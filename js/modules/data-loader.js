/**
 * üìä Data Loader Module
 * Veri y√ºkleme, metadata, cache y√∂netimi ve hedef y√ºkleme
 */

class DataLoader {
    constructor() {
        this.loadedYears = new Set();
        this.loadedDataCache = {};
        this.centralTargets = {yearly: {}, monthly: {}};
        this.metadata = null;
        this.allData = [];
        this.baseData = [];
        this.filteredData = [];
        this.inventoryData = [];
        
        // Loading progress tracking
        this.dataLoadProgress = {
            metadata: false,
            targets: false,
            data: false,
            pageInit: false
        };
        
        this.init();
    }

    /**
     * Data loader'ƒ± ba≈ülat
     */
    init() {
        console.log('üìä DataLoader initialized');
    }

    /**
     * G√ºnl√ºk cache versiyonu al
     */
    getDailyVersion() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        return `${year}${month}${day}`;
    }

    /**
     * Saatlik cache versiyonu al
     */
    getHourlyVersion() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hour = String(now.getHours()).padStart(2, '0');
        return `${year}${month}${day}${hour}`;
    }

    /**
     * Metadata y√ºkle
     */
    async loadMetadata() {
        try {
            // Rate limiting kontrol√º
            if (window.RateLimiter && !window.RateLimiter.canMakeRequest('metadata')) {
                throw new Error('√áok fazla istek g√∂nderildi. L√ºtfen bekleyin.');
            }
            
            console.log('üìã Metadata y√ºkleniyor...');
            const version = this.getHourlyVersion();
            const response = await fetch(`data-metadata.json?v=${version}`, {
                headers: {
                    'Cache-Control': 'public, max-age=3600' // 1 saat cache
                }
            });
            
            if (!response.ok) {
                throw new Error('Metadata y√ºklenemedi');
            }
            
            this.metadata = await response.json();
            console.log('‚úÖ Metadata y√ºklendi:', this.metadata);
            
            this.dataLoadProgress.metadata = true;
            this.checkLoadingComplete();
            
            return this.metadata;
        } catch (error) {
            console.error('‚ùå Metadata y√ºkleme hatasƒ±:', error);
            
            // Error handler'a g√∂nder
            if (window.ErrorHandler) {
                window.ErrorHandler.handleDataError(error);
            }
            
            throw error;
        }
    }

    /**
     * Merkezi hedefleri y√ºkle
     */
    async loadCentralTargets() {
        try {
            console.log('üéØ Merkezi hedefler y√ºkleniyor...');
            const response = await fetch('data/targets.json?' + Date.now()); // Cache bypass
            if (response.ok) {
                this.centralTargets = await response.json();
                console.log('‚úÖ Merkezi hedefler y√ºklendi:', this.centralTargets);
                
                this.dataLoadProgress.targets = true;
                this.checkLoadingComplete();
                
                return true;
            } else {
                console.warn('‚ö†Ô∏è targets.json y√ºklenemedi, varsayƒ±lan hedefler kullanƒ±lacak');
                return false;
            }
    } catch (error) {
            console.error('‚ùå Hedef y√ºkleme hatasƒ±:', error);
            return false;
        }
    }

    /**
     * Belirli bir yƒ±lƒ±n verisini y√ºkle
     */
    async loadYearData(year) {
        // √áift y√ºkleme √∂nleme kontrol√º
        if (this.loadedYears.has(year) && this.loadedDataCache[year]) {
            console.log(`‚è≠Ô∏è ${year} zaten y√ºkl√º, cache'den d√∂nd√ºr√ºl√ºyor...`);
            return this.loadedDataCache[year];
        }
        
        // Loading flag ekle - race condition √∂nleme
        this.loadedYears.add(year);
        
        try {
            console.log(`üì¶ ${year} y√ºkleniyor...`);
            
            // GZIP dosyasƒ±nƒ± indir - Akƒ±llƒ± Cache ile
            const version = this.getDailyVersion();
            const response = await fetch(`data-${year}.json.gz?v=${version}`, {
                headers: {
                    'Cache-Control': 'public, max-age=86400' // 24 saat cache
                }
            });
            if (!response.ok) throw new Error(`${year} verisi bulunamadƒ±`);
            
            // ArrayBuffer olarak al
            const arrayBuffer = await response.arrayBuffer();
            
            // GZIP a√ßma - Evrensel y√∂ntem
            let decompressed;
            
            // Y√∂ntem 1: DecompressionStream (modern tarayƒ±cƒ±lar)
            if (typeof DecompressionStream !== 'undefined') {
                try {
                    const blob = new Blob([arrayBuffer]);
                    const ds = new DecompressionStream('gzip');
                    const stream = blob.stream().pipeThrough(ds);
                    decompressed = await new Response(stream).text();
                } catch (e) {
                    console.warn('DecompressionStream ba≈üarƒ±sƒ±z, pako kullanƒ±lƒ±yor:', e);
                    // Fallback to pako
                    const uint8Array = new Uint8Array(arrayBuffer);
                    const decompressedArray = pako.inflate(uint8Array);
                    decompressed = new TextDecoder().decode(decompressedArray);
                }
            }
            // Y√∂ntem 2: Pako.js (t√ºm tarayƒ±cƒ±lar i√ßin fallback)
            else {
                if (typeof pako === 'undefined') {
                    throw new Error('GZIP a√ßma k√ºt√ºphanesi y√ºklenmedi. L√ºtfen sayfayƒ± yenileyin.');
                }
                const uint8Array = new Uint8Array(arrayBuffer);
                const decompressedArray = pako.inflate(uint8Array);
                decompressed = new TextDecoder().decode(decompressedArray);
            }
            
            // JSON'a √ßevir
            const yearData = JSON.parse(decompressed);
            
            console.log(`‚úÖ ${year} y√ºklendi: ${yearData?.details?.length || 0} kayƒ±t`);
            if (!yearData?.details) {
                console.warn(`‚ö†Ô∏è ${year} verisi bo≈ü veya ge√ßersiz`);
            }
            
            // Cache'e kaydet
            this.loadedDataCache[year] = yearData;
            
            return yearData;
            
        } catch (error) {
            console.error(`‚ùå ${year} y√ºkleme hatasƒ±:`, error);
            // Hata durumunda loading flag'i temizle
            this.loadedYears.delete(year);
            delete this.loadedDataCache[year];
            throw error;
        }
    }

    /**
     * T√ºm yƒ±llarƒ±n verisini paralel olarak y√ºkle
     */
    async loadAllYearsData() {
        if (!this.metadata || !this.metadata.years) {
            throw new Error('Metadata y√ºklenmedi');
        }

        console.log('üìä T√ºm yƒ±llarƒ±n verisi y√ºkleniyor...');
        const years = this.metadata.years;
        
        try {
            // Paralel y√ºkleme
            const yearPromises = years.map(year => this.loadYearData(year));
            const yearDataArray = await Promise.all(yearPromises);
            
            // T√ºm veriyi birle≈ütir
            this.allData = [];
            yearDataArray.forEach(yearData => {
                if (yearData && yearData.details) {
                    this.allData = this.allData.concat(yearData.details);
                }
            });
            
            console.log(`‚úÖ T√ºm veriler y√ºklendi: ${this.allData.length} kayƒ±t`);
            
            // Base data'yƒ± ayarla
            this.baseData = [...this.allData];
            this.filteredData = [...this.allData];
            
            this.dataLoadProgress.data = true;
            this.checkLoadingComplete();
            
            return this.allData;
        } catch (error) {
            console.error('‚ùå T√ºm veri y√ºkleme hatasƒ±:', error);
            throw error;
        }
    }

    /**
     * Stok verilerini y√ºkle
     */
    async loadInventoryData() {
        try {
            console.log('üì¶ Stok verileri y√ºkleniyor...');
            const response = await fetch('inventory.json.gz?' + Date.now());
            if (!response.ok) {
                console.warn('‚ö†Ô∏è Stok verisi bulunamadƒ±');
                return [];
            }
            
            const arrayBuffer = await response.arrayBuffer();
            let decompressed;
            
            if (typeof DecompressionStream !== 'undefined') {
                try {
                    const blob = new Blob([arrayBuffer]);
                    const ds = new DecompressionStream('gzip');
                    const stream = blob.stream().pipeThrough(ds);
                    decompressed = await new Response(stream).text();
                } catch (e) {
                    const uint8Array = new Uint8Array(arrayBuffer);
                    const decompressedArray = pako.inflate(uint8Array);
                    decompressed = new TextDecoder().decode(decompressedArray);
                }
            } else {
                const uint8Array = new Uint8Array(arrayBuffer);
                const decompressedArray = pako.inflate(uint8Array);
                decompressed = new TextDecoder().decode(decompressedArray);
            }
            
            this.inventoryData = JSON.parse(decompressed);
            console.log(`‚úÖ Stok verileri y√ºklendi: ${this.inventoryData.length} kayƒ±t`);
            
            return this.inventoryData;
        } catch (error) {
            console.error('‚ùå Stok veri y√ºkleme hatasƒ±:', error);
            return [];
        }
    }

    /**
     * T√ºm verileri y√ºkle (ana fonksiyon)
     */
    async loadAllData() {
        try {
            console.log('üöÄ T√ºm veri y√ºkleme i≈ülemi ba≈ülatƒ±lƒ±yor...');
            
            // 1. Metadata y√ºkle
            await this.loadMetadata();
            
            // 2. Hedefleri y√ºkle (paralel)
            const targetsPromise = this.loadCentralTargets();
            
            // 3. Stok verilerini y√ºkle (paralel)
            const inventoryPromise = this.loadInventoryData();
            
            // 4. T√ºm yƒ±llarƒ±n verisini y√ºkle
            await this.loadAllYearsData();
            
            // 5. Hedefleri bekle
            await targetsPromise;
            
            // 6. Stok verilerini bekle
            await inventoryPromise;
            
            console.log('‚úÖ T√ºm veriler ba≈üarƒ±yla y√ºklendi!');
            
            // Dashboard'ƒ± g√ºncelle
            if (window.Dashboard) {
                console.log('üîÑ Dashboard g√ºncelleniyor...');
                window.Dashboard.updateDashboard();
            }
            
            return {
                allData: this.allData,
                metadata: this.metadata,
                centralTargets: this.centralTargets,
                inventoryData: this.inventoryData
            };
            
    } catch (error) {
            console.error('‚ùå Veri y√ºkleme hatasƒ±:', error);
            throw error;
        }
    }

    /**
     * Loading tamamlanma kontrol√º
     */
    checkLoadingComplete() {
        const allComplete = Object.values(this.dataLoadProgress).every(complete => complete);
        
        if (allComplete) {
            console.log('‚úÖ T√ºm veriler y√ºklendi!');
            
            // Loading screen'i gizle
            const loadingScreen = document.getElementById('loadingScreen');
            if (loadingScreen) {
                loadingScreen.style.display = 'none';
            }
            
            // Main container'ƒ± g√∂ster
            const mainContainer = document.getElementById('mainContainer');
            if (mainContainer) {
                mainContainer.style.display = 'block';
            }
        }
    }

    /**
     * Veri filtreleme
     */
    filterData(filters = {}) {
        let filtered = [...this.baseData];
        
        // Yƒ±l filtresi
        if (filters.years && filters.years.length > 0) {
            filtered = filtered.filter(item => {
                const itemYear = new Date(item.date).getFullYear().toString();
                return filters.years.includes(itemYear);
            });
        }
        
        // Ay filtresi
        if (filters.months && filters.months.length > 0) {
            filtered = filtered.filter(item => {
                const itemMonth = new Date(item.date).getMonth() + 1;
                return filters.months.includes(itemMonth.toString());
            });
        }
        
        // Maƒüaza filtresi
        if (filters.stores && filters.stores.length > 0) {
            filtered = filtered.filter(item => {
                return filters.stores.includes(item.partner);
            });
        }
        
        // Kanal filtresi
        if (filters.channels && filters.channels.length > 0) {
            filtered = filtered.filter(item => {
                return filters.channels.includes(item.channel);
            });
        }
        
        this.filteredData = filtered;
        return filtered;
    }

    /**
     * Cache temizle
     */
    clearCache() {
        this.loadedYears.clear();
        this.loadedDataCache = {};
        console.log('üóëÔ∏è Cache temizlendi');
    }

    /**
     * Veri istatistikleri
     */
    getDataStats() {
        return {
            totalRecords: this.allData.length,
            filteredRecords: this.filteredData.length,
            loadedYears: Array.from(this.loadedYears),
            cacheSize: Object.keys(this.loadedDataCache).length,
            metadata: this.metadata,
            hasTargets: Object.keys(this.centralTargets.yearly).length > 0
        };
    }
}

// Global DataLoader instance olu≈ütur
window.DataLoader = new DataLoader();

// Global fonksiyonlar (geriye uyumluluk i√ßin)
window.loadData = () => window.DataLoader.loadAllData();
window.loadMetadata = () => window.DataLoader.loadMetadata();
window.loadYearData = (year) => window.DataLoader.loadYearData(year);
window.loadCentralTargets = () => window.DataLoader.loadCentralTargets();
window.loadAllYearsData = () => window.DataLoader.loadAllYearsData();

console.log('üìä DataLoader module loaded successfully');