<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Satis Analizi Dashboard - AI Powered</title>
    <!-- Pako.js for GZIP Decompression (Fallback) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .info-box {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .info-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .info-card h3 {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-card p {
            font-size: 1.5em;
            color: #212529;
            font-weight: 600;
        }

        .search-section {
            padding: 30px;
            background: white;
            border-bottom: 1px solid #dee2e6;
        }

        .search-box {
            display: flex;
            gap: 10px;
            max-width: 800px;
            margin: 0 auto;
        }

        .search-box input {
            flex: 1;
            padding: 15px 20px;
            font-size: 1.1em;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            outline: none;
            transition: all 0.3s;
        }

        .search-box input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-box button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .search-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .filters-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group label {
            display: block;
            font-size: 0.9em;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .filter-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            transition: all 0.3s;
            min-height: 42px;
        }

        .filter-group select[multiple] {
            display: none; /* Gizle, checkbox kullanacağız */
        }
        
        .filter-search-box {
            position: relative;
            margin-bottom: 8px;
        }
        
        .filter-search-input {
            width: 100%;
            padding: 8px 30px 8px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        
        .filter-search-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filter-search-clear {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            width: 20px;
            height: 20px;
            display: none;
        }
        
        .filter-search-clear:hover {
            color: #333;
        }
        
        .checkbox-container {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.2s;
        }
        
        .checkbox-item.hidden {
            display: none;
        }
        
        .checkbox-item:hover {
            background: #f8f9fa;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #667eea;
        }
        
        .checkbox-item label {
            cursor: pointer;
            flex: 1;
            margin: 0;
            font-size: 0.95em;
        }

        .filter-group select:focus {
            border-color: #667eea;
        }
        
        .selected-count {
            font-size: 0.85em;
            color: #667eea;
            margin-top: 3px;
            font-weight: 600;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .filter-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-apply {
            background: #28a745;
            color: white;
        }

        .btn-reset {
            background: #6c757d;
            color: white;
        }

        .btn-apply:hover {
            background: #218838;
        }

        .btn-reset:hover {
            background: #5a6268;
        }

        .content {
            padding: 30px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .summary-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .summary-card p {
            font-size: 2em;
            font-weight: 700;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 1200px;
        }

        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            font-size: 0.9em;
        }

        .data-table th:hover {
            background: rgba(255,255,255,0.1);
        }

        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.9em;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .data-table td:hover {
            overflow: visible;
            white-space: normal;
            word-wrap: break-word;
            position: relative;
            z-index: 5;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .data-table td.numeric {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #6c757d;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: #dc3545;
            font-size: 1.2em;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Tab System */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 0 30px;
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1.1em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Voice Search */
        .voice-btn {
            padding: 15px 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }
        
        .voice-btn.listening {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* Target Tracking */
        .target-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .target-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .target-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .target-card h3 {
            font-size: 1.2em;
            color: #495057;
            margin-bottom: 15px;
        }
        
        .target-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1.1em;
            margin-bottom: 15px;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .target-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .target-stat {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .target-stat label {
            font-size: 0.85em;
            color: #6c757d;
            display: block;
            margin-bottom: 5px;
        }
        
        .target-stat value {
            font-size: 1.3em;
            font-weight: 700;
            color: #212529;
        }
        
        /* Customer Analysis */
        .customer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .customer-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .customer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .customer-rank {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            font-weight: 700;
            font-size: 1.2em;
            margin-right: 15px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
        }
        
        /* Export Button */
        .export-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.3);
        }
        
        /* AI Analysis Panel */
        .analysis-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .analysis-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
        }
        
        .analysis-section h3 {
            margin: 0 0 15px 0;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .insight-item {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid;
        }
        
        .insight-positive {
            border-left-color: #38ef7d;
        }
        
        .insight-negative {
            border-left-color: #f5576c;
        }
        
        .insight-neutral {
            border-left-color: #ffd700;
        }
        
        .insight-icon {
            font-size: 1.5em;
            margin-right: 10px;
        }
        
        .recommendation {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: start;
            gap: 15px;
        }
        
        .recommendation-icon {
            font-size: 2em;
            flex-shrink: 0;
        }
        
        .metric-highlight {
            display: inline-block;
            background: rgba(255,255,255,0.3);
            padding: 3px 10px;
            border-radius: 5px;
            font-weight: 700;
            margin: 0 5px;
        }
        
        /* ==================== MOBİL İYİLEŞTİRMELER ==================== */
        /* PC görünümüne DOKUNMAZ - Sadece mobilde aktif */
        
        @media (max-width: 768px) {
            /* Body ve Container */
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 10px;
            }
            
            /* Header */
            .header h1 {
                font-size: 1.5em;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            /* Info Cards */
            .info-cards {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 15px;
            }
            
            .info-card {
                padding: 15px;
            }
            
            .info-card h3 {
                font-size: 0.9em;
            }
            
            .info-card p {
                font-size: 1.2em;
            }
            
            /* Tab Navigation - Yatay Scroll */
            .tabs {
                overflow-x: auto;
                overflow-y: hidden;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                padding: 10px 5px;
                gap: 5px;
                scrollbar-width: thin;
            }
            
            .tabs::-webkit-scrollbar {
                height: 4px;
            }
            
            .tabs::-webkit-scrollbar-thumb {
                background: #667eea;
                border-radius: 2px;
            }
            
            .tab {
                display: inline-block;
                padding: 12px 20px;
                font-size: 0.85em;
                min-width: auto;
                white-space: nowrap;
            }
            
            /* Content */
            .content {
                padding: 15px;
            }
            
            .content h2 {
                font-size: 1.3em;
                margin-bottom: 15px;
            }
            
            .content h3 {
                font-size: 1.1em;
                margin-bottom: 10px;
            }
            
            /* Summary Cards */
            .summary-cards {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .summary-card {
                padding: 15px;
            }
            
            .summary-card h3 {
                font-size: 0.9em;
            }
            
            .summary-card p {
                font-size: 1.3em;
            }
            
            /* Filters */
            .filters {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .filter-group {
                padding: 12px;
            }
            
            .filter-group label {
                font-size: 0.9em;
            }
            
            .filter-group select,
            .filter-group input {
                font-size: 0.9em;
                padding: 10px;
            }
            
            /* Multi-select dropdowns */
            .multi-select-dropdown {
                max-height: 200px;
            }
            
            .checkbox-item {
                padding: 10px 8px;
            }
            
            .checkbox-item label {
                font-size: 0.9em;
            }
            
            /* Search Section */
            .search-section {
                padding: 15px;
            }
            
            .search-box input {
                font-size: 0.9em;
                padding: 12px;
            }
            
            .search-box button {
                padding: 12px 20px;
                font-size: 0.9em;
            }
            
            /* Buttons */
            button {
                padding: 12px 20px;
                font-size: 0.9em;
                min-height: 44px; /* Touch-friendly */
            }
            
            /* Charts */
            .chart-container {
                min-height: 250px;
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .chart-container h3 {
                font-size: 1em;
                margin-bottom: 10px;
            }
            
            /* Charts Grid - Tek sütun */
            .content > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            /* Tables - Yatay Scroll */
            table {
                font-size: 0.85em;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            table thead,
            table tbody,
            table tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }
            
            table th,
            table td {
                padding: 8px !important;
                min-width: 80px;
            }
            
            /* Customer Cards */
            .customer-card {
                margin-bottom: 15px;
            }
            
            .customer-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            /* Target Section */
            .target-section {
                padding: 15px;
            }
            
            .target-input-group {
                grid-template-columns: 1fr !important;
                gap: 15px;
            }
            
            .target-input-group input {
                font-size: 0.9em;
                padding: 10px;
            }
            
            /* Progress Bars */
            .progress-item {
                margin-bottom: 15px;
            }
            
            /* AI Analysis Panel */
            .analysis-panel {
                padding: 20px 15px;
            }
            
            .analysis-section {
                margin: 15px 0;
            }
            
            .insight-item {
                padding: 12px;
                margin: 8px 0;
                font-size: 0.9em;
            }
            
            .recommendation {
                padding: 12px;
                margin: 10px 0;
                font-size: 0.9em;
            }
            
            /* Product/Customer Search Results */
            #productResultsContainer,
            #customerProfileContainer,
            #customerProfileMainContainer,
            #salespersonProfileContainer,
            #cityAnalysisContainer {
                padding: 10px;
            }
            
            /* Responsive Grid Layouts */
            div[style*="grid-template-columns: repeat(auto-fit"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Input Fields */
            input[type="text"],
            input[type="number"],
            select,
            textarea {
                font-size: 16px !important; /* Prevent zoom on iOS */
            }
            
            /* Sticky Tab Menu */
            .tabs {
                position: sticky;
                top: 0;
                z-index: 100;
                background: white;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            /* Voice Button */
            #voiceButton {
                width: 44px;
                height: 44px;
                padding: 10px;
            }
            
            /* Excel Export Button */
            button[onclick*="exportToExcel"] {
                width: 100%;
                margin-top: 10px;
            }
            
            /* Debug Panel */
            #debugPanel {
                font-size: 0.8em;
                padding: 10px;
            }
            
            /* Scroll Hint for Tables */
            table::after {
                content: "← Kaydırın →";
                display: block;
                text-align: center;
                padding: 10px;
                background: #f8f9fa;
                color: #6c757d;
                font-size: 0.85em;
                border-top: 1px solid #dee2e6;
            }
            
            /* Hide table scroll hint after first scroll */
            table.scrolled::after {
                display: none;
            }
            
            /* Compact spacing for mobile */
            .content > * {
                margin-bottom: 20px;
            }
            
            /* Modal/Alert improvements */
            .swal2-popup {
                width: 90% !important;
                font-size: 0.9em !important;
            }
        }
        
        /* Tablet (768px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 100%;
            }
            
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .tab {
                font-size: 0.9em;
                padding: 12px 20px;
            }
            
            .content {
                padding: 20px;
            }
            
            /* 2 sütun layout for tablets */
            .filters {
                grid-template-columns: repeat(2, 1fr);
            }
            
            div[style*="grid-template-columns: repeat(auto-fit"] {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        /* Landscape Mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .header h1 {
                font-size: 1.3em;
            }
            
            .chart-container {
                min-height: 200px;
            }
            
            /* 2 sütun for landscape */
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 Satis Analizi Dashboard</h1>
            <p>Odoo ERP - Gercek Zamanli Veri Analizi</p>
        </div>

        <div class="info-box">
            <div class="info-card">
                <h3>📊 Veri Durumu</h3>
                <p id="dataStatus">Yukleniyor...</p>
            </div>
            <div class="info-card">
                <h3>Son Guncelleme</h3>
                <p id="lastUpdate">-</p>
            </div>
            <div class="info-card">
                <h3>Toplam Kayit</h3>
                <p id="totalRecords">-</p>
            </div>
            <div class="info-card">
                <h3>Toplam USD Tutar</h3>
                <p id="totalUSD">-</p>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('sales')">📊 Satış Analizi</button>
            <button class="tab" onclick="switchTab('targets')">🎯 Hedef Takip</button>
            <button class="tab" onclick="switchTab('customers')">👥 Müşteri Analizi</button>
            <button class="tab" onclick="switchTab('salesperson')">👨‍💼 Satış Temsilcisi</button>
            <button class="tab" onclick="switchTab('city')">🌍 Şehir Analizi</button>
            <button class="tab" onclick="switchTab('stock')">📦 Stok Dağılım</button>
            <button class="tab" onclick="switchTab('time')">⏰ Zaman Analizi</button>
            <button class="tab" onclick="switchTab('product')">🎸 Ürün Analizi</button>
        </div>

        <!-- Sales Analysis Tab -->
        <div id="salesTab" class="tab-content active">
            <div class="search-section">
                <div class="search-box">
                    <input type="text" id="smartSearch" placeholder="🤖 AI Agent: Doğal dille sorun - Örnek: Akasya 2025 ekim Fender satışları" onkeypress="if(event.key==='Enter') applySmartSearch()">
                    <button onclick="applySmartSearch()">🤖 AI Ara</button>
                    <button class="voice-btn" id="voiceBtn" onclick="startVoiceSearch()" title="Sesli Arama">🎤</button>
                    <button class="export-btn" onclick="exportToExcel()" title="Excel'e Aktar">📥 Excel</button>
                </div>
                <p style="text-align: center; margin-top: 10px; font-size: 0.9em; color: #6c757d;">
                    💡 <strong>AI + Ses Destekli:</strong> Yazın veya 🎤 mikrofona tıklayıp konuşun
                </p>
            </div>

        <div class="filters-section">
            <div class="filters-grid">
                <div class="filter-group">
                    <label>Marka <span class="selected-count" id="countBrand"></span></label>
                    <div class="filter-search-box">
                        <input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput="filterCheckboxes('filterBrand', this.value)">
                    </div>
                    <div class="checkbox-container" id="filterBrand"></div>
                </div>
                <div class="filter-group">
                    <label>Kategori 1 <span class="selected-count" id="countCategory1"></span></label>
                    <div class="filter-search-box">
                        <input type="text" class="filter-search-input" placeholder="🔍 Ara (örn: davul)..." oninput="filterCheckboxes('filterCategory1', this.value)">
                    </div>
                    <div class="checkbox-container" id="filterCategory1"></div>
                </div>
                <div class="filter-group">
                    <label>Kategori 2 <span class="selected-count" id="countCategory2"></span></label>
                    <div class="filter-search-box">
                        <input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput="filterCheckboxes('filterCategory2', this.value)">
                    </div>
                    <div class="checkbox-container" id="filterCategory2"></div>
                </div>
                <div class="filter-group">
                    <label>Kategori 3 <span class="selected-count" id="countCategory3"></span></label>
                    <div class="filter-search-box">
                        <input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput="filterCheckboxes('filterCategory3', this.value)">
                    </div>
                    <div class="checkbox-container" id="filterCategory3"></div>
                </div>
                <div class="filter-group">
                    <label>Kategori 4 <span class="selected-count" id="countCategory4"></span></label>
                    <div class="filter-search-box">
                        <input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput="filterCheckboxes('filterCategory4', this.value)">
                    </div>
                    <div class="checkbox-container" id="filterCategory4"></div>
                </div>
                <div class="filter-group">
                    <label>Satis Temsilcisi <span class="selected-count" id="countSalesPerson"></span></label>
                    <div class="filter-search-box">
                        <input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput="filterCheckboxes('filterSalesPerson', this.value)">
                    </div>
                    <div class="checkbox-container" id="filterSalesPerson"></div>
                </div>
                <div class="filter-group">
                    <label>Magaza <span class="selected-count" id="countStore"></span></label>
                    <div class="filter-search-box">
                        <input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput="filterCheckboxes('filterStore', this.value)">
                    </div>
                    <div class="checkbox-container" id="filterStore"></div>
                </div>
                <div class="filter-group">
                    <label>Sehir <span class="selected-count" id="countCity"></span></label>
                    <div class="filter-search-box">
                        <input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput="filterCheckboxes('filterCity', this.value)">
                    </div>
                    <div class="checkbox-container" id="filterCity"></div>
                </div>
                <div class="filter-group">
                    <label>Yil <span class="selected-count" id="countYear"></span></label>
                    <div class="filter-search-box">
                        <input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput="filterCheckboxes('filterYear', this.value)">
                    </div>
                    <div class="checkbox-container" id="filterYear"></div>
                </div>
                <div class="filter-group">
                    <label>Ay <span class="selected-count" id="countMonth"></span></label>
                    <div class="filter-search-box">
                        <input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput="filterCheckboxes('filterMonth', this.value)">
                    </div>
                    <div class="checkbox-container" id="filterMonth"></div>
                </div>
                <div class="filter-group">
                    <label>Gun <span class="selected-count" id="countDay"></span></label>
                    <div class="filter-search-box">
                        <input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput="filterCheckboxes('filterDay', this.value)">
                    </div>
                    <div class="checkbox-container" id="filterDay"></div>
                </div>
            </div>
            <div class="filter-buttons">
                <button class="btn-apply" onclick="applyFilters()">Filtrele</button>
                <button class="btn-reset" onclick="resetFilters()">Sifirla</button>
            </div>
        </div>

        <div class="content">
            <!-- Debug Panel -->
            <div id="debugPanel" style="background: #fff3cd; padding: 15px; border-radius: 10px; margin-bottom: 20px; display: none;">
                <h4 style="margin: 0 0 10px 0; color: #856404;">🔍 Debug Bilgileri</h4>
                <div id="debugInfo" style="font-family: monospace; font-size: 0.9em; color: #856404;"></div>
                <button onclick="document.getElementById('debugPanel').style.display='none'" style="margin-top: 10px; padding: 5px 10px; background: #856404; color: white; border: none; border-radius: 5px; cursor: pointer;">Kapat</button>
            </div>
            
            <div class="summary-cards">
                <div class="summary-card">
                    <h3>Toplam Satis (USD)</h3>
                    <p id="summaryUSD">$0</p>
                </div>
                <div class="summary-card">
                    <h3>Toplam Urun Miktari</h3>
                    <p id="summaryQuantity">0</p>
                </div>
                <div class="summary-card">
                    <h3>Toplam Musteri</h3>
                    <p id="summaryPartners">0</p>
                </div>
                <div class="summary-card">
                    <h3>Toplam Urun</h3>
                    <p id="summaryProducts">0</p>
                </div>
            </div>

            <!-- AI Analysis Panel -->
            <div id="aiAnalysisPanel" style="display: none;"></div>

            <div id="tableContainer">
                <div class="loading">📊 Veriler yukleniyor...</div>
            </div>
        </div>
        </div>
        <!-- End Sales Tab -->

        <!-- Targets Tab -->
        <div id="targetsTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 20px;">🎯 Hedef Takip Sistemi</h2>
                
                <div class="target-section">
                    <h3>Yıllık Hedef</h3>
                    <div class="target-grid">
                        <div class="target-card">
                            <h3>Hedef Belirle</h3>
                            <input type="number" id="yearlyTarget" class="target-input" placeholder="Yıllık hedef (USD)">
                            <label style="font-size: 0.9em; color: #6c757d;">Mağaza seçin:</label>
                            <select id="targetYearStore" class="target-input" onchange="loadYearlyTarget()">
                                <option value="TÜM MAĞAZALAR">🏢 Tüm Mağazalar</option>
                            </select>
                            <label style="font-size: 0.9em; color: #6c757d;">Yıl seçin:</label>
                            <select id="targetYear" class="target-input" onchange="loadYearlyTarget()">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                            </select>
                            <button onclick="saveYearlyTarget()" style="margin-top: 15px; padding: 12px 30px; background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1em;">
                                💾 Kaydet
                            </button>
                        </div>
                        
                        <div class="target-card">
                            <h3>Gerçekleşme</h3>
                            <div class="progress-bar">
                                <div class="progress-fill" id="yearlyProgress" style="width: 0%">0%</div>
                            </div>
                            <div class="target-stats">
                                <div class="target-stat">
                                    <label>Gerçekleşen</label>
                                    <value id="yearlyAchieved">$0</value>
                                </div>
                                <div class="target-stat">
                                    <label>Kalan</label>
                                    <value id="yearlyRemaining">$0</value>
                                </div>
                                <div class="target-stat">
                                    <label>Kalan Gün</label>
                                    <value id="yearlyDaysLeft">0</value>
                                </div>
                                <div class="target-stat">
                                    <label>Günlük Gerekli</label>
                                    <value id="yearlyDailyRequired">$0</value>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="target-section">
                    <h3>Aylık Hedef</h3>
                    <div class="target-grid">
                        <div class="target-card">
                            <h3>Hedef Belirle</h3>
                            <input type="number" id="monthlyTarget" class="target-input" placeholder="Aylık hedef (USD)">
                            <label style="font-size: 0.9em; color: #6c757d;">Mağaza seçin:</label>
                            <select id="targetMonthStore" class="target-input" onchange="loadMonthlyTarget()">
                                <option value="TÜM MAĞAZALAR">🏢 Tüm Mağazalar</option>
                            </select>
                            <label style="font-size: 0.9em; color: #6c757d;">Ay seçin:</label>
                            <select id="targetMonth" class="target-input" onchange="loadMonthlyTarget()">
                                <option value="01">Ocak</option>
                                <option value="02">Şubat</option>
                                <option value="03">Mart</option>
                                <option value="04">Nisan</option>
                                <option value="05">Mayıs</option>
                                <option value="06">Haziran</option>
                                <option value="07">Temmuz</option>
                                <option value="08">Ağustos</option>
                                <option value="09">Eylül</option>
                                <option value="10">Ekim</option>
                                <option value="11">Kasım</option>
                                <option value="12">Aralık</option>
                            </select>
                            <button onclick="saveMonthlyTarget()" style="margin-top: 15px; padding: 12px 30px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-weight: bold; font-size: 1em;">
                                💾 Kaydet
                            </button>
                        </div>
                        
                        <div class="target-card">
                            <h3>Gerçekleşme</h3>
                            <div class="progress-bar">
                                <div class="progress-fill" id="monthlyProgress" style="width: 0%">0%</div>
                            </div>
                            <div class="target-stats">
                                <div class="target-stat">
                                    <label>Gerçekleşen</label>
                                    <value id="monthlyAchieved">$0</value>
                                </div>
                                <div class="target-stat">
                                    <label>Kalan</label>
                                    <value id="monthlyRemaining">$0</value>
                                </div>
                                <div class="target-stat">
                                    <label>Kalan Gün</label>
                                    <value id="monthlyDaysLeft">0</value>
                                </div>
                                <div class="target-stat">
                                    <label>Günlük Gerekli</label>
                                    <value id="monthlyDailyRequired">$0</value>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Target Chart -->
                <div class="chart-container">
                    <canvas id="targetChart"></canvas>
                </div>
            </div>
        </div>
        <!-- End Targets Tab -->

        <!-- Customers Tab -->
        <div id="customersTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 20px;">👥 Müşteri Analizi</h2>
                
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>Toplam Müşteri</h3>
                        <p id="totalCustomers">0</p>
                    </div>
                    <div class="summary-card">
                        <h3>Aktif Müşteri (Son 90 Gün)</h3>
                        <p id="activeCustomers">0</p>
                    </div>
                    <div class="summary-card">
                        <h3>Ortalama Sipariş</h3>
                        <p id="avgOrderValue">$0</p>
                    </div>
                    <div class="summary-card">
                        <h3>En Yüksek Sipariş</h3>
                        <p id="maxOrderValue">$0</p>
                    </div>
                </div>
                
                <!-- Customer Search Section -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin: 30px 0;">
                    <h3 style="color: white; margin: 0 0 20px 0;">🔍 Müşteri Arama</h3>
                    <div style="position: relative; max-width: 600px;">
                        <input type="text" id="customerSearchInputMain" placeholder="Müşteri adı yazın... (örn: Ahmet Yılmaz)" 
                               style="width: 100%; padding: 15px 60px 15px 15px; font-size: 1em; border: 2px solid white; border-radius: 10px; outline: none;"
                               onkeyup="if(event.key==='Enter') searchCustomerProfileMain()">
                        <button onclick="searchCustomerProfileMain()" 
                                style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                            🔍 Ara
                        </button>
                    </div>
                    <p style="color: white; opacity: 0.9; margin-top: 10px; font-size: 0.9em;">
                        💡 Müşteri adının bir kısmını yazmak yeterli
                    </p>
                </div>
                
                <!-- Customer Profile Results (Initially Hidden) -->
                <div id="customerProfileMainContainer" style="display: none; margin-bottom: 40px;">
                    <!-- Customer Profile Header -->
                    <div style="background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.8em;">👤 <span id="customerNameMain">-</span></h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div>
                                <div style="opacity: 0.8; font-size: 0.85em;">🌍 Şehir</div>
                                <div style="font-size: 1.1em; font-weight: bold;" id="customerCityMain">-</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.85em;">🏷️ Etiketler</div>
                                <div style="font-size: 0.95em; font-weight: bold;" id="customerTagsMain">-</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.85em;">💰 Toplam Alışveriş</div>
                                <div style="font-size: 1.3em; font-weight: bold;" id="customerTotalSalesMain">$0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.85em;">📦 Toplam Adet</div>
                                <div style="font-size: 1.3em; font-weight: bold;" id="customerTotalQtyMain">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.85em;">🛒 İşlem Sayısı</div>
                                <div style="font-size: 1.3em; font-weight: bold;" id="customerTransactionCountMain">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.85em;">📊 Ortalama Sepet</div>
                                <div style="font-size: 1.3em; font-weight: bold;" id="customerAvgBasketMain">$0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customer Charts -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 15px;">🏷️ En Çok Tercih Ettiği Markalar</h3>
                            <canvas id="customerBrandChartMain"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 15px;">📂 En Çok Aldığı Kategoriler</h3>
                            <canvas id="customerCategoryChartMain"></canvas>
                        </div>
                    </div>
                    
                    <!-- Purchase History -->
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px;">🛍️ Son Alışverişler (Son 20)</h3>
                        <div id="customerPurchaseHistoryMain" style="overflow-x: auto;"></div>
                    </div>
                    
                    <!-- AI Analysis Panel -->
                    <div id="customerAIAnalysisPanelMain" style="margin: 40px 0; display: none;">
                        <h3 style="margin-bottom: 20px;">🤖 AI Müşteri Analizi, Yorum ve Öneriler</h3>
                        <div id="customerAIAnalysisContentMain"></div>
                    </div>
                </div>
                
                <h3 style="margin: 30px 0 20px 0;">🏆 Top 10 Müşteri</h3>
                <div class="customer-grid" id="topCustomersGrid">
                    <!-- Dinamik olarak doldurulacak -->
                </div>
                
                <!-- Customer Charts -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 30px; margin-top: 30px;">
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 20px;">Müşteri Dağılımı (Şehir)</h3>
                        <canvas id="customerCityChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 20px;">Aylık Müşteri Trendi</h3>
                        <canvas id="customerTrendChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Customers Tab -->

        <!-- Time Analysis Tab -->
        <div id="timeTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 20px;">⏰ Zaman Analizi</h2>
                
                <!-- Time Summary Cards -->
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>En Yoğun Saat</h3>
                        <p id="peakHour">-</p>
                    </div>
                    <div class="summary-card">
                        <h3>En Yoğun Gün</h3>
                        <p id="peakDay">-</p>
                    </div>
                    <div class="summary-card">
                        <h3>Mesai Saati Satış</h3>
                        <p id="workHoursSales">-</p>
                    </div>
                    <div class="summary-card">
                        <h3>Hafta Sonu Satış</h3>
                        <p id="weekendSales">-</p>
                    </div>
                </div>
                
                <!-- AI Time Insights -->
                <div id="timeInsightsPanel" style="display: none;"></div>
                
                <!-- Hourly Chart -->
                <div class="chart-container" style="margin: 30px 0;">
                    <h3 style="text-align: center; margin-bottom: 20px;">📊 Saatlik Yoğunluk (24 Saat)</h3>
                    <canvas id="hourlyChart"></canvas>
                </div>
                
                <!-- Daily Chart -->
                <div class="chart-container" style="margin: 30px 0;">
                    <h3 style="text-align: center; margin-bottom: 20px;">📅 Günlük Trend (Haftalık)</h3>
                    <canvas id="dailyChart"></canvas>
                </div>
                
                <!-- Heatmap -->
                <div style="margin: 30px 0;">
                    <h3 style="text-align: center; margin-bottom: 20px;">🔥 Gün x Saat Heatmap</h3>
                    <div id="heatmapContainer" style="overflow-x: auto;"></div>
                </div>
                
                <!-- Store Time Comparison -->
                <div style="margin: 30px 0;">
                    <h3 style="text-align: center; margin-bottom: 20px;">🏪 Mağaza Bazında Saat Karşılaştırması</h3>
                    <div style="margin-bottom: 20px; text-align: center;">
                        <label>Mağaza Seç: </label>
                        <select id="storeTimeFilter" onchange="renderStoreTimeChart()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                            <option value="">Tüm Mağazalar</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="storeTimeChart"></canvas>
                    </div>
                </div>
                
                <!-- Category Time Analysis -->
                <div style="margin: 30px 0;">
                    <h3 style="text-align: center; margin-bottom: 20px;">📦 Kategori Bazında Saat Analizi</h3>
                    <div style="margin-bottom: 20px; text-align: center;">
                        <label>Kategori Seç: </label>
                        <select id="categoryTimeFilter" onchange="renderCategoryTimeChart()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                            <option value="">Tüm Kategoriler</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="categoryTimeChart"></canvas>
                    </div>
                </div>
                
                <!-- Sales Person Time Analysis -->
                <div style="margin: 30px 0;">
                    <h3 style="text-align: center; margin-bottom: 20px;">👤 Satış Temsilcisi Bazında Saat Analizi</h3>
                    <div style="margin-bottom: 20px; text-align: center;">
                        <label>Temsilci Seç: </label>
                        <select id="salesPersonTimeFilter" onchange="renderSalesPersonTimeChart()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                            <option value="">Tüm Temsilciler</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="salesPersonTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Time Analysis Tab -->

        <!-- Product Analysis Tab -->
        <div id="productTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 20px;">🎸 Ürün / Marka Analizi</h2>
                
                <!-- Search Section -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="color: white; margin-bottom: 20px; text-align: center;">🔍 Ürün veya Marka Ara</h3>
                    <div style="display: flex; gap: 15px; max-width: 800px; margin: 0 auto;">
                        <input type="text" id="productSearchInput" placeholder="Örnek: KDP120R, Roland, Yamaha P-125..." 
                               style="flex: 1; padding: 15px; border: none; border-radius: 10px; font-size: 1.1em;"
                               onkeypress="if(event.key==='Enter') searchProduct()">
                        <button onclick="searchProduct()" 
                                style="padding: 15px 40px; background: #38ef7d; color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: bold; cursor: pointer; transition: all 0.3s;">
                            🔍 Ara
                        </button>
                    </div>
                    <p style="text-align: center; margin-top: 15px; color: white; font-size: 0.95em; opacity: 0.9;">
                        💡 <strong>İpucu:</strong> Ürün kodu (KDP120R), marka adı (Roland) veya ürün adı (Yamaha P-125) yazabilirsiniz
                    </p>
                </div>
                
                <!-- Results Section -->
                <div id="productResultsContainer" style="display: none;">
                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="summary-card">
                            <h3>Toplam Satış</h3>
                            <p id="productTotalSales">$0</p>
                        </div>
                        <div class="summary-card">
                            <h3>Toplam Adet</h3>
                            <p id="productTotalQty">0</p>
                        </div>
                        <div class="summary-card">
                            <h3>Farklı Ürün</h3>
                            <p id="productUniqueCount">0</p>
                        </div>
                        <div class="summary-card">
                            <h3>Ortalama Fiyat</h3>
                            <p id="productAvgPrice">$0</p>
                        </div>
                    </div>
                    
                    <!-- Charts Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px;">
                        <!-- Top Stores -->
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">🏪 En Çok Satan Mağazalar</h3>
                            <canvas id="productStoreChart"></canvas>
                        </div>
                        
                        <!-- Top Cities -->
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">🌍 En Çok Satılan İller</h3>
                            <canvas id="productCityChart"></canvas>
                        </div>
                        
                        <!-- Top Sales Persons -->
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">👤 En Çok Satan Temsilciler</h3>
                            <canvas id="productSalesPersonChart"></canvas>
                        </div>
                        
                        <!-- Monthly Trend -->
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">📈 Aylık Satış Trendi</h3>
                            <canvas id="productMonthlyChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- AI Analysis Panel -->
                    <div id="productAIAnalysisPanel" style="margin: 40px 0; display: none;">
                        <h3 style="margin-bottom: 20px;">🤖 AI Analiz, Yorum ve Öneriler</h3>
                        <div id="productAIAnalysisContent"></div>
                    </div>
                    
                    <!-- Detailed Products Table -->
                    <div style="margin-top: 40px;">
                        <h3 style="margin-bottom: 20px;">📋 Detaylı Ürün Listesi</h3>
                        <div id="productDetailTable" style="overflow-x: auto;"></div>
                    </div>
                </div>
                
                <!-- No Results Message -->
                <div id="productNoResults" style="display: none; text-align: center; padding: 60px; background: #f8f9fa; border-radius: 15px;">
                    <div style="font-size: 4em; margin-bottom: 20px;">🔍</div>
                    <h3 style="color: #6c757d; margin-bottom: 10px;">Sonuç Bulunamadı</h3>
                    <p style="color: #adb5bd;">Lütfen farklı bir ürün veya marka adı deneyin</p>
                </div>
            </div>
        </div>
        <!-- End Product Analysis Tab -->

        <!-- Customer Search Tab -->
        <div id="customerSearchTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 30px;">🔍 Müşteri Arama ve Analizi</h2>
                
                <!-- Search Input -->
                <div style="max-width: 800px; margin: 0 auto 40px;">
                    <div style="position: relative;">
                        <input type="text" id="customerSearchInput" placeholder="Müşteri adı yazın... (örn: Ahmet Yılmaz)" 
                               style="width: 100%; padding: 20px 60px 20px 20px; font-size: 1.1em; border: 2px solid #667eea; border-radius: 15px; outline: none;"
                               onkeyup="if(event.key==='Enter') searchCustomerProfile()">
                        <button onclick="searchCustomerProfile()" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-size: 1em;">
                            🔍 Ara
                        </button>
                    </div>
                    <p style="text-align: center; color: #6c757d; margin-top: 10px; font-size: 0.9em;">
                        💡 İpucu: Müşteri adının bir kısmını yazmak yeterli
                    </p>
                </div>
                
                <!-- Results Container -->
                <div id="customerProfileContainer" style="display: none;">
                    <!-- Customer Profile Header -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 20px; margin-bottom: 30px;">
                        <h2 style="margin: 0 0 20px 0; font-size: 2em;">👤 <span id="customerName">-</span></h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">🌍 Şehir</div>
                                <div style="font-size: 1.3em; font-weight: bold;" id="customerCity">-</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">🏷️ Etiketler</div>
                                <div style="font-size: 1.1em; font-weight: bold;" id="customerTags">-</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">💰 Toplam Alışveriş</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="customerTotalSales">$0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">📦 Toplam Adet</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="customerTotalQty">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">🛒 İşlem Sayısı</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="customerTransactionCount">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">📊 Ortalama Sepet</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="customerAvgBasket">$0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">📅 İlk Alışveriş</div>
                                <div style="font-size: 1.1em; font-weight: bold;" id="customerFirstPurchase">-</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">📅 Son Alışveriş</div>
                                <div style="font-size: 1.1em; font-weight: bold;" id="customerLastPurchase">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; margin-bottom: 30px;">
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">🏷️ En Çok Tercih Ettiği Markalar</h3>
                            <canvas id="customerBrandChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">📂 En Çok Aldığı Kategoriler</h3>
                            <canvas id="customerCategoryChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">🏪 Alışveriş Yaptığı Mağazalar</h3>
                            <canvas id="customerStoreChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">📈 Aylık Alışveriş Trendi</h3>
                            <canvas id="customerMonthlyTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- AI Customer Analysis -->
                    <div id="customerAIAnalysisPanel" style="margin: 40px 0;">
                        <h3 style="margin-bottom: 20px;">🤖 AI Müşteri Analizi ve Öneriler</h3>
                        <div id="customerAIAnalysisContent"></div>
                    </div>
                    
                    <!-- Purchase History Table -->
                    <div style="margin-top: 40px;">
                        <h3 style="margin-bottom: 20px;">🛍️ Satın Alma Geçmişi</h3>
                        <div id="customerPurchaseHistory" style="overflow-x: auto;"></div>
                    </div>
                </div>
                
                <!-- No Results Message -->
                <div id="customerSearchNoResults" style="display: none; text-align: center; padding: 60px; background: #f8f9fa; border-radius: 15px;">
                    <div style="font-size: 4em; margin-bottom: 20px;">🔍</div>
                    <h3 style="color: #6c757d; margin-bottom: 10px;">Müşteri Bulunamadı</h3>
                    <p style="color: #adb5bd;">Lütfen farklı bir müşteri adı deneyin</p>
                </div>
            </div>
        </div>
        <!-- End Customer Search Tab -->

        <!-- Salesperson Analysis Tab -->
        <div id="salespersonTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 30px;">👨‍💼 Satış Temsilcisi Performans Analizi</h2>
                
                <!-- Search Input -->
                <div style="max-width: 800px; margin: 0 auto 40px;">
                    <div style="position: relative;">
                        <input type="text" id="salespersonSearchInput" placeholder="Satış temsilcisi adı yazın... (örn: Mustafa Kılıç)" 
                               style="width: 100%; padding: 20px 60px 20px 20px; font-size: 1.1em; border: 2px solid #667eea; border-radius: 15px; outline: none;"
                               onkeyup="if(event.key==='Enter') searchSalespersonProfile()">
                        <button onclick="searchSalespersonProfile()" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-size: 1em;">
                            🔍 Ara
                        </button>
                    </div>
                    <p style="text-align: center; color: #6c757d; margin-top: 10px; font-size: 0.9em;">
                        💡 İpucu: Temsilci adının bir kısmını yazmak yeterli
                    </p>
                </div>
                
                <!-- Results Container -->
                <div id="salespersonProfileContainer" style="display: none;">
                    <!-- Salesperson Profile Header -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 20px; margin-bottom: 30px;">
                        <h2 style="margin: 0 0 20px 0; font-size: 2em;">👨‍💼 <span id="salespersonName">-</span></h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">💰 Toplam Satış</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="salespersonTotalSales">$0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">📦 Toplam Adet</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="salespersonTotalQty">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">🛒 İşlem Sayısı</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="salespersonTransactionCount">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">📊 Ortalama İşlem</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="salespersonAvgTransaction">$0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">👥 Farklı Müşteri</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="salespersonUniqueCustomers">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">🎯 Farklı Ürün</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="salespersonUniqueProducts">0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; margin-bottom: 30px;">
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">🏷️ En Çok Sattığı Markalar (Top 10)</h3>
                            <canvas id="salespersonBrandChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">📂 En Çok Sattığı Kategoriler</h3>
                            <canvas id="salespersonCategoryChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">🏪 Çalıştığı Mağazalar</h3>
                            <canvas id="salespersonStoreChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">📈 Aylık Performans Trendi</h3>
                            <canvas id="salespersonMonthlyChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Top 20 Products -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="margin-bottom: 20px;">🎯 En Çok Sattığı Ürünler (Top 20)</h3>
                        <div id="salespersonTopProductsTable" style="overflow-x: auto;"></div>
                    </div>
                    
                    <!-- Bottom 10 Products -->
                    <div style="margin-bottom: 40px;">
                        <h3 style="margin-bottom: 20px;">⚠️ En Az Sattığı Ürünler (Bottom 10)</h3>
                        <div id="salespersonBottomProductsTable" style="overflow-x: auto;"></div>
                    </div>
                    
                    <!-- AI Salesperson Analysis -->
                    <div id="salespersonAIAnalysisPanel" style="margin: 40px 0;">
                        <h3 style="margin-bottom: 20px;">🤖 AI Performans Analizi ve Öneriler</h3>
                        <div id="salespersonAIAnalysisContent"></div>
                    </div>
                </div>
                
                <!-- No Results Message -->
                <div id="salespersonSearchNoResults" style="display: none; text-align: center; padding: 60px; background: #f8f9fa; border-radius: 15px;">
                    <div style="font-size: 4em; margin-bottom: 20px;">🔍</div>
                    <h3 style="color: #6c757d; margin-bottom: 10px;">Satış Temsilcisi Bulunamadı</h3>
                    <p style="color: #adb5bd;">Lütfen farklı bir isim deneyin</p>
                </div>
            </div>
        </div>
        <!-- End Salesperson Analysis Tab -->

        <!-- City Analysis Tab -->
        <div id="cityTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 30px;">🌍 Şehir Bazlı Satış Analizi</h2>
                
                <!-- City Selection -->
                <div style="max-width: 600px; margin: 0 auto 40px;">
                    <label style="display: block; margin-bottom: 10px; font-weight: bold; font-size: 1.1em;">📍 Şehir Seçin:</label>
                    <select id="citySelect" onchange="analyzeCityPerformance()" 
                            style="width: 100%; padding: 15px; font-size: 1.1em; border: 2px solid #667eea; border-radius: 10px; outline: none;">
                        <option value="">-- Şehir Seçin --</option>
                    </select>
                </div>
                
                <!-- City Results Container -->
                <div id="cityAnalysisContainer" style="display: none;">
                    <!-- City Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="summary-card">
                            <h3>💰 Toplam Satış</h3>
                            <p id="cityTotalSales">$0</p>
                        </div>
                        <div class="summary-card">
                            <h3>📦 Toplam Adet</h3>
                            <p id="cityTotalQty">0</p>
                        </div>
                        <div class="summary-card">
                            <h3>👥 Müşteri Sayısı</h3>
                            <p id="cityCustomerCount">0</p>
                        </div>
                        <div class="summary-card">
                            <h3>📊 Ortalama Sepet</h3>
                            <p id="cityAvgBasket">$0</p>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); color: white;">
                            <h3>👤 En Çok Satış Yapan Temsilci</h3>
                            <p id="cityTopSalesperson" style="color: white;">-</p>
                            <small id="cityTopSalespersonAmount" style="opacity: 0.9; font-size: 0.9em;">$0</small>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <h3>🏪 En Çok Satış Yapan Mağaza</h3>
                            <p id="cityTopStore" style="color: white;">-</p>
                            <small id="cityTopStoreAmount" style="opacity: 0.9; font-size: 0.9em;">$0</small>
                        </div>
                    </div>
                    
                    <!-- Charts Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; margin-bottom: 30px;">
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">🏷️ En Çok Satılan Markalar</h3>
                            <canvas id="cityBrandChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">🎸 En Çok Satılan Ürünler</h3>
                            <canvas id="cityProductChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">📂 En Çok Satılan Kategoriler</h3>
                            <canvas id="cityCategoryChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">📈 Aylık Satış Trendi</h3>
                            <canvas id="cityMonthlyChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- AI City Analysis -->
                    <div id="cityAIAnalysisPanel" style="margin: 40px 0;">
                        <h3 style="margin-bottom: 20px;">🤖 AI Şehir Analizi ve Öneriler</h3>
                        <div id="cityAIAnalysisContent"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End City Analysis Tab -->

        <!-- Stock Distribution Tab -->
        <div id="stockTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 30px;">📦 Stok Dağılım Analizi</h2>
                
                <!-- Stock Input Methods -->
                <div style="max-width: 1000px; margin: 0 auto;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">
                        <!-- Excel Upload -->
                        <div style="background: #f8f9fa; padding: 30px; border-radius: 15px;">
                            <h3 style="margin-bottom: 20px;">📄 Excel ile Toplu Yükleme</h3>
                            <p style="color: #6c757d; margin-bottom: 15px;">Excel formatı: <strong>Ürün Kodu | Stok Miktarı</strong></p>
                            <input type="file" id="stockExcelInput" accept=".xlsx,.xls" 
                                   style="display: none;" onchange="handleStockExcelUpload(event)">
                            <button onclick="document.getElementById('stockExcelInput').click()" 
                                    style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1em;">
                                📂 Excel Dosyası Seç
                            </button>
                            <p style="color: #6c757d; margin-top: 10px; font-size: 0.9em;">Max 5 MB, .xlsx veya .xls</p>
                        </div>
                        
                        <!-- Manual Entry -->
                        <div style="background: #f8f9fa; padding: 30px; border-radius: 15px;">
                            <h3 style="margin-bottom: 20px;">✏️ Manuel Giriş</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Ürün Kodu:</label>
                                <input type="text" id="manualProductCode" placeholder="örn: KDP120R" 
                                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Stok Miktarı:</label>
                                <input type="number" id="manualStockQty" placeholder="örn: 25" min="0"
                                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <button onclick="addManualStock()" 
                                    style="width: 100%; padding: 15px; background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1em;">
                                ➕ Stok Ekle
                            </button>
                        </div>
                    </div>
                    
                    <!-- Current Stock List -->
                    <div id="stockListContainer" style="display: none; margin-bottom: 40px;">
                        <h3 style="margin-bottom: 20px;">📋 Mevcut Stok Listesi</h3>
                        <div id="stockListTable" style="overflow-x: auto;"></div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="analyzeStockDistribution()" 
                                    style="padding: 15px 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1em; margin-right: 10px;">
                                🤖 AI Dağılım Önerisi Al
                            </button>
                            <button onclick="clearStockList()" 
                                    style="padding: 15px 40px; background: #dc3545; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1em;">
                                🗑️ Listeyi Temizle
                            </button>
                        </div>
                    </div>
                    
                    <!-- AI Distribution Recommendations -->
                    <div id="stockDistributionResults" style="display: none;">
                        <h3 style="margin-bottom: 20px;">🤖 AI Stok Dağılım Önerileri</h3>
                        <div id="stockDistributionContent"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Stock Distribution Tab -->

    </div>

    <script>
        let allData = [];
        let filteredData = [];
        let metadata = null;
        let loadedYears = new Set();

        // GZIP Decompression ve Yıl Yükleme Fonksiyonları
        async function loadMetadata() {
            try {
                const response = await fetch('data-metadata.json');
                if (!response.ok) throw new Error('Metadata yüklenemedi');
                metadata = await response.json();
                console.log('✅ Metadata yüklendi:', metadata);
                return metadata;
            } catch (error) {
                console.error('❌ Metadata hatası:', error);
                return null;
            }
        }

        async function loadYearData(year) {
            try {
                console.log(`📦 ${year} yükleniyor...`);
                
                // GZIP dosyasını indir
                const response = await fetch(`data-${year}.json.gz`);
                if (!response.ok) throw new Error(`${year} verisi bulunamadı`);
                
                // ArrayBuffer olarak al
                const arrayBuffer = await response.arrayBuffer();
                
                // GZIP açma - Evrensel yöntem
                let decompressed;
                
                // Yöntem 1: DecompressionStream (modern tarayıcılar)
                if (typeof DecompressionStream !== 'undefined') {
                    try {
                        const blob = new Blob([arrayBuffer]);
                        const ds = new DecompressionStream('gzip');
                        const stream = blob.stream().pipeThrough(ds);
                        decompressed = await new Response(stream).text();
                    } catch (e) {
                        console.warn('DecompressionStream başarısız, pako kullanılıyor:', e);
                        // Fallback to pako
                        const uint8Array = new Uint8Array(arrayBuffer);
                        const decompressedArray = pako.inflate(uint8Array);
                        decompressed = new TextDecoder().decode(decompressedArray);
                    }
                }
                // Yöntem 2: Pako.js (tüm tarayıcılar için fallback)
                else {
                    if (typeof pako === 'undefined') {
                        throw new Error('GZIP açma kütüphanesi yüklenmedi. Lütfen sayfayı yenileyin.');
                    }
                    const uint8Array = new Uint8Array(arrayBuffer);
                    const decompressedArray = pako.inflate(uint8Array);
                    decompressed = new TextDecoder().decode(decompressedArray);
                }
                
                // JSON'a çevir
                const yearData = JSON.parse(decompressed);
                
                console.log(`✅ ${year} yüklendi: ${yearData.details?.length || 0} kayıt`);
                
                loadedYears.add(year);
                return yearData;
                
            } catch (error) {
                console.error(`❌ ${year} yükleme hatası:`, error);
                throw error;
            }
        }

        async function loadData() {
            try {
                document.getElementById('dataStatus').innerHTML = '<span class="status-badge" style="background:#ffc107;color:#000;">⏳ Yükleniyor...</span>';
                document.getElementById('tableContainer').innerHTML = '<div style="text-align:center;padding:50px;font-size:1.2em;">⏳ Veriler yükleniyor, lütfen bekleyin...</div>';
                
                // İlk olarak metadata'yı yükle
                metadata = await loadMetadata();
                
                if (!metadata || !metadata.years || metadata.years.length === 0) {
                    throw new Error('Geçerli yıl verisi bulunamadı');
                }
                
                // En yeni yılı yükle (genellikle 2025)
                const latestYear = metadata.years[metadata.years.length - 1];
                const latestData = await loadYearData(latestYear);
                
                // İlk veriyi yükle
                allData = latestData.details || [];
                filteredData = [...allData];
                
                // Update info cards
                document.getElementById('dataStatus').innerHTML = `<span class="status-badge status-success">✅ ${latestYear}</span>`;
                document.getElementById('lastUpdate').textContent = metadata.last_update || '-';
                document.getElementById('totalRecords').textContent = allData.length.toLocaleString('tr-TR');
                
                // Calculate total USD
                let totalUSD = 0;
                if (allData && Array.isArray(allData)) {
                    totalUSD = allData.reduce((sum, item) => sum + (parseFloat(item.usd_amount) || 0), 0);
                }
                document.getElementById('totalUSD').textContent = '$' + totalUSD.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                populateFilters();
                updateSummary();
                renderTable();
                
                // Diğer yılları arka planda yükle
                setTimeout(() => loadRemainingYears(latestYear), 2000);
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('dataStatus').innerHTML = '<span class="status-badge status-error">❌ Hata</span>';
                document.getElementById('tableContainer').innerHTML = '<div class="error">❌ Veri yüklenirken hata oluştu!<br><small>' + error.message + '</small></div>';
            }
        }

        async function loadRemainingYears(skipYear) {
            if (!metadata || !metadata.years) return;
            
            console.log('📦 Diğer yıllar arka planda yükleniyor...');
            
            for (const year of metadata.years) {
                if (year === skipYear || loadedYears.has(year)) continue;
                
                try {
                    const yearData = await loadYearData(year);
                    
                    // Verileri birleştir
                    if (yearData.details && Array.isArray(yearData.details)) {
                        allData = [...allData, ...yearData.details];
                        filteredData = [...allData];
                        
                        // Filtreleri ve tabloyu güncelle
                        populateFilters();
                        updateSummary();
                        
                        // Status güncelle
                        const loadedYearsList = Array.from(loadedYears).sort().join(', ');
                        document.getElementById('dataStatus').innerHTML = `<span class="status-badge status-success">✅ ${loadedYearsList}</span>`;
                        document.getElementById('totalRecords').textContent = allData.length.toLocaleString('tr-TR');
                        
                        let totalUSD = allData.reduce((sum, item) => sum + (parseFloat(item.usd_amount) || 0), 0);
                        document.getElementById('totalUSD').textContent = '$' + totalUSD.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    }
                    
                } catch (error) {
                    console.error(`⚠️ ${year} yüklenemedi:`, error);
                }
            }
            
            console.log('✅ Tüm yıllar yüklendi!');
            const allYears = metadata.years.sort().join(', ');
            document.getElementById('dataStatus').innerHTML = `<span class="status-badge status-success">✅ Tüm Yıllar (${allYears})</span>`;
        }

        function populateFilters() {
            const brands = new Set();
            const cat1 = new Set();
            const cat2 = new Set();
            const cat3 = new Set();
            const cat4 = new Set();
            const salesPersons = new Set();
            const stores = new Set();
            const cities = new Set();
            const years = new Set();
            const months = new Set();
            const days = new Set();
            
            allData.forEach(item => {
                if (item.brand) brands.add(item.brand);
                if (item.category_1) cat1.add(item.category_1);
                if (item.category_2) cat2.add(item.category_2);
                if (item.category_3) cat3.add(item.category_3);
                if (item.category_4) cat4.add(item.category_4);
                if (item.sales_person) salesPersons.add(item.sales_person);
                if (item.store) stores.add(item.store);
                if (item.city) cities.add(item.city);
                
                // Tarih bilgilerini ayir
                if (item.date) {
                    const dateParts = item.date.split('-');
                    if (dateParts.length >= 3) {
                        years.add(dateParts[0]); // YYYY
                        months.add(dateParts[1]); // MM
                        days.add(dateParts[2]); // DD
                    }
                }
            });
            
            populateMultiSelect('filterBrand', Array.from(brands).sort(), 'countBrand');
            populateMultiSelect('filterCategory1', Array.from(cat1).sort(), 'countCategory1');
            populateMultiSelect('filterCategory2', Array.from(cat2).sort(), 'countCategory2');
            populateMultiSelect('filterCategory3', Array.from(cat3).sort(), 'countCategory3');
            populateMultiSelect('filterCategory4', Array.from(cat4).sort(), 'countCategory4');
            populateMultiSelect('filterSalesPerson', Array.from(salesPersons).sort(), 'countSalesPerson');
            populateMultiSelect('filterStore', Array.from(stores).sort(), 'countStore');
            populateMultiSelect('filterCity', Array.from(cities).sort(), 'countCity');
            populateMultiSelect('filterYear', Array.from(years).sort().reverse(), 'countYear'); // En yeni once
            populateMultiSelect('filterMonth', Array.from(months).sort(), 'countMonth');
            populateMultiSelect('filterDay', Array.from(days).sort(), 'countDay');
        }

        function populateMultiSelect(id, values, countId) {
            const container = document.getElementById(id);
            if (!container) return;
            
            // Mevcut seçimleri koru
            const currentChecked = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            
            container.innerHTML = '';
            
            values.forEach(value => {
                const item = document.createElement('div');
                item.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = value;
                checkbox.id = `${id}_${value.replace(/\s+/g, '_')}`;
                checkbox.checked = currentChecked.includes(value);
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = value;
                
                // Checkbox değiştiğinde sayıyı güncelle
                checkbox.addEventListener('change', () => updateSelectionCount(id, countId));
                
                item.appendChild(checkbox);
                item.appendChild(label);
                container.appendChild(item);
            });
            
            // İlk yüklemede sayıyı güncelle
            updateSelectionCount(id, countId);
        }
        
        function updateSelectionCount(containerId, countId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const count = container.querySelectorAll('input[type="checkbox"]:checked').length;
            const countSpan = document.getElementById(countId);
            if (countSpan) {
                if (count > 0) {
                    countSpan.textContent = `(${count} seçili)`;
                } else {
                    countSpan.textContent = '';
                }
            }
        }
        
        function getSelectedValues(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return [];
            
            return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        }
        
        // Checkbox'ları filtrele (arama kutusu için)
        function filterCheckboxes(containerId, searchText) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const searchLower = searchText.toLowerCase().trim();
            const items = container.querySelectorAll('.checkbox-item');
            
            items.forEach(item => {
                const label = item.querySelector('label');
                if (!label) return;
                
                const text = label.textContent.toLowerCase();
                
                if (searchLower === '' || text.includes(searchLower)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        function applyFilters() {
            const brands = getSelectedValues('filterBrand');
            const cat1s = getSelectedValues('filterCategory1');
            const cat2s = getSelectedValues('filterCategory2');
            const cat3s = getSelectedValues('filterCategory3');
            const cat4s = getSelectedValues('filterCategory4');
            const salesPersons = getSelectedValues('filterSalesPerson');
            const stores = getSelectedValues('filterStore');
            const cities = getSelectedValues('filterCity');
            const years = getSelectedValues('filterYear');
            const months = getSelectedValues('filterMonth');
            const days = getSelectedValues('filterDay');
            
            console.log('🔍 Çoklu Filtreler:', {
                brands: brands.length,
                cat1s: cat1s.length,
                cat2s: cat2s.length,
                cat3s: cat3s.length,
                cat4s: cat4s.length,
                salesPersons: salesPersons.length,
                stores: stores.length,
                cities: cities.length,
                years: years.length,
                months: months.length,
                days: days.length
            });
            
            filteredData = allData.filter(item => {
                // Marka filtresi (çoklu)
                if (brands.length > 0 && !brands.includes(item.brand)) return false;
                
                // Kategori filtreleri (çoklu)
                if (cat1s.length > 0 && !cat1s.includes(item.category_1)) return false;
                if (cat2s.length > 0 && !cat2s.includes(item.category_2)) return false;
                if (cat3s.length > 0 && !cat3s.includes(item.category_3)) return false;
                if (cat4s.length > 0 && !cat4s.includes(item.category_4)) return false;
                
                // Satis temsilcisi filtresi (çoklu)
                if (salesPersons.length > 0 && !salesPersons.includes(item.sales_person)) return false;
                
                // Magaza filtresi (çoklu) - KISMI ESLEME
                if (stores.length > 0) {
                    const itemStore = (item.store || '').toLowerCase();
                    const matches = stores.some(store => itemStore.includes(store.toLowerCase()));
                    if (!matches) return false;
                }
                
                // Sehir filtresi (çoklu)
                if (cities.length > 0 && !cities.includes(item.city)) return false;
                
                // Tarih filtreleri (çoklu)
                if (years.length > 0 || months.length > 0 || days.length > 0) {
                    if (!item.date) return false;
                    
                    const dateParts = item.date.split('-');
                    if (dateParts.length < 3) return false;
                    
                    if (years.length > 0 && !years.includes(dateParts[0])) return false;
                    if (months.length > 0 && !months.includes(dateParts[1])) return false;
                    if (days.length > 0 && !days.includes(dateParts[2])) return false;
                }
                
                return true;
            });
            
            console.log(`Filtreleme sonucu: ${filteredData.length} kayit`);
            
            // Debug panel goster
            const debugPanel = document.getElementById('debugPanel');
            const debugInfo = document.getElementById('debugInfo');
            if (filteredData.length > 0) {
                // Toplam USD ve Miktar hesapla
                const totalUSD = filteredData.reduce((sum, item) => sum + (parseFloat(item.usd_amount) || 0), 0);
                const totalQty = filteredData.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0), 0);
                
                // Benzersiz magazalari say
                const uniqueStores = new Set(filteredData.map(item => item.store)).size;
                
                // Tarih dagilimi
                const dateDistribution = {};
                filteredData.forEach(item => {
                    const date = item.date || 'Bilinmeyen';
                    dateDistribution[date] = (dateDistribution[date] || 0) + 1;
                });
                const topDates = Object.entries(dateDistribution).sort((a, b) => b[1] - a[1]).slice(0, 5);
                
                let debugText = `<strong>Toplam Kayit:</strong> ${allData.length.toLocaleString('tr-TR')}<br>`;
                debugText += `<strong>Filtrelenmis Kayit:</strong> ${filteredData.length.toLocaleString('tr-TR')}<br>`;
                debugText += `<strong>Toplam USD:</strong> $${totalUSD.toLocaleString('tr-TR', {minimumFractionDigits: 2})}<br>`;
                debugText += `<strong>Toplam Miktar:</strong> ${totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2})}<br>`;
                debugText += `<strong>Benzersiz Magaza:</strong> ${uniqueStores}<br><br>`;
                
                debugText += `<strong>Aktif Filtreler:</strong><br>`;
                if (stores.length > 0) debugText += `- Magaza: ${stores.join(', ')}<br>`;
                if (years.length > 0) debugText += `- Yil: ${years.join(', ')}<br>`;
                if (months.length > 0) debugText += `- Ay: ${months.join(', ')}<br>`;
                if (days.length > 0) debugText += `- Gun: ${days.join(', ')}<br>`;
                if (brands.length > 0) debugText += `- Marka: ${brands.join(', ')}<br>`;
                if (cat1s.length > 0) debugText += `- Kategori 1: ${cat1s.join(', ')}<br>`;
                
                debugText += `<br><strong>En Cok Kayit Olan 5 Gun:</strong><br>`;
                topDates.forEach(([date, count]) => {
                    debugText += `- ${date}: ${count} kayit<br>`;
                });
                
                debugText += `<br><strong>Ornek Kayitlar (ilk 3):</strong><br>`;
                for (let i = 0; i < Math.min(3, filteredData.length); i++) {
                    debugText += `<br>${i+1}. Tarih: ${filteredData[i].date} | Magaza: ${filteredData[i].store}<br>`;
                    debugText += `   USD: $${parseFloat(filteredData[i].usd_amount).toFixed(2)} | Miktar: ${filteredData[i].quantity}<br>`;
                    debugText += `   Musteri: ${filteredData[i].partner}<br>`;
                }
                
                debugInfo.innerHTML = debugText;
                debugPanel.style.display = 'block';
            }
            
            updateSummary();
            renderTable();
        }

        function resetFilters() {
            // Tüm checkbox'ların seçimlerini temizle
            ['filterBrand', 'filterCategory1', 'filterCategory2', 'filterCategory3', 'filterCategory4',
             'filterSalesPerson', 'filterStore', 'filterCity', 'filterYear', 'filterMonth', 'filterDay'].forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => cb.checked = false);
                }
            });
            
            // Seçim sayılarını güncelle
            ['countBrand', 'countCategory1', 'countCategory2', 'countCategory3', 'countCategory4',
             'countSalesPerson', 'countStore', 'countCity', 'countYear', 'countMonth', 'countDay'].forEach(id => {
                const countSpan = document.getElementById(id);
                if (countSpan) countSpan.textContent = '';
            });
            
            document.getElementById('smartSearch').value = '';
            document.getElementById('debugPanel').style.display = 'none';
            document.getElementById('aiAnalysisPanel').style.display = 'none';
            
            filteredData = [...allData];
            updateSummary();
            renderTable();
        }

        // 🤖 AI AGENT - Gelişmiş Doğal Dil İşleme Motoru
        function applySmartSearch() {
            const query = document.getElementById('smartSearch').value.trim();
            if (!query) {
                resetFilters();
                return;
            }
            
            console.log('🤖 AI AGENT BAŞLATILIYOR...');
            console.log('📝 Sorgu:', query);
            
            // Önce filtreleri sıfırla
            resetFilters();
            
            // AI Agent analizi
            const aiAnalysis = analyzeQueryWithAI(query);
            console.log('🧠 AI Analiz Sonucu:', aiAnalysis);
            
            // Filtreleri uygula
            applyAIFilters(aiAnalysis);
            
            // Veriyi filtrele
            filteredData = filterDataWithAI(allData, aiAnalysis);
            
            console.log(`✅ AI Agent Sonucu: ${filteredData.length} kayıt bulundu`);
            
            // Gelişmiş soru tipleri için özel analiz
            if (aiAnalysis.queryType !== 'basic') {
                performAdvancedAnalysis(aiAnalysis, filteredData);
            } else {
                // Kullanıcıya AI'nın ne anladığını göster
                showAIInterpretation(aiAnalysis, filteredData.length);
            }
            
            updateSummary();
            renderTable();
        }
        
        // 🧠 AI Analiz Motoru - GELİŞMİŞ VERSİYON
        function analyzeQueryWithAI(query) {
            const lowerQuery = query.toLowerCase();
            const analysis = {
                intent: 'search', // search, filter, analyze, compare, recommendation
                queryType: 'basic', // basic, person_analysis, city_analysis, product_recommendation
                entities: {
                    stores: [],
                    brands: [],
                    categories: [],
                    cities: [],
                    salesPersons: [],
                    products: [],
                    dateRange: null,
                    years: [],
                    months: [],
                    keywords: []
                },
                question: {
                    type: null, // "who_sold_what", "city_bought_what", "where_to_sell", "best_for"
                    subject: null, // Kişi adı, şehir adı, ürün adı
                    object: null, // Ürün, marka, kategori
                    action: null // "sattı", "aldı", "satmalı", "konumlandırmalı"
                },
                confidence: 0,
                interpretation: '',
                needsGPT: false // Karmaşık soru mu?
            };
            
            // ==================== GELİŞMİŞ SORU TİPİ TESPİTİ ====================
            
            // 1. "X en çok hangi Y sattı/aldı?" pattern
            const personSoldPattern = /(.+?)\s+(en\s+çok|en\s+fazla)?\s*hangi\s+(ürün|marka|kategori|model).*?(sattı|satmış|satıyor)/i;
            const personSoldMatch = query.match(personSoldPattern);
            
            if (personSoldMatch) {
                analysis.queryType = 'person_analysis';
                analysis.question.type = 'who_sold_what';
                analysis.question.subject = personSoldMatch[1].trim();
                analysis.question.object = personSoldMatch[3]; // ürün, marka, kategori
                analysis.question.action = 'sattı';
                analysis.intent = 'analyze';
                console.log('🎯 Tespit: Kişi analizi -', analysis.question.subject, 'hangi', analysis.question.object, 'sattı?');
            }
            
            // 2. "X hangi Y aldı?" pattern (Şehir/Müşteri bazlı)
            const cityBoughtPattern = /(.+?)\s+(en\s+çok|en\s+fazla)?\s*hangi\s+(marka|model|kategori|ürün).*?(aldı|almış|alıyor|satın\s+aldı)/i;
            const cityBoughtMatch = query.match(cityBoughtPattern);
            
            if (cityBoughtMatch) {
                analysis.queryType = 'city_analysis';
                analysis.question.type = 'city_bought_what';
                analysis.question.subject = cityBoughtMatch[1].trim();
                analysis.question.object = cityBoughtMatch[3];
                analysis.question.action = 'aldı';
                analysis.intent = 'analyze';
                console.log('🎯 Tespit: Şehir/Müşteri analizi -', analysis.question.subject, 'hangi', analysis.question.object, 'aldı?');
            }
            
            // 3. "Hangi X'de Y daha çok satıyor/satar?" pattern (Öneri)
            const whereToSellPattern = /hangi\s+(mağaza|şehir|yer).*?(satmalı|satmalıyım|satmak|konumlandır|daha\s+çok\s+sat)/i;
            const whereToSellMatch = query.match(whereToSellPattern);
            
            if (whereToSellMatch) {
                analysis.queryType = 'product_recommendation';
                analysis.question.type = 'where_to_sell';
                analysis.question.action = 'satmalı';
                analysis.intent = 'recommendation';
                analysis.needsGPT = true; // Öneri için GPT kullanılabilir
                console.log('🎯 Tespit: Ürün konumlandırma önerisi');
            }
            
            // 4. "X için en iyi Y nedir?" pattern
            const bestForPattern = /(.+?)\s+için\s+en\s+iyi\s+(mağaza|şehir|yer|kategori)/i;
            const bestForMatch = query.match(bestForPattern);
            
            if (bestForMatch) {
                analysis.queryType = 'product_recommendation';
                analysis.question.type = 'best_for';
                analysis.question.subject = bestForMatch[1].trim();
                analysis.question.object = bestForMatch[2];
                analysis.intent = 'recommendation';
                console.log('🎯 Tespit: En iyi yer önerisi -', analysis.question.subject, 'için');
            }
            
            // 5. "Hangi X Y'de popüler/çok satıyor?" pattern
            const popularWherePattern = /hangi\s+(ürün|marka|kategori).*?(şehir|mağaza|yer).*?(popüler|çok\s+sat|başarılı)/i;
            const popularWhereMatch = query.match(popularWherePattern);
            
            if (popularWhereMatch) {
                analysis.queryType = 'city_analysis';
                analysis.question.type = 'what_popular_where';
                analysis.question.object = popularWhereMatch[1];
                analysis.intent = 'analyze';
                console.log('🎯 Tespit: Popülerlik analizi');
            }
            
            // 1. MAĞAZA TESPİTİ (Fuzzy matching ile)
            const allStores = [...new Set(allData.map(item => item.store).filter(Boolean))];
            allStores.forEach(store => {
                const storeLower = store.toLowerCase();
                // Tam eşleşme veya kısmi eşleşme
                if (lowerQuery.includes(storeLower) || 
                    storeLower.includes(lowerQuery) ||
                    fuzzyMatch(lowerQuery, storeLower)) {
                    analysis.entities.stores.push(store);
                }
            });
            
            // Yaygın mağaza kısaltmaları
            const storeAliases = {
                'aka': 'akasya', 'kadi': 'kadıköy', 'kadı': 'kadıköy',
                'beylik': 'beylikdüzü', 'beyl': 'beylikdüzü'
            };
            for (const [alias, fullName] of Object.entries(storeAliases)) {
                if (lowerQuery.includes(alias)) {
                    const matchingStores = allStores.filter(s => s.toLowerCase().includes(fullName));
                    analysis.entities.stores.push(...matchingStores);
                }
            }
            
            // 2. MARKA TESPİTİ
            const allBrands = [...new Set(allData.map(item => item.brand).filter(Boolean))];
            allBrands.forEach(brand => {
                if (lowerQuery.includes(brand.toLowerCase())) {
                    analysis.entities.brands.push(brand);
                }
            });
            
            // 3. KATEGORİ TESPİTİ (Tüm seviyeler)
            const allCategories = new Set();
            allData.forEach(item => {
                [item.category_1, item.category_2, item.category_3, item.category_4].forEach(cat => {
                    if (cat) allCategories.add(cat);
                });
            });
            Array.from(allCategories).forEach(category => {
                if (lowerQuery.includes(category.toLowerCase())) {
                    analysis.entities.categories.push(category);
                }
            });
            
            // Yaygın kategori anahtar kelimeleri
            const categoryKeywords = {
                'gitar': ['gitar', 'guitar'],
                'piyano': ['piyano', 'piano'],
                'davul': ['davul', 'drum', 'bateri'],
                'keman': ['keman', 'violin'],
                'saz': ['saz', 'bağlama'],
                'aksesu': ['aksesuar', 'aksesuarlar']
            };
            for (const [key, keywords] of Object.entries(categoryKeywords)) {
                if (keywords.some(kw => lowerQuery.includes(kw))) {
                    const matchingCats = Array.from(allCategories).filter(c => 
                        c.toLowerCase().includes(key)
                    );
                    analysis.entities.categories.push(...matchingCats);
                }
            }
            
            // 4. TARİH ANALİZİ (Gelişmiş)
            // "son X gün/ay" tespiti
            const timePatterns = [
                /son\s+(\d+)\s+(gün|gun)/i,
                /son\s+(\d+)\s+(ay)/i,
                /son\s+(\d+)\s+(hafta)/i,
                /geçen\s+(\d+)\s+(gün|gun|ay|hafta)/i,
                /gecen\s+(\d+)\s+(gün|gun|ay|hafta)/i
            ];
            
            for (const pattern of timePatterns) {
                const match = query.match(pattern);
                if (match) {
                    const amount = parseInt(match[1]);
                    const unit = match[2].toLowerCase();
                    const today = new Date();
                    
                    if (unit.includes('ay')) {
                        today.setMonth(today.getMonth() - amount);
                    } else if (unit.includes('hafta')) {
                        today.setDate(today.getDate() - (amount * 7));
                    } else {
                        today.setDate(today.getDate() - amount);
                    }
                    
                    analysis.entities.dateRange = {
                        from: today.toISOString().split('T')[0],
                        to: new Date().toISOString().split('T')[0],
                        description: `Son ${amount} ${unit}`
                    };
                    break;
                }
            }
            
            // Ay isimleri (Türkçe ve İngilizce)
            const monthNames = {
                'ocak': '01', 'january': '01', 'jan': '01',
                'şubat': '02', 'subat': '02', 'february': '02', 'feb': '02',
                'mart': '03', 'march': '03', 'mar': '03',
                'nisan': '04', 'april': '04', 'apr': '04',
                'mayıs': '05', 'mayis': '05', 'may': '05',
                'haziran': '06', 'june': '06', 'jun': '06',
                'temmuz': '07', 'july': '07', 'jul': '07',
                'ağustos': '08', 'agustos': '08', 'august': '08', 'aug': '08',
                'eylül': '09', 'eylul': '09', 'september': '09', 'sep': '09',
                'ekim': '10', 'october': '10', 'oct': '10',
                'kasım': '11', 'kasim': '11', 'november': '11', 'nov': '11',
                'aralık': '12', 'aralik': '12', 'december': '12', 'dec': '12'
            };
            
            for (const [monthName, monthNum] of Object.entries(monthNames)) {
                if (lowerQuery.includes(monthName)) {
                    analysis.entities.months.push(monthNum);
                }
            }
            
            // Yıl tespiti (2020-2030)
            const yearMatches = query.match(/\b(202[0-9])\b/g);
            if (yearMatches) {
                analysis.entities.years.push(...yearMatches);
            }
            
            // 5. ŞEHİR TESPİTİ
            const allCities = [...new Set(allData.map(item => item.city).filter(Boolean))];
            allCities.forEach(city => {
                if (lowerQuery.includes(city.toLowerCase())) {
                    analysis.entities.cities.push(city);
                }
            });
            
            // 6. SATIŞ TEMSİLCİSİ TESPİTİ (Fuzzy matching ile)
            const allSalesPersons = [...new Set(allData.map(item => item.sales_person).filter(Boolean))];
            allSalesPersons.forEach(person => {
                const personLower = person.toLowerCase();
                // Tam eşleşme veya kısmi eşleşme (ad veya soyad)
                const queryWords = lowerQuery.split(/\s+/);
                const personWords = personLower.split(/\s+/);
                
                const matches = queryWords.some(qw => 
                    personWords.some(pw => pw.includes(qw) || qw.includes(pw))
                );
                
                if (matches || lowerQuery.includes(personLower)) {
                    analysis.entities.salesPersons.push(person);
                }
            });
            
            // 6.5. ÜRÜN TESPİTİ (Yeni ürün önerileri için)
            const allProducts = [...new Set(allData.map(item => item.product).filter(Boolean))];
            
            // Ürün anahtar kelimeleri
            const productKeywords = {
                'gitar': ['gitar', 'guitar', 'elektro gitar', 'akustik gitar'],
                'piyano': ['piyano', 'piano', 'dijital piyano', 'akustik piyano'],
                'davul': ['davul', 'drum', 'bateri', 'davul seti'],
                'keman': ['keman', 'violin'],
                'saz': ['saz', 'bağlama'],
                'amfi': ['amfi', 'amplifier', 'amplifikatör']
            };
            
            for (const [key, keywords] of Object.entries(productKeywords)) {
                if (keywords.some(kw => lowerQuery.includes(kw))) {
                    const matchingProducts = allProducts.filter(p => 
                        p.toLowerCase().includes(key)
                    );
                    analysis.entities.products.push(...matchingProducts.slice(0, 5)); // İlk 5 ürün
                }
            }
            
            // 7. GENEL ANAHTAR KELİMELER
            const stopWords = ['ve', 'veya', 'ile', 'için', 'son', 'gün', 'gun', 'ay', 'yıl', 'yil', 
                               'toplam', 'kaç', 'kac', 'ne', 'kadar', 'göster', 'goster', 'bul', 'ara'];
            const words = query.toLowerCase().split(/\s+/).filter(w => 
                w.length > 2 && !stopWords.includes(w) && !/^\d+$/.test(w)
            );
            analysis.entities.keywords = words;
            
            // 8. GÜVENİLİRLİK SKORU
            let confidence = 0;
            if (analysis.entities.stores.length > 0) confidence += 30;
            if (analysis.entities.brands.length > 0) confidence += 25;
            if (analysis.entities.categories.length > 0) confidence += 20;
            if (analysis.entities.dateRange || analysis.entities.years.length > 0 || analysis.entities.months.length > 0) confidence += 15;
            if (analysis.entities.keywords.length > 0) confidence += 10;
            analysis.confidence = Math.min(confidence, 100);
            
            // 9. YORUMLAMA
            const parts = [];
            if (analysis.entities.stores.length > 0) parts.push(`Mağaza: ${analysis.entities.stores.join(', ')}`);
            if (analysis.entities.brands.length > 0) parts.push(`Marka: ${analysis.entities.brands.join(', ')}`);
            if (analysis.entities.categories.length > 0) parts.push(`Kategori: ${analysis.entities.categories.join(', ')}`);
            if (analysis.entities.dateRange) parts.push(`Tarih: ${analysis.entities.dateRange.description}`);
            else if (analysis.entities.years.length > 0) parts.push(`Yıl: ${analysis.entities.years.join(', ')}`);
            if (analysis.entities.months.length > 0) parts.push(`Ay: ${analysis.entities.months.join(', ')}`);
            if (analysis.entities.keywords.length > 0) parts.push(`Anahtar: ${analysis.entities.keywords.join(', ')}`);
            
            analysis.interpretation = parts.length > 0 ? parts.join(' | ') : 'Genel arama';
            
            return analysis;
        }
        
        // 🎯 Fuzzy Matching (Benzerlik skoru)
        function fuzzyMatch(query, target) {
            const queryWords = query.split(/\s+/);
            const targetLower = target.toLowerCase();
            return queryWords.some(word => {
                if (word.length < 3) return false;
                return targetLower.includes(word) || levenshteinDistance(word, targetLower) < 3;
            });
        }
        
        // 📏 Levenshtein Distance (Düzenleme mesafesi)
        function levenshteinDistance(a, b) {
            const matrix = [];
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[b.length][a.length];
        }
        
        // 🔧 AI Filtrelerini Uygula
        function applyAIFilters(analysis) {
            // Mağaza filtrelerini seç
            if (analysis.entities.stores.length > 0) {
                const storeContainer = document.getElementById('filterStore');
                if (storeContainer) {
                    const checkboxes = storeContainer.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        if (analysis.entities.stores.some(store => 
                            cb.value.toLowerCase().includes(store.toLowerCase())
                        )) {
                            cb.checked = true;
                        }
                    });
                    updateSelectionCount('filterStore', 'countStore');
                }
            }
            
            // Marka filtrelerini seç
            if (analysis.entities.brands.length > 0) {
                const brandContainer = document.getElementById('filterBrand');
                if (brandContainer) {
                    const checkboxes = brandContainer.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        if (analysis.entities.brands.includes(cb.value)) {
                            cb.checked = true;
                        }
                    });
                    updateSelectionCount('filterBrand', 'countBrand');
                }
            }
            
            // Yıl filtrelerini seç
            if (analysis.entities.years.length > 0) {
                const yearContainer = document.getElementById('filterYear');
                if (yearContainer) {
                    const checkboxes = yearContainer.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        if (analysis.entities.years.includes(cb.value)) {
                            cb.checked = true;
                        }
                    });
                    updateSelectionCount('filterYear', 'countYear');
                }
            }
            
            // Ay filtrelerini seç
            if (analysis.entities.months.length > 0) {
                const monthContainer = document.getElementById('filterMonth');
                if (monthContainer) {
                    const checkboxes = monthContainer.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        if (analysis.entities.months.includes(cb.value)) {
                            cb.checked = true;
                        }
                    });
                    updateSelectionCount('filterMonth', 'countMonth');
                }
            }
        }
        
        // 🔍 AI ile Veri Filtreleme
        function filterDataWithAI(data, analysis) {
            return data.filter(item => {
                // Mağaza kontrolü
                if (analysis.entities.stores.length > 0) {
                    const itemStore = (item.store || '').toLowerCase();
                    const matches = analysis.entities.stores.some(store => 
                        itemStore.includes(store.toLowerCase())
                    );
                    if (!matches) return false;
                }
                
                // Marka kontrolü
                if (analysis.entities.brands.length > 0) {
                    if (!analysis.entities.brands.includes(item.brand)) return false;
                }
                
                // Kategori kontrolü (tüm seviyeler)
                if (analysis.entities.categories.length > 0) {
                    const itemCategories = [item.category_1, item.category_2, item.category_3, item.category_4]
                        .filter(Boolean).map(c => c.toLowerCase());
                    const matches = analysis.entities.categories.some(cat => 
                        itemCategories.some(ic => ic.includes(cat.toLowerCase()) || cat.toLowerCase().includes(ic))
                    );
                    if (!matches) return false;
                }
                
                // Tarih aralığı kontrolü
                if (analysis.entities.dateRange) {
                    if (!item.date || item.date < analysis.entities.dateRange.from) return false;
                }
                
                // Yıl kontrolü
                if (analysis.entities.years.length > 0 && item.date) {
                    const itemYear = item.date.split('-')[0];
                    if (!analysis.entities.years.includes(itemYear)) return false;
                }
                
                // Ay kontrolü
                if (analysis.entities.months.length > 0 && item.date) {
                    const itemMonth = item.date.split('-')[1];
                    if (!analysis.entities.months.includes(itemMonth)) return false;
                }
                
                // Şehir kontrolü
                if (analysis.entities.cities.length > 0) {
                    if (!analysis.entities.cities.includes(item.city)) return false;
                }
                
                // Satış temsilcisi kontrolü
                if (analysis.entities.salesPersons.length > 0) {
                    if (!analysis.entities.salesPersons.includes(item.sales_person)) return false;
                }
                
                // Anahtar kelime kontrolü (fuzzy)
                if (analysis.entities.keywords.length > 0) {
                    const searchableText = [
                        item.partner, item.product, item.brand,
                        item.category_1, item.category_2, item.category_3, item.category_4,
                        item.sales_person, item.store, item.city
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    const matches = analysis.entities.keywords.some(keyword => 
                        searchableText.includes(keyword)
                    );
                    if (!matches) return false;
                }
                
                return true;
            });
        }
        
        // 💬 AI Yorumunu Göster
        function showAIInterpretation(analysis, resultCount) {
            const debugPanel = document.getElementById('debugPanel');
            const debugInfo = document.getElementById('debugInfo');
            
            let html = `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">`;
            html += `<h4 style="margin: 0 0 10px 0; color: white;">🤖 AI Agent Analizi</h4>`;
            html += `<p style="margin: 5px 0; font-size: 0.95em;"><strong>Anladığım:</strong> ${analysis.interpretation}</p>`;
            html += `<p style="margin: 5px 0; font-size: 0.9em;">📊 Güvenilirlik: ${analysis.confidence}% | 🎯 Sonuç: ${resultCount} kayıt</p>`;
            html += `</div>`;
            
            html += `<strong>🔍 Tespit Edilen Varlıklar:</strong><br>`;
            if (analysis.entities.stores.length > 0) html += `🏪 Mağazalar: ${analysis.entities.stores.join(', ')}<br>`;
            if (analysis.entities.brands.length > 0) html += `🏷️ Markalar: ${analysis.entities.brands.join(', ')}<br>`;
            if (analysis.entities.categories.length > 0) html += `📂 Kategoriler: ${analysis.entities.categories.join(', ')}<br>`;
            if (analysis.entities.dateRange) html += `📅 Tarih: ${analysis.entities.dateRange.description}<br>`;
            if (analysis.entities.years.length > 0) html += `📆 Yıl: ${analysis.entities.years.join(', ')}<br>`;
            if (analysis.entities.months.length > 0) html += `📆 Ay: ${analysis.entities.months.join(', ')}<br>`;
            if (analysis.entities.cities.length > 0) html += `🌍 Şehir: ${analysis.entities.cities.join(', ')}<br>`;
            if (analysis.entities.salesPersons.length > 0) html += `👤 Satış Tem.: ${analysis.entities.salesPersons.join(', ')}<br>`;
            if (analysis.entities.keywords.length > 0) html += `🔑 Anahtar Kelimeler: ${analysis.entities.keywords.join(', ')}<br>`;
            
            debugInfo.innerHTML = html;
            debugPanel.style.display = 'block';
        }
        
        // 🎯 GELİŞMİŞ ANALİZ (Kişi, Şehir, Öneri Sorguları)
        function performAdvancedAnalysis(analysis, data) {
            console.log('🎯 Gelişmiş analiz başlatılıyor:', analysis.queryType);
            
            const debugPanel = document.getElementById('debugPanel');
            const debugInfo = document.getElementById('debugInfo');
            
            let html = `<div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px;">`;
            html += `<h3 style="margin: 0 0 15px 0; color: white;">🤖 Gelişmiş AI Analizi</h3>`;
            
            if (analysis.queryType === 'person_analysis') {
                // "Mustafa Kılıç en çok hangi ürünü sattı?"
                const personName = analysis.question.subject;
                const objectType = analysis.question.object; // ürün, marka, kategori
                
                // Kişinin verilerini filtrele
                const personData = data.filter(item => 
                    item.sales_person && item.sales_person.toLowerCase().includes(personName.toLowerCase())
                );
                
                if (personData.length === 0) {
                    html += `<p>⚠️ "${personName}" adlı satış temsilcisi bulunamadı.</p>`;
                } else {
                    // Analiz yap
                    const results = {};
                    personData.forEach(item => {
                        let key;
                        if (objectType === 'ürün') key = item.product;
                        else if (objectType === 'marka') key = item.brand;
                        else if (objectType === 'kategori') key = item.category_1;
                        else if (objectType === 'model') key = item.product;
                        
                        if (key) {
                            if (!results[key]) results[key] = {sales: 0, count: 0};
                            results[key].sales += parseFloat(item.usd_amount || 0);
                            results[key].count += 1;
                        }
                    });
                    
                    // Sırala
                    const sorted = Object.entries(results).sort((a, b) => b[1].sales - a[1].sales);
                    const top5 = sorted.slice(0, 5);
                    
                    html += `<p style="font-size: 1.1em; margin-bottom: 15px;">📊 <strong>${personName}</strong> analizi:</p>`;
                    html += `<p>💰 Toplam Satış: <strong>$${personData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</strong></p>`;
                    html += `<p>📦 Toplam İşlem: <strong>${personData.length}</strong></p>`;
                    html += `<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">`;
                    html += `<p style="font-size: 1.05em; margin-bottom: 10px;">🏆 En Çok Sattığı ${objectType.charAt(0).toUpperCase() + objectType.slice(1)}ler:</p>`;
                    
                    top5.forEach((item, index) => {
                        html += `<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 5px; margin: 8px 0;">`;
                        html += `<strong>${index + 1}. ${item[0]}</strong><br>`;
                        html += `💰 Satış: $${item[1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} | 📦 Adet: ${item[1].count}`;
                        html += `</div>`;
                    });
                    
                    // Öneri
                    html += `<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">`;
                    html += `<p style="font-size: 1em;">💡 <strong>Öneri:</strong> ${personName}, <strong>${top5[0][0]}</strong> konusunda uzman. Bu ${objectType}'e odaklanmalı ve stok takibi yapmalı.</p>`;
                }
                
            } else if (analysis.queryType === 'city_analysis') {
                // "İstanbul en çok hangi marka piyano aldı?"
                const cityName = analysis.question.subject;
                const objectType = analysis.question.object; // marka, model, kategori
                
                // Şehir verilerini filtrele
                let cityData = data.filter(item => 
                    item.city && item.city.toLowerCase().includes(cityName.toLowerCase())
                );
                
                // Eğer partner adı ise
                if (cityData.length === 0) {
                    cityData = data.filter(item => 
                        item.partner && item.partner.toLowerCase().includes(cityName.toLowerCase())
                    );
                }
                
                if (cityData.length === 0) {
                    html += `<p>⚠️ "${cityName}" için veri bulunamadı.</p>`;
                } else {
                    // Analiz yap
                    const results = {};
                    cityData.forEach(item => {
                        let key;
                        if (objectType === 'marka') key = item.brand;
                        else if (objectType === 'model') key = item.product;
                        else if (objectType === 'kategori') key = item.category_1;
                        else if (objectType === 'ürün') key = item.product;
                        
                        if (key) {
                            if (!results[key]) results[key] = {sales: 0, count: 0};
                            results[key].sales += parseFloat(item.usd_amount || 0);
                            results[key].count += 1;
                        }
                    });
                    
                    // Sırala
                    const sorted = Object.entries(results).sort((a, b) => b[1].sales - a[1].sales);
                    const top5 = sorted.slice(0, 5);
                    
                    html += `<p style="font-size: 1.1em; margin-bottom: 15px;">📊 <strong>${cityName}</strong> analizi:</p>`;
                    html += `<p>💰 Toplam Satış: <strong>$${cityData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</strong></p>`;
                    html += `<p>📦 Toplam İşlem: <strong>${cityData.length}</strong></p>`;
                    html += `<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">`;
                    html += `<p style="font-size: 1.05em; margin-bottom: 10px;">🏆 En Çok Tercih Edilen ${objectType.charAt(0).toUpperCase() + objectType.slice(1)}ler:</p>`;
                    
                    top5.forEach((item, index) => {
                        html += `<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 5px; margin: 8px 0;">`;
                        html += `<strong>${index + 1}. ${item[0]}</strong><br>`;
                        html += `💰 Satış: $${item[1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} | 📦 Adet: ${item[1].count}`;
                        html += `</div>`;
                    });
                    
                    // Öneri
                    html += `<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">`;
                    html += `<p style="font-size: 1em;">💡 <strong>Öneri:</strong> ${cityName}'da <strong>${top5[0][0]}</strong> en popüler. Bu ${objectType} için stok artırılmalı.</p>`;
                }
                
            } else if (analysis.queryType === 'product_recommendation') {
                // "Hangi mağazada bu ürünü satmalıyım?"
                html += `<p style="font-size: 1.1em; margin-bottom: 15px;">🎯 Ürün Konumlandırma Önerisi</p>`;
                
                // Kategori veya marka bazlı analiz
                const categoryData = {};
                const storeData = {};
                
                data.forEach(item => {
                    const store = item.store || 'Bilinmiyor';
                    const category = item.category_1 || 'Bilinmiyor';
                    
                    if (!storeData[store]) storeData[store] = {sales: 0, count: 0, categories: {}};
                    storeData[store].sales += parseFloat(item.usd_amount || 0);
                    storeData[store].count += 1;
                    
                    if (!storeData[store].categories[category]) storeData[store].categories[category] = 0;
                    storeData[store].categories[category] += parseFloat(item.usd_amount || 0);
                });
                
                // En başarılı mağazaları bul
                const sortedStores = Object.entries(storeData).sort((a, b) => b[1].sales - a[1].sales);
                const top3Stores = sortedStores.slice(0, 3);
                
                html += `<p>📊 Mağaza Performans Analizi:</p>`;
                
                top3Stores.forEach((store, index) => {
                    const storeName = store[0];
                    const storeStats = store[1];
                    const topCategory = Object.entries(storeStats.categories).sort((a, b) => b[1] - a[1])[0];
                    
                    html += `<div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 5px; margin: 10px 0;">`;
                    html += `<strong>${index + 1}. ${storeName}</strong><br>`;
                    html += `💰 Toplam Satış: $${storeStats.sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}<br>`;
                    html += `📦 İşlem Sayısı: ${storeStats.count}<br>`;
                    html += `🏆 En Güçlü Kategori: ${topCategory[0]}`;
                    html += `</div>`;
                });
                
                // Öneri
                html += `<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">`;
                html += `<p style="font-size: 1em;">💡 <strong>Öneri:</strong></p>`;
                html += `<p>• <strong>${top3Stores[0][0]}</strong> en yüksek satış performansına sahip.</p>`;
                html += `<p>• Yeni ürün için bu mağazayı tercih edin.</p>`;
                html += `<p>• Özellikle <strong>${Object.entries(top3Stores[0][1].categories).sort((a, b) => b[1] - a[1])[0][0]}</strong> kategorisinde güçlü.</p>`;
                
                if (analysis.needsGPT) {
                    html += `<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">`;
                    html += `<p style="font-size: 0.9em; opacity: 0.9;">🤖 <em>Daha detaylı analiz için GPT-4 kullanılabilir. (İsteğe bağlı)</em></p>`;
                }
            }
            
            html += `</div>`;
            
            debugInfo.innerHTML = html;
            debugPanel.style.display = 'block';
        }

        function updateSummary() {
            console.log('updateSummary - Filtrelenmis veri sayisi:', filteredData.length);
            
            const totalUSD = filteredData.reduce((sum, item) => sum + (parseFloat(item.usd_amount) || 0), 0);
            const totalQty = filteredData.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0), 0);
            const uniquePartners = new Set(filteredData.map(item => item.partner)).size;
            const uniqueProducts = new Set(filteredData.map(item => item.product)).size;
            
            console.log('Ozet:', {totalUSD, totalQty, uniquePartners, uniqueProducts});
            
            document.getElementById('summaryUSD').textContent = '$' + totalUSD.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('summaryQuantity').textContent = totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            document.getElementById('summaryPartners').textContent = uniquePartners.toLocaleString('tr-TR');
            document.getElementById('summaryProducts').textContent = uniqueProducts.toLocaleString('tr-TR');
            
            // AI Analiz yap
            if (filteredData.length > 0) {
                performAIAnalysis();
            }
        }

        // Chart.js instances
        let topCategoryChart = null;
        let topBrandChart = null;
        let topProductChart = null;
        let topSalesPersonChart = null;
        
        function renderTable() {
            const container = document.getElementById('tableContainer');
            
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="loading">⚠️ Filtreye uygun veri bulunamadi.</div>';
                return;
            }
            
            // Veriyi analiz et
            const categoryData = {};
            const brandData = {};
            const productData = {};
            const salesPersonData = {};
            
            filteredData.forEach(item => {
                // Kategori
                const cat = item.category_1 || 'Bilinmiyor';
                if (!categoryData[cat]) categoryData[cat] = 0;
                categoryData[cat] += parseFloat(item.usd_amount || 0);
                
                // Marka
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += parseFloat(item.usd_amount || 0);
                
                // Ürün
                const product = item.product || 'Bilinmiyor';
                if (!productData[product]) productData[product] = 0;
                productData[product] += parseFloat(item.usd_amount || 0);
                
                // Satış Temsilcisi
                const person = item.sales_person || 'Bilinmiyor';
                if (!salesPersonData[person]) salesPersonData[person] = 0;
                salesPersonData[person] += parseFloat(item.usd_amount || 0);
            });
            
            // Top 10'ları al
            const topCategories = Object.entries(categoryData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const topBrands = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const topProducts = Object.entries(productData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const topSalesPersons = Object.entries(salesPersonData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            // HTML oluştur
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 30px; margin-top: 30px;">
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 20px;">🏆 En Başarılı Kategoriler</h3>
                        <canvas id="topCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 20px;">🏷️ En Çok Satan Markalar</h3>
                        <canvas id="topBrandChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 20px;">⭐ En Çok Satan Ürünler</h3>
                        <canvas id="topProductChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 20px;">👤 En Başarılı Satış Temsilcileri</h3>
                        <canvas id="topSalesPersonChart"></canvas>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Grafikleri render et
            setTimeout(() => {
                renderTopCategoryChart(topCategories);
                renderTopBrandChart(topBrands);
                renderTopProductChart(topProducts);
                renderTopSalesPersonChart(topSalesPersons);
            }, 100);
        }
        
        function renderTopCategoryChart(data) {
            const ctx = document.getElementById('topCategoryChart');
            if (!ctx) return;
            
            if (topCategoryChart) {
                topCategoryChart.destroy();
            }
            
            topCategoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d[0]),
                    datasets: [{
                        label: 'Satış ($)',
                        data: data.map(d => d[1]),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderTopBrandChart(data) {
            const ctx = document.getElementById('topBrandChart');
            if (!ctx) return;
            
            if (topBrandChart) {
                topBrandChart.destroy();
            }
            
            topBrandChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d[0]),
                    datasets: [{
                        label: 'Satış ($)',
                        data: data.map(d => d[1]),
                        backgroundColor: 'rgba(56, 239, 125, 0.8)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderTopProductChart(data) {
            const ctx = document.getElementById('topProductChart');
            if (!ctx) return;
            
            if (topProductChart) {
                topProductChart.destroy();
            }
            
            topProductChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d[0].substring(0, 30) + (d[0].length > 30 ? '...' : '')),
                    datasets: [{
                        label: 'Satış ($)',
                        data: data.map(d => d[1]),
                        backgroundColor: 'rgba(245, 87, 108, 0.8)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false},
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return data[context[0].dataIndex][0];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderTopSalesPersonChart(data) {
            const ctx = document.getElementById('topSalesPersonChart');
            if (!ctx) return;
            
            if (topSalesPersonChart) {
                topSalesPersonChart.destroy();
            }
            
            topSalesPersonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d[0]),
                    datasets: [{
                        label: 'Satış ($)',
                        data: data.map(d => d[1]),
                        backgroundColor: 'rgba(240, 147, 251, 0.8)',
                        borderColor: 'rgba(240, 147, 251, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==================== TAB SYSTEM ====================
        function switchTab(tabName) {
            // Tüm tab'ları gizle
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Seçili tab'ı göster
            if (tabName === 'sales') {
                document.getElementById('salesTab').classList.add('active');
                document.querySelectorAll('.tab')[0].classList.add('active');
            } else if (tabName === 'targets') {
                document.getElementById('targetsTab').classList.add('active');
                document.querySelectorAll('.tab')[1].classList.add('active');
                calculateTargets();
            } else if (tabName === 'customers') {
                document.getElementById('customersTab').classList.add('active');
                document.querySelectorAll('.tab')[2].classList.add('active');
                analyzeCustomers();
            } else if (tabName === 'time') {
                document.getElementById('timeTab').classList.add('active');
                document.querySelectorAll('.tab')[3].classList.add('active');
                analyzeTime();
            } else if (tabName === 'product') {
                document.getElementById('productTab').classList.add('active');
                document.querySelectorAll('.tab')[4].classList.add('active');
            }
        }
        
        // ==================== EXCEL EXPORT ====================
        function exportToExcel() {
            if (filteredData.length === 0) {
                alert('⚠️ Dışa aktarılacak veri yok!');
                return;
            }
            
            console.log('📥 Excel export başlatılıyor...');
            
            // Veriyi Excel formatına dönüştür
            const excelData = filteredData.map(item => ({
                'İş Ortağı': item.partner || '',
                'Ürün': item.product || '',
                'Marka': item.brand || '',
                'Kategori 1': item.category_1 || '',
                'Kategori 2': item.category_2 || '',
                'Kategori 3': item.category_3 || '',
                'Kategori 4': item.category_4 || '',
                'Satış Temsilcisi': item.sales_person || '',
                'Mağaza': item.store || '',
                'Şehir': item.city || '',
                'Tarih': item.date || '',
                'Miktar': parseFloat(item.quantity || 0),
                'USD Tutar': parseFloat(item.usd_amount || 0)
            }));
            
            // Özet satırı ekle
            const summary = {
                'İş Ortağı': 'TOPLAM',
                'Ürün': '',
                'Marka': '',
                'Kategori 1': '',
                'Kategori 2': '',
                'Kategori 3': '',
                'Kategori 4': '',
                'Satış Temsilcisi': '',
                'Mağaza': '',
                'Şehir': '',
                'Tarih': '',
                'Miktar': filteredData.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0),
                'USD Tutar': filteredData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0)
            };
            excelData.push(summary);
            
            // Workbook oluştur
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // Sütun genişliklerini ayarla
            ws['!cols'] = [
                {wch: 30}, // İş Ortağı
                {wch: 40}, // Ürün
                {wch: 15}, // Marka
                {wch: 20}, // Kategori 1
                {wch: 20}, // Kategori 2
                {wch: 20}, // Kategori 3
                {wch: 20}, // Kategori 4
                {wch: 20}, // Satış Temsilcisi
                {wch: 30}, // Mağaza
                {wch: 15}, // Şehir
                {wch: 12}, // Tarih
                {wch: 12}, // Miktar
                {wch: 15}  // USD Tutar
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Satış Verileri');
            
            // Dosya adı oluştur
            const today = new Date().toISOString().split('T')[0];
            const filename = `Satis_Analizi_${today}.xlsx`;
            
            // İndir
            XLSX.writeFile(wb, filename);
            
            console.log(`✅ Excel dosyası indirildi: ${filename}`);
            alert(`✅ ${filteredData.length} kayıt Excel'e aktarıldı!\nDosya: ${filename}`);
        }
        
        // ==================== VOICE SEARCH ====================
        let recognition = null;
        let isListening = false;
        
        function startVoiceSearch() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('⚠️ Tarayıcınız ses tanıma özelliğini desteklemiyor!\nChrome veya Edge kullanın.');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (isListening) {
                // Dinlemeyi durdur
                if (recognition) {
                    recognition.stop();
                }
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.lang = 'tr-TR';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            const voiceBtn = document.getElementById('voiceBtn');
            
            recognition.onstart = () => {
                isListening = true;
                voiceBtn.classList.add('listening');
                voiceBtn.textContent = '🎙️';
                console.log('🎤 Dinleniyor...');
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                console.log('🗣️ Algılanan:', transcript);
                document.getElementById('smartSearch').value = transcript;
                applySmartSearch();
            };
            
            recognition.onerror = (event) => {
                console.error('❌ Ses tanıma hatası:', event.error);
                if (event.error === 'no-speech') {
                    alert('⚠️ Ses algılanamadı. Lütfen tekrar deneyin.');
                } else if (event.error === 'not-allowed') {
                    alert('⚠️ Mikrofon izni verilmedi. Lütfen tarayıcı ayarlarından mikrofon izni verin.');
                }
            };
            
            recognition.onend = () => {
                isListening = false;
                voiceBtn.classList.remove('listening');
                voiceBtn.textContent = '🎤';
                console.log('🎤 Dinleme bitti');
            };
            
            recognition.start();
        }
        
        // ==================== TARGET TRACKING ====================
        let targetChart = null;
        
        // ==================== HEDEF YÖNETİMİ ====================
        
        // Yıllık hedefleri kaydet
        function saveYearlyTarget() {
            const year = document.getElementById('targetYear').value;
            const store = document.getElementById('targetYearStore').value;
            const target = parseFloat(document.getElementById('yearlyTarget').value) || 0;
            
            if (target <= 0) {
                alert('⚠️ Lütfen geçerli bir hedef girin!');
                return;
            }
            
            // Mevcut hedefleri al
            let yearlyTargets = JSON.parse(localStorage.getItem('yearlyTargets') || '{}');
            
            // Yıl yoksa oluştur
            if (!yearlyTargets[year]) {
                yearlyTargets[year] = {};
            }
            
            // Mağaza bazında hedefi kaydet
            yearlyTargets[year][store] = target;
            localStorage.setItem('yearlyTargets', JSON.stringify(yearlyTargets));
            
            // Hesapla
            calculateTargets();
            
            // Bildirim
            const storeText = store === 'TÜM MAĞAZALAR' ? 'Tüm Mağazalar' : store;
            alert(`✅ ${year} yılı ${storeText} hedefi kaydedildi: $${target.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`);
        }
        
        // Yıllık hedefi yükle
        function loadYearlyTarget() {
            const year = document.getElementById('targetYear').value;
            const store = document.getElementById('targetYearStore').value;
            const yearlyTargets = JSON.parse(localStorage.getItem('yearlyTargets') || '{}');
            
            if (yearlyTargets[year] && yearlyTargets[year][store]) {
                document.getElementById('yearlyTarget').value = yearlyTargets[year][store];
            } else {
                document.getElementById('yearlyTarget').value = '';
            }
            
            calculateTargets();
        }
        
        // Aylık hedefleri kaydet
        function saveMonthlyTarget() {
            const year = document.getElementById('targetYear').value;
            const month = document.getElementById('targetMonth').value;
            const store = document.getElementById('targetMonthStore').value;
            const target = parseFloat(document.getElementById('monthlyTarget').value) || 0;
            
            if (target <= 0) {
                alert('⚠️ Lütfen geçerli bir hedef girin!');
                return;
            }
            
            // Mevcut hedefleri al
            let monthlyTargets = JSON.parse(localStorage.getItem('monthlyTargets') || '{}');
            
            // Yıl yoksa oluştur
            if (!monthlyTargets[year]) {
                monthlyTargets[year] = {};
            }
            
            // Mağaza yoksa oluştur
            if (!monthlyTargets[year][store]) {
                monthlyTargets[year][store] = {};
            }
            
            // Mağaza ve ay bazında hedefi kaydet
            monthlyTargets[year][store][month] = target;
            localStorage.setItem('monthlyTargets', JSON.stringify(monthlyTargets));
            
            // Hesapla
            calculateTargets();
            
            // Ay adını bul
            const monthNames = {
                '01': 'Ocak', '02': 'Şubat', '03': 'Mart', '04': 'Nisan',
                '05': 'Mayıs', '06': 'Haziran', '07': 'Temmuz', '08': 'Ağustos',
                '09': 'Eylül', '10': 'Ekim', '11': 'Kasım', '12': 'Aralık'
            };
            
            // Bildirim
            const storeText = store === 'TÜM MAĞAZALAR' ? 'Tüm Mağazalar' : store;
            alert(`✅ ${year} ${monthNames[month]} ${storeText} hedefi kaydedildi: $${target.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`);
        }
        
        // Aylık hedefi yükle
        function loadMonthlyTarget() {
            const year = document.getElementById('targetYear').value;
            const month = document.getElementById('targetMonth').value;
            const store = document.getElementById('targetMonthStore').value;
            const monthlyTargets = JSON.parse(localStorage.getItem('monthlyTargets') || '{}');
            
            if (monthlyTargets[year] && monthlyTargets[year][store] && monthlyTargets[year][store][month]) {
                document.getElementById('monthlyTarget').value = monthlyTargets[year][store][month];
            } else {
                document.getElementById('monthlyTarget').value = '';
            }
            
            calculateTargets();
        }
        
        // Sayfa yüklendiğinde hedefleri yükle
        window.addEventListener('load', () => {
            loadYearlyTarget();
            loadMonthlyTarget();
        });
        
        function calculateTargets() {
            // Mağazaları doldur (ilk kez çağrıldığında)
            populateTargetStoreDropdowns();
            
            const yearlyTarget = parseFloat(document.getElementById('yearlyTarget').value) || 0;
            const monthlyTarget = parseFloat(document.getElementById('monthlyTarget').value) || 0;
            const targetYear = document.getElementById('targetYear').value;
            const targetMonth = document.getElementById('targetMonth').value;
            const yearStore = document.getElementById('targetYearStore').value;
            const monthStore = document.getElementById('targetMonthStore').value;
            
            // Yıllık hesaplama
            if (yearlyTarget > 0) {
                const yearlyData = allData.filter(item => {
                    if (!item.date) return false;
                    const dateMatch = item.date.startsWith(targetYear);
                    const storeMatch = yearStore === 'TÜM MAĞAZALAR' || item.store === yearStore;
                    return dateMatch && storeMatch;
                });
                
                const yearlyAchieved = yearlyData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
                const yearlyRemaining = Math.max(0, yearlyTarget - yearlyAchieved);
                const yearlyPercent = Math.min(100, (yearlyAchieved / yearlyTarget) * 100);
                
                // Kalan günleri hesapla
                const today = new Date();
                const endOfYear = new Date(targetYear, 11, 31);
                const daysLeft = Math.max(0, Math.ceil((endOfYear - today) / (1000 * 60 * 60 * 24)));
                const dailyRequired = daysLeft > 0 ? yearlyRemaining / daysLeft : 0;
                
                document.getElementById('yearlyProgress').style.width = yearlyPercent + '%';
                document.getElementById('yearlyProgress').textContent = yearlyPercent.toFixed(1) + '%';
                document.getElementById('yearlyAchieved').textContent = '$' + yearlyAchieved.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                document.getElementById('yearlyRemaining').textContent = '$' + yearlyRemaining.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                document.getElementById('yearlyDaysLeft').textContent = daysLeft;
                document.getElementById('yearlyDailyRequired').textContent = '$' + dailyRequired.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            }
            
            // Aylık hesaplama
            if (monthlyTarget > 0) {
                const monthlyData = allData.filter(item => {
                    if (!item.date) return false;
                    const itemDate = item.date.split('-');
                    const dateMatch = itemDate[0] === targetYear && itemDate[1] === targetMonth;
                    const storeMatch = monthStore === 'TÜM MAĞAZALAR' || item.store === monthStore;
                    return dateMatch && storeMatch;
                });
                
                const monthlyAchieved = monthlyData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
                const monthlyRemaining = Math.max(0, monthlyTarget - monthlyAchieved);
                const monthlyPercent = Math.min(100, (monthlyAchieved / monthlyTarget) * 100);
                
                // Kalan günleri hesapla
                const today = new Date();
                const endOfMonth = new Date(targetYear, parseInt(targetMonth), 0);
                const daysLeft = Math.max(0, Math.ceil((endOfMonth - today) / (1000 * 60 * 60 * 24)));
                const dailyRequired = daysLeft > 0 ? monthlyRemaining / daysLeft : 0;
                
                document.getElementById('monthlyProgress').style.width = monthlyPercent + '%';
                document.getElementById('monthlyProgress').textContent = monthlyPercent.toFixed(1) + '%';
                document.getElementById('monthlyAchieved').textContent = '$' + monthlyAchieved.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                document.getElementById('monthlyRemaining').textContent = '$' + monthlyRemaining.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                document.getElementById('monthlyDaysLeft').textContent = daysLeft;
                document.getElementById('monthlyDailyRequired').textContent = '$' + dailyRequired.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            }
            
            // Grafik çiz
            renderTargetChart();
        }
        
        function renderTargetChart() {
            const ctx = document.getElementById('targetChart');
            if (!ctx) return;
            
            // Aylık satış verileri
            const months = ['Ocak', 'Şubat', 'Mart', 'Nisan', 'Mayıs', 'Haziran', 
                           'Temmuz', 'Ağustos', 'Eylül', 'Ekim', 'Kasım', 'Aralık'];
            const targetYear = document.getElementById('targetYear').value;
            
            const monthlySales = months.map((month, index) => {
                const monthNum = String(index + 1).padStart(2, '0');
                const monthData = allData.filter(item => {
                    if (!item.date) return false;
                    const itemDate = item.date.split('-');
                    return itemDate[0] === targetYear && itemDate[1] === monthNum;
                });
                return monthData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            });
            
            if (targetChart) {
                targetChart.destroy();
            }
            
            targetChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Aylık Satış (USD)',
                        data: monthlySales,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: `${targetYear} Yılı Aylık Satış Performansı`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ==================== CUSTOMER ANALYSIS ====================
        let customerCityChart = null;
        let customerTrendChart = null;
        
        function analyzeCustomers() {
            // Müşteri verilerini analiz et
            const customerData = {};
            const today = new Date();
            const ninetyDaysAgo = new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000));
            
            allData.forEach(item => {
                const partner = item.partner;
                if (!partner) return;
                
                if (!customerData[partner]) {
                    customerData[partner] = {
                        name: partner,
                        totalSales: 0,
                        orderCount: 0,
                        city: item.city || 'Bilinmiyor',
                        lastOrderDate: item.date || ''
                    };
                }
                
                customerData[partner].totalSales += parseFloat(item.usd_amount || 0);
                customerData[partner].orderCount += 1;
                
                if (item.date && item.date > customerData[partner].lastOrderDate) {
                    customerData[partner].lastOrderDate = item.date;
                }
            });
            
            // Array'e çevir ve sırala
            const customers = Object.values(customerData).sort((a, b) => b.totalSales - a.totalSales);
            
            // İstatistikler
            const totalCustomers = customers.length;
            const activeCustomers = customers.filter(c => {
                if (!c.lastOrderDate) return false;
                const lastOrder = new Date(c.lastOrderDate);
                return lastOrder >= ninetyDaysAgo;
            }).length;
            
            const avgOrderValue = customers.reduce((sum, c) => sum + c.totalSales, 0) / totalCustomers;
            const maxOrderValue = customers.length > 0 ? customers[0].totalSales : 0;
            
            document.getElementById('totalCustomers').textContent = totalCustomers.toLocaleString('tr-TR');
            document.getElementById('activeCustomers').textContent = activeCustomers.toLocaleString('tr-TR');
            document.getElementById('avgOrderValue').textContent = '$' + avgOrderValue.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('maxOrderValue').textContent = '$' + maxOrderValue.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            
            // Top 10 müşteri kartları
            renderTopCustomers(customers.slice(0, 10));
            
            // Grafikler
            renderCustomerCityChart(customers);
            renderCustomerTrendChart();
        }
        
        function renderTopCustomers(topCustomers) {
            const grid = document.getElementById('topCustomersGrid');
            grid.innerHTML = '';
            
            topCustomers.forEach((customer, index) => {
                const card = document.createElement('div');
                card.className = 'customer-card';
                card.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <span class="customer-rank">${index + 1}</span>
                        <div style="flex: 1;">
                            <h4 style="margin: 0; font-size: 1.1em;">${customer.name}</h4>
                            <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 0.9em;">📍 ${customer.city}</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                            <p style="margin: 0; font-size: 0.85em; color: #6c757d;">Toplam Satış</p>
                            <p style="margin: 5px 0 0 0; font-size: 1.2em; font-weight: 700; color: #667eea;">$${customer.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                            <p style="margin: 0; font-size: 0.85em; color: #6c757d;">Sipariş Sayısı</p>
                            <p style="margin: 5px 0 0 0; font-size: 1.2em; font-weight: 700; color: #764ba2;">${customer.orderCount}</p>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        function renderCustomerCityChart(customers) {
            const ctx = document.getElementById('customerCityChart');
            if (!ctx) return;
            
            // Şehir bazında müşteri sayısı
            const cityData = {};
            customers.forEach(c => {
                const city = c.city || 'Bilinmiyor';
                cityData[city] = (cityData[city] || 0) + 1;
            });
            
            const sortedCities = Object.entries(cityData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (customerCityChart) {
                customerCityChart.destroy();
            }
            
            customerCityChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedCities.map(c => c[0]),
                    datasets: [{
                        data: sortedCities.map(c => c[1]),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)',
                            'rgba(199, 199, 199, 0.8)',
                            'rgba(83, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        }
                    }
                }
            });
        }
        
        function renderCustomerTrendChart() {
            const ctx = document.getElementById('customerTrendChart');
            if (!ctx) return;
            
            // Son 12 ay için müşteri sayısı
            const monthlyCustomers = {};
            const today = new Date();
            
            for (let i = 11; i >= 0; i--) {
                const date = new Date(today.getFullYear(), today.getMonth() - i, 1);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyCustomers[key] = new Set();
            }
            
            allData.forEach(item => {
                if (!item.date || !item.partner) return;
                const monthKey = item.date.substring(0, 7);
                if (monthlyCustomers[monthKey] !== undefined) {
                    monthlyCustomers[monthKey].add(item.partner);
                }
            });
            
            const labels = Object.keys(monthlyCustomers);
            const data = Object.values(monthlyCustomers).map(set => set.size);
            
            if (customerTrendChart) {
                customerTrendChart.destroy();
            }
            
            customerTrendChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Aktif Müşteri Sayısı',
                        data: data,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // ==================== AI ANALYSIS & INSIGHTS ====================
        function performAIAnalysis() {
            console.log('🤖 AI Analiz başlatılıyor...');
            
            const panel = document.getElementById('aiAnalysisPanel');
            if (!panel || filteredData.length === 0) return;
            
            // Veri analizi
            const analysis = analyzeData(filteredData);
            
            // Öngörüler ve öneriler
            const insights = generateInsights(analysis);
            
            // HTML oluştur
            let html = `
                <div class="analysis-panel">
                    <h2 style="margin: 0 0 20px 0; font-size: 2em;">🤖 AI Analiz & Öneriler</h2>
                    <p style="opacity: 0.9; margin-bottom: 20px;">Filtrelenen ${filteredData.length.toLocaleString('tr-TR')} kayıt üzerinden yapılan akıllı analiz sonuçları</p>
                    
                    ${insights.positive.length > 0 ? `
                    <div class="analysis-section">
                        <h3>✅ Olumlu Tespitler</h3>
                        ${insights.positive.map(item => `
                            <div class="insight-item insight-positive">
                                <span class="insight-icon">✅</span>
                                <strong>${item.title}</strong><br>
                                ${item.description}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.negative.length > 0 ? `
                    <div class="analysis-section">
                        <h3>⚠️ Dikkat Edilmesi Gerekenler</h3>
                        ${insights.negative.map(item => `
                            <div class="insight-item insight-negative">
                                <span class="insight-icon">⚠️</span>
                                <strong>${item.title}</strong><br>
                                ${item.description}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.neutral.length > 0 ? `
                    <div class="analysis-section">
                        <h3>💡 Önemli Bilgiler</h3>
                        ${insights.neutral.map(item => `
                            <div class="insight-item insight-neutral">
                                <span class="insight-icon">💡</span>
                                <strong>${item.title}</strong><br>
                                ${item.description}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="analysis-section">
                        <h3>🎯 Aksiyon Önerileri</h3>
                        ${insights.recommendations.map(item => `
                            <div class="recommendation">
                                <span class="recommendation-icon">${item.icon}</span>
                                <div>
                                    <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                    <p style="margin: 10px 0 0 0; opacity: 0.95;">${item.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            panel.innerHTML = html;
            panel.style.display = 'block';
        }
        
        function analyzeData(data) {
            // Temel metrikler
            const totalUSD = data.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = data.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const avgOrderValue = totalUSD / data.length;
            
            // Mağaza analizi
            const storeData = {};
            data.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) {
                    storeData[store] = {sales: 0, count: 0, qty: 0};
                }
                storeData[store].sales += parseFloat(item.usd_amount || 0);
                storeData[store].count += 1;
                storeData[store].qty += parseFloat(item.quantity || 0);
            });
            
            // Marka analizi
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) {
                    brandData[brand] = {sales: 0, count: 0};
                }
                brandData[brand].sales += parseFloat(item.usd_amount || 0);
                brandData[brand].count += 1;
            });
            
            // Kategori analizi
            const categoryData = {};
            data.forEach(item => {
                const cat = item.category_1 || 'Bilinmiyor';
                if (!categoryData[cat]) {
                    categoryData[cat] = {sales: 0, count: 0};
                }
                categoryData[cat].sales += parseFloat(item.usd_amount || 0);
                categoryData[cat].count += 1;
            });
            
            // Müşteri analizi
            const customerData = {};
            data.forEach(item => {
                const customer = item.partner || 'Bilinmiyor';
                if (!customerData[customer]) {
                    customerData[customer] = {sales: 0, count: 0};
                }
                customerData[customer].sales += parseFloat(item.usd_amount || 0);
                customerData[customer].count += 1;
            });
            
            // Satış temsilcisi analizi
            const salesPersonData = {};
            data.forEach(item => {
                const person = item.sales_person || 'Bilinmiyor';
                if (!salesPersonData[person]) {
                    salesPersonData[person] = {sales: 0, count: 0};
                }
                salesPersonData[person].sales += parseFloat(item.usd_amount || 0);
                salesPersonData[person].count += 1;
            });
            
            // Tarih analizi
            const dateData = {};
            data.forEach(item => {
                if (!item.date) return;
                const month = item.date.substring(0, 7);
                if (!dateData[month]) {
                    dateData[month] = {sales: 0, count: 0};
                }
                dateData[month].sales += parseFloat(item.usd_amount || 0);
                dateData[month].count += 1;
            });
            
            // Sıralama
            const topStores = Object.entries(storeData).sort((a, b) => b[1].sales - a[1].sales);
            const topBrands = Object.entries(brandData).sort((a, b) => b[1].sales - a[1].sales);
            const topCategories = Object.entries(categoryData).sort((a, b) => b[1].sales - a[1].sales);
            const topCustomers = Object.entries(customerData).sort((a, b) => b[1].sales - a[1].sales);
            const topSalesPersons = Object.entries(salesPersonData).sort((a, b) => b[1].sales - a[1].sales);
            
            return {
                totalUSD,
                totalQty,
                avgOrderValue,
                recordCount: data.length,
                storeData,
                brandData,
                categoryData,
                customerData,
                salesPersonData,
                dateData,
                topStores,
                topBrands,
                topCategories,
                topCustomers,
                topSalesPersons
            };
        }
        
        function generateInsights(analysis) {
            const insights = {
                positive: [],
                negative: [],
                neutral: [],
                recommendations: []
            };
            
            // Olumlu tespitler
            if (analysis.topStores.length > 0) {
                const topStore = analysis.topStores[0];
                const storePercent = (topStore[1].sales / analysis.totalUSD * 100).toFixed(1);
                if (storePercent > 30) {
                    insights.positive.push({
                        title: `En Başarılı Mağaza: ${topStore[0]}`,
                        description: `<span class="metric-highlight">$${topStore[1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span> satış ile toplam satışların <span class="metric-highlight">%${storePercent}</span>'ini gerçekleştirmiş. Mükemmel performans! 🎉`
                    });
                }
            }
            
            if (analysis.topBrands.length > 0) {
                const topBrand = analysis.topBrands[0];
                insights.positive.push({
                    title: `En Çok Satan Marka: ${topBrand[0]}`,
                    description: `<span class="metric-highlight">${topBrand[1].count}</span> adet satış ile lider marka. Stok yönetimine dikkat edin.`
                });
            }
            
            if (analysis.avgOrderValue > 100) {
                insights.positive.push({
                    title: 'Yüksek Ortalama Sipariş Değeri',
                    description: `Ortalama sipariş değeri <span class="metric-highlight">$${analysis.avgOrderValue.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span>. Müşteriler yüksek değerli ürünleri tercih ediyor.`
                });
            }
            
            // Dikkat edilmesi gerekenler
            if (analysis.topStores.length > 1) {
                const topStore = analysis.topStores[0];
                const secondStore = analysis.topStores[1];
                const gap = ((topStore[1].sales - secondStore[1].sales) / topStore[1].sales * 100).toFixed(1);
                if (gap > 50) {
                    insights.negative.push({
                        title: 'Mağazalar Arası Dengesizlik',
                        description: `${topStore[0]} ile ${secondStore[0]} arasında <span class="metric-highlight">%${gap}</span> fark var. Düşük performanslı mağazalara destek gerekebilir.`
                    });
                }
            }
            
            if (analysis.topCustomers.length > 0) {
                const topCustomer = analysis.topCustomers[0];
                const customerPercent = (topCustomer[1].sales / analysis.totalUSD * 100).toFixed(1);
                if (customerPercent > 20) {
                    insights.negative.push({
                        title: 'Tek Müşteriye Bağımlılık Riski',
                        description: `${topCustomer[0]} toplam satışların <span class="metric-highlight">%${customerPercent}</span>'ini oluşturuyor. Müşteri portföyünü çeşitlendirmeyi düşünün.`
                    });
                }
            }
            
            if (analysis.recordCount < 10) {
                insights.negative.push({
                    title: 'Düşük Veri Hacmi',
                    description: `Sadece <span class="metric-highlight">${analysis.recordCount}</span> kayıt analiz edildi. Daha geniş tarih aralığı seçerek daha sağlıklı analiz yapabilirsiniz.`
                });
            }
            
            // Önemli bilgiler
            if (analysis.topCategories.length > 0) {
                const topCat = analysis.topCategories[0];
                insights.neutral.push({
                    title: `En Popüler Kategori: ${topCat[0]}`,
                    description: `<span class="metric-highlight">${topCat[1].count}</span> adet satış ile en çok tercih edilen kategori.`
                });
            }
            
            if (analysis.topSalesPersons.length > 0) {
                const topPerson = analysis.topSalesPersons[0];
                insights.neutral.push({
                    title: `En Başarılı Satış Temsilcisi: ${topPerson[0]}`,
                    description: `<span class="metric-highlight">$${topPerson[1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span> satış gerçekleştirmiş.`
                });
            }
            
            const uniqueCustomers = Object.keys(analysis.customerData).length;
            insights.neutral.push({
                title: 'Müşteri Çeşitliliği',
                description: `<span class="metric-highlight">${uniqueCustomers}</span> farklı müşteri ile işlem yapılmış.`
            });
            
            // Öneriler
            insights.recommendations.push({
                icon: '🎯',
                title: 'Hedef Belirleme',
                description: `Mevcut performans: <span class="metric-highlight">$${analysis.totalUSD.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span>. "Hedef Takip" sekmesinden aylık/yıllık hedeflerinizi belirleyin ve ilerlemenizi takip edin.`
            });
            
            if (analysis.topStores.length > 1) {
                const weakStores = analysis.topStores.slice(-2);
                insights.recommendations.push({
                    icon: '📈',
                    title: 'Düşük Performanslı Mağazalara Odaklanın',
                    description: `${weakStores.map(s => s[0]).join(' ve ')} mağazalarının performansını artırmak için özel kampanyalar düzenleyin.`
                });
            }
            
            if (analysis.topBrands.length > 3) {
                const topBrands = analysis.topBrands.slice(0, 3);
                insights.recommendations.push({
                    icon: '🏷️',
                    title: 'Stok Optimizasyonu',
                    description: `En çok satan markalar (${topBrands.map(b => b[0]).join(', ')}) için stok seviyelerini artırın.`
                });
            }
            
            insights.recommendations.push({
                icon: '👥',
                title: 'Müşteri İlişkileri',
                description: `"Müşteri Analizi" sekmesinden top müşterilerinizi inceleyin ve özel teklifler sunarak sadakati artırın.`
            });
            
            if (analysis.avgOrderValue < 50) {
                insights.recommendations.push({
                    icon: '💰',
                    title: 'Ortalama Sipariş Değerini Artırın',
                    description: `Mevcut ortalama: <span class="metric-highlight">$${analysis.avgOrderValue.toFixed(2)}</span>. Cross-selling ve up-selling stratejileri uygulayın.`
                });
            }
            
            insights.recommendations.push({
                icon: '📊',
                title: 'Düzenli Raporlama',
                description: `"Excel'e Aktar" özelliğini kullanarak haftalık/aylık raporlar oluşturun ve trendleri takip edin.`
            });
            
            return insights;
        }

        // ==================== TAB SWITCHING ====================
        function switchTab(tabName) {
            // Tüm tab'ları gizle
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Tüm tab butonlarını pasif yap
            document.querySelectorAll('.tab').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Seçili tab'ı göster
            const selectedTab = document.getElementById(tabName + 'Tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Seçili butonu aktif yap
            event.target.classList.add('active');
            
            // Tab'a göre özel işlemler
            if (tabName === 'targets') {
                calculateTargets();
            } else if (tabName === 'customers') {
                analyzeCustomers();
            } else if (tabName === 'salesperson') {
                // Satış temsilcisi sekmesi
                console.log('👨‍💼 Satış Temsilcisi sekmesi açıldı');
            } else if (tabName === 'city') {
                // Şehir analizi sekmesi - şehir dropdown'unu doldur
                populateCitySelect();
            } else if (tabName === 'stock') {
                // Stok dağılım sekmesi - hazırlık
                console.log('📦 Stok Dağılım sekmesi açıldı');
            } else if (tabName === 'time') {
                analyzeTime();
            }
        }

        // ==================== TIME ANALYSIS ====================
        let hourlyChartInstance = null;
        let dailyChartInstance = null;
        let storeTimeChartInstance = null;
        let categoryTimeChartInstance = null;
        let salesPersonTimeChartInstance = null;
        
        function analyzeTime() {
            console.log('⏰ Zaman analizi başlatılıyor...');
            
            // Summary cards güncelle
            updateTimeSummary();
            
            // Grafikleri render et
            renderHourlyChart();
            renderDailyChart();
            renderHeatmap();
            
            // Filtreleri doldur
            populateTimeFilters();
            
            // İlk grafikleri render et
            renderStoreTimeChart();
            renderCategoryTimeChart();
            renderSalesPersonTimeChart();
            
            // AI analiz
            performTimeAIAnalysis();
        }
        
        function updateTimeSummary() {
            // Saatlik veri topla
            const hourData = {};
            const dayData = {};
            let workHoursSales = 0;
            let weekendSales = 0;
            
            filteredData.forEach(item => {
                const hour = item.create_hour || 0;
                const day = item.day_of_week || 0;
                const sales = parseFloat(item.usd_amount || 0);
                
                // Saatlik
                if (!hourData[hour]) hourData[hour] = 0;
                hourData[hour] += sales;
                
                // Günlük
                if (!dayData[day]) dayData[day] = 0;
                dayData[day] += sales;
                
                // Mesai saati (09:00-18:00)
                if (hour >= 9 && hour < 18) {
                    workHoursSales += sales;
                }
                
                // Hafta sonu (Cumartesi=5, Pazar=6)
                if (day === 5 || day === 6) {
                    weekendSales += sales;
                }
            });
            
            // En yoğun saat
            let peakHour = 0;
            let maxHourSales = 0;
            for (const [hour, sales] of Object.entries(hourData)) {
                if (sales > maxHourSales) {
                    maxHourSales = sales;
                    peakHour = parseInt(hour);
                }
            }
            
            // En yoğun gün
            const dayNames = ['Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi', 'Pazar'];
            let peakDay = 0;
            let maxDaySales = 0;
            for (const [day, sales] of Object.entries(dayData)) {
                if (sales > maxDaySales) {
                    maxDaySales = sales;
                    peakDay = parseInt(day);
                }
            }
            
            // UI güncelle
            document.getElementById('peakHour').textContent = `${String(peakHour).padStart(2, '0')}:00-${String(peakHour + 1).padStart(2, '0')}:00`;
            document.getElementById('peakDay').textContent = dayNames[peakDay];
            document.getElementById('workHoursSales').textContent = '$' + workHoursSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('weekendSales').textContent = '$' + weekendSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
        }
        
        function renderHourlyChart() {
            const ctx = document.getElementById('hourlyChart');
            if (!ctx) return;
            
            // 24 saatlik veri
            const hourData = Array(24).fill(0);
            const hourCount = Array(24).fill(0);
            
            filteredData.forEach(item => {
                const hour = item.create_hour || 0;
                hourData[hour] += parseFloat(item.usd_amount || 0);
                hourCount[hour] += 1;
            });
            
            if (hourlyChartInstance) {
                hourlyChartInstance.destroy();
            }
            
            hourlyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`),
                    datasets: [{
                        label: 'Satış ($)',
                        data: hourData,
                        backgroundColor: hourData.map((val, idx) => {
                            const max = Math.max(...hourData);
                            if (val === max) return 'rgba(245, 87, 108, 0.8)'; // En yoğun
                            if (idx >= 9 && idx < 18) return 'rgba(56, 239, 125, 0.6)'; // Mesai saati
                            return 'rgba(102, 126, 234, 0.6)'; // Normal
                        }),
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Satış: $${context.parsed.y.toLocaleString('tr-TR')} (${hourCount[context.dataIndex]} adet)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderDailyChart() {
            const ctx = document.getElementById('dailyChart');
            if (!ctx) return;
            
            const dayNames = ['Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi', 'Pazar'];
            const dayData = Array(7).fill(0);
            const dayCount = Array(7).fill(0);
            
            filteredData.forEach(item => {
                const day = item.day_of_week || 0;
                dayData[day] += parseFloat(item.usd_amount || 0);
                dayCount[day] += 1;
            });
            
            if (dailyChartInstance) {
                dailyChartInstance.destroy();
            }
            
            dailyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: dayNames,
                    datasets: [{
                        label: 'Satış ($)',
                        data: dayData,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointRadius: 6,
                        pointHoverRadius: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Satış: $${context.parsed.y.toLocaleString('tr-TR')} (${dayCount[context.dataIndex]} adet)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderHeatmap() {
            const container = document.getElementById('heatmapContainer');
            if (!container) return;
            
            const dayNames = ['Paz', 'Sal', 'Çar', 'Per', 'Cum', 'Cmt', 'Paz'];
            const heatmapData = {};
            
            // Veriyi topla
            for (let day = 0; day < 7; day++) {
                heatmapData[day] = {};
                for (let hour = 0; hour < 24; hour++) {
                    heatmapData[day][hour] = 0;
                }
            }
            
            filteredData.forEach(item => {
                const day = item.day_of_week || 0;
                const hour = item.create_hour || 0;
                heatmapData[day][hour] += parseFloat(item.usd_amount || 0);
            });
            
            // Maksimum değeri bul (renk skalası için)
            let maxValue = 0;
            for (let day = 0; day < 7; day++) {
                for (let hour = 0; hour < 24; hour++) {
                    if (heatmapData[day][hour] > maxValue) {
                        maxValue = heatmapData[day][hour];
                    }
                }
            }
            
            // HTML oluştur
            let html = '<table style="border-collapse: collapse; margin: 0 auto;">';
            html += '<tr><th style="padding: 8px; border: 1px solid #ddd;">Gün/Saat</th>';
            for (let hour = 0; hour < 24; hour++) {
                html += `<th style="padding: 8px; border: 1px solid #ddd; font-size: 0.8em;">${String(hour).padStart(2, '0')}</th>`;
            }
            html += '</tr>';
            
            for (let day = 0; day < 7; day++) {
                html += `<tr><td style="padding: 8px; border: 1px solid #ddd; font-weight: 600;">${dayNames[day]}</td>`;
                for (let hour = 0; hour < 24; hour++) {
                    const value = heatmapData[day][hour];
                    const intensity = maxValue > 0 ? (value / maxValue) : 0;
                    const color = `rgba(102, 126, 234, ${intensity})`;
                    const textColor = intensity > 0.5 ? '#fff' : '#333';
                    html += `<td style="padding: 8px; border: 1px solid #ddd; background: ${color}; color: ${textColor}; text-align: center; font-size: 0.8em;" title="$${value.toLocaleString('tr-TR')}">
                        ${value > 0 ? '$' + (value / 1000).toFixed(1) + 'K' : '-'}
                    </td>`;
                }
                html += '</tr>';
            }
            html += '</table>';
            
            container.innerHTML = html;
        }
        
        function populateTimeFilters() {
            // Mağaza filtresi
            const stores = [...new Set(filteredData.map(item => item.store).filter(Boolean))];
            const storeSelect = document.getElementById('storeTimeFilter');
            storeSelect.innerHTML = '<option value="">Tüm Mağazalar</option>';
            stores.forEach(store => {
                storeSelect.innerHTML += `<option value="${store}">${store}</option>`;
            });
            
            // Kategori filtresi
            const categories = [...new Set(filteredData.map(item => item.category_1).filter(Boolean))];
            const categorySelect = document.getElementById('categoryTimeFilter');
            categorySelect.innerHTML = '<option value="">Tüm Kategoriler</option>';
            categories.forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            
            // Satış temsilcisi filtresi
            const salesPersons = [...new Set(filteredData.map(item => item.sales_person).filter(Boolean))];
            const salesPersonSelect = document.getElementById('salesPersonTimeFilter');
            salesPersonSelect.innerHTML = '<option value="">Tüm Temsilciler</option>';
            salesPersons.forEach(person => {
                salesPersonSelect.innerHTML += `<option value="${person}">${person}</option>`;
            });
        }
        
        function renderStoreTimeChart() {
            const ctx = document.getElementById('storeTimeChart');
            if (!ctx) return;
            
            const selectedStore = document.getElementById('storeTimeFilter').value;
            const data = selectedStore ? 
                filteredData.filter(item => item.store === selectedStore) : 
                filteredData;
            
            const hourData = Array(24).fill(0);
            data.forEach(item => {
                const hour = item.create_hour || 0;
                hourData[hour] += parseFloat(item.usd_amount || 0);
            });
            
            if (storeTimeChartInstance) {
                storeTimeChartInstance.destroy();
            }
            
            storeTimeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`),
                    datasets: [{
                        label: selectedStore || 'Tüm Mağazalar',
                        data: hourData,
                        backgroundColor: 'rgba(56, 239, 125, 0.6)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCategoryTimeChart() {
            const ctx = document.getElementById('categoryTimeChart');
            if (!ctx) return;
            
            const selectedCategory = document.getElementById('categoryTimeFilter').value;
            const data = selectedCategory ? 
                filteredData.filter(item => item.category_1 === selectedCategory) : 
                filteredData;
            
            const hourData = Array(24).fill(0);
            data.forEach(item => {
                const hour = item.create_hour || 0;
                hourData[hour] += parseFloat(item.usd_amount || 0);
            });
            
            if (categoryTimeChartInstance) {
                categoryTimeChartInstance.destroy();
            }
            
            categoryTimeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`),
                    datasets: [{
                        label: selectedCategory || 'Tüm Kategoriler',
                        data: hourData,
                        backgroundColor: 'rgba(245, 87, 108, 0.6)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderSalesPersonTimeChart() {
            const ctx = document.getElementById('salesPersonTimeChart');
            if (!ctx) return;
            
            const selectedPerson = document.getElementById('salesPersonTimeFilter').value;
            const data = selectedPerson ? 
                filteredData.filter(item => item.sales_person === selectedPerson) : 
                filteredData;
            
            const hourData = Array(24).fill(0);
            data.forEach(item => {
                const hour = item.create_hour || 0;
                hourData[hour] += parseFloat(item.usd_amount || 0);
            });
            
            if (salesPersonTimeChartInstance) {
                salesPersonTimeChartInstance.destroy();
            }
            
            salesPersonTimeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`),
                    datasets: [{
                        label: selectedPerson || 'Tüm Temsilciler',
                        data: hourData,
                        backgroundColor: 'rgba(240, 147, 251, 0.6)',
                        borderColor: 'rgba(240, 147, 251, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function performTimeAIAnalysis() {
            console.log('🤖 Zaman AI analizi başlatılıyor...');
            
            const panel = document.getElementById('timeInsightsPanel');
            if (!panel || filteredData.length === 0) return;
            
            // Zaman verilerini analiz et
            const hourData = {};
            const dayData = {};
            const storeHourData = {};
            const categoryHourData = {};
            
            filteredData.forEach(item => {
                const hour = item.create_hour || 0;
                const day = item.day_of_week || 0;
                const store = item.store || 'Bilinmiyor';
                const category = item.category_1 || 'Bilinmiyor';
                const sales = parseFloat(item.usd_amount || 0);
                
                if (!hourData[hour]) hourData[hour] = {sales: 0, count: 0};
                hourData[hour].sales += sales;
                hourData[hour].count += 1;
                
                if (!dayData[day]) dayData[day] = {sales: 0, count: 0};
                dayData[day].sales += sales;
                dayData[day].count += 1;
                
                if (!storeHourData[store]) storeHourData[store] = {};
                if (!storeHourData[store][hour]) storeHourData[store][hour] = 0;
                storeHourData[store][hour] += sales;
                
                if (!categoryHourData[category]) categoryHourData[category] = {};
                if (!categoryHourData[category][hour]) categoryHourData[category][hour] = 0;
                categoryHourData[category][hour] += sales;
            });
            
            // İçgörüler üret
            const insights = {
                positive: [],
                negative: [],
                neutral: [],
                recommendations: []
            };
            
            // En yoğun saat
            let peakHour = 0;
            let maxHourSales = 0;
            for (const [hour, data] of Object.entries(hourData)) {
                if (data.sales > maxHourSales) {
                    maxHourSales = data.sales;
                    peakHour = parseInt(hour);
                }
            }
            
            insights.positive.push({
                title: `En Yoğun Saat: ${String(peakHour).padStart(2, '0')}:00-${String(peakHour + 1).padStart(2, '0')}:00`,
                description: `<span class="metric-highlight">$${maxHourSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span> satış ile en yoğun saat dilimi. Bu saatte personel sayısını artırın.`
            });
            
            // Gün analizi
            const dayNames = ['Pazartesi', 'Salı', 'Çarşamba', 'Perşembe', 'Cuma', 'Cumartesi', 'Pazar'];
            let peakDay = 0;
            let maxDaySales = 0;
            let minDay = 0;
            let minDaySales = Infinity;
            
            for (const [day, data] of Object.entries(dayData)) {
                if (data.sales > maxDaySales) {
                    maxDaySales = data.sales;
                    peakDay = parseInt(day);
                }
                if (data.sales < minDaySales) {
                    minDaySales = data.sales;
                    minDay = parseInt(day);
                }
            }
            
            insights.positive.push({
                title: `En Yoğun Gün: ${dayNames[peakDay]}`,
                description: `<span class="metric-highlight">$${maxDaySales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span> satış ile haftanın en yoğun günü.`
            });
            
            if (maxDaySales / minDaySales > 2) {
                insights.negative.push({
                    title: 'Günler Arası Büyük Fark',
                    description: `${dayNames[peakDay]} ile ${dayNames[minDay]} arasında <span class="metric-highlight">${((maxDaySales / minDaySales - 1) * 100).toFixed(0)}%</span> fark var. ${dayNames[minDay]} için özel kampanyalar düşünün.`
                });
            }
            
            // Mesai saati vs mesai dışı
            let workHoursSales = 0;
            let offHoursSales = 0;
            for (const [hour, data] of Object.entries(hourData)) {
                if (parseInt(hour) >= 9 && parseInt(hour) < 18) {
                    workHoursSales += data.sales;
                } else {
                    offHoursSales += data.sales;
                }
            }
            
            const workHoursPercent = (workHoursSales / (workHoursSales + offHoursSales) * 100).toFixed(1);
            insights.neutral.push({
                title: 'Mesai Saati Dağılımı',
                description: `Satışların <span class="metric-highlight">%${workHoursPercent}</span>'i mesai saatlerinde (09:00-18:00) gerçekleşiyor.`
            });
            
            // Öneriler
            insights.recommendations.push({
                icon: '⏰',
                title: 'Personel Planlaması',
                description: `${String(peakHour).padStart(2, '0')}:00-${String(peakHour + 1).padStart(2, '0')}:00 saatleri arasında personel sayısını artırın. Bu saatte satışların %${((maxHourSales / Object.values(hourData).reduce((sum, d) => sum + d.sales, 0)) * 100).toFixed(1)}'i gerçekleşiyor.`
            });
            
            insights.recommendations.push({
                icon: '📅',
                title: 'Kampanya Zamanlaması',
                description: `${dayNames[minDay]} günleri için özel kampanyalar düzenleyin. Mevcut satışlar ${dayNames[peakDay]}'ye göre %${((1 - minDaySales / maxDaySales) * 100).toFixed(0)} daha düşük.`
            });
            
            if (offHoursSales > workHoursSales * 0.3) {
                insights.recommendations.push({
                    icon: '🌙',
                    title: 'Mesai Dışı Potansiyel',
                    description: `Mesai dışı satışlar toplam satışların %${((offHoursSales / (workHoursSales + offHoursSales)) * 100).toFixed(1)}'ini oluşturuyor. Online satış kanallarını güçlendirin.`
                });
            }
            
            // HTML oluştur
            let html = `
                <div class="analysis-panel" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h2 style="margin: 0 0 20px 0; font-size: 2em;">⏰ Zaman Analizi AI Önerileri</h2>
                    <p style="opacity: 0.9; margin-bottom: 20px;">Filtrelenen ${filteredData.length.toLocaleString('tr-TR')} kayıt üzerinden yapılan zaman analizi sonuçları</p>
                    
                    ${insights.positive.length > 0 ? `
                    <div class="analysis-section">
                        <h3>✅ Olumlu Tespitler</h3>
                        ${insights.positive.map(item => `
                            <div class="insight-item insight-positive">
                                <span class="insight-icon">✅</span>
                                <strong>${item.title}</strong><br>
                                ${item.description}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.negative.length > 0 ? `
                    <div class="analysis-section">
                        <h3>⚠️ Dikkat Edilmesi Gerekenler</h3>
                        ${insights.negative.map(item => `
                            <div class="insight-item insight-negative">
                                <span class="insight-icon">⚠️</span>
                                <strong>${item.title}</strong><br>
                                ${item.description}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.neutral.length > 0 ? `
                    <div class="analysis-section">
                        <h3>💡 Önemli Bilgiler</h3>
                        ${insights.neutral.map(item => `
                            <div class="insight-item insight-neutral">
                                <span class="insight-icon">💡</span>
                                <strong>${item.title}</strong><br>
                                ${item.description}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="analysis-section">
                        <h3>🎯 Aksiyon Önerileri</h3>
                        ${insights.recommendations.map(item => `
                            <div class="recommendation">
                                <span class="recommendation-icon">${item.icon}</span>
                                <div>
                                    <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                    <p style="margin: 10px 0 0 0; opacity: 0.95;">${item.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            panel.innerHTML = html;
            panel.style.display = 'block';
        }

        // Load data on page load
        loadData();
        
        // ==================== ÜRÜN ANALİZİ ====================
        
        let productStoreChartInstance = null;
        let productCityChartInstance = null;
        let productSalesPersonChartInstance = null;
        let productMonthlyChartInstance = null;
        
        // Ürün tablosu sıralama için
        let currentProductData = [];
        let currentSortColumn = 'sales';
        let currentSortDirection = 'desc';
        let lastProductSearchData = null;
        
        // Satış Temsilcisi tablosu sıralama için
        let lastSalespersonTopProductsData = null;
        let currentSalespersonSortColumn = 'sales';
        let currentSalespersonSortDirection = 'desc';
        
        // Müşteri alışveriş geçmişi sıralama için
        let lastCustomerPurchaseData = null;
        let currentCustomerPurchaseSortColumn = 'date';
        let currentCustomerPurchaseSortDirection = 'desc';
        
        function searchProduct() {
            const searchTerm = document.getElementById('productSearchInput').value.trim();
            
            if (!searchTerm) {
                alert('⚠️ Lütfen bir ürün veya marka adı girin!');
                return;
            }
            
            console.log('🔍 Ürün/Marka aranıyor:', searchTerm);
            
            // Arama (ürün adı, marka, veya ürün kodu)
            const searchLower = searchTerm.toLowerCase();
            const results = allData.filter(item => {
                const product = (item.product || '').toLowerCase();
                const brand = (item.brand || '').toLowerCase();
                
                return product.includes(searchLower) || brand.includes(searchLower);
            });
            
            console.log('📊 Bulunan kayıt sayısı:', results.length);
            
            if (results.length === 0) {
                // Sonuç yok
                document.getElementById('productResultsContainer').style.display = 'none';
                document.getElementById('productNoResults').style.display = 'block';
                return;
            }
            
            // Sonuçları göster
            document.getElementById('productResultsContainer').style.display = 'block';
            document.getElementById('productNoResults').style.display = 'none';
            
            // Veriyi kaydet (sıralama için)
            lastProductSearchData = results;
            
            // Özet kartları güncelle
            const totalSales = results.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = results.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const uniqueProducts = new Set(results.map(item => item.product)).size;
            const avgPrice = totalSales / Math.max(totalQty, 1);
            
            document.getElementById('productTotalSales').textContent = '$' + totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('productTotalQty').textContent = totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('productUniqueCount').textContent = uniqueProducts;
            document.getElementById('productAvgPrice').textContent = '$' + avgPrice.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            
            // Grafikleri render et
            renderProductStoreChart(results);
            renderProductCityChart(results);
            renderProductSalesPersonChart(results);
            renderProductMonthlyChart(results);
            renderProductDetailTable(results);
            
            // AI Analiz ve Öneri
            performProductAIAnalysis(results);
        }
        
        function renderProductStoreChart(data) {
            const storeData = {};
            data.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) storeData[store] = {sales: 0, qty: 0};
                storeData[store].sales += parseFloat(item.usd_amount || 0);
                storeData[store].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(storeData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('productStoreChart');
            if (!ctx) return;
            
            if (productStoreChartInstance) {
                productStoreChartInstance.destroy();
            }
            
            productStoreChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satış (USD)',
                        data: salesValues,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    if (label === 'Satış (USD)') {
                                        return label + ': $' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                    } else {
                                        return label + ': ' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderProductCityChart(data) {
            const cityData = {};
            data.forEach(item => {
                const city = item.city || 'Bilinmiyor';
                if (!cityData[city]) cityData[city] = {sales: 0, qty: 0};
                cityData[city].sales += parseFloat(item.usd_amount || 0);
                cityData[city].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(cityData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('productCityChart');
            if (!ctx) return;
            
            if (productCityChartInstance) {
                productCityChartInstance.destroy();
            }
            
            productCityChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satış (USD)',
                        data: salesValues,
                        backgroundColor: 'rgba(56, 239, 125, 0.6)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    if (label === 'Satış (USD)') {
                                        return label + ': $' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                    } else {
                                        return label + ': ' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderProductSalesPersonChart(data) {
            const personData = {};
            data.forEach(item => {
                const person = item.sales_person || 'Bilinmiyor';
                if (!personData[person]) personData[person] = {sales: 0, qty: 0};
                personData[person].sales += parseFloat(item.usd_amount || 0);
                personData[person].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(personData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('productSalesPersonChart');
            if (!ctx) return;
            
            if (productSalesPersonChartInstance) {
                productSalesPersonChartInstance.destroy();
            }
            
            productSalesPersonChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satış (USD)',
                        data: salesValues,
                        backgroundColor: 'rgba(245, 87, 108, 0.6)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    if (label === 'Satış (USD)') {
                                        return label + ': $' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                    } else {
                                        return label + ': ' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderProductMonthlyChart(data) {
            const monthlyData = {};
            data.forEach(item => {
                if (!item.date) return;
                const month = item.date.substring(0, 7); // YYYY-MM
                if (!monthlyData[month]) monthlyData[month] = 0;
                monthlyData[month] += parseFloat(item.usd_amount || 0);
            });
            
            const sorted = Object.entries(monthlyData).sort((a, b) => a[0].localeCompare(b[0]));
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1]);
            
            const ctx = document.getElementById('productMonthlyChart');
            if (!ctx) return;
            
            if (productMonthlyChartInstance) {
                productMonthlyChartInstance.destroy();
            }
            
            productMonthlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Aylık Satış (USD)',
                        data: values,
                        backgroundColor: 'rgba(240, 147, 251, 0.2)',
                        borderColor: 'rgba(240, 147, 251, 1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderProductDetailTable(data = null, sortColumn = null, sortDirection = null) {
            // Eğer data null ise, mevcut veriyi kullan
            if (data === null && lastProductSearchData) {
                data = lastProductSearchData;
            }
            
            if (!data || data.length === 0) {
                document.getElementById('productDetailTable').innerHTML = '<p style="text-align: center; padding: 20px;">Veri bulunamadı</p>';
                return;
            }
            
            // Sıralama parametrelerini güncelle
            if (sortColumn !== null) {
                if (currentSortColumn === sortColumn) {
                    // Aynı kolona tıklandı, yönü değiştir
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    // Farklı kolon, varsayılan azalan
                    currentSortColumn = sortColumn;
                    currentSortDirection = 'desc';
                }
            }
            
            // Ürün bazında grupla
            const productData = {};
            data.forEach(item => {
                const product = item.product || 'Bilinmiyor';
                if (!productData[product]) {
                    productData[product] = {
                        brand: item.brand || 'Bilinmiyor',
                        category: item.category_1 || 'Bilinmiyor',
                        sales: 0,
                        qty: 0,
                        count: 0
                    };
                }
                productData[product].sales += parseFloat(item.usd_amount || 0);
                productData[product].qty += parseFloat(item.quantity || 0);
                productData[product].count += 1;
            });
            
            // Veriyi global değişkene kaydet (sıralama için)
            currentProductData = Object.entries(productData);
            
            // Sıralama
            currentProductData.sort((a, b) => {
                let valA, valB;
                
                if (currentSortColumn === 'product') {
                    valA = a[0].toLowerCase();
                    valB = b[0].toLowerCase();
                    return currentSortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else if (currentSortColumn === 'brand') {
                    valA = a[1].brand.toLowerCase();
                    valB = b[1].brand.toLowerCase();
                    return currentSortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else if (currentSortColumn === 'category') {
                    valA = a[1].category.toLowerCase();
                    valB = b[1].category.toLowerCase();
                    return currentSortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else if (currentSortColumn === 'sales') {
                    valA = a[1].sales;
                    valB = b[1].sales;
                } else if (currentSortColumn === 'qty') {
                    valA = a[1].qty;
                    valB = b[1].qty;
                } else if (currentSortColumn === 'count') {
                    valA = a[1].count;
                    valB = b[1].count;
                } else if (currentSortColumn === 'avgPrice') {
                    valA = a[1].sales / Math.max(a[1].qty, 1);
                    valB = b[1].sales / Math.max(b[1].qty, 1);
                }
                
                return currentSortDirection === 'asc' ? valA - valB : valB - valA;
            });
            
            // Sıralama oku ikonu
            const getSortIcon = (column) => {
                if (currentSortColumn === column) {
                    return currentSortDirection === 'asc' ? ' ▲' : ' ▼';
                }
                return ' ⇅';
            };
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">#</th>
                            <th onclick="renderProductDetailTable(null, 'product')" style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sıralamak için tıklayın">
                                Ürün${getSortIcon('product')}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'brand')" style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sıralamak için tıklayın">
                                Marka${getSortIcon('brand')}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'category')" style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sıralamak için tıklayın">
                                Kategori${getSortIcon('category')}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'sales')" style="padding: 15px; text-align: right; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sıralamak için tıklayın">
                                Satış (USD)${getSortIcon('sales')}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'qty')" style="padding: 15px; text-align: right; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sıralamak için tıklayın">
                                Miktar${getSortIcon('qty')}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'count')" style="padding: 15px; text-align: right; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sıralamak için tıklayın">
                                İşlem${getSortIcon('count')}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'avgPrice')" style="padding: 15px; text-align: right; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sıralamak için tıklayın">
                                Ort. Fiyat${getSortIcon('avgPrice')}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            currentProductData.forEach((item, index) => {
                const product = item[0];
                const stats = item[1];
                const avgPrice = stats.sales / Math.max(stats.qty, 1);
                
                html += `
                    <tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                        <td style="padding: 12px;">${index + 1}</td>
                        <td style="padding: 12px;"><strong>${product}</strong></td>
                        <td style="padding: 12px;">${stats.brand}</td>
                        <td style="padding: 12px;">${stats.category}</td>
                        <td style="padding: 12px; text-align: right; color: #38ef7d; font-weight: bold;">$${stats.sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right;">${stats.qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right;">${stats.count}</td>
                        <td style="padding: 12px; text-align: right;">$${avgPrice.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('productDetailTable').innerHTML = html;
        }
        
        // 🤖 ÜRÜN ANALİZİ AI DEĞERLENDİRME
        function performProductAIAnalysis(data) {
            console.log('🤖 Ürün analizi AI değerlendirmesi başlatılıyor...');
            
            // Veri analizi
            const totalSales = data.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = data.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const uniqueProducts = new Set(data.map(item => item.product)).size;
            const avgPrice = totalSales / Math.max(totalQty, 1);
            
            // Mağaza analizi
            const storeData = {};
            data.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) storeData[store] = {sales: 0, qty: 0};
                storeData[store].sales += parseFloat(item.usd_amount || 0);
                storeData[store].qty += parseFloat(item.quantity || 0);
            });
            const topStores = Object.entries(storeData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            
            // İl analizi
            const cityData = {};
            data.forEach(item => {
                const city = item.city || 'Bilinmiyor';
                if (!cityData[city]) cityData[city] = {sales: 0, qty: 0};
                cityData[city].sales += parseFloat(item.usd_amount || 0);
                cityData[city].qty += parseFloat(item.quantity || 0);
            });
            const topCities = Object.entries(cityData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            
            // Temsilci analizi
            const personData = {};
            data.forEach(item => {
                const person = item.sales_person || 'Bilinmiyor';
                if (!personData[person]) personData[person] = {sales: 0, qty: 0};
                personData[person].sales += parseFloat(item.usd_amount || 0);
                personData[person].qty += parseFloat(item.quantity || 0);
            });
            const topPersons = Object.entries(personData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            
            // Marka analizi
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = {sales: 0, qty: 0};
                brandData[brand].sales += parseFloat(item.usd_amount || 0);
                brandData[brand].qty += parseFloat(item.quantity || 0);
            });
            const topBrands = Object.entries(brandData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            
            // Kategori analizi
            const categoryData = {};
            data.forEach(item => {
                const category = item.category_1 || 'Bilinmiyor';
                if (!categoryData[category]) categoryData[category] = {sales: 0, qty: 0};
                categoryData[category].sales += parseFloat(item.usd_amount || 0);
                categoryData[category].qty += parseFloat(item.quantity || 0);
            });
            const topCategories = Object.entries(categoryData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            
            // AI İçgörüleri
            const insights = {
                positive: [],
                negative: [],
                neutral: [],
                recommendations: []
            };
            
            // Pozitif içgörüler
            if (topStores.length > 0) {
                const topStore = topStores[0];
                const storeShare = (topStore[1].sales / totalSales * 100).toFixed(1);
                insights.positive.push({
                    title: `🏪 ${topStore[0]} Lider Mağaza`,
                    description: `${topStore[0]} mağazası toplam satışın %${storeShare}'ini gerçekleştirdi ($${topStore[1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} / ${topStore[1].qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})} adet). Bu mağaza bu ürün/marka için en güçlü performansı gösteriyor.`
                });
            }
            
            if (topCities.length > 0) {
                const topCity = topCities[0];
                const cityShare = (topCity[1].sales / totalSales * 100).toFixed(1);
                insights.positive.push({
                    title: `🌍 ${topCity[0]} Önde Gelen İl`,
                    description: `${topCity[0]} ili toplam satışın %${cityShare}'ini oluşturuyor ($${topCity[1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} / ${topCity[1].qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})} adet). Bu bölgede güçlü talep var.`
                });
            }
            
            if (topPersons.length > 0) {
                const topPerson = topPersons[0];
                const personShare = (topPerson[1].sales / totalSales * 100).toFixed(1);
                insights.positive.push({
                    title: `👤 ${topPerson[0]} Başarılı Temsilci`,
                    description: `${topPerson[0]} toplam satışın %${personShare}'ini gerçekleştirdi ($${topPerson[1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} / ${topPerson[1].qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})} adet). Bu temsilci bu ürün/marka konusunda uzman.`
                });
            }
            
            // Nötr içgörüler (Bilgilendirme)
            insights.neutral.push({
                title: `📊 Genel Performans`,
                description: `Toplam ${uniqueProducts} farklı ürün, ${totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2})} adet satıldı. Ortalama ürün fiyatı $${avgPrice.toLocaleString('tr-TR', {minimumFractionDigits: 2})}.`
            });
            
            if (topBrands.length > 0) {
                insights.neutral.push({
                    title: `🏷️ Marka Dağılımı`,
                    description: `En çok satan markalar: ${topBrands.map(b => b[0]).join(', ')}. Bu markalar toplam satışın büyük kısmını oluşturuyor.`
                });
            }
            
            if (topCategories.length > 0) {
                insights.neutral.push({
                    title: `📂 Kategori Dağılımı`,
                    description: `En çok satan kategoriler: ${topCategories.map(c => c[0]).join(', ')}. Bu kategorilerde yoğunlaşma var.`
                });
            }
            
            // Negatif içgörüler (Fırsatlar)
            if (topStores.length > 1) {
                const secondStore = topStores[1];
                const gap = ((topStores[0][1].sales - secondStore[1].sales) / secondStore[1].sales * 100).toFixed(1);
                if (gap > 50) {
                    insights.negative.push({
                        title: `⚠️ Mağazalar Arası Dengesizlik`,
                        description: `${topStores[0][0]} ile ${secondStore[0]} arasında %${gap} satış farkı var. Diğer mağazalarda potansiyel artış fırsatı mevcut.`
                    });
                }
            }
            
            if (Object.keys(cityData).length > 5 && topCities[0][1].sales / totalSales > 0.5) {
                insights.negative.push({
                    title: `🌍 Coğrafi Yoğunlaşma`,
                    description: `Satışların büyük kısmı ${topCities[0][0]} ilinde yoğunlaşmış. Diğer illerde pazar payı artırma fırsatı var.`
                });
            }
            
            // Öneriler
            insights.recommendations.push({
                icon: '🎯',
                title: 'Stok Optimizasyonu',
                description: `${topStores[0][0]} mağazasında bu ürün/marka için stok seviyesini artırın. Bu mağaza en yüksek satış performansını gösteriyor ve stok tükenmesi riski var.`
            });
            
            insights.recommendations.push({
                icon: '📍',
                title: 'Coğrafi Genişleme',
                description: `${topCities[0][0]} ilindeki başarıyı analiz edin ve benzer demografik özelliklere sahip diğer illerde (${topCities.slice(1, 3).map(c => c[0]).join(', ')}) pazarlama kampanyaları düzenleyin.`
            });
            
            insights.recommendations.push({
                icon: '👥',
                title: 'Temsilci Eğitimi',
                description: `${topPersons[0][0]}'in satış tekniklerini diğer temsilcilerle paylaşın. Bu temsilcinin başarı stratejilerini eğitim programına dahil edin.`
            });
            
            if (avgPrice > 300) {
                insights.recommendations.push({
                    icon: '💳',
                    title: 'Ödeme Kolaylığı',
                    description: `Ortalama ürün fiyatı $${avgPrice.toLocaleString('tr-TR', {minimumFractionDigits: 2})} gibi yüksek bir seviyede. Taksit seçenekleri ve finansman imkanları sunarak satışları artırabilirsiniz.`
                });
            }
            
            if (topStores.length >= 3) {
                const thirdStore = topStores[2];
                if (thirdStore[1].sales < topStores[0][1].sales * 0.3) {
                    insights.recommendations.push({
                        icon: '📢',
                        title: 'Düşük Performanslı Mağazalar',
                        description: `${thirdStore[0]} ve benzeri mağazalarda özel promosyonlar düzenleyin. Bu mağazalarda satış potansiyeli henüz tam olarak kullanılmamış.`
                    });
                }
            }
            
            // HTML oluştur
            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">
                    ${insights.positive.length > 0 ? `
                    <div class="analysis-section">
                        <h3 style="color: white; margin-top: 0;">✅ Güçlü Yönler</h3>
                        ${insights.positive.map(item => `
                            <div class="insight-item insight-positive" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">✅</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.negative.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">⚠️ Dikkat Edilmesi Gerekenler</h3>
                        ${insights.negative.map(item => `
                            <div class="insight-item insight-negative" style="background: rgba(245, 87, 108, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #f5576c;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">⚠️</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.neutral.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">💡 Genel Bilgiler</h3>
                        ${insights.neutral.map(item => `
                            <div class="insight-item insight-neutral" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">💡</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">🎯 Aksiyon Önerileri</h3>
                        ${insights.recommendations.map(item => `
                            <div class="recommendation" style="background: rgba(255, 255, 255, 0.15); padding: 18px; border-radius: 10px; margin: 12px 0;">
                                <span class="recommendation-icon" style="font-size: 1.8em; margin-right: 12px;">${item.icon}</span>
                                <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px);">
                                    <strong style="font-size: 1.15em; display: block; margin-bottom: 8px;">${item.title}</strong>
                                    <p style="margin: 0; opacity: 0.95; line-height: 1.6;">${item.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('productAIAnalysisContent').innerHTML = html;
            document.getElementById('productAIAnalysisPanel').style.display = 'block';
        }
        
        // ==================== GPT BACKEND ENTEGRASYONU ====================
        
        // Maliyet takibi için localStorage
        let queryCostTracker = {
            totalQueries: parseInt(localStorage.getItem('gpt_total_queries') || '0'),
            totalCost: parseFloat(localStorage.getItem('gpt_total_cost') || '0'),
            monthlyQueries: parseInt(localStorage.getItem('gpt_monthly_queries') || '0'),
            monthlyCost: parseFloat(localStorage.getItem('gpt_monthly_cost') || '0'),
            lastResetDate: localStorage.getItem('gpt_last_reset') || new Date().toISOString().slice(0, 7)
        };
        
        // Aylık sıfırlama kontrolü
        function checkMonthlyReset() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            if (queryCostTracker.lastResetDate !== currentMonth) {
                queryCostTracker.monthlyQueries = 0;
                queryCostTracker.monthlyCost = 0;
                queryCostTracker.lastResetDate = currentMonth;
                localStorage.setItem('gpt_monthly_queries', '0');
                localStorage.setItem('gpt_monthly_cost', '0');
                localStorage.setItem('gpt_last_reset', currentMonth);
            }
        }
        
        // Maliyet güncelleme
        function updateQueryCost(model, inputTokens, outputTokens) {
            checkMonthlyReset();
            
            let cost = 0;
            if (model === 'gpt-3.5-turbo') {
                cost = (inputTokens / 1000 * 0.0005) + (outputTokens / 1000 * 0.0015);
            } else if (model === 'gpt-4-turbo') {
                cost = (inputTokens / 1000 * 0.01) + (outputTokens / 1000 * 0.03);
            } else if (model === 'gpt-4o-mini') {
                cost = (inputTokens / 1000 * 0.00015) + (outputTokens / 1000 * 0.0006);
            }
            
            queryCostTracker.totalQueries++;
            queryCostTracker.totalCost += cost;
            queryCostTracker.monthlyQueries++;
            queryCostTracker.monthlyCost += cost;
            
            localStorage.setItem('gpt_total_queries', queryCostTracker.totalQueries.toString());
            localStorage.setItem('gpt_total_cost', queryCostTracker.totalCost.toFixed(4));
            localStorage.setItem('gpt_monthly_queries', queryCostTracker.monthlyQueries.toString());
            localStorage.setItem('gpt_monthly_cost', queryCostTracker.monthlyCost.toFixed(4));
            
            console.log(`💰 GPT Maliyet: $${cost.toFixed(4)} | Aylık Toplam: $${queryCostTracker.monthlyCost.toFixed(2)} (${queryCostTracker.monthlyQueries} sorgu)`);
            
            return cost;
        }
        
        // GPT API çağrısı (Backend'e gönderilecek)
        async function callGPTAPI(query, context) {
            // ÖNEMLİ: Bu fonksiyon şu anda placeholder. 
            // Gerçek kullanım için backend API endpoint'i gerekli.
            
            console.log('🤖 GPT API çağrısı hazırlanıyor...');
            console.log('📝 Sorgu:', query);
            console.log('📊 Context boyutu:', JSON.stringify(context).length, 'karakter');
            
            // Backend endpoint (Vercel/Netlify Functions)
            const BACKEND_URL = 'YOUR_BACKEND_URL_HERE'; // Buraya backend URL'i eklenecek
            
            try {
                // Backend'e istek gönder
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        context: context,
                        model: 'gpt-3.5-turbo' // veya 'gpt-4-turbo'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Backend error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Maliyet takibi
                if (data.usage) {
                    updateQueryCost(
                        data.model || 'gpt-3.5-turbo',
                        data.usage.prompt_tokens,
                        data.usage.completion_tokens
                    );
                }
                
                return {
                    success: true,
                    answer: data.answer,
                    model: data.model,
                    cost: data.cost
                };
                
            } catch (error) {
                console.error('❌ GPT API Hatası:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // Maliyet istatistiklerini göster
        function showCostStats() {
            checkMonthlyReset();
            
            const statsHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin: 10px 0;">
                    <h4 style="margin: 0 0 10px 0;">💰 GPT Maliyet İstatistikleri</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <strong>Bu Ay:</strong><br>
                            ${queryCostTracker.monthlyQueries} sorgu<br>
                            $${queryCostTracker.monthlyCost.toFixed(2)} (~${(queryCostTracker.monthlyCost * 30).toFixed(0)} TL)
                        </div>
                        <div>
                            <strong>Toplam:</strong><br>
                            ${queryCostTracker.totalQueries} sorgu<br>
                            $${queryCostTracker.totalCost.toFixed(2)}
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.9;">
                        📊 Ortalama: $${(queryCostTracker.monthlyCost / Math.max(queryCostTracker.monthlyQueries, 1)).toFixed(4)}/sorgu
                    </div>
                </div>
            `;
            
            // Stats'ı debug panel'e ekle
            const debugPanel = document.getElementById('debugPanel');
            if (debugPanel && debugPanel.style.display === 'block') {
                const debugInfo = document.getElementById('debugInfo');
                debugInfo.innerHTML += statsHTML;
            }
        }
        
        // Konsol komutu: Maliyet istatistiklerini göster
        window.showGPTStats = function() {
            checkMonthlyReset();
            console.log('💰 GPT Maliyet İstatistikleri:');
            console.log('Bu Ay:', queryCostTracker.monthlyQueries, 'sorgu, $' + queryCostTracker.monthlyCost.toFixed(2));
            console.log('Toplam:', queryCostTracker.totalQueries, 'sorgu, $' + queryCostTracker.totalCost.toFixed(2));
            console.log('Ortalama:', '$' + (queryCostTracker.monthlyCost / Math.max(queryCostTracker.monthlyQueries, 1)).toFixed(4), 'per sorgu');
        };
        
        // Konsol komutu: Maliyet sıfırla
        window.resetGPTStats = function() {
            if (confirm('Tüm GPT maliyet istatistiklerini sıfırlamak istediğinize emin misiniz?')) {
                localStorage.removeItem('gpt_total_queries');
                localStorage.removeItem('gpt_total_cost');
                localStorage.removeItem('gpt_monthly_queries');
                localStorage.removeItem('gpt_monthly_cost');
                localStorage.removeItem('gpt_last_reset');
                queryCostTracker = {
                    totalQueries: 0,
                    totalCost: 0,
                    monthlyQueries: 0,
                    monthlyCost: 0,
                    lastResetDate: new Date().toISOString().slice(0, 7)
                };
                console.log('✅ GPT maliyet istatistikleri sıfırlandı.');
            }
        };
        
        console.log('✅ GPT Backend hazır! Kullanım:');
        console.log('   showGPTStats() - Maliyet istatistiklerini göster');
        console.log('   resetGPTStats() - Maliyet istatistiklerini sıfırla');
        
        // ==================== CUSTOMER SEARCH IN MAIN TAB ====================
        let customerBrandChartMainInstance = null;
        let customerCategoryChartMainInstance = null;
        
        function searchCustomerProfileMain() {
            const searchQuery = document.getElementById('customerSearchInputMain').value.trim().toLowerCase();
            
            if (!searchQuery) {
                alert('Lütfen bir müşteri adı girin');
                return;
            }
            
            console.log('🔍 Müşteri aranıyor:', searchQuery);
            
            // Müşteri verilerini filtrele (fuzzy matching)
            const customerData = allData.filter(item => 
                item.partner && item.partner.toLowerCase().includes(searchQuery)
            );
            
            if (customerData.length === 0) {
                document.getElementById('customerProfileMainContainer').style.display = 'none';
                alert('Müşteri bulunamadı. Lütfen farklı bir isim deneyin.');
                return;
            }
            
            // Sonuçları göster
            document.getElementById('customerProfileMainContainer').style.display = 'block';
            
            // Müşteri bilgilerini hesapla
            const customerName = customerData[0].partner;
            const customerCity = customerData[0].city || 'Bilinmiyor';
            const customerTags = customerData[0].tags || '-';
            
            const totalSales = customerData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = customerData.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const uniqueDates = new Set(customerData.map(item => item.date));
            const transactionCount = uniqueDates.size;
            const avgBasket = totalSales / Math.max(transactionCount, 1);
            
            // UI güncelle
            document.getElementById('customerNameMain').textContent = customerName;
            document.getElementById('customerCityMain').textContent = customerCity;
            document.getElementById('customerTagsMain').textContent = customerTags;
            document.getElementById('customerTotalSalesMain').textContent = '$' + totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('customerTotalQtyMain').textContent = totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('customerTransactionCountMain').textContent = transactionCount;
            document.getElementById('customerAvgBasketMain').textContent = '$' + avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            
            // Grafikleri render et
            renderCustomerBrandChartMain(customerData);
            renderCustomerCategoryChartMain(customerData);
            
            // Veriyi kaydet (sıralama için)
            lastCustomerPurchaseData = customerData;
            
            // Satın alma geçmişi tablosu
            renderCustomerPurchaseHistoryMain(customerData);
            
            // AI analiz
            performCustomerAIAnalysisMain(customerData, {
                name: customerName,
                city: customerCity,
                tags: customerTags,
                totalSales,
                totalQty,
                transactionCount,
                avgBasket
            });
            
            // Sonuçlara scroll
            document.getElementById('customerProfileMainContainer').scrollIntoView({behavior: 'smooth', block: 'start'});
        }
        
        function renderCustomerBrandChartMain(data) {
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += parseFloat(item.usd_amount || 0);
            });
            
            const sorted = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1]);
            
            const ctx = document.getElementById('customerBrandChartMain');
            if (!ctx) return;
            
            if (customerBrandChartMainInstance) {
                customerBrandChartMainInstance.destroy();
            }
            
            customerBrandChartMainInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satış (USD)',
                        data: values,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCustomerCategoryChartMain(data) {
            const categoryData = {};
            data.forEach(item => {
                const category = item.category_1 || 'Bilinmiyor';
                if (!categoryData[category]) categoryData[category] = 0;
                categoryData[category] += parseFloat(item.usd_amount || 0);
            });
            
            const sorted = Object.entries(categoryData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1]);
            
            const ctx = document.getElementById('customerCategoryChartMain');
            if (!ctx) return;
            
            if (customerCategoryChartMainInstance) {
                customerCategoryChartMainInstance.destroy();
            }
            
            customerCategoryChartMainInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satış (USD)',
                        data: values,
                        backgroundColor: 'rgba(56, 239, 125, 0.6)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCustomerPurchaseHistoryMain(data = null, sortColumn = null, sortDirection = null) {
            // Eğer data null ise, mevcut veriyi kullan
            if (data === null && lastCustomerPurchaseData) {
                data = lastCustomerPurchaseData;
            }
            
            if (!data || data.length === 0) {
                document.getElementById('customerPurchaseHistoryMain').innerHTML = '<p style="text-align: center; padding: 20px;">Veri bulunamadı</p>';
                return;
            }
            
            // Sıralama parametrelerini güncelle
            if (sortColumn !== null) {
                if (currentCustomerPurchaseSortColumn === sortColumn) {
                    currentCustomerPurchaseSortDirection = currentCustomerPurchaseSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentCustomerPurchaseSortColumn = sortColumn;
                    currentCustomerPurchaseSortDirection = sortColumn === 'date' ? 'desc' : 'asc';
                }
            }
            
            // Sıralama
            let sorted = [...data];
            
            if (currentCustomerPurchaseSortColumn === 'date') {
                sorted.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return currentCustomerPurchaseSortDirection === 'asc' ? dateA - dateB : dateB - dateA;
                });
            } else if (currentCustomerPurchaseSortColumn === 'product') {
                sorted.sort((a, b) => {
                    return currentCustomerPurchaseSortDirection === 'asc'
                        ? (a.product || '').localeCompare(b.product || '', 'tr')
                        : (b.product || '').localeCompare(a.product || '', 'tr');
                });
            } else if (currentCustomerPurchaseSortColumn === 'brand') {
                sorted.sort((a, b) => {
                    return currentCustomerPurchaseSortDirection === 'asc'
                        ? (a.brand || '').localeCompare(b.brand || '', 'tr')
                        : (b.brand || '').localeCompare(a.brand || '', 'tr');
                });
            } else if (currentCustomerPurchaseSortColumn === 'quantity') {
                sorted.sort((a, b) => {
                    return currentCustomerPurchaseSortDirection === 'asc'
                        ? parseFloat(a.quantity || 0) - parseFloat(b.quantity || 0)
                        : parseFloat(b.quantity || 0) - parseFloat(a.quantity || 0);
                });
            } else if (currentCustomerPurchaseSortColumn === 'amount') {
                sorted.sort((a, b) => {
                    return currentCustomerPurchaseSortDirection === 'asc'
                        ? parseFloat(a.usd_amount || 0) - parseFloat(b.usd_amount || 0)
                        : parseFloat(b.usd_amount || 0) - parseFloat(a.usd_amount || 0);
                });
            } else if (currentCustomerPurchaseSortColumn === 'store') {
                sorted.sort((a, b) => {
                    return currentCustomerPurchaseSortDirection === 'asc'
                        ? (a.store || '').localeCompare(b.store || '', 'tr')
                        : (b.store || '').localeCompare(a.store || '', 'tr');
                });
            }
            
            // Son 20 işlem
            sorted = sorted.slice(0, 20);
            
            const getSortIcon = (column) => {
                if (currentCustomerPurchaseSortColumn !== column) return '⇅';
                return currentCustomerPurchaseSortDirection === 'asc' ? '↑' : '↓';
            };
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'date')">
                                Tarih ${getSortIcon('date')}
                            </th>
                            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'product')">
                                Ürün ${getSortIcon('product')}
                            </th>
                            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'brand')">
                                Marka ${getSortIcon('brand')}
                            </th>
                            <th style="padding: 12px; text-align: right; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'quantity')">
                                Adet ${getSortIcon('quantity')}
                            </th>
                            <th style="padding: 12px; text-align: right; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'amount')">
                                Tutar ${getSortIcon('amount')}
                            </th>
                            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'store')">
                                Mağaza ${getSortIcon('store')}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sorted.forEach((item, index) => {
                html += `
                    <tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                        <td style="padding: 10px;">${item.date}</td>
                        <td style="padding: 10px;"><strong>${item.product}</strong></td>
                        <td style="padding: 10px;">${item.brand}</td>
                        <td style="padding: 10px; text-align: right;">${parseFloat(item.quantity || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 10px; text-align: right; color: #38ef7d; font-weight: bold;">$${parseFloat(item.usd_amount || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 10px;">${item.store}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('customerPurchaseHistoryMain').innerHTML = html;
        }
        
        function performCustomerAIAnalysisMain(data, profile) {
            console.log('🤖 Müşteri AI analizi başlatılıyor...', profile);
            
            // Veri analizi
            const brandData = {};
            const categoryData = {};
            const storeData = {};
            const monthlyData = {};
            
            data.forEach(item => {
                // Marka
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = {sales: 0, qty: 0, count: 0};
                brandData[brand].sales += parseFloat(item.usd_amount || 0);
                brandData[brand].qty += parseFloat(item.quantity || 0);
                brandData[brand].count += 1;
                
                // Kategori
                const category = item.category_1 || 'Bilinmiyor';
                if (!categoryData[category]) categoryData[category] = {sales: 0, qty: 0};
                categoryData[category].sales += parseFloat(item.usd_amount || 0);
                categoryData[category].qty += parseFloat(item.quantity || 0);
                
                // Mağaza
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) storeData[store] = {sales: 0, count: 0};
                storeData[store].sales += parseFloat(item.usd_amount || 0);
                storeData[store].count += 1;
                
                // Aylık
                const month = item.date ? item.date.substring(0, 7) : 'Bilinmiyor';
                if (!monthlyData[month]) monthlyData[month] = 0;
                monthlyData[month] += parseFloat(item.usd_amount || 0);
            });
            
            // Top 3 listeler
            const topBrands = Object.entries(brandData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            const topCategories = Object.entries(categoryData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            const topStores = Object.entries(storeData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            const monthlySales = Object.entries(monthlyData).sort((a, b) => new Date(b[0]) - new Date(a[0])).slice(0, 6);
            
            // En çok alınan ürün
            const productData = {};
            data.forEach(item => {
                const product = item.product || 'Bilinmiyor';
                if (!productData[product]) productData[product] = {qty: 0, sales: 0};
                productData[product].qty += parseFloat(item.quantity || 0);
                productData[product].sales += parseFloat(item.usd_amount || 0);
            });
            const topProduct = Object.entries(productData).sort((a, b) => b[1].qty - a[1].qty)[0];
            
            // AI İçgörüleri
            const insights = {
                positive: [],
                negative: [],
                neutral: [],
                recommendations: []
            };
            
            // Pozitif İçgörüler
            if (profile.totalSales > 10000) {
                insights.positive.push({
                    title: '💎 VIP Müşteri',
                    description: `${profile.name}, toplam $${profile.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} alışveriş ile VIP müşteri kategorisinde. Bu müşteriye özel ilgi gösterilmeli.`
                });
            } else if (profile.totalSales > 5000) {
                insights.positive.push({
                    title: '⭐ Değerli Müşteri',
                    description: `${profile.name}, toplam $${profile.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} alışveriş ile değerli müşteri kategorisinde.`
                });
            }
            
            if (profile.transactionCount > 10) {
                insights.positive.push({
                    title: '🔄 Sadık Müşteri',
                    description: `${profile.transactionCount} işlem ile düzenli alışveriş yapan sadık bir müşteri. Müşteri memnuniyeti yüksek.`
                });
            }
            
            if (profile.avgBasket > 1000) {
                insights.positive.push({
                    title: '🛒 Yüksek Sepet Ortalaması',
                    description: `Ortalama sepet tutarı $${profile.avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2})}. Premium ürünlere ilgi gösteriyor.`
                });
            }
            
            if (topBrands.length > 0) {
                insights.positive.push({
                    title: `🏷️ Favori Marka: ${topBrands[0][0]}`,
                    description: `${topBrands[0][0]} markasından $${topBrands[0][1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} değerinde ${topBrands[0][1].count} adet ürün aldı. Bu markada yeni ürünler önerilmeli.`
                });
            }
            
            // Negatif İçgörüler / Dikkat Edilmesi Gerekenler
            if (profile.transactionCount < 3) {
                insights.negative.push({
                    title: '⚠️ Yeni Müşteri',
                    description: `Sadece ${profile.transactionCount} işlem gerçekleştirdi. Müşteri sadakati oluşturmak için özel kampanyalar sunulmalı.`
                });
            }
            
            if (profile.avgBasket < 500) {
                insights.negative.push({
                    title: '📊 Düşük Sepet Ortalaması',
                    description: `Ortalama sepet tutarı $${profile.avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2})}. Cross-sell ve up-sell fırsatları değerlendirilmeli.`
                });
            }
            
            const lastPurchaseDate = data.length > 0 ? new Date(Math.max(...data.map(item => new Date(item.date)))) : null;
            if (lastPurchaseDate) {
                const daysSinceLastPurchase = Math.floor((new Date() - lastPurchaseDate) / (1000 * 60 * 60 * 24));
                if (daysSinceLastPurchase > 90) {
                    insights.negative.push({
                        title: '⏰ Uzun Süredir Alışveriş Yok',
                        description: `Son alışverişten ${daysSinceLastPurchase} gün geçti. Müşteriyi geri kazanmak için hatırlatma kampanyası düzenlenebilir.`
                    });
                }
            }
            
            // Nötr İçgörüler
            insights.neutral.push({
                title: '📍 Konum Bilgisi',
                description: `Müşteri ${profile.city} şehrinden alışveriş yapıyor. ${topStores.length > 0 ? `En çok ${topStores[0][0]} mağazasını tercih ediyor.` : ''}`
            });
            
            if (topCategories.length > 0) {
                insights.neutral.push({
                    title: `📂 İlgi Alanı: ${topCategories[0][0]}`,
                    description: `${topCategories[0][0]} kategorisinden $${topCategories[0][1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} değerinde alışveriş yaptı.`
                });
            }
            
            if (topProduct) {
                insights.neutral.push({
                    title: `🎯 En Çok Aldığı Ürün`,
                    description: `${topProduct[0]} ürününden ${topProduct[1].qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})} adet aldı.`
                });
            }
            
            // Öneriler
            if (topBrands.length > 1) {
                insights.recommendations.push({
                    icon: '🎁',
                    title: 'Çapraz Satış Fırsatı',
                    description: `Müşteri ${topBrands.map(b => b[0]).join(', ')} markalarını tercih ediyor. Bu markaların yeni ürünleri ve aksesuarları önerilebilir.`
                });
            }
            
            if (profile.avgBasket > 500) {
                insights.recommendations.push({
                    icon: '💳',
                    title: 'Premium Ürün Önerisi',
                    description: `Yüksek sepet ortalaması nedeniyle premium ve lüks ürünler önerilebilir. Özel koleksiyonlar sunulmalı.`
                });
            }
            
            if (profile.transactionCount > 5) {
                insights.recommendations.push({
                    icon: '🎖️',
                    title: 'Sadakat Programı',
                    description: `Düzenli müşteri olduğu için sadakat programına dahil edilmeli. Özel indirimler ve erken erişim fırsatları sunulabilir.`
                });
            }
            
            if (topStores.length > 0) {
                insights.recommendations.push({
                    icon: '🏪',
                    title: 'Mağaza Bazlı Kampanya',
                    description: `${topStores[0][0]} mağazasını sıklıkla tercih ediyor. Bu mağazada özel etkinlikler ve lansmanlar için davet gönderilebilir.`
                });
            }
            
            insights.recommendations.push({
                icon: '📧',
                title: 'Kişiselleştirilmiş İletişim',
                description: `${topCategories.length > 0 ? topCategories[0][0] : 'İlgi alanı'} kategorisindeki yeni ürünler hakkında e-posta veya SMS ile bilgilendirme yapılabilir.`
            });
            
            if (monthlySales.length > 0) {
                const avgMonthlySales = monthlySales.reduce((sum, item) => sum + item[1], 0) / monthlySales.length;
                insights.recommendations.push({
                    icon: '📊',
                    title: 'Alışveriş Tahmini',
                    description: `Aylık ortalama $${avgMonthlySales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} alışveriş yapıyor. Gelecek ay için özel teklifler hazırlanabilir.`
                });
            }
            
            // HTML oluşturma
            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">
                    ${insights.positive.length > 0 ? `
                    <div class="analysis-section">
                        <h3 style="color: white; margin-top: 0;">✅ Güçlü Yönler</h3>
                        ${insights.positive.map(item => `
                            <div class="insight-item insight-positive" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">✅</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.negative.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 30px;">
                        <h3 style="color: white;">⚠️ Dikkat Edilmesi Gerekenler</h3>
                        ${insights.negative.map(item => `
                            <div class="insight-item insight-negative" style="background: rgba(255, 107, 107, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ff6b6b;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">⚠️</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.neutral.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 30px;">
                        <h3 style="color: white;">📊 Genel Bilgiler</h3>
                        ${insights.neutral.map(item => `
                            <div class="insight-item insight-neutral" style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid white;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">📊</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.recommendations.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 30px;">
                        <h3 style="color: white;">💡 Aksiyon Önerileri</h3>
                        ${insights.recommendations.map(item => `
                            <div class="recommendation" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700; display: flex; align-items: start; gap: 15px;">
                                <span class="recommendation-icon" style="font-size: 2em; flex-shrink: 0;">${item.icon}</span>
                                <div style="flex: 1;">
                                    <strong style="font-size: 1.1em; display: block; margin-bottom: 5px;">${item.title}</strong>
                                    <span style="opacity: 0.95;">${item.description}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('customerAIAnalysisContentMain').innerHTML = html;
            document.getElementById('customerAIAnalysisPanelMain').style.display = 'block';
        }
        
        // ==================== OLD CUSTOMER SEARCH TAB (DEPRECATED) ====================
        let customerBrandChartInstance = null;
        let customerCategoryChartInstance = null;
        let customerStoreChartInstance = null;
        let customerMonthlyTrendChartInstance = null;
        
        function populateCityDropdownForCustomerSearch() {
            // Artık kullanılmıyor - Müşteri arama Müşteri Analizi içinde
            console.log('⚠️ Bu fonksiyon artık kullanılmıyor');
        }
        
        function searchCustomerProfile() {
            const searchQuery = document.getElementById('customerSearchInput').value.trim().toLowerCase();
            
            if (!searchQuery) {
                alert('Lütfen bir müşteri adı girin');
                return;
            }
            
            console.log('🔍 Müşteri aranıyor:', searchQuery);
            
            // Müşteri verilerini filtrele (fuzzy matching)
            const customerData = allData.filter(item => 
                item.partner && item.partner.toLowerCase().includes(searchQuery)
            );
            
            if (customerData.length === 0) {
                document.getElementById('customerProfileContainer').style.display = 'none';
                document.getElementById('customerSearchNoResults').style.display = 'block';
                return;
            }
            
            // Sonuçları göster
            document.getElementById('customerSearchNoResults').style.display = 'none';
            document.getElementById('customerProfileContainer').style.display = 'block';
            
            // Müşteri bilgilerini hesapla
            const customerName = customerData[0].partner;
            const customerCity = customerData[0].city || 'Bilinmiyor';
            const customerTags = customerData[0].tags || '-';
            
            const totalSales = customerData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = customerData.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const uniqueDates = new Set(customerData.map(item => item.date));
            const transactionCount = uniqueDates.size;
            const avgBasket = totalSales / Math.max(transactionCount, 1);
            
            // Tarih bilgileri
            const dates = customerData.map(item => new Date(item.date)).sort((a, b) => a - b);
            const firstPurchase = dates[0].toLocaleDateString('tr-TR');
            const lastPurchase = dates[dates.length - 1].toLocaleDateString('tr-TR');
            
            // UI güncelle
            document.getElementById('customerName').textContent = customerName;
            document.getElementById('customerCity').textContent = customerCity;
            document.getElementById('customerTags').textContent = customerTags;
            document.getElementById('customerTotalSales').textContent = '$' + totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('customerTotalQty').textContent = totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('customerTransactionCount').textContent = transactionCount;
            document.getElementById('customerAvgBasket').textContent = '$' + avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('customerFirstPurchase').textContent = firstPurchase;
            document.getElementById('customerLastPurchase').textContent = lastPurchase;
            
            // Grafikleri render et
            renderCustomerBrandChart(customerData);
            renderCustomerCategoryChart(customerData);
            renderCustomerStoreChart(customerData);
            renderCustomerMonthlyTrendChart(customerData);
            
            // Satın alma geçmişi tablosu
            renderCustomerPurchaseHistory(customerData);
            
            // AI analiz
            performCustomerAIAnalysis(customerData, {
                name: customerName,
                city: customerCity,
                tags: customerTags,
                totalSales,
                totalQty,
                transactionCount,
                avgBasket,
                firstPurchase,
                lastPurchase
            });
        }
        
        function renderCustomerBrandChart(data) {
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = {sales: 0, qty: 0};
                brandData[brand].sales += parseFloat(item.usd_amount || 0);
                brandData[brand].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(brandData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1].sales);
            
            const ctx = document.getElementById('customerBrandChart');
            if (!ctx) return;
            
            if (customerBrandChartInstance) {
                customerBrandChartInstance.destroy();
            }
            
            customerBrandChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satış (USD)',
                        data: values,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCustomerCategoryChart(data) {
            const categoryData = {};
            data.forEach(item => {
                const category = item.category_1 || 'Bilinmiyor';
                if (!categoryData[category]) categoryData[category] = {sales: 0, qty: 0};
                categoryData[category].sales += parseFloat(item.usd_amount || 0);
                categoryData[category].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(categoryData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1].sales);
            
            const ctx = document.getElementById('customerCategoryChart');
            if (!ctx) return;
            
            if (customerCategoryChartInstance) {
                customerCategoryChartInstance.destroy();
            }
            
            customerCategoryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satış (USD)',
                        data: values,
                        backgroundColor: 'rgba(56, 239, 125, 0.6)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCustomerStoreChart(data) {
            const storeData = {};
            data.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) storeData[store] = {sales: 0, qty: 0};
                storeData[store].sales += parseFloat(item.usd_amount || 0);
                storeData[store].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(storeData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1].sales);
            
            const ctx = document.getElementById('customerStoreChart');
            if (!ctx) return;
            
            if (customerStoreChartInstance) {
                customerStoreChartInstance.destroy();
            }
            
            customerStoreChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satış (USD)',
                        data: values,
                        backgroundColor: 'rgba(245, 87, 108, 0.6)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCustomerMonthlyTrendChart(data) {
            const monthlyData = {};
            data.forEach(item => {
                const date = new Date(item.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[monthKey]) monthlyData[monthKey] = 0;
                monthlyData[monthKey] += parseFloat(item.usd_amount || 0);
            });
            
            const sorted = Object.entries(monthlyData).sort((a, b) => a[0].localeCompare(b[0]));
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1]);
            
            const ctx = document.getElementById('customerMonthlyTrendChart');
            if (!ctx) return;
            
            if (customerMonthlyTrendChartInstance) {
                customerMonthlyTrendChartInstance.destroy();
            }
            
            customerMonthlyTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Aylık Satış (USD)',
                        data: values,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCustomerPurchaseHistory(data) {
            // Son 50 işlemi göster
            const sorted = [...data].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 50);
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left;">Tarih</th>
                            <th style="padding: 15px; text-align: left;">Ürün</th>
                            <th style="padding: 15px; text-align: left;">Marka</th>
                            <th style="padding: 15px; text-align: right;">Adet</th>
                            <th style="padding: 15px; text-align: right;">Tutar</th>
                            <th style="padding: 15px; text-align: left;">Mağaza</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sorted.forEach((item, index) => {
                html += `
                    <tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                        <td style="padding: 12px;">${item.date}</td>
                        <td style="padding: 12px;"><strong>${item.product}</strong></td>
                        <td style="padding: 12px;">${item.brand}</td>
                        <td style="padding: 12px; text-align: right;">${parseFloat(item.quantity || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right; color: #38ef7d; font-weight: bold;">$${parseFloat(item.usd_amount || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px;">${item.store}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('customerPurchaseHistory').innerHTML = html;
        }
        
        function performCustomerAIAnalysis(data, profile) {
            console.log('🤖 Müşteri AI analizi başlatılıyor...');
            
            const insights = {
                positive: [],
                negative: [],
                neutral: [],
                recommendations: []
            };
            
            // VIP müşteri mi?
            if (profile.totalSales > 40000) {
                insights.positive.push({
                    title: '👑 VIP Müşteri',
                    description: `Toplam ${profile.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} USD alışveriş yapmış. Bu müşteriye özel ilgi gösterilmeli.`
                });
            }
            
            // Sadık müşteri mi?
            const firstDate = new Date(profile.firstPurchase.split('.').reverse().join('-'));
            const lastDate = new Date(profile.lastPurchase.split('.').reverse().join('-'));
            const daysDiff = Math.floor((lastDate - firstDate) / (1000 * 60 * 60 * 24));
            
            if (daysDiff > 365) {
                insights.positive.push({
                    title: '💎 Sadık Müşteri',
                    description: `${Math.floor(daysDiff / 365)} yıldan fazla süredir müşteri. Uzun vadeli ilişki kurulmuş.`
                });
            }
            
            // Yüksek sepet ortalaması
            if (profile.avgBasket > 3000) {
                insights.positive.push({
                    title: '💰 Yüksek Sepet Değeri',
                    description: `Ortalama sepet değeri $${profile.avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2})}. Premium ürünleri tercih ediyor.`
                });
            }
            
            // Marka sadakati
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += parseFloat(item.usd_amount || 0);
            });
            const topBrand = Object.entries(brandData).sort((a, b) => b[1] - a[1])[0];
            const brandShare = (topBrand[1] / profile.totalSales * 100).toFixed(1);
            
            if (brandShare > 50) {
                insights.neutral.push({
                    title: `🏷️ ${topBrand[0]} Markasına Sadık`,
                    description: `Alışverişlerin %${brandShare}'i ${topBrand[0]} markasından. Bu markadaki yeni ürünleri önerebilirsiniz.`
                });
            }
            
            // Öneriler
            insights.recommendations.push({
                icon: '🎁',
                title: 'Kişiselleştirilmiş Kampanya',
                description: `${topBrand[0]} markasındaki yeni ürünler için özel indirim sunun.`
            });
            
            insights.recommendations.push({
                icon: '📧',
                title: 'E-posta Bildirimi',
                description: `Tercih ettiği kategorilerdeki (${data[0].category_1}) yeni ürünler için e-posta gönderin.`
            });
            
            if (profile.avgBasket > 3000) {
                insights.recommendations.push({
                    icon: '⭐',
                    title: 'VIP Program',
                    description: `Yüksek sepet değeri nedeniyle VIP müşteri programına davet edin.`
                });
            }
            
            // HTML oluştur
            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">
                    ${insights.positive.length > 0 ? `
                    <div class="analysis-section">
                        <h3 style="color: white; margin-top: 0;">✅ Müşteri Profili</h3>
                        ${insights.positive.map(item => `
                            <div class="insight-item insight-positive" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">✅</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.neutral.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">💡 Satın Alma Davranışı</h3>
                        ${insights.neutral.map(item => `
                            <div class="insight-item insight-neutral" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">💡</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">🎯 Kişiselleştirilmiş Öneriler</h3>
                        ${insights.recommendations.map(item => `
                            <div class="recommendation" style="background: rgba(255, 255, 255, 0.15); padding: 18px; border-radius: 10px; margin: 12px 0;">
                                <span class="recommendation-icon" style="font-size: 1.8em; margin-right: 12px;">${item.icon}</span>
                                <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px);">
                                    <strong style="font-size: 1.15em; display: block; margin-bottom: 8px;">${item.title}</strong>
                                    <p style="margin: 0; opacity: 0.95; line-height: 1.6;">${item.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('customerAIAnalysisContent').innerHTML = html;
        }
        
        // ==================== CITY ANALYSIS TAB ====================
        let cityBrandChartInstance = null;
        let cityProductChartInstance = null;
        let cityCategoryChartInstance = null;
        let cityMonthlyChartInstance = null;
        
        function populateCitySelect() {
            // Veri yüklenmemişse uyarı ver
            if (!allData || allData.length === 0) {
                console.warn('⚠️ Şehir listesi doldurulamadı: Veri henüz yüklenmedi');
                return;
            }
            
            const cities = new Set();
            allData.forEach(item => {
                if (item.city) cities.add(item.city);
            });
            
            const select = document.getElementById('citySelect');
            if (!select) {
                console.error('❌ citySelect elementi bulunamadı');
                return;
            }
            
            select.innerHTML = '<option value="">-- Şehir Seçin --</option>';
            
            if (cities.size === 0) {
                console.warn('⚠️ Hiç şehir verisi bulunamadı');
                select.innerHTML += '<option value="" disabled>Şehir verisi bulunamadı</option>';
                return;
            }
            
            Array.from(cities).sort().forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                select.appendChild(option);
            });
            
            console.log('✅ Şehir dropdown dolduruldu:', cities.size, 'şehir');
        }
        
        function populateTargetStoreDropdowns() {
            // Mağazaları topla
            const stores = new Set();
            allData.forEach(item => {
                if (item.store) stores.add(item.store);
            });
            
            const sortedStores = Array.from(stores).sort();
            
            // Yıllık hedef mağaza dropdown
            const yearStoreSelect = document.getElementById('targetYearStore');
            if (yearStoreSelect) {
                const currentYearValue = yearStoreSelect.value; // Mevcut seçimi koru
                yearStoreSelect.innerHTML = '<option value="TÜM MAĞAZALAR">🏢 Tüm Mağazalar</option>';
                sortedStores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store;
                    option.textContent = store;
                    yearStoreSelect.appendChild(option);
                });
                // Mevcut seçimi geri yükle
                if (currentYearValue && sortedStores.includes(currentYearValue)) {
                    yearStoreSelect.value = currentYearValue;
                }
            }
            
            // Aylık hedef mağaza dropdown
            const monthStoreSelect = document.getElementById('targetMonthStore');
            if (monthStoreSelect) {
                const currentMonthValue = monthStoreSelect.value; // Mevcut seçimi koru
                monthStoreSelect.innerHTML = '<option value="TÜM MAĞAZALAR">🏢 Tüm Mağazalar</option>';
                sortedStores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store;
                    option.textContent = store;
                    monthStoreSelect.appendChild(option);
                });
                // Mevcut seçimi geri yükle
                if (currentMonthValue && sortedStores.includes(currentMonthValue)) {
                    monthStoreSelect.value = currentMonthValue;
                }
            }
            
            console.log('🏪 Hedef takip mağaza dropdownları dolduruldu:', stores.size, 'mağaza');
        }
        
        function analyzeCityPerformance() {
            const selectedCity = document.getElementById('citySelect').value;
            
            if (!selectedCity) {
                document.getElementById('cityAnalysisContainer').style.display = 'none';
                return;
            }
            
            console.log('🌍 Şehir analizi:', selectedCity);
            
            // Şehir verilerini filtrele
            const cityData = allData.filter(item => item.city === selectedCity);
            
            if (cityData.length === 0) {
                alert('Bu şehir için veri bulunamadı');
                return;
            }
            
            // Özet bilgileri hesapla
            const totalSales = cityData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = cityData.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const uniqueCustomers = new Set(cityData.map(item => item.partner)).size;
            const uniqueDates = new Set(cityData.map(item => item.date)).size;
            const avgBasket = totalSales / Math.max(uniqueDates, 1);
            
            // En çok satış yapan temsilci
            const salespersonData = {};
            cityData.forEach(item => {
                const salesperson = item.sales_person || 'Bilinmiyor';
                if (!salespersonData[salesperson]) salespersonData[salesperson] = 0;
                salespersonData[salesperson] += parseFloat(item.usd_amount || 0);
            });
            const topSalesperson = Object.entries(salespersonData).sort((a, b) => b[1] - a[1])[0];
            
            // En çok satış yapan mağaza
            const storeData = {};
            cityData.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) storeData[store] = 0;
                storeData[store] += parseFloat(item.usd_amount || 0);
            });
            const topStore = Object.entries(storeData).sort((a, b) => b[1] - a[1])[0];
            
            // UI güncelle
            document.getElementById('cityTotalSales').textContent = '$' + totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('cityTotalQty').textContent = totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('cityCustomerCount').textContent = uniqueCustomers;
            document.getElementById('cityAvgBasket').textContent = '$' + avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            
            // Temsilci ve mağaza
            if (topSalesperson) {
                document.getElementById('cityTopSalesperson').textContent = topSalesperson[0];
                document.getElementById('cityTopSalespersonAmount').textContent = '$' + topSalesperson[1].toLocaleString('tr-TR', {minimumFractionDigits: 2});
            }
            if (topStore) {
                document.getElementById('cityTopStore').textContent = topStore[0];
                document.getElementById('cityTopStoreAmount').textContent = '$' + topStore[1].toLocaleString('tr-TR', {minimumFractionDigits: 2});
            }
            
            // Container'ı göster
            document.getElementById('cityAnalysisContainer').style.display = 'block';
            
            // Grafikleri render et
            renderCityBrandChart(cityData);
            renderCityProductChart(cityData);
            renderCityCategoryChart(cityData);
            renderCityMonthlyChart(cityData);
            
            // AI analiz
            performCityAIAnalysis(cityData, selectedCity, {totalSales, totalQty, uniqueCustomers, avgBasket});
        }
        
        function renderCityBrandChart(data) {
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = {sales: 0, qty: 0};
                brandData[brand].sales += parseFloat(item.usd_amount || 0);
                brandData[brand].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(brandData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('cityBrandChart');
            if (!ctx) return;
            
            if (cityBrandChartInstance) {
                cityBrandChartInstance.destroy();
            }
            
            cityBrandChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satış (USD)',
                        data: salesValues,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'}
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function renderCityProductChart(data) {
            const productData = {};
            data.forEach(item => {
                const product = item.product || 'Bilinmiyor';
                if (!productData[product]) productData[product] = {sales: 0, qty: 0};
                productData[product].sales += parseFloat(item.usd_amount || 0);
                productData[product].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(productData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0].substring(0, 30) + (item[0].length > 30 ? '...' : ''));
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('cityProductChart');
            if (!ctx) return;
            
            if (cityProductChartInstance) {
                cityProductChartInstance.destroy();
            }
            
            cityProductChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satış (USD)',
                        data: salesValues,
                        backgroundColor: 'rgba(56, 239, 125, 0.6)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'}
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function renderCityCategoryChart(data) {
            const categoryData = {};
            data.forEach(item => {
                const category = item.category_1 || 'Bilinmiyor';
                if (!categoryData[category]) categoryData[category] = {sales: 0, qty: 0};
                categoryData[category].sales += parseFloat(item.usd_amount || 0);
                categoryData[category].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(categoryData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('cityCategoryChart');
            if (!ctx) return;
            
            if (cityCategoryChartInstance) {
                cityCategoryChartInstance.destroy();
            }
            
            cityCategoryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satış (USD)',
                        data: salesValues,
                        backgroundColor: 'rgba(245, 87, 108, 0.6)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'}
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function renderCityMonthlyChart(data) {
            const monthlyData = {};
            data.forEach(item => {
                const date = new Date(item.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[monthKey]) monthlyData[monthKey] = 0;
                monthlyData[monthKey] += parseFloat(item.usd_amount || 0);
            });
            
            const sorted = Object.entries(monthlyData).sort((a, b) => a[0].localeCompare(b[0]));
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1]);
            
            const ctx = document.getElementById('cityMonthlyChart');
            if (!ctx) return;
            
            if (cityMonthlyChartInstance) {
                cityMonthlyChartInstance.destroy();
            }
            
            cityMonthlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Aylık Satış (USD)',
                        data: values,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function performCityAIAnalysis(data, cityName, stats) {
            console.log('🤖 Şehir AI analizi başlatılıyor...');
            
            // Marka analizi
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += parseFloat(item.usd_amount || 0);
            });
            const topBrands = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 3);
            
            // Kategori analizi
            const categoryData = {};
            data.forEach(item => {
                const category = item.category_1 || 'Bilinmiyor';
                if (!categoryData[category]) categoryData[category] = 0;
                categoryData[category] += parseFloat(item.usd_amount || 0);
            });
            const topCategories = Object.entries(categoryData).sort((a, b) => b[1] - a[1]).slice(0, 3);
            
            const insights = {
                positive: [],
                negative: [],
                neutral: [],
                recommendations: []
            };
            
            // Pozitif içgörüler
            if (topBrands.length > 0) {
                const topBrand = topBrands[0];
                const brandShare = (topBrand[1] / stats.totalSales * 100).toFixed(1);
                insights.positive.push({
                    title: `🏷️ ${topBrand[0]} Lider Marka`,
                    description: `${cityName} ilinde ${topBrand[0]} markası %${brandShare} pay ile lider ($${topBrand[1].toLocaleString('tr-TR', {minimumFractionDigits: 2})}).`
                });
            }
            
            if (topCategories.length > 0) {
                const topCategory = topCategories[0];
                const catShare = (topCategory[1] / stats.totalSales * 100).toFixed(1);
                insights.positive.push({
                    title: `📂 ${topCategory[0]} En Popüler Kategori`,
                    description: `${cityName} ilinde ${topCategory[0]} kategorisi %${catShare} pay ile en çok tercih edilen ($${topCategory[1].toLocaleString('tr-TR', {minimumFractionDigits: 2})}).`
                });
            }
            
            // Nötr bilgiler
            insights.neutral.push({
                title: `📊 ${cityName} Genel Performans`,
                description: `Toplam ${stats.uniqueCustomers} müşteri, $${stats.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} satış gerçekleştirdi. Ortalama sepet değeri $${stats.avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2})}.`
            });
            
            if (topBrands.length >= 3) {
                insights.neutral.push({
                    title: `🏷️ Top 3 Marka`,
                    description: `${topBrands.map(b => b[0]).join(', ')} markaları ${cityName} ilinde en çok tercih ediliyor.`
                });
            }
            
            // Öneriler
            insights.recommendations.push({
                icon: '📦',
                title: 'Stok Optimizasyonu',
                description: `${cityName} ilindeki mağazalarda ${topBrands[0][0]} markası ve ${topCategories[0][0]} kategorisi ürünlerinin stok seviyesini artırın.`
            });
            
            insights.recommendations.push({
                icon: '📢',
                title: 'Bölgesel Kampanya',
                description: `${cityName} ili için ${topBrands[0][0]} markasında özel kampanya düzenleyin. Bu bölgede yüksek talep var.`
            });
            
            insights.recommendations.push({
                icon: '🎯',
                title: 'Müşteri Segmentasyonu',
                description: `${cityName} ilindeki ${stats.uniqueCustomers} müşteriye özel e-posta kampanyaları gönderin. Tercih ettikleri kategorilerdeki yeni ürünleri tanıtın.`
            });
            
            // HTML oluştur
            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">
                    ${insights.positive.length > 0 ? `
                    <div class="analysis-section">
                        <h3 style="color: white; margin-top: 0;">✅ ${cityName} Güçlü Yönler</h3>
                        ${insights.positive.map(item => `
                            <div class="insight-item insight-positive" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">✅</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.neutral.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">💡 Genel Bilgiler</h3>
                        ${insights.neutral.map(item => `
                            <div class="insight-item insight-neutral" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">💡</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">🎯 Aksiyon Önerileri</h3>
                        ${insights.recommendations.map(item => `
                            <div class="recommendation" style="background: rgba(255, 255, 255, 0.15); padding: 18px; border-radius: 10px; margin: 12px 0;">
                                <span class="recommendation-icon" style="font-size: 1.8em; margin-right: 12px;">${item.icon}</span>
                                <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px);">
                                    <strong style="font-size: 1.15em; display: block; margin-bottom: 8px;">${item.title}</strong>
                                    <p style="margin: 0; opacity: 0.95; line-height: 1.6;">${item.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('cityAIAnalysisContent').innerHTML = html;
        }
        
        // ==================== STOCK DISTRIBUTION TAB ====================
        let stockList = [];  // {product_code: string, qty: number}
        
        function handleStockExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Boyut kontrolü (5 MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Dosya çok büyük! Maksimum 5 MB olmalıdır.');
                return;
            }
            
            // Tip kontrolü
            const validTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-excel'
            ];
            if (!validTypes.includes(file.type)) {
                alert('Sadece Excel dosyaları (.xlsx, .xls) yükleyebilirsiniz.');
                return;
            }
            
            console.log('📄 Excel dosyası okunuyor...');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    
                    console.log('📊 Excel verisi:', json);
                    
                    // Veriyi işle
                    stockList = [];
                    json.forEach(row => {
                        // Farklı kolon isimleri için esnek yaklaşım
                        const productCode = row['Ürün Kodu'] || row['product_code'] || row['Product Code'] || row['Kod'] || row['Code'];
                        const qty = row['Stok Miktarı'] || row['stock'] || row['Stock'] || row['Miktar'] || row['Quantity'] || row['qty'];
                        
                        if (productCode && qty) {
                            stockList.push({
                                product_code: String(productCode).trim(),
                                qty: parseFloat(qty)
                            });
                        }
                    });
                    
                    if (stockList.length === 0) {
                        alert('Excel dosyasında geçerli veri bulunamadı! Kolon isimleri: "Ürün Kodu" ve "Stok Miktarı" olmalı.');
                        return;
                    }
                    
                    console.log('✅ Stok listesi yüklendi:', stockList.length, 'ürün');
                    renderStockList();
                    
                } catch (error) {
                    console.error('❌ Excel okuma hatası:', error);
                    alert('Excel dosyası okunamadı! Lütfen dosya formatını kontrol edin.');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function addManualStock() {
            const productCode = document.getElementById('manualProductCode').value.trim();
            const qty = parseFloat(document.getElementById('manualStockQty').value);
            
            if (!productCode) {
                alert('Lütfen ürün kodu girin');
                return;
            }
            
            if (isNaN(qty) || qty <= 0) {
                alert('Lütfen geçerli bir stok miktarı girin');
                return;
            }
            
            // Aynı ürün varsa güncelle
            const existingIndex = stockList.findIndex(item => item.product_code === productCode);
            if (existingIndex >= 0) {
                stockList[existingIndex].qty = qty;
            } else {
                stockList.push({product_code: productCode, qty: qty});
            }
            
            // Inputları temizle
            document.getElementById('manualProductCode').value = '';
            document.getElementById('manualStockQty').value = '';
            
            console.log('✅ Stok eklendi:', productCode, qty);
            renderStockList();
        }
        
        function renderStockList() {
            if (stockList.length === 0) {
                document.getElementById('stockListContainer').style.display = 'none';
                return;
            }
            
            document.getElementById('stockListContainer').style.display = 'block';
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left;">#</th>
                            <th style="padding: 15px; text-align: left;">Ürün Kodu</th>
                            <th style="padding: 15px; text-align: right;">Stok Miktarı</th>
                            <th style="padding: 15px; text-align: center;">İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            stockList.forEach((item, index) => {
                html += `
                    <tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                        <td style="padding: 12px;">${index + 1}</td>
                        <td style="padding: 12px;"><strong>${item.product_code}</strong></td>
                        <td style="padding: 12px; text-align: right;">${item.qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="removeStock(${index})" style="background: #dc3545; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">
                                🗑️ Sil
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('stockListTable').innerHTML = html;
        }
        
        function removeStock(index) {
            stockList.splice(index, 1);
            renderStockList();
        }
        
        function clearStockList() {
            if (confirm('Tüm stok listesini temizlemek istediğinize emin misiniz?')) {
                stockList = [];
                renderStockList();
                document.getElementById('stockDistributionResults').style.display = 'none';
            }
        }
        
        function analyzeStockDistribution() {
            if (stockList.length === 0) {
                alert('Önce stok listesi yükleyin veya manuel giriş yapın');
                return;
            }
            
            console.log('🤖 AI stok dağılım analizi başlatılıyor...');
            
            const recommendations = [];
            
            stockList.forEach(stockItem => {
                // Bu ürün kodunu içeren satışları bul
                const productSales = allData.filter(item => 
                    item.product && item.product.toLowerCase().includes(stockItem.product_code.toLowerCase())
                );
                
                if (productSales.length === 0) {
                    recommendations.push({
                        productCode: stockItem.product_code,
                        totalStock: stockItem.qty,
                        distribution: [],
                        message: `⚠️ "${stockItem.product_code}" için geçmiş satış verisi bulunamadı. Eşit dağılım öneriliyor.`,
                        noData: true
                    });
                    return;
                }
                
                // Mağaza bazında satış analizi (son 3 ay)
                const storePerformance = {};
                productSales.forEach(item => {
                    const store = item.store || 'Bilinmiyor';
                    if (!storePerformance[store]) {
                        storePerformance[store] = {qty: 0, sales: 0};
                    }
                    storePerformance[store].qty += parseFloat(item.quantity || 0);
                    storePerformance[store].sales += parseFloat(item.usd_amount || 0);
                });
                
                // Toplam satış
                const totalSold = Object.values(storePerformance).reduce((sum, s) => sum + s.qty, 0);
                
                // Yüzde dağılım hesapla
                const distribution = [];
                Object.entries(storePerformance).forEach(([store, data]) => {
                    const percentage = data.qty / totalSold;
                    const recommendedQty = Math.round(stockItem.qty * percentage);
                    distribution.push({
                        store: store,
                        historicalQty: data.qty,
                        historicalSales: data.sales,
                        percentage: (percentage * 100).toFixed(1),
                        recommendedQty: recommendedQty
                    });
                });
                
                // Büyükten küçüğe sırala
                distribution.sort((a, b) => b.recommendedQty - a.recommendedQty);
                
                recommendations.push({
                    productCode: stockItem.product_code,
                    totalStock: stockItem.qty,
                    distribution: distribution,
                    message: `✅ "${stockItem.product_code}" için ${distribution.length} mağazaya dağılım önerisi hazırlandı.`,
                    noData: false
                });
            });
            
            // Sonuçları göster
            renderStockDistributionResults(recommendations);
        }
        
        function renderStockDistributionResults(recommendations) {
            document.getElementById('stockDistributionResults').style.display = 'block';
            
            let html = '';
            
            recommendations.forEach((rec, index) => {
                html += `
                    <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
                        <h3 style="margin: 0 0 20px 0; color: #667eea;">
                            ${index + 1}. ${rec.productCode} (Toplam Stok: ${rec.totalStock.toLocaleString('tr-TR', {minimumFractionDigits: 2})} adet)
                        </h3>
                        <p style="color: #6c757d; margin-bottom: 20px;">${rec.message}</p>
                        
                        ${rec.noData ? `
                            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107;">
                                <strong>💡 Öneri:</strong> Geçmiş satış verisi olmadığı için mağazalara eşit dağıtım yapabilirsiniz.
                            </div>
                        ` : `
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Mağaza</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Geçmiş Satış</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Pay (%)</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Önerilen Stok</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rec.distribution.map((dist, i) => `
                                        <tr style="border-bottom: 1px solid #eee; ${i % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                                            <td style="padding: 12px;"><strong>${dist.store}</strong></td>
                                            <td style="padding: 12px; text-align: right;">${dist.historicalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2})} adet</td>
                                            <td style="padding: 12px; text-align: right; color: #667eea; font-weight: bold;">${dist.percentage}%</td>
                                            <td style="padding: 12px; text-align: right; color: #38ef7d; font-weight: bold; font-size: 1.1em;">${dist.recommendedQty} adet</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            
                            <div style="background: #d1ecf1; padding: 20px; border-radius: 10px; border-left: 4px solid #0c5460; margin-top: 20px;">
                                <strong>🤖 AI Öneri:</strong> Bu dağılım, geçmiş satış performansına göre optimize edilmiştir. 
                                En yüksek satış yapan mağazalara daha fazla stok ayrılmıştır.
                            </div>
                        `}
                    </div>
                `;
            });
            
            document.getElementById('stockDistributionContent').innerHTML = html;
            
            // Sonuçlara scroll
            document.getElementById('stockDistributionResults').scrollIntoView({behavior: 'smooth', block: 'start'});
        }
        
        // ==================== SALESPERSON ANALYSIS TAB ====================
        let salespersonBrandChartInstance = null;
        let salespersonCategoryChartInstance = null;
        let salespersonStoreChartInstance = null;
        let salespersonMonthlyChartInstance = null;
        
        function searchSalespersonProfile() {
            const searchQuery = document.getElementById('salespersonSearchInput').value.trim().toLowerCase();
            
            if (!searchQuery) {
                alert('Lütfen bir satış temsilcisi adı girin');
                return;
            }
            
            console.log('🔍 Satış temsilcisi aranıyor:', searchQuery);
            
            // Temsilci verilerini filtrele (fuzzy matching)
            const salespersonData = allData.filter(item => 
                item.sales_person && item.sales_person.toLowerCase().includes(searchQuery)
            );
            
            if (salespersonData.length === 0) {
                document.getElementById('salespersonProfileContainer').style.display = 'none';
                document.getElementById('salespersonSearchNoResults').style.display = 'block';
                return;
            }
            
            // Sonuçları göster
            document.getElementById('salespersonSearchNoResults').style.display = 'none';
            document.getElementById('salespersonProfileContainer').style.display = 'block';
            
            // Temsilci bilgilerini hesapla
            const salespersonName = salespersonData[0].sales_person;
            
            const totalSales = salespersonData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = salespersonData.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const uniqueDates = new Set(salespersonData.map(item => item.date));
            const transactionCount = uniqueDates.size;
            const avgTransaction = totalSales / Math.max(transactionCount, 1);
            const uniqueCustomers = new Set(salespersonData.map(item => item.partner)).size;
            const uniqueProducts = new Set(salespersonData.map(item => item.product)).size;
            
            // UI güncelle
            document.getElementById('salespersonName').textContent = salespersonName;
            document.getElementById('salespersonTotalSales').textContent = '$' + totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('salespersonTotalQty').textContent = totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('salespersonTransactionCount').textContent = transactionCount;
            document.getElementById('salespersonAvgTransaction').textContent = '$' + avgTransaction.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('salespersonUniqueCustomers').textContent = uniqueCustomers;
            document.getElementById('salespersonUniqueProducts').textContent = uniqueProducts;
            
            // Grafikleri render et
            renderSalespersonBrandChart(salespersonData);
            renderSalespersonCategoryChart(salespersonData);
            renderSalespersonStoreChart(salespersonData);
            renderSalespersonMonthlyChart(salespersonData);
            
            // Veriyi kaydet (sıralama için)
            lastSalespersonTopProductsData = salespersonData;
            
            // Top 20 ve Bottom 10 ürünler
            renderSalespersonTopProducts(salespersonData);
            renderSalespersonBottomProducts(salespersonData);
            
            // AI analiz
            performSalespersonAIAnalysis(salespersonData, {
                name: salespersonName,
                totalSales,
                totalQty,
                transactionCount,
                avgTransaction,
                uniqueCustomers,
                uniqueProducts
            });
        }
        
        function renderSalespersonBrandChart(data) {
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = {sales: 0, qty: 0};
                brandData[brand].sales += parseFloat(item.usd_amount || 0);
                brandData[brand].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(brandData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('salespersonBrandChart');
            if (!ctx) return;
            
            if (salespersonBrandChartInstance) {
                salespersonBrandChartInstance.destroy();
            }
            
            salespersonBrandChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satış (USD)',
                        data: salesValues,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'}
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function renderSalespersonCategoryChart(data) {
            const categoryData = {};
            data.forEach(item => {
                const category = item.category_1 || 'Bilinmiyor';
                if (!categoryData[category]) categoryData[category] = {sales: 0, qty: 0};
                categoryData[category].sales += parseFloat(item.usd_amount || 0);
                categoryData[category].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(categoryData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('salespersonCategoryChart');
            if (!ctx) return;
            
            if (salespersonCategoryChartInstance) {
                salespersonCategoryChartInstance.destroy();
            }
            
            salespersonCategoryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satış (USD)',
                        data: salesValues,
                        backgroundColor: 'rgba(56, 239, 125, 0.6)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'}
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function renderSalespersonStoreChart(data) {
            const storeData = {};
            data.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) storeData[store] = {sales: 0, qty: 0};
                storeData[store].sales += parseFloat(item.usd_amount || 0);
                storeData[store].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(storeData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('salespersonStoreChart');
            if (!ctx) return;
            
            if (salespersonStoreChartInstance) {
                salespersonStoreChartInstance.destroy();
            }
            
            salespersonStoreChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satış (USD)',
                        data: salesValues,
                        backgroundColor: 'rgba(245, 87, 108, 0.6)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'}
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function renderSalespersonMonthlyChart(data) {
            const monthlyData = {};
            data.forEach(item => {
                const date = new Date(item.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[monthKey]) monthlyData[monthKey] = 0;
                monthlyData[monthKey] += parseFloat(item.usd_amount || 0);
            });
            
            const sorted = Object.entries(monthlyData).sort((a, b) => a[0].localeCompare(b[0]));
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1]);
            
            const ctx = document.getElementById('salespersonMonthlyChart');
            if (!ctx) return;
            
            if (salespersonMonthlyChartInstance) {
                salespersonMonthlyChartInstance.destroy();
            }
            
            salespersonMonthlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Aylık Satış (USD)',
                        data: values,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderSalespersonTopProducts(data = null, sortColumn = null, sortDirection = null) {
            // Eğer data null ise, mevcut veriyi kullan
            if (data === null && lastSalespersonTopProductsData) {
                data = lastSalespersonTopProductsData;
            }
            
            if (!data || data.length === 0) {
                document.getElementById('salespersonTopProductsTable').innerHTML = '<p style="text-align: center; padding: 20px;">Veri bulunamadı</p>';
                return;
            }
            
            // Sıralama parametrelerini güncelle
            if (sortColumn !== null) {
                if (currentSalespersonSortColumn === sortColumn) {
                    currentSalespersonSortDirection = currentSalespersonSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSalespersonSortColumn = sortColumn;
                    currentSalespersonSortDirection = 'desc';
                }
            }
            
            // Ürün bazında grupla
            const productData = {};
            data.forEach(item => {
                const product = item.product || 'Bilinmiyor';
                if (!productData[product]) {
                    productData[product] = {
                        brand: item.brand || 'Bilinmiyor',
                        category: item.category_1 || 'Bilinmiyor',
                        sales: 0,
                        qty: 0,
                        count: 0
                    };
                }
                productData[product].sales += parseFloat(item.usd_amount || 0);
                productData[product].qty += parseFloat(item.quantity || 0);
                productData[product].count += 1;
            });
            
            // Sıralama
            let sorted = Object.entries(productData);
            
            if (currentSalespersonSortColumn === 'product') {
                sorted.sort((a, b) => {
                    return currentSalespersonSortDirection === 'asc' 
                        ? a[0].localeCompare(b[0], 'tr')
                        : b[0].localeCompare(a[0], 'tr');
                });
            } else if (currentSalespersonSortColumn === 'brand') {
                sorted.sort((a, b) => {
                    return currentSalespersonSortDirection === 'asc'
                        ? a[1].brand.localeCompare(b[1].brand, 'tr')
                        : b[1].brand.localeCompare(a[1].brand, 'tr');
                });
            } else if (currentSalespersonSortColumn === 'category') {
                sorted.sort((a, b) => {
                    return currentSalespersonSortDirection === 'asc'
                        ? a[1].category.localeCompare(b[1].category, 'tr')
                        : b[1].category.localeCompare(a[1].category, 'tr');
                });
            } else if (currentSalespersonSortColumn === 'sales') {
                sorted.sort((a, b) => {
                    return currentSalespersonSortDirection === 'asc'
                        ? a[1].sales - b[1].sales
                        : b[1].sales - a[1].sales;
                });
            } else if (currentSalespersonSortColumn === 'qty') {
                sorted.sort((a, b) => {
                    return currentSalespersonSortDirection === 'asc'
                        ? a[1].qty - b[1].qty
                        : b[1].qty - a[1].qty;
                });
            } else if (currentSalespersonSortColumn === 'count') {
                sorted.sort((a, b) => {
                    return currentSalespersonSortDirection === 'asc'
                        ? a[1].count - b[1].count
                        : b[1].count - a[1].count;
                });
            }
            
            // Top 20
            sorted = sorted.slice(0, 20);
            
            const getSortIcon = (column) => {
                if (currentSalespersonSortColumn !== column) return '⇅';
                return currentSalespersonSortDirection === 'asc' ? '↑' : '↓';
            };
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left;">#</th>
                            <th style="padding: 15px; text-align: left; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'product')">
                                Ürün ${getSortIcon('product')}
                            </th>
                            <th style="padding: 15px; text-align: left; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'brand')">
                                Marka ${getSortIcon('brand')}
                            </th>
                            <th style="padding: 15px; text-align: left; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'category')">
                                Kategori ${getSortIcon('category')}
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'sales')">
                                Satış (USD) ${getSortIcon('sales')}
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'qty')">
                                Miktar ${getSortIcon('qty')}
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'count')">
                                İşlem ${getSortIcon('count')}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sorted.forEach((item, index) => {
                const product = item[0];
                const stats = item[1];
                
                html += `
                    <tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                        <td style="padding: 12px;">${index + 1}</td>
                        <td style="padding: 12px;"><strong>${product}</strong></td>
                        <td style="padding: 12px;">${stats.brand}</td>
                        <td style="padding: 12px;">${stats.category}</td>
                        <td style="padding: 12px; text-align: right; color: #38ef7d; font-weight: bold;">$${stats.sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right;">${stats.qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right;">${stats.count}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('salespersonTopProductsTable').innerHTML = html;
        }
        
        function renderSalespersonBottomProducts(data) {
            // Ürün bazında grupla
            const productData = {};
            data.forEach(item => {
                const product = item.product || 'Bilinmiyor';
                if (!productData[product]) {
                    productData[product] = {
                        brand: item.brand || 'Bilinmiyor',
                        category: item.category_1 || 'Bilinmiyor',
                        sales: 0,
                        qty: 0,
                        count: 0
                    };
                }
                productData[product].sales += parseFloat(item.usd_amount || 0);
                productData[product].qty += parseFloat(item.quantity || 0);
                productData[product].count += 1;
            });
            
            // Bottom 10 (en az satan)
            const sorted = Object.entries(productData).sort((a, b) => a[1].sales - b[1].sales).slice(0, 10);
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left;">#</th>
                            <th style="padding: 15px; text-align: left;">Ürün</th>
                            <th style="padding: 15px; text-align: left;">Marka</th>
                            <th style="padding: 15px; text-align: left;">Kategori</th>
                            <th style="padding: 15px; text-align: right;">Satış (USD)</th>
                            <th style="padding: 15px; text-align: right;">Miktar</th>
                            <th style="padding: 15px; text-align: right;">İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sorted.forEach((item, index) => {
                const product = item[0];
                const stats = item[1];
                
                html += `
                    <tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: #fff3cd;' : 'background: #ffe5e5;'}">
                        <td style="padding: 12px;">${index + 1}</td>
                        <td style="padding: 12px;"><strong>${product}</strong></td>
                        <td style="padding: 12px;">${stats.brand}</td>
                        <td style="padding: 12px;">${stats.category}</td>
                        <td style="padding: 12px; text-align: right; color: #f5576c; font-weight: bold;">$${stats.sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right;">${stats.qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right;">${stats.count}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('salespersonBottomProductsTable').innerHTML = html;
        }
        
        function performSalespersonAIAnalysis(data, profile) {
            console.log('🤖 Satış temsilcisi AI analizi başlatılıyor...');
            
            // Marka analizi
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += parseFloat(item.usd_amount || 0);
            });
            const topBrands = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 3);
            const bottomBrands = Object.entries(brandData).sort((a, b) => a[1] - b[1]).slice(0, 3);
            
            // Kategori analizi
            const categoryData = {};
            data.forEach(item => {
                const category = item.category_1 || 'Bilinmiyor';
                if (!categoryData[category]) categoryData[category] = 0;
                categoryData[category] += parseFloat(item.usd_amount || 0);
            });
            const topCategories = Object.entries(categoryData).sort((a, b) => b[1] - a[1]).slice(0, 3);
            const bottomCategories = Object.entries(categoryData).sort((a, b) => a[1] - b[1]).slice(0, 3);
            
            const insights = {
                positive: [],
                negative: [],
                neutral: [],
                recommendations: []
            };
            
            // Pozitif içgörüler
            if (profile.totalSales > 100000) {
                insights.positive.push({
                    title: '🏆 Yüksek Performans',
                    description: `${profile.name} toplam $${profile.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} satış gerçekleştirmiş. Bu, çok başarılı bir performans göstergesi.`
                });
            }
            
            if (topBrands.length > 0) {
                const topBrand = topBrands[0];
                const brandShare = (topBrand[1] / profile.totalSales * 100).toFixed(1);
                insights.positive.push({
                    title: `🏷️ ${topBrand[0]} Markasında Uzman`,
                    description: `${topBrand[0]} markasında %${brandShare} pay ile güçlü ($${topBrand[1].toLocaleString('tr-TR', {minimumFractionDigits: 2})}). Bu markadaki ürünleri çok iyi biliyor.`
                });
            }
            
            if (topCategories.length > 0) {
                const topCat = topCategories[0];
                const catShare = (topCat[1] / profile.totalSales * 100).toFixed(1);
                insights.positive.push({
                    title: `📂 ${topCat[0]} Kategorisinde Başarılı`,
                    description: `${topCat[0]} kategorisinde %${catShare} pay ile lider ($${topCat[1].toLocaleString('tr-TR', {minimumFractionDigits: 2})}). Bu kategorideki ürünleri etkili satıyor.`
                });
            }
            
            // Negatif içgörüler (Gelişim alanları)
            if (bottomBrands.length > 0 && bottomBrands[0][1] < profile.totalSales * 0.05) {
                insights.negative.push({
                    title: `⚠️ ${bottomBrands[0][0]} Markasında Zayıf`,
                    description: `${bottomBrands[0][0]} markasında sadece $${bottomBrands[0][1].toLocaleString('tr-TR', {minimumFractionDigits: 2})} satış var. Bu markada eğitim gerekebilir.`
                });
            }
            
            if (bottomCategories.length > 0 && bottomCategories[0][1] < profile.totalSales * 0.05) {
                insights.negative.push({
                    title: `⚠️ ${bottomCategories[0][0]} Kategorisinde Gelişim Alanı`,
                    description: `${bottomCategories[0][0]} kategorisinde sadece $${bottomCategories[0][1].toLocaleString('tr-TR', {minimumFractionDigits: 2})} satış var. Bu kategoride potansiyel artış fırsatı.`
                });
            }
            
            if (profile.uniqueCustomers < 50) {
                insights.negative.push({
                    title: '👥 Müşteri Portföyü Dar',
                    description: `Sadece ${profile.uniqueCustomers} farklı müşteri ile çalışılmış. Yeni müşteri kazanımına odaklanılmalı.`
                });
            }
            
            // Nötr bilgiler
            insights.neutral.push({
                title: '📊 Genel Performans',
                description: `${profile.uniqueProducts} farklı ürün, ${profile.uniqueCustomers} farklı müşteriye satıldı. Ortalama işlem değeri $${profile.avgTransaction.toLocaleString('tr-TR', {minimumFractionDigits: 2})}.`
            });
            
            if (topBrands.length >= 3) {
                insights.neutral.push({
                    title: '🏷️ Marka Çeşitliliği',
                    description: `En çok satılan markalar: ${topBrands.map(b => b[0]).join(', ')}. Bu markalarda yoğunlaşma var.`
                });
            }
            
            // Öneriler
            insights.recommendations.push({
                icon: '📚',
                title: 'Ürün Eğitimi',
                description: `${bottomBrands[0][0]} ve ${bottomCategories[0][0]} konularında ürün eğitimi almalı. Bu alanlardaki bilgi eksikliği satışları etkiliyor olabilir.`
            });
            
            insights.recommendations.push({
                icon: '🎯',
                title: 'Hedef Belirleme',
                description: `${topBrands[0][0]} markasındaki başarıyı diğer markalara da taşımak için aylık hedefler belirleyin. Cross-selling fırsatlarını değerlendirin.`
            });
            
            insights.recommendations.push({
                icon: '👥',
                title: 'Müşteri Geliştirme',
                description: `Mevcut ${profile.uniqueCustomers} müşteriye ek olarak yeni müşteri kazanımı için aktif çalışma yapılmalı. Referans sistemi kullanılabilir.`
            });
            
            if (profile.avgTransaction > 1000) {
                insights.recommendations.push({
                    icon: '💎',
                    title: 'Premium Ürün Odağı',
                    description: `Ortalama işlem değeri yüksek ($${profile.avgTransaction.toLocaleString('tr-TR', {minimumFractionDigits: 2})}). Premium ürünlerde uzmanlaşma fırsatı var.`
                });
            }
            
            // HTML oluştur
            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">
                    ${insights.positive.length > 0 ? `
                    <div class="analysis-section">
                        <h3 style="color: white; margin-top: 0;">✅ Güçlü Yönler</h3>
                        ${insights.positive.map(item => `
                            <div class="insight-item insight-positive" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">✅</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.negative.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">⚠️ Gelişim Alanları</h3>
                        ${insights.negative.map(item => `
                            <div class="insight-item insight-negative" style="background: rgba(245, 87, 108, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #f5576c;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">⚠️</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.neutral.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">💡 Genel Bilgiler</h3>
                        ${insights.neutral.map(item => `
                            <div class="insight-item insight-neutral" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">💡</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">🎯 Gelişim Önerileri</h3>
                        ${insights.recommendations.map(item => `
                            <div class="recommendation" style="background: rgba(255, 255, 255, 0.15); padding: 18px; border-radius: 10px; margin: 12px 0;">
                                <span class="recommendation-icon" style="font-size: 1.8em; margin-right: 12px;">${item.icon}</span>
                                <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px);">
                                    <strong style="font-size: 1.15em; display: block; margin-bottom: 8px;">${item.title}</strong>
                                    <p style="margin: 0; opacity: 0.95; line-height: 1.6;">${item.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('salespersonAIAnalysisContent').innerHTML = html;
        }
        
        // ==================== MOBİL: TABLE SCROLL HINT ==================== 
        // Tablolar ilk kaydırıldığında "← Kaydırın →" mesajını gizle
        function initMobileTableScrollHint() {
            if (window.innerWidth <= 768) {
                const tables = document.querySelectorAll('table');
                tables.forEach(table => {
                    table.addEventListener('scroll', function() {
                        this.classList.add('scrolled');
                    }, { once: true });
                });
            }
        }
        
        // Sayfa yüklendiğinde ve tab değiştiğinde çalıştır
        document.addEventListener('DOMContentLoaded', function() {
            initMobileTableScrollHint();
            
            // Tab değişimlerinde de çalıştır
            const observer = new MutationObserver(function() {
                initMobileTableScrollHint();
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });
        
    </script>
</body>
</html>

