<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zuhal M√ºzik Raporlama</title>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üìä</text></svg>">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <!-- Pako.js for GZIP Decompression (Fallback) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>
    <!-- SheetJS for Excel Export -->
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <!-- Chart.js for Graphs -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script>
    <!-- CryptoJS for encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- Performance Optimizer -->
    <script defer src="js/performance-optimizer.js"></script>
    <!-- Enhanced AI Analyzer -->
    <script defer src="js/ai-analyzer-enhanced.js"></script>
    <!-- Enhanced Time Analysis -->
    <script defer src="js/time-analysis-enhanced.js"></script>
    <!-- Email Servisi Konfig√ºrasyonu -->
    <script>
        // ===== GLOBAL AUTHENTICATION FUNCTIONS =====
        // Bu fonksiyonlar sayfa y√ºklenir y√ºklenmez tanƒ±mlanƒ±r
        window.showDashboardAfterAuth = function(user) {
            const authForm = document.getElementById('authForm');
            const otpForm = document.getElementById('otpForm');
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContainer = document.getElementById('mainContainer');
            
            if (authForm) authForm.style.display = 'none';
            if (otpForm) otpForm.style.display = 'none';
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (mainContainer) mainContainer.style.display = 'block';
            
            // Kullanƒ±cƒ± bilgilerini g√ºncelle
            window.updateUserInfo(user);
            
            // Dashboard'ƒ± y√ºkle
            if (typeof window.loadData === 'function') {
                window.loadData();
            } else {
                console.log('‚ö†Ô∏è loadData fonksiyonu hen√ºz y√ºklenmedi, 2 saniye bekleniyor...');
                setTimeout(() => {
                    if (typeof window.loadData === 'function') {
                        window.loadData();
                    } else {
                        console.error('‚ùå loadData fonksiyonu bulunamadƒ±!');
                    }
                }, 2000);
            }
        };
        
        window.updateUserInfo = function(user) {
            const userNameElement = document.getElementById('currentUserName');
            const userInfoElement = document.getElementById('userInfo');
            const userTypeElement = document.getElementById('userType');
            
            if (userNameElement) {
                userNameElement.textContent = user.name || user.email?.split('@')[0] || 'Kullanƒ±cƒ±';
            }
            
            if (userInfoElement) {
                userInfoElement.textContent = user.name || user.email?.split('@')[0] || 'Kullanƒ±cƒ±';
            }
            
            if (userTypeElement) {
                userTypeElement.textContent = 'üë§ Kullanƒ±cƒ±';
            }
        };
        
        window.showAuthForm = function() {
            const authForm = document.getElementById('authForm');
            const otpForm = document.getElementById('otpForm');
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContainer = document.getElementById('mainContainer');
            
            if (authForm) authForm.style.display = 'flex';
            if (otpForm) otpForm.style.display = 'none';
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (mainContainer) mainContainer.style.display = 'none';
        };
        
        window.showOTPForm = function(email) {
            const authForm = document.getElementById('authForm');
            const otpForm = document.getElementById('otpForm');
            
            if (authForm) authForm.style.display = 'none';
            if (otpForm) {
                otpForm.style.display = 'flex';
                document.getElementById('otpEmailDisplay').textContent = email;
            }
        };
        
        window.showAuthLoading = function() {
            const loginBtn = document.getElementById('authLoginBtn');
            if (loginBtn) {
                loginBtn.textContent = '‚è≥ Y√ºkleniyor...';
                loginBtn.disabled = true;
            }
        };
        
        window.showAuthError = function(message, type = 'error') {
            const errorDiv = document.getElementById('authError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                errorDiv.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
                errorDiv.style.color = type === 'success' ? '#155724' : '#721c24';
            }
        };
        
        window.logout = function() {
            // Session ve local storage'ƒ± temizle
            sessionStorage.clear();
            localStorage.clear();
            
            // T√ºm formlarƒ± gizle
            const authForm = document.getElementById('authForm');
            const otpForm = document.getElementById('otpForm');
            const loadingScreen = document.getElementById('loadingScreen');
            const mainContainer = document.getElementById('mainContainer');
            
            if (authForm) authForm.style.display = 'none';
            if (otpForm) otpForm.style.display = 'none';
            if (loadingScreen) loadingScreen.style.display = 'none';
            if (mainContainer) mainContainer.style.display = 'none';
            
            // Auth formunu g√∂ster
            setTimeout(() => {
                window.showAuthForm();
            }, 500);
            
            console.log('‚úÖ √áƒ±kƒ±≈ü yapƒ±ldƒ±, session temizlendi');
        };
        
        // ===== GLOBAL DATA LOADING FUNCTION =====
        // Bu fonksiyon sayfa y√ºklenir y√ºklenmez tanƒ±mlanƒ±r
        window.loadData = async function() {
            console.log('üöÄ loadData fonksiyonu √ßaƒürƒ±ldƒ±');
            try {
                // Loading progress'i g√ºncelle
                if (typeof dataLoadProgress !== 'undefined') {
                    dataLoadProgress.dataFiles = true;
                    checkLoadingComplete();
                }
                
                if (document.getElementById('dataStatus')) {
                    document.getElementById('dataStatus').innerHTML = '<span class="status-badge" style="background:#ffc107;color:#000;">‚è≥ Y√ºkleniyor...</span>';
                }
                
                // tableContainer artƒ±k Dashboard'da yok, null check ekledik
                const tableContainer = document.getElementById('tableContainer');
                if (tableContainer) {
                    tableContainer.innerHTML = '<div style="text-align:center;padding:50px;font-size:1.2em;">‚è≥ Veriler y√ºkleniyor, l√ºtfen bekleyin...</div>';
                }
                
                // Hedefleri y√ºkle (paralel olarak)
                if (typeof loadCentralTargets === 'function') {
                    loadCentralTargets();
                }
                
                // ƒ∞lk olarak metadata'yƒ± y√ºkle
                const metadata = await loadMetadata();
                console.log('üìä Metadata y√ºklendi:', metadata);
                
                if (!metadata || !metadata.years || metadata.years.length === 0) {
                    throw new Error('Ge√ßerli yƒ±l verisi bulunamadƒ±');
                }
                
                // T√ºm yƒ±llarƒ± y√ºkle
                await loadAllYearsData(metadata);
                
                console.log('‚úÖ Veri y√ºkleme tamamlandƒ±');
                
            } catch (error) {
                console.error('‚ùå Veri y√ºkleme hatasƒ±:', error);
                if (document.getElementById('dataStatus')) {
                    document.getElementById('dataStatus').innerHTML = '<span class="status-badge" style="background:#dc3545;color:#fff;">‚ùå Hata</span>';
                }
            }
        };
        
        // ===== CACHE VERSION FUNCTIONS =====
        function getDailyVersion() {
            const today = new Date();
            const year = today.getFullYear();
            const month = String(today.getMonth() + 1).padStart(2, '0');
            const day = String(today.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }
        
        function getHourlyVersion() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            return `${year}${month}${day}${hour}`;
        }

        // ===== GLOBAL METADATA LOADING FUNCTION =====
        window.loadMetadata = async function() {
            try {
                // Akƒ±llƒ± Cache: Metadata i√ßin saatlik versiyon
                const version = getHourlyVersion();
                const response = await fetch(`data-metadata.json?v=${version}`, {
                    headers: {
                        'Cache-Control': 'public, max-age=3600' // 1 saat cache
                    }
                });
                if (!response.ok) throw new Error('Metadata y√ºklenemedi');
                metadata = await response.json();
                console.log('‚úÖ Metadata y√ºklendi:', metadata);
                return metadata;
            } catch (error) {
                console.error('‚ùå Metadata y√ºkleme hatasƒ±:', error);
                throw error;
            }
        };
        
        // ===== GLOBAL YEAR DATA LOADING FUNCTION =====
        window.loadYearData = async function(year) {
            if (loadedYears.has(year) && loadedDataCache[year]) {
                console.log(`‚è≠Ô∏è ${year} zaten y√ºkl√º, cache'den d√∂nd√ºr√ºl√ºyor...`);
                return loadedDataCache[year];
            }
            
            try {
                console.log(`üì¶ ${year} y√ºkleniyor...`);
                
                // GZIP dosyasƒ±nƒ± indir - Akƒ±llƒ± Cache ile
                const version = getDailyVersion(); // G√ºnl√ºk versiyon
                const response = await fetch(`data-${year}.json.gz?v=${version}`, {
                    headers: {
                        'Cache-Control': 'public, max-age=86400' // 24 saat cache
                    }
                });
                if (!response.ok) throw new Error(`${year} verisi bulunamadƒ±`);
                
                // ArrayBuffer olarak al
                const arrayBuffer = await response.arrayBuffer();
                
                // GZIP'i a√ß
                const decompressed = pako.ungzip(new Uint8Array(arrayBuffer), { to: 'string' });
                
                // JSON parse et
                const yearData = JSON.parse(decompressed);
                
                // Cache'e kaydet
                loadedYears.add(year);
                loadedDataCache[year] = yearData;
                
                console.log(`‚úÖ ${year} yƒ±lƒ± y√ºklendi: ${yearData.details?.length || 0} kayƒ±t`);
                return yearData;
                
            } catch (error) {
                console.error(`‚ùå ${year} y√ºkleme hatasƒ±:`, error);
                throw error;
            }
        };
        
        // Email servisi ayarlarƒ±
        const EMAIL_SERVICE_URL = 'http://localhost:3001'; // G√ºvenli port
        
        // Email servisi fonksiyonlarƒ±
        async function sendOTPCode(email) {
            try {
                // Domain kontrol√º
                const allowedDomains = ['zuhalmuzik.com'];
                const emailDomain = email.split('@')[1];
                
                if (!allowedDomains.includes(emailDomain)) {
                    showAuthError('‚ùå Yetkisiz e-mail');
                    return;
                }
                
                showAuthLoading();
                
                const response = await fetch(`${EMAIL_SERVICE_URL}/send-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ OTP g√∂nderildi:', email);
                    showAuthError('‚úÖ Doƒürulama kodu emailinize g√∂nderildi!', 'success');
                    showOTPForm(email);
                } else {
                    throw new Error(result.error || 'OTP g√∂nderilemedi');
                }
                
            } catch (error) {
                console.error('‚ùå OTP g√∂nderme hatasƒ±:', error);
                showAuthError('Email g√∂nderilemedi: ' + error.message);
            }
        }
        
        async function verifyOTPCode(email, otp) {
            try {
                showAuthLoading();
                
                const response = await fetch(`${EMAIL_SERVICE_URL}/verify-otp`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email: email, otp: otp })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    console.log('‚úÖ OTP doƒürulandƒ±:', email);
                    
                    // Session bilgilerini kaydet
                    sessionStorage.setItem('isLoggedIn', 'true');
                    sessionStorage.setItem('userEmail', email);
                    sessionStorage.setItem('loginTime', Date.now().toString());
                    
                    window.showDashboardAfterAuth(result.user);
                } else {
                    throw new Error(result.error || 'Ge√ßersiz OTP');
                }
                
            } catch (error) {
                console.error('‚ùå OTP doƒürulama hatasƒ±:', error);
                showAuthError(error.message);
            }
        }
    </script>
    <!-- Login Kontrol√º -->
    <script>
        // Sayfa y√ºklendiƒüinde oturum kontrol√º
        (function() {
            const isLoggedIn = sessionStorage.getItem('isLoggedIn');
            const loginTime = sessionStorage.getItem('loginTime');
            
            // Session s√ºresi kontrol√º (1 saat)
            const oneHour = 60 * 60 * 1000; // 1 saat
            const now = Date.now();
            
            if (isLoggedIn && loginTime) {
                const timeDiff = now - parseInt(loginTime);
                
                if (timeDiff < oneHour) {
                    // Session ge√ßerli, dashboard'ƒ± g√∂ster
                    console.log('‚úÖ Ge√ßerli session bulundu, kalan s√ºre:', Math.round((oneHour - timeDiff) / 60000), 'dakika');
                    const userEmail = sessionStorage.getItem('userEmail');
                    const user = {
                        email: userEmail,
                        name: userEmail?.split('@')[0] || 'Kullanƒ±cƒ±'
                    };
                    
                    // Loading tamamlandƒ±ktan sonra dashboard'ƒ± g√∂ster
                    setTimeout(() => {
                        window.showDashboardAfterAuth(user);
                    }, 3000); // 3 saniye loading
                    return;
                } else {
                    // Session s√ºresi dolmu≈ü, temizle
                    console.log('‚è∞ Session s√ºresi dolmu≈ü, temizleniyor');
                    sessionStorage.clear();
                }
            }
            
            // Session yok veya s√ºresi dolmu≈ü, auth formunu g√∂ster
            console.log('üîê Session bulunamadƒ±, auth formu g√∂steriliyor');
            setTimeout(() => {
                window.showAuthForm();
            }, 3000); // 3 saniye loading
        })();
    </script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            text-align: center;
            position: relative;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }

        .user-info {
            position: absolute;
            top: 20px;
            right: 30px;
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(255, 255, 255, 0.2);
            padding: 10px 20px;
            border-radius: 25px;
            backdrop-filter: blur(10px);
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
        }

        .logout-btn {
            background: rgba(255, 255, 255, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.5);
            color: white;
            padding: 6px 16px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-1px);
        }

        .info-box {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .info-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .info-card h3 {
            font-size: 0.9em;
            color: #6c757d;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .info-card p {
            font-size: 1.5em;
            color: #212529;
            font-weight: 600;
        }

        .search-section {
            padding: 30px;
            background: white;
            border-bottom: 1px solid #dee2e6;
        }

        .search-box {
            display: flex;
            gap: 10px;
            max-width: 800px;
            margin: 0 auto;
        }

        .search-box input {
            flex: 1;
            padding: 15px 20px;
            font-size: 1.1em;
            border: 2px solid #dee2e6;
            border-radius: 10px;
            outline: none;
            transition: all 0.3s;
        }

        .search-box input:focus {
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .search-box button {
            padding: 15px 30px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.1em;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .search-box button:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .filters-section {
            padding: 30px;
            background: #f8f9fa;
            border-bottom: 1px solid #dee2e6;
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .filter-group label {
            display: block;
            font-size: 0.9em;
            font-weight: 600;
            color: #495057;
            margin-bottom: 5px;
        }

        .filter-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1em;
            outline: none;
            transition: all 0.3s;
            min-height: 42px;
        }

        .filter-group select[multiple] {
            display: none; /* Gizle, checkbox kullanacaƒüƒ±z */
        }
        
        .filter-search-box {
            position: relative;
            margin-bottom: 8px;
        }
        
        .filter-search-input {
            width: 100%;
            padding: 8px 30px 8px 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
            box-sizing: border-box;
        }
        
        .filter-search-input:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .filter-search-clear {
            position: absolute;
            right: 8px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #999;
            cursor: pointer;
            font-size: 1.2em;
            padding: 0;
            width: 20px;
            height: 20px;
            display: none;
        }
        
        .filter-search-clear:hover {
            color: #333;
        }
        
        .checkbox-container {
            max-height: 200px;
            overflow-y: auto;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            background: white;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            cursor: pointer;
            border-radius: 5px;
            transition: background 0.2s;
        }
        
        .checkbox-item.hidden {
            display: none;
        }
        
        .checkbox-item:hover {
            background: #f8f9fa;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin-right: 10px;
            cursor: pointer;
            accent-color: #667eea;
        }
        
        .checkbox-item label {
            cursor: pointer;
            flex: 1;
            margin: 0;
            font-size: 0.95em;
        }

        .filter-group select:focus {
            border-color: #667eea;
        }
        
        .selected-count {
            font-size: 0.85em;
            color: #667eea;
            margin-top: 3px;
            font-weight: 600;
        }

        .filter-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
        }

        .filter-buttons button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-apply {
            background: #28a745;
            color: white;
        }

        .btn-reset {
            background: #6c757d;
            color: white;
        }

        .btn-apply:hover {
            background: #218838;
        }

        .btn-reset:hover {
            background: #5a6268;
        }

        .content {
            padding: 30px;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .summary-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .summary-card h3 {
            font-size: 0.9em;
            opacity: 0.9;
            margin-bottom: 10px;
        }

        .summary-card p {
            font-size: 2em;
            font-weight: 700;
        }

        .table-wrapper {
            overflow-x: auto;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            min-width: 1200px;
        }

        .data-table thead {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .data-table th {
            padding: 15px 10px;
            text-align: left;
            font-weight: 600;
            cursor: pointer;
            user-select: none;
            white-space: nowrap;
            font-size: 0.9em;
        }

        .data-table th:hover {
            background: rgba(255,255,255,0.1);
        }

        .data-table td {
            padding: 10px;
            border-bottom: 1px solid #dee2e6;
            font-size: 0.9em;
            max-width: 250px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .data-table td:hover {
            overflow: visible;
            white-space: normal;
            word-wrap: break-word;
            position: relative;
            z-index: 5;
            background: #fff;
            box-shadow: 0 2px 8px rgba(0,0,0,0.15);
        }

        .data-table tbody tr:hover {
            background: #f8f9fa;
        }

        .data-table td.numeric {
            text-align: right;
            font-family: 'Courier New', monospace;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
            color: #6c757d;
        }

        .error {
            text-align: center;
            padding: 50px;
            color: #dc3545;
            font-size: 1.2em;
        }

        .status-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.85em;
            font-weight: 600;
        }

        .status-success {
            background: #d4edda;
            color: #155724;
        }

        .status-warning {
            background: #fff3cd;
            color: #856404;
        }

        .status-error {
            background: #f8d7da;
            color: #721c24;
        }
        
        /* Tab System */
        .tabs {
            display: flex;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            padding: 0 30px;
        }
        
        .tab {
            padding: 15px 30px;
            cursor: pointer;
            border: none;
            background: transparent;
            font-size: 1.1em;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s;
            border-bottom: 3px solid transparent;
        }
        
        .tab:hover {
            color: #667eea;
            background: rgba(102, 126, 234, 0.1);
        }
        
        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* Voice Search */
        .voice-btn {
            padding: 15px 20px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1.5em;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .voice-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 15px rgba(245, 87, 108, 0.4);
        }
        
        .voice-btn.listening {
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* Target Tracking */
        .target-section {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 30px;
        }
        
        .target-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .target-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .target-card h3 {
            font-size: 1.2em;
            color: #495057;
            margin-bottom: 15px;
        }
        
        .target-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            font-size: 1.1em;
            margin-bottom: 15px;
        }
        
        .progress-bar {
            width: 100%;
            height: 30px;
            background: #e9ecef;
            border-radius: 15px;
            overflow: hidden;
            margin: 15px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            transition: width 0.5s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
        
        .target-stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 15px;
        }
        
        .target-stat {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
        }
        
        .target-stat label {
            font-size: 0.85em;
            color: #6c757d;
            display: block;
            margin-bottom: 5px;
        }
        
        .target-stat value {
            font-size: 1.3em;
            font-weight: 700;
            color: #212529;
        }
        
        /* Customer Analysis */
        .customer-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .customer-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .customer-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0,0,0,0.15);
        }
        
        .customer-rank {
            display: inline-block;
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 40px;
            font-weight: 700;
            font-size: 1.2em;
            margin-right: 15px;
        }
        
        .chart-container {
            position: relative;
            height: 400px;
            margin: 30px 0;
        }
        
        /* Export Button */
        .export-btn {
            padding: 12px 25px;
            background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            margin-left: 10px;
        }
        
        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(17, 153, 142, 0.3);
        }
        
        /* AI Analysis Panel */
        .analysis-panel {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            margin: 30px 0;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        
        .analysis-section {
            background: rgba(255,255,255,0.1);
            padding: 20px;
            border-radius: 10px;
            margin: 15px 0;
            backdrop-filter: blur(10px);
        }
        
        .analysis-section h3 {
            margin: 0 0 15px 0;
            font-size: 1.3em;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .insight-item {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            border-left: 4px solid;
        }
        
        .insight-positive {
            border-left-color: #38ef7d;
        }
        
        .insight-negative {
            border-left-color: #f5576c;
        }
        
        .insight-neutral {
            border-left-color: #ffd700;
        }
        
        .insight-icon {
            font-size: 1.5em;
            margin-right: 10px;
        }
        
        .recommendation {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: flex;
            align-items: start;
            gap: 15px;
        }
        
        .recommendation-icon {
            font-size: 2em;
            flex-shrink: 0;
        }
        
        .metric-highlight {
            display: inline-block;
            background: rgba(255,255,255,0.3);
            padding: 3px 10px;
            border-radius: 5px;
            font-weight: 700;
            margin: 0 5px;
        }
        
        /* ==================== MOBƒ∞L ƒ∞Yƒ∞LE≈ûTƒ∞RMELER ==================== */
        /* PC g√∂r√ºn√ºm√ºne DOKUNMAZ - Sadece mobilde aktif */
        
        @media (max-width: 768px) {
            /* Body ve Container */
            body {
                padding: 10px;
            }
            
            .container {
                border-radius: 10px;
            }
            
            /* Header */
            .header h1 {
                font-size: 1.5em;
                margin-bottom: 5px;
            }
            
            .header p {
                font-size: 0.9em;
            }
            
            .header {
                padding: 20px 15px;
            }
            
            /* Info Cards */
            .info-cards {
                grid-template-columns: 1fr;
                gap: 10px;
                padding: 15px;
            }
            
            .info-card {
                padding: 15px;
            }
            
            .info-card h3 {
                font-size: 0.9em;
            }
            
            .info-card p {
                font-size: 1.2em;
            }
            
            /* Tab Navigation - Yatay Scroll */
            .tabs {
                overflow-x: auto;
                overflow-y: hidden;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
                padding: 10px 5px;
                gap: 5px;
                scrollbar-width: thin;
            }
            
            .tabs::-webkit-scrollbar {
                height: 4px;
            }
            
            .tabs::-webkit-scrollbar-thumb {
                background: #667eea;
                border-radius: 2px;
            }
            
            .tab {
                display: inline-block;
                padding: 12px 20px;
                font-size: 0.85em;
                min-width: auto;
                white-space: nowrap;
            }
            
            /* Content */
            .content {
                padding: 15px;
            }
            
            .content h2 {
                font-size: 1.3em;
                margin-bottom: 15px;
            }
            
            .content h3 {
                font-size: 1.1em;
                margin-bottom: 10px;
            }
            
            /* Summary Cards */
            .summary-cards {
                grid-template-columns: 1fr;
                gap: 10px;
            }
            
            .summary-card {
                padding: 15px;
            }
            
            .summary-card h3 {
                font-size: 0.9em;
            }
            
            .summary-card p {
                font-size: 1.3em;
            }
            
            /* Filters */
            .filters {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .filter-group {
                padding: 12px;
            }
            
            .filter-group label {
                font-size: 0.9em;
            }
            
            .filter-group select,
            .filter-group input {
                font-size: 0.9em;
                padding: 10px;
            }
            
            /* Multi-select dropdowns */
            .multi-select-dropdown {
                max-height: 200px;
            }
            
            .checkbox-item {
                padding: 10px 8px;
            }
            
            .checkbox-item label {
                font-size: 0.9em;
            }
            
            /* Search Section */
            .search-section {
                padding: 15px;
            }
            
            .search-box input {
                font-size: 0.9em;
                padding: 12px;
            }
            
            .search-box button {
                padding: 12px 20px;
                font-size: 0.9em;
            }
            
            /* Buttons */
            button {
                padding: 12px 20px;
                font-size: 0.9em;
                min-height: 44px; /* Touch-friendly */
            }
            
            /* Charts */
            .chart-container {
                min-height: 250px;
                padding: 15px;
                margin-bottom: 20px;
            }
            
            .chart-container h3 {
                font-size: 1em;
                margin-bottom: 10px;
            }
            
            /* Charts Grid - Tek s√ºtun */
            .content > div[style*="grid-template-columns"] {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            /* Tables - Yatay Scroll */
            table {
                font-size: 0.85em;
                display: block;
                overflow-x: auto;
                white-space: nowrap;
                -webkit-overflow-scrolling: touch;
            }
            
            table thead,
            table tbody,
            table tr {
                display: table;
                width: 100%;
                table-layout: fixed;
            }
            
            table th,
            table td {
                padding: 8px !important;
                min-width: 80px;
            }
            
            /* Customer Cards */
            .customer-card {
                margin-bottom: 15px;
            }
            
            .customer-grid {
                grid-template-columns: 1fr !important;
                gap: 15px !important;
            }
            
            /* Target Section */
            .target-section {
                padding: 15px;
            }
            
            .target-input-group {
                grid-template-columns: 1fr !important;
                gap: 15px;
            }
            
            .target-input-group input {
                font-size: 0.9em;
                padding: 10px;
            }
            
            /* Progress Bars */
            .progress-item {
                margin-bottom: 15px;
            }
            
            /* AI Analysis Panel */
            .analysis-panel {
                padding: 20px 15px;
            }
            
            .analysis-section {
                margin: 15px 0;
            }
            
            .insight-item {
                padding: 12px;
                margin: 8px 0;
                font-size: 0.9em;
            }
            
            .recommendation {
                padding: 12px;
                margin: 10px 0;
                font-size: 0.9em;
            }
            
            /* Product/Customer Search Results */
            #productResultsContainer,
            #customerProfileContainer,
            #customerProfileMainContainer,
            #salespersonProfileContainer,
            #cityAnalysisContainer {
                padding: 10px;
            }
            
            /* Responsive Grid Layouts */
            div[style*="grid-template-columns: repeat(auto-fit"] {
                grid-template-columns: 1fr !important;
            }
            
            /* Input Fields */
            input[type="text"],
            input[type="number"],
            select,
            textarea {
                font-size: 16px !important; /* Prevent zoom on iOS */
            }
            
            /* Sticky Tab Menu */
            .tabs {
                position: sticky;
                top: 0;
                z-index: 100;
                background: white;
                box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            }
            
            /* Voice Button */
            #voiceButton {
                width: 44px;
                height: 44px;
                padding: 10px;
            }
            
            /* Excel Export Button */
            button[onclick*="exportToExcel"] {
                width: 100%;
                margin-top: 10px;
            }
            
            /* Debug Panel */
            #debugPanel {
                font-size: 0.8em;
                padding: 10px;
            }
            
            /* Scroll Hint for Tables */
            table::after {
                content: "‚Üê Kaydƒ±rƒ±n ‚Üí";
                display: block;
                text-align: center;
                padding: 10px;
                background: #f8f9fa;
                color: #6c757d;
                font-size: 0.85em;
                border-top: 1px solid #dee2e6;
            }
            
            /* Hide table scroll hint after first scroll */
            table.scrolled::after {
                display: none;
            }
            
            /* Compact spacing for mobile */
            .content > * {
                margin-bottom: 20px;
            }
            
            /* Modal/Alert improvements */
            .swal2-popup {
                width: 90% !important;
                font-size: 0.9em !important;
            }
        }
        
        /* Tablet (768px - 1024px) */
        @media (min-width: 769px) and (max-width: 1024px) {
            .container {
                max-width: 100%;
            }
            
            .tabs {
                overflow-x: auto;
                white-space: nowrap;
            }
            
            .tab {
                font-size: 0.9em;
                padding: 12px 20px;
            }
            
            .content {
                padding: 20px;
            }
            
            /* 2 s√ºtun layout for tablets */
            .filters {
                grid-template-columns: repeat(2, 1fr);
            }
            
            div[style*="grid-template-columns: repeat(auto-fit"] {
                grid-template-columns: repeat(2, 1fr) !important;
            }
        }
        
        /* Landscape Mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .header h1 {
                font-size: 1.3em;
            }
            
            .chart-container {
                min-height: 200px;
            }
            
            /* 2 s√ºtun for landscape */
            .summary-cards {
                grid-template-columns: repeat(2, 1fr);
            }
        }
    </style>
</head>
    <body>
    <!-- Email Authentication Form -->
    <div id="authForm" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: #333; margin-bottom: 10px;">üîê Zuhal M√ºzik Dashboard</h2>
                <p style="color: #666;">Email ile giri≈ü yapƒ±n</p>
            </div>
            
            <div id="authError" style="display: none; background: #fee; color: #c33; padding: 10px; border-radius: 5px; margin-bottom: 20px; text-align: center;"></div>
            
            <div style="margin-bottom: 20px;">
                <input type="email" id="authEmailInput" placeholder="ornek@zuhalmuzik.com" 
                       style="width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 1em; outline: none; transition: border-color 0.3s ease;">
            </div>
            
            <button id="authLoginBtn" onclick="sendOTPCode(document.getElementById('authEmailInput').value)" 
                    style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: transform 0.2s ease;">
                üìß Doƒürulama Kodu G√∂nder
            </button>
        </div>
    </div>

    <!-- OTP Form -->
    <div id="otpForm" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; justify-content: center; align-items: center;">
        <div style="background: white; padding: 40px; border-radius: 15px; box-shadow: 0 20px 40px rgba(0,0,0,0.3); max-width: 400px; width: 90%;">
            <div style="text-align: center; margin-bottom: 30px;">
                <h2 style="color: #333; margin-bottom: 10px;">üìß Doƒürulama Kodu</h2>
                <p style="color: #666;">Email kutunuzdan 6 haneli kodu girin</p>
                <p style="color: #888; font-size: 0.9em; margin-top: 10px;">
                    <span id="otpEmailDisplay" style="font-weight: bold; color: #333;"></span> adresine g√∂nderildi
                </p>
            </div>
            
            <div style="margin-bottom: 20px;">
                <input type="text" id="otpInput" placeholder="6 haneli doƒürulama kodunu girin" 
                       style="width: 100%; padding: 15px; border: 2px solid #e1e5e9; border-radius: 10px; font-size: 1em; outline: none; transition: border-color 0.3s ease; text-align: center; letter-spacing: 2px;">
            </div>
            
            <button onclick="verifyOTPCode(document.getElementById('authEmailInput').value, document.getElementById('otpInput').value)" 
                    style="width: 100%; padding: 15px; background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%); color: white; border: none; border-radius: 10px; font-size: 1.1em; font-weight: 600; cursor: pointer; transition: transform 0.2s ease; margin-bottom: 10px;">
                ‚úÖ Doƒürula
            </button>
            
            <div style="text-align: center;">
                <button onclick="window.showAuthForm()" 
                        style="padding: 10px 20px; background: #e5e7eb; color: #666; border: none; border-radius: 8px; cursor: pointer;">
                    üîÑ Geri D√∂n
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Screen -->
        <div id="loadingScreen" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 9999; display: flex; flex-direction: column; justify-content: center; align-items: center; color: white;">
            <div style="text-align: center;">
                <!-- Animated Icon -->
                <div id="loadingIcon" style="font-size: 4em; margin-bottom: 20px; animation: pulse 2s infinite;">üìä</div>
                <h1 style="margin: 0 0 10px 0; font-size: 2.5em; animation: fadeInUp 1s ease;">Zuhal M√ºzik Raporlama</h1>
                <p style="margin: 0 0 30px 0; font-size: 1.2em; opacity: 0.9; animation: fadeInUp 1s ease 0.2s both;">Ho≈ü Geldiniz! Veriler y√ºkleniyor...</p>
                
                <!-- Progress Bar -->
                <div style="width: 400px; height: 8px; background: rgba(255,255,255,0.3); border-radius: 4px; margin: 0 auto 15px; overflow: hidden; animation: fadeInUp 1s ease 0.4s both;">
                    <div id="progressBar" style="width: 0%; height: 100%; background: linear-gradient(90deg, #4ade80 0%, #22c55e 100%); border-radius: 4px; transition: width 0.3s ease; position: relative;">
                        <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%); animation: shimmer 2s infinite;"></div>
                    </div>
                </div>
                
                <!-- Progress Text -->
                <div id="progressText" style="font-size: 1.1em; font-weight: 600; margin-bottom: 20px; animation: fadeInUp 1s ease 0.6s both;">0%</div>
                
                <!-- Loading Steps -->
                <div id="loadingSteps" style="font-size: 0.9em; opacity: 0.8; animation: fadeInUp 1s ease 0.8s both;">
                    <div id="step1" style="margin-bottom: 8px; transition: all 0.3s ease;">üîÑ Sayfa ba≈ülatƒ±lƒ±yor...</div>
                    <div id="step2" style="display: none; margin-bottom: 8px; transition: all 0.3s ease;">üìä Veri dosyalarƒ± y√ºkleniyor...</div>
                    <div id="step3" style="display: none; margin-bottom: 8px; transition: all 0.3s ease;">üéØ Hedefler y√ºkleniyor...</div>
                    <div id="step4" style="display: none; margin-bottom: 8px; transition: all 0.3s ease;">‚úÖ Hazƒ±rlanƒ±yor...</div>
                </div>
            </div>
        </div>

        <style>
            @keyframes pulse {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }
            
            @keyframes fadeInUp {
                from {
                    opacity: 0;
                    transform: translateY(30px);
                }
                to {
                    opacity: 1;
                    transform: translateY(0);
                }
            }
            
            @keyframes shimmer {
                0% { transform: translateX(-100%); }
                100% { transform: translateX(100%); }
            }
            
            #loadingScreen .loading-step {
                opacity: 0.5;
                transition: opacity 0.3s ease;
            }
            
            #loadingScreen .loading-step.active {
                opacity: 1;
                color: #4ade80;
            }
        </style>

        <div class="container" style="display: none;" id="mainContainer">
        <div class="header">
            <h1>üìä Zuhal M√ºzik Raporlama</h1>
            <p>M√ºzik Enstr√ºman Sekt√∂r√º</p>
            <div class="user-info">
                <span class="user-name" id="currentUserName">Kullanƒ±cƒ±</span>
                <button class="logout-btn" onclick="logout()">üö™ √áƒ±kƒ±≈ü</button>
            </div>
        </div>

        <!-- Global Satƒ±≈ü Kanalƒ± Filtresi -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);">
            <h3 style="color: white; margin: 0 0 15px 0; font-size: 1.3em;">üè¢ Satƒ±≈ü Kanalƒ± Filtresi</h3>
            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px;">
                <label style="background: rgba(255,255,255,0.15); padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; transition: all 0.3s; color: white; font-weight: 500;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                    <input type="checkbox" id="channelAll" checked onchange="handleChannelFilter('channelAll')" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                    <span>‚ú® T√ºm√º (19 Kanal)</span>
                </label>
                <label style="background: rgba(255,255,255,0.15); padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; transition: all 0.3s; color: white; font-weight: 500;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                    <input type="checkbox" id="channelRetail" onchange="handleChannelFilter('channelRetail')" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                    <span>üè™ Perakende (14)</span>
                </label>
                <label style="background: rgba(255,255,255,0.15); padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; transition: all 0.3s; color: white; font-weight: 500;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                    <input type="checkbox" id="channelWholesale" onchange="handleChannelFilter('channelWholesale')" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                    <span>üì¶ Toptan Satƒ±≈ü</span>
                </label>
                <label style="background: rgba(255,255,255,0.15); padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; transition: all 0.3s; color: white; font-weight: 500;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                    <input type="checkbox" id="channelOnline" onchange="handleChannelFilter('channelOnline')" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                    <span>üåê Online Satƒ±≈ü</span>
                </label>
                <label style="background: rgba(255,255,255,0.15); padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; transition: all 0.3s; color: white; font-weight: 500;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                    <input type="checkbox" id="channelCorporate" onchange="handleChannelFilter('channelCorporate')" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                    <span>üè¢ Kurumsal Satƒ±≈ü</span>
                </label>
                <label style="background: rgba(255,255,255,0.15); padding: 12px 15px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; transition: all 0.3s; color: white; font-weight: 500;" onmouseover="this.style.background='rgba(255,255,255,0.25)'" onmouseout="this.style.background='rgba(255,255,255,0.15)'">
                    <input type="checkbox" id="channelCentral" onchange="handleChannelFilter('channelCentral')" style="margin-right: 10px; width: 18px; height: 18px; cursor: pointer;">
                    <span>üèõÔ∏è Merkezi Satƒ±≈ü</span>
                </label>
            </div>
            <div id="channelFilterInfo" style="margin-top: 12px; padding: 10px 15px; background: rgba(255,255,255,0.2); border-radius: 8px; color: white; font-size: 0.9em; text-align: center;">
                üìä Aktif: T√ºm Kanallar
            </div>
        </div>

        <!-- Loading Spinner for Channel Filter -->
        <div id="channelLoadingSpinner" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 9999; justify-content: center; align-items: center;">
            <div style="text-align: center;">
                <div style="width: 80px; height: 80px; border: 8px solid rgba(255,255,255,0.2); border-top: 8px solid #667eea; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 20px;"></div>
                <div style="color: white; font-size: 1.3em; font-weight: bold;" id="channelLoadingText">üîÑ Filtreleniyor...</div>
                <div style="color: rgba(255,255,255,0.7); font-size: 0.9em; margin-top: 10px;">L√ºtfen bekleyin</div>
            </div>
        </div>

        <style>
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
        </style>

        <div class="info-box">
            <div class="info-card">
                <h3>üìä Veri Durumu</h3>
                <p id="dataStatus">Yukleniyor...</p>
            </div>
            <div class="info-card">
                <h3>Son Guncelleme</h3>
                <p id="lastUpdate">-</p>
            </div>
            <div class="info-card">
                <h3>Toplam Kayit</h3>
                <p id="totalRecords">-</p>
            </div>
            <div class="info-card">
                <h3>Toplam USD (KDV Hari√ß)</h3>
                <p id="totalUSD">-</p>
            </div>
            <div class="info-card">
                <h3>üìÖ G√ºnl√ºk Ortalama</h3>
                <p id="dailyAverage">-</p>
            </div>
            <div class="info-card">
                <h3>üõí Sepet Ortalamasƒ±</h3>
                <p id="basketAverage">-</p>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">üè† Dashboard</button>
            <button class="tab" onclick="switchTab('targets')">üéØ Hedef Takip</button>
            <button class="tab" onclick="switchTab('customers')">üë• M√º≈üteri Analizi</button>
            <button class="tab" onclick="switchTab('salesperson')">üë®‚Äçüíº Satƒ±≈ü Temsilcisi</button>
            <button class="tab" onclick="switchTab('store')">üè™ Maƒüaza Analizi</button>
            <button class="tab" onclick="switchTab('city')">üåç ≈ûehir Analizi</button>
            <button class="tab" onclick="switchTab('stock')">üì¶ Stok Daƒüƒ±lƒ±m</button>
            <button class="tab" onclick="switchTab('time')">‚è∞ Zaman Analizi</button>
            <button class="tab" onclick="switchTab('product')">üé∏ √úr√ºn, Marka ve Kategori Analizi</button>
        </div>

        <!-- Dashboard Tab -->
        <div id="dashboardTab" class="tab-content active">
            <div class="content">
                <h2 style="margin-bottom: 30px; text-align: center;">üè† Zuhal M√ºzik - Genel Dashboard</h2>
                
                <!-- Genel √ñzet Kartlarƒ± -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 40px;">
                    <div class="summary-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px;">
                        <h3 style="font-size: 0.95em; margin-bottom: 10px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">üí∞ Toplam Satƒ±≈ü</h3>
                        <p id="dashTotalSales" style="color: white; font-size: 1.6em; font-weight: bold; margin: 10px 0; word-break: break-all;">$0</p>
                        <small style="opacity: 0.9; font-size: 0.85em;">KDV Hari√ß - T√ºm zamanlar</small>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px;">
                        <h3 style="font-size: 0.95em; margin-bottom: 10px;">üì¶ Toplam √úr√ºn</h3>
                        <p id="dashTotalQty" style="color: white; font-size: 1.6em; font-weight: bold; margin: 10px 0;">0</p>
                        <small style="opacity: 0.9; font-size: 0.85em;">Satƒ±lan √ºr√ºn adedi</small>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); color: white; padding: 20px;">
                        <h3 style="font-size: 0.95em; margin-bottom: 10px;">üë• M√º≈üteri</h3>
                        <p id="dashTotalCustomers" style="color: white; font-size: 1.6em; font-weight: bold; margin: 10px 0;">0</p>
                        <small style="opacity: 0.9; font-size: 0.85em;">Aktif m√º≈üteri sayƒ±sƒ±</small>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%); color: white; padding: 20px;">
                        <h3 style="font-size: 0.95em; margin-bottom: 10px;">üé∏ Farklƒ± √úr√ºn</h3>
                        <p id="dashTotalProducts" style="color: white; font-size: 1.6em; font-weight: bold; margin: 10px 0;">0</p>
                        <small style="opacity: 0.9; font-size: 0.85em;">√úr√ºn √ße≈üidi</small>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #fa709a 0%, #fee140 100%); color: white; padding: 20px;">
                        <h3 style="font-size: 0.95em; margin-bottom: 10px;">üè™ Maƒüaza</h3>
                        <p id="dashTotalStores" style="color: white; font-size: 1.6em; font-weight: bold; margin: 10px 0;">0</p>
                        <small style="opacity: 0.9; font-size: 0.85em;">Aktif maƒüaza sayƒ±sƒ±</small>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #30cfd0 0%, #330867 100%); color: white; padding: 20px;">
                        <h3 style="font-size: 0.95em; margin-bottom: 10px;">üë®‚Äçüíº Temsilci</h3>
                        <p id="dashTotalSalespeople" style="color: white; font-size: 1.6em; font-weight: bold; margin: 10px 0;">0</p>
                        <small style="opacity: 0.9; font-size: 0.85em;">Aktif temsilci sayƒ±sƒ±</small>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #ffa751 0%, #ffe259 100%); color: white; padding: 20px;">
                        <h3 style="font-size: 0.95em; margin-bottom: 10px;">üìÖ G√ºnl√ºk Ortalama</h3>
                        <p id="dashDailyAverage" style="color: white; font-size: 1.6em; font-weight: bold; margin: 10px 0;">$0</p>
                        <small style="opacity: 0.9; font-size: 0.85em;">G√ºnl√ºk ortalama satƒ±≈ü</small>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #a8edea 0%, #fed6e3 100%); color: white; padding: 20px;">
                        <h3 style="font-size: 0.95em; margin-bottom: 10px;">üõí Sepet Ortalamasƒ±</h3>
                        <p id="dashBasketAverage" style="color: white; font-size: 1.6em; font-weight: bold; margin: 10px 0;">$0</p>
                        <small style="opacity: 0.9; font-size: 0.85em;">Ortalama i≈ülem tutarƒ±</small>
                    </div>
                    <div class="summary-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px;">
                        <h3 style="font-size: 0.95em; margin-bottom: 10px;">üîÑ Cache Versiyonu</h3>
                        <p id="cacheVersion" style="color: white; font-size: 1.6em; font-weight: bold; margin: 10px 0;">20241024</p>
                        <small style="opacity: 0.9; font-size: 0.85em;">G√ºnl√ºk veri versiyonu</small>
                    </div>
                </div>

                <!-- Yƒ±llƒ±k Kar≈üƒ±la≈ütƒ±rma -->
                <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); margin-bottom: 40px;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0;">üìä Yƒ±llƒ±k Satƒ±≈ü Kar≈üƒ±la≈ütƒ±rmasƒ±</h3>
                        <div style="display: flex; gap: 10px;">
                            <button id="dashYearlyMetricSales" onclick="changeDashYearlyMetric('sales')" style="padding: 8px 20px; border: 2px solid #667eea; background: #667eea; color: white; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                üí∞ Satƒ±≈ü (USD)
                            </button>
                            <button id="dashYearlyMetricQty" onclick="changeDashYearlyMetric('qty')" style="padding: 8px 20px; border: 2px solid #667eea; background: white; color: #667eea; border-radius: 8px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                                üì¶ Miktar
                            </button>
                        </div>
                    </div>
                    <canvas id="dashYearlyChart" style="max-height: 400px;"></canvas>
            </div>
            
                <!-- Top Performanslar -->
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-bottom: 40px;">
                    <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: 580px;">
                        <h3 style="margin-bottom: 20px;">üèÜ Top 10 Maƒüaza (T√ºm Zamanlar)</h3>
                        <canvas id="dashTopStoresChart" style="height: 500px; max-height: 500px;"></canvas>
                    </div>
                    <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: 580px;">
                        <h3 style="margin-bottom: 20px;">‚≠ê Top 10 Satƒ±≈ü Temsilcisi (T√ºm Zamanlar)</h3>
                        <canvas id="dashTopSalespeopleChart" style="height: 500px; max-height: 500px;"></canvas>
                    </div>
                    <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: 580px;">
                        <h3 style="margin-bottom: 20px;">üè∑Ô∏è Top 10 Marka (T√ºm Zamanlar)</h3>
                        <canvas id="dashTopBrandsChart" style="height: 500px; max-height: 500px;"></canvas>
                    </div>
                    <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: 580px;">
                        <h3 style="margin-bottom: 20px;">üìÇ Top 10 Kategori (T√ºm Zamanlar)</h3>
                        <canvas id="dashTopCategoriesChart" style="height: 500px; max-height: 500px;"></canvas>
                    </div>
                    <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: 580px;">
                        <h3 style="margin-bottom: 20px;">üåç Top 10 ≈ûehir (T√ºm Zamanlar)</h3>
                        <canvas id="dashTopCitiesChart" style="height: 500px; max-height: 500px;"></canvas>
                    </div>
                    <div style="background: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); height: 580px;">
                        <h3 style="margin-bottom: 20px;">üé∏ Top 10 √úr√ºn (T√ºm Zamanlar)</h3>
                        <canvas id="dashTopProductsChart" style="height: 500px; max-height: 500px;"></canvas>
                    </div>
                </div>

                <!-- AI Dashboard Analizi -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin-bottom: 40px;">
                    <h3 style="color: white; margin-bottom: 20px;">ü§ñ AI Dashboard Analizi</h3>
                    <div id="dashAIAnalysis" style="background: white; padding: 20px; border-radius: 10px; line-height: 1.8;"></div>
            </div>
        </div>
        </div>
        <!-- End Dashboard Tab -->

        <!-- Targets Tab -->
        <div id="targetsTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 30px;">üéØ Hedef Takip Sistemi</h2>
                
                <!-- Filtreler -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="color: white; margin: 0 0 20px 0;">üìÖ D√∂nem Se√ßin</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; max-width: 600px;">
                        <div>
                            <label style="color: white; display: block; margin-bottom: 8px; font-weight: 600;">Yƒ±l</label>
                            <select id="targetFilterYear" class="target-input" onchange="loadAllStoresTargets()" style="width: 100%;">
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: white; display: block; margin-bottom: 8px; font-weight: 600;">Ay (Opsiyonel)</label>
                            <select id="targetFilterMonth" class="target-input" onchange="loadAllStoresTargets()" style="width: 100%;">
                                <option value="">T√ºm Yƒ±l</option>
                                <option value="01">Ocak</option>
                                <option value="02">≈ûubat</option>
                                <option value="03">Mart</option>
                                <option value="04">Nisan</option>
                                <option value="05">Mayƒ±s</option>
                                <option value="06">Haziran</option>
                                <option value="07">Temmuz</option>
                                <option value="08">Aƒüustos</option>
                                <option value="09">Eyl√ºl</option>
                                <option value="10">Ekim</option>
                                <option value="11">Kasƒ±m</option>
                                <option value="12">Aralƒ±k</option>
                            </select>
                        </div>
                            </div>
                    <p style="color: white; opacity: 0.9; margin-top: 15px; font-size: 0.95em;">
                        üí° ƒ∞pucu: Sadece yƒ±l se√ßerseniz yƒ±llƒ±k hedefler, yƒ±l + ay se√ßerseniz aylƒ±k hedefler g√∂sterilir
                    </p>
                </div>
                
                <!-- T√ºm Maƒüazalar Hedef Listesi -->
                <div id="allStoresTargetsContainer"></div>
            </div>
        </div>
        <!-- End Targets Tab -->

        <!-- Customers Tab -->
        <div id="customersTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 20px;">üë• M√º≈üteri Analizi</h2>
                
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>Toplam M√º≈üteri</h3>
                        <p id="totalCustomers">0</p>
                    </div>
                    <div class="summary-card">
                        <h3>Aktif M√º≈üteri (Son 90 G√ºn)</h3>
                        <p id="activeCustomers">0</p>
                    </div>
                    <div class="summary-card">
                        <h3>Ortalama Sipari≈ü</h3>
                        <p id="avgOrderValue">$0</p>
                    </div>
                    <div class="summary-card">
                        <h3>En Y√ºksek Sipari≈ü</h3>
                        <p id="maxOrderValue">$0</p>
                    </div>
                </div>
                
                <!-- Customer Search Section -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin: 30px 0;">
                    <h3 style="color: white; margin: 0 0 20px 0;">üîç M√º≈üteri Arama</h3>
                    <div style="display: flex; gap: 10px; max-width: 600px;">
                        <div style="position: relative; flex: 1;">
                            <input type="text" id="customerSearchInputMain" placeholder="M√º≈üteri adƒ± yazƒ±n... (√∂rn: Ahmet Yƒ±lmaz)" 
                                   style="width: 100%; padding: 15px 60px 15px 15px; font-size: 1em; border: 2px solid white; border-radius: 10px; outline: none;"
                                   onkeyup="if(event.key==='Enter') searchCustomerProfileMain()">
                            <button onclick="searchCustomerProfileMain()" 
                                    style="position: absolute; right: 5px; top: 50%; transform: translateY(-50%); background: white; color: #667eea; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: bold;">
                                üîç Ara
                            </button>
                        </div>
                        <button onclick="clearCustomerSearchMain()" 
                                style="background: rgba(255,255,255,0.2); border: 2px solid white; color: white; padding: 15px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; transition: all 0.3s;"
                                onmouseover="this.style.background='rgba(255,255,255,0.3)'" 
                                onmouseout="this.style.background='rgba(255,255,255,0.2)'">
                            üóëÔ∏è Temizle
                        </button>
                    </div>
                    <p style="color: white; opacity: 0.9; margin-top: 10px; font-size: 0.9em;">
                        üí° M√º≈üteri adƒ±nƒ±n bir kƒ±smƒ±nƒ± yazmak yeterli
                    </p>
                </div>
                
                <!-- Customer Profile Results (Initially Hidden) -->
                <div id="customerProfileMainContainer" style="display: none; margin-bottom: 40px;">
                    <!-- Customer Profile Header -->
                    <div style="background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); color: white; padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                        <h3 style="margin: 0 0 15px 0; font-size: 1.8em;">üë§ <span id="customerNameMain">-</span></h3>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px;">
                            <div>
                                <div style="opacity: 0.8; font-size: 0.85em;">üåç ≈ûehir</div>
                                <div style="font-size: 1.1em; font-weight: bold;" id="customerCityMain">-</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.85em;">üè∑Ô∏è Etiketler</div>
                                <div style="font-size: 0.95em; font-weight: bold;" id="customerTagsMain">-</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.85em;">üí∞ Toplam Alƒ±≈üveri≈ü</div>
                                <div style="font-size: 1.3em; font-weight: bold;" id="customerTotalSalesMain">$0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.85em;">üì¶ Toplam Adet</div>
                                <div style="font-size: 1.3em; font-weight: bold;" id="customerTotalQtyMain">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.85em;">üõí ƒ∞≈ülem Sayƒ±sƒ±</div>
                                <div style="font-size: 1.3em; font-weight: bold;" id="customerTransactionCountMain">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.85em;">üìä Ortalama Sepet</div>
                                <div style="font-size: 1.3em; font-weight: bold;" id="customerAvgBasketMain">$0</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Customer Charts -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 15px;">üè∑Ô∏è En √áok Tercih Ettiƒüi Markalar</h3>
                            <canvas id="customerBrandChartMain"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 15px;">üìÇ En √áok Aldƒ±ƒüƒ± Kategoriler</h3>
                            <canvas id="customerCategoryChartMain"></canvas>
                        </div>
                    </div>
                    
                    <!-- Purchase History -->
                    <div style="margin-top: 30px;">
                        <h3 style="margin-bottom: 15px;">üõçÔ∏è Son Alƒ±≈üveri≈üler (Son 20)</h3>
                        <div id="customerPurchaseHistoryMain" style="overflow-x: auto;"></div>
                    </div>
                    
                    <!-- AI Analysis Panel -->
                    <div id="customerAIAnalysisPanelMain" style="margin: 40px 0; display: none;">
                        <h3 style="margin-bottom: 20px;">ü§ñ AI M√º≈üteri Analizi, Yorum ve √ñneriler</h3>
                        <div id="customerAIAnalysisContentMain"></div>
                    </div>
                </div>
                
                <div id="topCustomersSection">
                    <h3 style="margin: 30px 0 20px 0;">üèÜ Top 30 M√º≈üteri</h3>
                    <div class="customer-grid" id="topCustomersGrid">
                        <!-- Dinamik olarak doldurulacak -->
                    </div>
                </div>
                
                <!-- Customer Charts -->
                <div id="customerChartsSection" style="margin-top: 30px;">
                    <!-- Yƒ±llƒ±k M√º≈üteri Trendi - Tam Geni≈ülik -->
                    <div class="chart-container" style="margin-bottom: 30px;">
                        <h3 style="text-align: center; margin-bottom: 20px;">üìä Yƒ±llƒ±k M√º≈üteri Trendi</h3>
                        <canvas id="customerTrendChart" style="max-height: 400px;"></canvas>
                    </div>
                    
                    <!-- M√º≈üteri Daƒüƒ±lƒ±mƒ± (≈ûehir) - Alt kƒ±sƒ±mda -->
                    <div class="chart-container" style="max-width: 600px; margin: 0 auto;">
                        <h3 style="text-align: center; margin-bottom: 20px;">üåç M√º≈üteri Daƒüƒ±lƒ±mƒ± (≈ûehir)</h3>
                        <canvas id="customerCityChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Customers Tab -->

        <!-- Time Analysis Tab -->
        <div id="timeTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 20px;">‚è∞ Zaman Analizi</h2>
                
                <!-- Filters -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 8px; color: white; font-weight: 600;">üìÅ Kategori</label>
                            <select id="timeCategory1Filter" onchange="analyzeTime()" style="width: 100%; padding: 10px; border: none; border-radius: 8px; font-size: 1em;">
                                <option value="">T√ºm Kategoriler</option>
                            </select>
                        </div>
                        <div style="display: flex; align-items: end;">
                            <button onclick="clearTimeFilters()" style="width: 100%; padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 1em;">
                                üîÑ Temizle
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- Time Summary Cards -->
                <div class="summary-cards">
                    <div class="summary-card">
                        <h3>En Yoƒüun Saat</h3>
                        <p id="peakHour">-</p>
                    </div>
                    <div class="summary-card">
                        <h3>En Yoƒüun G√ºn</h3>
                        <p id="peakDay">-</p>
                    </div>
                    <div class="summary-card">
                        <h3>Mesai Saati Satƒ±≈ü</h3>
                        <p id="workHoursSales">-</p>
                    </div>
                    <div class="summary-card">
                        <h3>Hafta Sonu Satƒ±≈ü</h3>
                        <p id="weekendSales">-</p>
                    </div>
                </div>
                
                <!-- AI Time Insights -->
                <div id="timeInsightsPanel" style="display: none;"></div>
                
                <!-- Hourly Chart -->
                <div class="chart-container" style="margin: 30px 0;">
                    <h3 style="text-align: center; margin-bottom: 20px;">üìä Saatlik Yoƒüunluk (24 Saat)</h3>
                    <canvas id="hourlyChart"></canvas>
                </div>
                
                <!-- Monthly Trend -->
                <div class="chart-container" style="margin: 30px 0;">
                    <h3 style="text-align: center; margin-bottom: 20px;">üìÖ Aylƒ±k Trend</h3>
                    <canvas id="monthlyTrendChart"></canvas>
                </div>
                
                <!-- Yearly Trend -->
                <div class="chart-container" style="margin: 30px 0;">
                    <h3 style="text-align: center; margin-bottom: 20px;">üìä Yƒ±llƒ±k Trend</h3>
                    <canvas id="yearlyTrendChart"></canvas>
                </div>
                
                <!-- Store Time Comparison -->
                <div style="margin: 30px 0;">
                    <h3 style="text-align: center; margin-bottom: 20px;">üè™ Maƒüaza Bazƒ±nda Saat Kar≈üƒ±la≈ütƒ±rmasƒ±</h3>
                    <div style="margin-bottom: 20px; text-align: center;">
                        <label>Maƒüaza Se√ß: </label>
                        <select id="storeTimeFilter" onchange="renderStoreTimeChart()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                            <option value="">T√ºm Maƒüazalar</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="storeTimeChart"></canvas>
                    </div>
                </div>
                
                <!-- Category Time Analysis -->
                <div style="margin: 30px 0;">
                    <h3 style="text-align: center; margin-bottom: 20px;">üì¶ Kategori Bazƒ±nda Saat Analizi</h3>
                    <div style="margin-bottom: 20px; text-align: center;">
                        <label>Kategori Se√ß: </label>
                        <select id="categoryTimeFilter" onchange="renderCategoryTimeChart()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                            <option value="">T√ºm Kategoriler</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="categoryTimeChart"></canvas>
                    </div>
                </div>
                
                <!-- Sales Person Time Analysis -->
                <div style="margin: 30px 0;">
                    <h3 style="text-align: center; margin-bottom: 20px;">üë§ Satƒ±≈ü Temsilcisi Bazƒ±nda Saat Analizi</h3>
                    <div style="margin-bottom: 20px; text-align: center;">
                        <label>Temsilci Se√ß: </label>
                        <select id="salesPersonTimeFilter" onchange="renderSalesPersonTimeChart()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                            <option value="">T√ºm Temsilciler</option>
                        </select>
                    </div>
                    <div class="chart-container">
                        <canvas id="salesPersonTimeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Time Analysis Tab -->

        <!-- Product Analysis Tab -->
        <div id="productTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 20px;">üé∏ √úr√ºn, Marka ve Kategori Analizi</h2>
                
                <!-- Search Section -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin-bottom: 30px;">
                    <h3 style="color: white; margin-bottom: 20px; text-align: center;">üîç √úr√ºn, Marka veya Kategori Ara</h3>
                    
                    <!-- Filters Grid -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; max-width: 1000px; margin: 0 auto 20px;">
                        <!-- Search Input -->
                        <div style="grid-column: 1 / -1;">
                            <label style="color: white; display: block; margin-bottom: 8px; font-weight: 600;">üîç √úr√ºn/Marka Ara</label>
                            <div style="display: flex; gap: 10px;">
                        <input type="text" id="productSearchInput" placeholder="√ñrnek: KDP120R, Roland, Fender..." 
                                       style="flex: 1; padding: 12px; border: none; border-radius: 8px; font-size: 1em;"
                               onkeypress="if(event.key==='Enter') searchProduct()">
                        <button onclick="searchProduct()" 
                                        style="padding: 12px 30px; background: #38ef7d; color: white; border: none; border-radius: 8px; font-size: 1em; font-weight: bold; cursor: pointer;">
                            üîç Ara
                        </button>
                    </div>
                        </div>
                        
                        <!-- Category Search -->
                        <div style="position: relative;">
                            <label style="color: white; display: block; margin-bottom: 8px; font-weight: 600;">üìÅ Kategori Ara</label>
                            <input type="text" id="productCategorySearch" placeholder="Kategori adƒ± yazƒ±n..." 
                                   style="width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1em;"
                                   oninput="filterProductCategories()"
                                   onfocus="showProductCategoryDropdown()"
                                   onblur="setTimeout(() => hideProductCategoryDropdown(), 200)">
                            <div id="productCategoryDropdown" style="display: none; position: absolute; top: 100%; left: 0; right: 0; background: white; border-radius: 8px; max-height: 300px; overflow-y: auto; box-shadow: 0 4px 12px rgba(0,0,0,0.2); z-index: 1000; margin-top: 5px;">
                            </div>
                        </div>
                        
                        <!-- Store Filter -->
                        <div style="margin-bottom: 15px;">
                            <label style="color: white; display: block; margin-bottom: 8px; font-weight: 600;">üè™ Maƒüaza (Opsiyonel)</label>
                            <select id="productStoreFilter" 
                                    style="width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1em;">
                                <option value="">T√ºm Maƒüazalar</option>
                            </select>
                        </div>
                        
                        <!-- Date Range Filters -->
                        <div style="display: flex; gap: 10px; align-items: end;">
                            <div style="flex: 1;">
                                <label style="color: white; display: block; margin-bottom: 8px; font-weight: 600;">üìÖ Ba≈ülangƒ±√ß Tarihi</label>
                                <input type="date" id="productDateStart" 
                                       style="width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1em;">
                            </div>
                            <div style="flex: 1;">
                                <label style="color: white; display: block; margin-bottom: 8px; font-weight: 600;">üìÖ Biti≈ü Tarihi</label>
                                <input type="date" id="productDateEnd" 
                                       style="width: 100%; padding: 12px; border: none; border-radius: 8px; font-size: 1em;">
                            </div>
                            <div>
                                <button onclick="clearProductDateFilters()" 
                                        style="padding: 12px 20px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 8px; cursor: pointer; font-size: 1em; white-space: nowrap;">
                                    üîÑ Temizle
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <p style="text-align: center; margin-top: 15px; color: white; font-size: 0.95em; opacity: 0.9;">
                        üí° <strong>ƒ∞pucu:</strong> Tarih aralƒ±ƒüƒ± se√ßmek zorunlu deƒüil, istenirse t√ºm d√∂nem veya belirli tarih aralƒ±ƒüƒ± i√ßin analiz yapabilirsiniz
                    </p>
                </div>
                
                <!-- Results Section -->
                <div id="productResultsContainer" style="display: none;">
                    <!-- Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="summary-card">
                            <h3>Toplam Satƒ±≈ü (KDV Hari√ß)</h3>
                            <p id="productTotalSales">$0</p>
                        </div>
                        <div class="summary-card">
                            <h3>Toplam Adet</h3>
                            <p id="productTotalQty">0</p>
                        </div>
                        <div class="summary-card">
                            <h3>Farklƒ± √úr√ºn</h3>
                            <p id="productUniqueCount">0</p>
                        </div>
                        <div class="summary-card">
                            <h3>Sepet Ortalamasƒ±</h3>
                            <p id="productAvgPrice">$0</p>
                        </div>
                    </div>
                    
                    <!-- Charts Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px;">
                        <!-- Top Stores -->
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">üè™ En √áok Satan Maƒüazalar</h3>
                            <canvas id="productStoreChart"></canvas>
                        </div>
                        
                        <!-- Top Cities -->
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">üåç En √áok Satƒ±lan ƒ∞ller</h3>
                            <canvas id="productCityChart"></canvas>
                        </div>
                        
                        <!-- Top Districts -->
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">üìç En √áok Satƒ±lan ƒ∞l√ßeler</h3>
                            <canvas id="productDistrictChart"></canvas>
                        </div>
                        
                        <!-- Top Sales Persons -->
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">üë§ En √áok Satan Temsilciler</h3>
                            <canvas id="productSalesPersonChart"></canvas>
                        </div>
                        
                        <!-- Monthly Trend -->
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">üìà Aylƒ±k Satƒ±≈ü Trendi</h3>
                            <canvas id="productMonthlyChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- AI Analysis Panel -->
                    <div id="productAIAnalysisPanel" style="margin: 40px 0; display: none;">
                        <h3 style="margin-bottom: 20px;">ü§ñ AI Analiz, Yorum ve √ñneriler</h3>
                        <div id="productAIAnalysisContent"></div>
                    </div>
                    
                    <!-- Detailed Products Table -->
                    <div style="margin-top: 40px;">
                        <h3 style="margin-bottom: 20px;">üìã Detaylƒ± √úr√ºn Listesi</h3>
                        <div id="productDetailTable" style="overflow-x: auto;"></div>
                    </div>
                </div>
                
                <!-- No Results Message -->
                <div id="productNoResults" style="display: none; text-align: center; padding: 60px; background: #f8f9fa; border-radius: 15px;">
                    <div style="font-size: 4em; margin-bottom: 20px;">üîç</div>
                    <h3 style="color: #6c757d; margin-bottom: 10px;">Sonu√ß Bulunamadƒ±</h3>
                    <p style="color: #adb5bd;">L√ºtfen farklƒ± bir √ºr√ºn veya marka adƒ± deneyin</p>
                </div>
            </div>
        </div>
        <!-- End Product Analysis Tab -->

        <!-- Customer Search Tab -->
        <div id="customerSearchTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 30px;">üîç M√º≈üteri Arama ve Analizi</h2>
                
                <!-- Search Input -->
                <div style="max-width: 800px; margin: 0 auto 40px;">
                    <div style="position: relative;">
                        <input type="text" id="customerSearchInput" placeholder="M√º≈üteri adƒ± yazƒ±n veya virg√ºlle ayƒ±rarak √ßoklu arama yapƒ±n..." 
                               style="width: 100%; padding: 20px 60px 20px 20px; font-size: 1.1em; border: 2px solid #667eea; border-radius: 15px; outline: none;"
                               oninput="showCustomerSuggestions(this.value)"
                               onkeydown="handleCustomerKeydown(event)"
                               onfocus="showCustomerSuggestions(this.value)">
                        <button onclick="searchCustomerProfile()" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-size: 1em;">
                            üîç Ara
                        </button>
                        <div id="customerSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #667eea; border-top: none; border-radius: 0 0 15px 15px; max-height: 300px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                    </div>
                    
                    <!-- Selected Customers Tags -->
                    <div id="selectedCustomersContainer" style="display: none; margin-top: 15px;">
                        <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border: 2px dashed #667eea;">
                            <div style="font-weight: 600; color: #667eea; margin-bottom: 10px;">‚úÖ Se√ßili M√º≈üteriler (En fazla 3):</div>
                            <div id="selectedCustomersTags" style="display: flex; flex-wrap: wrap; gap: 10px;"></div>
                        </div>
                    </div>
                    
                    <p style="text-align: center; color: #6c757d; margin-top: 10px; font-size: 0.9em;">
                        üí° ƒ∞pucu: Listeden tƒ±klayarak veya virg√ºl ile ayƒ±rarak birden fazla m√º≈üteri se√ßebilir, kar≈üƒ±la≈ütƒ±rabilirsiniz
                    </p>
                </div>
                
                <!-- Results Container -->
                <div id="customerProfileContainer" style="display: none;">
                    <!-- Customer Profile Header -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 20px; margin-bottom: 30px;">
                        <h2 style="margin: 0 0 20px 0; font-size: 2em;">üë§ <span id="customerName">-</span></h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üåç ≈ûehir</div>
                                <div style="font-size: 1.3em; font-weight: bold;" id="customerCity">-</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üè∑Ô∏è Etiketler</div>
                                <div style="font-size: 1.1em; font-weight: bold;" id="customerTags">-</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üí∞ Toplam Alƒ±≈üveri≈ü</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="customerTotalSales">$0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üì¶ Toplam Adet</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="customerTotalQty">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üõí ƒ∞≈ülem Sayƒ±sƒ±</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="customerTransactionCount">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üìä Ortalama Sepet</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="customerAvgBasket">$0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üìÖ ƒ∞lk Alƒ±≈üveri≈ü</div>
                                <div style="font-size: 1.1em; font-weight: bold;" id="customerFirstPurchase">-</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üìÖ Son Alƒ±≈üveri≈ü</div>
                                <div style="font-size: 1.1em; font-weight: bold;" id="customerLastPurchase">-</div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; margin-bottom: 30px;">
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">üè∑Ô∏è En √áok Tercih Ettiƒüi Markalar</h3>
                            <canvas id="customerBrandChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">üìÇ En √áok Aldƒ±ƒüƒ± Kategoriler</h3>
                            <canvas id="customerCategoryChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">üè™ Alƒ±≈üveri≈ü Yaptƒ±ƒüƒ± Maƒüazalar</h3>
                            <canvas id="customerStoreChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">üìà Aylƒ±k Alƒ±≈üveri≈ü Trendi</h3>
                            <canvas id="customerMonthlyTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- AI Customer Analysis -->
                    <div id="customerAIAnalysisPanel" style="margin: 40px 0;">
                        <h3 style="margin-bottom: 20px;">ü§ñ AI M√º≈üteri Analizi ve √ñneriler</h3>
                        <div id="customerAIAnalysisContent"></div>
                    </div>
                    
                    <!-- Purchase History Table -->
                    <div style="margin-top: 40px;">
                        <h3 style="margin-bottom: 20px;">üõçÔ∏è Satƒ±n Alma Ge√ßmi≈üi</h3>
                        <div id="customerPurchaseHistory" style="overflow-x: auto;"></div>
                    </div>
                </div>
                
                <!-- No Results Message -->
                <div id="customerSearchNoResults" style="display: none; text-align: center; padding: 60px; background: #f8f9fa; border-radius: 15px;">
                    <div style="font-size: 4em; margin-bottom: 20px;">üîç</div>
                    <h3 style="color: #6c757d; margin-bottom: 10px;">M√º≈üteri Bulunamadƒ±</h3>
                    <p style="color: #adb5bd;">L√ºtfen farklƒ± bir m√º≈üteri adƒ± deneyin</p>
                </div>
            </div>
        </div>
        <!-- End Customer Search Tab -->

        <!-- Salesperson Analysis Tab -->
        <div id="salespersonTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 30px;">üë®‚Äçüíº Satƒ±≈ü Temsilcisi Performans Analizi</h2>
                
                <!-- Filters Section (Satƒ±≈ü Analizi ile aynƒ± yapƒ±) -->
                <div class="filters-section" style="margin-bottom: 30px;">
                    <div class="filters-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div class="filter-group">
                            <label>Yƒ±l <span class="selected-count" id="countSalespersonYear"></span></label>
                            <div class="filter-search-box">
                                <input type="text" class="filter-search-input" placeholder="üîç Ara..." oninput="filterCheckboxes('filterSalespersonYear', this.value)">
                            </div>
                            <div class="checkbox-container" id="filterSalespersonYear"></div>
                        </div>
                        <div class="filter-group">
                            <label>Ay <span class="selected-count" id="countSalespersonMonth"></span></label>
                            <div class="filter-search-box">
                                <input type="text" class="filter-search-input" placeholder="üîç Ara..." oninput="filterCheckboxes('filterSalespersonMonth', this.value)">
                            </div>
                            <div class="checkbox-container" id="filterSalespersonMonth"></div>
                        </div>
                        <div class="filter-group">
                            <label>G√ºn <span class="selected-count" id="countSalespersonDay"></span></label>
                            <div class="filter-search-box">
                                <input type="text" class="filter-search-input" placeholder="üîç Ara..." oninput="filterCheckboxes('filterSalespersonDay', this.value)">
                            </div>
                            <div class="checkbox-container" id="filterSalespersonDay"></div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="clearSalespersonFilters()" 
                                style="background: #6c757d; color: white; border: none; padding: 12px 30px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                            üîÑ Filtreleri Temizle
                        </button>
                    </div>
                </div>
                
                <!-- Search Input with Multi-Select -->
                <div style="max-width: 800px; margin: 0 auto 40px;">
                    <!-- Selected Salespersons Tags -->
                    <div id="selectedSalespersonsContainer" style="display: none; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <span style="font-weight: 600; color: #667eea;">Se√ßili Temsilciler:</span>
                            <div id="selectedSalespersonsTags" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                        </div>
                    </div>
                    
                    <div style="position: relative;">
                        <input type="text" id="salespersonSearchInput" placeholder="Satƒ±≈ü temsilcisi adƒ± yazƒ±n... (√∂rn: Mustafa Kƒ±lƒ±√ß, Kaan Poyraz)" 
                               style="width: 100%; padding: 20px 60px 20px 20px; font-size: 1.1em; border: 2px solid #667eea; border-radius: 15px; outline: none;"
                               oninput="showSalespersonSuggestions(this.value)"
                               onkeydown="handleSalespersonKeydown(event)"
                               onfocus="showSalespersonSuggestions(this.value)">
                        <button onclick="searchSalespersonProfile()" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-size: 1em;">
                            üîç Ara
                        </button>
                        <div id="salespersonSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #667eea; border-top: none; border-radius: 0 0 15px 15px; max-height: 300px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                    </div>
                    <p style="text-align: center; color: #6c757d; margin-top: 10px; font-size: 0.9em;">
                        üí° ƒ∞pucu: Birden fazla temsilci se√ßerek kar≈üƒ±la≈ütƒ±rmalƒ± analiz yapabilirsiniz! (En fazla 3 temsilci)
                    </p>
                </div>
                
                <!-- Results Container -->
                <div id="salespersonProfileContainer" style="display: none;">
                    <!-- Single Salesperson View -->
                    <div id="singleSalespersonView" style="display: none;">
                    <!-- Salesperson Profile Header -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 20px; margin-bottom: 30px;">
                        <h2 style="margin: 0 0 20px 0; font-size: 2em;">üë®‚Äçüíº <span id="salespersonName">-</span></h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üí∞ Toplam Satƒ±≈ü (KDV Hari√ß)</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="salespersonTotalSales">$0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üì¶ Toplam Adet</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="salespersonTotalQty">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üõí Fatura Sayƒ±sƒ±</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="salespersonInvoiceCount">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üìä G√ºnl√ºk Ort. Satƒ±≈ü</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="salespersonAvgTransaction">$0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üõí Sepet Ortalamasƒ±</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="salespersonAvgBasket">$0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üë• Farklƒ± M√º≈üteri</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="salespersonUniqueCustomers">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üéØ Farklƒ± √úr√ºn</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="salespersonUniqueProducts">0</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Multiple Salespersons Comparison View -->
                    <div id="multipleSalespersonsView" style="display: none;">
                        <h2 style="margin: 0 0 30px 0; font-size: 2em; text-align: center;">üìä Satƒ±≈ü Temsilcileri Kar≈üƒ±la≈ütƒ±rmalƒ± Analiz</h2>
                        
                        <!-- Comparison Table -->
                        <div style="overflow-x: auto; margin-bottom: 40px;">
                            <div id="salespersonComparisonTable"></div>
                        </div>
                        
                        <!-- Comparison Charts -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; margin-bottom: 30px;">
                        <div class="chart-container">
                                <h3 style="text-align: center; margin-bottom: 20px;">üí∞ Toplam Satƒ±≈ü Kar≈üƒ±la≈ütƒ±rmasƒ±</h3>
                                <canvas id="comparisonSalesChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3 style="text-align: center; margin-bottom: 20px;">üì¶ √úr√ºn Adet Kar≈üƒ±la≈ütƒ±rmasƒ±</h3>
                                <canvas id="comparisonQtyChart"></canvas>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Charts Grid -->
                    <div id="salespersonBrandCategorySection" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; margin-bottom: 30px;">
                        <div class="chart-container">
                            <h3 id="salespersonBrandChartTitle" style="text-align: center; margin-bottom: 20px;">üè∑Ô∏è En √áok Sattƒ±ƒüƒ± Markalar (Top 10)</h3>
                            <canvas id="salespersonBrandChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 id="salespersonCategoryChartTitle" style="text-align: center; margin-bottom: 20px;">üìÇ En √áok Sattƒ±ƒüƒ± Kategoriler</h3>
                            <canvas id="salespersonCategoryChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Aylƒ±k Performans Trendi - Tam Geni≈ülik -->
                    <div id="salespersonMonthlySection" style="margin-bottom: 40px;">
                        <div class="chart-container" style="height: 400px;">
                            <h3 style="text-align: center; margin-bottom: 20px;">üìà Aylƒ±k Performans Trendi (Yƒ±l Kar≈üƒ±la≈ütƒ±rmalƒ±)</h3>
                            <canvas id="salespersonMonthlyChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Top 20 Products -->
                    <div id="salespersonTopProductsSection" style="margin-bottom: 40px;">
                        <h3 style="margin-bottom: 20px;">üéØ En √áok Sattƒ±ƒüƒ± √úr√ºnler (Top 20)</h3>
                        <div id="salespersonTopProductsTable" style="overflow-x: auto;"></div>
                    </div>
                    
                    <!-- Bottom 10 Products -->
                    <div id="salespersonBottomProductsSection" style="margin-bottom: 40px;">
                        <h3 style="margin-bottom: 20px;">‚ö†Ô∏è En Az Sattƒ±ƒüƒ± √úr√ºnler (Bottom 10)</h3>
                        <div id="salespersonBottomProductsTable" style="overflow-x: auto;"></div>
                    </div>
                    
                    <!-- AI Salesperson Analysis -->
                    <div id="salespersonAIAnalysisPanel" style="margin: 40px 0;">
                        <h3 style="margin-bottom: 20px;">ü§ñ AI Performans Analizi ve √ñneriler</h3>
                        <div id="salespersonAIAnalysisContent"></div>
                    </div>
                </div>
                
                <!-- No Results Message -->
                <div id="salespersonSearchNoResults" style="display: none; text-align: center; padding: 60px; background: #f8f9fa; border-radius: 15px;">
                    <div style="font-size: 4em; margin-bottom: 20px;">üîç</div>
                    <h3 style="color: #6c757d; margin-bottom: 10px;">Satƒ±≈ü Temsilcisi Bulunamadƒ±</h3>
                    <p style="color: #adb5bd;">L√ºtfen farklƒ± bir isim deneyin</p>
                </div>
            </div>
        </div>
        <!-- End Salesperson Analysis Tab -->

        <!-- Store Analysis Tab -->
        <div id="storeTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 30px;">üè™ Maƒüaza Performans Analizi</h2>
                
                <!-- Filters Section (Satƒ±≈ü Analizi ile aynƒ± yapƒ±) -->
                <div class="filters-section" style="margin-bottom: 30px;">
                    <div class="filters-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                        <div class="filter-group">
                            <label>Yƒ±l <span class="selected-count" id="countStoreYear"></span></label>
                            <div class="filter-search-box">
                                <input type="text" class="filter-search-input" placeholder="üîç Ara..." oninput="filterCheckboxes('filterStoreYear', this.value)">
                            </div>
                            <div class="checkbox-container" id="filterStoreYear"></div>
                        </div>
                        <div class="filter-group">
                            <label>Ay <span class="selected-count" id="countStoreMonth"></span></label>
                            <div class="filter-search-box">
                                <input type="text" class="filter-search-input" placeholder="üîç Ara..." oninput="filterCheckboxes('filterStoreMonth', this.value)">
                            </div>
                            <div class="checkbox-container" id="filterStoreMonth"></div>
                        </div>
                        <div class="filter-group">
                            <label>G√ºn <span class="selected-count" id="countStoreDay"></span></label>
                            <div class="filter-search-box">
                                <input type="text" class="filter-search-input" placeholder="üîç Ara..." oninput="filterCheckboxes('filterStoreDay', this.value)">
                            </div>
                            <div class="checkbox-container" id="filterStoreDay"></div>
                        </div>
                        <div class="filter-group">
                            <label>Kategori <span class="selected-count" id="countStoreCategory"></span></label>
                            <div class="filter-search-box">
                                <input type="text" class="filter-search-input" placeholder="üîç Ara..." oninput="filterCheckboxes('filterStoreCategory', this.value)">
                            </div>
                            <div class="checkbox-container" id="filterStoreCategory"></div>
                        </div>
                    </div>
                    <div style="text-align: center; margin-top: 20px;">
                        <button onclick="clearStoreFilters()" 
                                style="background: #6c757d; color: white; border: none; padding: 12px 30px; border-radius: 10px; cursor: pointer; font-weight: 600; transition: all 0.3s;">
                            üîÑ Filtreleri Temizle
                        </button>
                    </div>
                </div>
                
                <!-- Search Input with Multi-Select -->
                <div style="max-width: 800px; margin: 0 auto 40px;">
                    <!-- Selected Stores Tags -->
                    <div id="selectedStoresContainer" style="display: none; margin-bottom: 15px; padding: 15px; background: #f8f9fa; border-radius: 10px;">
                        <div style="display: flex; align-items: center; gap: 10px; flex-wrap: wrap;">
                            <span style="font-weight: 600; color: #667eea;">Se√ßili Maƒüazalar:</span>
                            <div id="selectedStoresTags" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                        </div>
                    </div>
                    
                    <div style="position: relative;">
                        <input type="text" id="storeSearchInput" placeholder="Maƒüaza adƒ± yazƒ±n... (√∂rn: Toptan, Akasya)" 
                               style="width: 100%; padding: 20px 60px 20px 20px; font-size: 1.1em; border: 2px solid #667eea; border-radius: 15px; outline: none;"
                               oninput="showStoreSuggestions(this.value)"
                               onkeydown="handleStoreKeydown(event)"
                               onfocus="showStoreSuggestions(this.value)">
                        <button onclick="searchStoreProfile()" 
                                style="position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; padding: 12px 25px; border-radius: 10px; cursor: pointer; font-size: 1em;">
                            üîç Ara
                        </button>
                        <div id="storeSuggestions" style="position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #667eea; border-top: none; border-radius: 0 0 15px 15px; max-height: 300px; overflow-y: auto; display: none; z-index: 1000; box-shadow: 0 4px 6px rgba(0,0,0,0.1);"></div>
                    </div>
                    <p style="text-align: center; color: #6c757d; margin-top: 10px; font-size: 0.9em;">
                        üí° ƒ∞pucu: Birden fazla maƒüaza se√ßerek kar≈üƒ±la≈ütƒ±rmalƒ± analiz yapabilirsiniz! (En fazla 3 maƒüaza)
                    </p>
                </div>
                
                <!-- Results Container -->
                <div id="storeProfileContainer" style="display: none;">
                    <!-- Multiple Stores Comparison View -->
                    <div id="multipleStoresView" style="display: none;">
                        <h2 style="margin-bottom: 30px; text-align: center;">üè™ Maƒüaza Kar≈üƒ±la≈ütƒ±rma Analizi</h2>
                        
                        <!-- Comparison Table -->
                        <div id="storeComparisonTableContainer" style="margin-bottom: 40px; overflow-x: auto;"></div>
                        
                        <!-- Comparison Charts -->
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; margin-bottom: 30px;">
                            <div class="chart-container">
                                <h3 style="text-align: center; margin-bottom: 20px;">üìä Toplam Satƒ±≈ü Kar≈üƒ±la≈ütƒ±rmasƒ±</h3>
                                <canvas id="comparisonStoreSalesChart"></canvas>
                            </div>
                            <div class="chart-container">
                                <h3 style="text-align: center; margin-bottom: 20px;">üì¶ Toplam Adet Kar≈üƒ±la≈ütƒ±rmasƒ±</h3>
                                <canvas id="comparisonStoreQtyChart"></canvas>
                            </div>
                        </div>
                        
                        <!-- Category Comparison by Store -->
                        <div id="storeComparisonCategorySection" style="margin: 40px 0;">
                            <h3 style="text-align: center; margin-bottom: 30px;">üìÇ Maƒüaza Bazƒ±nda Kategori Kar≈üƒ±la≈ütƒ±rmasƒ± (Kategori 1)</h3>
                            
                            <!-- Category Comparison Table -->
                            <div id="storeCategoryComparisonTableContainer" style="margin-bottom: 40px; overflow-x: auto;"></div>
                            
                            <!-- Category Charts (Gƒ∞ZLENDƒ∞ - Metrik tablo yeterli) -->
                            <div id="storeComparisonCategoryCharts" style="display: none;"></div>
                        </div>
                        
                        <!-- AI Comparison Analysis -->
                        <div id="multipleStoresAIPanel" style="margin: 40px 0;">
                            <div id="multipleStoresAIContent"></div>
                        </div>
                    </div>
                    
                    <!-- Single Store View -->
                    <div id="singleStoreView" style="display: none;">
                    <!-- Store Profile Header -->
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; border-radius: 20px; margin-bottom: 30px;">
                        <h2 style="margin: 0 0 20px 0; font-size: 2em;">üè™ <span id="storeName">-</span></h2>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px;">
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üí∞ Toplam Satƒ±≈ü (KDV Hari√ß)</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="storeTotalSales">$0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üì¶ Toplam Adet</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="storeTotalQty">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üõí Fatura Sayƒ±sƒ±</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="storeInvoiceCount">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üìä G√ºnl√ºk Ort. Satƒ±≈ü</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="storeAvgTransaction">$0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üõí Sepet Ortalamasƒ±</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="storeAvgBasket">$0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üë• Farklƒ± M√º≈üteri</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="storeUniqueCustomers">0</div>
                            </div>
                            <div>
                                <div style="opacity: 0.8; font-size: 0.9em;">üéØ Farklƒ± √úr√ºn</div>
                                <div style="font-size: 1.5em; font-weight: bold;" id="storeUniqueProducts">0</div>
                            </div>
                        </div>
                    </div>
                    <!-- End Single Store View -->
                    
                    <!-- Charts Grid (ORTAK - hem tek hem √ßoklu maƒüaza i√ßin) -->
                    <div id="storeBrandCategorySection" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; margin-bottom: 30px;">
                        <div class="chart-container">
                            <h3 id="storeBrandChartTitle" style="text-align: center; margin-bottom: 20px;">üè∑Ô∏è En √áok Satan Markalar (Top 10)</h3>
                            <canvas id="storeBrandChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 id="storeCategoryChartTitle" style="text-align: center; margin-bottom: 20px;">üìÇ En √áok Satan Kategoriler</h3>
                            <canvas id="storeCategoryChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 id="storeDistrictChartTitle" style="text-align: center; margin-bottom: 20px;">üìç En √áok Satƒ±≈ü Yapƒ±lan ƒ∞lk 5 ƒ∞l√ße</h3>
                            <canvas id="storeDistrictChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 id="storeSalespersonChartTitle" style="text-align: center; margin-bottom: 20px;">üë®‚Äçüíº Satƒ±≈ü Temsilcileri</h3>
                            <canvas id="storeSalespersonChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 id="storeMonthlyChartTitle" style="text-align: center; margin-bottom: 20px;">üìà Aylƒ±k Performans Trendi</h3>
                            <canvas id="storeMonthlyChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- Top 20 Products -->
                    <div id="storeTopProductsSection" style="margin-bottom: 40px;">
                        <h3 style="margin-bottom: 20px;">üéØ En √áok Satan √úr√ºnler (Top 20)</h3>
                        <div id="storeTopProductsTable" style="overflow-x: auto;"></div>
                    </div>
                    
                    <!-- AI Store Analysis -->
                    <div id="storeAIAnalysisPanel" style="margin: 40px 0;">
                        <h3 style="margin-bottom: 20px;">ü§ñ AI Performans Analizi ve √ñneriler</h3>
                        <div id="storeAIAnalysisContent"></div>
                    </div>
                    
                    <!-- Full Salesperson List -->
                    <div id="storeFullSalespersonSection" style="margin: 40px 0;">
                        <h3 style="margin-bottom: 20px;">üë• T√ºm Satƒ±≈ü Temsilcileri Detaylƒ± Performans Listesi</h3>
                        <div id="storeFullSalespersonTable" style="overflow-x: auto;"></div>
                    </div>
                </div>
                <!-- End storeProfileContainer -->
                
                <!-- No Results Message -->
                <div id="storeSearchNoResults" style="display: none; text-align: center; padding: 60px; background: #f8f9fa; border-radius: 15px;">
                    <div style="font-size: 4em; margin-bottom: 20px;">üîç</div>
                    <h3 style="color: #6c757d; margin-bottom: 10px;">Maƒüaza Bulunamadƒ±</h3>
                    <p style="color: #adb5bd;">L√ºtfen farklƒ± bir isim deneyin</p>
                </div>
                </div>
            </div>
        </div>
        <!-- End Store Analysis Tab -->

        <!-- City Analysis Tab -->
        <div id="cityTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 30px;">üåç ≈ûehir Bazlƒ± Satƒ±≈ü Analizi</h2>
                <div style="background: #e3f2fd; border-left: 4px solid #2196f3; padding: 15px; margin-bottom: 20px; border-radius: 5px;">
                    <p style="margin: 0; color: #1565c0; font-size: 0.95em;">
                        üí° <strong>ƒ∞pucu:</strong> Tarih aralƒ±ƒüƒ± se√ßmek zorunlu deƒüil, istenirse t√ºm d√∂nem veya belirli tarih aralƒ±ƒüƒ± i√ßin analiz yapabilirsiniz.
                    </p>
                </div>
                
                <!-- City Selection & Date Filters -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; margin-bottom: 40px;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr 1fr 1fr auto; gap: 20px; align-items: end;">
                        <div>
                            <label style="color: white; display: block; margin-bottom: 8px; font-weight: 600;">üìç ≈ûehir Se√ßin</label>
                            <select id="citySelect" onchange="handleCityChange()" 
                                    style="width: 100%; padding: 15px; font-size: 1.1em; border: none; border-radius: 10px; outline: none;">
                                <option value="">-- ≈ûehir Se√ßin --</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: white; display: block; margin-bottom: 8px; font-weight: 600;">üèòÔ∏è ƒ∞l√ße Se√ßin <small style="opacity: 0.8;">(Opsiyonel)</small></label>
                            <select id="districtSelect" onchange="analyzeCityPerformance()" 
                                    style="width: 100%; padding: 15px; font-size: 1.1em; border: none; border-radius: 10px; outline: none;" disabled>
                                <option value="">-- √ñnce ≈ûehir Se√ßin --</option>
                            </select>
                        </div>
                        <div>
                            <label style="color: white; display: block; margin-bottom: 8px; font-weight: 600;">üìÖ Ba≈ülangƒ±√ß Tarihi</label>
                            <input type="date" id="cityDateStart" onchange="analyzeCityPerformance()"
                                   style="width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 1em;">
                        </div>
                        <div>
                            <label style="color: white; display: block; margin-bottom: 8px; font-weight: 600;">üìÖ Biti≈ü Tarihi</label>
                            <input type="date" id="cityDateEnd" onchange="analyzeCityPerformance()"
                                   style="width: 100%; padding: 15px; border: none; border-radius: 10px; font-size: 1em;">
                        </div>
                        <div>
                            <button onclick="clearCityFilters()" 
                                    style="padding: 15px 30px; background: white; color: #667eea; border: none; border-radius: 10px; font-weight: 600; cursor: pointer; white-space: nowrap;">
                                üóëÔ∏è Temizle
                            </button>
                        </div>
                    </div>
                </div>
                
                <!-- City Results Container -->
                <div id="cityAnalysisContainer" style="display: none;">
                    <!-- City Summary Cards -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 30px;">
                        <div class="summary-card">
                            <h3 style="font-size: 1em; margin-bottom: 10px;">üí∞ Toplam Satƒ±≈ü (KDV Hari√ß)</h3>
                            <p id="cityTotalSales" style="font-size: 1.8em; font-weight: bold;">$0</p>
                        </div>
                        <div class="summary-card">
                            <h3 style="font-size: 1em; margin-bottom: 10px;">üì¶ Toplam Adet</h3>
                            <p id="cityTotalQty" style="font-size: 1.8em; font-weight: bold;">0</p>
                        </div>
                        <div class="summary-card">
                            <h3 style="font-size: 1em; margin-bottom: 10px;">üë• M√º≈üteri Sayƒ±sƒ±</h3>
                            <p id="cityCustomerCount" style="font-size: 1.8em; font-weight: bold;">0</p>
                        </div>
                        <div class="summary-card">
                            <h3 style="font-size: 1em; margin-bottom: 10px;">üìä Ortalama Sepet</h3>
                            <p id="cityAvgBasket" style="font-size: 1.8em; font-weight: bold;">$0</p>
                        </div>
                        <div class="summary-card">
                            <h3 style="font-size: 1em; margin-bottom: 10px;">üìÖ G√ºnl√ºk Ortalama</h3>
                            <p id="cityDailyAverage" style="font-size: 1.8em; font-weight: bold;">$0</p>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <h3 style="font-size: 1em; margin-bottom: 10px; color: white;">üèôÔ∏è N√ºfus (2024)</h3>
                            <p id="cityPopulation" style="font-size: 1.8em; font-weight: bold; color: white;">-</p>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white;">
                            <h3 style="font-size: 1em; margin-bottom: 10px; color: white;">üë§ Ki≈üi Ba≈üƒ± Satƒ±≈ü</h3>
                            <p id="cityPerCapitaSales" style="font-size: 1.8em; font-weight: bold; color: white;">$0</p>
                            <small style="opacity: 0.9; font-size: 0.85em;">Toplam Satƒ±≈ü / N√ºfus</small>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); color: white; grid-column: span 1;">
                            <h3 style="font-size: 0.95em; margin-bottom: 10px;">üë§ Top 5 Temsilci</h3>
                            <div id="cityTopSalespersons" style="color: white; font-size: 0.85em; line-height: 1.6; max-height: 120px; overflow-y: auto;"></div>
                        </div>
                        <div class="summary-card" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; grid-column: span 1;">
                            <h3 style="font-size: 0.95em; margin-bottom: 10px;">üè™ Top 5 Maƒüaza</h3>
                            <div id="cityTopStores" style="color: white; font-size: 0.85em; line-height: 1.6; max-height: 120px; overflow-y: auto;"></div>
                        </div>
                    </div>
                    
                    <!-- Charts Grid -->
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(450px, 1fr)); gap: 30px; margin-bottom: 30px;">
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">üè∑Ô∏è En √áok Satƒ±lan Markalar</h3>
                            <canvas id="cityBrandChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">üé∏ En √áok Satƒ±lan √úr√ºnler</h3>
                            <canvas id="cityProductChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">üìÇ En √áok Satƒ±lan Kategoriler</h3>
                            <canvas id="cityCategoryChart"></canvas>
                        </div>
                        <div class="chart-container">
                            <h3 style="text-align: center; margin-bottom: 20px;">üìà Aylƒ±k Performans Trendi (Yƒ±l Kar≈üƒ±la≈ütƒ±rmalƒ±)</h3>
                            <canvas id="cityYearlyChart"></canvas>
                        </div>
                    </div>
                    
                    <!-- AI City Analysis -->
                    <div id="cityAIAnalysisPanel" style="margin: 40px 0;">
                        <h3 style="margin-bottom: 20px;">ü§ñ AI ≈ûehir Analizi ve √ñneriler</h3>
                        <div id="cityAIAnalysisContent"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End City Analysis Tab -->

        <!-- Stock Distribution Tab -->
        <div id="stockTab" class="tab-content">
            <div class="content">
                <h2 style="margin-bottom: 30px;">üì¶ Stok Daƒüƒ±lƒ±m Analizi</h2>
                
                <!-- Tarih Filtresi -->
                <div style="max-width: 1000px; margin: 0 auto 30px;">
                    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 20px; border-radius: 15px; color: white;">
                        <h3 style="margin-bottom: 15px;">üìÖ Tarih Aralƒ±ƒüƒ± Filtresi (Opsiyonel)</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr auto; gap: 15px; align-items: end;">
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; opacity: 0.9;">Ba≈ülangƒ±√ß Tarihi:</label>
                                <input type="date" id="stockDateStart" 
                                       style="width: 100%; padding: 10px; border: none; border-radius: 8px; font-size: 1em;">
                            </div>
                            <div>
                                <label style="display: block; margin-bottom: 5px; font-size: 0.9em; opacity: 0.9;">Biti≈ü Tarihi:</label>
                                <input type="date" id="stockDateEnd" 
                                       style="width: 100%; padding: 10px; border: none; border-radius: 8px; font-size: 1em;">
                            </div>
                            <div>
                                <button onclick="clearStockDateFilters()" 
                                        style="padding: 10px 20px; background: rgba(255,255,255,0.2); color: white; border: 2px solid white; border-radius: 8px; cursor: pointer; font-size: 1em;">
                                    üîÑ Temizle
                                </button>
                            </div>
                        </div>
                        <p style="margin-top: 10px; font-size: 0.85em; opacity: 0.8;">
                            üí° Tarih se√ßmezseniz t√ºm satƒ±≈ü verileri kullanƒ±lƒ±r
                        </p>
                    </div>
                </div>
                
                <!-- Stock Input Methods -->
                <div style="max-width: 1000px; margin: 0 auto;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px;">
                        <!-- Excel Upload -->
                        <div style="background: #f8f9fa; padding: 30px; border-radius: 15px;">
                            <h3 style="margin-bottom: 20px;">üìÑ Excel ile Toplu Y√ºkleme</h3>
                            <p style="color: #6c757d; margin-bottom: 15px;">Excel formatƒ±: <strong>√úr√ºn Kodu | Stok Miktarƒ±</strong></p>
                            <input type="file" id="stockExcelInput" accept=".xlsx,.xls" 
                                   style="display: none;" onchange="handleStockExcelUpload(event)">
                            <button onclick="document.getElementById('stockExcelInput').click()" 
                                    style="width: 100%; padding: 15px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1em;">
                                üìÇ Excel Dosyasƒ± Se√ß
                            </button>
                            <p style="color: #6c757d; margin-top: 10px; font-size: 0.9em;">Max 5 MB, .xlsx veya .xls</p>
                        </div>
                        
                        <!-- Manual Entry -->
                        <div style="background: #f8f9fa; padding: 30px; border-radius: 15px;">
                            <h3 style="margin-bottom: 20px;">‚úèÔ∏è Manuel Giri≈ü</h3>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">√úr√ºn Kodu:</label>
                                <input type="text" id="manualProductCode" placeholder="√∂rn: KDP120R" 
                                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <div style="margin-bottom: 15px;">
                                <label style="display: block; margin-bottom: 5px; font-weight: bold;">Stok Miktarƒ±:</label>
                                <input type="number" id="manualStockQty" placeholder="√∂rn: 25" min="0"
                                       style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 5px;">
                            </div>
                            <button onclick="addManualStock()" 
                                    style="width: 100%; padding: 15px; background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1em;">
                                ‚ûï Stok Ekle
                            </button>
                        </div>
                    </div>
                    
                    <!-- Current Stock List -->
                    <div id="stockListContainer" style="display: none; margin-bottom: 40px;">
                        <h3 style="margin-bottom: 20px;">üìã Mevcut Stok Listesi</h3>
                        <div id="stockListTable" style="overflow-x: auto;"></div>
                        <div style="margin-top: 20px; text-align: center;">
                            <button onclick="analyzeStockDistribution()" 
                                    style="padding: 15px 40px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1em; margin-right: 10px;">
                                ü§ñ AI Daƒüƒ±lƒ±m √ñnerisi Al
                            </button>
                            <button onclick="clearStockList()" 
                                    style="padding: 15px 40px; background: #dc3545; color: white; border: none; border-radius: 10px; cursor: pointer; font-size: 1.1em;">
                                üóëÔ∏è Listeyi Temizle
                            </button>
                        </div>
                    </div>
                    
                    <!-- AI Distribution Recommendations -->
                    <div id="stockDistributionResults" style="display: none;">
                        <h3 style="margin-bottom: 20px;">ü§ñ AI Stok Daƒüƒ±lƒ±m √ñnerileri</h3>
                        <div id="stockDistributionContent"></div>
                    </div>
                </div>
            </div>
        </div>
        <!-- End Stock Distribution Tab -->

    </div>

    <script>
        // Sayfa y√ºklendiƒüinde kullanƒ±cƒ± adƒ±nƒ± g√∂ster
        window.addEventListener('DOMContentLoaded', function() {
            const username = sessionStorage.getItem('username');
            if (username) {
                document.getElementById('currentUserName').textContent = username.charAt(0).toUpperCase() + username.slice(1);
            }
        });

        // √áƒ±kƒ±≈ü fonksiyonu
        function logout() {
            if (confirm('√áƒ±kƒ±≈ü yapmak istediƒüinizden emin misiniz?')) {
                // Session ve local storage'ƒ± temizle
                sessionStorage.clear();
                localStorage.clear();
                
                // Authentication formunu g√∂ster
                showAuthForm();
                
                console.log('‚úÖ √áƒ±kƒ±≈ü yapƒ±ldƒ±');
            }
        }

        let inventoryData = null; // Envanter verileri
        let inventoryCharts = {}; // Envanter grafikleri
        let stockLocations = {}; // Stok konumu ve maƒüaza e≈üle≈ümesi
        
        // Global Satƒ±≈ü Kanalƒ± Filtresi State
        let activeChannels = {
            all: true,
            retail: false,
            wholesale: false,
            online: false,
            corporate: false,
            central: false
        };
        
        // Ger√ßek veri y√ºkleme takibi
        let dataLoadProgress = {
            pageInit: false,
            dataFiles: false,
            targets: false,
            ready: false
        };
        
        // ƒ∞ndirim √ºr√ºnlerini tespit eden yardƒ±mcƒ± fonksiyon
        function isDiscountProduct(item) {
            const productName = (item.product || '').toLowerCase();
            return productName.includes('[disc]') ||
                   productName.includes('indirim') || 
                   productName.includes('discount') ||
                   productName.includes('toplam tutarda indirim');
        }
        
        // ƒ∞ndirim √ºr√ºnlerinin tutarƒ±nƒ± negatif yapan fonksiyon
        function applyDiscountLogic(item) {
            if (isDiscountProduct(item)) {
                // ƒ∞ndirim √ºr√ºnleri i√ßin tutar negatif, miktar pozitif
                return {
                    ...item,
                    usd_amount: -Math.abs(parseFloat(item.usd_amount || 0)),
                    quantity: Math.abs(parseFloat(item.quantity || 0)),
                    _isDiscount: true  // ƒ∞ndirim i≈üareti ekle (filtreleme i√ßin)
                };
            }
            return item;
        }
        
        // Hedefler artƒ±k targets.json'dan y√ºkleniyor (Google Sheets kaldƒ±rƒ±ldƒ±)
        
        // MAƒûAZA √áALI≈ûMA SAATLERƒ∞ VE KAPALILIKLARI
        const STORE_WORKING_HOURS = {
            // √ñzel saatli maƒüazalar (10:00-20:00, Pazar kapalƒ±)
            'T√ºnel': { openHour: 10, closeHour: 20, closedDays: [0] }, // 0 = Pazar
            'ƒ∞zmir': { openHour: 10, closeHour: 20, closedDays: [0] },
            'Antalya': { openHour: 10, closeHour: 20, closedDays: [0] },
            'Kƒ±zƒ±lay': { openHour: 10, closeHour: 20, closedDays: [0] },
            // Default: T√ºm diƒüer maƒüazalar (10:00-22:00, 7 g√ºn a√ßƒ±k)
            'default': { openHour: 10, closeHour: 22, closedDays: [] }
        };
        
        // Maƒüaza √ßalƒ±≈üma saatlerini kontrol eden fonksiyon
        function getStoreWorkingHours(storeName) {
            // Maƒüaza adƒ±nƒ± temizle (kodlarƒ± kaldƒ±r)
            const cleanName = storeName.replace(/\[.*?\]\s*/g, '').trim();
            
            // √ñzel maƒüazalarda arama yap (kƒ±smi e≈üle≈üme)
            for (const [key, hours] of Object.entries(STORE_WORKING_HOURS)) {
                if (key !== 'default' && cleanName.toLowerCase().includes(key.toLowerCase())) {
                    return hours;
                }
            }
            
            // Bulunamazsa default d√∂nd√ºr
            return STORE_WORKING_HOURS.default;
        }
        
        // Satƒ±≈ü verisinin √ßalƒ±≈üma saatleri i√ßinde olup olmadƒ±ƒüƒ±nƒ± kontrol eden fonksiyon
        function isWithinWorkingHours(item) {
            const hours = getStoreWorkingHours(item.store || '');
            const hour = item.create_hour;
            const dayOfWeek = item.day_of_week;
            
            // G√ºn kontrol√º (kapalƒ± g√ºn m√º?)
            if (dayOfWeek !== undefined && dayOfWeek !== null) {
                const dayIndex = (dayOfWeek + 1) % 7; // 0=Pazar, 1=Pazartesi, ...
                if (hours.closedDays.includes(dayIndex)) {
                    return false; // Kapalƒ± g√ºn
                }
            }
            
            // Saat kontrol√º (√ßalƒ±≈üma saatleri i√ßinde mi?)
            if (hour !== undefined && hour !== null) {
                if (hour < hours.openHour || hour >= hours.closeHour) {
                    return false; // √áalƒ±≈üma saatleri dƒ±≈üƒ±nda
                }
            }
            
            return true; // √áalƒ±≈üma saatleri i√ßinde
        }
        
        // Google Sheets fonksiyonu kaldƒ±rƒ±ldƒ± - artƒ±k targets.json kullanƒ±lƒ±yor

        // GZIP Decompression ve Yƒ±l Y√ºkleme Fonksiyonlarƒ±
        async function loadStockLocations() {
            try {
                const response = await fetch('data/stock-locations.json');
                if (!response.ok) throw new Error('Stock locations y√ºklenemedi');
                const data = await response.json();
                stockLocations = data.stock_locations || {};
                console.log('‚úÖ Stok konumlarƒ± y√ºklendi:', Object.keys(stockLocations).length, 'lokasyon');
                return stockLocations;
            } catch (error) {
                console.error('‚ùå Stock locations hatasƒ±:', error);
                return {};
            }
        }

        // Maƒüaza ismini normalize eden fonksiyon (stock-locations mapping i√ßin)
        function normalizeStoreName(storeName) {
            if (!storeName) return '';
            
            // K√º√ß√ºk harfe √ßevir ve bo≈üluklarƒ± temizle
            const normalized = storeName.toLowerCase().trim();
            
            // Mapping tablosu (satƒ±≈ü verisindeki maƒüaza isimleri -> stock-locations'daki deƒüerler)
            const storeMapping = {
                'kentpark': 'KENTPARK',
                'akasya': 'AKASYA',
                't√ºnel': 'T√úNEL',
                'izmir': 'ƒ∞zmir',
                'kƒ±zƒ±lay': 'KIZILAY',
                'hilltown': 'Hilltown',
                'kanyon': 'KANYON',
                'antalya': 'ANTALYA',
                'adana': 'ADANA',
                'bursa': 'BURSA',
                'uniq': 'UNIQ',
                'mavibah√ße': 'MAVƒ∞BAH√áE',
                'temaworld': 'TEMAWORLD',
                'bodrum': 'BODRUM',
                'outlet': 'OUTLET'
            };
            
            // E≈üle≈üme ara
            for (const [key, value] of Object.entries(storeMapping)) {
                if (normalized.includes(key)) {
                    return value;
                }
            }
            
            return storeName; // E≈üle≈üme yoksa orijinal ismi d√∂nd√ºr
        }

        // Belirli bir maƒüaza ve √ºr√ºn i√ßin mevcut stok miktarƒ±nƒ± hesaplayan fonksiyon
        function getCurrentStock(storeName, productCode) {
            if (!inventoryData || inventoryData.length === 0) {
                return 0;
            }
            
            // Maƒüaza ismini normalize et
            const normalizedStore = normalizeStoreName(storeName);
            
            // stock-locations'da bu maƒüazaya kar≈üƒ±lƒ±k gelen location_id'leri bul
            const matchingLocations = [];
            for (const [locationId, mappedStore] of Object.entries(stockLocations)) {
                if (mappedStore === normalizedStore) {
                    matchingLocations.push(locationId);
                }
            }
            
            if (matchingLocations.length === 0) {
                console.warn(`‚ö†Ô∏è "${storeName}" i√ßin stok konumu bulunamadƒ±`);
                return 0;
            }
            
            // Inventory verilerinde bu lokasyonlarda ve bu √ºr√ºnde ne kadar stok var?
            let totalStock = 0;
            inventoryData.forEach(item => {
                const itemLocation = item.location || '';
                const itemProduct = (item.product_name || item.product || '').toLowerCase();
                const searchProduct = productCode.toLowerCase();
                
                // Lokasyon e≈üle≈ümesi ve √ºr√ºn e≈üle≈ümesi
                if (matchingLocations.includes(itemLocation) && itemProduct.includes(searchProduct)) {
                    totalStock += parseFloat(item.quantity || 0);
                }
            });
            
            return totalStock;
        }

        async function loadYearData(year) {
            // √áift y√ºkleme √∂nleme kontrol√º
            if (loadedYears.has(year) && loadedDataCache[year]) {
                console.log(`‚è≠Ô∏è ${year} zaten y√ºkl√º, cache'den d√∂nd√ºr√ºl√ºyor...`);
                // Cache'den veriyi d√∂nd√ºr
                return loadedDataCache[year];
            }
            
            // Hemen ekle - race condition √∂nleme
            loadedYears.add(year);
            
            try {
                console.log(`üì¶ ${year} y√ºkleniyor...`);
                
                // GZIP dosyasƒ±nƒ± indir - Akƒ±llƒ± Cache ile
                const version = getDailyVersion(); // G√ºnl√ºk versiyon
                const response = await fetch(`data-${year}.json.gz?v=${version}`, {
                    headers: {
                        'Cache-Control': 'public, max-age=86400' // 24 saat cache
                    }
                });
                if (!response.ok) throw new Error(`${year} verisi bulunamadƒ±`);
                
                // ArrayBuffer olarak al
                const arrayBuffer = await response.arrayBuffer();
                
                // GZIP a√ßma - Evrensel y√∂ntem
                let decompressed;
                
                // Y√∂ntem 1: DecompressionStream (modern tarayƒ±cƒ±lar)
                if (typeof DecompressionStream !== 'undefined') {
                    try {
                        const blob = new Blob([arrayBuffer]);
                        const ds = new DecompressionStream('gzip');
                        const stream = blob.stream().pipeThrough(ds);
                        decompressed = await new Response(stream).text();
                    } catch (e) {
                        console.warn('DecompressionStream ba≈üarƒ±sƒ±z, pako kullanƒ±lƒ±yor:', e);
                        // Fallback to pako
                        const uint8Array = new Uint8Array(arrayBuffer);
                        const decompressedArray = pako.inflate(uint8Array);
                        decompressed = new TextDecoder().decode(decompressedArray);
                    }
                }
                // Y√∂ntem 2: Pako.js (t√ºm tarayƒ±cƒ±lar i√ßin fallback)
                else {
                    if (typeof pako === 'undefined') {
                        throw new Error('GZIP a√ßma k√ºt√ºphanesi y√ºklenmedi. L√ºtfen sayfayƒ± yenileyin.');
                    }
                    const uint8Array = new Uint8Array(arrayBuffer);
                    const decompressedArray = pako.inflate(uint8Array);
                    decompressed = new TextDecoder().decode(decompressedArray);
                }
                
                // JSON'a √ßevir
                const yearData = JSON.parse(decompressed);
                
                console.log(`‚úÖ ${year} y√ºklendi: ${yearData?.details?.length || 0} kayƒ±t`);
                if (!yearData?.details) {
                    console.warn(`‚ö†Ô∏è ${year} verisi bo≈ü veya ge√ßersiz`);
                }
                
                // Cache'e kaydet
                loadedDataCache[year] = yearData;
                
                // loadedYears.add(year) zaten fonksiyon ba≈üƒ±nda yapƒ±ldƒ±
                return yearData;
                
            } catch (error) {
                console.error(`‚ùå ${year} y√ºkleme hatasƒ±:`, error);
                throw error;
            }
        }

        // Hedefleri y√ºkle (GitHub'dan - Kalƒ±cƒ± √ß√∂z√ºm)
        let centralTargets = {yearly: {}, monthly: {}};
        
        async function loadCentralTargets() {
            try {
                console.log('üéØ Merkezi hedefler y√ºkleniyor...');
                const response = await fetch('data/targets.json?' + Date.now()); // Cache bypass
                if (response.ok) {
                    centralTargets = await response.json();
                    console.log('‚úÖ Merkezi hedefler y√ºklendi:', centralTargets);
                    
                    // Loading progress'i g√ºncelle
                    dataLoadProgress.targets = true;
                    checkLoadingComplete();
                    
                    return true;
                } else {
                    console.warn('‚ö†Ô∏è targets.json y√ºklenemedi, varsayƒ±lan hedefler kullanƒ±lacak');
                    return false;
                }
            } catch (error) {
                console.error('‚ùå Hedef y√ºkleme hatasƒ±:', error);
                return false;
            }
        }

        // Global Kanal Filtresi Fonksiyonu (window scope'una ekle)
        window.handleChannelFilter = function(clickedId) {
            console.log('üîÑ handleChannelFilter √ßaƒürƒ±ldƒ±, tƒ±klanan:', clickedId);
            console.log('üìä baseData boyutu:', baseData.length);
            console.log('üìä allData boyutu:', allData.length);
            
            const channelAll = document.getElementById('channelAll').checked;
            const channelRetail = document.getElementById('channelRetail').checked;
            const channelWholesale = document.getElementById('channelWholesale').checked;
            const channelOnline = document.getElementById('channelOnline').checked;
            const channelCorporate = document.getElementById('channelCorporate').checked;
            const channelCentral = document.getElementById('channelCentral').checked;
            
            console.log('‚úÖ Checkbox durumlarƒ±:', {channelAll, channelRetail, channelWholesale, channelOnline, channelCorporate, channelCentral});
            
            // Eƒüer T√ºm√º tƒ±klandƒ±ysa, diƒüerlerini kapat
            if (clickedId === 'channelAll' && channelAll) {
                document.getElementById('channelRetail').checked = false;
                document.getElementById('channelWholesale').checked = false;
                document.getElementById('channelOnline').checked = false;
                document.getElementById('channelCorporate').checked = false;
                document.getElementById('channelCentral').checked = false;
                activeChannels = {all: true, retail: false, wholesale: false, online: false, corporate: false, central: false};
            }
            // Eƒüer diƒüer bir kanal tƒ±klandƒ±ysa, T√ºm√º'y√º kapat
            else if (clickedId !== 'channelAll' && (channelRetail || channelWholesale || channelOnline || channelCorporate || channelCentral)) {
                document.getElementById('channelAll').checked = false;
                activeChannels = {
                    all: false,
                    retail: channelRetail,
                    wholesale: channelWholesale,
                    online: channelOnline,
                    corporate: channelCorporate,
                    central: channelCentral
                };
            }
            // Hi√ßbiri se√ßili deƒüilse T√ºm√º'y√º aktif et
            else if (!channelAll && !channelRetail && !channelWholesale && !channelOnline && !channelCorporate && !channelCentral) {
                document.getElementById('channelAll').checked = true;
                activeChannels = {all: true, retail: false, wholesale: false, online: false, corporate: false, central: false};
            }
            // Sadece T√ºm√º kapatƒ±ldƒ±ysa hi√ßbir ≈üey yapma (diƒüerleri zaten kapalƒ±)
            else if (clickedId === 'channelAll' && !channelAll) {
                document.getElementById('channelAll').checked = true;
                activeChannels = {all: true, retail: false, wholesale: false, online: false, corporate: false, central: false};
            }
            
            // Veriyi filtrele
            applyChannelFilter();
        };
        
        function applyChannelFilter() {
            console.log('üè¢ applyChannelFilter ba≈üladƒ±');
            console.log('üìä activeChannels:', activeChannels);
            console.log('üìä baseData uzunluk:', baseData.length);
            
            // Spinner'ƒ± g√∂ster
            const spinner = document.getElementById('channelLoadingSpinner');
            const loadingText = document.getElementById('channelLoadingText');
            spinner.style.display = 'flex';
            
            // Hangi kanal se√ßiliyse onu g√∂ster
            const channelNames = {
                retail: 'üè™ Perakende',
                wholesale: 'üì¶ Toptan Satƒ±≈ü',
                online: 'üåê Online Satƒ±≈ü',
                corporate: 'üè¢ Kurumsal Satƒ±≈ü',
                central: 'üèõÔ∏è Merkezi Satƒ±≈ü'
            };
            
            let activeChannelName = 'T√ºm Kanallar';
            if (!activeChannels.all) {
                const active = Object.keys(activeChannels).filter(key => activeChannels[key] && key !== 'all');
                activeChannelName = active.map(key => channelNames[key]).join(' + ');
            }
            
            loadingText.textContent = `üîÑ ${activeChannelName} verileri y√ºkleniyor...`;
            
            // Filtrelemeyi setTimeout ile geciktir - UI'ƒ±n g√ºncellenmesi i√ßin
            setTimeout(() => {
                // T√ºm√º se√ßiliyse t√ºm veriyi kullan
                if (activeChannels.all) {
                    allData = [...baseData];
                    console.log('‚úÖ T√ºm√º se√ßili, allData uzunluk:', allData.length);
                    document.getElementById('channelFilterInfo').textContent = 'üìä Aktif: T√ºm Kanallar (19)';
                } else {
                // Se√ßili kanallara g√∂re filtrele
                const selectedChannels = [];
                
                if (activeChannels.retail) {
                    // 14 perakende maƒüaza
                    allData = baseData.filter(item => 
                        item.store && item.store.toLowerCase().includes('perakende')
                    );
                    selectedChannels.push('Perakende');
                }
                
                if (activeChannels.wholesale) {
                    const wholesaleData = baseData.filter(item => 
                        item.store && item.store.toLowerCase().includes('toptan')
                    );
                    allData = activeChannels.retail ? [...allData, ...wholesaleData] : wholesaleData;
                    selectedChannels.push('Toptan');
                }
                
                if (activeChannels.online) {
                    const onlineData = baseData.filter(item => 
                        item.store && item.store.toLowerCase().includes('online')
                    );
                    allData = (activeChannels.retail || activeChannels.wholesale) ? [...allData, ...onlineData] : onlineData;
                    selectedChannels.push('Online');
                }
                
                if (activeChannels.corporate) {
                    const corporateData = baseData.filter(item => 
                        item.store && item.store.toLowerCase().includes('kurumsal')
                    );
                    allData = (activeChannels.retail || activeChannels.wholesale || activeChannels.online) ? [...allData, ...corporateData] : corporateData;
                    selectedChannels.push('Kurumsal');
                }
                
                if (activeChannels.central) {
                    const centralData = baseData.filter(item => 
                        item.store && item.store.toLowerCase().includes('merkezi')
                    );
                    allData = (activeChannels.retail || activeChannels.wholesale || activeChannels.online || activeChannels.corporate) ? [...allData, ...centralData] : centralData;
                    selectedChannels.push('Merkezi');
                }
                
                document.getElementById('channelFilterInfo').textContent = `üìä Aktif: ${selectedChannels.join(' + ')} (${allData.length.toLocaleString('tr-TR')} kayƒ±t)`;
            }
            
            filteredData = [...allData];
            
            // T√úM SAYFA YENƒ∞DEN HESAPLANIYOR!
            updateAfterChannelFilter();
            }, 100); // 100ms gecikme - UI'ƒ±n spinner'ƒ± g√∂stermesi i√ßin
        }
        
        function updateAfterChannelFilter() {
            // Info kartlarƒ±nƒ± g√ºncelle
            document.getElementById('totalRecords').textContent = allData.length.toLocaleString('tr-TR');
            const totalUSD = allData.reduce((sum, item) => sum + (parseFloat(item.usd_amount) || 0), 0);
            document.getElementById('totalUSD').textContent = '$' + totalUSD.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // G√ºnl√ºk Ortalama Hesapla
            const uniqueDates = [...new Set(allData.map(item => item.date))];
            const dailyAverage = uniqueDates.length > 0 ? totalUSD / uniqueDates.length : 0;
            document.getElementById('dailyAverage').textContent = '$' + dailyAverage.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // Sepet Ortalamasƒ± Hesapla (Toplam USD / Satƒ±≈ü Fatura Sayƒ±sƒ± - ƒ∞adeler Hari√ß)
            const uniqueInvoices = new Set(allData.filter(item => item.move_type === 'out_invoice').map(item => item.move_name).filter(Boolean)).size;
            const basketAverage = uniqueInvoices > 0 ? totalUSD / uniqueInvoices : 0;
            document.getElementById('basketAverage').textContent = '$' + basketAverage.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            // Filtreleri yeniden doldur
            populateFilters();
            updateSummary();
            
            // Dashboard'ƒ± yenile
            loadDashboard();
            
            // M√º≈üteri analizini yenile
            analyzeCustomers();
            
            // Hedef takibini yenile
            loadAllStoresTargets();
            
            // Spinner'ƒ± gizle
            setTimeout(() => {
                document.getElementById('channelLoadingSpinner').style.display = 'none';
            }, 500); // T√ºm i≈ülemler bittikten 500ms sonra kapat
        }
        
        
        // T√úM YILLARI PARALEL Y√úKLE (ƒ∞lk giri≈üte hepsi)
        async function loadAllYearsData(metadata) {
            try {
                console.log(`üìÖ T√ºm yƒ±llar y√ºkleniyor: ${metadata.years.join(', ')}`);
                
                // T√ºm yƒ±llarƒ± paralel olarak y√ºkle
                const yearPromises = metadata.years.map(year => loadYearData(year));
                const yearResults = await Promise.all(yearPromises);
                
                // T√ºm verileri birle≈ütir
                let allRawData = [];
                let totalRecords = 0;
                
                for (let i = 0; i < metadata.years.length; i++) {
                    const year = metadata.years[i];
                    const yearData = yearResults[i];
                    
                    if (yearData?.details && yearData.details.length > 0) {
                        console.log(`‚úÖ ${year} yƒ±lƒ± y√ºklendi: ${yearData.details.length} kayƒ±t`);
                        allRawData = allRawData.concat(yearData.details);
                        totalRecords += yearData.details.length;
                    } else {
                        console.warn(`‚ö†Ô∏è ${year} yƒ±lƒ±nda veri bulunamadƒ±`);
                    }
                }
                
                console.log(`üìä Toplam y√ºklenen kayƒ±t: ${totalRecords}`);
                
                if (allRawData.length === 0) {
                    console.error('‚ùå Hi√ßbir yƒ±lda veri bulunamadƒ±!');
                    return;
                }
                
                // T√ºm verileri i≈üle
                allData = allRawData.map(item => applyDiscountLogic(item));
                baseData = [...allData];
                const discountProducts = allData.filter(item => isDiscountProduct(item));
                filteredData = [...allData];
                
                console.log(`üí∞ ${discountProducts.length} indirim √ºr√ºn√º negatif deƒüer olarak i≈ülendi (toplam kayƒ±t: ${allRawData.length})`);
                
                // Update info cards
                const latestYear = metadata.years[metadata.years.length - 1]; // En son yƒ±l
                document.getElementById('dataStatus').innerHTML = `<span class="status-badge status-success">‚úÖ ${latestYear}</span>`;
                document.getElementById('lastUpdate').textContent = metadata.last_update || '-';
                document.getElementById('totalRecords').textContent = allData.length.toLocaleString('tr-TR');
                
                // Calculate total USD
                let totalUSD = 0;
                if (allData && Array.isArray(allData)) {
                    totalUSD = allData.reduce((sum, item) => sum + (parseFloat(item.usd_amount) || 0), 0);
                }
                document.getElementById('totalUSD').textContent = '$' + totalUSD.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                // G√ºnl√ºk Ortalama Hesapla
                const uniqueDates = [...new Set(allData.map(item => item.date))];
                const dailyAverage = uniqueDates.length > 0 ? totalUSD / uniqueDates.length : 0;
                document.getElementById('dailyAverage').textContent = '$' + dailyAverage.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                // Sepet Ortalamasƒ± Hesapla (Toplam USD / Fatura Sayƒ±sƒ±)
                const uniqueInvoices = new Set(allData.map(item => item.move_name).filter(Boolean)).size;
                const basketAverage = uniqueInvoices > 0 ? totalUSD / uniqueInvoices : 0;
                document.getElementById('basketAverage').textContent = '$' + basketAverage.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                
                populateFilters();
                updateSummary();
                renderTable();
                
                // YENƒ∞ HEDEF Sƒ∞STEMƒ∞: loadAllStoresTargets() kullanƒ±lƒ±yor
                // Eski hedef sistemi (loadYearlyTarget, loadMonthlyTarget) kaldƒ±rƒ±ldƒ±
                
                // Satƒ±≈ü temsilcisi ve maƒüaza yƒ±l filtrelerini doldur
                populateSalespersonYearFilter();
                populateStoreYearFilter();
                
                // √úr√ºn filtrelerini initialize et
                initializeProductFilters();
                
                // Dashboard'ƒ± y√ºkle - veri tamamen y√ºklendikten sonra
                console.log('üìä ƒ∞lk veri y√ºkleme tamamlandƒ±, dashboard y√ºkleniyor...');
                setTimeout(() => {
                    if (allData && allData.length > 0) {
                        loadDashboard();
                        console.log('‚úÖ Dashboard y√ºklendi');
                    } else {
                        console.warn('‚ö†Ô∏è Dashboard y√ºklenemedi - veri yok');
                    }
                }, 500);
                
                // Diƒüer yƒ±llarƒ± arka planda y√ºkle
                setTimeout(() => loadRemainingYears(latestYear), 2000);
                
            } catch (error) {
                console.error('Error loading data:', error);
                document.getElementById('dataStatus').innerHTML = '<span class="status-badge status-error">‚ùå Hata</span>';
                // tableContainer null check
                const tableContainerError = document.getElementById('tableContainer');
                if (tableContainerError) {
                    tableContainerError.innerHTML = '<div class="error">‚ùå Veri y√ºklenirken hata olu≈ütu!<br><small>' + error.message + '</small></div>';
                }
            }
        }

        async function loadRemainingYears(skipYear) {
            if (!metadata || !metadata.years) return;
            
            console.log('üì¶ Diƒüer yƒ±llar arka planda y√ºkleniyor...');
            
            // Paralel y√ºkleme i√ßin Promise.all kullan
            const yearPromises = metadata.years
                .filter(year => year !== skipYear && !loadedYears.has(year))
                .map(year => loadYearData(year).catch(err => {
                    console.error(`‚ùå ${year} y√ºkleme hatasƒ±:`, err);
                    return null;
                }));
            
            const yearResults = await Promise.all(yearPromises);
            
            for (let i = 0; i < yearResults.length; i++) {
                const yearData = yearResults[i];
                const year = metadata.years.filter(y => y !== skipYear && !loadedYears.has(y))[i];
                
                if (!yearData) continue;
                
                try {
                    
                    // Eƒüer yƒ±l zaten y√ºkl√ºyse (null d√∂nd√º), atla
                    if (!yearData) {
                        continue;
                    }
                    
                    // Verileri birle≈ütir ve indirim √ºr√ºnlerini negatif yap
                    if (yearData?.details && Array.isArray(yearData.details)) {
                        const yearRawData = yearData.details;
                        const yearDiscountCount = yearRawData.filter(item => isDiscountProduct(item)).length;
                        
                        // T√ºm verileri i≈üle - indirim √ºr√ºnleri negatif olarak
                        const processedYearData = yearRawData.map(item => applyDiscountLogic(item));
                        allData = [...allData, ...processedYearData];
                        baseData = [...allData]; // Kanal filtresi i√ßin g√ºncelle
                        filteredData = [...allData];
                        
                        console.log(`üí∞ ${year}: ${yearDiscountCount} indirim √ºr√ºn√º negatif deƒüer olarak i≈ülendi (toplam: ${yearRawData.length})`);
                        
                        // Filtreleri ve tabloyu g√ºncelle
                        populateFilters();
                        updateSummary();
                        
                        // Satƒ±≈ü temsilcisi ve maƒüaza yƒ±l filtrelerini g√ºncelle
                        populateSalespersonYearFilter();
                        populateStoreYearFilter();
                        
                        // Status g√ºncelle
                        const loadedYearsList = Array.from(loadedYears).sort().join(', ');
                        document.getElementById('dataStatus').innerHTML = `<span class="status-badge status-success">‚úÖ ${loadedYearsList}</span>`;
                        document.getElementById('totalRecords').textContent = allData.length.toLocaleString('tr-TR');
                        
                        // Toplam USD'yi g√ºncelle
                        const totalUSD = allData.reduce((sum, item) => sum + (parseFloat(item.usd_amount) || 0), 0);
                        document.getElementById('totalUSD').textContent = '$' + totalUSD.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        
                        // G√ºnl√ºk Ortalama Hesapla
                        const uniqueDates = [...new Set(allData.map(item => item.date))];
                        const dailyAverage = uniqueDates.length > 0 ? totalUSD / uniqueDates.length : 0;
                        document.getElementById('dailyAverage').textContent = '$' + dailyAverage.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        
                        // Sepet Ortalamasƒ± Hesapla (Toplam USD / Fatura Sayƒ±sƒ±)
                        const uniqueInvoices = new Set(allData.map(item => item.move_name).filter(Boolean)).size;
                        const basketAverage = uniqueInvoices > 0 ? totalUSD / uniqueInvoices : 0;
                        document.getElementById('basketAverage').textContent = '$' + basketAverage.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                        
                        // Dashboard'ƒ± g√ºncelle - sadece grafikleri yenile, veri y√ºkleme yapma
                        // loadDashboard() √ßaƒüƒ±rmƒ±yoruz √ß√ºnk√º zaten veriler y√ºkl√º
                    }
                    
                } catch (error) {
                    console.error(`‚ö†Ô∏è ${year} y√ºklenemedi:`, error);
                }
            }
            
            console.log('‚úÖ T√ºm yƒ±llar y√ºklendi!');
            const allYears = metadata.years.sort().join(', ');
            document.getElementById('dataStatus').innerHTML = `<span class="status-badge status-success">‚úÖ T√ºm Yƒ±llar (${allYears})</span>`;
            
            // Loading progress'i tamamla
            dataLoadProgress.ready = true;
            checkLoadingComplete();
        }
        
        // ==================== INVENTORY DATA LOADING ====================
        async function loadInventoryData() {
            console.log('üì¶ Envanter verileri y√ºkleniyor...');
            
            // Loading state'i g√∂ster
            document.getElementById('inventoryLoading').style.display = 'block';
            document.getElementById('inventoryContent').style.display = 'none';
            
            try {
                // inventory.json.gz dosyasƒ±nƒ± y√ºkle
                const response = await fetch('inventory.json.gz');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const compressedData = await response.arrayBuffer();
                const decompressedData = pako.ungzip(new Uint8Array(compressedData), { to: 'string' });
                const parsedData = JSON.parse(decompressedData);
                
                // Veri yapƒ±sƒ±nƒ± kontrol et (object i√ßinde inventory array'i var)
                if (parsedData.inventory && Array.isArray(parsedData.inventory)) {
                    inventoryData = parsedData.inventory;
                    console.log(`‚úÖ Envanter verileri y√ºklendi: ${inventoryData.length} kayƒ±t`);
                    console.log(`üìä Toplam miktar: ${parsedData.total_quantity}`);
                    console.log(`üí∞ Toplam deƒüer: $${parsedData.total_value}`);
                } else if (Array.isArray(parsedData)) {
                    // Eƒüer direkt array ise
                    inventoryData = parsedData;
                    console.log(`‚úÖ Envanter verileri y√ºklendi: ${inventoryData.length} kayƒ±t`);
                } else {
                    throw new Error('Beklenmeyen veri formatƒ±: inventory array bulunamadƒ±');
                }
                
                // Verileri g√∂r√ºnt√ºle
                renderInventoryDashboard();
                
            } catch (error) {
                console.error('‚ùå Envanter verileri y√ºklenemedi:', error);
                document.getElementById('inventoryLoading').innerHTML = `
                    <div style="text-align: center; padding: 60px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">‚ö†Ô∏è</div>
                        <h3 style="color: #f5576c;">Envanter verileri y√ºklenemedi</h3>
                        <p style="color: #666; margin-top: 15px;">Hata: ${error.message}</p>
                        <button onclick="loadInventoryData()" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em;">
                            üîÑ Tekrar Dene
                        </button>
                    </div>
                `;
            }
        }
        
        function renderInventoryDashboard() {
            if (!inventoryData || inventoryData.length === 0) {
                console.warn('‚ö†Ô∏è Envanter verisi yok!');
                return;
            }
            
            console.log('üìä Envanter dashboard olu≈üturuluyor...');
            
            // Loading'i gizle, content'i g√∂ster
            document.getElementById('inventoryLoading').style.display = 'none';
            document.getElementById('inventoryContent').style.display = 'block';
            
            // ƒ∞lk y√ºklemede t√ºm √ºr√ºnleri g√∂ster
            filterStockAnalysis();
            
            console.log('‚úÖ Envanter dashboard olu≈üturuldu!');
        }
        
        function filterStockAnalysis() {
            if (!inventoryData || inventoryData.length === 0 || !allData || allData.length === 0) {
                console.warn('‚ö†Ô∏è Envanter veya satƒ±≈ü verisi yok!');
                document.getElementById('stockAnalysisTableContainer').innerHTML = '<p style="text-align: center; color: #f5576c; padding: 40px;">‚ö†Ô∏è Veri hen√ºz y√ºklenmedi. L√ºtfen bekleyin...</p>';
                return;
            }
            
            console.log('üîç Stok analizi filtreleniyor...');
            
            // Filtre deƒüerlerini al
            const searchBrand = (document.getElementById('stockSearchBrand')?.value || '').toLowerCase().trim();
            const searchProduct = (document.getElementById('stockSearchProduct')?.value || '').toLowerCase().trim();
            const searchCat2 = (document.getElementById('stockSearchCat2')?.value || '').toLowerCase().trim();
            const searchCat3 = (document.getElementById('stockSearchCat3')?.value || '').toLowerCase().trim();
            const searchCat4 = (document.getElementById('stockSearchCat4')?.value || '').toLowerCase().trim();
            
            // Envanter verilerini filtrele
            let filtered = inventoryData.filter(item => {
                if (searchBrand && !(item.brand || '').toLowerCase().includes(searchBrand)) return false;
                
                // √úr√ºn adƒ±: product_name veya product alanƒ±nƒ± kontrol et
                const productName = item.product_name || item.product || '';
                if (searchProduct && !productName.toLowerCase().includes(searchProduct)) return false;
                
                // Kategoriler: tek bir string'de birle≈üik (√∂rn: "All / Lifestyle / Kitap")
                const category = item.category || '';
                if (searchCat2 && !category.toLowerCase().includes(searchCat2)) return false;
                if (searchCat3 && !category.toLowerCase().includes(searchCat3)) return false;
                if (searchCat4 && !category.toLowerCase().includes(searchCat4)) return false;
                
                return true;
            });
            
            console.log(`üì¶ Filtrelenmi≈ü envanter: ${filtered.length} √ºr√ºn`);
            
            // Her √ºr√ºn i√ßin maƒüaza bazlƒ± stok ve satƒ±≈ü analizi
            const storeAnalysis = {};
            
            filtered.forEach(invItem => {
                const store = invItem.location || 'Bilinmeyen';
                const product = invItem.product_name || invItem.product || '';
                const brand = invItem.brand || '';
                
                if (!storeAnalysis[store]) {
                    storeAnalysis[store] = {};
                }
                
                const key = `${brand}_${product}`;
                if (!storeAnalysis[store][key]) {
                    storeAnalysis[store][key] = {
                        brand: brand,
                        product: product,
                        stock: 0,
                        sales: 0,
                        salesQty: 0
                    };
                }
                
                storeAnalysis[store][key].stock += parseFloat(invItem.quantity) || 0;
            });
            
            // Satƒ±≈ü verilerini ekle (son 12 ay)
            const twelveMonthsAgo = new Date();
            twelveMonthsAgo.setMonth(twelveMonthsAgo.getMonth() - 12);
            
            allData.forEach(saleItem => {
                const saleDate = new Date(saleItem.date);
                if (saleDate < twelveMonthsAgo) return;
                
                const store = saleItem.store || 'Bilinmeyen';
                const product = saleItem.product || '';
                const brand = saleItem.brand || '';
                const key = `${brand}_${product}`;
                
                if (storeAnalysis[store] && storeAnalysis[store][key]) {
                    storeAnalysis[store][key].sales += parseFloat(saleItem.usd_amount) || 0;
                    storeAnalysis[store][key].salesQty += parseFloat(saleItem.quantity) || 0;
                }
            });
            
            // AI: √ñnerilen stok ve satƒ±n alma hesapla
            Object.keys(storeAnalysis).forEach(store => {
                Object.keys(storeAnalysis[store]).forEach(key => {
                    const item = storeAnalysis[store][key];
                    
                    // Aylƒ±k ortalama satƒ±≈ü (son 12 ay)
                    const monthlySales = item.salesQty / 12;
                    
                    // √ñnerilen stok: 2 aylƒ±k satƒ±≈ü + %20 g√ºvenlik marjƒ±
                    const recommendedStock = Math.ceil(monthlySales * 2 * 1.2);
                    item.recommendedStock = recommendedStock;
                    
                    // √ñnerilen satƒ±n alma: √ñnerilen stok - Mevcut stok
                    const purchaseNeed = Math.max(0, recommendedStock - item.stock);
                    item.recommendedPurchase = Math.ceil(purchaseNeed);
                });
            });
            
            // Tabloyu olu≈ütur
            renderStockAnalysisTable(storeAnalysis);
        }
        
        function renderStockAnalysisTable(storeAnalysis) {
            const container = document.getElementById('stockAnalysisTableContainer');
            if (!container) return;
            
            // Her maƒüaza i√ßin tablo
            let html = '';
            
            Object.entries(storeAnalysis).sort((a, b) => a[0].localeCompare(b[0])).forEach(([store, products]) => {
                const productList = Object.values(products);
                if (productList.length === 0) return;
                
                html += `
                    <div style="margin-bottom: 40px;">
                        <h4 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            üè™ ${store} <span style="opacity: 0.8; font-size: 0.9em;">(${productList.length} √ºr√ºn)</span>
                        </h4>
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <thead>
                                <tr style="background: #f8f9fa; text-align: left;">
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Marka</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">√úr√ºn</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: right;">üì¶ Stok</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: right;">üìä Satƒ±≈ü (12 Ay)</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: right;">ü§ñ √ñnerilen Stok</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: right;">üõí √ñnerilen Satƒ±n Alma</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${productList.map(item => {
                                    const stockStatus = item.stock >= item.recommendedStock ? 'background: #d4edda;' : item.stock < item.recommendedStock * 0.5 ? 'background: #f8d7da;' : '';
                                    return `
                                        <tr style="${stockStatus}">
                                            <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${item.brand || '-'}</td>
                                            <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${item.product || '-'}</td>
                                            <td style="padding: 10px; border-bottom: 1px solid #dee2e6; text-align: right; font-weight: bold;">${item.stock.toFixed(0)}</td>
                                            <td style="padding: 10px; border-bottom: 1px solid #dee2e6; text-align: right;">${item.salesQty.toFixed(0)} adet</td>
                                            <td style="padding: 10px; border-bottom: 1px solid #dee2e6; text-align: right; color: #667eea; font-weight: bold;">${item.recommendedStock}</td>
                                            <td style="padding: 10px; border-bottom: 1px solid #dee2e6; text-align: right; ${item.recommendedPurchase > 0 ? 'color: #f5576c; font-weight: bold;' : 'color: #38ef7d;'}">${item.recommendedPurchase > 0 ? item.recommendedPurchase : '‚úì Yeterli'}</td>
                                        </tr>
                                    `;
                                }).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            });
            
            if (html === '') {
                html = '<p style="text-align: center; color: #666; padding: 40px;">Filtre kriterlerine uygun √ºr√ºn bulunamadƒ±.</p>';
            }
            
            container.innerHTML = html;
            console.log('‚úÖ Stok analiz tablosu olu≈üturuldu!');
        }
        
        function clearStockFilters() {
            document.getElementById('stockSearchBrand').value = '';
            document.getElementById('stockSearchProduct').value = '';
            document.getElementById('stockSearchCat2').value = '';
            document.getElementById('stockSearchCat3').value = '';
            document.getElementById('stockSearchCat4').value = '';
            filterStockAnalysis();
            console.log('üóëÔ∏è Stok filtreleri temizlendi');
        }
        
        function renderInventoryCharts() {
            // Marka bazƒ±nda stok
            const brandData = {};
            inventoryData.forEach(item => {
                const brand = item.brand || 'Diƒüer';
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += parseFloat(item.value) || 0;
            });
            const topBrands = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            // Kategori bazƒ±nda stok
            const categoryData = {};
            inventoryData.forEach(item => {
                const category = item.category || 'Diƒüer';
                if (!categoryData[category]) categoryData[category] = 0;
                categoryData[category] += parseFloat(item.value) || 0;
            });
            const topCategories = Object.entries(categoryData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            // Lokasyon bazƒ±nda stok
            const locationData = {};
            inventoryData.forEach(item => {
                const location = item.location || 'Diƒüer';
                if (!locationData[location]) locationData[location] = 0;
                locationData[location] += parseFloat(item.value) || 0;
            });
            const topLocations = Object.entries(locationData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            // En y√ºksek deƒüerli √ºr√ºnler
            const topValueProducts = [...inventoryData]
                .sort((a, b) => (parseFloat(b.value) || 0) - (parseFloat(a.value) || 0))
                .slice(0, 10);
            
            // Chart.js ile grafikleri olu≈ütur
            // Marka grafiƒüi
            if (inventoryCharts.brand) inventoryCharts.brand.destroy();
            const brandCtx = document.getElementById('invBrandChart');
            if (brandCtx) {
                inventoryCharts.brand = new Chart(brandCtx, {
                    type: 'bar',
                    data: {
                        labels: topBrands.map(b => b[0]),
                        datasets: [{
                            label: 'Stok Deƒüeri ($)',
                            data: topBrands.map(b => b[1]),
                            backgroundColor: '#667eea'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } }
                    }
                });
            }
            
            // Kategori grafiƒüi
            if (inventoryCharts.category) inventoryCharts.category.destroy();
            const categoryCtx = document.getElementById('invCategoryChart');
            if (categoryCtx) {
                inventoryCharts.category = new Chart(categoryCtx, {
                    type: 'doughnut',
                    data: {
                        labels: topCategories.map(c => c[0]),
                        datasets: [{
                            data: topCategories.map(c => c[1]),
                            backgroundColor: ['#667eea', '#f093fb', '#4facfe', '#43e97b', '#fa709a', '#fee140', '#30cfd0', '#a8edea', '#ffa751', '#f5576c']
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true
                    }
                });
            }
            
            // Lokasyon grafiƒüi
            if (inventoryCharts.location) inventoryCharts.location.destroy();
            const locationCtx = document.getElementById('invLocationChart');
            if (locationCtx) {
                inventoryCharts.location = new Chart(locationCtx, {
                    type: 'bar',
                    data: {
                        labels: topLocations.map(l => l[0]),
                        datasets: [{
                            label: 'Stok Deƒüeri ($)',
                            data: topLocations.map(l => l[1]),
                            backgroundColor: '#f093fb'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } }
                    }
                });
            }
            
            // Top Value Products grafiƒüi
            if (inventoryCharts.topValue) inventoryCharts.topValue.destroy();
            const topValueCtx = document.getElementById('invTopValueChart');
            if (topValueCtx) {
                inventoryCharts.topValue = new Chart(topValueCtx, {
                    type: 'horizontalBar',
                    data: {
                        labels: topValueProducts.map(p => (p.product || 'Bilinmeyen').substring(0, 30)),
                        datasets: [{
                            label: 'Deƒüer ($)',
                            data: topValueProducts.map(p => parseFloat(p.value) || 0),
                            backgroundColor: '#43e97b'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: true,
                        plugins: { legend: { display: false } }
                    }
                });
            }
        }
        
        function renderInventoryTable() {
            const tbody = document.getElementById('inventoryTableBody');
            if (!tbody) return;
            
            // ƒ∞lk 100 kayƒ±t
            const displayData = inventoryData.slice(0, 100);
            
            tbody.innerHTML = displayData.map(item => `
                <tr>
                    <td>${item.product || '-'}</td>
                    <td>${item.brand || '-'}</td>
                    <td>${item.category || '-'}</td>
                    <td>${item.location || '-'}</td>
                    <td style="text-align: right;">${(parseFloat(item.quantity) || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                    <td style="text-align: right;">$${(parseFloat(item.value) || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                </tr>
            `).join('');
            
            console.log(`‚úÖ Envanter tablosu olu≈üturuldu: ${displayData.length} kayƒ±t`);
        }
        
        function filterInventoryTable() {
            if (!inventoryData || inventoryData.length === 0) return;
            
            const searchTerm = document.getElementById('inventorySearch').value.toLowerCase();
            
            if (!searchTerm.trim()) {
                // Arama bo≈üsa ilk 100 kaydƒ± g√∂ster
                renderInventoryTable();
                return;
            }
            
            // Arama yap
            const filtered = inventoryData.filter(item => {
                return (
                    (item.product && item.product.toLowerCase().includes(searchTerm)) ||
                    (item.brand && item.brand.toLowerCase().includes(searchTerm)) ||
                    (item.category && item.category.toLowerCase().includes(searchTerm)) ||
                    (item.location && item.location.toLowerCase().includes(searchTerm))
                );
            });
            
            // Tabloyu g√ºncelle
            const tbody = document.getElementById('inventoryTableBody');
            if (!tbody) return;
            
            const displayData = filtered.slice(0, 100); // ƒ∞lk 100 sonu√ß
            
            tbody.innerHTML = displayData.map(item => `
                <tr>
                    <td>${item.product || '-'}</td>
                    <td>${item.brand || '-'}</td>
                    <td>${item.category || '-'}</td>
                    <td>${item.location || '-'}</td>
                    <td style="text-align: right;">${(parseFloat(item.quantity) || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                    <td style="text-align: right;">$${(parseFloat(item.value) || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                </tr>
            `).join('');
            
            console.log(`üîç Arama sonucu: ${filtered.length} kayƒ±t bulundu, ${displayData.length} g√∂steriliyor`);
        }

        function populateFilters() {
            const brands = new Set();
            const cat1 = new Set();
            const cat2 = new Set();
            const cat3 = new Set();
            const cat4 = new Set();
            const salesPersons = new Set();
            const stores = new Set();
            const cities = new Set();
            const years = new Set();
            const months = new Set();
            const days = new Set();
            
            allData.forEach(item => {
                if (item.brand) brands.add(item.brand);
                // Kategori kaydƒ±rmasƒ±: category_2 -> Kategori 1, category_3 -> Kategori 2, category_4 -> Kategori 3
                if (item.category_2) cat1.add(item.category_2);
                if (item.category_3) cat2.add(item.category_3);
                if (item.category_4) cat3.add(item.category_4);
                if (item.sales_person) salesPersons.add(item.sales_person);
                if (item.store) stores.add(item.store);
                if (item.city) cities.add(item.city);
                
                // Tarih bilgilerini ayir
                if (item.date) {
                    const dateParts = item.date.split('-');
                    if (dateParts.length >= 3) {
                        years.add(dateParts[0]); // YYYY
                        months.add(dateParts[1]); // MM
                        days.add(dateParts[2]); // DD
                    }
                }
            });
            
            populateMultiSelect('filterBrand', Array.from(brands).sort(), 'countBrand');
            populateMultiSelect('filterCategory1', Array.from(cat1).sort(), 'countCategory1');
            populateMultiSelect('filterCategory2', Array.from(cat2).sort(), 'countCategory2');
            populateMultiSelect('filterCategory3', Array.from(cat3).sort(), 'countCategory3');
            populateMultiSelect('filterSalesPerson', Array.from(salesPersons).sort(), 'countSalesPerson');
            populateMultiSelect('filterStore', Array.from(stores).sort(), 'countStore');
            populateMultiSelect('filterCity', Array.from(cities).sort(), 'countCity');
            populateMultiSelect('filterYear', Array.from(years).sort().reverse(), 'countYear'); // En yeni once
            populateMultiSelect('filterMonth', Array.from(months).sort(), 'countMonth');
            populateMultiSelect('filterDay', Array.from(days).sort(), 'countDay');
        }

        function populateMultiSelect(id, values, countId) {
            const container = document.getElementById(id);
            if (!container) return;
            
            // Mevcut se√ßimleri koru
            const currentChecked = Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
            
            container.innerHTML = '';
            
            values.forEach(value => {
                const item = document.createElement('div');
                item.className = 'checkbox-item';
                
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.value = value;
                checkbox.id = `${id}_${value.replace(/\s+/g, '_')}`;
                checkbox.checked = currentChecked.includes(value);
                
                const label = document.createElement('label');
                label.htmlFor = checkbox.id;
                label.textContent = value;
                
                // Checkbox deƒüi≈ütiƒüinde sayƒ±yƒ± g√ºncelle
                checkbox.addEventListener('change', () => updateSelectionCount(id, countId));
                
                item.appendChild(checkbox);
                item.appendChild(label);
                container.appendChild(item);
            });
            
            // ƒ∞lk y√ºklemede sayƒ±yƒ± g√ºncelle
            updateSelectionCount(id, countId);
        }
        
        function updateSelectionCount(containerId, countId) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const count = container.querySelectorAll('input[type="checkbox"]:checked').length;
            const countSpan = document.getElementById(countId);
            if (countSpan) {
                if (count > 0) {
                    countSpan.textContent = `(${count} se√ßili)`;
                } else {
                    countSpan.textContent = '';
                }
            }
        }
        
        function getSelectedValues(containerId) {
            const container = document.getElementById(containerId);
            if (!container) return [];
            
            return Array.from(container.querySelectorAll('input[type="checkbox"]:checked')).map(cb => cb.value);
        }
        
        // Checkbox'larƒ± filtrele (arama kutusu i√ßin)
        function filterCheckboxes(containerId, searchText) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            const searchLower = searchText.toLowerCase().trim();
            const items = container.querySelectorAll('.checkbox-item');
            
            items.forEach(item => {
                const label = item.querySelector('label');
                if (!label) return;
                
                const text = label.textContent.toLowerCase();
                
                if (searchLower === '' || text.includes(searchLower)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        function applyFilters() {
            const brands = getSelectedValues('filterBrand');
            const cat1s = getSelectedValues('filterCategory1'); // category_2 verisi
            const cat2s = getSelectedValues('filterCategory2'); // category_3 verisi
            const cat3s = getSelectedValues('filterCategory3'); // category_4 verisi
            const salesPersons = getSelectedValues('filterSalesPerson');
            const stores = getSelectedValues('filterStore');
            const cities = getSelectedValues('filterCity');
            const years = getSelectedValues('filterYear');
            const months = getSelectedValues('filterMonth');
            const days = getSelectedValues('filterDay');
            
            console.log('üîç √áoklu Filtreler:', {
                brands: brands.length,
                cat1s: cat1s.length,
                cat2s: cat2s.length,
                cat3s: cat3s.length,
                salesPersons: salesPersons.length,
                stores: stores.length,
                cities: cities.length,
                years: years.length,
                months: months.length,
                days: days.length
            });
            
            filteredData = allData.filter(item => {
                // Marka filtresi (√ßoklu)
                if (brands.length > 0 && !brands.includes(item.brand)) return false;
                
                // Kategori filtreleri (√ßoklu) - KAYDƒ±Rƒ±LMƒ±≈û
                if (cat1s.length > 0 && !cat1s.includes(item.category_2)) return false; // Kategori 1 = category_2
                if (cat2s.length > 0 && !cat2s.includes(item.category_3)) return false; // Kategori 2 = category_3
                if (cat3s.length > 0 && !cat3s.includes(item.category_4)) return false; // Kategori 3 = category_4
                
                // Satis temsilcisi filtresi (√ßoklu)
                if (salesPersons.length > 0 && !salesPersons.includes(item.sales_person)) return false;
                
                // Magaza filtresi (√ßoklu) - KISMI ESLEME
                if (stores.length > 0) {
                    const itemStore = (item.store || '').toLowerCase();
                    const matches = stores.some(store => itemStore.includes(store.toLowerCase()));
                    if (!matches) return false;
                }
                
                // Sehir filtresi (√ßoklu)
                if (cities.length > 0 && !cities.includes(item.city)) return false;
                
                // Tarih filtreleri (√ßoklu)
                if (years.length > 0 || months.length > 0 || days.length > 0) {
                    if (!item.date) return false;
                    
                    const dateParts = item.date.split('-');
                    if (dateParts.length < 3) return false;
                    
                    if (years.length > 0 && !years.includes(dateParts[0])) return false;
                    if (months.length > 0 && !months.includes(dateParts[1])) return false;
                    if (days.length > 0 && !days.includes(dateParts[2])) return false;
                }
                
                return true;
            });
            
            console.log(`Filtreleme sonucu: ${filteredData.length} kayit`);
            
            // Debug panel goster
            const debugPanel = document.getElementById('debugPanel');
            const debugInfo = document.getElementById('debugInfo');
            if (filteredData.length > 0) {
                // Toplam USD ve Miktar hesapla
                const totalUSD = filteredData.reduce((sum, item) => sum + (parseFloat(item.usd_amount) || 0), 0);
                const totalQty = filteredData.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0), 0);
                
                // Benzersiz magazalari say
                const uniqueStores = new Set(filteredData.map(item => item.store)).size;
                
                // Tarih dagilimi
                const dateDistribution = {};
                filteredData.forEach(item => {
                    const date = item.date || 'Bilinmeyen';
                    dateDistribution[date] = (dateDistribution[date] || 0) + 1;
                });
                const topDates = Object.entries(dateDistribution).sort((a, b) => b[1] - a[1]).slice(0, 5);
                
                let debugText = `<strong>Toplam Kayit:</strong> ${allData.length.toLocaleString('tr-TR')}<br>`;
                debugText += `<strong>Filtrelenmis Kayit:</strong> ${filteredData.length.toLocaleString('tr-TR')}<br>`;
                debugText += `<strong>Toplam USD:</strong> $${totalUSD.toLocaleString('tr-TR', {minimumFractionDigits: 2})}<br>`;
                debugText += `<strong>Toplam Miktar:</strong> ${totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2})}<br>`;
                debugText += `<strong>Benzersiz Magaza:</strong> ${uniqueStores}<br><br>`;
                
                debugText += `<strong>Aktif Filtreler:</strong><br>`;
                if (stores.length > 0) debugText += `- Magaza: ${stores.join(', ')}<br>`;
                if (years.length > 0) debugText += `- Yil: ${years.join(', ')}<br>`;
                if (months.length > 0) debugText += `- Ay: ${months.join(', ')}<br>`;
                if (days.length > 0) debugText += `- Gun: ${days.join(', ')}<br>`;
                if (brands.length > 0) debugText += `- Marka: ${brands.join(', ')}<br>`;
                if (cat1s.length > 0) debugText += `- Kategori 1: ${cat1s.join(', ')}<br>`;
                
                debugText += `<br><strong>En Cok Kayit Olan 5 Gun:</strong><br>`;
                topDates.forEach(([date, count]) => {
                    debugText += `- ${date}: ${count} kayit<br>`;
                });
                
                debugText += `<br><strong>Ornek Kayitlar (ilk 3):</strong><br>`;
                for (let i = 0; i < Math.min(3, filteredData.length); i++) {
                    debugText += `<br>${i+1}. Tarih: ${filteredData[i].date} | Magaza: ${filteredData[i].store}<br>`;
                    debugText += `   USD: $${parseFloat(filteredData[i].usd_amount).toFixed(2)} | Miktar: ${filteredData[i].quantity}<br>`;
                    debugText += `   Musteri: ${filteredData[i].partner}<br>`;
                }
                
                debugInfo.innerHTML = debugText;
                debugPanel.style.display = 'block';
            }
            
            updateSummary();
            renderTable();
        }

        function resetFilters() {
            // T√ºm checkbox'larƒ±n se√ßimlerini temizle
            ['filterBrand', 'filterCategory1', 'filterCategory2', 'filterCategory3', 'filterCategory4',
             'filterSalesPerson', 'filterStore', 'filterCity', 'filterYear', 'filterMonth', 'filterDay'].forEach(id => {
                const container = document.getElementById(id);
                if (container) {
                    const checkboxes = container.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => cb.checked = false);
                }
            });
            
            // Se√ßim sayƒ±larƒ±nƒ± g√ºncelle
            ['countBrand', 'countCategory1', 'countCategory2', 'countCategory3', 'countCategory4',
             'countSalesPerson', 'countStore', 'countCity', 'countYear', 'countMonth', 'countDay'].forEach(id => {
                const countSpan = document.getElementById(id);
                if (countSpan) countSpan.textContent = '';
            });
            
            document.getElementById('smartSearch').value = '';
            document.getElementById('debugPanel').style.display = 'none';
            document.getElementById('aiAnalysisPanel').style.display = 'none';
            
            filteredData = [...allData];
            updateSummary();
            renderTable();
        }

        // ü§ñ AI AGENT - Geli≈ümi≈ü Doƒüal Dil ƒ∞≈üleme Motoru
        function applySmartSearch() {
            const query = document.getElementById('smartSearch').value.trim();
            if (!query) {
                resetFilters();
                return;
            }
            
            console.log('ü§ñ AI AGENT BA≈ûLATILIYOR...');
            console.log('üìù Sorgu:', query);
            
            // √ñnce filtreleri sƒ±fƒ±rla
            resetFilters();
            
            // AI Agent analizi
            const aiAnalysis = analyzeQueryWithAI(query);
            console.log('üß† AI Analiz Sonucu:', aiAnalysis);
            
            // Filtreleri uygula
            applyAIFilters(aiAnalysis);
            
            // Veriyi filtrele
            filteredData = filterDataWithAI(allData, aiAnalysis);
            
            console.log(`‚úÖ AI Agent Sonucu: ${filteredData.length} kayƒ±t bulundu`);
            
            // Geli≈ümi≈ü soru tipleri i√ßin √∂zel analiz
            if (aiAnalysis.queryType !== 'basic') {
                performAdvancedAnalysis(aiAnalysis, filteredData);
            } else {
                // Kullanƒ±cƒ±ya AI'nƒ±n ne anladƒ±ƒüƒ±nƒ± g√∂ster
                showAIInterpretation(aiAnalysis, filteredData.length);
            }
            
            updateSummary();
            renderTable();
        }
        
        // üß† AI Analiz Motoru - GELƒ∞≈ûMƒ∞≈û VERSƒ∞YON
        function analyzeQueryWithAI(query) {
            const lowerQuery = query.toLowerCase();
            const analysis = {
                intent: 'search', // search, filter, analyze, compare, recommendation
                queryType: 'basic', // basic, person_analysis, city_analysis, product_recommendation
                entities: {
                    stores: [],
                    brands: [],
                    categories: [],
                    cities: [],
                    salesPersons: [],
                    products: [],
                    dateRange: null,
                    years: [],
                    months: [],
                    keywords: []
                },
                question: {
                    type: null, // "who_sold_what", "city_bought_what", "where_to_sell", "best_for"
                    subject: null, // Ki≈üi adƒ±, ≈üehir adƒ±, √ºr√ºn adƒ±
                    object: null, // √úr√ºn, marka, kategori
                    action: null // "sattƒ±", "aldƒ±", "satmalƒ±", "konumlandƒ±rmalƒ±"
                },
                confidence: 0,
                interpretation: '',
                needsGPT: false // Karma≈üƒ±k soru mu?
            };
            
            // ==================== GELƒ∞≈ûMƒ∞≈û SORU Tƒ∞Pƒ∞ TESPƒ∞Tƒ∞ ====================
            
            // 1. "X en √ßok hangi Y sattƒ±/aldƒ±?" pattern
            const personSoldPattern = /(.+?)\s+(en\s+√ßok|en\s+fazla)?\s*hangi\s+(√ºr√ºn|marka|kategori|model).*?(sattƒ±|satmƒ±≈ü|satƒ±yor)/i;
            const personSoldMatch = query.match(personSoldPattern);
            
            if (personSoldMatch) {
                analysis.queryType = 'person_analysis';
                analysis.question.type = 'who_sold_what';
                analysis.question.subject = personSoldMatch[1].trim();
                analysis.question.object = personSoldMatch[3]; // √ºr√ºn, marka, kategori
                analysis.question.action = 'sattƒ±';
                analysis.intent = 'analyze';
                console.log('üéØ Tespit: Ki≈üi analizi -', analysis.question.subject, 'hangi', analysis.question.object, 'sattƒ±?');
            }
            
            // 2. "X hangi Y aldƒ±?" pattern (≈ûehir/M√º≈üteri bazlƒ±)
            const cityBoughtPattern = /(.+?)\s+(en\s+√ßok|en\s+fazla)?\s*hangi\s+(marka|model|kategori|√ºr√ºn).*?(aldƒ±|almƒ±≈ü|alƒ±yor|satƒ±n\s+aldƒ±)/i;
            const cityBoughtMatch = query.match(cityBoughtPattern);
            
            if (cityBoughtMatch) {
                analysis.queryType = 'city_analysis';
                analysis.question.type = 'city_bought_what';
                analysis.question.subject = cityBoughtMatch[1].trim();
                analysis.question.object = cityBoughtMatch[3];
                analysis.question.action = 'aldƒ±';
                analysis.intent = 'analyze';
                console.log('üéØ Tespit: ≈ûehir/M√º≈üteri analizi -', analysis.question.subject, 'hangi', analysis.question.object, 'aldƒ±?');
            }
            
            // 3. "Hangi X'de Y daha √ßok satƒ±yor/satar?" pattern (√ñneri)
            const whereToSellPattern = /hangi\s+(maƒüaza|≈üehir|yer).*?(satmalƒ±|satmalƒ±yƒ±m|satmak|konumlandƒ±r|daha\s+√ßok\s+sat)/i;
            const whereToSellMatch = query.match(whereToSellPattern);
            
            if (whereToSellMatch) {
                analysis.queryType = 'product_recommendation';
                analysis.question.type = 'where_to_sell';
                analysis.question.action = 'satmalƒ±';
                analysis.intent = 'recommendation';
                analysis.needsGPT = true; // √ñneri i√ßin GPT kullanƒ±labilir
                console.log('üéØ Tespit: √úr√ºn konumlandƒ±rma √∂nerisi');
            }
            
            // 4. "X i√ßin en iyi Y nedir?" pattern
            const bestForPattern = /(.+?)\s+i√ßin\s+en\s+iyi\s+(maƒüaza|≈üehir|yer|kategori)/i;
            const bestForMatch = query.match(bestForPattern);
            
            if (bestForMatch) {
                analysis.queryType = 'product_recommendation';
                analysis.question.type = 'best_for';
                analysis.question.subject = bestForMatch[1].trim();
                analysis.question.object = bestForMatch[2];
                analysis.intent = 'recommendation';
                console.log('üéØ Tespit: En iyi yer √∂nerisi -', analysis.question.subject, 'i√ßin');
            }
            
            // 5. "Hangi X Y'de pop√ºler/√ßok satƒ±yor?" pattern
            const popularWherePattern = /hangi\s+(√ºr√ºn|marka|kategori).*?(≈üehir|maƒüaza|yer).*?(pop√ºler|√ßok\s+sat|ba≈üarƒ±lƒ±)/i;
            const popularWhereMatch = query.match(popularWherePattern);
            
            if (popularWhereMatch) {
                analysis.queryType = 'city_analysis';
                analysis.question.type = 'what_popular_where';
                analysis.question.object = popularWhereMatch[1];
                analysis.intent = 'analyze';
                console.log('üéØ Tespit: Pop√ºlerlik analizi');
            }
            
            // 1. MAƒûAZA TESPƒ∞Tƒ∞ (Fuzzy matching ile)
            const allStores = [...new Set(allData.map(item => item.store).filter(Boolean))];
            allStores.forEach(store => {
                const storeLower = store.toLowerCase();
                // Tam e≈üle≈üme veya kƒ±smi e≈üle≈üme
                if (lowerQuery.includes(storeLower) || 
                    storeLower.includes(lowerQuery) ||
                    fuzzyMatch(lowerQuery, storeLower)) {
                    analysis.entities.stores.push(store);
                }
            });
            
            // Yaygƒ±n maƒüaza kƒ±saltmalarƒ±
            const storeAliases = {
                'aka': 'akasya', 'kadi': 'kadƒ±k√∂y', 'kadƒ±': 'kadƒ±k√∂y',
                'beylik': 'beylikd√ºz√º', 'beyl': 'beylikd√ºz√º'
            };
            for (const [alias, fullName] of Object.entries(storeAliases)) {
                if (lowerQuery.includes(alias)) {
                    const matchingStores = allStores.filter(s => s.toLowerCase().includes(fullName));
                    analysis.entities.stores.push(...matchingStores);
                }
            }
            
            // 2. MARKA TESPƒ∞Tƒ∞
            const allBrands = [...new Set(allData.map(item => item.brand).filter(Boolean))];
            allBrands.forEach(brand => {
                if (lowerQuery.includes(brand.toLowerCase())) {
                    analysis.entities.brands.push(brand);
                }
            });
            
            // 3. KATEGORƒ∞ TESPƒ∞Tƒ∞ (T√ºm seviyeler)
            const allCategories = new Set();
            allData.forEach(item => {
                [item.category_1, item.category_2, item.category_3, item.category_4].forEach(cat => {
                    if (cat) allCategories.add(cat);
                });
            });
            Array.from(allCategories).forEach(category => {
                if (lowerQuery.includes(category.toLowerCase())) {
                    analysis.entities.categories.push(category);
                }
            });
            
            // Yaygƒ±n kategori anahtar kelimeleri
            const categoryKeywords = {
                'gitar': ['gitar', 'guitar'],
                'piyano': ['piyano', 'piano'],
                'davul': ['davul', 'drum', 'bateri'],
                'keman': ['keman', 'violin'],
                'saz': ['saz', 'baƒülama'],
                'aksesu': ['aksesuar', 'aksesuarlar']
            };
            for (const [key, keywords] of Object.entries(categoryKeywords)) {
                if (keywords.some(kw => lowerQuery.includes(kw))) {
                    const matchingCats = Array.from(allCategories).filter(c => 
                        c.toLowerCase().includes(key)
                    );
                    analysis.entities.categories.push(...matchingCats);
                }
            }
            
            // 4. TARƒ∞H ANALƒ∞Zƒ∞ (Geli≈ümi≈ü)
            // "son X g√ºn/ay" tespiti
            const timePatterns = [
                /son\s+(\d+)\s+(g√ºn|gun)/i,
                /son\s+(\d+)\s+(ay)/i,
                /son\s+(\d+)\s+(hafta)/i,
                /ge√ßen\s+(\d+)\s+(g√ºn|gun|ay|hafta)/i,
                /gecen\s+(\d+)\s+(g√ºn|gun|ay|hafta)/i
            ];
            
            for (const pattern of timePatterns) {
                const match = query.match(pattern);
                if (match) {
                    const amount = parseInt(match[1]);
                    const unit = match[2].toLowerCase();
                    const today = new Date();
                    
                    if (unit.includes('ay')) {
                        today.setMonth(today.getMonth() - amount);
                    } else if (unit.includes('hafta')) {
                        today.setDate(today.getDate() - (amount * 7));
                    } else {
                        today.setDate(today.getDate() - amount);
                    }
                    
                    analysis.entities.dateRange = {
                        from: today.toISOString().split('T')[0],
                        to: new Date().toISOString().split('T')[0],
                        description: `Son ${amount} ${unit}`
                    };
                    break;
                }
            }
            
            // Ay isimleri (T√ºrk√ße ve ƒ∞ngilizce)
            const monthNames = {
                'ocak': '01', 'january': '01', 'jan': '01',
                '≈üubat': '02', 'subat': '02', 'february': '02', 'feb': '02',
                'mart': '03', 'march': '03', 'mar': '03',
                'nisan': '04', 'april': '04', 'apr': '04',
                'mayƒ±s': '05', 'mayis': '05', 'may': '05',
                'haziran': '06', 'june': '06', 'jun': '06',
                'temmuz': '07', 'july': '07', 'jul': '07',
                'aƒüustos': '08', 'agustos': '08', 'august': '08', 'aug': '08',
                'eyl√ºl': '09', 'eylul': '09', 'september': '09', 'sep': '09',
                'ekim': '10', 'october': '10', 'oct': '10',
                'kasƒ±m': '11', 'kasim': '11', 'november': '11', 'nov': '11',
                'aralƒ±k': '12', 'aralik': '12', 'december': '12', 'dec': '12'
            };
            
            for (const [monthName, monthNum] of Object.entries(monthNames)) {
                if (lowerQuery.includes(monthName)) {
                    analysis.entities.months.push(monthNum);
                }
            }
            
            // Yƒ±l tespiti (2020-2030)
            const yearMatches = query.match(/\b(202[0-9])\b/g);
            if (yearMatches) {
                analysis.entities.years.push(...yearMatches);
            }
            
            // 5. ≈ûEHƒ∞R TESPƒ∞Tƒ∞
            const allCities = [...new Set(allData.map(item => item.city).filter(Boolean))];
            allCities.forEach(city => {
                if (lowerQuery.includes(city.toLowerCase())) {
                    analysis.entities.cities.push(city);
                }
            });
            
            // 6. SATI≈û TEMSƒ∞LCƒ∞Sƒ∞ TESPƒ∞Tƒ∞ (Fuzzy matching ile)
            const allSalesPersons = [...new Set(allData.map(item => item.sales_person).filter(Boolean))];
            allSalesPersons.forEach(person => {
                const personLower = person.toLowerCase();
                // Tam e≈üle≈üme veya kƒ±smi e≈üle≈üme (ad veya soyad)
                const queryWords = lowerQuery.split(/\s+/);
                const personWords = personLower.split(/\s+/);
                
                const matches = queryWords.some(qw => 
                    personWords.some(pw => pw.includes(qw) || qw.includes(pw))
                );
                
                if (matches || lowerQuery.includes(personLower)) {
                    analysis.entities.salesPersons.push(person);
                }
            });
            
            // 6.5. √úR√úN TESPƒ∞Tƒ∞ (Yeni √ºr√ºn √∂nerileri i√ßin)
            const allProducts = [...new Set(allData.map(item => item.product).filter(Boolean))];
            
            // √úr√ºn anahtar kelimeleri
            const productKeywords = {
                'gitar': ['gitar', 'guitar', 'elektro gitar', 'akustik gitar'],
                'piyano': ['piyano', 'piano', 'dijital piyano', 'akustik piyano'],
                'davul': ['davul', 'drum', 'bateri', 'davul seti'],
                'keman': ['keman', 'violin'],
                'saz': ['saz', 'baƒülama'],
                'amfi': ['amfi', 'amplifier', 'amplifikat√∂r']
            };
            
            for (const [key, keywords] of Object.entries(productKeywords)) {
                if (keywords.some(kw => lowerQuery.includes(kw))) {
                    const matchingProducts = allProducts.filter(p => 
                        p.toLowerCase().includes(key)
                    );
                    analysis.entities.products.push(...matchingProducts.slice(0, 5)); // ƒ∞lk 5 √ºr√ºn
                }
            }
            
            // 7. GENEL ANAHTAR KELƒ∞MELER
            const stopWords = ['ve', 'veya', 'ile', 'i√ßin', 'son', 'g√ºn', 'gun', 'ay', 'yƒ±l', 'yil', 
                               'toplam', 'ka√ß', 'kac', 'ne', 'kadar', 'g√∂ster', 'goster', 'bul', 'ara'];
            const words = query.toLowerCase().split(/\s+/).filter(w => 
                w.length > 2 && !stopWords.includes(w) && !/^\d+$/.test(w)
            );
            analysis.entities.keywords = words;
            
            // 8. G√úVENƒ∞Lƒ∞RLƒ∞K SKORU
            let confidence = 0;
            if (analysis.entities.stores.length > 0) confidence += 30;
            if (analysis.entities.brands.length > 0) confidence += 25;
            if (analysis.entities.categories.length > 0) confidence += 20;
            if (analysis.entities.dateRange || analysis.entities.years.length > 0 || analysis.entities.months.length > 0) confidence += 15;
            if (analysis.entities.keywords.length > 0) confidence += 10;
            analysis.confidence = Math.min(confidence, 100);
            
            // 9. YORUMLAMA
            const parts = [];
            if (analysis.entities.stores.length > 0) parts.push(`Maƒüaza: ${analysis.entities.stores.join(', ')}`);
            if (analysis.entities.brands.length > 0) parts.push(`Marka: ${analysis.entities.brands.join(', ')}`);
            if (analysis.entities.categories.length > 0) parts.push(`Kategori: ${analysis.entities.categories.join(', ')}`);
            if (analysis.entities.dateRange) parts.push(`Tarih: ${analysis.entities.dateRange.description}`);
            else if (analysis.entities.years.length > 0) parts.push(`Yƒ±l: ${analysis.entities.years.join(', ')}`);
            if (analysis.entities.months.length > 0) parts.push(`Ay: ${analysis.entities.months.join(', ')}`);
            if (analysis.entities.keywords.length > 0) parts.push(`Anahtar: ${analysis.entities.keywords.join(', ')}`);
            
            analysis.interpretation = parts.length > 0 ? parts.join(' | ') : 'Genel arama';
            
            return analysis;
        }
        
        // üéØ Fuzzy Matching (Benzerlik skoru)
        function fuzzyMatch(query, target) {
            const queryWords = query.split(/\s+/);
            const targetLower = target.toLowerCase();
            return queryWords.some(word => {
                if (word.length < 3) return false;
                return targetLower.includes(word) || levenshteinDistance(word, targetLower) < 3;
            });
        }
        
        // üìè Levenshtein Distance (D√ºzenleme mesafesi)
        function levenshteinDistance(a, b) {
            const matrix = [];
            for (let i = 0; i <= b.length; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= a.length; j++) {
                matrix[0][j] = j;
            }
            for (let i = 1; i <= b.length; i++) {
                for (let j = 1; j <= a.length; j++) {
                    if (b.charAt(i - 1) === a.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[b.length][a.length];
        }
        
        // üîß AI Filtrelerini Uygula
        function applyAIFilters(analysis) {
            // Maƒüaza filtrelerini se√ß
            if (analysis.entities.stores.length > 0) {
                const storeContainer = document.getElementById('filterStore');
                if (storeContainer) {
                    const checkboxes = storeContainer.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        if (analysis.entities.stores.some(store => 
                            cb.value.toLowerCase().includes(store.toLowerCase())
                        )) {
                            cb.checked = true;
                        }
                    });
                    updateSelectionCount('filterStore', 'countStore');
                }
            }
            
            // Marka filtrelerini se√ß
            if (analysis.entities.brands.length > 0) {
                const brandContainer = document.getElementById('filterBrand');
                if (brandContainer) {
                    const checkboxes = brandContainer.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        if (analysis.entities.brands.includes(cb.value)) {
                            cb.checked = true;
                        }
                    });
                    updateSelectionCount('filterBrand', 'countBrand');
                }
            }
            
            // Yƒ±l filtrelerini se√ß
            if (analysis.entities.years.length > 0) {
                const yearContainer = document.getElementById('filterYear');
                if (yearContainer) {
                    const checkboxes = yearContainer.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        if (analysis.entities.years.includes(cb.value)) {
                            cb.checked = true;
                        }
                    });
                    updateSelectionCount('filterYear', 'countYear');
                }
            }
            
            // Ay filtrelerini se√ß
            if (analysis.entities.months.length > 0) {
                const monthContainer = document.getElementById('filterMonth');
                if (monthContainer) {
                    const checkboxes = monthContainer.querySelectorAll('input[type="checkbox"]');
                    checkboxes.forEach(cb => {
                        if (analysis.entities.months.includes(cb.value)) {
                            cb.checked = true;
                        }
                    });
                    updateSelectionCount('filterMonth', 'countMonth');
                }
            }
        }
        
        // üîç AI ile Veri Filtreleme
        function filterDataWithAI(data, analysis) {
            return data.filter(item => {
                // Maƒüaza kontrol√º
                if (analysis.entities.stores.length > 0) {
                    const itemStore = (item.store || '').toLowerCase();
                    const matches = analysis.entities.stores.some(store => 
                        itemStore.includes(store.toLowerCase())
                    );
                    if (!matches) return false;
                }
                
                // Marka kontrol√º
                if (analysis.entities.brands.length > 0) {
                    if (!analysis.entities.brands.includes(item.brand)) return false;
                }
                
                // Kategori kontrol√º (t√ºm seviyeler)
                if (analysis.entities.categories.length > 0) {
                    const itemCategories = [item.category_1, item.category_2, item.category_3, item.category_4]
                        .filter(Boolean).map(c => c.toLowerCase());
                    const matches = analysis.entities.categories.some(cat => 
                        itemCategories.some(ic => ic.includes(cat.toLowerCase()) || cat.toLowerCase().includes(ic))
                    );
                    if (!matches) return false;
                }
                
                // Tarih aralƒ±ƒüƒ± kontrol√º
                if (analysis.entities.dateRange) {
                    if (!item.date || item.date < analysis.entities.dateRange.from) return false;
                }
                
                // Yƒ±l kontrol√º
                if (analysis.entities.years.length > 0 && item.date) {
                    const itemYear = item.date.split('-')[0];
                    if (!analysis.entities.years.includes(itemYear)) return false;
                }
                
                // Ay kontrol√º
                if (analysis.entities.months.length > 0 && item.date) {
                    const itemMonth = item.date.split('-')[1];
                    if (!analysis.entities.months.includes(itemMonth)) return false;
                }
                
                // ≈ûehir kontrol√º
                if (analysis.entities.cities.length > 0) {
                    if (!analysis.entities.cities.includes(item.city)) return false;
                }
                
                // Satƒ±≈ü temsilcisi kontrol√º
                if (analysis.entities.salesPersons.length > 0) {
                    if (!analysis.entities.salesPersons.includes(item.sales_person)) return false;
                }
                
                // Anahtar kelime kontrol√º (fuzzy)
                if (analysis.entities.keywords.length > 0) {
                    const searchableText = [
                        item.partner, item.product, item.brand,
                        item.category_1, item.category_2, item.category_3, item.category_4,
                        item.sales_person, item.store, item.city
                    ].filter(Boolean).join(' ').toLowerCase();
                    
                    const matches = analysis.entities.keywords.some(keyword => 
                        searchableText.includes(keyword)
                    );
                    if (!matches) return false;
                }
                
                return true;
            });
        }
        
        // üí¨ AI Yorumunu G√∂ster
        function showAIInterpretation(analysis, resultCount) {
            const debugPanel = document.getElementById('debugPanel');
            const debugInfo = document.getElementById('debugInfo');
            
            let html = `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">`;
            html += `<h4 style="margin: 0 0 10px 0; color: white;">ü§ñ AI Agent Analizi</h4>`;
            html += `<p style="margin: 5px 0; font-size: 0.95em;"><strong>Anladƒ±ƒüƒ±m:</strong> ${analysis.interpretation}</p>`;
            html += `<p style="margin: 5px 0; font-size: 0.9em;">üìä G√ºvenilirlik: ${analysis.confidence}% | üéØ Sonu√ß: ${resultCount} kayƒ±t</p>`;
            html += `</div>`;
            
            html += `<strong>üîç Tespit Edilen Varlƒ±klar:</strong><br>`;
            if (analysis.entities.stores.length > 0) html += `üè™ Maƒüazalar: ${analysis.entities.stores.join(', ')}<br>`;
            if (analysis.entities.brands.length > 0) html += `üè∑Ô∏è Markalar: ${analysis.entities.brands.join(', ')}<br>`;
            if (analysis.entities.categories.length > 0) html += `üìÇ Kategoriler: ${analysis.entities.categories.join(', ')}<br>`;
            if (analysis.entities.dateRange) html += `üìÖ Tarih: ${analysis.entities.dateRange.description}<br>`;
            if (analysis.entities.years.length > 0) html += `üìÜ Yƒ±l: ${analysis.entities.years.join(', ')}<br>`;
            if (analysis.entities.months.length > 0) html += `üìÜ Ay: ${analysis.entities.months.join(', ')}<br>`;
            if (analysis.entities.cities.length > 0) html += `üåç ≈ûehir: ${analysis.entities.cities.join(', ')}<br>`;
            if (analysis.entities.salesPersons.length > 0) html += `üë§ Satƒ±≈ü Tem.: ${analysis.entities.salesPersons.join(', ')}<br>`;
            if (analysis.entities.keywords.length > 0) html += `üîë Anahtar Kelimeler: ${analysis.entities.keywords.join(', ')}<br>`;
            
            debugInfo.innerHTML = html;
            debugPanel.style.display = 'block';
        }
        
        // üéØ GELƒ∞≈ûMƒ∞≈û ANALƒ∞Z (Ki≈üi, ≈ûehir, √ñneri Sorgularƒ±)
        function performAdvancedAnalysis(analysis, data) {
            console.log('üéØ Geli≈ümi≈ü analiz ba≈ülatƒ±lƒ±yor:', analysis.queryType);
            
            const debugPanel = document.getElementById('debugPanel');
            const debugInfo = document.getElementById('debugInfo');
            
            let html = `<div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px;">`;
            html += `<h3 style="margin: 0 0 15px 0; color: white;">ü§ñ Geli≈ümi≈ü AI Analizi</h3>`;
            
            if (analysis.queryType === 'person_analysis') {
                // "Mustafa Kƒ±lƒ±√ß en √ßok hangi √ºr√ºn√º sattƒ±?"
                const personName = analysis.question.subject;
                const objectType = analysis.question.object; // √ºr√ºn, marka, kategori
                
                // Ki≈üinin verilerini filtrele
                const personData = data.filter(item => 
                    item.sales_person && item.sales_person.toLowerCase().includes(personName.toLowerCase())
                );
                
                if (personData.length === 0) {
                    html += `<p>‚ö†Ô∏è "${personName}" adlƒ± satƒ±≈ü temsilcisi bulunamadƒ±.</p>`;
                } else {
                    // Analiz yap
                    const results = {};
                    personData.forEach(item => {
                        let key;
                        if (objectType === '√ºr√ºn') key = item.product;
                        else if (objectType === 'marka') key = item.brand;
                        else if (objectType === 'kategori') key = item.category_1;
                        else if (objectType === 'model') key = item.product;
                        
                        if (key) {
                            if (!results[key]) results[key] = {sales: 0, count: 0};
                            results[key].sales += parseFloat(item.usd_amount || 0);
                            results[key].count += 1;
                        }
                    });
                    
                    // Sƒ±rala
                    const sorted = Object.entries(results).sort((a, b) => b[1].sales - a[1].sales);
                    const top5 = sorted.slice(0, 5);
                    
                    html += `<p style="font-size: 1.1em; margin-bottom: 15px;">üìä <strong>${personName}</strong> analizi:</p>`;
                    html += `<p>üí∞ Toplam Satƒ±≈ü: <strong>$${personData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</strong></p>`;
                    html += `<p>üì¶ Toplam ƒ∞≈ülem: <strong>${personData.length}</strong></p>`;
                    html += `<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">`;
                    html += `<p style="font-size: 1.05em; margin-bottom: 10px;">üèÜ En √áok Sattƒ±ƒüƒ± ${objectType.charAt(0).toUpperCase() + objectType.slice(1)}ler:</p>`;
                    
                    top5.forEach((item, index) => {
                        html += `<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 5px; margin: 8px 0;">`;
                        html += `<strong>${index + 1}. ${item[0]}</strong><br>`;
                        html += `üí∞ Satƒ±≈ü: $${item[1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} | üì¶ Adet: ${item[1].count}`;
                        html += `</div>`;
                    });
                    
                    // √ñneri
                    html += `<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">`;
                    html += `<p style="font-size: 1em;">üí° <strong>√ñneri:</strong> ${personName}, <strong>${top5[0][0]}</strong> konusunda uzman. Bu ${objectType}'e odaklanmalƒ± ve stok takibi yapmalƒ±.</p>`;
                }
                
            } else if (analysis.queryType === 'city_analysis') {
                // "ƒ∞stanbul en √ßok hangi marka piyano aldƒ±?"
                const cityName = analysis.question.subject;
                const objectType = analysis.question.object; // marka, model, kategori
                
                // ≈ûehir verilerini filtrele
                let cityData = data.filter(item => 
                    item.city && item.city.toLowerCase().includes(cityName.toLowerCase())
                );
                
                // Eƒüer partner adƒ± ise
                if (cityData.length === 0) {
                    cityData = data.filter(item => 
                        item.partner && item.partner.toLowerCase().includes(cityName.toLowerCase())
                    );
                }
                
                if (cityData.length === 0) {
                    html += `<p>‚ö†Ô∏è "${cityName}" i√ßin veri bulunamadƒ±.</p>`;
                } else {
                    // Analiz yap
                    const results = {};
                    cityData.forEach(item => {
                        let key;
                        if (objectType === 'marka') key = item.brand;
                        else if (objectType === 'model') key = item.product;
                        else if (objectType === 'kategori') key = item.category_1;
                        else if (objectType === '√ºr√ºn') key = item.product;
                        
                        if (key) {
                            if (!results[key]) results[key] = {sales: 0, count: 0};
                            results[key].sales += parseFloat(item.usd_amount || 0);
                            results[key].count += 1;
                        }
                    });
                    
                    // Sƒ±rala
                    const sorted = Object.entries(results).sort((a, b) => b[1].sales - a[1].sales);
                    const top5 = sorted.slice(0, 5);
                    
                    html += `<p style="font-size: 1.1em; margin-bottom: 15px;">üìä <strong>${cityName}</strong> analizi:</p>`;
                    html += `<p>üí∞ Toplam Satƒ±≈ü: <strong>$${cityData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</strong></p>`;
                    html += `<p>üì¶ Toplam ƒ∞≈ülem: <strong>${cityData.length}</strong></p>`;
                    html += `<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">`;
                    html += `<p style="font-size: 1.05em; margin-bottom: 10px;">üèÜ En √áok Tercih Edilen ${objectType.charAt(0).toUpperCase() + objectType.slice(1)}ler:</p>`;
                    
                    top5.forEach((item, index) => {
                        html += `<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 5px; margin: 8px 0;">`;
                        html += `<strong>${index + 1}. ${item[0]}</strong><br>`;
                        html += `üí∞ Satƒ±≈ü: $${item[1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} | üì¶ Adet: ${item[1].count}`;
                        html += `</div>`;
                    });
                    
                    // √ñneri
                    html += `<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">`;
                    html += `<p style="font-size: 1em;">üí° <strong>√ñneri:</strong> ${cityName}'da <strong>${top5[0][0]}</strong> en pop√ºler. Bu ${objectType} i√ßin stok artƒ±rƒ±lmalƒ±.</p>`;
                }
                
            } else if (analysis.queryType === 'product_recommendation') {
                // "Hangi maƒüazada bu √ºr√ºn√º satmalƒ±yƒ±m?"
                html += `<p style="font-size: 1.1em; margin-bottom: 15px;">üéØ √úr√ºn Konumlandƒ±rma √ñnerisi</p>`;
                
                // Kategori veya marka bazlƒ± analiz
                const categoryData = {};
                const storeData = {};
                
                data.forEach(item => {
                    const store = item.store || 'Bilinmiyor';
                    const category = item.category_1 || 'Bilinmiyor';
                    
                    if (!storeData[store]) storeData[store] = {sales: 0, count: 0, categories: {}};
                    storeData[store].sales += parseFloat(item.usd_amount || 0);
                    storeData[store].count += 1;
                    
                    if (!storeData[store].categories[category]) storeData[store].categories[category] = 0;
                    storeData[store].categories[category] += parseFloat(item.usd_amount || 0);
                });
                
                // En ba≈üarƒ±lƒ± maƒüazalarƒ± bul
                const sortedStores = Object.entries(storeData).sort((a, b) => b[1].sales - a[1].sales);
                const top3Stores = sortedStores.slice(0, 3);
                
                html += `<p>üìä Maƒüaza Performans Analizi:</p>`;
                
                top3Stores.forEach((store, index) => {
                    const storeName = store[0];
                    const storeStats = store[1];
                    const topCategory = Object.entries(storeStats.categories).sort((a, b) => b[1] - a[1])[0];
                    
                    html += `<div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 5px; margin: 10px 0;">`;
                    html += `<strong>${index + 1}. ${storeName}</strong><br>`;
                    html += `üí∞ Toplam Satƒ±≈ü: $${storeStats.sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}<br>`;
                    html += `üì¶ ƒ∞≈ülem Sayƒ±sƒ±: ${storeStats.count}<br>`;
                    html += `üèÜ En G√º√ßl√º Kategori: ${topCategory[0]}`;
                    html += `</div>`;
                });
                
                // √ñneri
                html += `<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">`;
                html += `<p style="font-size: 1em;">üí° <strong>√ñneri:</strong></p>`;
                html += `<p>‚Ä¢ <strong>${top3Stores[0][0]}</strong> en y√ºksek satƒ±≈ü performansƒ±na sahip.</p>`;
                html += `<p>‚Ä¢ Yeni √ºr√ºn i√ßin bu maƒüazayƒ± tercih edin.</p>`;
                html += `<p>‚Ä¢ √ñzellikle <strong>${Object.entries(top3Stores[0][1].categories).sort((a, b) => b[1] - a[1])[0][0]}</strong> kategorisinde g√º√ßl√º.</p>`;
                
                if (analysis.needsGPT) {
                    html += `<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">`;
                    html += `<p style="font-size: 0.9em; opacity: 0.9;">ü§ñ <em>Daha detaylƒ± analiz i√ßin GPT-4 kullanƒ±labilir. (ƒ∞steƒüe baƒülƒ±)</em></p>`;
                }
            }
            
            html += `</div>`;
            
            debugInfo.innerHTML = html;
            debugPanel.style.display = 'block';
        }

        function updateSummary() {
            console.log('updateSummary - Filtrelenmis veri sayisi:', filteredData.length);
            
            const totalUSD = filteredData.reduce((sum, item) => sum + (parseFloat(item.usd_amount) || 0), 0);
            const totalQty = filteredData.reduce((sum, item) => sum + (parseFloat(item.quantity) || 0), 0);
            const uniquePartners = new Set(filteredData.map(item => item.partner)).size;
            const uniqueProducts = new Set(filteredData.map(item => item.product)).size;
            
            console.log('Ozet:', {totalUSD, totalQty, uniquePartners, uniqueProducts});
            
            // Eski Sales sekmesi elementleri - null check
            const summaryUSD = document.getElementById('summaryUSD');
            const summaryQuantity = document.getElementById('summaryQuantity');
            const summaryPartners = document.getElementById('summaryPartners');
            const summaryProducts = document.getElementById('summaryProducts');
            
            if (summaryUSD) summaryUSD.textContent = '$' + totalUSD.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            if (summaryQuantity) summaryQuantity.textContent = totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            if (summaryPartners) summaryPartners.textContent = uniquePartners.toLocaleString('tr-TR');
            if (summaryProducts) summaryProducts.textContent = uniqueProducts.toLocaleString('tr-TR');
            
            // AI Analiz yap
            if (filteredData.length > 0) {
                performAIAnalysis();
            }
        }

        // Chart.js instances
        let topCategoryChart = null;
        let topBrandChart = null;
        let topProductChart = null;
        let topSalesPersonChart = null;
        
        function renderTable() {
            const container = document.getElementById('tableContainer');
            
            // tableContainer yoksa (Dashboard sekmesinde), √ßƒ±k
            if (!container) {
                return;
            }
            
            if (filteredData.length === 0) {
                container.innerHTML = '<div class="loading">‚ö†Ô∏è Filtreye uygun veri bulunamadi.</div>';
                return;
            }
            
            // Veriyi analiz et
            const categoryData = {};
            const brandData = {};
            const productData = {};
            const salesPersonData = {};
            
            filteredData.forEach(item => {
                // Kategori
                const cat = item.category_1 || 'Bilinmiyor';
                if (!categoryData[cat]) categoryData[cat] = 0;
                categoryData[cat] += parseFloat(item.usd_amount || 0);
                
                // Marka
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += parseFloat(item.usd_amount || 0);
                
                // √úr√ºn
                const product = item.product || 'Bilinmiyor';
                if (!productData[product]) productData[product] = 0;
                productData[product] += parseFloat(item.usd_amount || 0);
                
                // Satƒ±≈ü Temsilcisi
                const person = item.sales_person || 'Bilinmiyor';
                if (!salesPersonData[person]) salesPersonData[person] = 0;
                salesPersonData[person] += parseFloat(item.usd_amount || 0);
            });
            
            // Top 10'larƒ± al
            const topCategories = Object.entries(categoryData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const topBrands = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const topProducts = Object.entries(productData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const topSalesPersons = Object.entries(salesPersonData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            // HTML olu≈ütur
            let html = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 30px; margin-top: 30px;">
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 20px;">üèÜ En Ba≈üarƒ±lƒ± Kategoriler</h3>
                        <canvas id="topCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 20px;">üè∑Ô∏è En √áok Satan Markalar</h3>
                        <canvas id="topBrandChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 20px;">‚≠ê En √áok Satan √úr√ºnler</h3>
                        <canvas id="topProductChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 20px;">üë§ En Ba≈üarƒ±lƒ± Satƒ±≈ü Temsilcileri</h3>
                        <canvas id="topSalesPersonChart"></canvas>
                    </div>
                </div>
            `;
            
            container.innerHTML = html;
            
            // Grafikleri render et
            setTimeout(() => {
                renderTopCategoryChart(topCategories);
                renderTopBrandChart(topBrands);
                renderTopProductChart(topProducts);
                renderTopSalesPersonChart(topSalesPersons);
            }, 100);
        }
        
        function renderTopCategoryChart(data) {
            const ctx = document.getElementById('topCategoryChart');
            if (!ctx) return;
            
            if (topCategoryChart) {
                topCategoryChart.destroy();
            }
            
            topCategoryChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d[0]),
                    datasets: [{
                        label: 'Satƒ±≈ü ($ - KDV Hari√ß)',
                        data: data.map(d => d[1]),
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderTopBrandChart(data) {
            const ctx = document.getElementById('topBrandChart');
            if (!ctx) return;
            
            if (topBrandChart) {
                topBrandChart.destroy();
            }
            
            topBrandChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d[0]),
                    datasets: [{
                        label: 'Satƒ±≈ü ($ - KDV Hari√ß)',
                        data: data.map(d => d[1]),
                        backgroundColor: 'rgba(56, 239, 125, 0.8)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderTopProductChart(data) {
            const ctx = document.getElementById('topProductChart');
            if (!ctx) return;
            
            if (topProductChart) {
                topProductChart.destroy();
            }
            
            topProductChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d[0].substring(0, 30) + (d[0].length > 30 ? '...' : '')),
                    datasets: [{
                        label: 'Satƒ±≈ü ($ - KDV Hari√ß)',
                        data: data.map(d => d[1]),
                        backgroundColor: 'rgba(245, 87, 108, 0.8)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false},
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    return data[context[0].dataIndex][0];
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderTopSalesPersonChart(data) {
            const ctx = document.getElementById('topSalesPersonChart');
            if (!ctx) return;
            
            if (topSalesPersonChart) {
                topSalesPersonChart.destroy();
            }
            
            topSalesPersonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: data.map(d => d[0]),
                    datasets: [{
                        label: 'Satƒ±≈ü ($ - KDV Hari√ß)',
                        data: data.map(d => d[1]),
                        backgroundColor: 'rgba(240, 147, 251, 0.8)',
                        borderColor: 'rgba(240, 147, 251, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }

        // ==================== TAB SYSTEM ====================
        function switchTab(tabName) {
            console.log('üîÑ switchTab √ßaƒürƒ±ldƒ±:', tabName);
            
            // T√ºm tab i√ßeriklerini gizle
            const allTabContents = document.querySelectorAll('.tab-content');
            allTabContents.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // T√ºm tab butonlarƒ±nƒ± pasif yap
            const allTabs = document.querySelectorAll('.tab');
            allTabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Se√ßilen tab'ƒ± aktif et
            const selectedTab = document.getElementById(tabName + 'Tab');
            console.log('üîç Aranan tab ID:', tabName + 'Tab', '| Bulundu mu?', selectedTab ? 'EVET' : 'HAYIR');
            if (selectedTab) {
                selectedTab.classList.add('active');
                console.log('‚úÖ Tab aktif edildi:', tabName + 'Tab');
            } else {
                console.error('‚ùå Tab bulunamadƒ±:', tabName + 'Tab');
            }
            
            // ƒ∞lgili tab butonunu aktif et
            const tabButtons = {
                'dashboard': 0,
                'targets': 1,
                'customers': 2,
                'salesperson': 3,
                'store': 4,
                'city': 5,
                'stock': 6,
                'time': 7,
                'product': 8
            };
            if (tabButtons[tabName] !== undefined) {
                allTabs[tabButtons[tabName]].classList.add('active');
            }
            
            // Tab'a g√∂re √∂zel i≈ülemler
            if (tabName === 'dashboard') {
                loadDashboard();
            } else if (tabName === 'targets') {
                loadAllStoresTargets(); // Yeni hedef takip sistemi
            } else if (tabName === 'customers') {
                analyzeCustomers();
            } else if (tabName === 'time') {
                analyzeTime();
            } else if (tabName === 'city') {
                console.log('üåç ≈ûehir analizi sekmesi a√ßƒ±lƒ±yor...');
                console.log('üìä allData durumu:', allData ? `${allData.length} kayƒ±t` : 'Hen√ºz y√ºklenmedi');
                if (allData && allData.length > 0) {
                    populateCitySelect();
                } else {
                    console.warn('‚ö†Ô∏è Veriler hen√ºz y√ºklenmedi, ≈üehir listesi doldurulamƒ±yor');
                    setTimeout(() => {
                        if (allData && allData.length > 0) {
                            console.log('üîÑ Veri y√ºklendi, ≈üehir listesi yeniden dolduruluyor...');
                            populateCitySelect();
                        }
                    }, 2000);
                }
            } else if (tabName === 'stock') {
                console.log('üì¶ Stok daƒüƒ±lƒ±m sekmesi a√ßƒ±lƒ±yor...');
                // LAZY LOAD: Envanter verilerini sadece ilk kez y√ºkle
                if (!inventoryData) {
                    console.log('üîÑ Envanter verileri lazy loading ile y√ºkleniyor...');
                    loadInventoryData();
                } else {
                    console.log('‚úÖ Envanter verileri zaten y√ºkl√º');
                }
                // Stok konumlarƒ±nƒ± y√ºkle
                if (Object.keys(stockLocations).length === 0) {
                    console.log('üîÑ Stok konumlarƒ± y√ºkleniyor...');
                    loadStockLocations();
                }
            }
        }
        
        // ==================== EXCEL EXPORT ====================
        function exportToExcel() {
            if (filteredData.length === 0) {
                alert('‚ö†Ô∏è Dƒ±≈üa aktarƒ±lacak veri yok!');
                return;
            }
            
            console.log('üì• Excel export ba≈ülatƒ±lƒ±yor...');
            
            // Veriyi Excel formatƒ±na d√∂n√º≈üt√ºr (Kategori kaydƒ±rƒ±lmƒ±≈ü)
            const excelData = filteredData.map(item => ({
                'ƒ∞≈ü Ortaƒüƒ±': item.partner || '',
                '√úr√ºn': item.product || '',
                'Marka': item.brand || '',
                'Kategori 1': item.category_2 || '', // category_2 -> Kategori 1
                'Kategori 2': item.category_3 || '', // category_3 -> Kategori 2
                'Kategori 3': item.category_4 || '', // category_4 -> Kategori 3
                'Satƒ±≈ü Temsilcisi': item.sales_person || '',
                'Maƒüaza': item.store || '',
                '≈ûehir': item.city || '',
                'Tarih': item.date || '',
                'Miktar': parseFloat(item.quantity || 0),
                'USD (KDV Hari√ß)': parseFloat(item.usd_amount || 0)
            }));
            
            // √ñzet satƒ±rƒ± ekle
            const summary = {
                'ƒ∞≈ü Ortaƒüƒ±': 'TOPLAM',
                '√úr√ºn': '',
                'Marka': '',
                'Kategori 1': '',
                'Kategori 2': '',
                'Kategori 3': '',
                'Satƒ±≈ü Temsilcisi': '',
                'Maƒüaza': '',
                '≈ûehir': '',
                'Tarih': '',
                'Miktar': filteredData.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0),
                'USD (KDV Hari√ß)': filteredData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0)
            };
            excelData.push(summary);
            
            // Workbook olu≈ütur
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(excelData);
            
            // S√ºtun geni≈üliklerini ayarla
            ws['!cols'] = [
                {wch: 30}, // ƒ∞≈ü Ortaƒüƒ±
                {wch: 40}, // √úr√ºn
                {wch: 15}, // Marka
                {wch: 20}, // Kategori 1
                {wch: 20}, // Kategori 2
                {wch: 20}, // Kategori 3
                {wch: 20}, // Satƒ±≈ü Temsilcisi
                {wch: 30}, // Maƒüaza
                {wch: 15}, // ≈ûehir
                {wch: 12}, // Tarih
                {wch: 12}, // Miktar
                {wch: 18}  // USD (KDV Hari√ß)
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, 'Satƒ±≈ü Verileri');
            
            // Dosya adƒ± olu≈ütur
            const today = new Date().toISOString().split('T')[0];
            const filename = `Satis_Analizi_${today}.xlsx`;
            
            // ƒ∞ndir
            XLSX.writeFile(wb, filename);
            
            console.log(`‚úÖ Excel dosyasƒ± indirildi: ${filename}`);
            alert(`‚úÖ ${filteredData.length} kayƒ±t Excel'e aktarƒ±ldƒ±!\nDosya: ${filename}`);
        }
        
        
        // ==================== VOICE SEARCH ====================
        let recognition = null;
        let isListening = false;
        
        function startVoiceSearch() {
            if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
                alert('‚ö†Ô∏è Tarayƒ±cƒ±nƒ±z ses tanƒ±ma √∂zelliƒüini desteklemiyor!\nChrome veya Edge kullanƒ±n.');
                return;
            }
            
            const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
            
            if (isListening) {
                // Dinlemeyi durdur
                if (recognition) {
                    recognition.stop();
                }
                return;
            }
            
            recognition = new SpeechRecognition();
            recognition.lang = 'tr-TR';
            recognition.continuous = false;
            recognition.interimResults = false;
            
            const voiceBtn = document.getElementById('voiceBtn');
            
            recognition.onstart = () => {
                isListening = true;
                voiceBtn.classList.add('listening');
                voiceBtn.textContent = 'üéôÔ∏è';
                console.log('üé§ Dinleniyor...');
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                console.log('üó£Ô∏è Algƒ±lanan:', transcript);
                document.getElementById('smartSearch').value = transcript;
                applySmartSearch();
            };
            
            recognition.onerror = (event) => {
                console.error('‚ùå Ses tanƒ±ma hatasƒ±:', event.error);
                if (event.error === 'no-speech') {
                    alert('‚ö†Ô∏è Ses algƒ±lanamadƒ±. L√ºtfen tekrar deneyin.');
                } else if (event.error === 'not-allowed') {
                    alert('‚ö†Ô∏è Mikrofon izni verilmedi. L√ºtfen tarayƒ±cƒ± ayarlarƒ±ndan mikrofon izni verin.');
                }
            };
            
            recognition.onend = () => {
                isListening = false;
                voiceBtn.classList.remove('listening');
                voiceBtn.textContent = 'üé§';
                console.log('üé§ Dinleme bitti');
            };
            
            recognition.start();
        }
        
        // ==================== TARGET TRACKING ====================
        let targetChart = null;
        
        // ==================== HEDEF Y√ñNETƒ∞Mƒ∞ ====================
        
        // Yƒ±llƒ±k hedefleri kaydet
        function saveYearlyTarget() {
            const year = document.getElementById('targetYear').value;
            const store = document.getElementById('targetYearStore').value;
            const target = parseFloat(document.getElementById('yearlyTarget').value) || 0;
            
            console.log('üíæ saveYearlyTarget √ßaƒürƒ±ldƒ±:', {year, store, target});
            
            if (target <= 0) {
                alert('‚ö†Ô∏è L√ºtfen ge√ßerli bir hedef girin!');
                return;
            }
            
            // Mevcut hedefleri al
            let yearlyTargets = JSON.parse(localStorage.getItem('yearlyTargets') || '{}');
            console.log('üìÇ Mevcut localStorage:', yearlyTargets);
            
            // üîß ESKƒ∞ FORMAT TESPƒ∞Tƒ∞ VE OTOMATƒ∞K TEMƒ∞ZLƒ∞K
            // Eski format: {2025: 5750000} -> sayƒ±
            // Yeni format: {2025: {"T√úM MAƒûAZALAR": 5750000}} -> object
            let needsMigration = false;
            for (const [y, value] of Object.entries(yearlyTargets)) {
                if (typeof value === 'number') {
                    needsMigration = true;
                    console.warn('‚ö†Ô∏è Eski localStorage formatƒ± tespit edildi! Otomatik temizleniyor...');
                    break;
                }
            }
            
            if (needsMigration) {
                // Eski verileri yeni formata d√∂n√º≈üt√ºr
                const migratedTargets = {};
                for (const [y, value] of Object.entries(yearlyTargets)) {
                    if (typeof value === 'number') {
                        // Eski format: sayƒ± -> yeni format: {T√úM MAƒûAZALAR: sayƒ±}
                        migratedTargets[y] = {'T√úM MAƒûAZALAR': value};
                        console.log(`üîÑ ${y} yƒ±lƒ± formatƒ± g√ºncellendi:`, value, '‚Üí', migratedTargets[y]);
                    } else {
                        // Zaten yeni format
                        migratedTargets[y] = value;
                    }
                }
                yearlyTargets = migratedTargets;
                localStorage.setItem('yearlyTargets', JSON.stringify(yearlyTargets));
                console.log('‚úÖ Eski format temizlendi ve yeni formata d√∂n√º≈üt√ºr√ºld√º!');
            }
            
            // Yƒ±l yoksa olu≈ütur
            if (!yearlyTargets[year]) {
                yearlyTargets[year] = {};
            }
            
            // Maƒüaza bazƒ±nda hedefi kaydet
            yearlyTargets[year][store] = target;
            localStorage.setItem('yearlyTargets', JSON.stringify(yearlyTargets));
            
            console.log('‚úÖ localStorage\'a kaydedildi:', yearlyTargets);
            console.log('üîç Kontrol: localStorage.getItem:', localStorage.getItem('yearlyTargets'));
            
            // Hesapla
            calculateTargets();
            
            // Bildirim
            const storeText = store === 'T√úM MAƒûAZALAR' ? 'T√ºm Maƒüazalar' : store;
            alert(`‚úÖ ${year} yƒ±lƒ± ${storeText} hedefi kaydedildi: $${target.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`);
        }
        
        // T√ºm maƒüazalarƒ±n hedeflerini y√ºkle ve g√∂ster (YENƒ∞ Sƒ∞STEM)
        function loadAllStoresTargets() {
            const year = document.getElementById('targetFilterYear').value;
            const month = document.getElementById('targetFilterMonth').value || ''; // Bo≈ü string'i garantile
            const container = document.getElementById('allStoresTargetsContainer');
            
            console.log('üìä T√ºm maƒüazalar hedef listesi y√ºkleniyor:', {year, month, monthType: typeof month, monthLength: month.length});
            
            // T√ºm maƒüazalarƒ± bul
            const allStores = new Set();
            allData.forEach(item => {
                if (item.store && item.store !== 'Analitik' && !item.store.toLowerCase().includes('eƒüitim')) {
                    allStores.add(item.store);
                }
            });
            
            const storesList = Array.from(allStores).sort();
            
            // Her maƒüaza i√ßin hedef ve ger√ßekle≈üme hesapla
            const storesData = storesList.map(storeName => {
                // Maƒüaza adƒ±ndan [ID] prefix'ini temizle
                const cleanStoreName = storeName.replace(/^\[\d+\]\s*/, ''); // "[1101404] " gibi prefix'leri kaldƒ±r
                
                // Hedefi al (Esnek e≈üle≈ütirme ile)
                let target = 0;
                
                // Hedef anahtarƒ± bul (tam e≈üle≈üme veya kƒ±smi e≈üle≈üme)
                function findTargetKey(targetObj, storeName) {
                    if (!targetObj) return null;
                    
                    // Tam e≈üle≈üme (temiz isimle)
                    if (targetObj[storeName]) return storeName;
                    
                    // Kƒ±smi e≈üle≈üme (case-insensitive)
                    const storeNameLower = storeName.toLowerCase();
                    for (const key of Object.keys(targetObj)) {
                        const keyLower = key.toLowerCase();
                        // Eƒüer hedef anahtarƒ± maƒüaza adƒ±nƒ± i√ßeriyorsa veya tam tersi
                        if (keyLower.includes(storeNameLower) || storeNameLower.includes(keyLower)) {
                            return key;
                        }
                    }
                    return null;
                }
                
                if (month) {
                    // AYLIK HEDEF - √ñnce centralTargets (GitHub), sonra Google Sheets, sonra localStorage
                    if (centralTargets.monthly && centralTargets.monthly[year]) {
                        const targetKey = findTargetKey(centralTargets.monthly[year], cleanStoreName);
                        // console.log(`üîç Maƒüaza: "${storeName}" ‚Üí Temiz: "${cleanStoreName}" ‚Üí Hedef Anahtarƒ±: "${targetKey}"`);
                        if (targetKey && centralTargets.monthly[year][targetKey] && centralTargets.monthly[year][targetKey][month]) {
                            target = centralTargets.monthly[year][targetKey][month];
                            // console.log(`‚úÖ Hedef bulundu: $${target}`);
                        }
                    }
                    
                    // Google Sheets kaldƒ±rƒ±ldƒ± - sadece localStorage fallback
                    if (target === 0) {
                        const localTargets = JSON.parse(localStorage.getItem('monthlyTargets') || '{}');
                        if (localTargets[year]) {
                            const targetKey = findTargetKey(localTargets[year], cleanStoreName);
                            if (targetKey && localTargets[year][targetKey][month]) {
                                target = localTargets[year][targetKey][month];
                            }
                        }
                    }
                } else {
                    // YILLIK HEDEF - √ñnce centralTargets (GitHub), sonra Google Sheets, sonra localStorage
                    if (centralTargets.yearly && centralTargets.yearly[year]) {
                        const targetKey = findTargetKey(centralTargets.yearly[year], cleanStoreName);
                        if (targetKey) {
                            target = centralTargets.yearly[year][targetKey];
                        }
                    }
                    
                    // Google Sheets kaldƒ±rƒ±ldƒ± - sadece localStorage fallback
                    if (target === 0) {
                        const localTargets = JSON.parse(localStorage.getItem('yearlyTargets') || '{}');
                        if (localTargets[year]) {
                            const targetKey = findTargetKey(localTargets[year], cleanStoreName);
                            if (targetKey) {
                                target = localTargets[year][targetKey];
                            }
                        }
                    }
                }
                
                // Ger√ßekle≈ümeyi hesapla
                const storeData = allData.filter(item => {
                    if (item.store !== storeName) return false;
                    if (!item.date) return false;
                    
                    if (month) {
                        // Aylƒ±k: Belirli yƒ±l ve ay
                        return item.date.startsWith(`${year}-${month}`);
                    } else {
                        // Yƒ±llƒ±k: Sadece yƒ±l
                        return item.date.startsWith(year);
                    }
                });
                
                const achieved = storeData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
                const percentage = target > 0 ? (achieved / target * 100) : 0;
                const remaining = target - achieved;
                
                // Kalan g√ºn hesapla
                const today = new Date();
                let daysLeft = 0;
                
                if (month) {
                    // Ayƒ±n son g√ºn√º
                    const lastDay = new Date(year, parseInt(month), 0);
                    daysLeft = Math.max(0, Math.ceil((lastDay - today) / (1000 * 60 * 60 * 24)));
                } else {
                    // Yƒ±lƒ±n son g√ºn√º
                    const lastDay = new Date(year, 11, 31);
                    daysLeft = Math.max(0, Math.ceil((lastDay - today) / (1000 * 60 * 60 * 24)));
                }
                
                const dailyRequired = daysLeft > 0 ? remaining / daysLeft : 0;
                
                return {
                    name: storeName,
                    target,
                    achieved,
                    percentage,
                    remaining,
                    daysLeft,
                    dailyRequired
                };
            }); // T√úM maƒüazalarƒ± g√∂ster (hedef olsun olmasƒ±n)
            
            // Hedefsiz maƒüazalarƒ± ayƒ±r (en alta koyacaƒüƒ±z)
            const storesWithTarget = storesData.filter(store => store.target > 0);
            const storesWithoutTarget = storesData.filter(store => store.target === 0);
            
            // Hedefli maƒüazalarƒ± y√ºzdeye g√∂re sƒ±rala
            storesWithTarget.sort((a, b) => b.percentage - a.percentage);
            
            // Hedefsiz maƒüazalarƒ± alfabetik sƒ±rala
            storesWithoutTarget.sort((a, b) => a.name.localeCompare(b.name, 'tr'));
            
            // √ñnce hedefli, sonra hedefsiz maƒüazalar
            const sortedStoresData = [...storesWithTarget, ...storesWithoutTarget];
            
            console.log(`üìä Toplam ${storesData.length} maƒüaza, ${storesWithTarget.length} hedefli, ${storesWithoutTarget.length} hedefsiz`);
            
            // Renk belirleme fonksiyonu
            function getPerformanceColor(percentage) {
                if (percentage >= 130) return '#10b981'; // Ye≈üil - Parlak
                if (percentage >= 100) return '#22c55e'; // Ye≈üil
                if (percentage >= 85) return '#f59e0b'; // Turuncu
                return '#ef4444'; // Kƒ±rmƒ±zƒ±
            }
            
            // HTML olu≈ütur
            let html = '<div style="margin-bottom: 20px; text-align: center;">';
            html += '<h3 style="margin: 0; font-size: 1.5em;">';
            html += (month ? year + ' - ' + ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'][parseInt(month) - 1] + ' D√∂nemi' : year + ' Yƒ±lƒ±') + ' Maƒüaza Hedef Durumlarƒ±';
            html += '</h3>';
            html += '<p style="color: #6c757d; margin-top: 5px;">Toplam ' + sortedStoresData.length + ' maƒüaza</p>';
            html += '</div>';
            html += '<div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">';
            
            sortedStoresData.forEach(store => {
                // Hedefsiz maƒüazalar i√ßin √∂zel g√∂r√ºn√ºm
                if (store.target === 0) {
                    html += '<div class="storeCard" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); color: white; opacity: 0.7;">';
                    html += '<h3 style="margin: 0 0 15px 0; font-size: 1.5em; color: white;">' + store.name + '</h3>';
                    html += '<div style="text-align: center; padding: 40px 0;">';
                    html += '<div style="font-size: 3em; margin-bottom: 10px;">üìä</div>';
                    html += '<div style="font-size: 1.1em; opacity: 0.9; margin-bottom: 10px;">Hedef Tanƒ±mlanmamƒ±≈ü</div>';
                    html += '<div style="font-size: 1.3em; font-weight: 600; margin-top: 15px;">';
                    html += 'Ger√ßekle≈üme: $' + store.achieved.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2});
                    html += '</div></div></div>';
                    return;
                }
                
                const bgColor = getPerformanceColor(store.percentage);
                const textColor = 'white';
                
                // ƒ∞√ßerik belirleme
                let contentHtml = '';
                
                if (store.percentage >= 130) {
                    // %130 hedefi a≈üƒ±ldƒ± - Ger√ßekle≈üen satƒ±≈üƒ± g√∂ster
                    contentHtml = '<div style="text-align: center; margin-bottom: 20px;">';
                    contentHtml += '<div style="font-size: 3em; font-weight: bold; margin-bottom: 5px;">' + store.percentage.toFixed(1) + '%</div>';
                    contentHtml += '<div style="font-size: 0.9em; opacity: 0.9;">Ger√ßekle≈üme</div>';
                    contentHtml += '</div>';
                    contentHtml += '<div style="text-align: center; font-size: 1.8em; margin: 20px 0;">üèÜ T√ºm Hedefler Tamamlandƒ±!</div>';
                    contentHtml += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;">';
                    contentHtml += '<div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">üìä Ger√ßekle≈üen</div>';
                    contentHtml += '<div style="font-size: 1.5em; font-weight: bold;">$' + store.achieved.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</div>';
                    contentHtml += '</div>';
                    contentHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; font-size: 0.9em;">';
                    contentHtml += '<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px;">';
                    contentHtml += '<div style="opacity: 0.9; margin-bottom: 3px;">üéØ %100 Hedef</div>';
                    contentHtml += '<div style="font-weight: bold;">$' + store.target.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + '</div>';
                    contentHtml += '</div>';
                    contentHtml += '<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px;">';
                    contentHtml += '<div style="opacity: 0.9; margin-bottom: 3px;">üèÜ %130 Hedef</div>';
                    contentHtml += '<div style="font-weight: bold;">$' + (store.target * 1.3).toLocaleString('tr-TR', {minimumFractionDigits: 2}) + '</div>';
                    contentHtml += '</div></div>';
                } else if (store.percentage >= 100) {
                    // %100 hedef ger√ßekle≈üti, %130 i√ßin bilgileri g√∂ster
                    contentHtml = '<div style="text-align: center; margin-bottom: 20px;">';
                    contentHtml += '<div style="font-size: 3em; font-weight: bold; margin-bottom: 5px;">' + store.percentage.toFixed(1) + '%</div>';
                    contentHtml += '<div style="font-size: 0.9em; opacity: 0.9;">Ger√ßekle≈üme</div>';
                    contentHtml += '</div>';
                    contentHtml += '<div style="text-align: center; font-size: 1.5em; margin: 15px 0; font-weight: bold;">‚úÖ Hedef Ger√ßekle≈üti!</div>';
                    
                    // %100 Hedefi i√ßin bilgiler - SADECE %130 ƒ∞√áƒ∞N G√ñSTER
                    const remaining130 = Math.max(0, (store.target * 1.3) - store.achieved);
                    const dailyRequired130 = store.daysLeft > 0 ? remaining130 / store.daysLeft : 0;
                    
                    contentHtml += '<div style="font-size: 0.95em; opacity: 0.95; margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.15); border-radius: 10px;">';
                    
                    // %130 Hedefi i√ßin bilgiler
                    contentHtml += '<div style="margin-bottom: 8px;">üéØ <strong>%130 Hedefi i√ßin:</strong></div>';
                    contentHtml += '<div style="margin-bottom: 5px;">üìä Ger√ßekle≈üen: <strong>$' + store.achieved.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + '</strong></div>';
                    contentHtml += '<div style="margin-bottom: 5px;">üìà Kalan: <strong>$' + remaining130.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + '</strong></div>';
                    contentHtml += '<div style="margin-bottom: 5px;">üìÖ Kalan G√ºn: <strong>' + store.daysLeft + '</strong></div>';
                    contentHtml += '<div>üí∞ G√ºnl√ºk Gerekli: <strong>$' + dailyRequired130.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + '</strong></div>';
                    contentHtml += '</div>';
                    
                    // HER ZAMAN HEDEF KARTLARINI G√ñSTER
                    contentHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">';
                    contentHtml += '<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;">';
                    contentHtml += '<div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">üéØ %100 Hedef</div>';
                    contentHtml += '<div style="font-size: 1.1em; font-weight: bold;">$' + store.target.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + '</div>';
                    contentHtml += '</div>';
                    contentHtml += '<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;">';
                    contentHtml += '<div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">üèÜ %130 Hedef</div>';
                    contentHtml += '<div style="font-size: 1.1em; font-weight: bold;">$' + (store.target * 1.3).toLocaleString('tr-TR', {minimumFractionDigits: 2}) + '</div>';
                    contentHtml += '</div></div>';
                } else {
                    // %100'√ºn altƒ±nda - Ekran g√∂r√ºnt√ºs√ºndeki gibi g√∂r√ºn√ºm
                    contentHtml = '<div style="text-align: center; margin-bottom: 20px;">';
                    contentHtml += '<div style="font-size: 3em; font-weight: bold; margin-bottom: 5px;">' + store.percentage.toFixed(1) + '%</div>';
                    contentHtml += '<div style="font-size: 0.9em; opacity: 0.9;">Ger√ßekle≈üme</div>';
                    contentHtml += '</div>';
                    
                    // %100 Hedefi i√ßin detaylƒ± bilgiler (HEDEF GER√áEKLE≈ûMEYENLER ƒ∞√áƒ∞N)
                    const remaining100 = Math.max(0, store.target - store.achieved);
                    const dailyRequired100 = store.daysLeft > 0 ? remaining100 / store.daysLeft : 0;
                    
                    contentHtml += '<div style="font-size: 0.95em; opacity: 0.95; margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.15); border-radius: 10px;">';
                    contentHtml += '<div style="margin-bottom: 8px;">üéØ <strong>%100 Hedefi i√ßin:</strong></div>';
                    contentHtml += '<div style="margin-bottom: 5px;">üìä Ger√ßekle≈üen: <strong>$' + store.achieved.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + '</strong></div>';
                    contentHtml += '<div style="margin-bottom: 5px;">üìà Kalan: <strong>$' + remaining100.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + '</strong></div>';
                    contentHtml += '<div style="margin-bottom: 5px;">üìÖ Kalan G√ºn: <strong>' + store.daysLeft + '</strong></div>';
                    contentHtml += '<div>üí∞ G√ºnl√ºk Gerekli: <strong>$' + dailyRequired100.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + '</strong></div>';
                    contentHtml += '</div>';
                    
                    // Ger√ßekle≈üen - B√ºy√ºk kart (ekran g√∂r√ºnt√ºs√º gibi)
                    contentHtml += '<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left;">';
                    contentHtml += '<div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">üìä Ger√ßekle≈üen</div>';
                    contentHtml += '<div style="font-size: 1.6em; font-weight: bold;">$' + store.achieved.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2}) + '</div>';
                    contentHtml += '</div>';
                    
                    // %100 ve %130 Hedefler - Yan yana k√º√ß√ºk kartlar
                    contentHtml += '<div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">';
                    contentHtml += '<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;">';
                    contentHtml += '<div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">üéØ %100 Hedef</div>';
                    contentHtml += '<div style="font-size: 1.1em; font-weight: bold;">$' + store.target.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + '</div>';
                    contentHtml += '</div>';
                    contentHtml += '<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;">';
                    contentHtml += '<div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">üèÜ %130 Hedef</div>';
                    contentHtml += '<div style="font-size: 1.1em; font-weight: bold;">$' + (store.target * 1.3).toLocaleString('tr-TR', {minimumFractionDigits: 2}) + '</div>';
                    contentHtml += '</div></div>';
                }
                
                html += '<div style="background: ' + bgColor + '; color: ' + textColor + '; padding: 25px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">';
                html += '<h3 style="margin: 0 0 20px 0; font-size: 1.3em; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 10px;">üè™ ' + store.name + '</h3>';
                html += contentHtml;
                html += '</div>';
            });
            
            html += '</div>';
            
            if (sortedStoresData.length === 0) {
                html = `
                    <div style="text-align: center; padding: 60px; background: #f8f9fa; border-radius: 15px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">üìä</div>
                        <h3 style="color: #6c757d; margin-bottom: 10px;">Hedef Bulunamadƒ±</h3>
                        <p style="color: #adb5bd;">Se√ßili d√∂nem i√ßin hi√ßbir maƒüazaya hedef tanƒ±mlanmamƒ±≈ü</p>
                    </div>
                `;
            }
            
            console.log(`üìä HTML olu≈üturuldu, container bulundu: ${!!container}, HTML uzunluƒüu: ${html.length}`);
            console.log(`üìä HTML ba≈ülangƒ±cƒ±:`, html.substring(0, 200));
            
            try {
                container.innerHTML = html;
                console.log(`‚úÖ HTML container'a yazƒ±ldƒ±!`);
            } catch (error) {
                console.error(`‚ùå HTML yazma hatasƒ±:`, error);
                console.log(`‚ùå Hatalƒ± HTML:`, html.substring(0, 500));
            }
        }
        
        // Yƒ±llƒ±k hedefi y√ºkle
        function loadYearlyTarget() {
            const yearElement = document.getElementById('targetYear');
            const storeElement = document.getElementById('targetYearStore');
            
            // Eƒüer elementler yoksa (yeni hedef sistemi kullanƒ±lƒ±yorsa), √ßƒ±k
            if (!yearElement || !storeElement) {
                console.log('‚ÑπÔ∏è Eski hedef sistemi elementleri bulunamadƒ±, yeni sistem kullanƒ±lƒ±yor');
                return;
            }
            
            const year = yearElement.value;
            const store = storeElement.value;
            
            // Maƒüaza adƒ±nƒ± temizle (kodlarƒ± kaldƒ±r)
            const cleanStoreName = store.replace(/\[.*?\]\s*/g, '').replace(/^.*?\s-\s/, '').trim();
            
            // Google Sheets kaldƒ±rƒ±ldƒ± - sadece localStorage fallback
            let yearlyTarget = null;
            
            // localStorage fallback
            if (!yearlyTarget) {
                const localTargets = JSON.parse(localStorage.getItem('yearlyTargets') || '{}')[year] || {};
                yearlyTarget = localTargets[store];
            }
            
            const yearlyTargets = {[store]: yearlyTarget};
            
            console.log('üìä loadYearlyTarget √ßaƒürƒ±ldƒ±:', {year, store, cleanStoreName, yearlyTarget});
            
            // Hedef inputunu temizle
            const targetInput = document.getElementById('yearlyTarget');
            targetInput.value = '';
            
            // Eƒüer bu maƒüaza i√ßin hedef varsa doldur
            if (yearlyTargets[store]) {
                targetInput.value = yearlyTargets[store];
                console.log('‚úÖ Yƒ±llƒ±k hedef y√ºklendi (Google Sheets):', yearlyTargets[store]);
            } else {
                console.log('‚ö†Ô∏è Bu maƒüaza i√ßin kaydedilmi≈ü hedef yok');
            }
            
            calculateTargets();
        }
        
        // Aylƒ±k hedefleri kaydet
        function saveMonthlyTarget() {
            const year = document.getElementById('targetYear').value;
            const month = document.getElementById('targetMonth').value;
            const store = document.getElementById('targetMonthStore').value;
            const target = parseFloat(document.getElementById('monthlyTarget').value) || 0;
            
            console.log('üíæ saveMonthlyTarget √ßaƒürƒ±ldƒ±:', {year, month, store, target});
            
            if (target <= 0) {
                alert('‚ö†Ô∏è L√ºtfen ge√ßerli bir hedef girin!');
                return;
            }
            
            // Mevcut hedefleri al
            let monthlyTargets = JSON.parse(localStorage.getItem('monthlyTargets') || '{}');
            console.log('üìÇ Mevcut aylƒ±k localStorage:', monthlyTargets);
            
            // Yƒ±l yoksa olu≈ütur
            if (!monthlyTargets[year]) {
                monthlyTargets[year] = {};
            }
            
            // Maƒüaza yoksa olu≈ütur
            if (!monthlyTargets[year][store]) {
                monthlyTargets[year][store] = {};
            }
            
            // Maƒüaza ve ay bazƒ±nda hedefi kaydet
            monthlyTargets[year][store][month] = target;
            localStorage.setItem('monthlyTargets', JSON.stringify(monthlyTargets));
            
            console.log('‚úÖ Aylƒ±k localStorage\'a kaydedildi:', monthlyTargets);
            
            // Hesapla
            calculateTargets();
            
            // Ay adƒ±nƒ± bul
            const monthNames = {
                '01': 'Ocak', '02': '≈ûubat', '03': 'Mart', '04': 'Nisan',
                '05': 'Mayƒ±s', '06': 'Haziran', '07': 'Temmuz', '08': 'Aƒüustos',
                '09': 'Eyl√ºl', '10': 'Ekim', '11': 'Kasƒ±m', '12': 'Aralƒ±k'
            };
            
            // Bildirim
            const storeText = store === 'T√úM MAƒûAZALAR' ? 'T√ºm Maƒüazalar' : store;
            alert(`‚úÖ ${year} ${monthNames[month]} ${storeText} hedefi kaydedildi: $${target.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`);
        }
        
        // Aylƒ±k hedefi y√ºkle
        function loadMonthlyTarget() {
            const yearElement = document.getElementById('targetYear');
            const monthElement = document.getElementById('targetMonth');
            const storeElement = document.getElementById('targetMonthStore');
            
            // Eƒüer elementler yoksa (yeni hedef sistemi kullanƒ±lƒ±yorsa), √ßƒ±k
            if (!yearElement || !monthElement || !storeElement) {
                console.log('‚ÑπÔ∏è Eski hedef sistemi elementleri bulunamadƒ±, yeni sistem kullanƒ±lƒ±yor');
                return;
            }
            
            const year = yearElement.value;
            const month = monthElement.value;
            const store = storeElement.value;
            
            // Maƒüaza adƒ±nƒ± temizle (kodlarƒ± kaldƒ±r)
            const cleanStoreName = store.replace(/\[.*?\]\s*/g, '').replace(/^.*?\s-\s/, '').trim();
            
            // Google Sheets kaldƒ±rƒ±ldƒ± - sadece localStorage fallback
            const localTarget = JSON.parse(localStorage.getItem('monthlyTargets') || '{}')[year]?.[store]?.[month];
            const target = localTarget;
            
            console.log('üìä loadMonthlyTarget √ßaƒürƒ±ldƒ±:', {year, month, store, localTarget});
            
            // Hedef inputunu temizle
            const targetInput = document.getElementById('monthlyTarget');
            targetInput.value = '';
            
            // Eƒüer bu maƒüaza ve ay i√ßin hedef varsa doldur
            if (target) {
                targetInput.value = target;
                console.log(`‚úÖ Aylƒ±k hedef y√ºklendi (localStorage):`, target);
            } else {
                console.log('‚ö†Ô∏è Bu maƒüaza ve ay i√ßin kaydedilmi≈ü hedef yok');
            }
            
            calculateTargets();
        }
        
        // NOT: Hedefler artƒ±k loadData() i√ßinde veriler y√ºklendikten sonra y√ºkleniyor
        
        function calculateTargets() {
            // Maƒüazalarƒ± doldur (ilk kez √ßaƒürƒ±ldƒ±ƒüƒ±nda)
            populateTargetStoreDropdowns();
            
            const targetYear = document.getElementById('targetYear').value;
            const targetMonth = document.getElementById('targetMonth').value;
            const yearStore = document.getElementById('targetYearStore').value;
            const monthStore = document.getElementById('targetMonthStore').value;
            
            // Hedefleri Google Sheets'ten veya input'tan al
            let yearlyTarget = parseFloat(document.getElementById('yearlyTarget').value) || 0;
            let monthlyTarget = parseFloat(document.getElementById('monthlyTarget').value) || 0;
            
            // Google Sheets kaldƒ±rƒ±ldƒ± - hedefler targets.json'dan veya localStorage'dan geliyor
            
            // Yƒ±llƒ±k hesaplama - HER ZAMAN ger√ßekle≈ümeyi g√∂ster (hedef olsun/olmasƒ±n)
            const yearlyData = allData.filter(item => {
                if (!item.date) return false;
                const dateMatch = item.date.startsWith(targetYear);
                const storeMatch = yearStore === 'T√úM MAƒûAZALAR' || item.store === yearStore;
                return dateMatch && storeMatch;
            });
            
            const yearlyAchieved = yearlyData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            
            if (yearlyTarget > 0) {
                const yearlyRemaining = Math.max(0, yearlyTarget - yearlyAchieved);
                const yearlyPercent = (yearlyAchieved / yearlyTarget) * 100; // Math.min kaldƒ±rƒ±ldƒ±, %100 √ºst√º g√∂sterilecek
                
                // Kalan g√ºnleri hesapla
                const today = new Date();
                const endOfYear = new Date(targetYear, 11, 31);
                const daysLeft = Math.max(0, Math.ceil((endOfYear - today) / (1000 * 60 * 60 * 24)));
                const dailyRequired = daysLeft > 0 ? yearlyRemaining / daysLeft : 0;
                
                // Progress bar max 100% geni≈ülikte kalƒ±r, ama text ger√ßek y√ºzdeyi g√∂sterir
                document.getElementById('yearlyProgress').style.width = Math.min(100, yearlyPercent) + '%';
                document.getElementById('yearlyProgress').textContent = yearlyPercent.toFixed(1) + '%';
                document.getElementById('yearlyAchieved').textContent = '$' + yearlyAchieved.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                document.getElementById('yearlyRemaining').textContent = '$' + yearlyRemaining.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                document.getElementById('yearlyDaysLeft').textContent = daysLeft;
                document.getElementById('yearlyDailyRequired').textContent = '$' + dailyRequired.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            } else {
                // Hedef yoksa sadece ger√ßekle≈ümeyi g√∂ster, diƒüer alanlarƒ± temizle
                document.getElementById('yearlyProgress').style.width = '0%';
                document.getElementById('yearlyProgress').textContent = '0%';
                document.getElementById('yearlyAchieved').textContent = '$' + yearlyAchieved.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                document.getElementById('yearlyRemaining').textContent = '$0,00';
                document.getElementById('yearlyDaysLeft').textContent = '-';
                document.getElementById('yearlyDailyRequired').textContent = '$0,00';
            }
            
            // Aylƒ±k hesaplama - HER ZAMAN ger√ßekle≈ümeyi g√∂ster (hedef olsun/olmasƒ±n)
            const monthlyData = allData.filter(item => {
                if (!item.date) return false;
                const itemDate = item.date.split('-');
                const dateMatch = itemDate[0] === targetYear && itemDate[1] === targetMonth;
                const storeMatch = monthStore === 'T√úM MAƒûAZALAR' || item.store === monthStore;
                return dateMatch && storeMatch;
            });
            
            const monthlyAchieved = monthlyData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            
            if (monthlyTarget > 0) {
                const monthlyRemaining = Math.max(0, monthlyTarget - monthlyAchieved);
                const monthlyPercent = (monthlyAchieved / monthlyTarget) * 100; // Math.min kaldƒ±rƒ±ldƒ±, %100 √ºst√º g√∂sterilecek
                
                // Kalan g√ºnleri hesapla
                const today = new Date();
                const endOfMonth = new Date(targetYear, parseInt(targetMonth), 0);
                const daysLeft = Math.max(0, Math.ceil((endOfMonth - today) / (1000 * 60 * 60 * 24)));
                const dailyRequired = daysLeft > 0 ? monthlyRemaining / daysLeft : 0;
                
                // Progress bar max 100% geni≈ülikte kalƒ±r, ama text ger√ßek y√ºzdeyi g√∂sterir
                document.getElementById('monthlyProgress').style.width = Math.min(100, monthlyPercent) + '%';
                document.getElementById('monthlyProgress').textContent = monthlyPercent.toFixed(1) + '%';
                document.getElementById('monthlyAchieved').textContent = '$' + monthlyAchieved.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                document.getElementById('monthlyRemaining').textContent = '$' + monthlyRemaining.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                document.getElementById('monthlyDaysLeft').textContent = daysLeft;
                document.getElementById('monthlyDailyRequired').textContent = '$' + dailyRequired.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            } else {
                // Hedef yoksa sadece ger√ßekle≈ümeyi g√∂ster, diƒüer alanlarƒ± temizle
                document.getElementById('monthlyProgress').style.width = '0%';
                document.getElementById('monthlyProgress').textContent = '0%';
                document.getElementById('monthlyAchieved').textContent = '$' + monthlyAchieved.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                document.getElementById('monthlyRemaining').textContent = '$0,00';
                document.getElementById('monthlyDaysLeft').textContent = '-';
                document.getElementById('monthlyDailyRequired').textContent = '$0,00';
            }
            
            // Grafik √ßiz
            renderTargetChart();
        }
        
        function renderTargetChart() {
            const ctx = document.getElementById('targetChart');
            if (!ctx) return;
            
            // Aylƒ±k satƒ±≈ü verileri
            const months = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 
                           'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            const targetYear = document.getElementById('targetYear').value;
            const yearStore = document.getElementById('targetYearStore').value;
            
            const monthlySales = months.map((month, index) => {
                const monthNum = String(index + 1).padStart(2, '0');
                const monthData = allData.filter(item => {
                    if (!item.date) return false;
                    const itemDate = item.date.split('-');
                    const dateMatch = itemDate[0] === targetYear && itemDate[1] === monthNum;
                    const storeMatch = yearStore === 'T√úM MAƒûAZALAR' || item.store === yearStore;
                    return dateMatch && storeMatch;
                });
                return monthData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            });
            
            if (targetChart) {
                targetChart.destroy();
            }
            
            targetChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Aylƒ±k Satƒ±≈ü (USD)',
                        data: monthlySales,
                        backgroundColor: 'rgba(102, 126, 234, 0.8)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true,
                            position: 'top'
                        },
                        title: {
                            display: true,
                            text: `${targetYear} Yƒ±lƒ± Aylƒ±k Satƒ±≈ü Performansƒ± ${yearStore !== 'T√úM MAƒûAZALAR' ? '(' + yearStore + ')' : ''}`,
                            font: {
                                size: 16,
                                weight: 'bold'
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // ==================== CUSTOMER ANALYSIS ====================
        let customerCityChart = null;
        let customerTrendChart = null;
        
        function analyzeCustomers() {
            // M√º≈üteri verilerini analiz et
            const customerData = {};
            const today = new Date();
            const ninetyDaysAgo = new Date(today.getTime() - (90 * 24 * 60 * 60 * 1000));
            
            allData.forEach(item => {
                const partner = item.partner;
                if (!partner) return;
                
                if (!customerData[partner]) {
                    customerData[partner] = {
                        name: partner,
                        totalSales: 0,
                        orderCount: 0,
                        city: item.city || 'Bilinmiyor',
                        lastOrderDate: item.date || ''
                    };
                }
                
                customerData[partner].totalSales += parseFloat(item.usd_amount || 0);
                customerData[partner].orderCount += 1;
                
                if (item.date && item.date > customerData[partner].lastOrderDate) {
                    customerData[partner].lastOrderDate = item.date;
                }
            });
            
            // Array'e √ßevir ve sƒ±rala
            const customers = Object.values(customerData).sort((a, b) => b.totalSales - a.totalSales);
            
            // ƒ∞statistikler
            const totalCustomers = customers.length;
            const activeCustomers = customers.filter(c => {
                if (!c.lastOrderDate) return false;
                const lastOrder = new Date(c.lastOrderDate);
                return lastOrder >= ninetyDaysAgo;
            }).length;
            
            const avgOrderValue = customers.reduce((sum, c) => sum + c.totalSales, 0) / totalCustomers;
            const maxOrderValue = customers.length > 0 ? customers[0].totalSales : 0;
            
            document.getElementById('totalCustomers').textContent = totalCustomers.toLocaleString('tr-TR');
            document.getElementById('activeCustomers').textContent = activeCustomers.toLocaleString('tr-TR');
            document.getElementById('avgOrderValue').textContent = '$' + avgOrderValue.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('maxOrderValue').textContent = '$' + maxOrderValue.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            
            // Top 30 m√º≈üteri kartlarƒ± (otomatik g√∂ster)
            renderTopCustomers(customers.slice(0, 30));
            
            // Grafikler
            renderCustomerCityChart(customers);
            renderCustomerTrendChart();
        }
        
        function renderTopCustomers(topCustomers) {
            const grid = document.getElementById('topCustomersGrid');
            grid.innerHTML = '';
            
            topCustomers.forEach((customer, index) => {
                const card = document.createElement('div');
                card.className = 'customer-card';
                card.innerHTML = `
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <span class="customer-rank">${index + 1}</span>
                        <div style="flex: 1;">
                            <h4 style="margin: 0; font-size: 1.1em;">${customer.name}</h4>
                            <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 0.9em;">üìç ${customer.city}</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                            <p style="margin: 0; font-size: 0.85em; color: #6c757d;">Toplam Satƒ±≈ü</p>
                            <p style="margin: 5px 0 0 0; font-size: 1.2em; font-weight: 700; color: #667eea;">$${customer.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                            <p style="margin: 0; font-size: 0.85em; color: #6c757d;">Sipari≈ü Sayƒ±sƒ±</p>
                            <p style="margin: 5px 0 0 0; font-size: 1.2em; font-weight: 700; color: #764ba2;">${customer.orderCount}</p>
                        </div>
                    </div>
                `;
                grid.appendChild(card);
            });
        }
        
        function renderCustomerCityChart(customers) {
            const ctx = document.getElementById('customerCityChart');
            if (!ctx) return;
            
            // ≈ûehir bazƒ±nda m√º≈üteri sayƒ±sƒ±
            const cityData = {};
            customers.forEach(c => {
                const city = c.city || 'Bilinmiyor';
                cityData[city] = (cityData[city] || 0) + 1;
            });
            
            const sortedCities = Object.entries(cityData)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 10);
            
            if (customerCityChart) {
                customerCityChart.destroy();
            }
            
            customerCityChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sortedCities.map(c => c[0]),
                    datasets: [{
                        data: sortedCities.map(c => c[1]),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(255, 99, 132, 0.8)',
                            'rgba(54, 162, 235, 0.8)',
                            'rgba(255, 206, 86, 0.8)',
                            'rgba(75, 192, 192, 0.8)',
                            'rgba(153, 102, 255, 0.8)',
                            'rgba(255, 159, 64, 0.8)',
                            'rgba(199, 199, 199, 0.8)',
                            'rgba(83, 102, 255, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right'
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: (value, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (value * 100 / sum).toFixed(1) + "%";
                                return percentage;
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
        
        function renderCustomerTrendChart() {
            const ctx = document.getElementById('customerTrendChart');
            if (!ctx) return;
            
            console.log('üìä Yƒ±llƒ±k M√º≈üteri Trendi olu≈üturuluyor...');
            
            // Yƒ±llara g√∂re m√º≈üteri sayƒ±sƒ± (Dashboard gibi)
            const yearlyCustomers = {};
            const years = new Set();
            
            allData.forEach(item => {
                if (!item.date || !item.partner) return;
                const year = item.date.substring(0, 4);
                years.add(year);
                if (!yearlyCustomers[year]) {
                    yearlyCustomers[year] = new Set();
                }
                yearlyCustomers[year].add(item.partner);
            });
            
            // Yƒ±llarƒ± sƒ±rala
            const sortedYears = Array.from(years).sort();
            const customerCounts = sortedYears.map(year => yearlyCustomers[year].size);
            
            console.log('üìä Yƒ±llar:', sortedYears);
            console.log('üìä M√º≈üteri sayƒ±larƒ±:', customerCounts);
            
            if (customerTrendChart) {
                customerTrendChart.destroy();
            }
            
            // Renk paleti (Dashboard ile aynƒ±)
            const colors = [
                'rgba(102, 126, 234, 0.8)',   // 2020 - Mor
                'rgba(250, 112, 154, 0.8)',   // 2021 - Pembe
                'rgba(56, 239, 125, 0.8)',    // 2022 - Ye≈üil
                'rgba(255, 193, 7, 0.8)',     // 2023 - Sarƒ±
                'rgba(245, 87, 108, 0.8)',    // 2024 - Kƒ±rmƒ±zƒ±
                'rgba(72, 219, 251, 0.8)'     // 2025 - Turkuaz
            ];
            
            customerTrendChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedYears,
                    datasets: [{
                        label: 'Aktif M√º≈üteri Sayƒ±sƒ±',
                        data: customerCounts,
                        backgroundColor: sortedYears.map((year, idx) => colors[idx % colors.length]),
                        borderColor: sortedYears.map((year, idx) => colors[idx % colors.length].replace('0.8', '1')),
                        borderWidth: 2,
                        borderRadius: 10,
                        barThickness: 60
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    aspectRatio: 3,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'M√º≈üteri: ' + context.parsed.y.toLocaleString('tr-TR');
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    },
                    animation: {
                        duration: 1000,
                        easing: 'easeInOutQuart'
                    }
                },
                plugins: [ChartDataLabels]
            });
            
            console.log('‚úÖ Yƒ±llƒ±k M√º≈üteri Trendi grafiƒüi olu≈üturuldu');
        }

        // ==================== AI ANALYSIS & INSIGHTS ====================
        function performAIAnalysis() {
            console.log('ü§ñ AI Analiz ba≈ülatƒ±lƒ±yor...');
            
            const panel = document.getElementById('aiAnalysisPanel');
            if (!panel || filteredData.length === 0) return;
            
            // Veri analizi
            const analysis = analyzeData(filteredData);
            
            // √ñng√∂r√ºler ve √∂neriler
            const insights = generateInsights(analysis);
            
            // HTML olu≈ütur
            let html = `
                <div class="analysis-panel">
                    <h2 style="margin: 0 0 20px 0; font-size: 2em;">ü§ñ AI Analiz & √ñneriler</h2>
                    <p style="opacity: 0.9; margin-bottom: 20px;">Filtrelenen ${filteredData.length.toLocaleString('tr-TR')} kayƒ±t √ºzerinden yapƒ±lan akƒ±llƒ± analiz sonu√ßlarƒ±</p>
                    
                    ${insights.positive.length > 0 ? `
                    <div class="analysis-section">
                        <h3>‚úÖ Olumlu Tespitler</h3>
                        ${insights.positive.map(item => `
                            <div class="insight-item insight-positive">
                                <span class="insight-icon">‚úÖ</span>
                                <strong>${item.title}</strong><br>
                                ${item.description}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.negative.length > 0 ? `
                    <div class="analysis-section">
                        <h3>‚ö†Ô∏è Dikkat Edilmesi Gerekenler</h3>
                        ${insights.negative.map(item => `
                            <div class="insight-item insight-negative">
                                <span class="insight-icon">‚ö†Ô∏è</span>
                                <strong>${item.title}</strong><br>
                                ${item.description}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.neutral.length > 0 ? `
                    <div class="analysis-section">
                        <h3>üí° √ñnemli Bilgiler</h3>
                        ${insights.neutral.map(item => `
                            <div class="insight-item insight-neutral">
                                <span class="insight-icon">üí°</span>
                                <strong>${item.title}</strong><br>
                                ${item.description}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="analysis-section">
                        <h3>üéØ Aksiyon √ñnerileri</h3>
                        ${insights.recommendations.map(item => `
                            <div class="recommendation">
                                <span class="recommendation-icon">${item.icon}</span>
                                <div>
                                    <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                    <p style="margin: 10px 0 0 0; opacity: 0.95;">${item.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            panel.innerHTML = html;
            panel.style.display = 'block';
        }
        
        function analyzeData(data) {
            // Temel metrikler
            const totalUSD = data.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = data.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const avgOrderValue = totalUSD / data.length;
            
            // Maƒüaza analizi
            const storeData = {};
            data.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) {
                    storeData[store] = {sales: 0, count: 0, qty: 0};
                }
                storeData[store].sales += parseFloat(item.usd_amount || 0);
                storeData[store].count += 1;
                storeData[store].qty += parseFloat(item.quantity || 0);
            });
            
            // Marka analizi
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) {
                    brandData[brand] = {sales: 0, count: 0};
                }
                brandData[brand].sales += parseFloat(item.usd_amount || 0);
                brandData[brand].count += 1;
            });
            
            // Kategori analizi
            const categoryData = {};
            data.forEach(item => {
                const cat = item.category_1 || 'Bilinmiyor';
                if (!categoryData[cat]) {
                    categoryData[cat] = {sales: 0, count: 0};
                }
                categoryData[cat].sales += parseFloat(item.usd_amount || 0);
                categoryData[cat].count += 1;
            });
            
            // M√º≈üteri analizi
            const customerData = {};
            data.forEach(item => {
                const customer = item.partner || 'Bilinmiyor';
                if (!customerData[customer]) {
                    customerData[customer] = {sales: 0, count: 0};
                }
                customerData[customer].sales += parseFloat(item.usd_amount || 0);
                customerData[customer].count += 1;
            });
            
            // Satƒ±≈ü temsilcisi analizi
            const salesPersonData = {};
            data.forEach(item => {
                const person = item.sales_person || 'Bilinmiyor';
                if (!salesPersonData[person]) {
                    salesPersonData[person] = {sales: 0, count: 0};
                }
                salesPersonData[person].sales += parseFloat(item.usd_amount || 0);
                salesPersonData[person].count += 1;
            });
            
            // Tarih analizi
            const dateData = {};
            data.forEach(item => {
                if (!item.date) return;
                const month = item.date.substring(0, 7);
                if (!dateData[month]) {
                    dateData[month] = {sales: 0, count: 0};
                }
                dateData[month].sales += parseFloat(item.usd_amount || 0);
                dateData[month].count += 1;
            });
            
            // Sƒ±ralama
            const topStores = Object.entries(storeData).sort((a, b) => b[1].sales - a[1].sales);
            const topBrands = Object.entries(brandData).sort((a, b) => b[1].sales - a[1].sales);
            const topCategories = Object.entries(categoryData).sort((a, b) => b[1].sales - a[1].sales);
            const topCustomers = Object.entries(customerData).sort((a, b) => b[1].sales - a[1].sales);
            const topSalesPersons = Object.entries(salesPersonData).sort((a, b) => b[1].sales - a[1].sales);
            
            return {
                totalUSD,
                totalQty,
                avgOrderValue,
                recordCount: data.length,
                storeData,
                brandData,
                categoryData,
                customerData,
                salesPersonData,
                dateData,
                topStores,
                topBrands,
                topCategories,
                topCustomers,
                topSalesPersons
            };
        }
        
        function generateInsights(analysis) {
            const insights = {
                positive: [],
                negative: [],
                neutral: [],
                recommendations: []
            };
            
            // Olumlu tespitler
            if (analysis.topStores.length > 0) {
                const topStore = analysis.topStores[0];
                const storePercent = (topStore[1].sales / analysis.totalUSD * 100).toFixed(1);
                if (storePercent > 30) {
                    insights.positive.push({
                        title: `En Ba≈üarƒ±lƒ± Maƒüaza: ${topStore[0]}`,
                        description: `<span class="metric-highlight">$${topStore[1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span> satƒ±≈ü ile toplam satƒ±≈ülarƒ±n <span class="metric-highlight">%${storePercent}</span>'ini ger√ßekle≈ütirmi≈ü. M√ºkemmel performans! üéâ`
                    });
                }
            }
            
            if (analysis.topBrands.length > 0) {
                const topBrand = analysis.topBrands[0];
                insights.positive.push({
                    title: `En √áok Satan Marka: ${topBrand[0]}`,
                    description: `<span class="metric-highlight">${topBrand[1].count}</span> adet satƒ±≈ü ile lider marka. Stok y√∂netimine dikkat edin.`
                });
            }
            
            if (analysis.avgOrderValue > 100) {
                insights.positive.push({
                    title: 'Y√ºksek Ortalama Sipari≈ü Deƒüeri',
                    description: `Ortalama sipari≈ü deƒüeri <span class="metric-highlight">$${analysis.avgOrderValue.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span>. M√º≈üteriler y√ºksek deƒüerli √ºr√ºnleri tercih ediyor.`
                });
            }
            
            // Dikkat edilmesi gerekenler
            if (analysis.topStores.length > 1) {
                const topStore = analysis.topStores[0];
                const secondStore = analysis.topStores[1];
                const gap = ((topStore[1].sales - secondStore[1].sales) / topStore[1].sales * 100).toFixed(1);
                if (gap > 50) {
                    insights.negative.push({
                        title: 'Maƒüazalar Arasƒ± Dengesizlik',
                        description: `${topStore[0]} ile ${secondStore[0]} arasƒ±nda <span class="metric-highlight">%${gap}</span> fark var. D√º≈ü√ºk performanslƒ± maƒüazalara destek gerekebilir.`
                    });
                }
            }
            
            if (analysis.topCustomers.length > 0) {
                const topCustomer = analysis.topCustomers[0];
                const customerPercent = (topCustomer[1].sales / analysis.totalUSD * 100).toFixed(1);
                if (customerPercent > 20) {
                    insights.negative.push({
                        title: 'Tek M√º≈üteriye Baƒüƒ±mlƒ±lƒ±k Riski',
                        description: `${topCustomer[0]} toplam satƒ±≈ülarƒ±n <span class="metric-highlight">%${customerPercent}</span>'ini olu≈üturuyor. M√º≈üteri portf√∂y√ºn√º √ße≈üitlendirmeyi d√º≈ü√ºn√ºn.`
                    });
                }
            }
            
            if (analysis.recordCount < 10) {
                insights.negative.push({
                    title: 'D√º≈ü√ºk Veri Hacmi',
                    description: `Sadece <span class="metric-highlight">${analysis.recordCount}</span> kayƒ±t analiz edildi. Daha geni≈ü tarih aralƒ±ƒüƒ± se√ßerek daha saƒülƒ±klƒ± analiz yapabilirsiniz.`
                });
            }
            
            // √ñnemli bilgiler
            // En Pop√ºler Kategoriler (All ve Analitik olanlarƒ± hari√ß tut)
            const validCategories = analysis.topCategories.filter(cat => 
                !cat[0].toLowerCase().includes('all') && 
                !cat[0].toLowerCase().includes('analitik') &&
                !cat[0].toLowerCase().includes('eƒüitim')
            ).slice(0, 5);
            
            if (validCategories.length > 0) {
                const categoryDetails = validCategories.map((cat, idx) => {
                    const percent = (cat[1].sales / analysis.totalUSD * 100).toFixed(1);
                    return `${idx + 1}. <strong>${cat[0]}</strong>: <span class="metric-highlight">${cat[1].count}</span> adet, <span class="metric-highlight">%${percent}</span>`;
                }).join('<br>');
                
                insights.neutral.push({
                    title: 'üé∏ En Pop√ºler Kategoriler (ƒ∞lk 5)',
                    description: categoryDetails
                });
            }
            
            // En Ba≈üarƒ±lƒ± Satƒ±≈ü Temsilcileri (ƒ∞lk 5)
            if (analysis.topSalesPersons.length > 0) {
                const topSalesPersons = analysis.topSalesPersons.slice(0, 5);
                const salesPersonDetails = topSalesPersons.map((person, idx) => {
                    const percent = (person[1].sales / analysis.totalUSD * 100).toFixed(1);
                    return `${idx + 1}. <strong>${person[0]}</strong>: <span class="metric-highlight">$${person[1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span> (<span class="metric-highlight">%${percent}</span>)`;
                }).join('<br>');
                
                insights.neutral.push({
                    title: 'üë§ En Ba≈üarƒ±lƒ± Satƒ±≈ü Temsilcileri (ƒ∞lk 5)',
                    description: salesPersonDetails
                });
            }
            
            const uniqueCustomers = Object.keys(analysis.customerData).length;
            insights.neutral.push({
                title: 'M√º≈üteri √áe≈üitliliƒüi',
                description: `<span class="metric-highlight">${uniqueCustomers}</span> farklƒ± m√º≈üteri ile i≈ülem yapƒ±lmƒ±≈ü.`
            });
            
            // √ñneriler
            insights.recommendations.push({
                icon: 'üéØ',
                title: 'Hedef Belirleme',
                description: `Mevcut performans: <span class="metric-highlight">$${analysis.totalUSD.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span>. "Hedef Takip" sekmesinden aylƒ±k/yƒ±llƒ±k hedeflerinizi belirleyin ve ilerlemenizi takip edin.`
            });
            
            if (analysis.topStores.length > 1) {
                const weakStores = analysis.topStores.slice(-2);
                insights.recommendations.push({
                    icon: 'üìà',
                    title: 'D√º≈ü√ºk Performanslƒ± Maƒüazalara Odaklanƒ±n',
                    description: `${weakStores.map(s => s[0]).join(' ve ')} maƒüazalarƒ±nƒ±n performansƒ±nƒ± artƒ±rmak i√ßin √∂zel kampanyalar d√ºzenleyin.`
                });
            }
            
            // En √áok Satan Markalar (ƒ∞lk 5)
            if (analysis.topBrands.length > 0) {
                const topBrands = analysis.topBrands.slice(0, 5);
                const brandDetails = topBrands.map((brand, idx) => {
                    const percent = (brand[1].sales / analysis.totalUSD * 100).toFixed(1);
                    return `${idx + 1}. <strong>${brand[0]}</strong>: <span class="metric-highlight">${brand[1].count}</span> adet, <span class="metric-highlight">%${percent}</span>`;
                }).join('<br>');
                
                insights.recommendations.push({
                    icon: 'üè∑Ô∏è',
                    title: 'Stok Optimizasyonu - En √áok Satan Markalar (ƒ∞lk 5)',
                    description: brandDetails + '<br><br>Bu markalarƒ±n stok seviyelerini yakƒ±ndan takip edin.'
                });
            }
            
            insights.recommendations.push({
                icon: 'üë•',
                title: 'M√º≈üteri ƒ∞li≈ükileri',
                description: `"M√º≈üteri Analizi" sekmesinden top m√º≈üterilerinizi inceleyin ve √∂zel teklifler sunarak sadakati artƒ±rƒ±n.`
            });
            
            if (analysis.avgOrderValue < 50) {
                insights.recommendations.push({
                    icon: 'üí∞',
                    title: 'Ortalama Sipari≈ü Deƒüerini Artƒ±rƒ±n',
                    description: `Mevcut ortalama: <span class="metric-highlight">$${analysis.avgOrderValue.toFixed(2)}</span>. Cross-selling ve up-selling stratejileri uygulayƒ±n.`
                });
            }
            
            insights.recommendations.push({
                icon: 'üìä',
                title: 'D√ºzenli Raporlama',
                description: `"Excel'e Aktar" √∂zelliƒüini kullanarak haftalƒ±k/aylƒ±k raporlar olu≈üturun ve trendleri takip edin.`
            });
            
            return insights;
        }

        // ==================== DASHBOARD ====================
        let dashYearlyChartInstance = null;
        let dashTopStoresChartInstance = null;
        let dashTopSalespeopleChartInstance = null;
        let dashTopBrandsChartInstance = null;
        let dashTopCategoriesChartInstance = null;
        let dashTopCitiesChartInstance = null;
        let dashTopProductsChartInstance = null;

        function loadDashboard() {
            console.log('üè† Dashboard y√ºkleniyor...');
            
            if (!allData || allData.length === 0) {
                console.warn('‚ö†Ô∏è Veri yok, dashboard y√ºklenemedi');
                return;
            }
            
            // Genel istatistikler
            const totalSales = allData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = allData.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const uniqueCustomers = new Set(allData.map(item => item.partner).filter(Boolean)).size;
            const uniqueProducts = new Set(allData.map(item => item.product).filter(Boolean)).size;
            const uniqueStores = new Set(allData.map(item => item.store).filter(Boolean)).size;
            const uniqueSalespeople = new Set(allData.map(item => item.sales_person).filter(Boolean)).size;
            
            // G√ºnl√ºk Ortalama ve Sepet Ortalamasƒ± Hesaplama (GLOBAL MANTIK - Dƒ∞ƒûER SEKMELERLE AYNI)
            // G√ºnl√ºk Ortalama = Toplam USD / Benzersiz Tarih Sayƒ±sƒ± (t√ºm zamanlar)
            const uniqueDates = new Set(allData.map(item => item.date).filter(Boolean)).size;
            const dailyAverage = uniqueDates > 0 ? totalSales / uniqueDates : 0;
            
            // Sepet Ortalamasƒ± = Toplam USD / Satƒ±≈ü Fatura Sayƒ±sƒ± (ƒ∞adeler Hari√ß)
            const uniqueInvoices = new Set(allData.filter(item => item.move_type === 'out_invoice').map(item => item.move_name).filter(Boolean)).size;
            const basketAverage = uniqueInvoices > 0 ? totalSales / uniqueInvoices : 0;
            
            console.log('üìÖ Benzersiz G√ºn Sayƒ±sƒ± (T√ºm Zamanlar):', uniqueDates);
            console.log('üí∞ Toplam Satƒ±≈ü:', totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2}));
            console.log('üì¶ Toplam Kayƒ±t Sayƒ±sƒ±:', allData.length.toLocaleString('tr-TR'));
            console.log('üßæ Toplam Fatura Sayƒ±sƒ±:', uniqueInvoices.toLocaleString('tr-TR'));
            console.log('üìä G√ºnl√ºk Ortalama:', dailyAverage.toLocaleString('tr-TR', {minimumFractionDigits: 2}), '(Toplam Satƒ±≈ü /', uniqueDates, 'g√ºn)');
            console.log('üõí Sepet Ortalamasƒ±:', basketAverage.toLocaleString('tr-TR', {minimumFractionDigits: 2}), '(Toplam Satƒ±≈ü /', uniqueInvoices, 'fatura)');
            
            // Cache versiyonunu g√ºncelle
            document.getElementById('cacheVersion').textContent = getDailyVersion();
            
            // Yƒ±llƒ±k kar≈üƒ±la≈ütƒ±rma
            renderDashYearlyChart();
            
            // Top performanslar (T√úM ZAMANLAR)
            renderDashTopStoresChart(allData);
            renderDashTopSalespeopleChart(allData);
            renderDashTopBrandsChart(allData);
            renderDashTopCategoriesChart(allData);
            renderDashTopCitiesChart(allData);
            renderDashTopProductsChart(allData);
            
            // AI Analizi
            performDashboardAIAnalysis();
        }

        let dashYearlyMetricType = 'sales'; // Default: satƒ±≈ü
        let dashYearlyDataCache = null; // Veriyi cache'le

        function changeDashYearlyMetric(type) {
            dashYearlyMetricType = type;
            
            // Buton stillerini g√ºncelle
            const salesBtn = document.getElementById('dashYearlyMetricSales');
            const qtyBtn = document.getElementById('dashYearlyMetricQty');
            
            if (type === 'sales') {
                salesBtn.style.background = '#667eea';
                salesBtn.style.color = 'white';
                qtyBtn.style.background = 'white';
                qtyBtn.style.color = '#667eea';
            } else {
                salesBtn.style.background = 'white';
                salesBtn.style.color = '#667eea';
                qtyBtn.style.background = '#667eea';
                qtyBtn.style.color = 'white';
            }
            
            // Grafiƒüi yeniden √ßiz
            renderDashYearlyChart();
        }

        function renderDashYearlyChart() {
            const ctx = document.getElementById('dashYearlyChart');
            if (!ctx) return;
            
            // Veriyi her zaman yeniden hesapla (cache sorununu √∂nlemek i√ßin)
            const yearlyMonthlyData = {};
            const yearlyMonthlyQty = {};
            
            allData.forEach(item => {
                if (item.date) {
                    const year = item.date.substring(0, 4);
                    const month = item.date.substring(5, 7);
                    
                    // Satƒ±≈ü tutarƒ±
                    if (!yearlyMonthlyData[year]) yearlyMonthlyData[year] = {};
                    if (!yearlyMonthlyData[year][month]) yearlyMonthlyData[year][month] = 0;
                    yearlyMonthlyData[year][month] += parseFloat(item.usd_amount || 0);
                    
                    // Miktar
                    if (!yearlyMonthlyQty[year]) yearlyMonthlyQty[year] = {};
                    if (!yearlyMonthlyQty[year][month]) yearlyMonthlyQty[year][month] = 0;
                    yearlyMonthlyQty[year][month] += parseFloat(item.quantity || 0);
                }
            });
            
            // T√ºm aylarƒ± topla
            const allMonthKeys = new Set();
            Object.values(yearlyMonthlyData).forEach(yearData => {
                Object.keys(yearData).forEach(month => allMonthKeys.add(month));
            });
            
            const sortedMonths = Array.from(allMonthKeys).sort();
            const sourceData = dashYearlyMetricType === 'sales' ? yearlyMonthlyData : yearlyMonthlyQty;
            
            // Dataset olu≈ütur (se√ßilen metriƒüe g√∂re)
            const datasets = [];
            const colors = [
                {border: 'rgba(102, 126, 234, 1)', bg: 'rgba(102, 126, 234, 0.1)'},
                {border: 'rgba(245, 87, 108, 1)', bg: 'rgba(245, 87, 108, 0.1)'},
                {border: 'rgba(56, 239, 125, 1)', bg: 'rgba(56, 239, 125, 0.1)'},
                {border: 'rgba(255, 206, 86, 1)', bg: 'rgba(255, 206, 86, 0.1)'}
            ];
            
            Object.keys(sourceData).sort().forEach((year, idx) => {
                const yearData = sourceData[year];
                const values = sortedMonths.map(month => yearData[month] || 0);
                const color = colors[idx % colors.length];
                
                datasets.push({
                    label: `${year}`,
                    data: values,
                    borderColor: color.border,
                    backgroundColor: color.bg,
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                });
            });
            
            if (dashYearlyChartInstance) {
                dashYearlyChartInstance.destroy();
            }
            
            // Ay isimlerini g√∂ster
            const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 
                               'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            const labels = sortedMonths.map(m => monthNames[parseInt(m) - 1]);
            
            // Y ekseni ayarlarƒ±
            const isSales = dashYearlyMetricType === 'sales';
            const yAxisLabel = isSales ? 'Satƒ±≈ü (USD - KDV Hari√ß)' : 'Miktar (Adet)';
            const yAxisColor = isSales ? 'rgba(102, 126, 234, 1)' : 'rgba(255, 159, 64, 1)';
            
            dashYearlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    plugins: {
                        legend: {display: true, position: 'top'},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    if (isSales) {
                                        return context.dataset.label + ': $' + context.parsed.y.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                    } else {
                                        return context.dataset.label + ': ' + context.parsed.y.toLocaleString('tr-TR', {minimumFractionDigits: 0}) + ' adet';
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: yAxisLabel,
                                color: yAxisColor,
                                font: {
                                    weight: 'bold',
                                    size: 12
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    if (isSales) {
                                        return '$' + value.toLocaleString('tr-TR');
                                    } else {
                                        return value.toLocaleString('tr-TR') + ' adet';
                                    }
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderDashTopStoresChart(data) {
            const ctx = document.getElementById('dashTopStoresChart');
            if (!ctx) return;
            
            const storeData = {};
            data.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) storeData[store] = 0;
                storeData[store] += parseFloat(item.usd_amount || 0);
            });
            
            const top10 = Object.entries(storeData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const total = top10.reduce((sum, item) => sum + item[1], 0);
            
            if (dashTopStoresChartInstance) {
                dashTopStoresChartInstance.destroy();
            }
            
            dashTopStoresChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(s => s[0]),
                    datasets: [{
                        label: 'Satƒ±≈ü (USD)',
                        data: top10.map(s => s[1]),
                        backgroundColor: 'rgba(250, 112, 154, 0.8)'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed.x / total) * 100).toFixed(1);
                                    return 'Satƒ±≈ü: $' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderDashTopSalespeopleChart(data) {
            const ctx = document.getElementById('dashTopSalespeopleChart');
            if (!ctx) return;
            
            const spData = {};
            data.forEach(item => {
                const sp = item.sales_person || 'Bilinmiyor';
                if (!spData[sp]) spData[sp] = 0;
                spData[sp] += parseFloat(item.usd_amount || 0);
            });
            
            const top10 = Object.entries(spData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const total = top10.reduce((sum, item) => sum + item[1], 0);
            
            if (dashTopSalespeopleChartInstance) {
                dashTopSalespeopleChartInstance.destroy();
            }
            
            dashTopSalespeopleChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(s => s[0]),
                    datasets: [{
                        label: 'Satƒ±≈ü (USD)',
                        data: top10.map(s => s[1]),
                        backgroundColor: 'rgba(67, 233, 123, 0.8)'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed.x / total) * 100).toFixed(1);
                                    return 'Satƒ±≈ü: $' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderDashTopBrandsChart(data) {
            const ctx = document.getElementById('dashTopBrandsChart');
            if (!ctx) return;
            
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += parseFloat(item.usd_amount || 0);
            });
            
            const top10 = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            if (dashTopBrandsChartInstance) {
                dashTopBrandsChartInstance.destroy();
            }
            
            dashTopBrandsChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: top10.map(s => s[0]),
                    datasets: [{
                        data: top10.map(s => s[1]),
                        backgroundColor: [
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(240, 147, 251, 0.8)',
                            'rgba(245, 87, 108, 0.8)',
                            'rgba(79, 172, 254, 0.8)',
                            'rgba(67, 233, 123, 0.8)',
                            'rgba(56, 249, 215, 0.8)',
                            'rgba(250, 112, 154, 0.8)',
                            'rgba(254, 224, 101, 0.8)',
                            'rgba(0, 242, 254, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': $' + context.parsed.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: (value, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (value * 100 / sum).toFixed(1) + "%";
                                return percentage;
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderDashTopCategoriesChart(data) {
            const ctx = document.getElementById('dashTopCategoriesChart');
            if (!ctx) return;
            
            const catData = {};
            data.forEach(item => {
                // Eƒüer category_1 "All" ise category_2 kullan, deƒüilse category_1
                let cat = (item.category_1 && item.category_1.toLowerCase() !== 'all') 
                    ? item.category_1 
                    : (item.category_2 || item.category_3 || 'Diƒüer');
                
                // Bo≈ü deƒüerleri ve Analitik/Eƒüitim atla
                if (!cat || cat.toLowerCase() === 'bilinmiyor') return;
                if (cat.toLowerCase().includes('analitik') || cat.toLowerCase().includes('eƒüitim')) return;
                
                if (!catData[cat]) catData[cat] = 0;
                catData[cat] += parseFloat(item.usd_amount || 0);
            });
            
            const top10 = Object.entries(catData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            
            if (dashTopCategoriesChartInstance) {
                dashTopCategoriesChartInstance.destroy();
            }
            
            dashTopCategoriesChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: top10.map(s => s[0]),
                    datasets: [{
                        data: top10.map(s => s[1]),
                        backgroundColor: [
                            'rgba(67, 233, 123, 0.8)',
                            'rgba(56, 249, 215, 0.8)',
                            'rgba(79, 172, 254, 0.8)',
                            'rgba(0, 242, 254, 0.8)',
                            'rgba(102, 126, 234, 0.8)',
                            'rgba(118, 75, 162, 0.8)',
                            'rgba(240, 147, 251, 0.8)',
                            'rgba(245, 87, 108, 0.8)',
                            'rgba(250, 112, 154, 0.8)',
                            'rgba(254, 224, 101, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { display: true, position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.label + ': $' + context.parsed.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                }
                            }
                        },
                        datalabels: {
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: (value, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (value * 100 / sum).toFixed(1) + "%";
                                return percentage;
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }

        function renderDashTopCitiesChart(data) {
            const ctx = document.getElementById('dashTopCitiesChart');
            if (!ctx) return;
            
            const cityData = {};
            data.forEach(item => {
                const city = item.city || 'Bilinmiyor';
                if (!cityData[city]) cityData[city] = 0;
                cityData[city] += parseFloat(item.usd_amount || 0);
            });
            
            const top10 = Object.entries(cityData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const total = top10.reduce((sum, item) => sum + item[1], 0);
            
            if (dashTopCitiesChartInstance) {
                dashTopCitiesChartInstance.destroy();
            }
            
            dashTopCitiesChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: top10.map(s => s[0]),
                    datasets: [{
                        label: 'Satƒ±≈ü (USD)',
                        data: top10.map(s => s[1]),
                        backgroundColor: 'rgba(79, 172, 254, 0.8)'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const percentage = ((context.parsed.x / total) * 100).toFixed(1);
                                    return 'Satƒ±≈ü: $' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }

        function renderDashTopProductsChart(data) {
            const ctx = document.getElementById('dashTopProductsChart');
            if (!ctx) return;
            
            const productData = {};
            data.forEach(item => {
                const product = item.product || 'Bilinmiyor';
                if (!productData[product]) productData[product] = 0;
                productData[product] += parseFloat(item.usd_amount || 0);
            });
            
            const top10 = Object.entries(productData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const total = top10.reduce((sum, item) => sum + item[1], 0);
            
            if (dashTopProductsChartInstance) {
                dashTopProductsChartInstance.destroy();
            }
            
            // √úr√ºn isimlerini temizle ve kƒ±salt
            const shortLabels = top10.map(s => {
                let name = s[0];
                
                // Ba≈üƒ±ndaki kodlarƒ± temizle (√∂rn: "[1R] ", "201R] ", "'PEP] ")
                name = name.replace(/^[\[\(]?[A-Z0-9']+[\]\)]?\s*/g, '');
                
                // Sonundaki gereksiz a√ßƒ±klamalarƒ± kƒ±salt (√∂rn: "Dijital Piyano" -> "Piyano")
                name = name.replace(/\s+Dijital\s+Piyano/gi, ' Piyano');
                name = name.replace(/\s+Kuyruklu\s+Piyano/gi, ' K.Piyano');
                name = name.replace(/\s+M\/PEP\s+/gi, ' ');
                
                // Max 35 karakter
                return name.length > 35 ? name.substring(0, 32) + '...' : name;
            });
            
            dashTopProductsChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: shortLabels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD)',
                        data: top10.map(s => s[1]),
                        backgroundColor: 'rgba(240, 147, 251, 0.8)'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                title: function(context) {
                                    // Tooltip'te tam √ºr√ºn adƒ±nƒ± g√∂ster
                                    return top10[context[0].dataIndex][0];
                                },
                                label: function(context) {
                                    const percentage = ((context.parsed.x / total) * 100).toFixed(1);
                                    return 'Satƒ±≈ü: $' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + ' (' + percentage + '%)';
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        },
                        y: {
                            ticks: {
                                autoSkip: false,
                                font: {
                                    size: 11
                                }
                            }
                        }
                    }
                }
            });
        }

        function performDashboardAIAnalysis() {
            console.log('ü§ñ Geli≈ümi≈ü AI Analiz ba≈ülatƒ±lƒ±yor...');
            
            const currentYear = new Date().getFullYear();
            const lastYear = currentYear - 1;
            const thisYearData = allData.filter(item => item.date && item.date.startsWith(currentYear.toString()));
            const lastYearData = allData.filter(item => item.date && item.date.startsWith(lastYear.toString()));
            
            // ========== VERƒ∞ G√úNCELLEME TARƒ∞Hƒ∞ VE ƒ∞VME HESAPLAMA ==========
            const allDates = allData.map(item => item.date).filter(d => d).sort();
            const latestDataDate = allDates[allDates.length - 1];
            const latestYear = latestDataDate ? latestDataDate.substring(0, 4) : currentYear;
            const latestMonth = latestDataDate ? latestDataDate.substring(5, 7) : '';
            const latestDay = latestDataDate ? latestDataDate.substring(8, 10) : '';
            
            const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            const latestMonthName = latestMonth ? monthNames[parseInt(latestMonth) - 1] : '';
            const dataUpdateInfo = `${latestDay} ${latestMonthName} ${latestYear}`;
            
            console.log('üìÖ Son veri g√ºncelleme tarihi:', dataUpdateInfo);
            
            // ========== YILLIK KAR≈ûILA≈ûTIRMA (ƒ∞VME BAZLI) ==========
            const totalSalesThisYear = thisYearData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalSalesLastYear = lastYearData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            
            // Bu yƒ±l i√ßin ge√ßen g√ºn sayƒ±sƒ±nƒ± hesapla (veri g√ºncelleme tarihine g√∂re)
            const startOfYear = new Date(currentYear, 0, 1);
            const latestDate = new Date(latestDataDate);
            const daysPassedThisYear = Math.ceil((latestDate - startOfYear) / (1000 * 60 * 60 * 24));
            const daysRemainingThisYear = 365 - daysPassedThisYear;
            
            // G√ºnl√ºk ortalama ciro (bu yƒ±l vs ge√ßen yƒ±l)
            const dailyAvgThisYear = daysPassedThisYear > 0 ? totalSalesThisYear / daysPassedThisYear : 0;
            const dailyAvgLastYear = totalSalesLastYear / 365;
            
            // G√ºnl√ºk ortalama bazƒ±nda ivme
            const dailyGrowth = dailyAvgLastYear > 0 ? ((dailyAvgThisYear - dailyAvgLastYear) / dailyAvgLastYear * 100) : 0;
            
            // Yƒ±l sonu projeksiyonu (mevcut g√ºnl√ºk ortalama ile)
            const projectedYearEndSales = dailyAvgThisYear * 365;
            const projectedGrowth = totalSalesLastYear > 0 ? ((projectedYearEndSales - totalSalesLastYear) / totalSalesLastYear * 100) : 0;
            
            // Hedef hesaplama: 2024 seviyesine ula≈ümak i√ßin kalan g√ºnlerde ne kadar gerekli
            const targetRemainingForLastYear = Math.max(0, totalSalesLastYear - totalSalesThisYear);
            const dailyTargetToMatchLastYear = daysRemainingThisYear > 0 ? targetRemainingForLastYear / daysRemainingThisYear : 0;
            
            // Basit kar≈üƒ±la≈ütƒ±rma (yanƒ±ltƒ±cƒ± olabilir ama g√∂sterelim)
            const yearGrowth = lastYearData.length > 0 ? ((totalSalesThisYear - totalSalesLastYear) / totalSalesLastYear * 100) : 0;
            
            // ========== MAƒûAZA ANALƒ∞Zƒ∞ ==========
            const storeData = {};
            const storeDataLastYear = {};
            thisYearData.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) storeData[store] = 0;
                storeData[store] += parseFloat(item.usd_amount || 0);
            });
            lastYearData.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                if (!storeDataLastYear[store]) storeDataLastYear[store] = 0;
                storeDataLastYear[store] += parseFloat(item.usd_amount || 0);
            });
            const sortedStores = Object.entries(storeData).sort((a, b) => b[1] - a[1]);
            const top10Stores = sortedStores.slice(0, 10);
            const weakStore = sortedStores[sortedStores.length - 1];
            
            // Maƒüaza ivme hesaplama
            const storeGrowth = sortedStores.map(([store, sales]) => {
                const lastYearSales = storeDataLastYear[store] || 0;
                const growth = lastYearSales > 0 ? ((sales - lastYearSales) / lastYearSales * 100) : 0;
                return { store, sales, growth };
            }).sort((a, b) => b.growth - a.growth);
            const fastestGrowingStore = storeGrowth[0];
            const slowestGrowingStore = storeGrowth[storeGrowth.length - 1];
            
            // ========== TEMSƒ∞LCƒ∞ ANALƒ∞Zƒ∞ ==========
            const spData = {};
            const spDataLastYear = {};
            thisYearData.forEach(item => {
                const sp = item.sales_person || 'Bilinmiyor';
                if (!spData[sp]) spData[sp] = 0;
                spData[sp] += parseFloat(item.usd_amount || 0);
            });
            lastYearData.forEach(item => {
                const sp = item.sales_person || 'Bilinmiyor';
                if (!spDataLastYear[sp]) spDataLastYear[sp] = 0;
                spDataLastYear[sp] += parseFloat(item.usd_amount || 0);
            });
            const sortedSP = Object.entries(spData).sort((a, b) => b[1] - a[1]);
            const top10SP = sortedSP.slice(0, 10);
            
            // Temsilci ivme hesaplama
            const spGrowth = sortedSP.map(([sp, sales]) => {
                const lastYearSales = spDataLastYear[sp] || 0;
                const growth = lastYearSales > 0 ? ((sales - lastYearSales) / lastYearSales * 100) : 0;
                return { sp, sales, growth };
            }).sort((a, b) => b.growth - a.growth);
            
            // ========== MARKA ANALƒ∞Zƒ∞ (TOP 10) ==========
            const brandData = {};
            const brandDataLastYear = {};
            thisYearData.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += parseFloat(item.usd_amount || 0);
            });
            lastYearData.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandDataLastYear[brand]) brandDataLastYear[brand] = 0;
                brandDataLastYear[brand] += parseFloat(item.usd_amount || 0);
            });
            const sortedBrands = Object.entries(brandData).sort((a, b) => b[1] - a[1]);
            const top10Brands = sortedBrands.slice(0, 10);
            const brandConcentration10 = (top10Brands.reduce((sum, b) => sum + b[1], 0) / totalSalesThisYear * 100);
            
            // Marka ivme hesaplama
            const brandGrowth = sortedBrands.map(([brand, sales]) => {
                const lastYearSales = brandDataLastYear[brand] || 0;
                const growth = lastYearSales > 0 ? ((sales - lastYearSales) / lastYearSales * 100) : 0;
                return { brand, sales, growth };
            }).sort((a, b) => b.growth - a.growth);
            const fastestGrowingBrand = brandGrowth[0];
            const slowestGrowingBrand = brandGrowth[brandGrowth.length - 1];
            
            // ========== KATEGORƒ∞ ANALƒ∞Zƒ∞ ==========
            const categoryData = {};
            const categoryDataLastYear = {};
            thisYearData.forEach(item => {
                const category = item.category_2 || 'Bilinmiyor';
                if (!categoryData[category]) categoryData[category] = 0;
                categoryData[category] += parseFloat(item.usd_amount || 0);
            });
            lastYearData.forEach(item => {
                const category = item.category_2 || 'Bilinmiyor';
                if (!categoryDataLastYear[category]) categoryDataLastYear[category] = 0;
                categoryDataLastYear[category] += parseFloat(item.usd_amount || 0);
            });
            const sortedCategories = Object.entries(categoryData).sort((a, b) => b[1] - a[1]);
            const top10Categories = sortedCategories.slice(0, 10);
            
            // Kategori ivme hesaplama
            const categoryGrowth = sortedCategories.map(([category, sales]) => {
                const lastYearSales = categoryDataLastYear[category] || 0;
                const growth = lastYearSales > 0 ? ((sales - lastYearSales) / lastYearSales * 100) : 0;
                return { category, sales, growth };
            }).sort((a, b) => b.growth - a.growth);
            const fastestGrowingCategory = categoryGrowth[0];
            const slowestGrowingCategory = categoryGrowth[categoryGrowth.length - 1];
            
            // Aylƒ±k trend - G√úNL√úK ORTALAMA bazƒ±nda kar≈üƒ±la≈ütƒ±rma (ay hen√ºz bitmemi≈ü olabilir)
            const monthlyDataThisYear = {};
            const monthlyDataLastYear = {};
            const monthlyDaysThisYear = {};
            const monthlyDaysLastYear = {};
            
            thisYearData.forEach(item => {
                const month = item.date.substring(5, 7);
                const day = item.date.substring(8, 10);
                if (!monthlyDataThisYear[month]) {
                    monthlyDataThisYear[month] = 0;
                    monthlyDaysThisYear[month] = new Set();
                }
                monthlyDataThisYear[month] += parseFloat(item.usd_amount || 0);
                monthlyDaysThisYear[month].add(day);
            });
            
            lastYearData.forEach(item => {
                const month = item.date.substring(5, 7);
                const day = item.date.substring(8, 10);
                if (!monthlyDataLastYear[month]) {
                    monthlyDataLastYear[month] = 0;
                    monthlyDaysLastYear[month] = new Set();
                }
                monthlyDataLastYear[month] += parseFloat(item.usd_amount || 0);
                monthlyDaysLastYear[month].add(day);
            });
            
            const months = Object.keys(monthlyDataThisYear).sort();
            const lastMonth = months[months.length - 1];
            const lastMonthThisYear = monthlyDataThisYear[lastMonth] || 0;
            const lastMonthLastYear = monthlyDataLastYear[lastMonth] || 0;
            const daysThisYear = monthlyDaysThisYear[lastMonth] ? monthlyDaysThisYear[lastMonth].size : 1;
            const daysLastYear = monthlyDaysLastYear[lastMonth] ? monthlyDaysLastYear[lastMonth].size : 1;
            
            // G√úNL√úK ORTALAMA hesapla (AYLIK bazƒ±nda)
            const dailyAvgThisMonth = lastMonthThisYear / daysThisYear;
            const dailyAvgLastMonth = lastMonthLastYear / daysLastYear;
            const monthGrowth = dailyAvgLastMonth > 0 ? ((dailyAvgThisMonth - dailyAvgLastMonth) / dailyAvgLastMonth * 100) : 0;
            
            // Ay tamamlanma durumu
            const today = new Date();
            const currentDay = today.getDate();
            const currentMonth = String(today.getMonth() + 1).padStart(2, '0');
            const isCurrentMonth = (lastMonth === currentMonth);
            const monthCompletionRate = isCurrentMonth ? ((currentDay / 30) * 100).toFixed(0) : 100;
            
            // ========== M√ú≈ûTERƒ∞ ANALƒ∞Zƒ∞ ==========
            const uniqueCustomers = new Set(thisYearData.map(item => item.partner)).size;
            const uniqueInvoices = new Set(thisYearData.map(item => item.move_name)).size;
            const avgBasketValue = totalSalesThisYear / uniqueInvoices;
            const avgCustomerValue = totalSalesThisYear / uniqueCustomers;
            
            // Sepet ortalamas ge√ßen yƒ±l
            const uniqueInvoicesLastYear = new Set(lastYearData.map(item => item.move_name)).size;
            const avgBasketValueLastYear = uniqueInvoicesLastYear > 0 ? totalSalesLastYear / uniqueInvoicesLastYear : 0;
            const basketGrowth = avgBasketValueLastYear > 0 ? ((avgBasketValue - avgBasketValueLastYear) / avgBasketValueLastYear * 100) : 0;
            
            const lastMonthName = monthNames[parseInt(lastMonth) - 1];
            
            // ========== GELƒ∞≈ûMƒ∞≈û AI ANALƒ∞Z HTML √áIKTISI ==========
            console.log('üìä Veri g√ºncelleme:', dataUpdateInfo);
            console.log(`‚è±Ô∏è ${currentYear}: ${daysPassedThisYear} g√ºn ge√ßti, ${daysRemainingThisYear} g√ºn kaldƒ±`);
            console.log('üìä G√ºnl√ºk ortalama:', dailyAvgLastYear.toFixed(0), '‚Üí', dailyAvgThisYear.toFixed(0), `(${dailyGrowth > 0 ? '+' : ''}${dailyGrowth.toFixed(1)}%)`);
            console.log('üéØ Yƒ±l sonu tahmini:', projectedYearEndSales.toFixed(0), `(${projectedGrowth > 0 ? '+' : ''}${projectedGrowth.toFixed(1)}%)`);
            console.log('üìà Basit kar≈üƒ±la≈ütƒ±rma (YANILTICI):', yearGrowth.toFixed(1) + '%');
            console.log('üìä Aylƒ±k ivme:', monthGrowth.toFixed(1) + '%');
            
            const analysis = `
                <!-- Veri G√ºncelleme Tarihi -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; margin-bottom: 20px; color: white; text-align: center;">
                    <strong>üìÖ Son Veri G√ºncelleme:</strong> ${dataUpdateInfo} | <strong>üéµ M√ºzik Enstr√ºman Sekt√∂r√º</strong>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h4 style="margin-bottom: 15px; color: #38ef7d;">‚úÖ Olumlu Tespitler & G√º√ßl√º Y√∂nler</h4>
                        <ul style="line-height: 2.2; margin: 0;">
                            ${dailyGrowth > 0 ? `<li><strong>üìà G√ºnl√ºk Ortalama ƒ∞vme:</strong> %${Math.abs(dailyGrowth).toFixed(1)} artƒ±≈ü<br><span style="font-size: 0.9em; color: #666;">üíµ ${lastYear}: $${dailyAvgLastYear.toLocaleString('tr-TR', {minimumFractionDigits: 0})}/g√ºn ‚Üí ${currentYear}: $${dailyAvgThisYear.toLocaleString('tr-TR', {minimumFractionDigits: 0})}/g√ºn<br>üéØ Yƒ±l sonu tahmini: $${projectedYearEndSales.toLocaleString('tr-TR', {minimumFractionDigits: 0})} (%${projectedGrowth.toFixed(1)} b√ºy√ºme)</span></li>` : ''}
                            ${monthGrowth > 0 ? `<li><strong>üìä ${lastMonthName} Ayƒ± ƒ∞vme (G√ºnl√ºk Ort.):</strong> %${Math.abs(monthGrowth).toFixed(1)} artƒ±≈ü ${isCurrentMonth ? `<span style="color: #667eea;">(‚è±Ô∏è Ay %${monthCompletionRate} tamamlandƒ±)</span>` : ''}<br><span style="font-size: 0.9em; color: #666;">üìÖ ${lastYear}: $${dailyAvgLastMonth.toLocaleString('tr-TR', {minimumFractionDigits: 0})}/g√ºn ‚Üí ${currentYear}: $${dailyAvgThisMonth.toLocaleString('tr-TR', {minimumFractionDigits: 0})}/g√ºn</span></li>` : ''}
                            ${basketGrowth > 0 ? `<li><strong>üõí Sepet Ortalamasƒ± ƒ∞vmesi:</strong> %${Math.abs(basketGrowth).toFixed(1)} artƒ±≈ü<br><span style="font-size: 0.9em; color: #666;">üí∞ ${lastYear}: $${avgBasketValueLastYear.toLocaleString('tr-TR', {minimumFractionDigits: 0})} ‚Üí ${currentYear}: $${avgBasketValue.toLocaleString('tr-TR', {minimumFractionDigits: 0})}</span></li>` : ''}
                            ${fastestGrowingStore && fastestGrowingStore.growth > 20 ? `<li><strong>üöÄ En Hƒ±zlƒ± B√ºy√ºyen Maƒüaza:</strong> ${fastestGrowingStore.store} (%${fastestGrowingStore.growth.toFixed(1)} ivme)<br><span style="font-size: 0.9em; color: #666;">üéØ Best practice kaynak olarak kullanƒ±lmalƒ±</span></li>` : ''}
                            ${fastestGrowingBrand && fastestGrowingBrand.growth > 30 ? `<li><strong>üè∑Ô∏è En Hƒ±zlƒ± B√ºy√ºyen Marka:</strong> ${fastestGrowingBrand.brand} (%${fastestGrowingBrand.growth.toFixed(1)} ivme)<br><span style="font-size: 0.9em; color: #666;">üí° Bu markaya yatƒ±rƒ±m artƒ±rƒ±lmalƒ±</span></li>` : ''}
                            <li><strong>üè∑Ô∏è Top 10 Marka Performansƒ±:</strong><br>
                                ${top10Brands.map((b, i) => `<span style="font-size: 0.9em;">${i+1}. ${b[0]}: $${b[1].toLocaleString('tr-TR', {minimumFractionDigits: 0})} (%${(b[1]/totalSalesThisYear*100).toFixed(1)})</span>`).join('<br>')}
                                <br><span style="font-size: 0.9em; color: #666;">üéØ Top 10 marka toplam satƒ±≈üƒ±n %${brandConcentration10.toFixed(1)}'ini olu≈üturuyor</span>
                            </li>
                            <li><strong>üë• M√º≈üteri Metrikleri:</strong><br>
                                <span style="font-size: 0.9em;">‚Ä¢ ${uniqueCustomers.toLocaleString('tr-TR')} aktif m√º≈üteri<br>
                                ‚Ä¢ M√º≈üteri ba≈üƒ± ortalama: $${avgCustomerValue.toLocaleString('tr-TR', {minimumFractionDigits: 0})}<br>
                                ‚Ä¢ Sepet ortalamasƒ±: $${avgBasketValue.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 15px; color: #f5576c;">‚ö†Ô∏è Dikkat Noktalarƒ± & ƒ∞yile≈ütirme Alanlarƒ±</h4>
                        <ul style="line-height: 2.2; margin: 0;">
                            ${yearGrowth < 0 ? `<li><strong>‚è±Ô∏è ${currentYear} Durum Raporu (${daysPassedThisYear} g√ºn ge√ßti, ${daysRemainingThisYear} g√ºn kaldƒ±):</strong><br><span style="font-size: 0.9em; color: #666;">üíµ <strong>${lastYear} Tamamƒ±:</strong> $${totalSalesLastYear.toLocaleString('tr-TR', {minimumFractionDigits: 0})}<br>üíµ <strong>${currentYear} ≈ûu An:</strong> $${totalSalesThisYear.toLocaleString('tr-TR', {minimumFractionDigits: 0})} <span style="color: #f5576c;">(-%${Math.abs(yearGrowth).toFixed(1)} - YANILTICI!)</span><br>üìä <strong>G√ºnl√ºk Ortalama:</strong> ${lastYear}: $${dailyAvgLastYear.toLocaleString('tr-TR', {minimumFractionDigits: 0})}/g√ºn ‚Üí ${currentYear}: $${dailyAvgThisYear.toLocaleString('tr-TR', {minimumFractionDigits: 0})}/g√ºn <span style="${dailyGrowth < 0 ? 'color: #f5576c;' : 'color: #38ef7d;'}">(${dailyGrowth > 0 ? '+' : ''}%${dailyGrowth.toFixed(1)})</span><br>üéØ <strong>Yƒ±l Sonu Tahmini:</strong> $${projectedYearEndSales.toLocaleString('tr-TR', {minimumFractionDigits: 0})} <span style="${projectedGrowth < 0 ? 'color: #f5576c;' : 'color: #38ef7d;'}">(${projectedGrowth > 0 ? '+' : ''}%${projectedGrowth.toFixed(1)} vs ${lastYear})</span><br>üö® <strong>${lastYear} seviyesini yakalamak i√ßin kalan ${daysRemainingThisYear} g√ºnde:</strong> $${targetRemainingForLastYear.toLocaleString('tr-TR', {minimumFractionDigits: 0})} ciro gerekli ($${dailyTargetToMatchLastYear.toLocaleString('tr-TR', {minimumFractionDigits: 0})}/g√ºn vs mevcut $${dailyAvgThisYear.toLocaleString('tr-TR', {minimumFractionDigits: 0})}/g√ºn)</span></li>` : ''}
                            ${monthGrowth < 0 ? `<li><strong>‚ö†Ô∏è ${lastMonthName} Ayƒ± Negatif ƒ∞vme:</strong> %${Math.abs(monthGrowth).toFixed(1)} d√º≈ü√º≈ü ${isCurrentMonth ? `<span style="color: #f5576c;">(‚è±Ô∏è Ay %${monthCompletionRate} tamamlandƒ±)</span>` : ''}<br><span style="font-size: 0.9em; color: #666;">üìÖ G√ºnl√ºk ort: $${dailyAvgLastMonth.toLocaleString('tr-TR', {minimumFractionDigits: 0})} ‚Üí $${dailyAvgThisMonth.toLocaleString('tr-TR', {minimumFractionDigits: 0})}<br>üí° Ay sonu tahmini: $${(dailyAvgThisMonth * 30).toLocaleString('tr-TR', {minimumFractionDigits: 0})} (vs ${lastYear}: $${lastMonthLastYear.toLocaleString('tr-TR', {minimumFractionDigits: 0})})</span></li>` : ''}
                            ${basketGrowth < 0 ? `<li><strong>üõí Sepet Ortalamasƒ± D√º≈ü√º≈ü√º:</strong> %${Math.abs(basketGrowth).toFixed(1)} azalƒ±≈ü<br><span style="font-size: 0.9em; color: #666;">‚ö†Ô∏è Cross-selling ve upselling stratejileri g√º√ßlendirilmeli</span></li>` : ''}
                            ${slowestGrowingStore && slowestGrowingStore.growth < -10 ? `<li><strong>üìä En D√º≈ü√ºk ƒ∞vmeli Maƒüaza:</strong> ${slowestGrowingStore.store} (%${slowestGrowingStore.growth.toFixed(1)})<br><span style="font-size: 0.9em; color: #666;">üéØ Acil m√ºdahale ve destek gerekli</span></li>` : ''}
                            ${slowestGrowingBrand && slowestGrowingBrand.growth < -20 ? `<li><strong>üè∑Ô∏è D√º≈ü√º≈ü Ya≈üayan Marka:</strong> ${slowestGrowingBrand.brand} (%${slowestGrowingBrand.growth.toFixed(1)})<br><span style="font-size: 0.9em; color: #666;">üí° √úr√ºn yelpazesi ve fiyatlandƒ±rma g√∂zden ge√ßirilmeli</span></li>` : ''}
                            ${weakStore ? `<li><strong>üìç En D√º≈ü√ºk Performanslƒ± Maƒüaza:</strong> ${weakStore[0]} ($${weakStore[1].toLocaleString('tr-TR', {minimumFractionDigits: 0})})<br><span style="font-size: 0.9em; color: #666;">Toplam satƒ±≈üƒ±n %${(weakStore[1]/totalSalesThisYear*100).toFixed(2)}'i - Stratejik deƒüerlendirme gerekli</span></li>` : ''}
                            <li><strong>üéØ Marka √áe≈üitliliƒüi:</strong> Top 10 marka satƒ±≈ülarƒ±n %${brandConcentration10.toFixed(1)}'ini olu≈üturuyor ${brandConcentration10 > 70 ? '<span style="color: #f5576c;">(‚ö†Ô∏è Risk y√ºksek!)</span>' : '<span style="color: #38ef7d;">(‚úì Dengeli)</span>'}<br><span style="font-size: 0.9em; color: #666;">üí° Portf√∂y √ße≈üitliliƒüi artƒ±rƒ±lmalƒ±</span></li>
                        </ul>
                    </div>
                </div>
                
                <hr style="margin: 25px 0; border: none; border-top: 2px solid #667eea;">
                <h4 style="margin-bottom: 15px; color: #667eea;">üí° Stratejik √ñneriler & Aksiyon Planƒ± (M√ºzik Sekt√∂r√º √ñzel)</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #38ef7d;">
                        <strong>üéØ Kƒ±sa Vadeli (1-3 ay)</strong>
                        <ul style="margin: 10px 0 0 0; line-height: 2; font-size: 0.95em;">
                            ${monthGrowth < 0 ? `<li><strong>üö® ACƒ∞L:</strong> ${lastMonthName} ayƒ± d√º≈ü√º≈ü√º analizi - Stok, kampanya ve sezonsal fakt√∂rleri inceleyin</li>` : ''}
                            ${top10Stores.length > 0 ? `<li><strong>üèÜ Best Practice:</strong> ${top10Stores[0][0]} maƒüazasƒ±nƒ±n ba≈üarƒ± fakt√∂rlerini (vitrin d√ºzeni, m√º≈üteri deneyimi, te≈ühir teknikleri) diƒüer maƒüazalara aktarƒ±n</li>` : ''}
                            <li><strong>üé∏ √úr√ºn Te≈ühiri:</strong> Gitarlar, klavyeler, davullar i√ßin akustik test alanlarƒ± olu≈üturun - deneyimsel satƒ±≈ü artƒ±≈üƒ± hedefleyin</li>
                            <li><strong>üõí Sepet B√ºy√ºtme:</strong> Aksesuar paketleri (teller, kƒ±lƒ±flar, tuner) ile cross-selling - hedef: %20 sepet artƒ±≈üƒ±</li>
                            ${top10Brands.length > 0 ? `<li><strong>üè∑Ô∏è Kampanya:</strong> ${top10Brands[0][0]} i√ßin "Yeni Ba≈ülayanlar Paketi" kampanyasƒ± d√ºzenleyin</li>` : ''}
                            <li><strong>üì± Dijital:</strong> Online maƒüazada canlƒ± √ºr√ºn demolarƒ± ve sanal deneme √∂zellikleri ekleyin</li>
                        </ul>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #667eea;">
                        <strong>üìà Orta Vadeli (3-6 ay)</strong>
                        <ul style="margin: 10px 0 0 0; line-height: 2; font-size: 0.95em;">
                            <li><strong>üë• M√º≈üteri Segmentasyonu:</strong> Profesyonel m√ºzisyenler, amat√∂rler ve yeni ba≈ülayanlar i√ßin √∂zel hizmet paketleri</li>
                            <li><strong>üéì Eƒüitim Programƒ±:</strong> Maƒüazalarda √ºcretsiz enstr√ºman tanƒ±tƒ±m ve deneme workshoplarƒ± (m√º≈üteri baƒülƒ±lƒ±ƒüƒ± %30+ artƒ±≈ü)</li>
                            <li><strong>üîß Servis Geli≈ütirme:</strong> Enstr√ºman bakƒ±m ve onarƒ±m servisleri ile satƒ±≈ü sonrasƒ± gelir kaynaƒüƒ± olu≈üturun</li>
                            <li><strong>üì¶ Stok Optimizasyonu:</strong> Sezonsal trendlere g√∂re (okul a√ßƒ±lƒ±≈üƒ±, yƒ±lba≈üƒ±) stok planlamasƒ± yapƒ±n</li>
                            ${weakStore ? `<li><strong>üìä Maƒüaza ƒ∞yile≈ütirme:</strong> ${weakStore[0]} i√ßin √∂zel destek programƒ± - √ºr√ºn karmasƒ± ve satƒ±≈ü ekibi eƒüitimi</li>` : ''}
                            <li><strong>üåê Online-Offline Entegrasyon:</strong> Click & Collect, maƒüazadan deneme sonrasƒ± online sipari≈ü sistemi</li>
                        </ul>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #fa7268;">
                        <strong>üöÄ Uzun Vadeli (6-12 ay)</strong>
                        <ul style="margin: 10px 0 0 0; line-height: 2; font-size: 0.95em;">
                            <li><strong>üéµ Topluluk Olu≈üturma:</strong> M√ºzisyen topluluƒüu platformu - konserler, jamler, √ºr√ºn lansmanlarƒ± d√ºzenleyin</li>
                            <li><strong>ü§ù B2B Geli≈ütirme:</strong> M√ºzik okullarƒ±, kurslar ve tiyatrolar ile kurumsal anla≈ümalar yapƒ±n</li>
                            <li><strong>üíº Kiralama Servisi:</strong> Profesyonel ekipman kiralama servisi ba≈ülatƒ±n (pasif gelir kaynaƒüƒ±)</li>
                            <li><strong>üìä Data Analytics:</strong> M√º≈üteri satƒ±n alma davranƒ±≈ülarƒ± analizi ile ki≈üiselle≈ütirilmi≈ü √∂neriler geli≈ütirin</li>
                            <li><strong>üåç Pazar Geni≈ületme:</strong> Yeni maƒüaza a√ßƒ±lƒ±≈ülarƒ± i√ßin potansiyel ≈üehirleri analiz edin (${currentYear} verilerine g√∂re)</li>
                            <li><strong>üéØ Hedef Belirleme:</strong> ${currentYear + 1} yƒ±lƒ± i√ßin ger√ßek√ßi b√ºy√ºme hedefleri belirleyin - √∂nerilen: %${yearGrowth > 0 ? (yearGrowth * 1.2).toFixed(0) : '15'} b√ºy√ºme</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('dashAIAnalysis').innerHTML = analysis;
        }

        // ==================== TIME ANALYSIS ====================
        let hourlyChartInstance = null;
        let monthlyTrendChartInstance = null;
        let yearlyTrendChartInstance = null;
        let storeTimeChartInstance = null;
        let categoryTimeChartInstance = null;
        let salesPersonTimeChartInstance = null;
        
        function analyzeTime() {
            console.log('‚è∞ Zaman analizi ba≈ülatƒ±lƒ±yor...');
            
            // Kategori 1 filtresini uygula
            const category1Filter = document.getElementById('timeCategory1Filter')?.value || '';
            
            if (category1Filter) {
                filteredData = allData.filter(item => item.category_2 === category1Filter);
                console.log(`üìÅ Kategori filtresi: "${category1Filter}" - ${filteredData.length} kayƒ±t`);
            } else {
                filteredData = [...allData];
            }
            
            // Summary cards g√ºncelle
            updateTimeSummary();
            
            // Grafikleri render et
            renderHourlyChart();
            renderMonthlyTrendChart();
            renderYearlyTrendChart();
            
            // Filtreleri doldur
            populateTimeFilters();
            
            // ƒ∞lk grafikleri render et
            renderStoreTimeChart();
            renderCategoryTimeChart();
            renderSalesPersonTimeChart();
            
            // AI analiz
            performTimeAIAnalysis();
        }
        
        function updateTimeSummary() {
            // Saatlik veri topla
            const hourData = {};
            const dayData = {};
            let workHoursSales = 0;
            let weekendSales = 0;
            
            filteredData.forEach(item => {
                const hour = item.create_hour || 0;
                const day = item.day_of_week || 0;
                const sales = parseFloat(item.usd_amount || 0);
                
                // Saatlik
                if (!hourData[hour]) hourData[hour] = 0;
                hourData[hour] += sales;
                
                // G√ºnl√ºk
                if (!dayData[day]) dayData[day] = 0;
                dayData[day] += sales;
                
                // Mesai saati (09:00-18:00)
                if (hour >= 9 && hour < 18) {
                    workHoursSales += sales;
                }
                
                // Hafta sonu (Cumartesi=5, Pazar=6)
                if (day === 5 || day === 6) {
                    weekendSales += sales;
                }
            });
            
            // En yoƒüun saat
            let peakHour = 0;
            let maxHourSales = 0;
            for (const [hour, sales] of Object.entries(hourData)) {
                if (sales > maxHourSales) {
                    maxHourSales = sales;
                    peakHour = parseInt(hour);
                }
            }
            
            // En yoƒüun g√ºn
            const dayNames = ['Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi', 'Pazar'];
            let peakDay = 0;
            let maxDaySales = 0;
            for (const [day, sales] of Object.entries(dayData)) {
                if (sales > maxDaySales) {
                    maxDaySales = sales;
                    peakDay = parseInt(day);
                }
            }
            
            // UI g√ºncelle
            document.getElementById('peakHour').textContent = `${String(peakHour).padStart(2, '0')}:00-${String(peakHour + 1).padStart(2, '0')}:00`;
            document.getElementById('peakDay').textContent = dayNames[peakDay];
            document.getElementById('workHoursSales').textContent = '$' + workHoursSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('weekendSales').textContent = '$' + weekendSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
        }
        
        function renderHourlyChart() {
            const ctx = document.getElementById('hourlyChart');
            if (!ctx) return;
            
            // 24 saatlik veri
            const hourData = Array(24).fill(0);
            const hourCount = Array(24).fill(0);
            
            filteredData.forEach(item => {
                const hour = item.create_hour || 0;
                hourData[hour] += parseFloat(item.usd_amount || 0);
                hourCount[hour] += 1;
            });
            
            if (hourlyChartInstance) {
                hourlyChartInstance.destroy();
            }
            
            hourlyChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`),
                    datasets: [{
                        label: 'Satƒ±≈ü ($ - KDV Hari√ß)',
                        data: hourData,
                        backgroundColor: hourData.map((val, idx) => {
                            const max = Math.max(...hourData);
                            if (val === max) return 'rgba(245, 87, 108, 0.8)'; // En yoƒüun
                            if (idx >= 9 && idx < 18) return 'rgba(56, 239, 125, 0.6)'; // Mesai saati
                            return 'rgba(102, 126, 234, 0.6)'; // Normal
                        }),
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: true
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Satƒ±≈ü: $${context.parsed.y.toLocaleString('tr-TR')} (${hourCount[context.dataIndex]} adet)`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderMonthlyTrendChart() {
            const ctx = document.getElementById('monthlyTrendChart');
            if (!ctx) return;
            
            // Aylƒ±k veriyi topla
            const monthlyData = {};
            filteredData.forEach(item => {
                if (!item.date) return;
                const month = item.date.substring(0, 7); // YYYY-MM
                if (!monthlyData[month]) {
                    monthlyData[month] = 0;
                }
                monthlyData[month] += parseFloat(item.usd_amount || 0);
            });
            
            // Sƒ±rala ve formata et
            const sortedMonths = Object.keys(monthlyData).sort();
            const monthLabels = sortedMonths.map(m => {
                const [year, month] = m.split('-');
                const monthNames = ['Oca', '≈ûub', 'Mar', 'Nis', 'May', 'Haz', 'Tem', 'Aƒüu', 'Eyl', 'Eki', 'Kas', 'Ara'];
                return `${monthNames[parseInt(month) - 1]} ${year}`;
            });
            const monthValues = sortedMonths.map(m => monthlyData[m]);
            
            if (monthlyTrendChartInstance) {
                monthlyTrendChartInstance.destroy();
            }
            
            monthlyTrendChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: monthLabels,
                    datasets: [{
                        label: 'Aylƒ±k Satƒ±≈ü ($ - KDV Hari√ß)',
                        data: monthValues,
                        backgroundColor: 'rgba(102, 126, 234, 0.7)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Satƒ±≈ü: $${context.parsed.y.toLocaleString('tr-TR')}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderYearlyTrendChart() {
            const ctx = document.getElementById('yearlyTrendChart');
            if (!ctx) return;
            
            // Yƒ±llƒ±k veriyi topla
            const yearlyData = {};
            filteredData.forEach(item => {
                if (!item.date) return;
                const year = item.date.substring(0, 4); // YYYY
                if (!yearlyData[year]) {
                    yearlyData[year] = 0;
                }
                yearlyData[year] += parseFloat(item.usd_amount || 0);
            });
            
            // Sƒ±rala
            const sortedYears = Object.keys(yearlyData).sort();
            const yearValues = sortedYears.map(y => yearlyData[y]);
            
            if (yearlyTrendChartInstance) {
                yearlyTrendChartInstance.destroy();
            }
            
            yearlyTrendChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sortedYears,
                    datasets: [{
                        label: 'Yƒ±llƒ±k Satƒ±≈ü ($ - KDV Hari√ß)',
                        data: yearValues,
                        backgroundColor: 'rgba(118, 75, 162, 0.7)',
                        borderColor: 'rgba(118, 75, 162, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `Satƒ±≈ü: $${context.parsed.y.toLocaleString('tr-TR')}`;
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000000).toFixed(1) + 'M';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function populateTimeFilters() {
            // Kategori filtresi (√ºst filtre - allData'dan doldur)
            const category1Set = [...new Set(allData.map(item => item.category_2).filter(c => c && c.toLowerCase() !== 'all'))].sort();
            const category1Select = document.getElementById('timeCategory1Filter');
            if (category1Select) {
                const currentValue = category1Select.value;
                category1Select.innerHTML = '<option value="">T√ºm Kategoriler</option>';
                category1Set.forEach(cat => {
                    const selected = cat === currentValue ? 'selected' : '';
                    category1Select.innerHTML += `<option value="${cat}" ${selected}>${cat}</option>`;
                });
            }
            
            // Maƒüaza filtresi
            const stores = [...new Set(filteredData.map(item => item.store).filter(Boolean))];
            const storeSelect = document.getElementById('storeTimeFilter');
            storeSelect.innerHTML = '<option value="">T√ºm Maƒüazalar</option>';
            stores.forEach(store => {
                storeSelect.innerHTML += `<option value="${store}">${store}</option>`;
            });
            
            // Kategori filtresi (alt grafik i√ßin - sadece Kategori 2, ALL hari√ß)
            const categories = [...new Set(filteredData.map(item => item.category_2).filter(c => c && c.toLowerCase() !== 'all'))].sort();
            const categorySelect = document.getElementById('categoryTimeFilter');
            categorySelect.innerHTML = '<option value="">T√ºm Kategoriler</option>';
            categories.forEach(cat => {
                categorySelect.innerHTML += `<option value="${cat}">${cat}</option>`;
            });
            
            // Satƒ±≈ü temsilcisi filtresi
            const salesPersons = [...new Set(filteredData.map(item => item.sales_person).filter(Boolean))];
            const salesPersonSelect = document.getElementById('salesPersonTimeFilter');
            salesPersonSelect.innerHTML = '<option value="">T√ºm Temsilciler</option>';
            salesPersons.forEach(person => {
                salesPersonSelect.innerHTML += `<option value="${person}">${person}</option>`;
            });
        }
        
        function clearTimeFilters() {
            // Kategori 1 filtresini temizle
            const category1Select = document.getElementById('timeCategory1Filter');
            if (category1Select) {
                category1Select.value = '';
            }
            
            console.log('üîÑ Zaman analizi filtreleri temizlendi');
            analyzeTime();
        }
        
        function renderStoreTimeChart() {
            const ctx = document.getElementById('storeTimeChart');
            if (!ctx) return;
            
            const selectedStore = document.getElementById('storeTimeFilter').value;
            const data = selectedStore ? 
                filteredData.filter(item => item.store === selectedStore) : 
                filteredData;
            
            const hourData = Array(24).fill(0);
            data.forEach(item => {
                const hour = item.create_hour || 0;
                hourData[hour] += parseFloat(item.usd_amount || 0);
            });
            
            if (storeTimeChartInstance) {
                storeTimeChartInstance.destroy();
            }
            
            storeTimeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`),
                    datasets: [{
                        label: selectedStore || 'T√ºm Maƒüazalar',
                        data: hourData,
                        backgroundColor: 'rgba(56, 239, 125, 0.6)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCategoryTimeChart() {
            const ctx = document.getElementById('categoryTimeChart');
            if (!ctx) return;
            
            const selectedCategory = document.getElementById('categoryTimeFilter').value;
            const data = selectedCategory ? 
                filteredData.filter(item => item.category_2 === selectedCategory) : 
                filteredData;
            
            const hourData = Array(24).fill(0);
            data.forEach(item => {
                const hour = item.create_hour || 0;
                hourData[hour] += parseFloat(item.usd_amount || 0);
            });
            
            if (categoryTimeChartInstance) {
                categoryTimeChartInstance.destroy();
            }
            
            categoryTimeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`),
                    datasets: [{
                        label: selectedCategory || 'T√ºm Kategoriler',
                        data: hourData,
                        backgroundColor: 'rgba(245, 87, 108, 0.6)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderSalesPersonTimeChart() {
            const ctx = document.getElementById('salesPersonTimeChart');
            if (!ctx) return;
            
            const selectedPerson = document.getElementById('salesPersonTimeFilter').value;
            const data = selectedPerson ? 
                filteredData.filter(item => item.sales_person === selectedPerson) : 
                filteredData;
            
            const hourData = Array(24).fill(0);
            data.forEach(item => {
                const hour = item.create_hour || 0;
                hourData[hour] += parseFloat(item.usd_amount || 0);
            });
            
            if (salesPersonTimeChartInstance) {
                salesPersonTimeChartInstance.destroy();
            }
            
            salesPersonTimeChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 24}, (_, i) => `${String(i).padStart(2, '0')}:00`),
                    datasets: [{
                        label: selectedPerson || 'T√ºm Temsilciler',
                        data: hourData,
                        backgroundColor: 'rgba(240, 147, 251, 0.6)',
                        borderColor: 'rgba(240, 147, 251, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function performTimeAIAnalysis() {
            console.log('ü§ñ Zaman AI analizi ba≈ülatƒ±lƒ±yor...');
            
            const panel = document.getElementById('timeInsightsPanel');
            if (!panel || filteredData.length === 0) return;
            
            // Zaman verilerini analiz et
            const hourData = {};
            const dayData = {};
            const storeHourData = {};
            const categoryHourData = {};
            
            filteredData.forEach(item => {
                const hour = item.create_hour || 0;
                const day = item.day_of_week || 0;
                const store = item.store || 'Bilinmiyor';
                const category = item.category_1 || 'Bilinmiyor';
                const sales = parseFloat(item.usd_amount || 0);
                
                if (!hourData[hour]) hourData[hour] = {sales: 0, count: 0};
                hourData[hour].sales += sales;
                hourData[hour].count += 1;
                
                if (!dayData[day]) dayData[day] = {sales: 0, count: 0};
                dayData[day].sales += sales;
                dayData[day].count += 1;
                
                if (!storeHourData[store]) storeHourData[store] = {};
                if (!storeHourData[store][hour]) storeHourData[store][hour] = 0;
                storeHourData[store][hour] += sales;
                
                if (!categoryHourData[category]) categoryHourData[category] = {};
                if (!categoryHourData[category][hour]) categoryHourData[category][hour] = 0;
                categoryHourData[category][hour] += sales;
            });
            
            // ƒ∞√ßg√∂r√ºler √ºret
            const insights = {
                positive: [],
                negative: [],
                neutral: [],
                recommendations: []
            };
            
            // En yoƒüun saat
            let peakHour = 0;
            let maxHourSales = 0;
            for (const [hour, data] of Object.entries(hourData)) {
                if (data.sales > maxHourSales) {
                    maxHourSales = data.sales;
                    peakHour = parseInt(hour);
                }
            }
            
            insights.positive.push({
                title: `En Yoƒüun Saat: ${String(peakHour).padStart(2, '0')}:00-${String(peakHour + 1).padStart(2, '0')}:00`,
                description: `<span class="metric-highlight">$${maxHourSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span> satƒ±≈ü ile en yoƒüun saat dilimi. Bu saatte personel sayƒ±sƒ±nƒ± artƒ±rƒ±n.`
            });
            
            // G√ºn analizi
            const dayNames = ['Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi', 'Pazar'];
            let peakDay = 0;
            let maxDaySales = 0;
            let minDay = 0;
            let minDaySales = Infinity;
            
            for (const [day, data] of Object.entries(dayData)) {
                if (data.sales > maxDaySales) {
                    maxDaySales = data.sales;
                    peakDay = parseInt(day);
                }
                if (data.sales < minDaySales) {
                    minDaySales = data.sales;
                    minDay = parseInt(day);
                }
            }
            
            insights.positive.push({
                title: `En Yoƒüun G√ºn: ${dayNames[peakDay]}`,
                description: `<span class="metric-highlight">$${maxDaySales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span> satƒ±≈ü ile haftanƒ±n en yoƒüun g√ºn√º.`
            });
            
            if (maxDaySales / minDaySales > 2) {
                insights.negative.push({
                    title: 'G√ºnler Arasƒ± B√ºy√ºk Fark',
                    description: `${dayNames[peakDay]} ile ${dayNames[minDay]} arasƒ±nda <span class="metric-highlight">${((maxDaySales / minDaySales - 1) * 100).toFixed(0)}%</span> fark var. ${dayNames[minDay]} i√ßin √∂zel kampanyalar d√º≈ü√ºn√ºn.`
                });
            }
            
            // Mesai saati vs mesai dƒ±≈üƒ±
            let workHoursSales = 0;
            let offHoursSales = 0;
            for (const [hour, data] of Object.entries(hourData)) {
                if (parseInt(hour) >= 9 && parseInt(hour) < 18) {
                    workHoursSales += data.sales;
                } else {
                    offHoursSales += data.sales;
                }
            }
            
            const workHoursPercent = (workHoursSales / (workHoursSales + offHoursSales) * 100).toFixed(1);
            insights.neutral.push({
                title: 'Mesai Saati Daƒüƒ±lƒ±mƒ±',
                description: `Satƒ±≈ülarƒ±n <span class="metric-highlight">%${workHoursPercent}</span>'i mesai saatlerinde (09:00-18:00) ger√ßekle≈üiyor.`
            });
            
            // √ñneriler
            insights.recommendations.push({
                icon: '‚è∞',
                title: 'Personel Planlamasƒ±',
                description: `${String(peakHour).padStart(2, '0')}:00-${String(peakHour + 1).padStart(2, '0')}:00 saatleri arasƒ±nda personel sayƒ±sƒ±nƒ± artƒ±rƒ±n. Bu saatte satƒ±≈ülarƒ±n %${((maxHourSales / Object.values(hourData).reduce((sum, d) => sum + d.sales, 0)) * 100).toFixed(1)}'i ger√ßekle≈üiyor.`
            });
            
            insights.recommendations.push({
                icon: 'üìÖ',
                title: 'Kampanya Zamanlamasƒ±',
                description: `${dayNames[minDay]} g√ºnleri i√ßin √∂zel kampanyalar d√ºzenleyin. Mevcut satƒ±≈ülar ${dayNames[peakDay]}'ye g√∂re %${((1 - minDaySales / maxDaySales) * 100).toFixed(0)} daha d√º≈ü√ºk.`
            });
            
            if (offHoursSales > workHoursSales * 0.3) {
                insights.recommendations.push({
                    icon: 'üåô',
                    title: 'Mesai Dƒ±≈üƒ± Potansiyel',
                    description: `Mesai dƒ±≈üƒ± satƒ±≈ülar toplam satƒ±≈ülarƒ±n %${((offHoursSales / (workHoursSales + offHoursSales)) * 100).toFixed(1)}'ini olu≈üturuyor. Online satƒ±≈ü kanallarƒ±nƒ± g√º√ßlendirin.`
                });
            }
            
            // HTML olu≈ütur
            let html = `
                <div class="analysis-panel" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h2 style="margin: 0 0 20px 0; font-size: 2em;">‚è∞ Zaman Analizi AI √ñnerileri</h2>
                    <p style="opacity: 0.9; margin-bottom: 20px;">Filtrelenen ${filteredData.length.toLocaleString('tr-TR')} kayƒ±t √ºzerinden yapƒ±lan zaman analizi sonu√ßlarƒ±</p>
                    
                    ${insights.positive.length > 0 ? `
                    <div class="analysis-section">
                        <h3>‚úÖ Olumlu Tespitler</h3>
                        ${insights.positive.map(item => `
                            <div class="insight-item insight-positive">
                                <span class="insight-icon">‚úÖ</span>
                                <strong>${item.title}</strong><br>
                                ${item.description}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.negative.length > 0 ? `
                    <div class="analysis-section">
                        <h3>‚ö†Ô∏è Dikkat Edilmesi Gerekenler</h3>
                        ${insights.negative.map(item => `
                            <div class="insight-item insight-negative">
                                <span class="insight-icon">‚ö†Ô∏è</span>
                                <strong>${item.title}</strong><br>
                                ${item.description}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.neutral.length > 0 ? `
                    <div class="analysis-section">
                        <h3>üí° √ñnemli Bilgiler</h3>
                        ${insights.neutral.map(item => `
                            <div class="insight-item insight-neutral">
                                <span class="insight-icon">üí°</span>
                                <strong>${item.title}</strong><br>
                                ${item.description}
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="analysis-section">
                        <h3>üéØ Aksiyon √ñnerileri</h3>
                        ${insights.recommendations.map(item => `
                            <div class="recommendation">
                                <span class="recommendation-icon">${item.icon}</span>
                                <div>
                                    <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                    <p style="margin: 10px 0 0 0; opacity: 0.95;">${item.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            panel.innerHTML = html;
            panel.style.display = 'block';
        }

        // Load data on page load
        loadData();
        
        // ==================== VERƒ∞ Y√ñNETƒ∞Mƒ∞ ====================
        
        // Yƒ±l y√ºkleme kontrol√º i√ßin
        let loadedYears = new Set();
        let loadedDataCache = {};
        
        // ==================== √úR√úN ANALƒ∞Zƒ∞ ====================
        
        let productStoreChartInstance = null;
        let productCityChartInstance = null;
        let productDistrictChartInstance = null;
        let productSalesPersonChartInstance = null;
        let productMonthlyChartInstance = null;
        
        // √úr√ºn tablosu sƒ±ralama i√ßin
        let currentProductData = [];
        let currentSortColumn = 'sales';
        let currentSortDirection = 'desc';
        let lastProductSearchData = null;
        
        // Satƒ±≈ü Temsilcisi tablosu sƒ±ralama i√ßin
        let lastSalespersonTopProductsData = null;
        let currentSalespersonSortColumn = 'sales';
        let currentSalespersonSortDirection = 'desc';
        
        // M√º≈üteri alƒ±≈üveri≈ü ge√ßmi≈üi sƒ±ralama i√ßin
        let lastCustomerPurchaseData = null;
        let currentCustomerPurchaseSortColumn = 'date';
        let currentCustomerPurchaseSortDirection = 'desc';
        
        // Kategori dropdown i√ßin
        let allCategories = [];
        let allCategoriesHierarchical = []; // Hiyerar≈üik kategori listesi
        
        // Kategori dropdown fonksiyonlarƒ±
        function initializeProductFilters() {
            // T√ºm kategorileri topla (hiyerar≈üik olarak + ara seviyeler)
            const categoryMap = new Map();
            allData.forEach(item => {
                const cat1 = item.category_1 || '';
                const cat2 = item.category_2 || '';
                const cat3 = item.category_3 || '';
                const cat4 = item.category_4 || '';
                
                // Her seviyeyi ayrƒ± ayrƒ± ekle
                const levels = [cat1, cat2, cat3, cat4].filter(c => c && c.trim());
                
                // T√ºm kombinasyonlarƒ± ekle (ara seviyeler dahil)
                for (let i = 1; i <= levels.length; i++) {
                    const hierarchy = levels.slice(0, i).join(' > ');
                    if (hierarchy && !categoryMap.has(hierarchy)) {
                        categoryMap.set(hierarchy, {
                            cat1: levels[0] || '',
                            cat2: levels[1] || '',
                            cat3: levels[2] || '',
                            cat4: levels[3] || ''
                        });
                    }
                }
            });
            
            allCategoriesHierarchical = Array.from(categoryMap.keys()).sort();
            
            // Basit liste i√ßin de t√ºm kategorileri topla
            const categorySet = new Set();
            allData.forEach(item => {
                if (item.category_1) categorySet.add(item.category_1);
                if (item.category_2) categorySet.add(item.category_2);
                if (item.category_3) categorySet.add(item.category_3);
                if (item.category_4) categorySet.add(item.category_4);
            });
            allCategories = Array.from(categorySet).sort();
            
            // Maƒüaza dropdown'ƒ±nƒ± doldur
            const storeSet = new Set();
            allData.forEach(item => {
                if (item.store && item.store !== 'Analitik' && !item.store.toLowerCase().includes('eƒüitim')) {
                    storeSet.add(item.store);
                }
            });
            const storeFilter = document.getElementById('productStoreFilter');
            if (storeFilter) {
                storeFilter.innerHTML = '<option value="">T√ºm Maƒüazalar</option>';
                Array.from(storeSet).sort().forEach(store => {
                    storeFilter.innerHTML += `<option value="${store}">${store}</option>`;
                });
            }
        }
        
        function showProductCategoryDropdown() {
            filterProductCategories();
            document.getElementById('productCategoryDropdown').style.display = 'block';
        }
        
        function hideProductCategoryDropdown() {
            document.getElementById('productCategoryDropdown').style.display = 'none';
        }
        
        function filterProductCategories() {
            const searchValue = document.getElementById('productCategorySearch').value.toLowerCase();
            const dropdown = document.getElementById('productCategoryDropdown');
            
            // Hiyerar≈üik kategorilerde ara
            const filtered = allCategoriesHierarchical.filter(cat => 
                cat.toLowerCase().includes(searchValue)
            );
            
            if (filtered.length === 0) {
                dropdown.innerHTML = '<div style="padding: 15px; text-align: center; color: #999;">Sonu√ß bulunamadƒ±</div>';
            } else {
                dropdown.innerHTML = filtered.slice(0, 20).map(cat => {
                    // Kategori seviyelerini renklendir
                    const parts = cat.split(' > ');
                    const displayText = parts.map((part, idx) => {
                        const colors = ['#667eea', '#764ba2', '#e74c3c', '#f39c12'];
                        return `<span style="color: ${colors[idx % colors.length]}; font-weight: ${idx === 0 ? 'bold' : 'normal'};">${part}</span>`;
                    }).join(' <span style="color: #999;">‚Ä∫</span> ');
                    
                    return `
                        <div onclick="selectProductCategory('${cat.replace(/'/g, "\\'")}')" 
                             style="padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; transition: all 0.2s;"
                             onmouseover="this.style.background='#f5f5f5'"
                             onmouseout="this.style.background='white'">
                            üìÅ ${displayText}
                        </div>
                    `;
                }).join('');
                
                if (filtered.length > 20) {
                    dropdown.innerHTML += '<div style="padding: 10px; text-align: center; color: #999; font-size: 0.9em;">+' + (filtered.length - 20) + ' daha...</div>';
                }
            }
            
            dropdown.style.display = 'block';
        }
        
        function selectProductCategory(category) {
            document.getElementById('productCategorySearch').value = category;
            document.getElementById('productCategorySearch').setAttribute('data-selected-category', category);
            hideProductCategoryDropdown();
            searchProduct();
        }
        
        function clearProductDateFilters() {
            document.getElementById('productDateStart').value = '';
            document.getElementById('productDateEnd').value = '';
            console.log('üîÑ √úr√ºn tarih filtreleri temizlendi');
        }
        
        function searchProduct() {
            const searchTerm = document.getElementById('productSearchInput').value.trim();
            const selectedCategory = document.getElementById('productCategorySearch').getAttribute('data-selected-category') || '';
            const selectedStore = document.getElementById('productStoreFilter').value;
            const dateStart = document.getElementById('productDateStart').value;
            const dateEnd = document.getElementById('productDateEnd').value;
            
            if (!searchTerm && !selectedCategory) {
                alert('‚ö†Ô∏è L√ºtfen bir √ºr√ºn/marka adƒ± girin veya kategori se√ßin!');
                return;
            }
            
            console.log('üîç Arama kriteri:', {searchTerm, selectedCategory, selectedStore, dateStart, dateEnd});
            
            // Arama (√ºr√ºn adƒ±, marka, kategori, veya √ºr√ºn kodu)
            const searchLower = searchTerm.toLowerCase();
            let results = allData.filter(item => {
                const product = (item.product || '').toLowerCase();
                const brand = (item.brand || '').toLowerCase();
                const category1 = (item.category_1 || '').toLowerCase();
                const category2 = (item.category_2 || '').toLowerCase();
                const category3 = (item.category_3 || '').toLowerCase();
                
                // √úr√ºn/Marka filtresi
                let matchesSearch = !searchTerm || product.includes(searchLower) || brand.includes(searchLower);
                
                // Kategori filtresi (hiyerar≈üik veya basit arama)
                let matchesCategory = true;
                if (selectedCategory) {
                    const selectedLower = selectedCategory.toLowerCase();
                    // Eƒüer hiyerar≈üik kategori se√ßildiyse (i√ßinde '>' varsa)
                    if (selectedCategory.includes(' > ')) {
                        // Hiyerar≈üik yapƒ±yƒ± kontrol et
                        const currentHierarchy = [item.category_1, item.category_2, item.category_3, item.category_4]
                            .filter(c => c && c.trim())
                            .join(' > ')
                            .toLowerCase();
                        matchesCategory = currentHierarchy.includes(selectedLower);
                    } else {
                        // Basit arama - herhangi bir kategori seviyesinde ara
                        matchesCategory = category1.includes(selectedLower) || 
                                        category2.includes(selectedLower) || 
                                        category3.includes(selectedLower) ||
                                        (item.category_4 || '').toLowerCase().includes(selectedLower);
                    }
                }
                
                // Tarih filtreleri (ba≈ülangƒ±√ß-biti≈ü) - FIX: Tarih kar≈üƒ±la≈ütƒ±rmasƒ± d√ºzeltildi
                let matchesDate = true;
                if (dateStart || dateEnd) {
                    if (item.date) {
                        // Tarihleri kar≈üƒ±la≈ütƒ±r (YYYY-MM-DD formatƒ±nda)
                        if (dateStart && item.date < dateStart) {
                            matchesDate = false;
                        }
                        if (dateEnd && item.date > dateEnd) {
                            matchesDate = false;
                        }
                    } else {
                        // Eƒüer item.date yoksa, tarih filtresi varken bu kaydƒ± dƒ±≈üla
                        matchesDate = false;
                    }
                }
                
                // Maƒüaza filtresi (opsiyonel)
                let matchesStore = true;
                if (selectedStore) {
                    matchesStore = (item.store || '').toLowerCase().includes(selectedStore.toLowerCase());
                }
                
                return matchesSearch && matchesCategory && matchesDate && matchesStore;
            });
            
            console.log('üìä Bulunan kayƒ±t sayƒ±sƒ±:', results.length);
            
            if (results.length === 0) {
                // Sonu√ß yok
                document.getElementById('productResultsContainer').style.display = 'none';
                alert('‚ùå Arama kriterlerine uygun sonu√ß bulunamadƒ±!');
                return;
            }
            
            // Sonu√ßlarƒ± g√∂ster
            document.getElementById('productResultsContainer').style.display = 'block';
            document.getElementById('productNoResults').style.display = 'none';
            
            // Veriyi kaydet (sƒ±ralama i√ßin)
            lastProductSearchData = results;
            
            // √ñzet kartlarƒ± g√ºncelle
            const totalSales = results.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = results.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const uniqueProducts = new Set(results.map(item => item.product)).size;
            const avgPrice = totalSales / Math.max(totalQty, 1);
            
            document.getElementById('productTotalSales').textContent = '$' + totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('productTotalQty').textContent = totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('productUniqueCount').textContent = uniqueProducts;
            document.getElementById('productAvgPrice').textContent = '$' + avgPrice.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            
            // Grafikleri render et
            renderProductStoreChart(results);
            renderProductCityChart(results);
            renderProductDistrictChart(results);
            renderProductSalesPersonChart(results);
            renderProductMonthlyChart(results);
            renderProductDetailTable(results);
            
            // AI Analiz ve √ñneri
            performProductAIAnalysis(results);
        }
        
        function renderProductStoreChart(data) {
            const storeData = {};
            data.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) storeData[store] = {sales: 0, qty: 0};
                storeData[store].sales += parseFloat(item.usd_amount || 0);
                storeData[store].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(storeData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('productStoreChart');
            if (!ctx) return;
            
            if (productStoreChartInstance) {
                productStoreChartInstance.destroy();
            }
            
            productStoreChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD - KDV Hari√ß)',
                        data: salesValues,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    if (label === 'Satƒ±≈ü (USD)') {
                                        return label + ': $' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                    } else {
                                        return label + ': ' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderProductCityChart(data) {
            const cityData = {};
            data.forEach(item => {
                const city = item.partner_city || 'Bilinmiyor'; // partner_city = ƒ∞L bilgisi
                if (!cityData[city]) cityData[city] = {sales: 0, qty: 0};
                cityData[city].sales += parseFloat(item.usd_amount || 0);
                cityData[city].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(cityData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('productCityChart');
            if (!ctx) return;
            
            if (productCityChartInstance) {
                productCityChartInstance.destroy();
            }
            
            productCityChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD - KDV Hari√ß)',
                        data: salesValues,
                        backgroundColor: 'rgba(56, 239, 125, 0.6)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    if (label === 'Satƒ±≈ü (USD)') {
                                        return label + ': $' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                    } else {
                                        return label + ': ' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderProductDistrictChart(data) {
            const districtData = {};
            data.forEach(item => {
                const district = item.city || 'Bilinmiyor'; // city = ƒ∞L√áE bilgisi
                if (!districtData[district]) districtData[district] = {sales: 0, qty: 0};
                districtData[district].sales += parseFloat(item.usd_amount || 0);
                districtData[district].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(districtData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('productDistrictChart');
            if (!ctx) return;
            
            if (productDistrictChartInstance) {
                productDistrictChartInstance.destroy();
            }
            
            productDistrictChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD - KDV Hari√ß)',
                        data: salesValues,
                        backgroundColor: 'rgba(245, 87, 108, 0.6)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    if (label === 'Satƒ±≈ü (USD - KDV Hari√ß)') {
                                        return label + ': $' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                    } else {
                                        return label + ': ' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderProductSalesPersonChart(data) {
            const personData = {};
            data.forEach(item => {
                const person = item.sales_person || 'Bilinmiyor';
                if (!personData[person]) personData[person] = {sales: 0, qty: 0};
                personData[person].sales += parseFloat(item.usd_amount || 0);
                personData[person].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(personData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('productSalesPersonChart');
            if (!ctx) return;
            
            if (productSalesPersonChartInstance) {
                productSalesPersonChartInstance.destroy();
            }
            
            productSalesPersonChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD - KDV Hari√ß)',
                        data: salesValues,
                        backgroundColor: 'rgba(245, 87, 108, 0.6)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const label = context.dataset.label || '';
                                    if (label === 'Satƒ±≈ü (USD)') {
                                        return label + ': $' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                    } else {
                                        return label + ': ' + context.parsed.x.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                    }
                                }
                            }
                        }
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderProductMonthlyChart(data) {
            // Yƒ±llara g√∂re aylarƒ± grupla
            const yearlyMonthlyData = {};
            data.forEach(item => {
                if (!item.date) return;
                const year = item.date.substring(0, 4);
                const month = parseInt(item.date.substring(5, 7)); // Ay numarasƒ± (1-12)
                
                if (!yearlyMonthlyData[year]) yearlyMonthlyData[year] = {};
                if (!yearlyMonthlyData[year][month]) yearlyMonthlyData[year][month] = 0;
                yearlyMonthlyData[year][month] += parseFloat(item.usd_amount || 0);
            });
            
            const years = Object.keys(yearlyMonthlyData).sort();
            const months = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 
                          'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            
            // Her yƒ±l i√ßin dataset olu≈ütur
            const colors = [
                { bg: 'rgba(102, 126, 234, 0.2)', border: 'rgba(102, 126, 234, 1)' },
                { bg: 'rgba(240, 147, 251, 0.2)', border: 'rgba(240, 147, 251, 1)' },
                { bg: 'rgba(255, 159, 64, 0.2)', border: 'rgba(255, 159, 64, 1)' },
                { bg: 'rgba(75, 192, 192, 0.2)', border: 'rgba(75, 192, 192, 1)' },
                { bg: 'rgba(255, 99, 132, 0.2)', border: 'rgba(255, 99, 132, 1)' }
            ];
            
            const datasets = years.map((year, index) => {
                const monthData = Array(12).fill(0);
                Object.keys(yearlyMonthlyData[year]).forEach(month => {
                    monthData[parseInt(month) - 1] = yearlyMonthlyData[year][month];
                });
                
                const color = colors[index % colors.length];
                return {
                    label: year,
                    data: monthData,
                    backgroundColor: color.bg,
                    borderColor: color.border,
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                };
            });
            
            const ctx = document.getElementById('productMonthlyChart');
            if (!ctx) return;
            
            if (productMonthlyChartInstance) {
                productMonthlyChartInstance.destroy();
            }
            
            productMonthlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { 
                            display: true,
                            position: 'top'
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderProductDetailTable(data = null, sortColumn = null, sortDirection = null) {
            // Eƒüer data null ise, mevcut veriyi kullan
            if (data === null && lastProductSearchData) {
                data = lastProductSearchData;
            }
            
            // ƒ∞ndirim √ºr√ºnlerini filtrele (tablolarda g√∂sterme)
            if (data) {
                data = data.filter(item => !item._isDiscount);
            }
            
            if (!data || data.length === 0) {
                document.getElementById('productDetailTable').innerHTML = '<p style="text-align: center; padding: 20px;">Veri bulunamadƒ±</p>';
                return;
            }
            
            // Sƒ±ralama parametrelerini g√ºncelle
            if (sortColumn !== null) {
                if (currentSortColumn === sortColumn) {
                    // Aynƒ± kolona tƒ±klandƒ±, y√∂n√º deƒüi≈ütir
                    currentSortDirection = currentSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    // Farklƒ± kolon, varsayƒ±lan azalan
                    currentSortColumn = sortColumn;
                    currentSortDirection = 'desc';
                }
            }
            
            // √úr√ºn bazƒ±nda grupla
            const productData = {};
            data.forEach(item => {
                const product = item.product || 'Bilinmiyor';
                if (!productData[product]) {
                    // Hiyerar≈üik kategori olu≈ütur (ALL atlanƒ±r)
                    const categoryParts = [item.category_1, item.category_2, item.category_3, item.category_4]
                        .filter(c => c && c.trim() && c.toLowerCase() !== 'all');
                    const categoryDisplay = categoryParts.length > 0 ? categoryParts.join(' ‚Ä∫ ') : 'Bilinmiyor';
                    
                    productData[product] = {
                        brand: item.brand || 'Bilinmiyor',
                        category: categoryDisplay,
                        sales: 0,
                        qty: 0,
                        count: 0
                    };
                }
                productData[product].sales += parseFloat(item.usd_amount || 0);
                productData[product].qty += parseFloat(item.quantity || 0);
                productData[product].count += 1;
            });
            
            // Veriyi global deƒüi≈ükene kaydet (sƒ±ralama i√ßin)
            currentProductData = Object.entries(productData);
            
            // Sƒ±ralama
            currentProductData.sort((a, b) => {
                let valA, valB;
                
                if (currentSortColumn === 'product') {
                    valA = a[0].toLowerCase();
                    valB = b[0].toLowerCase();
                    return currentSortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else if (currentSortColumn === 'brand') {
                    valA = a[1].brand.toLowerCase();
                    valB = b[1].brand.toLowerCase();
                    return currentSortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else if (currentSortColumn === 'category') {
                    valA = a[1].category.toLowerCase();
                    valB = b[1].category.toLowerCase();
                    return currentSortDirection === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else if (currentSortColumn === 'sales') {
                    valA = a[1].sales;
                    valB = b[1].sales;
                } else if (currentSortColumn === 'qty') {
                    valA = a[1].qty;
                    valB = b[1].qty;
                } else if (currentSortColumn === 'count') {
                    valA = a[1].count;
                    valB = b[1].count;
                } else if (currentSortColumn === 'avgPrice') {
                    valA = a[1].sales / Math.max(a[1].qty, 1);
                    valB = b[1].sales / Math.max(b[1].qty, 1);
                }
                
                return currentSortDirection === 'asc' ? valA - valB : valB - valA;
            });
            
            // Sƒ±ralama oku ikonu
            const getSortIcon = (column) => {
                if (currentSortColumn === column) {
                    return currentSortDirection === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
                }
                return ' ‚áÖ';
            };
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">#</th>
                            <th onclick="renderProductDetailTable(null, 'product')" style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sƒ±ralamak i√ßin tƒ±klayƒ±n">
                                √úr√ºn${getSortIcon('product')}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'brand')" style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sƒ±ralamak i√ßin tƒ±klayƒ±n">
                                Marka${getSortIcon('brand')}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'category')" style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sƒ±ralamak i√ßin tƒ±klayƒ±n">
                                Kategori${getSortIcon('category')}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'sales')" style="padding: 15px; text-align: right; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sƒ±ralamak i√ßin tƒ±klayƒ±n">
                                Satƒ±≈ü (USD)${getSortIcon('sales')}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'qty')" style="padding: 15px; text-align: right; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sƒ±ralamak i√ßin tƒ±klayƒ±n">
                                Miktar${getSortIcon('qty')}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'count')" style="padding: 15px; text-align: right; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sƒ±ralamak i√ßin tƒ±klayƒ±n">
                                ƒ∞≈ülem${getSortIcon('count')}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'avgPrice')" style="padding: 15px; text-align: right; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sƒ±ralamak i√ßin tƒ±klayƒ±n">
                                Sepet Ort.${getSortIcon('avgPrice')}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            // Sadece ilk 30 √ºr√ºn√º g√∂ster (veri tasarrufu + performans)
            const displayLimit = 30;
            const displayData = currentProductData.slice(0, displayLimit);
            const hasMore = currentProductData.length > displayLimit;
            
            displayData.forEach((item, index) => {
                const product = item[0];
                const stats = item[1];
                const avgBasket = stats.sales / Math.max(stats.count, 1); // Sepet ortalamasƒ± = Toplam Satƒ±≈ü / Fatura Sayƒ±sƒ±
                
                html += `
                    <tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                        <td style="padding: 12px;">${index + 1}</td>
                        <td style="padding: 12px;"><strong>${product}</strong></td>
                        <td style="padding: 12px;">${stats.brand}</td>
                        <td style="padding: 12px;">${stats.category}</td>
                        <td style="padding: 12px; text-align: right; color: #38ef7d; font-weight: bold;">$${stats.sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right;">${stats.qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right;">${stats.count}</td>
                        <td style="padding: 12px; text-align: right;">$${avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                    </tr>
                `;
            });
            
            // Daha fazla √ºr√ºn varsa bilgilendirme satƒ±rƒ± ekle
            if (hasMore) {
                html += `
                    <tr style="background: #fffbeb; border-top: 2px solid #fbbf24;">
                        <td colspan="8" style="padding: 15px; text-align: center; color: #92400e; font-weight: 600;">
                            ‚ÑπÔ∏è ƒ∞lk ${displayLimit} √ºr√ºn g√∂steriliyor (Toplam: ${currentProductData.length} √ºr√ºn). Daha fazlasƒ± i√ßin filtreleri daraltabilirsiniz.
                        </td>
                    </tr>
                `;
            }
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('productDetailTable').innerHTML = html;
        }
        
        // ü§ñ √úR√úN ANALƒ∞Zƒ∞ AI DEƒûERLENDƒ∞RME
        function performProductAIAnalysis(data) {
            console.log('ü§ñ √úr√ºn analizi AI deƒüerlendirmesi ba≈ülatƒ±lƒ±yor...');
            
            // Veri analizi
            const totalSales = data.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = data.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const uniqueProducts = new Set(data.map(item => item.product)).size;
            const avgPrice = totalSales / Math.max(totalQty, 1);
            
            // Maƒüaza analizi
            const storeData = {};
            data.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) storeData[store] = {sales: 0, qty: 0};
                storeData[store].sales += parseFloat(item.usd_amount || 0);
                storeData[store].qty += parseFloat(item.quantity || 0);
            });
            const topStores = Object.entries(storeData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            
            // ƒ∞l analizi
            const cityData = {};
            data.forEach(item => {
                const city = item.city || 'Bilinmiyor';
                if (!cityData[city]) cityData[city] = {sales: 0, qty: 0};
                cityData[city].sales += parseFloat(item.usd_amount || 0);
                cityData[city].qty += parseFloat(item.quantity || 0);
            });
            const topCities = Object.entries(cityData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            
            // Temsilci analizi
            const personData = {};
            data.forEach(item => {
                const person = item.sales_person || 'Bilinmiyor';
                if (!personData[person]) personData[person] = {sales: 0, qty: 0};
                personData[person].sales += parseFloat(item.usd_amount || 0);
                personData[person].qty += parseFloat(item.quantity || 0);
            });
            const topPersons = Object.entries(personData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            
            // Marka analizi
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = {sales: 0, qty: 0};
                brandData[brand].sales += parseFloat(item.usd_amount || 0);
                brandData[brand].qty += parseFloat(item.quantity || 0);
            });
            const topBrands = Object.entries(brandData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            
            // Kategori analizi
            const categoryData = {};
            data.forEach(item => {
                const category = item.category_1 || 'Bilinmiyor';
                if (!categoryData[category]) categoryData[category] = {sales: 0, qty: 0};
                categoryData[category].sales += parseFloat(item.usd_amount || 0);
                categoryData[category].qty += parseFloat(item.quantity || 0);
            });
            const topCategories = Object.entries(categoryData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            
            // AI ƒ∞√ßg√∂r√ºleri
            const insights = {
                positive: [],
                negative: [],
                neutral: [],
                recommendations: []
            };
            
            // Pozitif i√ßg√∂r√ºler
            if (topStores.length > 0) {
                const topStore = topStores[0];
                const storeShare = (topStore[1].sales / totalSales * 100).toFixed(1);
                insights.positive.push({
                    title: `üè™ ${topStore[0]} Lider Maƒüaza`,
                    description: `${topStore[0]} maƒüazasƒ± toplam satƒ±≈üƒ±n %${storeShare}'ini ger√ßekle≈ütirdi ($${topStore[1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} / ${topStore[1].qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})} adet). Bu maƒüaza bu √ºr√ºn/marka i√ßin en g√º√ßl√º performansƒ± g√∂steriyor.`
                });
            }
            
            if (topCities.length > 0) {
                const topCity = topCities[0];
                const cityShare = (topCity[1].sales / totalSales * 100).toFixed(1);
                insights.positive.push({
                    title: `üåç ${topCity[0]} √ñnde Gelen ƒ∞l`,
                    description: `${topCity[0]} ili toplam satƒ±≈üƒ±n %${cityShare}'ini olu≈üturuyor ($${topCity[1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} / ${topCity[1].qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})} adet). Bu b√∂lgede g√º√ßl√º talep var.`
                });
            }
            
            if (topPersons.length > 0) {
                // ƒ∞lk 5 temsilciyi listele
                const top5Persons = topPersons.slice(0, Math.min(5, topPersons.length));
                const personsText = top5Persons.map((p, idx) => {
                    const share = (p[1].sales / totalSales * 100).toFixed(1);
                    return `${idx + 1}. ${p[0]} (%${share}, $${p[1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})})`;
                }).join(' | ');
                
                insights.positive.push({
                    title: `üë§ En Ba≈üarƒ±lƒ± 5 Temsilci`,
                    description: personsText
                });
            }
            
            // N√∂tr i√ßg√∂r√ºler (Bilgilendirme)
            insights.neutral.push({
                title: `üìä Genel Performans`,
                description: `Toplam ${uniqueProducts} farklƒ± √ºr√ºn, ${totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2})} adet satƒ±ldƒ±. Ortalama √ºr√ºn fiyatƒ± $${avgPrice.toLocaleString('tr-TR', {minimumFractionDigits: 2})}.`
            });
            
            if (topBrands.length > 0) {
                // Markalarƒ±n y√ºzdelerini hesapla
                const brandsWithPercent = topBrands.map(b => {
                    const percent = (b[1].sales / totalSales * 100).toFixed(1);
                    return `${b[0]} (%${percent})`;
                }).join(', ');
                
                insights.neutral.push({
                    title: `üè∑Ô∏è Marka Daƒüƒ±lƒ±mƒ±`,
                    description: `En √ßok satan markalar: ${brandsWithPercent}. Bu markalar toplam satƒ±≈üƒ±n b√ºy√ºk kƒ±smƒ±nƒ± olu≈üturuyor.`
                });
            }
            
            if (topCategories.length > 0) {
                // category_2 kullan (All yerine ger√ßek kategoriler)
                const categoryData2 = {};
                data.forEach(item => {
                    const category = item.category_2 || 'Bilinmiyor';
                    // All, Analitik, Eƒüitim kategorilerini atla
                    if (category.toLowerCase() === 'all' || 
                        category.toLowerCase() === 'bilinmiyor' ||
                        category.toLowerCase().includes('analitik') || 
                        category.toLowerCase().includes('eƒüitim')) {
                        return;
                    }
                    if (!categoryData2[category]) categoryData2[category] = {sales: 0, qty: 0};
                    categoryData2[category].sales += parseFloat(item.usd_amount || 0);
                    categoryData2[category].qty += parseFloat(item.quantity || 0);
                });
                const topCategories2 = Object.entries(categoryData2).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
                
                if (topCategories2.length > 0) {
                    const catsWithPercent = topCategories2.map(c => {
                        const percent = (c[1].sales / totalSales * 100).toFixed(1);
                        return `${c[0]} (%${percent})`;
                    }).join(', ');
                    
                    insights.neutral.push({
                        title: `üìÇ Kategori Daƒüƒ±lƒ±mƒ±`,
                        description: `En √ßok satan kategoriler: ${catsWithPercent}. Bu kategorilerde yoƒüunla≈üma var.`
                    });
                }
            }
            
            // Negatif i√ßg√∂r√ºler (Fƒ±rsatlar)
            if (topStores.length > 1) {
                const leader = topStores[0];
                const second = topStores[1];
                const leaderSales = leader[1].sales;
                const secondSales = second[1].sales;
                const gapAmount = leaderSales - secondSales;
                const gapPercent = ((gapAmount / secondSales) * 100).toFixed(1);
                
                // Maƒüaza sayƒ±sƒ±
                const totalStores = Object.keys(storeData).length;
                const leaderShare = ((leaderSales / totalSales) * 100).toFixed(1);
                
                if (gapPercent > 30) { // E≈üik %30'a d√º≈ü√ºr√ºld√º (daha hassas uyarƒ±)
                    insights.negative.push({
                        title: `‚ö†Ô∏è Maƒüazalar Arasƒ± Performans Farkƒ±`,
                        description: `${leader[0]} maƒüazasƒ± toplam ${totalStores} maƒüaza i√ßinde lider (%${leaderShare} pay). ${second[0]} maƒüazasƒ±ndan $${gapAmount.toLocaleString('tr-TR', {minimumFractionDigits: 2})} (%${gapPercent}) daha fazla satƒ±≈ü yapƒ±yor. Diƒüer maƒüazalarda stok, te≈ühir, personel eƒüitimi ve pazarlama a√ßƒ±sƒ±ndan iyile≈ütirme potansiyeli var.`
                    });
                }
            }
            
            if (Object.keys(cityData).length > 5 && topCities[0][1].sales / totalSales > 0.5) {
                insights.negative.push({
                    title: `üåç Coƒürafi Yoƒüunla≈üma`,
                    description: `Satƒ±≈ülarƒ±n b√ºy√ºk kƒ±smƒ± ${topCities[0][0]} ilinde yoƒüunla≈ümƒ±≈ü. Diƒüer illerde pazar payƒ± artƒ±rma fƒ±rsatƒ± var.`
                });
            }
            
            // √ñneriler
            insights.recommendations.push({
                icon: 'üéØ',
                title: 'Stok Optimizasyonu',
                description: `${topStores[0][0]} maƒüazasƒ±nda bu √ºr√ºn/marka i√ßin stok seviyesini artƒ±rƒ±n. Bu maƒüaza en y√ºksek satƒ±≈ü performansƒ±nƒ± g√∂steriyor ve stok t√ºkenmesi riski var.`
            });
            
            insights.recommendations.push({
                icon: 'üìç',
                title: 'Coƒürafi Geni≈üleme',
                description: `${topCities[0][0]} ilindeki ba≈üarƒ±yƒ± analiz edin ve benzer demografik √∂zelliklere sahip diƒüer illerde (${topCities.slice(1, 3).map(c => c[0]).join(', ')}) pazarlama kampanyalarƒ± d√ºzenleyin.`
            });
            
            insights.recommendations.push({
                icon: 'üë•',
                title: 'Temsilci Eƒüitimi',
                description: `${topPersons[0][0]}'in satƒ±≈ü tekniklerini diƒüer temsilcilerle payla≈üƒ±n. Bu temsilcinin ba≈üarƒ± stratejilerini eƒüitim programƒ±na dahil edin.`
            });
            
            if (avgPrice > 300) {
                insights.recommendations.push({
                    icon: 'üí≥',
                    title: '√ñdeme Kolaylƒ±ƒüƒ±',
                    description: `Ortalama √ºr√ºn fiyatƒ± $${avgPrice.toLocaleString('tr-TR', {minimumFractionDigits: 2})} gibi y√ºksek bir seviyede. Taksit se√ßenekleri ve finansman imkanlarƒ± sunarak satƒ±≈ülarƒ± artƒ±rabilirsiniz.`
                });
            }
            
            if (topStores.length >= 3) {
                const thirdStore = topStores[2];
                if (thirdStore[1].sales < topStores[0][1].sales * 0.3) {
                    insights.recommendations.push({
                        icon: 'üì¢',
                        title: 'D√º≈ü√ºk Performanslƒ± Maƒüazalar',
                        description: `${thirdStore[0]} ve benzeri maƒüazalarda √∂zel promosyonlar d√ºzenleyin. Bu maƒüazalarda satƒ±≈ü potansiyeli hen√ºz tam olarak kullanƒ±lmamƒ±≈ü.`
                    });
                }
            }
            
            // HTML olu≈ütur
            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">
                    ${insights.positive.length > 0 ? `
                    <div class="analysis-section">
                        <h3 style="color: white; margin-top: 0;">‚úÖ G√º√ßl√º Y√∂nler</h3>
                        ${insights.positive.map(item => `
                            <div class="insight-item insight-positive" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">‚úÖ</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.negative.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">‚ö†Ô∏è Dikkat Edilmesi Gerekenler</h3>
                        ${insights.negative.map(item => `
                            <div class="insight-item insight-negative" style="background: rgba(245, 87, 108, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #f5576c;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">‚ö†Ô∏è</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.neutral.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">üí° Genel Bilgiler</h3>
                        ${insights.neutral.map(item => `
                            <div class="insight-item insight-neutral" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">üí°</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">üéØ Aksiyon √ñnerileri</h3>
                        ${insights.recommendations.map(item => `
                            <div class="recommendation" style="background: rgba(255, 255, 255, 0.15); padding: 18px; border-radius: 10px; margin: 12px 0;">
                                <span class="recommendation-icon" style="font-size: 1.8em; margin-right: 12px;">${item.icon}</span>
                                <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px);">
                                    <strong style="font-size: 1.15em; display: block; margin-bottom: 8px;">${item.title}</strong>
                                    <p style="margin: 0; opacity: 0.95; line-height: 1.6;">${item.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('productAIAnalysisContent').innerHTML = html;
            document.getElementById('productAIAnalysisPanel').style.display = 'block';
        }
        
        // ==================== GPT BACKEND ENTEGRASYONU ====================
        
        // Maliyet takibi i√ßin localStorage
        let queryCostTracker = {
            totalQueries: parseInt(localStorage.getItem('gpt_total_queries') || '0'),
            totalCost: parseFloat(localStorage.getItem('gpt_total_cost') || '0'),
            monthlyQueries: parseInt(localStorage.getItem('gpt_monthly_queries') || '0'),
            monthlyCost: parseFloat(localStorage.getItem('gpt_monthly_cost') || '0'),
            lastResetDate: localStorage.getItem('gpt_last_reset') || new Date().toISOString().slice(0, 7)
        };
        
        // Aylƒ±k sƒ±fƒ±rlama kontrol√º
        function checkMonthlyReset() {
            const currentMonth = new Date().toISOString().slice(0, 7);
            if (queryCostTracker.lastResetDate !== currentMonth) {
                queryCostTracker.monthlyQueries = 0;
                queryCostTracker.monthlyCost = 0;
                queryCostTracker.lastResetDate = currentMonth;
                localStorage.setItem('gpt_monthly_queries', '0');
                localStorage.setItem('gpt_monthly_cost', '0');
                localStorage.setItem('gpt_last_reset', currentMonth);
            }
        }
        
        // Maliyet g√ºncelleme
        function updateQueryCost(model, inputTokens, outputTokens) {
            checkMonthlyReset();
            
            let cost = 0;
            if (model === 'gpt-3.5-turbo') {
                cost = (inputTokens / 1000 * 0.0005) + (outputTokens / 1000 * 0.0015);
            } else if (model === 'gpt-4-turbo') {
                cost = (inputTokens / 1000 * 0.01) + (outputTokens / 1000 * 0.03);
            } else if (model === 'gpt-4o-mini') {
                cost = (inputTokens / 1000 * 0.00015) + (outputTokens / 1000 * 0.0006);
            }
            
            queryCostTracker.totalQueries++;
            queryCostTracker.totalCost += cost;
            queryCostTracker.monthlyQueries++;
            queryCostTracker.monthlyCost += cost;
            
            localStorage.setItem('gpt_total_queries', queryCostTracker.totalQueries.toString());
            localStorage.setItem('gpt_total_cost', queryCostTracker.totalCost.toFixed(4));
            localStorage.setItem('gpt_monthly_queries', queryCostTracker.monthlyQueries.toString());
            localStorage.setItem('gpt_monthly_cost', queryCostTracker.monthlyCost.toFixed(4));
            
            console.log(`üí∞ GPT Maliyet: $${cost.toFixed(4)} | Aylƒ±k Toplam: $${queryCostTracker.monthlyCost.toFixed(2)} (${queryCostTracker.monthlyQueries} sorgu)`);
            
            return cost;
        }
        
        // GPT API √ßaƒürƒ±sƒ± (Backend'e g√∂nderilecek)
        async function callGPTAPI(query, context) {
            // √ñNEMLƒ∞: Bu fonksiyon ≈üu anda placeholder. 
            // Ger√ßek kullanƒ±m i√ßin backend API endpoint'i gerekli.
            
            console.log('ü§ñ GPT API √ßaƒürƒ±sƒ± hazƒ±rlanƒ±yor...');
            console.log('üìù Sorgu:', query);
            console.log('üìä Context boyutu:', JSON.stringify(context).length, 'karakter');
            
            // Backend endpoint
            const BACKEND_URL = 'YOUR_BACKEND_URL_HERE'; // Buraya backend URL'i eklenecek
            
            try {
                // Backend'e istek g√∂nder
                const response = await fetch(BACKEND_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        query: query,
                        context: context,
                        model: 'gpt-3.5-turbo' // veya 'gpt-4-turbo'
                    })
                });
                
                if (!response.ok) {
                    throw new Error(`Backend error: ${response.status}`);
                }
                
                const data = await response.json();
                
                // Maliyet takibi
                if (data.usage) {
                    updateQueryCost(
                        data.model || 'gpt-3.5-turbo',
                        data.usage.prompt_tokens,
                        data.usage.completion_tokens
                    );
                }
                
                return {
                    success: true,
                    answer: data.answer,
                    model: data.model,
                    cost: data.cost
                };
                
            } catch (error) {
                console.error('‚ùå GPT API Hatasƒ±:', error);
                return {
                    success: false,
                    error: error.message
                };
            }
        }
        
        // Maliyet istatistiklerini g√∂ster
        function showCostStats() {
            checkMonthlyReset();
            
            const statsHTML = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin: 10px 0;">
                    <h4 style="margin: 0 0 10px 0;">üí∞ GPT Maliyet ƒ∞statistikleri</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <strong>Bu Ay:</strong><br>
                            ${queryCostTracker.monthlyQueries} sorgu<br>
                            $${queryCostTracker.monthlyCost.toFixed(2)} (~${(queryCostTracker.monthlyCost * 30).toFixed(0)} TL)
                        </div>
                        <div>
                            <strong>Toplam:</strong><br>
                            ${queryCostTracker.totalQueries} sorgu<br>
                            $${queryCostTracker.totalCost.toFixed(2)}
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.9;">
                        üìä Ortalama: $${(queryCostTracker.monthlyCost / Math.max(queryCostTracker.monthlyQueries, 1)).toFixed(4)}/sorgu
                    </div>
                </div>
            `;
            
            // Stats'ƒ± debug panel'e ekle
            const debugPanel = document.getElementById('debugPanel');
            if (debugPanel && debugPanel.style.display === 'block') {
                const debugInfo = document.getElementById('debugInfo');
                debugInfo.innerHTML += statsHTML;
            }
        }
        
        // Konsol komutu: Maliyet istatistiklerini g√∂ster
        window.showGPTStats = function() {
            checkMonthlyReset();
            console.log('üí∞ GPT Maliyet ƒ∞statistikleri:');
            console.log('Bu Ay:', queryCostTracker.monthlyQueries, 'sorgu, $' + queryCostTracker.monthlyCost.toFixed(2));
            console.log('Toplam:', queryCostTracker.totalQueries, 'sorgu, $' + queryCostTracker.totalCost.toFixed(2));
            console.log('Ortalama:', '$' + (queryCostTracker.monthlyCost / Math.max(queryCostTracker.monthlyQueries, 1)).toFixed(4), 'per sorgu');
        };
        
        // Konsol komutu: Maliyet sƒ±fƒ±rla
        window.resetGPTStats = function() {
            if (confirm('T√ºm GPT maliyet istatistiklerini sƒ±fƒ±rlamak istediƒüinize emin misiniz?')) {
                localStorage.removeItem('gpt_total_queries');
                localStorage.removeItem('gpt_total_cost');
                localStorage.removeItem('gpt_monthly_queries');
                localStorage.removeItem('gpt_monthly_cost');
                localStorage.removeItem('gpt_last_reset');
                queryCostTracker = {
                    totalQueries: 0,
                    totalCost: 0,
                    monthlyQueries: 0,
                    monthlyCost: 0,
                    lastResetDate: new Date().toISOString().slice(0, 7)
                };
                console.log('‚úÖ GPT maliyet istatistikleri sƒ±fƒ±rlandƒ±.');
            }
        };
        
        console.log('‚úÖ GPT Backend hazƒ±r! Kullanƒ±m:');
        console.log('   showGPTStats() - Maliyet istatistiklerini g√∂ster');
        console.log('   resetGPTStats() - Maliyet istatistiklerini sƒ±fƒ±rla');
        
        // ==================== CUSTOMER SEARCH IN MAIN TAB ====================
        let customerBrandChartMainInstance = null;
        let customerCategoryChartMainInstance = null;
        
        function searchCustomerProfileMain() {
            const searchQuery = document.getElementById('customerSearchInputMain').value.trim().toLowerCase();
            
            if (!searchQuery) {
                alert('L√ºtfen bir m√º≈üteri adƒ± girin');
                return;
            }
            
            console.log('üîç M√º≈üteri aranƒ±yor:', searchQuery);
            
            // M√º≈üteri verilerini filtrele (fuzzy matching)
            const customerData = allData.filter(item => 
                item.partner && item.partner.toLowerCase().includes(searchQuery)
            );
            
            if (customerData.length === 0) {
                document.getElementById('customerProfileMainContainer').style.display = 'none';
                alert('M√º≈üteri bulunamadƒ±. L√ºtfen farklƒ± bir isim deneyin.');
                return;
            }
            
            // Sonu√ßlarƒ± g√∂ster ve Top 30 + Grafikleri gizle
            document.getElementById('customerProfileMainContainer').style.display = 'block';
            document.getElementById('topCustomersSection').style.display = 'none';
            document.getElementById('customerChartsSection').style.display = 'none';
            
            // M√º≈üteri bilgilerini hesapla
            const customerName = customerData[0].partner;
            const customerCity = customerData[0].city || 'Bilinmiyor';
            const customerTags = customerData[0].tags || '-';
            
            const totalSales = customerData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = customerData.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const uniqueDates = new Set(customerData.map(item => item.date));
            const transactionCount = uniqueDates.size;
            const avgBasket = totalSales / Math.max(transactionCount, 1);
            
            // UI g√ºncelle
            document.getElementById('customerNameMain').textContent = customerName;
            document.getElementById('customerCityMain').textContent = customerCity;
            document.getElementById('customerTagsMain').textContent = customerTags;
            document.getElementById('customerTotalSalesMain').textContent = '$' + totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('customerTotalQtyMain').textContent = totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('customerTransactionCountMain').textContent = transactionCount;
            document.getElementById('customerAvgBasketMain').textContent = '$' + avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            
            // Grafikleri render et
            renderCustomerBrandChartMain(customerData);
            renderCustomerCategoryChartMain(customerData);
            
            // Veriyi kaydet (sƒ±ralama i√ßin)
            lastCustomerPurchaseData = customerData;
            
            // Satƒ±n alma ge√ßmi≈üi tablosu
            renderCustomerPurchaseHistoryMain(customerData);
            
            // AI analiz
            performCustomerAIAnalysisMain(customerData, {
                name: customerName,
                city: customerCity,
                tags: customerTags,
                totalSales,
                totalQty,
                transactionCount,
                avgBasket
            });
            
            // Sonu√ßlara scroll
            document.getElementById('customerProfileMainContainer').scrollIntoView({behavior: 'smooth', block: 'start'});
        }
        
        // Temizle butonu fonksiyonu
        function clearCustomerSearchMain() {
            // Input'u temizle
            document.getElementById('customerSearchInputMain').value = '';
            
            // Arama sonu√ßlarƒ±nƒ± gizle
            document.getElementById('customerProfileMainContainer').style.display = 'none';
            
            // Top 30 ve Grafikleri g√∂ster
            document.getElementById('topCustomersSection').style.display = 'block';
            document.getElementById('customerChartsSection').style.display = 'grid';
            
            console.log('‚úÖ M√º≈üteri aramasƒ± temizlendi, Top 30 ve grafikler g√∂steriliyor');
        }
        
        function renderCustomerBrandChartMain(data) {
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += parseFloat(item.usd_amount || 0);
            });
            
            const sorted = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1]);
            
            const ctx = document.getElementById('customerBrandChartMain');
            if (!ctx) return;
            
            if (customerBrandChartMainInstance) {
                customerBrandChartMainInstance.destroy();
            }
            
            customerBrandChartMainInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD - KDV Hari√ß)',
                        data: values,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCustomerCategoryChartMain(data) {
            const categoryData = {};
            data.forEach(item => {
                const category = item.category_2 || item.category_1 || 'Bilinmiyor';
                if (!categoryData[category]) categoryData[category] = 0;
                categoryData[category] += parseFloat(item.usd_amount || 0);
            });
            
            const sorted = Object.entries(categoryData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1]);
            
            const ctx = document.getElementById('customerCategoryChartMain');
            if (!ctx) return;
            
            if (customerCategoryChartMainInstance) {
                customerCategoryChartMainInstance.destroy();
            }
            
            customerCategoryChartMainInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD - KDV Hari√ß)',
                        data: values,
                        backgroundColor: 'rgba(56, 239, 125, 0.6)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCustomerPurchaseHistoryMain(data = null, sortColumn = null, sortDirection = null) {
            // Eƒüer data null ise, mevcut veriyi kullan
            if (data === null && lastCustomerPurchaseData) {
                data = lastCustomerPurchaseData;
            }
            
            // ƒ∞ndirim √ºr√ºnlerini filtrele (tablolarda g√∂sterme)
            if (data) {
                data = data.filter(item => !item._isDiscount);
            }
            
            if (!data || data.length === 0) {
                document.getElementById('customerPurchaseHistoryMain').innerHTML = '<p style="text-align: center; padding: 20px;">Veri bulunamadƒ±</p>';
                return;
            }
            
            // Sƒ±ralama parametrelerini g√ºncelle
            if (sortColumn !== null) {
                if (currentCustomerPurchaseSortColumn === sortColumn) {
                    currentCustomerPurchaseSortDirection = currentCustomerPurchaseSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentCustomerPurchaseSortColumn = sortColumn;
                    currentCustomerPurchaseSortDirection = sortColumn === 'date' ? 'desc' : 'asc';
                }
            }
            
            // Sƒ±ralama
            let sorted = [...data];
            
            if (currentCustomerPurchaseSortColumn === 'date') {
                sorted.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return currentCustomerPurchaseSortDirection === 'asc' ? dateA - dateB : dateB - dateA;
                });
            } else if (currentCustomerPurchaseSortColumn === 'product') {
                sorted.sort((a, b) => {
                    return currentCustomerPurchaseSortDirection === 'asc'
                        ? (a.product || '').localeCompare(b.product || '', 'tr')
                        : (b.product || '').localeCompare(a.product || '', 'tr');
                });
            } else if (currentCustomerPurchaseSortColumn === 'brand') {
                sorted.sort((a, b) => {
                    return currentCustomerPurchaseSortDirection === 'asc'
                        ? (a.brand || '').localeCompare(b.brand || '', 'tr')
                        : (b.brand || '').localeCompare(a.brand || '', 'tr');
                });
            } else if (currentCustomerPurchaseSortColumn === 'quantity') {
                sorted.sort((a, b) => {
                    return currentCustomerPurchaseSortDirection === 'asc'
                        ? parseFloat(a.quantity || 0) - parseFloat(b.quantity || 0)
                        : parseFloat(b.quantity || 0) - parseFloat(a.quantity || 0);
                });
            } else if (currentCustomerPurchaseSortColumn === 'amount') {
                sorted.sort((a, b) => {
                    return currentCustomerPurchaseSortDirection === 'asc'
                        ? parseFloat(a.usd_amount || 0) - parseFloat(b.usd_amount || 0)
                        : parseFloat(b.usd_amount || 0) - parseFloat(a.usd_amount || 0);
                });
            } else if (currentCustomerPurchaseSortColumn === 'store') {
                sorted.sort((a, b) => {
                    return currentCustomerPurchaseSortDirection === 'asc'
                        ? (a.store || '').localeCompare(b.store || '', 'tr')
                        : (b.store || '').localeCompare(a.store || '', 'tr');
                });
            }
            
            // Son 20 i≈ülem
            sorted = sorted.slice(0, 20);
            
            const getSortIcon = (column) => {
                if (currentCustomerPurchaseSortColumn !== column) return '‚áÖ';
                return currentCustomerPurchaseSortDirection === 'asc' ? '‚Üë' : '‚Üì';
            };
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'date')">
                                Tarih ${getSortIcon('date')}
                            </th>
                            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'product')">
                                √úr√ºn ${getSortIcon('product')}
                            </th>
                            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'brand')">
                                Marka ${getSortIcon('brand')}
                            </th>
                            <th style="padding: 12px; text-align: right; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'quantity')">
                                Adet ${getSortIcon('quantity')}
                            </th>
                            <th style="padding: 12px; text-align: right; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'amount')">
                                Tutar ${getSortIcon('amount')}
                            </th>
                            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'store')">
                                Maƒüaza ${getSortIcon('store')}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sorted.forEach((item, index) => {
                html += `
                    <tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                        <td style="padding: 10px;">${item.date}</td>
                        <td style="padding: 10px;"><strong>${item.product}</strong></td>
                        <td style="padding: 10px;">${item.brand}</td>
                        <td style="padding: 10px; text-align: right;">${parseFloat(item.quantity || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 10px; text-align: right; color: #38ef7d; font-weight: bold;">$${parseFloat(item.usd_amount || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 10px;">${item.store}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('customerPurchaseHistoryMain').innerHTML = html;
        }
        
        function performCustomerAIAnalysisMain(data, profile) {
            console.log('ü§ñ M√º≈üteri AI analizi ba≈ülatƒ±lƒ±yor...', profile);
            
            // Veri analizi
            const brandData = {};
            const categoryData = {};
            const storeData = {};
            const monthlyData = {};
            
            data.forEach(item => {
                // Marka
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = {sales: 0, qty: 0, count: 0};
                brandData[brand].sales += parseFloat(item.usd_amount || 0);
                brandData[brand].qty += parseFloat(item.quantity || 0);
                brandData[brand].count += 1;
                
                // Kategori (category_2 √∂ncelikli)
                const category = item.category_2 || item.category_1 || 'Bilinmiyor';
                if (!categoryData[category]) categoryData[category] = {sales: 0, qty: 0};
                categoryData[category].sales += parseFloat(item.usd_amount || 0);
                categoryData[category].qty += parseFloat(item.quantity || 0);
                
                // Maƒüaza
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) storeData[store] = {sales: 0, count: 0};
                storeData[store].sales += parseFloat(item.usd_amount || 0);
                storeData[store].count += 1;
                
                // Aylƒ±k
                const month = item.date ? item.date.substring(0, 7) : 'Bilinmiyor';
                if (!monthlyData[month]) monthlyData[month] = 0;
                monthlyData[month] += parseFloat(item.usd_amount || 0);
            });
            
            // Top 3 listeler
            const topBrands = Object.entries(brandData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            const topCategories = Object.entries(categoryData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            const topStores = Object.entries(storeData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 3);
            const monthlySales = Object.entries(monthlyData).sort((a, b) => new Date(b[0]) - new Date(a[0])).slice(0, 6);
            
            // En √ßok alƒ±nan √ºr√ºn
            const productData = {};
            data.forEach(item => {
                const product = item.product || 'Bilinmiyor';
                if (!productData[product]) productData[product] = {qty: 0, sales: 0};
                productData[product].qty += parseFloat(item.quantity || 0);
                productData[product].sales += parseFloat(item.usd_amount || 0);
            });
            const topProduct = Object.entries(productData).sort((a, b) => b[1].qty - a[1].qty)[0];
            
            // AI ƒ∞√ßg√∂r√ºleri
            const insights = {
                positive: [],
                negative: [],
                neutral: [],
                recommendations: []
            };
            
            // Pozitif ƒ∞√ßg√∂r√ºler
            if (profile.totalSales > 10000) {
                insights.positive.push({
                    title: 'üíé VIP M√º≈üteri',
                    description: `${profile.name}, toplam $${profile.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} alƒ±≈üveri≈ü ile VIP m√º≈üteri kategorisinde. Bu m√º≈üteriye √∂zel ilgi g√∂sterilmeli.`
                });
            } else if (profile.totalSales > 5000) {
                insights.positive.push({
                    title: '‚≠ê Deƒüerli M√º≈üteri',
                    description: `${profile.name}, toplam $${profile.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} alƒ±≈üveri≈ü ile deƒüerli m√º≈üteri kategorisinde.`
                });
            }
            
            if (profile.transactionCount > 10) {
                insights.positive.push({
                    title: 'üîÑ Sadƒ±k M√º≈üteri',
                    description: `${profile.transactionCount} i≈ülem ile d√ºzenli alƒ±≈üveri≈ü yapan sadƒ±k bir m√º≈üteri. M√º≈üteri memnuniyeti y√ºksek.`
                });
            }
            
            if (profile.avgBasket > 1000) {
                insights.positive.push({
                    title: 'üõí Y√ºksek Sepet Ortalamasƒ±',
                    description: `Ortalama sepet tutarƒ± $${profile.avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2})}. Premium √ºr√ºnlere ilgi g√∂steriyor.`
                });
            }
            
            if (topBrands.length > 0) {
                insights.positive.push({
                    title: `üè∑Ô∏è Favori Marka: ${topBrands[0][0]}`,
                    description: `${topBrands[0][0]} markasƒ±ndan $${topBrands[0][1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} deƒüerinde ${topBrands[0][1].count} adet √ºr√ºn aldƒ±. Bu markada yeni √ºr√ºnler √∂nerilmeli.`
                });
            }
            
            // Negatif ƒ∞√ßg√∂r√ºler / Dikkat Edilmesi Gerekenler
            if (profile.transactionCount < 3) {
                insights.negative.push({
                    title: '‚ö†Ô∏è Yeni M√º≈üteri',
                    description: `Sadece ${profile.transactionCount} i≈ülem ger√ßekle≈ütirdi. M√º≈üteri sadakati olu≈üturmak i√ßin √∂zel kampanyalar sunulmalƒ±.`
                });
            }
            
            if (profile.avgBasket < 500) {
                insights.negative.push({
                    title: 'üìä D√º≈ü√ºk Sepet Ortalamasƒ±',
                    description: `Ortalama sepet tutarƒ± $${profile.avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2})}. Cross-sell ve up-sell fƒ±rsatlarƒ± deƒüerlendirilmeli.`
                });
            }
            
            const lastPurchaseDate = data.length > 0 ? new Date(Math.max(...data.map(item => new Date(item.date)))) : null;
            if (lastPurchaseDate) {
                const daysSinceLastPurchase = Math.floor((new Date() - lastPurchaseDate) / (1000 * 60 * 60 * 24));
                if (daysSinceLastPurchase > 90) {
                    insights.negative.push({
                        title: '‚è∞ Uzun S√ºredir Alƒ±≈üveri≈ü Yok',
                        description: `Son alƒ±≈üveri≈üten ${daysSinceLastPurchase} g√ºn ge√ßti. M√º≈üteriyi geri kazanmak i√ßin hatƒ±rlatma kampanyasƒ± d√ºzenlenebilir.`
                    });
                }
            }
            
            // N√∂tr ƒ∞√ßg√∂r√ºler
            insights.neutral.push({
                title: 'üìç Konum Bilgisi',
                description: `M√º≈üteri ${profile.city} ≈üehrinden alƒ±≈üveri≈ü yapƒ±yor. ${topStores.length > 0 ? `En √ßok ${topStores[0][0]} maƒüazasƒ±nƒ± tercih ediyor.` : ''}`
            });
            
            if (topCategories.length > 0) {
                insights.neutral.push({
                    title: `üìÇ ƒ∞lgi Alanƒ±: ${topCategories[0][0]}`,
                    description: `${topCategories[0][0]} kategorisinden $${topCategories[0][1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} deƒüerinde alƒ±≈üveri≈ü yaptƒ±.`
                });
            }
            
            if (topProduct) {
                insights.neutral.push({
                    title: `üéØ En √áok Aldƒ±ƒüƒ± √úr√ºn`,
                    description: `${topProduct[0]} √ºr√ºn√ºnden ${topProduct[1].qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})} adet aldƒ±.`
                });
            }
            
            // √ñneriler
            if (topBrands.length > 1) {
                insights.recommendations.push({
                    icon: 'üéÅ',
                    title: '√áapraz Satƒ±≈ü Fƒ±rsatƒ±',
                    description: `M√º≈üteri ${topBrands.map(b => b[0]).join(', ')} markalarƒ±nƒ± tercih ediyor. Bu markalarƒ±n yeni √ºr√ºnleri ve aksesuarlarƒ± √∂nerilebilir.`
                });
            }
            
            if (profile.avgBasket > 500) {
                insights.recommendations.push({
                    icon: 'üí≥',
                    title: 'Premium √úr√ºn √ñnerisi',
                    description: `Y√ºksek sepet ortalamasƒ± nedeniyle premium ve l√ºks √ºr√ºnler √∂nerilebilir. √ñzel koleksiyonlar sunulmalƒ±.`
                });
            }
            
            if (profile.transactionCount > 5) {
                insights.recommendations.push({
                    icon: 'üéñÔ∏è',
                    title: 'Sadakat Programƒ±',
                    description: `D√ºzenli m√º≈üteri olduƒüu i√ßin sadakat programƒ±na dahil edilmeli. √ñzel indirimler ve erken eri≈üim fƒ±rsatlarƒ± sunulabilir.`
                });
            }
            
            if (topStores.length > 0) {
                insights.recommendations.push({
                    icon: 'üè™',
                    title: 'Maƒüaza Bazlƒ± Kampanya',
                    description: `${topStores[0][0]} maƒüazasƒ±nƒ± sƒ±klƒ±kla tercih ediyor. Bu maƒüazada √∂zel etkinlikler ve lansmanlar i√ßin davet g√∂nderilebilir.`
                });
            }
            
            insights.recommendations.push({
                icon: 'üìß',
                title: 'Ki≈üiselle≈ütirilmi≈ü ƒ∞leti≈üim',
                description: `${topCategories.length > 0 ? topCategories[0][0] : 'ƒ∞lgi alanƒ±'} kategorisindeki yeni √ºr√ºnler hakkƒ±nda e-posta veya SMS ile bilgilendirme yapƒ±labilir.`
            });
            
            if (monthlySales.length > 0) {
                const avgMonthlySales = monthlySales.reduce((sum, item) => sum + item[1], 0) / monthlySales.length;
                insights.recommendations.push({
                    icon: 'üìä',
                    title: 'Alƒ±≈üveri≈ü Tahmini',
                    description: `Aylƒ±k ortalama $${avgMonthlySales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} alƒ±≈üveri≈ü yapƒ±yor. Gelecek ay i√ßin √∂zel teklifler hazƒ±rlanabilir.`
                });
            }
            
            // HTML olu≈üturma
            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">
                    ${insights.positive.length > 0 ? `
                    <div class="analysis-section">
                        <h3 style="color: white; margin-top: 0;">‚úÖ G√º√ßl√º Y√∂nler</h3>
                        ${insights.positive.map(item => `
                            <div class="insight-item insight-positive" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">‚úÖ</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.negative.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 30px;">
                        <h3 style="color: white;">‚ö†Ô∏è Dikkat Edilmesi Gerekenler</h3>
                        ${insights.negative.map(item => `
                            <div class="insight-item insight-negative" style="background: rgba(255, 107, 107, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ff6b6b;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">‚ö†Ô∏è</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.neutral.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 30px;">
                        <h3 style="color: white;">üìä Genel Bilgiler</h3>
                        ${insights.neutral.map(item => `
                            <div class="insight-item insight-neutral" style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid white;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">üìä</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.recommendations.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 30px;">
                        <h3 style="color: white;">üí° Aksiyon √ñnerileri</h3>
                        ${insights.recommendations.map(item => `
                            <div class="recommendation" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700; display: flex; align-items: start; gap: 15px;">
                                <span class="recommendation-icon" style="font-size: 2em; flex-shrink: 0;">${item.icon}</span>
                                <div style="flex: 1;">
                                    <strong style="font-size: 1.1em; display: block; margin-bottom: 5px;">${item.title}</strong>
                                    <span style="opacity: 0.95;">${item.description}</span>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                </div>
            `;
            
            document.getElementById('customerAIAnalysisContentMain').innerHTML = html;
            document.getElementById('customerAIAnalysisPanelMain').style.display = 'block';
        }
        
        // ==================== OLD CUSTOMER SEARCH TAB (DEPRECATED) ====================
        let customerBrandChartInstance = null;
        let customerCategoryChartInstance = null;
        let customerStoreChartInstance = null;
        let customerMonthlyTrendChartInstance = null;
        
        function populateCityDropdownForCustomerSearch() {
            // Artƒ±k kullanƒ±lmƒ±yor - M√º≈üteri arama M√º≈üteri Analizi i√ßinde
            console.log('‚ö†Ô∏è Bu fonksiyon artƒ±k kullanƒ±lmƒ±yor');
        }
        
        // ==================== AUTOCOMPLETE FUNCTIONS ====================
        let customerSuggestionIndex = -1;
        let salespersonSuggestionIndex = -1;
        let storeSuggestionIndex = -1;
        let selectedCustomers = []; // Se√ßili m√º≈üteriler
        let selectedStores = []; // Se√ßili maƒüazalar
        
        function showCustomerSuggestions(query) {
            const suggestionsDiv = document.getElementById('customerSuggestions');
            
            // Virg√ºlden sonraki son terimi al
            const terms = query.split(',');
            const lastTerm = terms[terms.length - 1].trim().toLowerCase();
            query = lastTerm;
            
            if (query.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            if (!allData || allData.length === 0) {
                return;
            }
            
            // Benzersiz m√º≈üterileri bul
            const customerMap = {};
            allData.forEach(item => {
                const name = item.partner || '';
                if (name && name.toLowerCase().includes(query)) {
                    if (!customerMap[name]) {
                        customerMap[name] = {
                            name: name,
                            sales: 0,
                            count: 0
                        };
                    }
                    customerMap[name].sales += parseFloat(item.usd_amount || 0);
                    customerMap[name].count += 1;
                }
            });
            
            // Satƒ±≈üa g√∂re sƒ±rala, ilk 10
            const customers = Object.values(customerMap)
                .sort((a, b) => b.sales - a.sales)
                .slice(0, 10);
            
            if (customers.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            let html = '';
            customers.forEach((customer, idx) => {
                html += `<div class="suggestion-item" data-index="${idx}" data-name="${customer.name}" 
                    style="padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #e0e0e0; transition: background 0.2s;"
                    onmouseover="this.style.background='#f0f0ff'; customerSuggestionIndex=${idx};"
                    onmouseout="this.style.background='white';"
                    onclick="selectCustomerSuggestion('${customer.name.replace(/'/g, "\\'")}')">
                    <strong>${customer.name}</strong>
                    <span style="color: #667eea; margin-left: 10px; font-size: 0.9em;">
                        $${customer.sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} ‚Ä¢ ${customer.count} sipari≈ü
                    </span>
                </div>`;
            });
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';
            customerSuggestionIndex = -1;
        }
        
        function selectCustomerSuggestion(name) {
            // √áoklu se√ßim: m√º≈üteriyi listeye ekle
            if (selectedCustomers.length >= 3) {
                alert('‚ö†Ô∏è En fazla 3 m√º≈üteri se√ßebilirsiniz!');
                return;
            }
            
            if (selectedCustomers.includes(name)) {
                alert('‚ö†Ô∏è Bu m√º≈üteri zaten se√ßili!');
                return;
            }
            
            selectedCustomers.push(name);
            updateSelectedCustomersTags();
            document.getElementById('customerSearchInput').value = '';
            document.getElementById('customerSuggestions').style.display = 'none';
            
            // Otomatik arama yap
            searchCustomerProfile();
        }
        
        function updateSelectedCustomersTags() {
            const container = document.getElementById('selectedCustomersContainer');
            const tagsContainer = document.getElementById('selectedCustomersTags');
            
            if (selectedCustomers.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            tagsContainer.innerHTML = selectedCustomers.map((customer, index) => `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 0.9em;">
                    <span>üë§ ${customer}</span>
                    <button onclick="removeCustomer(${index})" 
                            style="background: rgba(255,255,255,0.3); border: none; color: white; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8em;">
                        √ó
                    </button>
                </div>
            `).join('');
        }
        
        function removeCustomer(index) {
            selectedCustomers.splice(index, 1);
            updateSelectedCustomersTags();
            
            // Eƒüer m√º≈üteri kalmadƒ±ysa sonu√ßlarƒ± temizle
            if (selectedCustomers.length === 0) {
                document.getElementById('customerProfileContainer').style.display = 'none';
            } else {
                // Kalan m√º≈üterilerle yeniden arama yap
                searchCustomerProfile();
            }
        }
        
        function handleCustomerKeydown(event) {
            const suggestionsDiv = document.getElementById('customerSuggestions');
            const items = suggestionsDiv.querySelectorAll('.suggestion-item');
            
            if (items.length === 0) return;
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                customerSuggestionIndex = Math.min(customerSuggestionIndex + 1, items.length - 1);
                highlightCustomerSuggestion(items);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                customerSuggestionIndex = Math.max(customerSuggestionIndex - 1, 0);
                highlightCustomerSuggestion(items);
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (customerSuggestionIndex >= 0 && items[customerSuggestionIndex]) {
                    const name = items[customerSuggestionIndex].getAttribute('data-name');
                    selectCustomerSuggestion(name);
                } else {
                    searchCustomerProfile();
                }
            } else if (event.key === 'Escape') {
                suggestionsDiv.style.display = 'none';
            }
        }
        
        function highlightCustomerSuggestion(items) {
            items.forEach((item, idx) => {
                if (idx === customerSuggestionIndex) {
                    item.style.background = '#f0f0ff';
                    item.scrollIntoView({block: 'nearest'});
                } else {
                    item.style.background = 'white';
                }
            });
        }
        
        function showSalespersonSuggestions(query) {
            const suggestionsDiv = document.getElementById('salespersonSuggestions');
            query = query.trim().toLowerCase();
            
            if (query.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            if (!allData || allData.length === 0) {
                return;
            }
            
            // Benzersiz satƒ±≈ü temsilcilerini bul
            const spMap = {};
            allData.forEach(item => {
                const name = item.sales_person || '';
                const store = item.store || '';
                // Analitik ve Eƒüitim hari√ß
                if (store.toLowerCase().includes('analitik') || store.toLowerCase().includes('eƒüitim')) {
                    return;
                }
                if (name && name.toLowerCase().includes(query)) {
                    if (!spMap[name]) {
                        spMap[name] = {
                            name: name,
                            sales: 0,
                            count: 0
                        };
                    }
                    spMap[name].sales += parseFloat(item.usd_amount || 0);
                    spMap[name].count += 1;
                }
            });
            
            // Satƒ±≈üa g√∂re sƒ±rala, ilk 10
            const salespersons = Object.values(spMap)
                .sort((a, b) => b.sales - a.sales)
                .slice(0, 10);
            
            if (salespersons.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            let html = '';
            salespersons.forEach((sp, idx) => {
                html += `<div class="suggestion-item" data-index="${idx}" data-name="${sp.name}" 
                    style="padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #e0e0e0; transition: background 0.2s;"
                    onmouseover="this.style.background='#f0f0ff'; salespersonSuggestionIndex=${idx};"
                    onmouseout="this.style.background='white';"
                    onclick="selectSalespersonSuggestion('${sp.name.replace(/'/g, "\\'")}')">
                    <strong>${sp.name}</strong>
                    <span style="color: #667eea; margin-left: 10px; font-size: 0.9em;">
                        $${sp.sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} ‚Ä¢ ${sp.count} satƒ±≈ü
                    </span>
                </div>`;
            });
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';
            salespersonSuggestionIndex = -1;
        }
        
        function selectSalespersonSuggestion(name) {
            // √áoklu se√ßim: temsilciyi listeye ekle
            if (selectedSalespersons.length >= 3) {
                alert('‚ö†Ô∏è En fazla 3 satƒ±≈ü temsilcisi se√ßebilirsiniz!');
                return;
            }
            
            if (selectedSalespersons.includes(name)) {
                alert('‚ö†Ô∏è Bu temsilci zaten se√ßili!');
                return;
            }
            
            selectedSalespersons.push(name);
            updateSelectedSalespersonsTags();
            document.getElementById('salespersonSearchInput').value = '';
            document.getElementById('salespersonSuggestions').style.display = 'none';
            
            // Otomatik arama yap
            searchSalespersonProfile();
        }
        
        function updateSelectedSalespersonsTags() {
            const container = document.getElementById('selectedSalespersonsContainer');
            const tagsContainer = document.getElementById('selectedSalespersonsTags');
            
            if (selectedSalespersons.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            tagsContainer.innerHTML = selectedSalespersons.map(name => `
                <div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; font-size: 0.9em;">
                    <span>üë®‚Äçüíº ${name}</span>
                    <button onclick="removeSalesperson('${name.replace(/'/g, "\\'")}'); event.stopPropagation();" 
                            style="background: rgba(255,255,255,0.3); border: none; color: white; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8em;">
                        √ó
                    </button>
                </div>
            `).join('');
        }
        
        function removeSalesperson(name) {
            selectedSalespersons = selectedSalespersons.filter(sp => sp !== name);
            updateSelectedSalespersonsTags();
            if (selectedSalespersons.length > 0) {
                searchSalespersonProfile();
            } else {
                document.getElementById('salespersonProfileContainer').style.display = 'none';
            }
        }
        
        function handleSalespersonKeydown(event) {
            const suggestionsDiv = document.getElementById('salespersonSuggestions');
            const items = suggestionsDiv.querySelectorAll('.suggestion-item');
            
            if (items.length === 0) return;
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                salespersonSuggestionIndex = Math.min(salespersonSuggestionIndex + 1, items.length - 1);
                highlightSalespersonSuggestion(items);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                salespersonSuggestionIndex = Math.max(salespersonSuggestionIndex - 1, 0);
                highlightSalespersonSuggestion(items);
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (salespersonSuggestionIndex >= 0 && items[salespersonSuggestionIndex]) {
                    const name = items[salespersonSuggestionIndex].getAttribute('data-name');
                    selectSalespersonSuggestion(name);
                } else {
                    searchSalespersonProfile();
                }
            } else if (event.key === 'Escape') {
                suggestionsDiv.style.display = 'none';
            }
        }
        
        function highlightSalespersonSuggestion(items) {
            items.forEach((item, idx) => {
                if (idx === salespersonSuggestionIndex) {
                    item.style.background = '#f0f0ff';
                    item.scrollIntoView({block: 'nearest'});
                } else {
                    item.style.background = 'white';
                }
            });
        }
        
        // MAƒûAZA AUTOCOMPLETE
        function showStoreSuggestions(query) {
            const suggestionsDiv = document.getElementById('storeSuggestions');
            query = query.trim().toLowerCase();
            
            if (query.length < 2) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            if (!allData || allData.length === 0) {
                return;
            }
            
            // Benzersiz maƒüazalarƒ± bul
            const storeMap = {};
            allData.forEach(item => {
                const name = item.store || '';
                if (name && name.toLowerCase().includes(query)) {
                    if (!storeMap[name]) {
                        storeMap[name] = {
                            name: name,
                            sales: 0,
                            count: 0
                        };
                    }
                    storeMap[name].sales += parseFloat(item.usd_amount || 0);
                    storeMap[name].count += 1;
                }
            });
            
            // Satƒ±≈üa g√∂re sƒ±rala, ilk 10
            const stores = Object.values(storeMap)
                .sort((a, b) => b.sales - a.sales)
                .slice(0, 10);
            
            if (stores.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }
            
            let html = '';
            stores.forEach((store, idx) => {
                html += `<div class="suggestion-item" data-index="${idx}" data-name="${store.name}" 
                    style="padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #e0e0e0; transition: background 0.2s;"
                    onmouseover="this.style.background='#f0f0ff'; storeSuggestionIndex=${idx};"
                    onmouseout="this.style.background='white';"
                    onclick="selectStoreSuggestion('${store.name.replace(/'/g, "\\'")}')">
                    <strong>${store.name}</strong>
                    <span style="color: #667eea; margin-left: 10px; font-size: 0.9em;">
                        $${store.sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} ‚Ä¢ ${store.count} satƒ±≈ü
                    </span>
                </div>`;
            });
            
            suggestionsDiv.innerHTML = html;
            suggestionsDiv.style.display = 'block';
            storeSuggestionIndex = -1;
        }
        
        function selectStoreSuggestion(name) {
            // √áoklu se√ßim: maƒüazayƒ± listeye ekle
            if (selectedStores.length >= 3) {
                alert('‚ö†Ô∏è En fazla 3 maƒüaza se√ßebilirsiniz!');
                return;
            }
            
            if (selectedStores.includes(name)) {
                alert('‚ö†Ô∏è Bu maƒüaza zaten se√ßili!');
                return;
            }
            
            selectedStores.push(name);
            updateSelectedStoresTags();
            document.getElementById('storeSearchInput').value = '';
            document.getElementById('storeSuggestions').style.display = 'none';
            
            // Otomatik arama yap
            searchStoreProfile();
        }
        
        function updateSelectedStoresTags() {
            const container = document.getElementById('selectedStoresContainer');
            const tagsContainer = document.getElementById('selectedStoresTags');
            
            if (selectedStores.length === 0) {
                container.style.display = 'none';
                return;
            }
            
            container.style.display = 'block';
            tagsContainer.innerHTML = selectedStores.map((store, index) => `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 0.9em;">
                    <span>üè™ ${store}</span>
                    <button onclick="removeStore(${index})" 
                            style="background: rgba(255,255,255,0.3); border: none; color: white; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8em;">
                        √ó
                    </button>
                </div>
            `).join('');
        }
        
        function removeStore(index) {
            selectedStores.splice(index, 1);
            updateSelectedStoresTags();
            
            // Eƒüer maƒüaza kalmadƒ±ysa sonu√ßlarƒ± temizle
            if (selectedStores.length === 0) {
                document.getElementById('storeProfileContainer').style.display = 'none';
            } else {
                // Kalan maƒüazalarla yeniden arama yap
                searchStoreProfile();
            }
        }
        
        function handleStoreKeydown(event) {
            const suggestionsDiv = document.getElementById('storeSuggestions');
            const items = suggestionsDiv.querySelectorAll('.suggestion-item');
            
            if (items.length === 0) return;
            
            if (event.key === 'ArrowDown') {
                event.preventDefault();
                storeSuggestionIndex = Math.min(storeSuggestionIndex + 1, items.length - 1);
                highlightStoreSuggestion(items);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                storeSuggestionIndex = Math.max(storeSuggestionIndex - 1, 0);
                highlightStoreSuggestion(items);
            } else if (event.key === 'Enter') {
                event.preventDefault();
                if (storeSuggestionIndex >= 0 && items[storeSuggestionIndex]) {
                    const name = items[storeSuggestionIndex].getAttribute('data-name');
                    selectStoreSuggestion(name);
                } else {
                    searchStoreProfile();
                }
            } else if (event.key === 'Escape') {
                suggestionsDiv.style.display = 'none';
            }
        }
        
        function highlightStoreSuggestion(items) {
            items.forEach((item, idx) => {
                if (idx === storeSuggestionIndex) {
                    item.style.background = '#f0f0ff';
                    item.scrollIntoView({block: 'nearest'});
                } else {
                    item.style.background = 'white';
                }
            });
        }
        
        // Dƒ±≈üarƒ± tƒ±klandƒ±ƒüƒ±nda suggestion'larƒ± kapat
        document.addEventListener('click', function(event) {
            if (!event.target.closest('#customerSearchInput') && !event.target.closest('#customerSuggestions')) {
                document.getElementById('customerSuggestions').style.display = 'none';
            }
            if (!event.target.closest('#salespersonSearchInput') && !event.target.closest('#salespersonSuggestions')) {
                document.getElementById('salespersonSuggestions').style.display = 'none';
            }
            if (!event.target.closest('#storeSearchInput') && !event.target.closest('#storeSuggestions')) {
                document.getElementById('storeSuggestions').style.display = 'none';
            }
        });
        
        function searchCustomerProfile() {
            // Se√ßili m√º≈üteriler varsa onlarƒ± kullan, yoksa input'tan al
            let customersToSearch = [];
            
            if (selectedCustomers.length > 0) {
                customersToSearch = selectedCustomers;
            } else {
                const searchQuery = document.getElementById('customerSearchInput').value.trim();
            if (!searchQuery) {
                    alert('L√ºtfen bir m√º≈üteri adƒ± girin veya listeden se√ßin');
                return;
            }
            
                // Virg√ºl ile ayrƒ±lmƒ±≈ü isimleri ayƒ±r (trim et ama case koru)
                const searchTerms = searchQuery.split(',').map(s => s.trim()).filter(s => s);
                
                if (searchTerms.length === 0) {
                    alert('L√ºtfen ge√ßerli bir m√º≈üteri adƒ± girin');
                    return;
                }
                
                // Her arama terimini ger√ßek isimlerle e≈üle≈ütir
                const customerMap = {};
                allData.forEach(item => {
                    const name = item.partner || '';
                    if (name && !customerMap[name]) {
                        customerMap[name] = name;
                    }
                });
                
                // Her arama terimi i√ßin en uygun e≈üle≈ümeyi bul
                customersToSearch = [];
                searchTerms.forEach(term => {
                    const termLower = term.toLowerCase(); // Lowercase sadece arama i√ßin
                    const matches = Object.keys(customerMap).filter(name => 
                        name.toLowerCase().includes(termLower)
                    );
                    
                    if (matches.length > 0) {
                        // ƒ∞lk e≈üle≈ümeyi al (tam e≈üle≈üme varsa onu, yoksa kƒ±smi e≈üle≈ümeyi)
                        const exactMatch = matches.find(m => m.toLowerCase() === termLower);
                        customersToSearch.push(exactMatch || matches[0]);
                    }
                });
                
                if (customersToSearch.length === 0) {
                    alert('‚ùå Girilen isimlere uygun m√º≈üteri bulunamadƒ±!');
                    return;
                }
                
                // Tekrar edenleri kaldƒ±r
                customersToSearch = [...new Set(customersToSearch)];
                
                // En fazla 3 m√º≈üteri
                if (customersToSearch.length > 3) {
                    alert('‚ö†Ô∏è En fazla 3 m√º≈üteri arayabilirsiniz!');
                    customersToSearch = customersToSearch.slice(0, 3);
                }
            }
            
            console.log('üîç M√º≈üteriler aranƒ±yor:', customersToSearch);
            
            // TEK VEYA √áOKLU M√ú≈ûTERƒ∞ MODU
            if (customersToSearch.length === 1) {
                // TEK M√ú≈ûTERƒ∞ - Mevcut g√∂r√ºn√ºm
                const searchQuery = customersToSearch[0]; // Orijinal ismi kullan (b√ºy√ºk/k√º√ß√ºk harf korunmu≈ü)
            const customerData = allData.filter(item => 
                    item.partner && item.partner.toLowerCase() === searchQuery.toLowerCase()
            );
            
            if (customerData.length === 0) {
                document.getElementById('customerProfileContainer').style.display = 'none';
                document.getElementById('customerSearchNoResults').style.display = 'block';
                return;
            }
            
            // Sonu√ßlarƒ± g√∂ster
            document.getElementById('customerSearchNoResults').style.display = 'none';
            document.getElementById('customerProfileContainer').style.display = 'block';
            
            // M√º≈üteri bilgilerini hesapla
            const customerName = customerData[0].partner;
            const customerCity = customerData[0].city || 'Bilinmiyor';
            const customerTags = customerData[0].tags || '-';
            
            const totalSales = customerData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = customerData.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const uniqueDates = new Set(customerData.map(item => item.date));
            const transactionCount = uniqueDates.size;
            const avgBasket = totalSales / Math.max(transactionCount, 1);
            
            // Tarih bilgileri
            const dates = customerData.map(item => new Date(item.date)).sort((a, b) => a - b);
            const firstPurchase = dates[0].toLocaleDateString('tr-TR');
            const lastPurchase = dates[dates.length - 1].toLocaleDateString('tr-TR');
            
            // UI g√ºncelle
            document.getElementById('customerName').textContent = customerName;
            document.getElementById('customerCity').textContent = customerCity;
            document.getElementById('customerTags').textContent = customerTags;
            document.getElementById('customerTotalSales').textContent = '$' + totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('customerTotalQty').textContent = totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('customerTransactionCount').textContent = transactionCount;
            document.getElementById('customerAvgBasket').textContent = '$' + avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('customerFirstPurchase').textContent = firstPurchase;
            document.getElementById('customerLastPurchase').textContent = lastPurchase;
            
            // Grafikleri render et
            renderCustomerBrandChart(customerData);
            renderCustomerCategoryChart(customerData);
            renderCustomerStoreChart(customerData);
            renderCustomerMonthlyTrendChart(customerData);
            
            // Satƒ±n alma ge√ßmi≈üi tablosu
            renderCustomerPurchaseHistory(customerData);
            
            // AI analiz
            performCustomerAIAnalysis(customerData, {
                name: customerName,
                city: customerCity,
                tags: customerTags,
                totalSales,
                totalQty,
                transactionCount,
                avgBasket,
                firstPurchase,
                lastPurchase
            });
            } else {
                // √áOKLU M√ú≈ûTERƒ∞ - Kar≈üƒ±la≈ütƒ±rma modu
                alert('üöß √áoklu m√º≈üteri kar≈üƒ±la≈ütƒ±rma √∂zelliƒüi yakƒ±nda eklenecek!');
                // TODO: Kar≈üƒ±la≈ütƒ±rma g√∂r√ºn√ºm√º eklenecek
            }
        }
        
        function renderCustomerBrandChart(data) {
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = {sales: 0, qty: 0};
                brandData[brand].sales += parseFloat(item.usd_amount || 0);
                brandData[brand].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(brandData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1].sales);
            
            const ctx = document.getElementById('customerBrandChart');
            if (!ctx) return;
            
            if (customerBrandChartInstance) {
                customerBrandChartInstance.destroy();
            }
            
            customerBrandChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD - KDV Hari√ß)',
                        data: values,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCustomerCategoryChart(data) {
            const categoryData = {};
            data.forEach(item => {
                const category = item.category_2 || item.category_1 || 'Bilinmiyor';
                if (!categoryData[category]) categoryData[category] = {sales: 0, qty: 0};
                categoryData[category].sales += parseFloat(item.usd_amount || 0);
                categoryData[category].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(categoryData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1].sales);
            
            const ctx = document.getElementById('customerCategoryChart');
            if (!ctx) return;
            
            if (customerCategoryChartInstance) {
                customerCategoryChartInstance.destroy();
            }
            
            customerCategoryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD - KDV Hari√ß)',
                        data: values,
                        backgroundColor: 'rgba(56, 239, 125, 0.6)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCustomerStoreChart(data) {
            const storeData = {};
            data.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) storeData[store] = {sales: 0, qty: 0};
                storeData[store].sales += parseFloat(item.usd_amount || 0);
                storeData[store].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(storeData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1].sales);
            
            const ctx = document.getElementById('customerStoreChart');
            if (!ctx) return;
            
            if (customerStoreChartInstance) {
                customerStoreChartInstance.destroy();
            }
            
            customerStoreChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD - KDV Hari√ß)',
                        data: values,
                        backgroundColor: 'rgba(245, 87, 108, 0.6)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        x: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCustomerMonthlyTrendChart(data) {
            const monthlyData = {};
            data.forEach(item => {
                const date = new Date(item.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[monthKey]) monthlyData[monthKey] = 0;
                monthlyData[monthKey] += parseFloat(item.usd_amount || 0);
            });
            
            const sorted = Object.entries(monthlyData).sort((a, b) => a[0].localeCompare(b[0]));
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1]);
            
            const ctx = document.getElementById('customerMonthlyTrendChart');
            if (!ctx) return;
            
            if (customerMonthlyTrendChartInstance) {
                customerMonthlyTrendChartInstance.destroy();
            }
            
            customerMonthlyTrendChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Aylƒ±k Satƒ±≈ü (USD)',
                        data: values,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderCustomerPurchaseHistory(data) {
            // Son 50 i≈ülemi g√∂ster
            const sorted = [...data].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 50);
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left;">Tarih</th>
                            <th style="padding: 15px; text-align: left;">√úr√ºn</th>
                            <th style="padding: 15px; text-align: left;">Marka</th>
                            <th style="padding: 15px; text-align: right;">Adet</th>
                            <th style="padding: 15px; text-align: right;">Tutar</th>
                            <th style="padding: 15px; text-align: left;">Maƒüaza</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sorted.forEach((item, index) => {
                html += `
                    <tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                        <td style="padding: 12px;">${item.date}</td>
                        <td style="padding: 12px;"><strong>${item.product}</strong></td>
                        <td style="padding: 12px;">${item.brand}</td>
                        <td style="padding: 12px; text-align: right;">${parseFloat(item.quantity || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right; color: #38ef7d; font-weight: bold;">$${parseFloat(item.usd_amount || 0).toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px;">${item.store}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('customerPurchaseHistory').innerHTML = html;
        }
        
        function performCustomerAIAnalysis(data, profile) {
            console.log('ü§ñ M√º≈üteri AI analizi ba≈ülatƒ±lƒ±yor...');
            
            const insights = {
                positive: [],
                negative: [],
                neutral: [],
                recommendations: []
            };
            
            // VIP m√º≈üteri mi?
            if (profile.totalSales > 40000) {
                insights.positive.push({
                    title: 'üëë VIP M√º≈üteri',
                    description: `Toplam ${profile.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} USD alƒ±≈üveri≈ü yapmƒ±≈ü. Bu m√º≈üteriye √∂zel ilgi g√∂sterilmeli.`
                });
            }
            
            // Sadƒ±k m√º≈üteri mi?
            const firstDate = new Date(profile.firstPurchase.split('.').reverse().join('-'));
            const lastDate = new Date(profile.lastPurchase.split('.').reverse().join('-'));
            const daysDiff = Math.floor((lastDate - firstDate) / (1000 * 60 * 60 * 24));
            
            if (daysDiff > 365) {
                insights.positive.push({
                    title: 'üíé Sadƒ±k M√º≈üteri',
                    description: `${Math.floor(daysDiff / 365)} yƒ±ldan fazla s√ºredir m√º≈üteri. Uzun vadeli ili≈üki kurulmu≈ü.`
                });
            }
            
            // Y√ºksek sepet ortalamasƒ±
            if (profile.avgBasket > 3000) {
                insights.positive.push({
                    title: 'üí∞ Y√ºksek Sepet Deƒüeri',
                    description: `Ortalama sepet deƒüeri $${profile.avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2})}. Premium √ºr√ºnleri tercih ediyor.`
                });
            }
            
            // Marka sadakati
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += parseFloat(item.usd_amount || 0);
            });
            const topBrand = Object.entries(brandData).sort((a, b) => b[1] - a[1])[0];
            const brandShare = (topBrand[1] / profile.totalSales * 100).toFixed(1);
            
            if (brandShare > 50) {
                insights.neutral.push({
                    title: `üè∑Ô∏è ${topBrand[0]} Markasƒ±na Sadƒ±k`,
                    description: `Alƒ±≈üveri≈ülerin %${brandShare}'i ${topBrand[0]} markasƒ±ndan. Bu markadaki yeni √ºr√ºnleri √∂nerebilirsiniz.`
                });
            }
            
            // √ñneriler
            insights.recommendations.push({
                icon: 'üéÅ',
                title: 'Ki≈üiselle≈ütirilmi≈ü Kampanya',
                description: `${topBrand[0]} markasƒ±ndaki yeni √ºr√ºnler i√ßin √∂zel indirim sunun.`
            });
            
            insights.recommendations.push({
                icon: 'üìß',
                title: 'E-posta Bildirimi',
                description: `Tercih ettiƒüi kategorilerdeki (${data[0].category_1}) yeni √ºr√ºnler i√ßin e-posta g√∂nderin.`
            });
            
            if (profile.avgBasket > 3000) {
                insights.recommendations.push({
                    icon: '‚≠ê',
                    title: 'VIP Program',
                    description: `Y√ºksek sepet deƒüeri nedeniyle VIP m√º≈üteri programƒ±na davet edin.`
                });
            }
            
            // HTML olu≈ütur
            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">
                    ${insights.positive.length > 0 ? `
                    <div class="analysis-section">
                        <h3 style="color: white; margin-top: 0;">‚úÖ M√º≈üteri Profili</h3>
                        ${insights.positive.map(item => `
                            <div class="insight-item insight-positive" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">‚úÖ</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.neutral.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">üí° Satƒ±n Alma Davranƒ±≈üƒ±</h3>
                        ${insights.neutral.map(item => `
                            <div class="insight-item insight-neutral" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">üí°</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">üéØ Ki≈üiselle≈ütirilmi≈ü √ñneriler</h3>
                        ${insights.recommendations.map(item => `
                            <div class="recommendation" style="background: rgba(255, 255, 255, 0.15); padding: 18px; border-radius: 10px; margin: 12px 0;">
                                <span class="recommendation-icon" style="font-size: 1.8em; margin-right: 12px;">${item.icon}</span>
                                <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px);">
                                    <strong style="font-size: 1.15em; display: block; margin-bottom: 8px;">${item.title}</strong>
                                    <p style="margin: 0; opacity: 0.95; line-height: 1.6;">${item.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('customerAIAnalysisContent').innerHTML = html;
        }
        
        // ==================== STORE ANALYSIS TAB ====================
        let storeBrandChartInstance = null;
        let storeCategoryChartInstance = null;
        let storeDistrictChartInstance = null;
        let storeSalespersonChartInstance = null;
        let storeMonthlyChartInstance = null;
        let lastStoreTopProductsData = null;
        
        function populateStoreYearFilter() {
            if (!allData || allData.length === 0) return;
            
            const years = new Set();
            const months = new Set();
            const days = new Set();
            const categories = new Set();
            
            allData.forEach(item => {
                if (item.date) {
                    const dateParts = item.date.split('-');
                    if (dateParts.length >= 3) {
                        years.add(dateParts[0]); // YYYY
                        months.add(dateParts[1]); // MM
                        days.add(dateParts[2]); // DD
                    }
                }
                // Sadece category_2 (Kategori 2) bilgilerini al
                if (item.category_2 && item.category_2.trim() && item.category_2.toLowerCase() !== 'all') {
                    categories.add(item.category_2);
                }
            });
            
            populateMultiSelect('filterStoreYear', Array.from(years).sort().reverse(), 'countStoreYear');
            populateMultiSelect('filterStoreMonth', Array.from(months).sort(), 'countStoreMonth');
            populateMultiSelect('filterStoreDay', Array.from(days).sort(), 'countStoreDay');
            populateMultiSelect('filterStoreCategory', Array.from(categories).sort(), 'countStoreCategory');
        }
        
        function clearStoreFilters() {
            // Checkbox'larƒ± temizle
            const yearCheckboxes = document.querySelectorAll('#filterStoreYear input[type="checkbox"]');
            const monthCheckboxes = document.querySelectorAll('#filterStoreMonth input[type="checkbox"]');
            const dayCheckboxes = document.querySelectorAll('#filterStoreDay input[type="checkbox"]');
            const categoryCheckboxes = document.querySelectorAll('#filterStoreCategory input[type="checkbox"]');
            
            yearCheckboxes.forEach(cb => cb.checked = false);
            monthCheckboxes.forEach(cb => cb.checked = false);
            dayCheckboxes.forEach(cb => cb.checked = false);
            categoryCheckboxes.forEach(cb => cb.checked = false);
            
            // Saya√ßlarƒ± g√ºncelle
            updateSelectionCount('filterStoreYear', 'countStoreYear');
            updateSelectionCount('filterStoreMonth', 'countStoreMonth');
            updateSelectionCount('filterStoreDay', 'countStoreDay');
            updateSelectionCount('filterStoreCategory', 'countStoreCategory');
            
            console.log('‚úÖ Maƒüaza filtreleri temizlendi');
        }
        
        // √áOKLU SATI≈û TEMSƒ∞LCƒ∞Sƒ∞ AI ANALƒ∞Zƒ∞
        function performMultipleSalespersonsAIAnalysis(salespersonsData) {
            console.log('ü§ñ √áoklu satƒ±≈ü temsilcisi kar≈üƒ±la≈ütƒ±rmalƒ± AI analizi ba≈ülatƒ±lƒ±yor...');
            
            const insights = {positive: [], negative: [], neutral: [], recommendations: []};
            
            // Temsilci isimlerini al
            const names = salespersonsData.map(sp => sp.name).join(', ');
            
            insights.neutral.push(`üîç ${salespersonsData.length} satƒ±≈ü temsilcisi kar≈üƒ±la≈ütƒ±rƒ±lƒ±yor: ${names}`);
            
            // Satƒ±≈ü performansƒ± kar≈üƒ±la≈ütƒ±rmasƒ±
            const sortedBySales = [...salespersonsData].sort((a, b) => b.totalSales - a.totalSales);
            insights.positive.push(`üèÜ En y√ºksek satƒ±≈ü: <strong>${sortedBySales[0].name}</strong> - $${sortedBySales[0].totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`);
            
            if (sortedBySales.length > 1) {
                const gap = sortedBySales[0].totalSales - sortedBySales[1].totalSales;
                const gapPercent = (gap / sortedBySales[1].totalSales * 100).toFixed(1);
                insights.neutral.push(`üìä 1. ve 2. arasƒ±ndaki fark: $${gap.toLocaleString('tr-TR', {minimumFractionDigits: 2})} (%${gapPercent})`);
            }
            
            if (sortedBySales.length > 2) {
                insights.negative.push(`‚ö†Ô∏è En d√º≈ü√ºk satƒ±≈ü: <strong>${sortedBySales[sortedBySales.length - 1].name}</strong> - $${sortedBySales[sortedBySales.length - 1].totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`);
            }
            
            // Miktar performansƒ±
            const sortedByQty = [...salespersonsData].sort((a, b) => b.totalQty - a.totalQty);
            insights.positive.push(`üì¶ En y√ºksek adet: <strong>${sortedByQty[0].name}</strong> - ${sortedByQty[0].totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2})} adet`);
            
            // Ortalama i≈ülem tutarƒ± kar≈üƒ±la≈ütƒ±rmasƒ±
            salespersonsData.forEach(sp => {
                const avgPerCustomer = sp.totalSales / Math.max(sp.uniqueCustomers, 1);
                if (avgPerCustomer > 5000) {
                    insights.positive.push(`üí∞ <strong>${sp.name}</strong> m√º≈üteri ba≈üƒ±na y√ºksek ortalama: $${avgPerCustomer.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`);
                } else if (avgPerCustomer < 1000) {
                    insights.negative.push(`üìâ <strong>${sp.name}</strong> m√º≈üteri ba≈üƒ±na d√º≈ü√ºk ortalama: $${avgPerCustomer.toLocaleString('tr-TR', {minimumFractionDigits: 2})}`);
                }
            });
            
            // √ñneriler
            insights.recommendations.push(`üéØ <strong>${sortedBySales[0].name}</strong>'in stratejilerini diƒüer temsilcilerle payla≈üƒ±n`);
            
            if (sortedBySales.length > 1) {
                const lowPerformers = sortedBySales.slice(Math.ceil(sortedBySales.length / 2));
                if (lowPerformers.length > 0) {
                    insights.recommendations.push(`üìö ${lowPerformers.map(sp => sp.name).join(', ')} i√ßin ek eƒüitim ve mentorluk programƒ± d√º≈ü√ºn√ºn`);
                }
            }
            
            insights.recommendations.push(`ü§ù T√ºm temsilciler i√ßin ortak hedefler belirleyin ve takƒ±m √ßalƒ±≈ümasƒ±nƒ± te≈üvik edin`);
            insights.recommendations.push(`üìä Aylƒ±k performans toplantƒ±larƒ± d√ºzenleyerek en iyi uygulamalarƒ± payla≈üƒ±n`);
            
            // HTML olu≈ütur
            let html = '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; color: white; margin-bottom: 30px;">';
            html += '<h3 style="margin: 0 0 20px 0; font-size: 1.8em;">ü§ñ Kar≈üƒ±la≈ütƒ±rmalƒ± AI Performans Analizi</h3>';
            
            if (insights.positive.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #4ade80; margin-bottom: 10px;">‚úÖ G√º√ßl√º Y√∂nler:</h4><ul style="margin: 0; padding-left: 20px;">';
                insights.positive.forEach(item => html += `<li style="margin-bottom: 8px;">${item}</li>`);
                html += '</ul></div>';
            }
            
            if (insights.negative.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #fbbf24; margin-bottom: 10px;">‚ö†Ô∏è Geli≈üim Alanlarƒ±:</h4><ul style="margin: 0; padding-left: 20px;">';
                insights.negative.forEach(item => html += `<li style="margin-bottom: 8px;">${item}</li>`);
                html += '</ul></div>';
            }
            
            if (insights.neutral.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #e0e7ff; margin-bottom: 10px;">üìä Genel Durum:</h4><ul style="margin: 0; padding-left: 20px;">';
                insights.neutral.forEach(item => html += `<li style="margin-bottom: 8px;">${item}</li>`);
                html += '</ul></div>';
            }
            
            if (insights.recommendations.length > 0) {
                html += '<div><h4 style="color: #a78bfa; margin-bottom: 10px;">üí° √ñneriler:</h4><ul style="margin: 0; padding-left: 20px;">';
                insights.recommendations.forEach(item => html += `<li style="margin-bottom: 8px;">${item}</li>`);
                html += '</ul></div>';
            }
            
            html += '</div>';
            
            // AI analiz i√ßeriƒüini doƒürudan salespersonAIAnalysisContent div'ine yaz
            const aiContent = document.getElementById('salespersonAIAnalysisContent');
            if (aiContent) {
                aiContent.innerHTML = html;
            }
        }
        
        function searchStoreProfile() {
            // Se√ßili maƒüazalar varsa onlarƒ± kullan, yoksa input'tan al
            let storesToSearch = [];
            
            if (selectedStores.length > 0) {
                storesToSearch = selectedStores;
            } else {
                const searchQuery = document.getElementById('storeSearchInput').value.trim();
            if (!searchQuery) {
                    alert('L√ºtfen bir maƒüaza adƒ± girin veya listeden se√ßin');
                return;
            }
            
                // Virg√ºl ile ayrƒ±lmƒ±≈ü isimleri ayƒ±r (case-insensitive arama i√ßin)
                const searchTerms = searchQuery.split(',').map(s => s.trim().toLowerCase()).filter(s => s);
                
                if (searchTerms.length === 0) {
                    alert('L√ºtfen ge√ßerli bir maƒüaza adƒ± girin');
                    return;
                }
                
                // Her arama terimini ger√ßek isimlerle e≈üle≈ütir
                const storeMap = {};
                allData.forEach(item => {
                    const name = item.store || '';
                    if (name && !storeMap[name]) {
                        storeMap[name] = name;
                    }
                });
                
                // Her arama terimi i√ßin en uygun e≈üle≈ümeyi bul
                storesToSearch = [];
                searchTerms.forEach(term => {
                    const matches = Object.keys(storeMap).filter(name => 
                        name.toLowerCase().includes(term)
                    );
                    
                    if (matches.length > 0) {
                        // ƒ∞lk e≈üle≈ümeyi al (tam e≈üle≈üme varsa onu, yoksa kƒ±smi e≈üle≈ümeyi)
                        const exactMatch = matches.find(m => m.toLowerCase() === term);
                        storesToSearch.push(exactMatch || matches[0]);
                    }
                });
                
                if (storesToSearch.length === 0) {
                    alert('‚ùå Girilen isimlere uygun maƒüaza bulunamadƒ±!');
                    return;
                }
                
                // Tekrar edenleri kaldƒ±r
                storesToSearch = [...new Set(storesToSearch)];
                
                // En fazla 3 maƒüaza
                if (storesToSearch.length > 3) {
                    alert('‚ö†Ô∏è En fazla 3 maƒüaza arayabilirsiniz!');
                    storesToSearch = storesToSearch.slice(0, 3);
                }
            }
            
            console.log('üîç Maƒüazalar aranƒ±yor:', storesToSearch);
            
            // Filtre deƒüerlerini al
            const yearFilter = Array.from(document.querySelectorAll('#filterStoreYear input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            const monthFilter = Array.from(document.querySelectorAll('#filterStoreMonth input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            const dayFilter = Array.from(document.querySelectorAll('#filterStoreDay input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            const categoryFilter = Array.from(document.querySelectorAll('#filterStoreCategory input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            // TEK VEYA √áOKLU MAƒûAZA MODU
            if (storesToSearch.length === 1) {
                // TEK MAƒûAZA - Mevcut g√∂r√ºn√ºm
                renderSingleStoreView(storesToSearch[0], yearFilter, monthFilter, dayFilter, categoryFilter);
            } else {
                // √áOKLU MAƒûAZA - Kar≈üƒ±la≈ütƒ±rma g√∂r√ºn√ºm√º
                renderMultipleStoresView(storesToSearch, yearFilter, monthFilter, dayFilter, categoryFilter);
            }
        }
        
        function renderSingleStoreView(storeName, yearFilter, monthFilter, dayFilter, categoryFilter = []) {
            // Maƒüaza verilerini filtrele
            const storeData = allData.filter(item => {
                // Maƒüaza adƒ± kontrol√º (case-insensitive exact match)
                if (!item.store || item.store.toLowerCase() !== storeName.toLowerCase()) {
                    return false;
                }
                
                // Analitik/Eƒüitim filtresi
                const store = (item.store || '').toLowerCase();
                if (store.includes('analitik') || store.includes('eƒüitim')) {
                    return false;
                }
                
                // Tarih kontrol√º
                if (!item.date) return false;
                
                // Yƒ±l filtresi
                if (yearFilter.length > 0) {
                    const itemYear = item.date.substring(0, 4);
                    if (!yearFilter.includes(itemYear)) return false;
                }
                
                // Ay filtresi
                if (monthFilter.length > 0) {
                    const itemMonth = item.date.substring(5, 7);
                    if (!monthFilter.includes(itemMonth)) return false;
                }
                
                // G√ºn filtresi
                if (dayFilter.length > 0) {
                    const itemDay = item.date.substring(8, 10);
                    if (!dayFilter.includes(itemDay)) return false;
                }
                
                // Kategori filtresi (category_2)
                if (categoryFilter.length > 0) {
                    if (!item.category_2 || !categoryFilter.includes(item.category_2)) return false;
                }
                
                return true;
            });
            
            if (storeData.length === 0) {
                document.getElementById('storeProfileContainer').style.display = 'none';
                document.getElementById('storeSearchNoResults').style.display = 'block';
                return;
            }
            
            // Sonu√ßlarƒ± g√∂ster
            document.getElementById('storeSearchNoResults').style.display = 'none';
            document.getElementById('storeProfileContainer').style.display = 'block';
            document.getElementById('singleStoreView').style.display = 'block';
            document.getElementById('multipleStoresView').style.display = 'none';
            
            // Tek maƒüaza b√∂l√ºmlerini g√∂ster
            document.getElementById('storeBrandCategorySection').style.display = 'grid';
            document.getElementById('storeTopProductsSection').style.display = 'block';
            document.getElementById('storeFullSalespersonSection').style.display = 'block';
            
            // Maƒüaza bilgilerini hesapla
            const actualStoreName = storeData[0].store;
            const totalSales = storeData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = storeData.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const transactionCount = new Set(storeData.map(item => item.date)).size; // Satƒ±≈ü yapƒ±lan g√ºn sayƒ±sƒ±
            const invoiceCount = new Set(storeData.map(item => item.move_name)).size; // Fatura sayƒ±sƒ±
            const avgTransaction = totalSales / Math.max(transactionCount, 1); // G√ºnl√ºk ortalama
            const avgBasket = totalSales / Math.max(invoiceCount, 1); // Sepet ortalamasƒ± (fatura ba≈üƒ±na)
            const uniqueCustomers = new Set(storeData.map(item => item.partner)).size;
            const uniqueProducts = new Set(storeData.map(item => item.product)).size;
            
            // Grafik ba≈ülƒ±klarƒ±nƒ± g√ºncelle
            document.getElementById('storeBrandChartTitle').textContent = `üè∑Ô∏è ${actualStoreName} - En √áok Satan Markalar (Top 10)`;
            document.getElementById('storeCategoryChartTitle').textContent = `üìÇ ${actualStoreName} - En √áok Satan Kategoriler`;
            document.getElementById('storeSalespersonChartTitle').textContent = `üë®‚Äçüíº ${actualStoreName} - Satƒ±≈ü Temsilcileri`;
            document.getElementById('storeMonthlyChartTitle').textContent = `üìà ${actualStoreName} - Aylƒ±k Performans Trendi`;
            
            // UI g√ºncelle
            document.getElementById('storeName').textContent = actualStoreName;
            document.getElementById('storeTotalSales').textContent = '$' + totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('storeTotalQty').textContent = totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('storeInvoiceCount').textContent = invoiceCount;
            document.getElementById('storeAvgTransaction').textContent = '$' + avgTransaction.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('storeAvgBasket').textContent = '$' + avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('storeUniqueCustomers').textContent = uniqueCustomers;
            document.getElementById('storeUniqueProducts').textContent = uniqueProducts;
            
            // Grafikleri render et
            renderStoreBrandChart(storeData);
            renderStoreCategoryChart(storeData);
            renderStoreDistrictChart(storeData);
            renderStoreSalespersonChart(storeData);
            renderStoreMonthlyChart(storeData);
            renderStoreTopProducts(storeData);
            renderStoreFullSalespersonTable(storeData);
            
            // Toplam satƒ±≈ü hesapla (t√ºm maƒüazalar i√ßin)
            const totalAllSales = allData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const storeSalesPercentage = ((totalSales / totalAllSales) * 100).toFixed(1);
            
            // AI analiz
            performStoreAIAnalysis(storeData, {
                name: actualStoreName,
                totalSales,
                totalQty,
                transactionCount,
                avgTransaction,
                uniqueCustomers,
                uniqueProducts,
                totalAllSales,
                storeSalesPercentage
            });
        }
        
        function renderMultipleStoresView(stores, yearFilter, monthFilter, dayFilter, categoryFilter = []) {
            // Her maƒüaza i√ßin veri topla
            const storesData = stores.map(storeName => {
                const data = allData.filter(item => {
                    // Maƒüaza adƒ± kontrol√º
                    if (!item.store || item.store.toLowerCase() !== storeName.toLowerCase()) {
                        return false;
                    }
                    
                    // Analitik/Eƒüitim filtresi
                    const store = (item.store || '').toLowerCase();
                    if (store.includes('analitik') || store.includes('eƒüitim')) {
                        return false;
                    }
                    
                    // Tarih kontrol√º
                    if (!item.date) return false;
                    
                    // Yƒ±l filtresi
                    if (yearFilter.length > 0) {
                        const itemYear = item.date.substring(0, 4);
                        if (!yearFilter.includes(itemYear)) return false;
                    }
                    
                    // Ay filtresi
                    if (monthFilter.length > 0) {
                        const itemMonth = item.date.substring(5, 7);
                        if (!monthFilter.includes(itemMonth)) return false;
                    }
                    
                    // G√ºn filtresi
                    if (dayFilter.length > 0) {
                        const itemDay = item.date.substring(8, 10);
                        if (!dayFilter.includes(itemDay)) return false;
                    }
                    
                    // Kategori filtresi (category_2)
                    if (categoryFilter.length > 0) {
                        if (!item.category_2 || !categoryFilter.includes(item.category_2)) return false;
                    }
                    
                    return true;
                });
                
                const totalSales = data.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
                const totalQty = data.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
                const uniqueDates = new Set(data.map(item => item.date));
                const transactionCount = uniqueDates.size; // Satƒ±≈ü yapƒ±lan g√ºn sayƒ±sƒ±
                const invoiceCount = new Set(data.map(item => item.move_name)).size; // Fatura sayƒ±sƒ±
                const avgTransaction = totalSales / Math.max(transactionCount, 1); // G√ºnl√ºk ortalama
                const avgBasket = totalSales / Math.max(invoiceCount, 1); // Sepet ortalamasƒ±
                const uniqueCustomers = new Set(data.map(item => item.partner)).size;
                const uniqueProducts = new Set(data.map(item => item.product)).size;
                
                return {
                    name: storeName,
                    data: data,
                    invoiceCount: invoiceCount,
                    avgBasket: avgBasket,
                    totalSales,
                    totalQty,
                    transactionCount,
                    avgTransaction,
                    uniqueCustomers,
                    uniqueProducts
                };
            }).filter(st => st.data.length > 0);
            
            if (storesData.length === 0) {
                document.getElementById('storeProfileContainer').style.display = 'none';
                document.getElementById('storeSearchNoResults').style.display = 'block';
                return;
            }
            
            // Sonu√ßlarƒ± g√∂ster
            document.getElementById('storeSearchNoResults').style.display = 'none';
            document.getElementById('storeProfileContainer').style.display = 'block';
            document.getElementById('singleStoreView').style.display = 'none';
            document.getElementById('multipleStoresView').style.display = 'block';
            
            // Kar≈üƒ±la≈ütƒ±rma tablosu olu≈ütur
            renderStoreComparisonTable(storesData);
            
            // Kar≈üƒ±la≈ütƒ±rma grafikleri
            renderStoreComparisonCharts(storesData);
            
            // Kategori kar≈üƒ±la≈ütƒ±rma grafikleri ekle
            renderStoreComparisonCategoryCharts(storesData);
            
            // Tek maƒüaza b√∂l√ºmlerini gizle (√ßoklu kar≈üƒ±la≈ütƒ±rmada gereksiz)
            document.getElementById('storeBrandCategorySection').style.display = 'none';
            document.getElementById('storeTopProductsSection').style.display = 'none';
            document.getElementById('storeFullSalespersonSection').style.display = 'none';
            
            // AI Analiz panelini g√∂ster ve kar≈üƒ±la≈ütƒ±rmalƒ± analizi yap
            const aiPanel = document.getElementById('storeAIAnalysisPanel');
            if (aiPanel) {
                aiPanel.style.display = 'block';
            }
            
            // Kar≈üƒ±la≈ütƒ±rmalƒ± AI analizi
            performMultipleStoresAIAnalysis(storesData);
        }
        
        function renderStoreComparisonTable(storesData) {
            const container = document.getElementById('storeComparisonTableContainer');
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <th style="padding: 15px; text-align: left;">Metrik</th>
                            ${storesData.map(st => `<th style="padding: 15px; text-align: right;">üè™ ${st.name}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">üí∞ Toplam Satƒ±≈ü</td>
                            ${storesData.map(st => `<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">$${st.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>`).join('')}
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">üì¶ Toplam Adet</td>
                            ${storesData.map(st => `<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${st.totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>`).join('')}
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">üõí Fatura Sayƒ±sƒ±</td>
                            ${storesData.map(st => `<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${st.invoiceCount}</td>`).join('')}
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">üìä G√ºnl√ºk Ort. Satƒ±≈ü</td>
                            ${storesData.map(st => `<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">$${st.avgTransaction.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>`).join('')}
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">üõí Sepet Ortalamasƒ±</td>
                            ${storesData.map(st => `<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">$${st.avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>`).join('')}
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">üë• Farklƒ± M√º≈üteri</td>
                            ${storesData.map(st => `<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${st.uniqueCustomers}</td>`).join('')}
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">üéØ Farklƒ± √úr√ºn</td>
                            ${storesData.map(st => `<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${st.uniqueProducts}</td>`).join('')}
                        </tr>
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        function renderStoreComparisonCharts(storesData) {
            const names = storesData.map(st => st.name);
            const sales = storesData.map(st => st.totalSales);
            const quantities = storesData.map(st => st.totalQty);
            
            const colors = [
                'rgba(102, 126, 234, 0.7)',
                'rgba(240, 147, 251, 0.7)',
                'rgba(255, 159, 64, 0.7)'
            ];
            
            const borderColors = [
                'rgba(102, 126, 234, 1)',
                'rgba(240, 147, 251, 1)',
                'rgba(255, 159, 64, 1)'
            ];
            
            // Satƒ±≈ü kar≈üƒ±la≈ütƒ±rma grafiƒüi
            const salesCtx = document.getElementById('comparisonStoreSalesChart');
            if (comparisonStoreSalesChartInstance) {
                comparisonStoreSalesChartInstance.destroy();
            }
            
            comparisonStoreSalesChartInstance = new Chart(salesCtx, {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [{
                        label: 'Toplam Satƒ±≈ü ($)',
                        data: sales,
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
            
            // Adet kar≈üƒ±la≈ütƒ±rma grafiƒüi
            const qtyCtx = document.getElementById('comparisonStoreQtyChart');
            if (comparisonStoreQtyChartInstance) {
                comparisonStoreQtyChartInstance.destroy();
            }
            
            comparisonStoreQtyChartInstance = new Chart(qtyCtx, {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [{
                        label: 'Toplam Adet',
                        data: quantities,
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + ' adet';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        // Kategori Kar≈üƒ±la≈ütƒ±rma Tablosu
        function renderStoreCategoryComparisonTable(storesData) {
            const tableContainer = document.getElementById('storeCategoryComparisonTableContainer');
            if (!tableContainer) return;
            
            // Her maƒüaza i√ßin kategori verilerini topla
            const storesCategories = storesData.map(store => {
                const categoryData = {};
                
                store.data.forEach(item => {
                    // Eƒüer category_1 "All" ise category_2 kullan, deƒüilse category_1
                    let cat = (item.category_1 && item.category_1.toLowerCase() !== 'all') 
                        ? item.category_1 
                        : (item.category_2 || item.category_3 || 'Diƒüer');
                    
                    // Sadece Analitik/Eƒüitim atla, diƒüerlerini al
                    if (cat.toLowerCase().includes('analitik') || cat.toLowerCase().includes('eƒüitim')) {
                        return;
                    }
                    if (!categoryData[cat]) categoryData[cat] = 0;
                    categoryData[cat] += parseFloat(item.usd_amount || 0);
                });
                
                // En y√ºksek 10 kategoriyi al
                const sorted = Object.entries(categoryData)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                return {
                    name: store.name,
                    categories: sorted,
                    totalSales: sorted.reduce((sum, item) => sum + item[1], 0)
                };
            });
            
            // T√ºm benzersiz kategorileri topla (en az bir maƒüazada top 10'da olan)
            const allCategories = new Set();
            storesCategories.forEach(store => {
                store.categories.forEach(([cat, _]) => allCategories.add(cat));
            });
            
            // Tablo HTML'i olu≈ütur
            let html = `
                <table style="width: 100%; border-collapse: collapse; box-shadow: 0 2px 10px rgba(0,0,0,0.1); background: white; border-radius: 10px; overflow: hidden;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <th style="padding: 20px; text-align: left; font-size: 1.1em; position: sticky; left: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 10;">üìÇ Kategori</th>
            `;
            
            // Maƒüaza ba≈ülƒ±klarƒ±nƒ± ekle
            storesCategories.forEach(store => {
                html += `<th style="padding: 20px; text-align: center; font-size: 1.1em; min-width: 150px;">üè™ ${store.name}</th>`;
            });
            
            html += `</tr></thead><tbody>`;
            
            // Her kategori i√ßin satƒ±r olu≈ütur
            Array.from(allCategories).sort().forEach((category, idx) => {
                const rowBg = idx % 2 === 0 ? '#f8f9fa' : 'white';
                html += `<tr style="background: ${rowBg}; border-bottom: 1px solid #e9ecef;">`;
                html += `<td style="padding: 15px; font-weight: 600; position: sticky; left: 0; background: ${rowBg}; z-index: 5;">${category}</td>`;
                
                // Her maƒüaza i√ßin bu kategorinin deƒüerini g√∂ster
                storesCategories.forEach(store => {
                    const categoryItem = store.categories.find(([cat, _]) => cat === category);
                    if (categoryItem) {
                        const value = categoryItem[1];
                        const percentage = ((value / store.totalSales) * 100).toFixed(1);
                        html += `
                            <td style="padding: 15px; text-align: center;">
                                <div style="font-weight: bold; color: #667eea; font-size: 1.1em;">$${value.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                                <div style="color: #6c757d; font-size: 0.9em; margin-top: 5px;">${percentage}%</div>
                            </td>
                        `;
                    } else {
                        html += `<td style="padding: 15px; text-align: center; color: #adb5bd;">-</td>`;
                    }
                });
                
                html += `</tr>`;
            });
            
            // Toplam satƒ±r ekle
            html += `
                <tr style="background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); color: white; font-weight: bold;">
                    <td style="padding: 20px; font-size: 1.1em; position: sticky; left: 0; background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); z-index: 10;">üí∞ TOPLAM</td>
            `;
            
            storesCategories.forEach(store => {
                html += `<td style="padding: 20px; text-align: center; font-size: 1.2em;">$${store.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td>`;
            });
            
            html += `</tr></tbody></table>`;
            
            tableContainer.innerHTML = html;
        }
        
        function renderStoreComparisonCategoryCharts(storesData) {
            const container = document.getElementById('storeComparisonCategoryCharts');
            if (!container) {
                console.error('‚ùå storeComparisonCategoryCharts container bulunamadƒ±!');
                return;
            }
            
            console.log('üìä Kategori kar≈üƒ±la≈ütƒ±rmasƒ± ba≈ülatƒ±lƒ±yor...', storesData.length, 'maƒüaza');
            
            // √ñNCE TABLO OLU≈ûTUR
            renderStoreCategoryComparisonTable(storesData);
            
            // Her maƒüaza i√ßin metrik kartlarƒ± olu≈ütur (YORUM: Renkli kartlar gizli, sadece tablo kullanƒ±lƒ±yor)
            // Performans i√ßin renkli kartlar devre dƒ±≈üƒ± bƒ±rakƒ±ldƒ±
            return; // Renkli kartlarƒ± render etme
            
            let html = '';
            
            storesData.forEach((store, idx) => {
                // Kategori 1 verilerini topla
                const categoryData = {};
                console.log(`   üè™ ${store.name}: ${store.data.length} kayƒ±t`);
                
                // ƒ∞lk birka√ß kayƒ±tta category_1 var mƒ± kontrol et
                if (store.data.length > 0) {
                    const sample = store.data[0];
                    console.log(`      √ñrnek veri:`, {
                        category_1: sample.category_1,
                        category_2: sample.category_2,
                        product: sample.product
                    });
                }
                
                store.data.forEach(item => {
                    // Eƒüer category_1 "All" ise category_2 kullan, deƒüilse category_1
                    let cat = (item.category_1 && item.category_1.toLowerCase() !== 'all') 
                        ? item.category_1 
                        : (item.category_2 || item.category_3 || 'Diƒüer');
                    
                    // Sadece Analitik/Eƒüitim atla, diƒüerlerini al
                    if (cat.toLowerCase().includes('analitik') || cat.toLowerCase().includes('eƒüitim')) {
                        return;
                    }
                    if (!categoryData[cat]) categoryData[cat] = 0;
                    categoryData[cat] += parseFloat(item.usd_amount || 0);
                });
                
                console.log(`      Kategori sayƒ±sƒ±: ${Object.keys(categoryData).length}`);
                
                // En y√ºksek 10 kategoriyi al
                const sorted = Object.entries(categoryData)
                    .sort((a, b) => b[1] - a[1])
                    .slice(0, 10);
                
                if (sorted.length === 0) return;
                
                // Toplam satƒ±≈ü hesapla
                const totalSales = sorted.reduce((sum, item) => sum + item[1], 0);
                
                // Maƒüaza kartƒ± ba≈ülƒ±ƒüƒ±
                html += `
                    <div style="background: white; border-radius: 15px; padding: 25px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                        <h4 style="text-align: center; margin-bottom: 20px; color: #667eea; font-size: 1.3em;">üè™ ${store.name}</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                `;
                
                // Her kategori i√ßin metrik kartƒ±
                sorted.forEach((item, catIdx) => {
                    const categoryName = item[0];
                    const categoryValue = item[1];
                    const percentage = ((categoryValue / totalSales) * 100).toFixed(1);
                    
                    // Kategori ikonu belirleme
                    let icon = 'üìÇ';
                    if (categoryName.toLowerCase().includes('gitar')) icon = 'üé∏';
                    else if (categoryName.toLowerCase().includes('klavye') || categoryName.toLowerCase().includes('piyano')) icon = 'üéπ';
                    else if (categoryName.toLowerCase().includes('davul') || categoryName.toLowerCase().includes('bateri')) icon = 'ü•Å';
                    else if (categoryName.toLowerCase().includes('ses') || categoryName.toLowerCase().includes('mikrofon')) icon = 'üé§';
                    else if (categoryName.toLowerCase().includes('kulaklƒ±k') || categoryName.toLowerCase().includes('hoparl√∂r')) icon = 'üîä';
                    else if (categoryName.toLowerCase().includes('yazƒ±lƒ±m') || categoryName.toLowerCase().includes('software')) icon = 'üíø';
                    
                    // Gradient renk belirleme (sƒ±ralamaya g√∂re)
                    const gradients = [
                        'linear-gradient(135deg, #667eea 0%, #764ba2 100%)',
                        'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)',
                        'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)',
                        'linear-gradient(135deg, #43e97b 0%, #38f9d7 100%)',
                        'linear-gradient(135deg, #fa709a 0%, #fee140 100%)',
                        'linear-gradient(135deg, #30cfd0 0%, #330867 100%)',
                        'linear-gradient(135deg, #a8edea 0%, #fed6e3 100%)',
                        'linear-gradient(135deg, #ff9a9e 0%, #fecfef 100%)',
                        'linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%)',
                        'linear-gradient(135deg, #e0c3fc 0%, #8ec5fc 100%)'
                    ];
                    const gradient = gradients[catIdx % gradients.length];
                    
                    html += `
                        <div style="background: ${gradient}; color: white; padding: 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.15);">
                            <div style="font-size: 2em; margin-bottom: 10px; text-align: center;">${icon}</div>
                            <div style="font-size: 0.85em; opacity: 0.95; margin-bottom: 8px; text-align: center; font-weight: 600;">${categoryName}</div>
                            <div style="font-size: 1.4em; font-weight: bold; text-align: center; margin-bottom: 5px;">$${categoryValue.toLocaleString('tr-TR', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                            <div style="font-size: 0.9em; opacity: 0.9; text-align: center;">${percentage}%</div>
                        </div>
                    `;
                });
                
                html += `
                        </div>
                    </div>
                `;
            });
            
            container.innerHTML = html;
        }
        
        function performMultipleStoresAIAnalysis(storesData) {
            console.log('ü§ñ √áoklu maƒüaza kar≈üƒ±la≈ütƒ±rmalƒ± AI analizi ba≈ülatƒ±lƒ±yor...', storesData);

            const insights = {positive: [], negative: [], neutral: [], recommendations: [], categories: []};

            // Maƒüaza isimlerini al
            const names = storesData.map(st => st.name).join(', ');

            insights.neutral.push(`üîç <strong>${storesData.length} Maƒüaza Detaylƒ± Kar≈üƒ±la≈ütƒ±rma:</strong> ${names}`);

            // === SATI≈û PERFORMANSI ANALƒ∞Zƒ∞ ===
            const sortedBySales = [...storesData].sort((a, b) => b.totalSales - a.totalSales);
            const totalAllSales = sortedBySales.reduce((sum, st) => sum + st.totalSales, 0);
            const avgSales = totalAllSales / sortedBySales.length;
            
            insights.positive.push(`üèÜ <strong>Satƒ±≈ü Lideri:</strong> ${sortedBySales[0].name} - $${sortedBySales[0].totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} (Toplam satƒ±≈üƒ±n %${((sortedBySales[0].totalSales / totalAllSales) * 100).toFixed(1)}'i)`);

            if (sortedBySales.length > 1) {
                const gap = sortedBySales[0].totalSales - sortedBySales[1].totalSales;
                const gapPercent = (gap / sortedBySales[1].totalSales * 100).toFixed(1);
                insights.neutral.push(`üìä <strong>Lider Farkƒ±:</strong> 1. sƒ±radaki maƒüaza 2. sƒ±radan $${gap.toLocaleString('tr-TR', {minimumFractionDigits: 2})} (%${gapPercent}) daha fazla satƒ±≈ü yapƒ±yor`);
                
                // Ortalama altƒ± performans
                const belowAvg = sortedBySales.filter(st => st.totalSales < avgSales);
                if (belowAvg.length > 0) {
                    insights.negative.push(`‚ö†Ô∏è <strong>Ortalama Altƒ± Performans:</strong> ${belowAvg.map(st => st.name).join(', ')} ortalama satƒ±≈üƒ±n ($${avgSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}) altƒ±nda`);
                }
            }

            if (sortedBySales.length > 2) {
                const lastStore = sortedBySales[sortedBySales.length - 1];
                const gapToLeader = sortedBySales[0].totalSales - lastStore.totalSales;
                insights.negative.push(`üìâ <strong>En D√º≈ü√ºk Performans:</strong> ${lastStore.name} - $${lastStore.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} (Liderden %${((gapToLeader / sortedBySales[0].totalSales) * 100).toFixed(1)} daha az)`);
            }

            // === Mƒ∞KTAR & SEPETAnalizi ===
            const sortedByQty = [...storesData].sort((a, b) => b.totalQty - a.totalQty);
            const sortedByBasket = [...storesData].sort((a, b) => b.avgBasket - a.avgBasket);
            
            insights.positive.push(`üì¶ <strong>En Y√ºksek Adet Satƒ±≈üƒ±:</strong> ${sortedByQty[0].name} - ${sortedByQty[0].totalQty.toLocaleString('tr-TR')} adet`);
            insights.positive.push(`üõí <strong>En Y√ºksek Sepet Ortalamasƒ±:</strong> ${sortedByBasket[0].name} - $${sortedByBasket[0].avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2})}/fatura`);
            
            // D√º≈ü√ºk sepet ortalamasƒ± uyarƒ±sƒ±
            const lowBasket = storesData.filter(st => st.avgBasket < 100);
            if (lowBasket.length > 0) {
                insights.negative.push(`‚ö†Ô∏è <strong>D√º≈ü√ºk Sepet Ortalamasƒ±:</strong> ${lowBasket.map(st => `${st.name} ($${st.avgBasket.toFixed(2)})`).join(', ')} - Cross-selling fƒ±rsatƒ± var`);
            }

            // === KATEGORƒ∞ ANALƒ∞Zƒ∞ ===
            const categoryAnalysis = {};
            storesData.forEach(store => {
                store.data.forEach(item => {
                    let cat = (item.category_1 && item.category_1.toLowerCase() !== 'all') 
                        ? item.category_1 
                        : (item.category_2 || item.category_3 || 'Diƒüer');
                    
                    if (cat.toLowerCase().includes('analitik') || cat.toLowerCase().includes('eƒüitim')) return;
                    
                    if (!categoryAnalysis[cat]) {
                        categoryAnalysis[cat] = {};
                    }
                    if (!categoryAnalysis[cat][store.name]) {
                        categoryAnalysis[cat][store.name] = 0;
                    }
                    categoryAnalysis[cat][store.name] += parseFloat(item.usd_amount || 0);
                });
            });
            
            // Her kategori i√ßin lider maƒüazayƒ± bul
            Object.entries(categoryAnalysis).forEach(([category, stores]) => {
                const sortedStores = Object.entries(stores).sort((a, b) => b[1] - a[1]);
                if (sortedStores.length > 0 && sortedStores[0][1] > 1000) { // Sadece anlamlƒ± kategoriler
                    const leader = sortedStores[0];
                    const total = sortedStores.reduce((sum, [_, val]) => sum + val, 0);
                    const percentage = ((leader[1] / total) * 100).toFixed(1);
                    insights.categories.push(`üìÇ <strong>${category}:</strong> ${leader[0]} lider ($${leader[1].toLocaleString('tr-TR', {minimumFractionDigits: 2})}, %${percentage})`);
                }
            });

            // === √ñNERƒ∞LER ===
            insights.recommendations.push(`üéØ <strong>${sortedBySales[0].name}</strong> en iyi uygulamalarƒ±nƒ± (satƒ±≈ü teknikleri, √ºr√ºn yerle≈üimi, m√º≈üteri hizmetleri) diƒüer maƒüazalarla payla≈ümalƒ±`);
            
            // Sepet ortalamasƒ± d√º≈ü√ºk maƒüazalar i√ßin
            if (lowBasket.length > 0) {
                insights.recommendations.push(`üõí ${lowBasket.map(st => st.name).join(', ')} i√ßin <strong>cross-selling ve up-selling eƒüitimleri</strong> d√ºzenleyin - Sepet ortalamasƒ±nƒ± artƒ±rma potansiyeli y√ºksek`);
            }
            
            // Kategori bazlƒ± √∂neriler
            const topCategories = Object.entries(categoryAnalysis)
                .map(([cat, stores]) => [cat, Object.values(stores).reduce((a, b) => a + b, 0)])
                .sort((a, b) => b[1] - a[1])
                .slice(0, 3);
            
            if (topCategories.length > 0) {
                insights.recommendations.push(`üìä <strong>En √ßok satan 3 kategori:</strong> ${topCategories.map(([cat, _]) => cat).join(', ')} - Bu kategorilerde stok ve te≈ühir optimizasyonu yapƒ±n`);
            }

            if (sortedBySales.length > 1) {
                const lowPerformers = sortedBySales.slice(Math.ceil(sortedBySales.length / 2));
                if (lowPerformers.length > 0) {
                    insights.recommendations.push(`üìö <strong>${lowPerformers.map(st => st.name).join(', ')}</strong> i√ßin: Trafik analizi, personel verimliliƒüi, √ºr√ºn √ße≈üitliliƒüi ve fiyatlandƒ±rma stratejilerini g√∂zden ge√ßirin`);
                }
            }

            insights.recommendations.push(`ü§ù <strong>Aylƒ±k Performans Toplantƒ±larƒ±:</strong> Maƒüaza m√ºd√ºrleri arasƒ± best practice payla≈üƒ±mƒ± ve sorun √ß√∂zme workshoplarƒ± d√ºzenleyin`);
            insights.recommendations.push(`üìä <strong>M√º≈üteri Geri Bildirimleri:</strong> Her maƒüaza i√ßin NPS (Net Promoter Score) ve m√º≈üteri memnuniyeti anketleri yaparak performans farklƒ±lƒ±klarƒ±nƒ±n nedenlerini analiz edin`);

            // HTML olu≈ütur
            let html = '<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; color: white; margin-bottom: 30px;">';
            html += '<h3 style="margin: 0 0 20px 0; font-size: 1.8em;">ü§ñ Kar≈üƒ±la≈ütƒ±rmalƒ± AI Performans Analizi</h3>';

            if (insights.positive.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #4ade80; margin-bottom: 10px;">‚úÖ G√º√ßl√º Y√∂nler:</h4><ul style="margin: 0; padding-left: 20px;">';
                insights.positive.forEach(item => html += `<li style="margin-bottom: 8px;">${item}</li>`);
                html += '</ul></div>';
            }

            if (insights.negative.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #fbbf24; margin-bottom: 10px;">‚ö†Ô∏è Geli≈üim Alanlarƒ±:</h4><ul style="margin: 0; padding-left: 20px;">';
                insights.negative.forEach(item => html += `<li style="margin-bottom: 8px;">${item}</li>`);
                html += '</ul></div>';
            }

            if (insights.neutral.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #e0e7ff; margin-bottom: 10px;">üìä Genel Durum:</h4><ul style="margin: 0; padding-left: 20px;">';
                insights.neutral.forEach(item => html += `<li style="margin-bottom: 8px;">${item}</li>`);
                html += '</ul></div>';
            }

            if (insights.categories.length > 0) {
                html += '<div style="margin-bottom: 20px;"><h4 style="color: #fcd34d; margin-bottom: 10px;">üìÇ Kategori Liderlikleri:</h4><ul style="margin: 0; padding-left: 20px;">';
                insights.categories.forEach(item => html += `<li style="margin-bottom: 8px;">${item}</li>`);
                html += '</ul></div>';
            }

            if (insights.recommendations.length > 0) {
                html += '<div><h4 style="color: #a78bfa; margin-bottom: 10px;">üí° Stratejik √ñneriler:</h4><ul style="margin: 0; padding-left: 20px;">';
                insights.recommendations.forEach(item => html += `<li style="margin-bottom: 8px;">${item}</li>`);
                html += '</ul></div>';
            }

            html += '</div>';

            // √áoklu maƒüaza kar≈üƒ±la≈ütƒ±rmasƒ± i√ßin √∂zel div'e yaz
            const multipleAIContent = document.getElementById('multipleStoresAIContent');
            if (multipleAIContent) {
                multipleAIContent.innerHTML = html;
                console.log('‚úÖ √áoklu maƒüaza AI analizi HTML eklendi');
            } else {
                console.error('‚ùå multipleStoresAIContent bulunamadƒ±!');
            }
            
            // Eski tek maƒüaza div'ini de g√ºncelle (fallback)
            const aiContent = document.getElementById('storeAIAnalysisContent');
            if (aiContent) {
                aiContent.innerHTML = html;
            }
        }
        
        function renderStoreBrandChart(data) {
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = {sales: 0, qty: 0};
                brandData[brand].sales += parseFloat(item.usd_amount || 0);
                brandData[brand].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(brandData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const ctx = document.getElementById('storeBrandChart');
            if (!ctx) return;
            if (storeBrandChartInstance) storeBrandChartInstance.destroy();
            
            storeBrandChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(item => item[0]),
                    datasets: [{
                        label: 'Satƒ±≈ü (USD)',
                        data: sorted.map(item => item[1].sales),
                        backgroundColor: 'rgba(102, 126, 234, 0.6)'
                    }]
                },
                options: {responsive: true, maintainAspectRatio: false}
            });
        }
        
        function renderStoreCategoryChart(data) {
            const catData = {};
            data.forEach(item => {
                const cat = item.category_2 || '';
                // ALL, Analitik, Eƒüitim, Bilinmiyor, bo≈ü deƒüerleri atla
                if (!cat || 
                    cat.toLowerCase() === 'all' || 
                    cat.toLowerCase() === 'bilinmiyor' ||
                    cat.toLowerCase().includes('analitik') || 
                    cat.toLowerCase().includes('eƒüitim')) {
                    return;
                }
                if (!catData[cat]) catData[cat] = 0;
                catData[cat] += parseFloat(item.usd_amount || 0);
            });
            
            const sorted = Object.entries(catData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const ctx = document.getElementById('storeCategoryChart');
            if (!ctx) return;
            if (storeCategoryChartInstance) storeCategoryChartInstance.destroy();
            
            storeCategoryChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: sorted.map(item => item[0]),
                    datasets: [{data: sorted.map(item => item[1])}]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        datalabels: {
                            color: '#fff',
                            font: {
                                weight: 'bold',
                                size: 14
                            },
                            formatter: (value, ctx) => {
                                let sum = ctx.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                let percentage = (value * 100 / sum).toFixed(1) + "%";
                                return percentage;
                            }
                        }
                    }
                },
                plugins: [ChartDataLabels]
            });
        }
        
        function renderStoreDistrictChart(data) {
            const districtData = {};
            data.forEach(item => {
                const district = item.city || 'Bilinmiyor'; // city = ƒ∞L√áE bilgisi
                if (!districtData[district]) districtData[district] = 0;
                districtData[district] += parseFloat(item.usd_amount || 0);
            });
            
            const sorted = Object.entries(districtData).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const ctx = document.getElementById('storeDistrictChart');
            if (!ctx) return;
            if (storeDistrictChartInstance) storeDistrictChartInstance.destroy();
            
            storeDistrictChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(item => item[0]),
                    datasets: [{
                        label: 'Satƒ±≈ü (USD)',
                        data: sorted.map(item => item[1]),
                        backgroundColor: 'rgba(245, 87, 108, 0.6)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: false}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderStoreSalespersonChart(data) {
            const spData = {};
            data.forEach(item => {
                const sp = item.sales_person || 'Bilinmiyor';
                if (!spData[sp]) spData[sp] = 0;
                spData[sp] += parseFloat(item.usd_amount || 0);
            });
            
            const sorted = Object.entries(spData).sort((a, b) => b[1] - a[1]).slice(0, 10);
            const ctx = document.getElementById('storeSalespersonChart');
            if (!ctx) return;
            if (storeSalespersonChartInstance) storeSalespersonChartInstance.destroy();
            
            storeSalespersonChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: sorted.map(item => item[0]),
                    datasets: [{
                        label: 'Satƒ±≈ü (USD)',
                        data: sorted.map(item => item[1]),
                        backgroundColor: 'rgba(118, 75, 162, 0.6)'
                    }]
                },
                options: {responsive: true, maintainAspectRatio: false}
            });
        }
        
        function renderStoreMonthlyChart(data) {
            const yearlyMonthlyData = {};
            data.forEach(item => {
                const date = new Date(item.date);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                if (!yearlyMonthlyData[year]) yearlyMonthlyData[year] = {};
                if (!yearlyMonthlyData[year][month]) yearlyMonthlyData[year][month] = 0;
                yearlyMonthlyData[year][month] += parseFloat(item.usd_amount || 0);
            });
            
            const allMonthKeys = new Set();
            Object.values(yearlyMonthlyData).forEach(yearData => {
                Object.keys(yearData).forEach(month => allMonthKeys.add(month));
            });
            const sortedMonths = Array.from(allMonthKeys).sort();
            
            const datasets = [];
            const colors = [
                {border: 'rgba(102, 126, 234, 1)', bg: 'rgba(102, 126, 234, 0.1)'},
                {border: 'rgba(245, 87, 108, 1)', bg: 'rgba(245, 87, 108, 0.1)'},
                {border: 'rgba(56, 239, 125, 1)', bg: 'rgba(56, 239, 125, 0.1)'}
            ];
            
            Object.keys(yearlyMonthlyData).sort().forEach((year, idx) => {
                const yearData = yearlyMonthlyData[year];
                const values = sortedMonths.map(month => yearData[month] || 0);
                const color = colors[idx % colors.length];
                
                datasets.push({
                    label: `${year}`,
                    data: values,
                    borderColor: color.border,
                    backgroundColor: color.bg,
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                });
            });
            
            const ctx = document.getElementById('storeMonthlyChart');
            if (!ctx) return;
            if (storeMonthlyChartInstance) storeMonthlyChartInstance.destroy();
            
            const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            const labels = sortedMonths.map(m => monthNames[parseInt(m) - 1]);
            
            storeMonthlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {labels: labels, datasets: datasets},
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {legend: {display: true, position: 'top'}}
                }
            });
        }
        
        function renderStoreTopProducts(data) {
            const productData = {};
            data.forEach(item => {
                const product = item.product || 'Bilinmiyor';
                if (!productData[product]) {
                    productData[product] = {brand: item.brand || 'Bilinmiyor', sales: 0, qty: 0};
                }
                productData[product].sales += parseFloat(item.usd_amount || 0);
                productData[product].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(productData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 20);
            
            let html = '<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #667eea; color: white;"><th style="padding: 12px; text-align: left;">√úr√ºn</th><th style="padding: 12px; text-align: left;">Marka</th><th style="padding: 12px; text-align: right;">Satƒ±≈ü (USD)</th><th style="padding: 12px; text-align: right;">Adet</th></tr></thead><tbody>';
            
            sorted.forEach((item, index) => {
                html += `<tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                    <td style="padding: 12px;">${item[0]}</td>
                    <td style="padding: 12px;">${item[1].brand}</td>
                    <td style="padding: 12px; text-align: right;">$${item[1].sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                    <td style="padding: 12px; text-align: right;">${item[1].qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                </tr>`;
            });
            
            html += '</tbody></table>';
            document.getElementById('storeTopProductsTable').innerHTML = html;
        }
        
        function renderStoreFullSalespersonTable(data) {
            const spData = {};
            
            data.forEach(item => {
                const sp = item.sales_person || 'Bilinmiyor';
                if (!spData[sp]) {
                    spData[sp] = {
                        sales: 0,
                        qty: 0,
                        invoiceCount: 0,
                        uniqueCustomers: 0,
                        invoices: new Set(),
                        customers: new Set()
                    };
                }
                spData[sp].sales += parseFloat(item.usd_amount || 0);
                spData[sp].qty += parseFloat(item.quantity || 0);
                // Fatura numarasƒ± unique olarak say (move_name kullan - daha g√ºvenli)
                if (item.move_name) spData[sp].invoices.add(item.move_name);
                else if (item.move_id) spData[sp].invoices.add(item.move_id);
                // M√º≈üteri sayƒ±sƒ±nƒ± unique olarak say
                if (item.partner) spData[sp].customers.add(item.partner);
            });
            
            // Fatura ve m√º≈üteri sayƒ±sƒ±nƒ± hesapla
            Object.keys(spData).forEach(sp => {
                spData[sp].invoiceCount = spData[sp].invoices.size;
                spData[sp].uniqueCustomers = spData[sp].customers.size;
                delete spData[sp].invoices; // Set'i sil
                delete spData[sp].customers; // Set'i sil
            });
            
            const sorted = Object.entries(spData).sort((a, b) => b[1].sales - a[1].sales);
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <th style="padding: 15px; text-align: left; cursor: pointer;" onclick="sortStoreSpTable(0)">
                                # <span style="font-size: 0.8em;">‚ñº</span>
                            </th>
                            <th style="padding: 15px; text-align: left; cursor: pointer;" onclick="sortStoreSpTable(1)">
                                üë§ Satƒ±≈ü Temsilcisi <span style="font-size: 0.8em;">‚ñº</span>
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="sortStoreSpTable(2)">
                                üí∞ Toplam Satƒ±≈ü (USD) <span style="font-size: 0.8em;">‚ñº</span>
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="sortStoreSpTable(3)">
                                üì¶ √úr√ºn Miktarƒ± <span style="font-size: 0.8em;">‚ñº</span>
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="sortStoreSpTable(4)">
                                üßæ Fatura Adeti <span style="font-size: 0.8em;">‚ñº</span>
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="sortStoreSpTable(5)">
                                üë• Farklƒ± M√º≈üteri <span style="font-size: 0.8em;">‚ñº</span>
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="sortStoreSpTable(6)">
                                üõí Sepet Ortalamasƒ± <span style="font-size: 0.8em;">‚ñº</span>
                            </th>
                            <th style="padding: 15px; text-align: right;">
                                üìà Pay (%)
                            </th>
                        </tr>
                    </thead>
                    <tbody id="storeSpTableBody">
            `;
            
            const totalSales = sorted.reduce((sum, item) => sum + item[1].sales, 0);
            
            sorted.forEach((item, index) => {
                const sp = item[0];
                const stats = item[1];
                const share = ((stats.sales / totalSales) * 100).toFixed(1);
                const avgInvoice = stats.invoiceCount > 0 ? (stats.sales / stats.invoiceCount) : 0;
                
                html += `
                    <tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: #f8f9fa;' : 'background: white;'}">
                        <td style="padding: 12px;">${index + 1}</td>
                        <td style="padding: 12px;"><strong>${sp}</strong></td>
                        <td style="padding: 12px; text-align: right; color: #667eea; font-weight: bold;">$${stats.sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right;">${stats.qty.toLocaleString('tr-TR', {minimumFractionDigits: 0})}</td>
                        <td style="padding: 12px; text-align: right; color: #38ef7d; font-weight: bold;">${stats.invoiceCount.toLocaleString('tr-TR')}</td>
                        <td style="padding: 12px; text-align: right; color: #764ba2; font-weight: bold;">${stats.uniqueCustomers.toLocaleString('tr-TR')}</td>
                        <td style="padding: 12px; text-align: right;">$${avgInvoice.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right;">
                            <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 12px; font-weight: bold;">
                                %${share}
                            </span>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
                <p style="margin-top: 10px; color: #6c757d; font-size: 0.9em;">
                    üí° <strong>Toplam ${sorted.length} satƒ±≈ü temsilcisi</strong> - S√ºtun ba≈ülƒ±klarƒ±na tƒ±klayarak sƒ±ralama yapabilirsiniz
                </p>
            `;
            
            document.getElementById('storeFullSalespersonTable').innerHTML = html;
        }
        
        // Sƒ±ralama fonksiyonu
        let storeSpSortColumn = 2; // Default: Satƒ±≈ü
        let storeSpSortAsc = false;
        
        function sortStoreSpTable(column) {
            if (storeSpSortColumn === column) {
                storeSpSortAsc = !storeSpSortAsc; // Toggle
            } else {
                storeSpSortColumn = column;
                storeSpSortAsc = false; // Yeni s√ºtun, descending ba≈üla
            }
            
            const tbody = document.getElementById('storeSpTableBody');
            const rows = Array.from(tbody.querySelectorAll('tr'));
            
            rows.sort((a, b) => {
                const cellsA = a.querySelectorAll('td');
                const cellsB = b.querySelectorAll('td');
                
                let valA, valB;
                
                if (column === 0) { // Sƒ±ra
                    valA = parseInt(cellsA[0].textContent);
                    valB = parseInt(cellsB[0].textContent);
                } else if (column === 1) { // ƒ∞sim
                    valA = cellsA[1].textContent.trim();
                    valB = cellsB[1].textContent.trim();
                    return storeSpSortAsc ? valA.localeCompare(valB) : valB.localeCompare(valA);
                } else if (column === 2) { // Satƒ±≈ü
                    valA = parseFloat(cellsA[2].textContent.replace(/[^0-9,.-]/g, '').replace(',', '.'));
                    valB = parseFloat(cellsB[2].textContent.replace(/[^0-9,.-]/g, '').replace(',', '.'));
                } else if (column === 3) { // Miktar
                    valA = parseFloat(cellsA[3].textContent.replace(/[^0-9,.-]/g, '').replace(',', '.'));
                    valB = parseFloat(cellsB[3].textContent.replace(/[^0-9,.-]/g, '').replace(',', '.'));
                } else if (column === 4) { // Fatura Adeti
                    valA = parseInt(cellsA[4].textContent.replace(/[^0-9]/g, ''));
                    valB = parseInt(cellsB[4].textContent.replace(/[^0-9]/g, ''));
                } else if (column === 5) { // Farklƒ± M√º≈üteri
                    valA = parseInt(cellsA[5].textContent.replace(/[^0-9]/g, ''));
                    valB = parseInt(cellsB[5].textContent.replace(/[^0-9]/g, ''));
                } else if (column === 6) { // Sepet Ortalamasƒ±
                    valA = parseFloat(cellsA[6].textContent.replace(/[^0-9,.-]/g, '').replace(',', '.'));
                    valB = parseFloat(cellsB[6].textContent.replace(/[^0-9,.-]/g, '').replace(',', '.'));
                }
                
                return storeSpSortAsc ? (valA - valB) : (valB - valA);
            });
            
            rows.forEach(row => tbody.appendChild(row));
        }
        
        function performStoreAIAnalysis(data, profile) {
            const insights = {positive: [], negative: [], neutral: [], recommendations: [], warnings: []};
            
            // ==================== YILLIK TREND VE GELECEK YIL HED EF √ñNERƒ∞Sƒ∞ ====================
            console.log('üìä Yƒ±llƒ±k trend analizi ba≈ülatƒ±lƒ±yor...');
            
            // Yƒ±llƒ±k satƒ±≈ü verileri
            const yearlyData = {};
            data.forEach(item => {
                const year = item.date ? item.date.substring(0, 4) : null;
                if (year) {
                    if (!yearlyData[year]) yearlyData[year] = 0;
                    yearlyData[year] += parseFloat(item.usd_amount || 0);
                }
            });
            
            const years = Object.keys(yearlyData).sort();
            const currentYear = new Date().getFullYear().toString();
            const lastYear = (parseInt(currentYear) - 1).toString();
            
            let yearlyTrendAnalysis = '';
            let nextYearTargetRecommendation = '';
            
            if (years.length >= 2) {
                // Son 3 yƒ±lƒ±n verilerini al
                const recentYears = years.slice(-3);
                const yearSales = recentYears.map(y => ({year: y, sales: yearlyData[y]}));
                
                // Trend hesapla (son 2 yƒ±l kar≈üƒ±la≈ütƒ±rmasƒ±)
                const currentYearSales = yearlyData[currentYear] || 0;
                const lastYearSales = yearlyData[lastYear] || 0;
                const growth = lastYearSales > 0 ? ((currentYearSales - lastYearSales) / lastYearSales * 100) : 0;
                
                // Ortalama b√ºy√ºme oranƒ± (son 3 yƒ±l varsa)
                let avgGrowth = 0;
                if (recentYears.length === 3) {
                    const growth1 = yearlyData[recentYears[1]] > 0 ? 
                        ((yearlyData[recentYears[1]] - yearlyData[recentYears[0]]) / yearlyData[recentYears[0]] * 100) : 0;
                    const growth2 = yearlyData[recentYears[2]] > 0 ? 
                        ((yearlyData[recentYears[2]] - yearlyData[recentYears[1]]) / yearlyData[recentYears[1]] * 100) : 0;
                    avgGrowth = (growth1 + growth2) / 2;
                }
                
                // Trend a√ßƒ±klamasƒ±
                let trendIcon = 'üìä';
                let trendText = '';
                let trendColor = '#667eea';
                
                if (growth > 20) {
                    trendIcon = 'üöÄ';
                    trendText = 'G√ú√áL√ú B√úY√úME';
                    trendColor = '#38ef7d';
                } else if (growth > 10) {
                    trendIcon = 'üìà';
                    trendText = 'POZƒ∞Tƒ∞F B√úY√úME';
                    trendColor = '#4facfe';
                } else if (growth > 0) {
                    trendIcon = '‚û°Ô∏è';
                    trendText = 'STABIL B√úY√úME';
                    trendColor = '#ffa751';
                } else if (growth > -10) {
                    trendIcon = '‚ö†Ô∏è';
                    trendText = 'D√ú≈û';
                    trendColor = '#ff6b6b';
                } else {
                    trendIcon = 'üìâ';
                    trendText = 'Y√úKSEK D√ú≈û√ú≈û';
                    trendColor = '#dc3545';
                }
                
                yearlyTrendAnalysis = `
                    <div style="background: linear-gradient(135deg, ${trendColor} 0%, ${trendColor}dd 100%); padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px;">
                        <h4 style="margin: 0 0 15px 0; font-size: 1.3em;">${trendIcon} Yƒ±llƒ±k Performans Trendi</h4>
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; margin-bottom: 15px;">
                            ${recentYears.map(y => `
                                <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">${y}</div>
                                    <div style="font-size: 1.3em; font-weight: bold;">$${(yearlyData[y] || 0).toLocaleString('tr-TR', {minimumFractionDigits: 0})}</div>
                                </div>
                            `).join('')}
                        </div>
                        <div style="background: rgba(255,255,255,0.15); padding: 15px; border-radius: 8px;">
                            <div style="font-size: 1.1em; margin-bottom: 8px;"><strong>üìä ${currentYear} Performansƒ±:</strong> ${trendText}</div>
                            <div style="font-size: 0.95em; line-height: 1.6;">
                                ‚Ä¢ ${lastYear} vs ${currentYear}: <strong>${growth > 0 ? '+' : ''}${growth.toFixed(1)}%</strong> ${growth > 0 ? 'b√ºy√ºme' : 'd√º≈ü√º≈ü'}<br>
                                ‚Ä¢ ${lastYear} Satƒ±≈ü: $${lastYearSales.toLocaleString('tr-TR', {minimumFractionDigits: 0})}<br>
                                ‚Ä¢ ${currentYear} Satƒ±≈ü: $${currentYearSales.toLocaleString('tr-TR', {minimumFractionDigits: 0})}<br>
                                ${recentYears.length === 3 ? `‚Ä¢ 3 Yƒ±llƒ±k Ortalama B√ºy√ºme: ${avgGrowth > 0 ? '+' : ''}${avgGrowth.toFixed(1)}%` : ''}
                            </div>
                        </div>
                    </div>
                `;
                
                // GELECEK YIL HEDEF √ñNERƒ∞Sƒ∞
                const nextYear = (parseInt(currentYear) + 1).toString();
                let recommendedTarget = 0;
                let targetReason = '';
                let targetColor = '#667eea';
                
                if (growth > 20) {
                    // G√º√ßl√º b√ºy√ºme: %20-25 hedef
                    recommendedTarget = currentYearSales * 1.22;
                    targetReason = `üöÄ Maƒüaza son yƒ±l <strong>%${growth.toFixed(1)}</strong> b√ºy√ºd√º! Bu momentum ile ${nextYear} i√ßin <strong>%22</strong> b√ºy√ºme hedefi makul.`;
                    targetColor = '#38ef7d';
                } else if (growth > 10) {
                    // ƒ∞yi b√ºy√ºme: %15-18 hedef
                    recommendedTarget = currentYearSales * 1.16;
                    targetReason = `üìà Maƒüaza saƒülam bir b√ºy√ºme g√∂steriyor (%${growth.toFixed(1)}). ${nextYear} i√ßin <strong>%16</strong> b√ºy√ºme hedefi √∂neriyoruz.`;
                    targetColor = '#4facfe';
                } else if (growth > 0) {
                    // Stabil: %10-12 hedef
                    recommendedTarget = currentYearSales * 1.10;
                    targetReason = `‚û°Ô∏è Maƒüaza stabil b√ºy√ºme g√∂steriyor (%${growth.toFixed(1)}). ${nextYear} i√ßin dikkatli bir <strong>%10</strong> b√ºy√ºme hedefi uygun.`;
                    targetColor = '#ffa751';
                } else if (growth > -10) {
                    // Hafif d√º≈ü√º≈ü: Stabilizasyon hedefi
                    recommendedTarget = currentYearSales * 1.05;
                    targetReason = `‚ö†Ô∏è Maƒüaza hafif d√º≈ü√º≈ü ya≈üƒ±yor (%${growth.toFixed(1)}). ${nextYear} i√ßin √∂nce <strong>stabilizasyon</strong>, sonra %5 b√ºy√ºme hedefleyin. <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; font-size: 0.9em;">Acil aksiyon gerekli!</span>`;
                    targetColor = '#ff6b6b';
                } else {
                    // Y√ºksek d√º≈ü√º≈ü: Minimum kayƒ±p hedefi
                    recommendedTarget = currentYearSales;
                    targetReason = `üìâ Maƒüaza ciddi d√º≈ü√º≈ü ya≈üƒ±yor (%${growth.toFixed(1)}). ${nextYear} i√ßin √∂ncelik <strong>mevcut seviyeyi korumak</strong> olmalƒ±. <span style="background: rgba(255,0,0,0.3); padding: 4px 8px; border-radius: 4px; font-size: 0.9em;">üö® Kapsamlƒ± strateji revizyonu ≈üart!</span>`;
                    targetColor = '#dc3545';
                }
                
                nextYearTargetRecommendation = `
                    <div style="background: linear-gradient(135deg, ${targetColor} 0%, ${targetColor}dd 100%); padding: 20px; border-radius: 12px; color: white; margin-bottom: 20px; border: 3px solid rgba(255,255,255,0.3);">
                        <h4 style="margin: 0 0 15px 0; font-size: 1.3em;">üéØ ${nextYear} Yƒ±lƒ± √ñnerilen Hedef</h4>
                        <div style="text-align: center; margin: 20px 0;">
                            <div style="font-size: 2.5em; font-weight: bold; margin-bottom: 10px;">
                                $${recommendedTarget.toLocaleString('tr-TR', {minimumFractionDigits: 0})}
                            </div>
                            <div style="font-size: 1.1em; opacity: 0.95;">
                                ${currentYear} Satƒ±≈ü: $${currentYearSales.toLocaleString('tr-TR', {minimumFractionDigits: 0})} 
                                ‚Üí <strong>${nextYear}: +${((recommendedTarget - currentYearSales) / currentYearSales * 100).toFixed(1)}%</strong>
                            </div>
                        </div>
                        <div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 8px; line-height: 1.7;">
                            <strong>üí° Neden Bu Hedef?</strong><br>
                            ${targetReason}
                        </div>
                        ${growth > 0 ? `
                            <div style="margin-top: 15px; padding: 12px; background: rgba(255,255,255,0.15); border-radius: 8px; font-size: 0.95em;">
                                <strong>üìä Aylƒ±k Hedef Daƒüƒ±lƒ±mƒ± (√ñneri):</strong><br>
                                ‚Ä¢ Yƒ±llƒ±k Hedef: $${recommendedTarget.toLocaleString('tr-TR', {minimumFractionDigits: 0})}<br>
                                ‚Ä¢ Aylƒ±k Ortalama: $${(recommendedTarget / 12).toLocaleString('tr-TR', {minimumFractionDigits: 0})}<br>
                                ‚Ä¢ G√ºnl√ºk Ortalama: $${(recommendedTarget / 365).toLocaleString('tr-TR', {minimumFractionDigits: 0})}
                            </div>
                        ` : `
                            <div style="margin-top: 15px; padding: 12px; background: rgba(255,0,0,0.2); border-radius: 8px; font-size: 0.95em;">
                                <strong>‚ö†Ô∏è Aksiyon √ñnerileri:</strong><br>
                                ‚Ä¢ √úr√ºn karmasƒ± revizyonu<br>
                                ‚Ä¢ Satƒ±≈ü ekibi eƒüitimi<br>
                                ‚Ä¢ Kampanya stratejisi deƒüi≈üikliƒüi<br>
                                ‚Ä¢ M√º≈üteri memnuniyeti analizi
                            </div>
                        `}
                    </div>
                `;
            }
            
            // Marka analizi
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += parseFloat(item.usd_amount || 0);
            });
            const topBrands = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 3);
            
            // Satƒ±≈ü temsilcisi analizi
            const spData = {};
            data.forEach(item => {
                const sp = item.sales_person || 'Bilinmiyor';
                if (!spData[sp]) spData[sp] = 0;
                spData[sp] += parseFloat(item.usd_amount || 0);
            });
            const topSP = Object.entries(spData).sort((a, b) => b[1] - a[1]).slice(0, 3);
            
            // Kategori analizi (category_2 kullan, ALL/Analitik/Eƒüitim atla)
            const categoryData = {};
            data.forEach(item => {
                const cat = item.category_2 || 'Bilinmiyor';
                if (cat.toLowerCase() === 'all' || cat.toLowerCase().includes('analitik') || cat.toLowerCase().includes('eƒüitim')) {
                    return;
                }
                if (!categoryData[cat]) categoryData[cat] = 0;
                categoryData[cat] += parseFloat(item.usd_amount || 0);
            });
            const topCategories = Object.entries(categoryData).sort((a, b) => b[1] - a[1]).slice(0, 3);
            
            // ZAMAN ANALƒ∞ZLERƒ∞
            // Aylƒ±k analiz
            const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            const monthData = {};
            data.forEach(item => {
                const date = new Date(item.date);
                const month = date.getMonth();
                if (!monthData[month]) monthData[month] = 0;
                monthData[month] += parseFloat(item.usd_amount || 0);
            });
            const monthEntries = Object.entries(monthData).map(([m, v]) => ({month: parseInt(m), name: monthNames[m], value: v}));
            const bestMonth = monthEntries.sort((a, b) => b.value - a.value)[0];
            const worstMonth = monthEntries.sort((a, b) => a.value - b.value)[0];
            
            // G√ºnl√ºk analiz (haftanƒ±n g√ºnleri)
            const dayNames = ['Pazar', 'Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi'];
            const dayData = {};
            data.forEach(item => {
                const day = item.day_of_week;
                if (day !== undefined && day !== null) {
                    // Odoo: 0=Pazartesi, Python: 0=Pazartesi de olabilir, kontrol et
                    const dayIndex = (day + 1) % 7; // 0=Paz, 1=Pzt, ...
                    if (!dayData[dayIndex]) dayData[dayIndex] = 0;
                    dayData[dayIndex] += parseFloat(item.usd_amount || 0);
                }
            });
            const dayEntries = Object.entries(dayData).map(([d, v]) => ({day: parseInt(d), name: dayNames[d], value: v}));
            const bestDay = dayEntries.sort((a, b) => b.value - a.value)[0];
            const worstDay = dayEntries.sort((a, b) => a.value - b.value)[0];
            
            // Saatlik analiz
            const hourData = {};
            data.forEach(item => {
                const hour = item.create_hour;
                if (hour !== undefined && hour !== null) {
                    if (!hourData[hour]) hourData[hour] = 0;
                    hourData[hour] += parseFloat(item.usd_amount || 0);
                }
            });
            const hourEntries = Object.entries(hourData).map(([h, v]) => ({hour: parseInt(h), value: v}));
            const bestHour = hourEntries.sort((a, b) => b.value - a.value)[0];
            const worstHour = hourEntries.sort((a, b) => a.value - b.value)[0];
            
            // Saat aralƒ±ƒüƒ± analizi (sabah, √∂ƒülen, ak≈üam)
            let morning = 0, afternoon = 0, evening = 0, night = 0;
            data.forEach(item => {
                const hour = item.create_hour;
                const amount = parseFloat(item.usd_amount || 0);
                if (hour >= 6 && hour < 12) morning += amount;
                else if (hour >= 12 && hour < 17) afternoon += amount;
                else if (hour >= 17 && hour < 22) evening += amount;
                else night += amount;
            });
            const timeSlots = [
                {name: 'Sabah (06:00-12:00)', value: morning},
                {name: '√ñƒülen (12:00-17:00)', value: afternoon},
                {name: 'Ak≈üam (17:00-22:00)', value: evening},
                {name: 'Gece (22:00-06:00)', value: night}
            ].sort((a, b) => b.value - a.value);
            
            // Temsilci-G√ºn kombinasyonu
            const spDayData = {};
            data.forEach(item => {
                const sp = item.sales_person || 'Bilinmiyor';
                const day = item.day_of_week;
                if (day !== undefined && day !== null) {
                    const dayIndex = (day + 1) % 7;
                    const key = `${sp}_${dayIndex}`;
                    if (!spDayData[key]) spDayData[key] = {sp, day: dayIndex, dayName: dayNames[dayIndex], value: 0};
                    spDayData[key].value += parseFloat(item.usd_amount || 0);
                }
            });
            const topSpDay = Object.values(spDayData).sort((a, b) => b.value - a.value)[0];
            
            // Temsilci-Saat kombinasyonu
            const spHourData = {};
            data.forEach(item => {
                const sp = item.sales_person || 'Bilinmiyor';
                const hour = item.create_hour;
                if (hour !== undefined && hour !== null) {
                    const key = `${sp}_${hour}`;
                    if (!spHourData[key]) spHourData[key] = {sp, hour, value: 0};
                    spHourData[key].value += parseFloat(item.usd_amount || 0);
                }
            });
            const topSpHour = Object.values(spHourData).sort((a, b) => b.value - a.value)[0];
            
            // Pozitif
            if (profile.totalSales > 100000) {
                insights.positive.push({
                    title: 'üí∞ Y√ºksek Ciro',
                    description: `Maƒüaza toplam <span class="metric-highlight">$${profile.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</span> satƒ±≈ü ger√ßekle≈ütirmi≈ü. M√ºkemmel performans!`
                });
            }
            
            if (topBrands.length > 0) {
                const topBrand = topBrands[0];
                const brandPercent = (topBrand[1] / profile.totalSales * 100).toFixed(1);
                insights.positive.push({
                    title: `üè∑Ô∏è En Ba≈üarƒ±lƒ± 3 Marka`,
                    description: `${topBrands.slice(0, 3).map(b => `${b[0]} (%${(b[1]/profile.totalSales*100).toFixed(1)})`).join(', ')}`
                });
            }
            
            if (topCategories.length > 0) {
                const topCat = topCategories[0];
                const catPercent = (topCat[1] / profile.totalSales * 100).toFixed(1);
                insights.positive.push({
                    title: `üìÇ En Ba≈üarƒ±lƒ± 3 Kategori`,
                    description: `${topCategories.slice(0, 3).map(c => `${c[0]} (%${(c[1]/profile.totalSales*100).toFixed(1)})`).join(', ')}`
                });
            }
            
            // ZAMAN BAZLI ANALƒ∞ZLER - Neutral
            if (bestMonth && worstMonth) {
                const bestPercent = ((bestMonth.value / profile.totalSales) * 100).toFixed(1);
                const worstPercent = ((worstMonth.value / profile.totalSales) * 100).toFixed(1);
                insights.neutral.push({
                    title: 'üìÖ Aylƒ±k Performans',
                    description: `En g√º√ßl√º ay: <span class="metric-highlight">${bestMonth.name}</span> (%${bestPercent})<br>En zayƒ±f ay: ${worstMonth.name} (%${worstPercent})`
                });
            }
            
            if (bestDay && worstDay) {
                const bestDayPercent = ((bestDay.value / profile.totalSales) * 100).toFixed(1);
                const worstDayPercent = ((worstDay.value / profile.totalSales) * 100).toFixed(1);
                insights.neutral.push({
                    title: 'üìÜ G√ºnl√ºk Performans',
                    description: `En g√º√ßl√º g√ºn: <span class="metric-highlight">${bestDay.name}</span> (%${bestDayPercent})<br>En zayƒ±f g√ºn: ${worstDay.name} (%${worstDayPercent})`
                });
            }
            
            if (timeSlots.length > 0) {
                const bestSlot = timeSlots[0];
                const bestSlotPercent = ((bestSlot.value / profile.totalSales) * 100).toFixed(1);
                insights.neutral.push({
                    title: 'üïê Saat Dilimi Performansƒ±',
                    description: `En g√º√ßl√º: <span class="metric-highlight">${bestSlot.name}</span> - Cironun %${bestSlotPercent}'i bu saatlerde`
                });
            }
            
            if (topSpDay) {
                const spDayPercent = ((topSpDay.value / profile.totalSales) * 100).toFixed(1);
                insights.neutral.push({
                    title: '‚≠ê En Ba≈üarƒ±lƒ± Kombinasyon',
                    description: `<span class="metric-highlight">${topSpDay.sp}</span> - <span class="metric-highlight">${topSpDay.dayName}</span> g√ºnleri harika! (%${spDayPercent})`
                });
            }
            
            // MAƒûAZA √áALI≈ûMA SAATLERƒ∞ Bƒ∞LGƒ∞Sƒ∞
            const storeHours = getStoreWorkingHours(profile.name || '');
            const closedDayNames = storeHours.closedDays.map(d => {
                const days = ['Pazar', 'Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi'];
                return days[d];
            }).join(', ');
            
            
            // N√∂tr
            if (topSP.length > 0) {
                const spList = topSP.map((sp, idx) => {
                    const percent = (sp[1] / profile.totalSales * 100).toFixed(1);
                    return `${idx + 1}. ${sp[0]} (%${percent})`;
                }).join('<br>');
                insights.neutral.push({
                    title: 'üë®‚Äçüíº En Ba≈üarƒ±lƒ± Satƒ±≈ü Temsilcileri',
                    description: spList
                });
            }
            
            insights.neutral.push({
                title: 'üìä Genel Performans',
                description: `<span class="metric-highlight">${profile.uniqueCustomers}</span> farklƒ± m√º≈üteri, <span class="metric-highlight">${profile.uniqueProducts}</span> farklƒ± √ºr√ºn satƒ±ldƒ±.`
            });
            
            // TOPLAM SATI≈û ƒ∞√áƒ∞NDEKƒ∞ PAY
            insights.neutral.push({
                title: 'üìà Toplam Satƒ±≈ü ƒ∞√ßindeki Pay',
                description: `${profile.name} maƒüazasƒ±, toplam ≈üirket satƒ±≈üƒ±nƒ±n <strong>%${profile.storeSalesPercentage}</strong> payƒ±nƒ± olu≈üturuyor. Bu, $${profile.totalAllSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} toplam satƒ±≈ü i√ßinde $${profile.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} deƒüerinde bir performans.`
            });
            
            if (topCategories.length >= 3) {
                insights.neutral.push({
                    title: 'üìÇ Kategori √áe≈üitliliƒüi',
                    description: `En √ßok satƒ±lan kategoriler: ${topCategories.map(c => c[0]).join(', ')}. Bu kategorilerde g√º√ßl√º performans.`
                });
            }
            
            // √ñneriler - ZAMAN BAZLI (√áALI≈ûMA SAATLERƒ∞ Dƒ∞KKATE ALINARAK)
            if (worstDay && bestDay) {
                // Kapalƒ± g√ºn kontrol√º
                const worstDayIndex = worstDay.day;
                const isWorstDayClosed = storeHours.closedDays.includes(worstDayIndex);
                
                if (isWorstDayClosed) {
                    insights.recommendations.push({
                        icon: 'üìÜ',
                        title: 'Kapalƒ± G√ºn Deƒüerlendirmesi',
                        description: `${worstDay.name} g√ºnleri maƒüaza kapalƒ±. Bu g√ºn i√ßin √∂zel bir strateji gerekmiyor.`
                    });
                } else {
                    insights.recommendations.push({
                        icon: 'üìÜ',
                        title: 'G√ºn Bazlƒ± Strateji',
                        description: `${worstDay.name} g√ºnleri zayƒ±f. ${bestDay.name} g√ºnlerindeki ba≈üarƒ±lƒ± stratejileri ${worstDay.name}'ya da uygulayƒ±n. √ñzel kampanyalar d√ºzenleyin.`
                    });
                }
            }
            
            if (topSpHour) {
                const bestHourInRange = topSpHour.hour >= storeHours.openHour && topSpHour.hour < storeHours.closeHour;
                if (bestHourInRange) {
                    insights.recommendations.push({
                        icon: '‚è∞',
                        title: 'Saat Bazlƒ± Planlama',
                        description: `${topSpHour.sp} saat ${topSpHour.hour}:00'da en ba≈üarƒ±lƒ±. Vardiya planlamasƒ±nƒ± buna g√∂re optimize edin. (√áalƒ±≈üma saatleri: ${storeHours.openHour}:00-${storeHours.closeHour}:00)`
                    });
                }
            }
            
            // Zayƒ±f saat dilimi √∂nerisi kaldƒ±rƒ±ldƒ± - maƒüazalar 20:00-22:00 kapanƒ±yor
            // Perakende maƒüazalar: T√ºnel, Mavibah√ße, Kƒ±zƒ±lay, ƒ∞zmir: 20:00
            // Diƒüer perakende maƒüazalar: 22:00
            
            insights.recommendations.push({
                icon: 'üéØ',
                title: 'Stok Y√∂netimi',
                description: `En √ßok satan markalar: ${topBrands.map(b => b[0]).join(', ')}. Bu markalarƒ±n stok seviyelerini takip edin.`
            });
            
            insights.recommendations.push({
                icon: 'üë•',
                title: 'Ekip Y√∂netimi',
                description: `En ba≈üarƒ±lƒ± temsilci ${topSP[0][0]}. Ba≈üarƒ± hikayesini diƒüer ekip √ºyeleriyle payla≈üƒ±n.`
            });
            
            let html = `<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">`;
            
            if (insights.positive.length > 0) {
                html += `<div class="analysis-section"><h3 style="color: white; margin-top: 0;">‚úÖ G√º√ßl√º Y√∂nler</h3>`;
                insights.positive.forEach(item => {
                    html += `<div class="insight-item" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                        <strong style="font-size: 1.1em;">${item.title}</strong><br>
                        <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                    </div>`;
                });
                html += `</div>`;
            }
            
            if (insights.neutral.length > 0) {
                html += `<div class="analysis-section" style="margin-top: 25px;"><h3 style="color: white;">üí° √ñnemli Bilgiler</h3>`;
                insights.neutral.forEach(item => {
                    html += `<div class="insight-item" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700;">
                        <strong style="font-size: 1.1em;">${item.title}</strong><br>
                        <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                    </div>`;
                });
                html += `</div>`;
            }
            
            if (insights.recommendations.length > 0) {
                html += `<div class="analysis-section" style="margin-top: 25px;"><h3 style="color: white;">üéØ √ñneriler</h3>`;
                insights.recommendations.forEach(item => {
                    html += `<div class="recommendation" style="background: rgba(255, 255, 255, 0.15); padding: 18px; border-radius: 10px; margin: 12px 0;">
                        <span style="font-size: 1.8em; margin-right: 12px;">${item.icon}</span>
                        <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px);">
                            <strong style="font-size: 1.15em; display: block; margin-bottom: 8px;">${item.title}</strong>
                            <p style="margin: 0; opacity: 0.95; line-height: 1.6;">${item.description}</p>
                        </div>
                    </div>`;
                });
                html += `</div>`;
            }
            
            html += `</div>`;
            document.getElementById('storeAIAnalysisContent').innerHTML = html;
        }
        
        // ==================== CITY ANALYSIS TAB ====================
        let cityBrandChartInstance = null;
        let cityProductChartInstance = null;
        let cityCategoryChartInstance = null;
        let cityMonthlyChartInstance = null;
        
        function populateCitySelect() {
            // Veri y√ºklenmemi≈üse uyarƒ± ver
            if (!allData || allData.length === 0) {
                console.warn('‚ö†Ô∏è ≈ûehir listesi doldurulamadƒ±: Veri hen√ºz y√ºklenmedi');
                return;
            }
            
            const cities = new Set();
            allData.forEach(item => {
                if (item.partner_city) cities.add(item.partner_city);  // ƒ∞L bilgisi (state_id)
            });
            
            const select = document.getElementById('citySelect');
            if (!select) {
                console.error('‚ùå citySelect elementi bulunamadƒ±');
                return;
            }
            
            select.innerHTML = '<option value="">-- ≈ûehir Se√ßin --</option>';
            
            if (cities.size === 0) {
                console.warn('‚ö†Ô∏è Hi√ß ≈üehir verisi bulunamadƒ±');
                select.innerHTML += '<option value="" disabled>≈ûehir verisi bulunamadƒ±</option>';
                return;
            }
            
            Array.from(cities).sort().forEach(city => {
                const option = document.createElement('option');
                option.value = city;
                option.textContent = city;
                select.appendChild(option);
            });
            
            console.log('‚úÖ ≈ûehir dropdown dolduruldu:', cities.size, '≈üehir');
            console.log('üìã Dropdown i√ßeriƒüi:', select.innerHTML.substring(0, 500));
        }
        
        let targetStoresPopulated = false; // Sadece bir kez doldur
        
        function populateTargetStoreDropdowns() {
            // Veri yoksa veya zaten doldurulduysa √ßƒ±k
            if (!allData || allData.length === 0) {
                console.warn('‚ö†Ô∏è Maƒüaza dropdown doldurulamƒ±yor: Veri yok');
                return;
            }
            
            // ZATEN DOLDURULDUYSA Bƒ∞R DAHA DOLDURMA (kullanƒ±cƒ± se√ßimini korur)
            if (targetStoresPopulated) {
                console.log('‚úÖ Maƒüaza dropdown zaten dolduruldu, tekrar doldurulmayacak');
                return;
            }
            
            // Maƒüazalarƒ± topla
            const stores = new Set();
            allData.forEach(item => {
                if (item.store) stores.add(item.store);
            });
            
            const sortedStores = Array.from(stores).sort();
            
            // Yƒ±llƒ±k hedef maƒüaza dropdown
            const yearStoreSelect = document.getElementById('targetYearStore');
            const targetYearElement = document.getElementById('targetYear');
            
            if (yearStoreSelect && targetYearElement) {
                // Mevcut se√ßimi koru (localStorage'dan gelecek)
                const savedYearTargets = JSON.parse(localStorage.getItem('yearlyTargets') || '{}');
                const currentYear = targetYearElement.value;
                const savedStoreForYear = savedYearTargets[currentYear] ? Object.keys(savedYearTargets[currentYear])[0] : 'T√úM MAƒûAZALAR';
                
                yearStoreSelect.innerHTML = '<option value="T√úM MAƒûAZALAR">üè¢ T√ºm Maƒüazalar</option>';
                sortedStores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store;
                    option.textContent = store;
                    yearStoreSelect.appendChild(option);
                });
                
                // Kaydedilmi≈ü maƒüazayƒ± se√ß
                if (savedStoreForYear) {
                    yearStoreSelect.value = savedStoreForYear;
                }
            }
            
            // Aylƒ±k hedef maƒüaza dropdown
            const monthStoreSelect = document.getElementById('targetMonthStore');
            if (monthStoreSelect) {
                // Mevcut se√ßimi koru (localStorage'dan gelecek)
                const savedMonthTargets = JSON.parse(localStorage.getItem('monthlyTargets') || '{}');
                const currentYear = document.getElementById('targetYear').value;
                const currentMonth = document.getElementById('targetMonth').value;
                const savedStoreForMonth = savedMonthTargets[currentYear] && savedMonthTargets[currentYear][currentMonth] 
                    ? Object.keys(savedMonthTargets[currentYear])[0] 
                    : 'T√úM MAƒûAZALAR';
                
                monthStoreSelect.innerHTML = '<option value="T√úM MAƒûAZALAR">üè¢ T√ºm Maƒüazalar</option>';
                sortedStores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store;
                    option.textContent = store;
                    monthStoreSelect.appendChild(option);
                });
                
                // Kaydedilmi≈ü maƒüazayƒ± se√ß
                if (savedStoreForMonth) {
                    monthStoreSelect.value = savedStoreForMonth;
                }
            }
            
            targetStoresPopulated = true;
            console.log('‚úÖ Hedef takip maƒüaza dropdownlarƒ± dolduruldu:', stores.size, 'maƒüaza');
        }
        
        // ==================== ƒ∞L√áE NORMALIZASYON Sƒ∞STEMƒ∞ ====================
        // Levenshtein Distance - Harf hatalarƒ±nƒ± tespit eder
        function levenshteinDistance(str1, str2) {
            const len1 = str1.length;
            const len2 = str2.length;
            const matrix = [];
            
            for (let i = 0; i <= len1; i++) {
                matrix[i] = [i];
            }
            for (let j = 0; j <= len2; j++) {
                matrix[0][j] = j;
            }
            
            for (let i = 1; i <= len1; i++) {
                for (let j = 1; j <= len2; j++) {
                    if (str1[i - 1] === str2[j - 1]) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1, // substitution
                            matrix[i][j - 1] + 1,     // insertion
                            matrix[i - 1][j] + 1      // deletion
                        );
                    }
                }
            }
            
            return matrix[len1][len2];
        }
        
        // T√ºrk√ße karakter normalizasyonu
        function normalizeTurkish(str) {
            if (!str) return '';
            const turkishMap = {
                'ƒ±': 'i', 'ƒ∞': 'i',
                '≈ü': 's', '≈û': 's',
                'ƒü': 'g', 'ƒû': 'g',
                '√º': 'u', '√ú': 'u',
                '√∂': 'o', '√ñ': 'o',
                '√ß': 'c', '√á': 'c'
            };
            
            return str
                .toLowerCase()
                .trim()
                .split('')
                .map(char => turkishMap[char] || char)
                .join('');
        }
        
        // ƒ∞l√ße adƒ±nƒ± d√ºzelt (Fuzzy Matching)
        function normalizeDistrictName(districtName, masterList) {
            if (!districtName || districtName === 'Bilinmeyen') return districtName;
            
            // Direkt e≈üle≈üme varsa d√∂nd√ºr (performans)
            if (masterList.includes(districtName)) return districtName;
            
            // Normalize edilmi≈ü versiyonu
            const normalized = normalizeTurkish(districtName);
            
            let bestMatch = districtName;
            let bestScore = Infinity;
            const threshold = 4; // Maksimum 4 harf farkƒ± (artƒ±rƒ±ldƒ±)
            
            for (const master of masterList) {
                const masterNormalized = normalizeTurkish(master);
                const distance = levenshteinDistance(normalized, masterNormalized);
                
                // Benzerlik skoru
                const similarity = 1 - (distance / Math.max(normalized.length, masterNormalized.length));
                
                // %65'ten fazla benzer VE 4'ten az harf farkƒ± (daha toleranslƒ±)
                if (distance < bestScore && distance <= threshold && similarity >= 0.65) {
                    bestScore = distance;
                    bestMatch = master;
                }
            }
            
            // Eƒüer hi√ß e≈üle≈üme yoksa, en y√ºksek benzerlik oranƒ±na bak (threshold olmadan)
            if (bestMatch === districtName && masterList.length > 0) {
                let maxSimilarity = 0;
                for (const master of masterList) {
                    const masterNormalized = normalizeTurkish(master);
                    const distance = levenshteinDistance(normalized, masterNormalized);
                    const similarity = 1 - (distance / Math.max(normalized.length, masterNormalized.length));
                    
                    // En az %60 benzer ise kabul et
                    if (similarity > maxSimilarity && similarity >= 0.6) {
                        maxSimilarity = similarity;
                        bestMatch = master;
                        bestScore = distance;
                    }
                }
            }
            
            if (bestMatch !== districtName) {
                console.log(`üîß ƒ∞l√ße d√ºzeltildi: "${districtName}" ‚Üí "${bestMatch}" (distance: ${bestScore})`);
            }
            
            return bestMatch;
        }
        
        function clearCityFilters() {
            document.getElementById('citySelect').value = '';
            document.getElementById('districtSelect').value = '';
            document.getElementById('districtSelect').innerHTML = '<option value="">-- √ñnce ≈ûehir Se√ßin --</option>';
            document.getElementById('districtSelect').disabled = true;
            document.getElementById('cityDateStart').value = '';
            document.getElementById('cityDateEnd').value = '';
            document.getElementById('cityAnalysisContainer').style.display = 'none';
            console.log('üóëÔ∏è ≈ûehir ve il√ße filtreleri temizlendi');
        }
        
        // ≈ûehir se√ßildiƒüinde il√ßeleri doldur
        function handleCityChange() {
            const selectedCity = document.getElementById('citySelect').value;
            const districtSelect = document.getElementById('districtSelect');
            
            console.log('üìç ≈ûehir deƒüi≈üti:', selectedCity);
            
            if (!selectedCity) {
                // ≈ûehir se√ßimi iptal edildi
                districtSelect.innerHTML = '<option value="">-- √ñnce ≈ûehir Se√ßin --</option>';
                districtSelect.disabled = true;
                analyzeCityPerformance();
                return;
            }
            
            // Se√ßilen ≈üehirdeki ham il√ßeleri topla
            const rawDistricts = new Set();
            allData.forEach(item => {
                // partner_city = ƒ∞L (state_id) - ≈ûehir kontrol√º i√ßin
                // city = ƒ∞L√áE/SEMT (res.partner.city) - ƒ∞l√ße verisi i√ßin
                if (item.partner_city === selectedCity && item.city && item.city.length > 0) {
                    rawDistricts.add(item.city);
                }
            });
            
            console.log('üèòÔ∏è Ham il√ße sayƒ±sƒ±:', rawDistricts.size);
            console.log('üìã ƒ∞lk 10 il√ße √∂rneƒüi:', Array.from(rawDistricts).slice(0, 10));
            
            // ƒ∞l√ßeleri normalize et (yanlƒ±≈ü yazƒ±mlarƒ± d√ºzelt)
            const districtArray = Array.from(rawDistricts);
            const normalizedDistricts = new Map(); // Normalize edilmi≈ü ‚Üí Orijinal
            
            // ƒ∞lk ge√ßi≈ü: T√ºm il√ßeleri normalize et
            districtArray.forEach(district => {
                const normalized = normalizeDistrictName(district, districtArray);
                if (!normalizedDistricts.has(normalized)) {
                    normalizedDistricts.set(normalized, normalized);
                }
            });
            
            const sortedDistricts = Array.from(normalizedDistricts.keys()).sort();
            console.log('üèòÔ∏è Normalize edilmi≈ü il√ße sayƒ±sƒ±:', sortedDistricts.length);
            
            // ƒ∞l√ße dropdown'ƒ±nƒ± doldur
            districtSelect.innerHTML = '<option value="">-- T√ºm ƒ∞l√ßeler --</option>';
            sortedDistricts.forEach(district => {
                const option = document.createElement('option');
                option.value = district;
                option.textContent = district;
                districtSelect.appendChild(option);
            });
            
            districtSelect.disabled = sortedDistricts.length === 0;
            
            // Analizi √ßalƒ±≈ütƒ±r
            analyzeCityPerformance();
        }
        
        // T√ºrkiye 81 ƒ∞l N√ºfuslarƒ± (2024 T√úƒ∞K)
        const cityPopulations = {
            // Her ≈üehir i√ßin hem d√ºz hem de "(TR)" sonekli versiyonu ekledik
            'ƒ∞stanbul': 15907951, 'ƒ∞stanbul (TR)': 15907951,
            'Ankara': 5803482, 'Ankara (TR)': 5803482,
            'ƒ∞zmir': 4462056, 'ƒ∞zmir (TR)': 4462056,
            'Bursa': 3194720, 'Bursa (TR)': 3194720,
            'Antalya': 2688004, 'Antalya (TR)': 2688004,
            'Adana': 2274106, 'Adana (TR)': 2274106,
            'Konya': 2305609, 'Konya (TR)': 2305609,
            'Gaziantep': 2154051, 'Gaziantep (TR)': 2154051,
            '≈ûanlƒ±urfa': 2155805, '≈ûanlƒ±urfa (TR)': 2155805,
            'Kocaeli': 2102907, 'Kocaeli (TR)': 2102907,
            'Mersin': 1938389, 'Mersin (TR)': 1938389,
            'Diyarbakƒ±r': 1804880, 'Diyarbakƒ±r (TR)': 1804880,
            'Hatay': 1686043, 'Hatay (TR)': 1686043,
            'Manisa': 1468279, 'Manisa (TR)': 1468279,
            'Kayseri': 1434357, 'Kayseri (TR)': 1434357,
            'Samsun': 1368488, 'Samsun (TR)': 1368488,
            'Balƒ±kesir': 1257590, 'Balƒ±kesir (TR)': 1257590,
            'Kahramanmara≈ü': 1168163, 'Kahramanmara≈ü (TR)': 1168163,
            'Van': 1136757, 'Van (TR)': 1136757,
            'Aydƒ±n': 1148241, 'Aydƒ±n (TR)': 1148241,
            'Denizli': 1058663, 'Denizli (TR)': 1058663,
            'Sakarya': 1080080, 'Sakarya (TR)': 1080080,
            'Tekirdaƒü': 1158149, 'Tekirdaƒü (TR)': 1158149,
            'Muƒüla': 1042669, 'Muƒüla (TR)': 1042669,
            'Eski≈üehir': 906617, 'Eski≈üehir (TR)': 906617,
            'Mardin': 870374, 'Mardin (TR)': 870374,
            'Malatya': 812580, 'Malatya (TR)': 812580,
            'Erzurum': 760476, 'Erzurum (TR)': 760476,
            'Trabzon': 818023, 'Trabzon (TR)': 818023,
            'Elazƒ±ƒü': 602877, 'Elazƒ±ƒü (TR)': 602877,
            '≈ûƒ±rnak': 542743, '≈ûƒ±rnak (TR)': 542743,
            'Ordu': 769854, 'Ordu (TR)': 769854,
            'K√ºtahya': 589524, 'K√ºtahya (TR)': 589524,
            'Afyonkarahisar': 754854, 'Afyonkarahisar (TR)': 754854,
            'Tokat': 617062, 'Tokat (TR)': 617062,
            '√áorum': 530126, '√áorum (TR)': 530126,
            'Sivas': 643864, 'Sivas (TR)': 643864,
            'Zonguldak': 588510, 'Zonguldak (TR)': 588510,
            'Aksaray': 433229, 'Aksaray (TR)': 433229,
            'Batman': 634491, 'Batman (TR)': 634491,
            'Isparta': 446102, 'Isparta (TR)': 446102,
            '√áanakkale': 557099, '√áanakkale (TR)': 557099,
            'U≈üak': 378115, 'U≈üak (TR)': 378115,
            'D√ºzce': 405285, 'D√ºzce (TR)': 405285,
            'Osmaniye': 558016, 'Osmaniye (TR)': 558016,
            'Amasya': 338267, 'Amasya (TR)': 338267,
            'Giresun': 453912, 'Giresun (TR)': 453912,
            'Kƒ±rƒ±kkale': 286602, 'Kƒ±rƒ±kkale (TR)': 286602,
            'Edirne': 413903, 'Edirne (TR)': 413903,
            'Kƒ±r≈üehir': 250120, 'Kƒ±r≈üehir (TR)': 250120,
            'Bolu': 320014, 'Bolu (TR)': 320014,
            'Adƒ±yaman': 635286, 'Adƒ±yaman (TR)': 635286,
            'Kƒ±rklareli': 368872, 'Kƒ±rklareli (TR)': 368872,
            'Yozgat': 424981, 'Yozgat (TR)': 424981,
            'Nev≈üehir': 310538, 'Nev≈üehir (TR)': 310538,
            'Burdur': 273799, 'Burdur (TR)': 273799,
            'Karaman': 262997, 'Karaman (TR)': 262997,
            'Kilis': 147887, 'Kilis (TR)': 147887,
            'Aƒürƒ±': 528744, 'Aƒürƒ± (TR)': 528744,
            'Niƒüde': 365419, 'Niƒüde (TR)': 365419,
            'Kastamonu': 383373, 'Kastamonu (TR)': 383373,
            'Artvin': 170875, 'Artvin (TR)': 170875,
            'Siirt': 331070, 'Siirt (TR)': 331070,
            'Bilecik': 228673, 'Bilecik (TR)': 228673,
            'Sinop': 218273, 'Sinop (TR)': 218273,
            'Rize': 348608, 'Rize (TR)': 348608,
            'Karab√ºk': 248014, 'Karab√ºk (TR)': 248014,
            'Yalova': 291001, 'Yalova (TR)': 291001,
            'Bartƒ±n': 198999, 'Bartƒ±n (TR)': 198999,
            'Mu≈ü': 408728, 'Mu≈ü (TR)': 408728,
            'Bitlis': 353988, 'Bitlis (TR)': 353988,
            'Erzincan': 236034, 'Erzincan (TR)': 236034,
            'Hakkari': 287625, 'Hakkari (TR)': 287625,
            'Ardahan': 94932, 'Ardahan (TR)': 94932,
            'Iƒüdƒ±r': 201314, 'Iƒüdƒ±r (TR)': 201314,
            'Kars': 281869, 'Kars (TR)': 281869,
            'G√ºm√º≈ühane': 164521, 'G√ºm√º≈ühane (TR)': 164521,
            '√áankƒ±rƒ±': 195766, '√áankƒ±rƒ± (TR)': 195766,
            'Tunceli': 89266, 'Tunceli (TR)': 89266,
            'Bayburt': 84843, 'Bayburt (TR)': 84843
        };
        
        function analyzeCityPerformance() {
            const selectedCity = document.getElementById('citySelect').value;
            const selectedDistrict = document.getElementById('districtSelect').value;
            const dateStart = document.getElementById('cityDateStart').value;
            const dateEnd = document.getElementById('cityDateEnd').value;
            
            if (!selectedCity) {
                document.getElementById('cityAnalysisContainer').style.display = 'none';
                return;
            }
            
            console.log('üåç ≈ûehir analizi:', selectedCity, selectedDistrict ? `/ ${selectedDistrict}` : '', 'Tarih:', dateStart, '-', dateEnd);
            
            // Se√ßilen ≈üehirdeki t√ºm il√ßeleri topla (normalize i√ßin)
            const allDistrictsInCity = [];
            if (selectedDistrict) {
                allData.forEach(item => {
                    // partner_city = ƒ∞L, city = ƒ∞L√áE
                    if (item.partner_city === selectedCity && item.city) {
                        allDistrictsInCity.push(item.city);
                    }
                });
            }
            
            // ≈ûehir verilerini filtrele (≈üehir + il√ße + tarih) - NORMALƒ∞ZE EDƒ∞LMƒ∞≈û
            const cityData = allData.filter(item => {
                // ≈ûehir kontrol√º (partner_city = ƒ∞L)
                if (item.partner_city !== selectedCity) return false;
                
                // ƒ∞l√ße kontrol√º (se√ßiliyse) - NORMALƒ∞ZE ET (city = ƒ∞L√áE)
                if (selectedDistrict && item.city) {
                    const normalizedItemDistrict = normalizeDistrictName(item.city, allDistrictsInCity);
                    if (normalizedItemDistrict !== selectedDistrict) return false;
                } else if (selectedDistrict && !item.city) {
                    return false;
                }
                
                // Tarih filtresi
                if (dateStart && item.date < dateStart) return false;
                if (dateEnd && item.date > dateEnd) return false;
                
                return true;
            });
            
            if (cityData.length === 0) {
                alert('Bu ≈üehir i√ßin veri bulunamadƒ±');
                return;
            }
            
            // √ñzet bilgileri hesapla
            const totalSales = cityData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = cityData.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const uniqueCustomers = new Set(cityData.map(item => item.partner)).size;
            const uniqueDates = new Set(cityData.map(item => item.date)).size;
            const uniqueInvoices = new Set(cityData.filter(item => item.move_type === 'out_invoice').map(item => item.move_name).filter(Boolean)).size;
            const avgBasket = totalSales / Math.max(uniqueInvoices, 1); // Ger√ßek sepet ortalamasƒ±: Sadece satƒ±≈ü faturalarƒ± (ƒ∞adeler hari√ß)
            const dailyAverage = totalSales / Math.max(uniqueDates, 1); // G√ºnl√ºk ortalama satƒ±≈ü
            
            console.log('üåç ≈ûehir Analizi - Sepet Ortalamasƒ± Hesaplama:');
            console.log('   üì¶ Toplam Kayƒ±t:', cityData.length);
            console.log('   üßæ Fatura Sayƒ±sƒ±:', uniqueInvoices);
            console.log('   üí∞ Toplam Satƒ±≈ü:', totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2}));
            console.log('   üõí Sepet Ortalamasƒ±:', avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2}), '(', totalSales.toLocaleString('tr-TR'), '/', uniqueInvoices, ')');
            
            // En √ßok satƒ±≈ü yapan temsilci
            const salespersonData = {};
            cityData.forEach(item => {
                const salesperson = item.sales_person || 'Bilinmiyor';
                if (!salespersonData[salesperson]) salespersonData[salesperson] = 0;
                salespersonData[salesperson] += parseFloat(item.usd_amount || 0);
            });
            const topSalesperson = Object.entries(salespersonData).sort((a, b) => b[1] - a[1])[0];
            
            // En √ßok satƒ±≈ü yapan maƒüaza
            const storeData = {};
            cityData.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) storeData[store] = 0;
                storeData[store] += parseFloat(item.usd_amount || 0);
            });
            const topStore = Object.entries(storeData).sort((a, b) => b[1] - a[1])[0];
            
            // N√ºfus ve ki≈üi ba≈üƒ± satƒ±≈ü hesapla
            const cityPopulation = cityPopulations[selectedCity] || 0;
            const perCapitaSales = cityPopulation > 0 ? totalSales / cityPopulation : 0;
            
            // UI g√ºncelle
            document.getElementById('cityTotalSales').textContent = '$' + totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('cityTotalQty').textContent = totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('cityCustomerCount').textContent = uniqueCustomers;
            document.getElementById('cityAvgBasket').textContent = '$' + avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('cityDailyAverage').textContent = '$' + dailyAverage.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            
            // N√ºfus ve ki≈üi ba≈üƒ± satƒ±≈ü
            if (cityPopulation > 0) {
                const popInMillions = (cityPopulation / 1000000).toFixed(2);
                document.getElementById('cityPopulation').textContent = popInMillions + 'M';
                document.getElementById('cityPerCapitaSales').textContent = '$' + perCapitaSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            } else {
                document.getElementById('cityPopulation').textContent = 'Veri Yok';
                document.getElementById('cityPerCapitaSales').textContent = '-';
            }
            
            // ƒ∞lk 5 Temsilci
            const top5Salespersons = Object.entries(salespersonData).sort((a, b) => b[1] - a[1]).slice(0, 5);
            let spHTML = '';
            top5Salespersons.forEach((sp, idx) => {
                const percent = (sp[1] / totalSales * 100).toFixed(1);
                spHTML += `<div style="margin: 5px 0;">${idx + 1}. ${sp[0]}: <strong>$${sp[1].toLocaleString('tr-TR', {minimumFractionDigits: 2})}</strong> (%${percent})</div>`;
            });
            document.getElementById('cityTopSalespersons').innerHTML = spHTML;
            
            // ƒ∞lk 5 Maƒüaza
            const top5Stores = Object.entries(storeData).sort((a, b) => b[1] - a[1]).slice(0, 5);
            let storeHTML = '';
            top5Stores.forEach((store, idx) => {
                const percent = (store[1] / totalSales * 100).toFixed(1);
                storeHTML += `<div style="margin: 5px 0;">${idx + 1}. ${store[0]}: <strong>$${store[1].toLocaleString('tr-TR', {minimumFractionDigits: 2})}</strong> (%${percent})</div>`;
            });
            document.getElementById('cityTopStores').innerHTML = storeHTML;
            
            // Container'ƒ± g√∂ster
            document.getElementById('cityAnalysisContainer').style.display = 'block';
            
            // Grafikleri render et
            renderCityBrandChart(cityData);
            renderCityProductChart(cityData);
            renderCityCategoryChart(cityData);
            renderCityMonthlyChart(cityData);
            renderCityYearlyChart(cityData);
            
            // AI analiz
            performCityAIAnalysis(cityData, selectedCity, {totalSales, totalQty, uniqueCustomers, avgBasket});
        }
        
        function renderCityBrandChart(data) {
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = {sales: 0, qty: 0};
                brandData[brand].sales += parseFloat(item.usd_amount || 0);
                brandData[brand].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(brandData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('cityBrandChart');
            if (!ctx) return;
            
            if (cityBrandChartInstance) {
                cityBrandChartInstance.destroy();
            }
            
            cityBrandChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD - KDV Hari√ß)',
                        data: salesValues,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'}
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function renderCityProductChart(data) {
            const productData = {};
            data.forEach(item => {
                const product = item.product || 'Bilinmiyor';
                if (!productData[product]) productData[product] = {sales: 0, qty: 0};
                productData[product].sales += parseFloat(item.usd_amount || 0);
                productData[product].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(productData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0].substring(0, 30) + (item[0].length > 30 ? '...' : ''));
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('cityProductChart');
            if (!ctx) return;
            
            if (cityProductChartInstance) {
                cityProductChartInstance.destroy();
            }
            
            cityProductChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD - KDV Hari√ß)',
                        data: salesValues,
                        backgroundColor: 'rgba(56, 239, 125, 0.6)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'}
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function renderCityCategoryChart(data) {
            const categoryData = {};
            data.forEach(item => {
                // category_2 kullan, ALL/Analitik/Eƒüitim atla
                const category = item.category_2 || 'Bilinmiyor';
                if (category.toLowerCase() === 'all' || category.toLowerCase().includes('analitik') || category.toLowerCase().includes('eƒüitim')) {
                    return;
                }
                if (!categoryData[category]) categoryData[category] = {sales: 0, qty: 0};
                categoryData[category].sales += parseFloat(item.usd_amount || 0);
                categoryData[category].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(categoryData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('cityCategoryChart');
            if (!ctx) return;
            
            if (cityCategoryChartInstance) {
                cityCategoryChartInstance.destroy();
            }
            
            cityCategoryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD - KDV Hari√ß)',
                        data: salesValues,
                        backgroundColor: 'rgba(245, 87, 108, 0.6)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'}
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function renderCityMonthlyChart(data) {
            const monthlyData = {};
            data.forEach(item => {
                const date = new Date(item.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[monthKey]) monthlyData[monthKey] = 0;
                monthlyData[monthKey] += parseFloat(item.usd_amount || 0);
            });
            
            const sorted = Object.entries(monthlyData).sort((a, b) => a[0].localeCompare(b[0]));
            const labels = sorted.map(item => item[0]);
            const values = sorted.map(item => item[1]);
            
            const ctx = document.getElementById('cityMonthlyChart');
            if (!ctx) return;
            
            if (cityMonthlyChartInstance) {
                cityMonthlyChartInstance.destroy();
            }
            
            cityMonthlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Aylƒ±k Satƒ±≈ü (USD)',
                        data: values,
                        borderColor: 'rgba(102, 126, 234, 1)',
                        backgroundColor: 'rgba(102, 126, 234, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        let cityYearlyChartInstance = null;
        
        function renderCityYearlyChart(data) {
            // Yƒ±l bazƒ±nda aylƒ±k grupla (kar≈üƒ±la≈ütƒ±rma i√ßin - satƒ±≈ü temsilcisi gibi)
            const yearlyMonthlyData = {};
            data.forEach(item => {
                const date = new Date(item.date);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                
                if (!yearlyMonthlyData[year]) yearlyMonthlyData[year] = {};
                if (!yearlyMonthlyData[year][month]) yearlyMonthlyData[year][month] = 0;
                yearlyMonthlyData[year][month] += parseFloat(item.usd_amount || 0);
            });
            
            // T√ºm aylarƒ± topla
            const allMonthKeys = new Set();
            Object.values(yearlyMonthlyData).forEach(yearData => {
                Object.keys(yearData).forEach(month => allMonthKeys.add(month));
            });
            const sortedMonths = Array.from(allMonthKeys).sort();
            
            // Dataset olu≈ütur (her yƒ±l i√ßin farklƒ± renk)
            const datasets = [];
            const colors = [
                {border: 'rgba(102, 126, 234, 1)', bg: 'rgba(102, 126, 234, 0.1)'},
                {border: 'rgba(245, 87, 108, 1)', bg: 'rgba(245, 87, 108, 0.1)'},
                {border: 'rgba(56, 239, 125, 1)', bg: 'rgba(56, 239, 125, 0.1)'},
                {border: 'rgba(255, 206, 86, 1)', bg: 'rgba(255, 206, 86, 0.1)'}
            ];
            
            Object.keys(yearlyMonthlyData).sort().forEach((year, idx) => {
                const yearData = yearlyMonthlyData[year];
                const values = sortedMonths.map(month => yearData[month] || 0);
                const color = colors[idx % colors.length];
                
                datasets.push({
                    label: `${year} Satƒ±≈ülarƒ±`,
                    data: values,
                    borderColor: color.border,
                    backgroundColor: color.bg,
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                });
            });
            
            const ctx = document.getElementById('cityYearlyChart');
            if (!ctx) return;
            
            if (cityYearlyChartInstance) {
                cityYearlyChartInstance.destroy();
            }
            
            // Ay isimlerini g√∂ster
            const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 
                               'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            const labels = sortedMonths.map(m => monthNames[parseInt(m) - 1]);
            
            cityYearlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'},
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.dataset.label + ': $' + context.parsed.y.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function performCityAIAnalysis(data, cityName, stats) {
            console.log('ü§ñ ≈ûehir AI analizi ba≈ülatƒ±lƒ±yor...');
            
            // Marka analizi
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += parseFloat(item.usd_amount || 0);
            });
            const topBrands = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 3);
            
            // Kategori analizi (category_2 kullanƒ±yoruz)
            const categoryData = {};
            data.forEach(item => {
                const category = item.category_2 || 'Bilinmiyor';
                if (!categoryData[category]) categoryData[category] = 0;
                categoryData[category] += parseFloat(item.usd_amount || 0);
            });
            const topCategories = Object.entries(categoryData).sort((a, b) => b[1] - a[1]).slice(0, 3);
            
            const insights = {
                positive: [],
                negative: [],
                neutral: [],
                recommendations: []
            };
            
            // Pozitif i√ßg√∂r√ºler
            if (topBrands.length > 0) {
                const topBrand = topBrands[0];
                const brandShare = (topBrand[1] / stats.totalSales * 100).toFixed(1);
                insights.positive.push({
                    title: `üè∑Ô∏è ${topBrand[0]} Lider Marka`,
                    description: `${cityName} ilinde ${topBrand[0]} markasƒ± %${brandShare} pay ile lider ($${topBrand[1].toLocaleString('tr-TR', {minimumFractionDigits: 2})}).`
                });
            }
            
            if (topCategories.length > 0) {
                const topCategory = topCategories[0];
                const catShare = (topCategory[1] / stats.totalSales * 100).toFixed(1);
                insights.positive.push({
                    title: `üìÇ ${topCategory[0]} En Pop√ºler Kategori`,
                    description: `${cityName} ilinde ${topCategory[0]} kategorisi %${catShare} pay ile en √ßok tercih edilen ($${topCategory[1].toLocaleString('tr-TR', {minimumFractionDigits: 2})}).`
                });
            }
            
            // N√∂tr bilgiler
            insights.neutral.push({
                title: `üìä ${cityName} Genel Performans`,
                description: `Toplam ${stats.uniqueCustomers} m√º≈üteri, $${stats.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} satƒ±≈ü ger√ßekle≈ütirdi. Ortalama sepet deƒüeri $${stats.avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2})}.`
            });
            
            if (topBrands.length >= 3) {
                insights.neutral.push({
                    title: `üè∑Ô∏è Top 3 Marka`,
                    description: `${topBrands.map(b => b[0]).join(', ')} markalarƒ± ${cityName} ilinde en √ßok tercih ediliyor.`
                });
            }
            
            // √ñneriler
            insights.recommendations.push({
                icon: 'üì¶',
                title: 'Stok Optimizasyonu',
                description: `${cityName} ilindeki maƒüazalarda ${topBrands[0][0]} markasƒ± ve ${topCategories[0][0]} kategorisi √ºr√ºnlerinin stok seviyesini artƒ±rƒ±n.`
            });
            
            insights.recommendations.push({
                icon: 'üì¢',
                title: 'B√∂lgesel Kampanya',
                description: `${cityName} ili i√ßin ${topBrands[0][0]} markasƒ±nda √∂zel kampanya d√ºzenleyin. Bu b√∂lgede y√ºksek talep var.`
            });
            
            insights.recommendations.push({
                icon: 'üéØ',
                title: 'M√º≈üteri Segmentasyonu',
                description: `${cityName} ilindeki ${stats.uniqueCustomers} m√º≈üteriye √∂zel e-posta kampanyalarƒ± g√∂nderin. Tercih ettikleri kategorilerdeki yeni √ºr√ºnleri tanƒ±tƒ±n.`
            });
            
            // HTML olu≈ütur
            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">
                    ${insights.positive.length > 0 ? `
                    <div class="analysis-section">
                        <h3 style="color: white; margin-top: 0;">‚úÖ ${cityName} G√º√ßl√º Y√∂nler</h3>
                        ${insights.positive.map(item => `
                            <div class="insight-item insight-positive" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">‚úÖ</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.neutral.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">üí° Genel Bilgiler</h3>
                        ${insights.neutral.map(item => `
                            <div class="insight-item insight-neutral" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">üí°</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">üéØ Aksiyon √ñnerileri</h3>
                        ${insights.recommendations.map(item => `
                            <div class="recommendation" style="background: rgba(255, 255, 255, 0.15); padding: 18px; border-radius: 10px; margin: 12px 0;">
                                <span class="recommendation-icon" style="font-size: 1.8em; margin-right: 12px;">${item.icon}</span>
                                <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px);">
                                    <strong style="font-size: 1.15em; display: block; margin-bottom: 8px;">${item.title}</strong>
                                    <p style="margin: 0; opacity: 0.95; line-height: 1.6;">${item.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('cityAIAnalysisContent').innerHTML = html;
        }
        
        // ==================== STOCK DISTRIBUTION TAB ====================
        let stockList = [];  // {product_code: string, qty: number}
        
        function handleStockExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // Boyut kontrol√º (5 MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Dosya √ßok b√ºy√ºk! Maksimum 5 MB olmalƒ±dƒ±r.');
                return;
            }
            
            // Tip kontrol√º
            const validTypes = [
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/vnd.ms-excel'
            ];
            if (!validTypes.includes(file.type)) {
                alert('Sadece Excel dosyalarƒ± (.xlsx, .xls) y√ºkleyebilirsiniz.');
                return;
            }
            
            console.log('üìÑ Excel dosyasƒ± okunuyor...');
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const json = XLSX.utils.sheet_to_json(sheet);
                    
                    console.log('üìä Excel verisi:', json);
                    
                    // Veriyi i≈üle
                    stockList = [];
                    json.forEach(row => {
                        // Farklƒ± kolon isimleri i√ßin esnek yakla≈üƒ±m
                        const productCode = row['√úr√ºn Kodu'] || row['product_code'] || row['Product Code'] || row['Kod'] || row['Code'];
                        const qty = row['Stok Miktarƒ±'] || row['stock'] || row['Stock'] || row['Miktar'] || row['Quantity'] || row['qty'];
                        
                        if (productCode && qty) {
                            stockList.push({
                                product_code: String(productCode).trim(),
                                qty: parseFloat(qty)
                            });
                        }
                    });
                    
                    if (stockList.length === 0) {
                        alert('Excel dosyasƒ±nda ge√ßerli veri bulunamadƒ±! Kolon isimleri: "√úr√ºn Kodu" ve "Stok Miktarƒ±" olmalƒ±.');
                        return;
                    }
                    
                    console.log('‚úÖ Stok listesi y√ºklendi:', stockList.length, '√ºr√ºn');
                    renderStockList();
                    
                } catch (error) {
                    console.error('‚ùå Excel okuma hatasƒ±:', error);
                    alert('Excel dosyasƒ± okunamadƒ±! L√ºtfen dosya formatƒ±nƒ± kontrol edin.');
                }
            };
            reader.readAsArrayBuffer(file);
        }
        
        function addManualStock() {
            const productCode = document.getElementById('manualProductCode').value.trim();
            const qty = parseFloat(document.getElementById('manualStockQty').value);
            
            if (!productCode) {
                alert('L√ºtfen √ºr√ºn kodu girin');
                return;
            }
            
            if (isNaN(qty) || qty <= 0) {
                alert('L√ºtfen ge√ßerli bir stok miktarƒ± girin');
                return;
            }
            
            // Aynƒ± √ºr√ºn varsa g√ºncelle
            const existingIndex = stockList.findIndex(item => item.product_code === productCode);
            if (existingIndex >= 0) {
                stockList[existingIndex].qty = qty;
            } else {
                stockList.push({product_code: productCode, qty: qty});
            }
            
            // Inputlarƒ± temizle
            document.getElementById('manualProductCode').value = '';
            document.getElementById('manualStockQty').value = '';
            
            console.log('‚úÖ Stok eklendi:', productCode, qty);
            renderStockList();
        }
        
        function renderStockList() {
            if (stockList.length === 0) {
                document.getElementById('stockListContainer').style.display = 'none';
                return;
            }
            
            document.getElementById('stockListContainer').style.display = 'block';
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left;">#</th>
                            <th style="padding: 15px; text-align: left;">√úr√ºn Kodu</th>
                            <th style="padding: 15px; text-align: right;">Stok Miktarƒ±</th>
                            <th style="padding: 15px; text-align: center;">ƒ∞≈ülem</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            stockList.forEach((item, index) => {
                html += `
                    <tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                        <td style="padding: 12px;">${index + 1}</td>
                        <td style="padding: 12px;"><strong>${item.product_code}</strong></td>
                        <td style="padding: 12px; text-align: right;">${item.qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="removeStock(${index})" style="background: #dc3545; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">
                                üóëÔ∏è Sil
                            </button>
                        </td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('stockListTable').innerHTML = html;
        }
        
        function removeStock(index) {
            stockList.splice(index, 1);
            renderStockList();
        }
        
        function clearStockList() {
            if (confirm('T√ºm stok listesini temizlemek istediƒüinize emin misiniz?')) {
                stockList = [];
                renderStockList();
                document.getElementById('stockDistributionResults').style.display = 'none';
            }
        }
        
        function analyzeStockDistribution() {
            if (stockList.length === 0) {
                alert('√ñnce stok listesi y√ºkleyin veya manuel giri≈ü yapƒ±n');
                return;
            }
            
            console.log('ü§ñ AI stok daƒüƒ±lƒ±m analizi ba≈ülatƒ±lƒ±yor...');
            
            // Tarih filtrelerini al
            const dateStart = document.getElementById('stockDateStart').value;
            const dateEnd = document.getElementById('stockDateEnd').value;
            
            console.log('üìÖ Tarih Filtreleri:', {dateStart, dateEnd});
            
            const recommendations = [];
            
            stockList.forEach(stockItem => {
                // Bu √ºr√ºn kodunu i√ßeren satƒ±≈ülarƒ± bul (tarih filtresiyle)
                let productSales = allData.filter(item => 
                    item.product && item.product.toLowerCase().includes(stockItem.product_code.toLowerCase())
                );
                
                // Tarih filtresi uygula (opsiyonel)
                if (dateStart) {
                    productSales = productSales.filter(item => item.date >= dateStart);
                }
                if (dateEnd) {
                    productSales = productSales.filter(item => item.date <= dateEnd);
                }
                
                if (productSales.length === 0) {
                    recommendations.push({
                        productCode: stockItem.product_code,
                        totalStock: stockItem.qty,
                        distribution: [],
                        message: `‚ö†Ô∏è "${stockItem.product_code}" i√ßin ge√ßmi≈ü satƒ±≈ü verisi bulunamadƒ±. E≈üit daƒüƒ±lƒ±m √∂neriliyor.`,
                        noData: true
                    });
                    return;
                }
                
                // Maƒüaza bazƒ±nda satƒ±≈ü analizi (son 3 ay)
                const storePerformance = {};
                productSales.forEach(item => {
                    const store = item.store || 'Bilinmiyor';
                    if (!storePerformance[store]) {
                        storePerformance[store] = {qty: 0, sales: 0};
                    }
                    storePerformance[store].qty += parseFloat(item.quantity || 0);
                    storePerformance[store].sales += parseFloat(item.usd_amount || 0);
                });
                
                // Toplam satƒ±≈ü
                const totalSold = Object.values(storePerformance).reduce((sum, s) => sum + s.qty, 0);
                
                // Y√ºzde daƒüƒ±lƒ±m hesapla
                const distribution = [];
                Object.entries(storePerformance).forEach(([store, data]) => {
                    const percentage = data.qty / totalSold;
                    const recommendedQty = Math.round(stockItem.qty * percentage);
                    distribution.push({
                        store: store,
                        historicalQty: data.qty,
                        historicalSales: data.sales,
                        percentage: (percentage * 100).toFixed(1),
                        recommendedQty: recommendedQty
                    });
                });
                
                // B√ºy√ºkten k√º√ß√ºƒüe sƒ±rala
                distribution.sort((a, b) => b.recommendedQty - a.recommendedQty);
                
                recommendations.push({
                    productCode: stockItem.product_code,
                    totalStock: stockItem.qty,
                    distribution: distribution,
                    message: `‚úÖ "${stockItem.product_code}" i√ßin ${distribution.length} maƒüazaya daƒüƒ±lƒ±m √∂nerisi hazƒ±rlandƒ±.`,
                    noData: false
                });
            });
            
            // Sonu√ßlarƒ± g√∂ster
            renderStockDistributionResults(recommendations);
        }
        
        function clearStockDateFilters() {
            document.getElementById('stockDateStart').value = '';
            document.getElementById('stockDateEnd').value = '';
            console.log('üîÑ Stok tarih filtreleri temizlendi');
        }
        
        function renderStockDistributionResults(recommendations) {
            document.getElementById('stockDistributionResults').style.display = 'block';
            
            let html = '';
            
            recommendations.forEach((rec, index) => {
                html += `
                    <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
                        <h3 style="margin: 0 0 20px 0; color: #667eea;">
                            ${index + 1}. ${rec.productCode} (Toplam Stok: ${rec.totalStock.toLocaleString('tr-TR', {minimumFractionDigits: 2})} adet)
                        </h3>
                        <p style="color: #6c757d; margin-bottom: 20px;">${rec.message}</p>
                        
                        ${rec.noData ? `
                            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107;">
                                <strong>üí° √ñneri:</strong> Ge√ßmi≈ü satƒ±≈ü verisi olmadƒ±ƒüƒ± i√ßin maƒüazalara e≈üit daƒüƒ±tƒ±m yapabilirsiniz.
                            </div>
                        ` : `
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Maƒüaza</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Ge√ßmi≈ü Satƒ±≈ü</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Pay (%)</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Mevcut Stok</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">√ñnerilen Stok</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${rec.distribution.map((dist, i) => `
                                        <tr style="border-bottom: 1px solid #eee; ${i % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                                            <td style="padding: 12px;"><strong>${dist.store}</strong></td>
                                            <td style="padding: 12px; text-align: right;">${dist.historicalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2})} adet</td>
                                            <td style="padding: 12px; text-align: right; color: #667eea; font-weight: bold;">${dist.percentage}%</td>
                                            <td style="padding: 12px; text-align: right; color: #38ef7d; font-weight: bold; font-size: 1.1em;">${dist.recommendedQty} adet</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            
                            <div style="background: #d1ecf1; padding: 20px; border-radius: 10px; border-left: 4px solid #0c5460; margin-top: 20px;">
                                <strong>ü§ñ AI √ñneri:</strong> Bu daƒüƒ±lƒ±m, ge√ßmi≈ü satƒ±≈ü performansƒ±na g√∂re optimize edilmi≈ütir. 
                                En y√ºksek satƒ±≈ü yapan maƒüazalara daha fazla stok ayrƒ±lmƒ±≈ütƒ±r.
                            </div>
                        `}
                    </div>
                `;
            });
            
            document.getElementById('stockDistributionContent').innerHTML = html;
            
            // Sonu√ßlara scroll
            document.getElementById('stockDistributionResults').scrollIntoView({behavior: 'smooth', block: 'start'});
        }
        
        // ==================== SALESPERSON ANALYSIS TAB ====================
        let salespersonBrandChartInstance = null;
        let salespersonCategoryChartInstance = null;
        let salespersonStoreChartInstance = null;
        let salespersonMonthlyChartInstance = null;
        let comparisonSalesChartInstance = null;
        let comparisonQtyChartInstance = null;
        
        // Se√ßili satƒ±≈ü temsilcileri array
        let selectedSalespersons = [];
        
        // ==================== STORE ANALYSIS TAB ====================
        let comparisonStoreSalesChartInstance = null;
        let comparisonStoreQtyChartInstance = null;
        
        // Satƒ±≈ü temsilcisi filtrelerini doldur (checkbox yapƒ±sƒ±)
        function populateSalespersonYearFilter() {
            if (!allData || allData.length === 0) return;
            
            const years = new Set();
            const months = new Set();
            const days = new Set();
            
            allData.forEach(item => {
                if (item.date) {
                    const dateParts = item.date.split('-');
                    if (dateParts.length >= 3) {
                        years.add(dateParts[0]); // YYYY
                        months.add(dateParts[1]); // MM
                        days.add(dateParts[2]); // DD
                    }
                }
            });
            
            populateMultiSelect('filterSalespersonYear', Array.from(years).sort().reverse(), 'countSalespersonYear');
            populateMultiSelect('filterSalespersonMonth', Array.from(months).sort(), 'countSalespersonMonth');
            populateMultiSelect('filterSalespersonDay', Array.from(days).sort(), 'countSalespersonDay');
        }
        
        // Satƒ±≈ü temsilcisi filtrelerini temizle
        function toggleSalespersonCustomDayRange(value) {
            const customDiv = document.getElementById('salespersonCustomDayRange');
            if (value === 'custom') {
                customDiv.style.display = 'block';
            } else {
                customDiv.style.display = 'none';
                // Hazƒ±r se√ßenekleri uygula
                if (value) {
                    const [start, end] = value.split('-');
                    document.getElementById('salespersonStartDay').value = start;
                    document.getElementById('salespersonEndDay').value = end;
                } else {
                    document.getElementById('salespersonStartDay').value = '';
                    document.getElementById('salespersonEndDay').value = '';
                }
            }
        }
        
        function clearSalespersonFilters() {
            // Checkbox'larƒ± temizle
            const yearCheckboxes = document.querySelectorAll('#filterSalespersonYear input[type="checkbox"]');
            const monthCheckboxes = document.querySelectorAll('#filterSalespersonMonth input[type="checkbox"]');
            const dayCheckboxes = document.querySelectorAll('#filterSalespersonDay input[type="checkbox"]');
            
            yearCheckboxes.forEach(cb => cb.checked = false);
            monthCheckboxes.forEach(cb => cb.checked = false);
            dayCheckboxes.forEach(cb => cb.checked = false);
            
            // Saya√ßlarƒ± g√ºncelle
            updateSelectionCount('filterSalespersonYear', 'countSalespersonYear');
            updateSelectionCount('filterSalespersonMonth', 'countSalespersonMonth');
            updateSelectionCount('filterSalespersonDay', 'countSalespersonDay');
            
            console.log('‚úÖ Satƒ±≈ü temsilcisi filtreleri temizlendi');
        }
        
        function searchSalespersonProfile() {
            // Se√ßili temsilciler varsa onlarƒ± kullan, yoksa input'tan al
            let salespersonsToSearch = [];
            
            if (selectedSalespersons.length > 0) {
                salespersonsToSearch = selectedSalespersons;
            } else {
                const searchQuery = document.getElementById('salespersonSearchInput').value.trim();
            if (!searchQuery) {
                    alert('L√ºtfen bir satƒ±≈ü temsilcisi adƒ± girin veya listeden se√ßin');
                return;
            }
            
                // Virg√ºl ile ayrƒ±lmƒ±≈ü isimleri ayƒ±r (case-insensitive arama i√ßin)
                const searchTerms = searchQuery.split(',').map(s => s.trim().toLowerCase()).filter(s => s);
                
                if (searchTerms.length === 0) {
                    alert('L√ºtfen ge√ßerli bir satƒ±≈ü temsilcisi adƒ± girin');
                    return;
                }
                
                // Her arama terimini ger√ßek isimlerle e≈üle≈ütir
                const spMap = {};
                allData.forEach(item => {
                    const name = item.sales_person || '';
                    const store = item.store || '';
                    if (store.toLowerCase().includes('analitik') || store.toLowerCase().includes('eƒüitim')) {
                        return;
                    }
                    if (name && !spMap[name]) {
                        spMap[name] = name;
                    }
                });
                
                // Her arama terimi i√ßin en uygun e≈üle≈ümeyi bul
                salespersonsToSearch = [];
                searchTerms.forEach(term => {
                    const matches = Object.keys(spMap).filter(name => 
                        name.toLowerCase().includes(term)
                    );
                    
                    if (matches.length > 0) {
                        // ƒ∞lk e≈üle≈ümeyi al (tam e≈üle≈üme varsa onu, yoksa kƒ±smi e≈üle≈ümeyi)
                        const exactMatch = matches.find(m => m.toLowerCase() === term);
                        salespersonsToSearch.push(exactMatch || matches[0]);
                    }
                });
                
                if (salespersonsToSearch.length === 0) {
                    alert('‚ùå Girilen isimlere uygun satƒ±≈ü temsilcisi bulunamadƒ±!');
                    return;
                }
                
                // Tekrar edenleri kaldƒ±r
                salespersonsToSearch = [...new Set(salespersonsToSearch)];
                
                // En fazla 3 temsilci
                if (salespersonsToSearch.length > 3) {
                    alert('‚ö†Ô∏è En fazla 3 satƒ±≈ü temsilcisi arayabilirsiniz!');
                    salespersonsToSearch = salespersonsToSearch.slice(0, 3);
                }
            }
            
            console.log('üîç Satƒ±≈ü temsilcileri aranƒ±yor:', salespersonsToSearch);
            
            // Filtre deƒüerlerini al (checkbox'lardan)
            const yearFilter = Array.from(document.querySelectorAll('#filterSalespersonYear input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            const monthFilter = Array.from(document.querySelectorAll('#filterSalespersonMonth input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            const dayFilter = Array.from(document.querySelectorAll('#filterSalespersonDay input[type="checkbox"]:checked'))
                .map(cb => cb.value);
            
            console.log('üìÖ Filtreler:', {yearFilter, monthFilter, dayFilter});
            
            // Tek veya √ßoklu temsilci moduna g√∂re i≈ülem yap
            if (salespersonsToSearch.length === 1) {
                // TEK TEMSƒ∞LCƒ∞ MODU
                renderSingleSalespersonView(salespersonsToSearch[0], yearFilter, monthFilter, dayFilter);
            } else {
                // √áOKLU TEMSƒ∞LCƒ∞ KAR≈ûILA≈ûTIRMA MODU
                renderMultipleSalespersonsView(salespersonsToSearch, yearFilter, monthFilter, dayFilter);
            }
        }
        
        function renderSingleSalespersonView(searchQuery, yearFilter, monthFilter, dayFilter) {
            // Temsilci verilerini filtrele
            const salespersonData = allData.filter(item => {
                // Temsilci adƒ± kontrol√º
                if (!item.sales_person || !item.sales_person.toLowerCase().includes(searchQuery.toLowerCase())) {
                    return false;
                }
                
                // Analitik/Eƒüitim filtresi
                const store = (item.store || '').toLowerCase();
                if (store.includes('analitik') || store.includes('eƒüitim')) {
                    return false;
                }
                
                // Tarih kontrol√º
                if (!item.date) return false;
                
                // Yƒ±l filtresi
                if (yearFilter.length > 0) {
                    const itemYear = item.date.substring(0, 4);
                    if (!yearFilter.includes(itemYear)) return false;
                }
                
                // Ay filtresi
                if (monthFilter.length > 0) {
                    const itemMonth = item.date.substring(5, 7);
                    if (!monthFilter.includes(itemMonth)) return false;
                }
                
                // G√ºn filtresi
                if (dayFilter.length > 0) {
                    const itemDay = item.date.substring(8, 10);
                    if (!dayFilter.includes(itemDay)) return false;
                }
                
                return true;
            });
            
            if (salespersonData.length === 0) {
                document.getElementById('salespersonProfileContainer').style.display = 'none';
                document.getElementById('salespersonSearchNoResults').style.display = 'block';
                return;
            }
            
            // Sonu√ßlarƒ± g√∂ster
            document.getElementById('salespersonSearchNoResults').style.display = 'none';
            document.getElementById('salespersonProfileContainer').style.display = 'block';
            document.getElementById('singleSalespersonView').style.display = 'block';
            document.getElementById('multipleSalespersonsView').style.display = 'none';
            
            // Tek temsilci b√∂l√ºmlerini g√∂ster (√ßoklu kar≈üƒ±la≈ütƒ±rmada gizlenmi≈ü olabilir)
            document.getElementById('salespersonBrandCategorySection').style.display = 'grid';
            document.getElementById('salespersonMonthlySection').style.display = 'block';
            document.getElementById('salespersonTopProductsSection').style.display = 'block';
            document.getElementById('salespersonBottomProductsSection').style.display = 'block';
            
            // Temsilci bilgilerini hesapla
            const salespersonName = salespersonData[0].sales_person;
            
            // Grafik ba≈ülƒ±klarƒ±nƒ± g√ºncelle
            document.getElementById('salespersonBrandChartTitle').textContent = `üè∑Ô∏è ${salespersonName} - En √áok Sattƒ±ƒüƒ± Markalar (Top 10)`;
            document.getElementById('salespersonCategoryChartTitle').textContent = `üìÇ ${salespersonName} - En √áok Sattƒ±ƒüƒ± Kategoriler`;
            
            const totalSales = salespersonData.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
            const totalQty = salespersonData.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
            const uniqueDates = new Set(salespersonData.map(item => item.date));
            const transactionCount = uniqueDates.size; // Satƒ±≈ü yapƒ±lan g√ºn sayƒ±sƒ±
            const invoiceCount = new Set(salespersonData.map(item => item.move_name)).size; // Fatura sayƒ±sƒ±
            const avgTransaction = totalSales / Math.max(transactionCount, 1); // G√ºnl√ºk ortalama
            const avgBasket = totalSales / Math.max(invoiceCount, 1); // Sepet ortalamasƒ±
            const uniqueCustomers = new Set(salespersonData.map(item => item.partner)).size;
            const uniqueProducts = new Set(salespersonData.map(item => item.product)).size;
            
            // UI g√ºncelle
            document.getElementById('salespersonName').textContent = salespersonName;
            document.getElementById('salespersonTotalSales').textContent = '$' + totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('salespersonTotalQty').textContent = totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('salespersonInvoiceCount').textContent = invoiceCount;
            document.getElementById('salespersonAvgTransaction').textContent = '$' + avgTransaction.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('salespersonAvgBasket').textContent = '$' + avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2});
            document.getElementById('salespersonUniqueCustomers').textContent = uniqueCustomers;
            document.getElementById('salespersonUniqueProducts').textContent = uniqueProducts;
            
            // Grafikleri render et
            renderSalespersonBrandChart(salespersonData);
            renderSalespersonCategoryChart(salespersonData);
            renderSalespersonMonthlyChart(salespersonData);
            
            // Veriyi kaydet (sƒ±ralama i√ßin)
            lastSalespersonTopProductsData = salespersonData;
            
            // Top 20 ve Bottom 10 √ºr√ºnler
            renderSalespersonTopProducts(salespersonData);
            renderSalespersonBottomProducts(salespersonData);
            
            // AI analiz
            performSalespersonAIAnalysis(salespersonData, {
                name: salespersonName,
                totalSales,
                totalQty,
                transactionCount,
                avgTransaction,
                uniqueCustomers,
                uniqueProducts
            });
        }
        
        function renderMultipleSalespersonsView(salespersons, yearFilter, monthFilter, dayFilter) {
            // Her temsilci i√ßin veri topla
            const salespersonsData = salespersons.map(spName => {
                const data = allData.filter(item => {
                    // Temsilci adƒ± kontrol√º
                    if (!item.sales_person || item.sales_person !== spName) {
                        return false;
                    }
                    
                    // Analitik/Eƒüitim filtresi
                    const store = (item.store || '').toLowerCase();
                    if (store.includes('analitik') || store.includes('eƒüitim')) {
                        return false;
                    }
                    
                    // Tarih kontrol√º
                    if (!item.date) return false;
                    
                    // Yƒ±l filtresi
                    if (yearFilter.length > 0) {
                        const itemYear = item.date.substring(0, 4);
                        if (!yearFilter.includes(itemYear)) return false;
                    }
                    
                    // Ay filtresi
                    if (monthFilter.length > 0) {
                        const itemMonth = item.date.substring(5, 7);
                        if (!monthFilter.includes(itemMonth)) return false;
                    }
                    
                    // G√ºn filtresi
                    if (dayFilter.length > 0) {
                        const itemDay = item.date.substring(8, 10);
                        if (!dayFilter.includes(itemDay)) return false;
                    }
                    
                    return true;
                });
                
                const totalSales = data.reduce((sum, item) => sum + parseFloat(item.usd_amount || 0), 0);
                const totalQty = data.reduce((sum, item) => sum + parseFloat(item.quantity || 0), 0);
                const uniqueDates = new Set(data.map(item => item.date));
                const transactionCount = uniqueDates.size; // Satƒ±≈ü yapƒ±lan g√ºn sayƒ±sƒ±
                const invoiceCount = new Set(data.map(item => item.move_name)).size; // Fatura sayƒ±sƒ±
                const avgTransaction = totalSales / Math.max(transactionCount, 1); // G√ºnl√ºk ortalama
                const avgBasket = totalSales / Math.max(invoiceCount, 1); // Sepet ortalamasƒ±
                const uniqueCustomers = new Set(data.map(item => item.partner)).size;
                const uniqueProducts = new Set(data.map(item => item.product)).size;
                
                return {
                    name: spName,
                    data: data,
                    invoiceCount: invoiceCount,
                    avgBasket: avgBasket,
                    totalSales,
                    totalQty,
                    transactionCount,
                    avgTransaction,
                    uniqueCustomers,
                    uniqueProducts
                };
            }).filter(sp => sp.data.length > 0);
            
            if (salespersonsData.length === 0) {
                document.getElementById('salespersonProfileContainer').style.display = 'none';
                document.getElementById('salespersonSearchNoResults').style.display = 'block';
                return;
            }
            
            // Sonu√ßlarƒ± g√∂ster
            document.getElementById('salespersonSearchNoResults').style.display = 'none';
            document.getElementById('salespersonProfileContainer').style.display = 'block';
            document.getElementById('singleSalespersonView').style.display = 'none';
            document.getElementById('multipleSalespersonsView').style.display = 'block';
            
            // Kar≈üƒ±la≈ütƒ±rma tablosu olu≈ütur
            renderSalespersonComparisonTable(salespersonsData);
            
            // Kar≈üƒ±la≈ütƒ±rma grafikleri
            renderSalespersonComparisonCharts(salespersonsData);
            
            // Tek temsilci b√∂l√ºmlerini gizle (√ßoklu kar≈üƒ±la≈ütƒ±rmada gereksiz)
            document.getElementById('salespersonBrandCategorySection').style.display = 'none';
            document.getElementById('salespersonMonthlySection').style.display = 'none';
            document.getElementById('salespersonTopProductsSection').style.display = 'none';
            document.getElementById('salespersonBottomProductsSection').style.display = 'none';
            
            // AI Analiz i√ßeriƒüini temizle ve kar≈üƒ±la≈ütƒ±rmalƒ± analizi g√∂ster
            const aiPanel = document.getElementById('salespersonAIAnalysisPanel');
            if (aiPanel) {
                aiPanel.style.display = 'block';
            }
            
            // Kar≈üƒ±la≈ütƒ±rmalƒ± AI analizi
            performMultipleSalespersonsAIAnalysis(salespersonsData);
        }
        
        function renderSalespersonBrandChart(data) {
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = {sales: 0, qty: 0};
                brandData[brand].sales += parseFloat(item.usd_amount || 0);
                brandData[brand].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(brandData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('salespersonBrandChart');
            if (!ctx) return;
            
            if (salespersonBrandChartInstance) {
                salespersonBrandChartInstance.destroy();
            }
            
            salespersonBrandChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD - KDV Hari√ß)',
                        data: salesValues,
                        backgroundColor: 'rgba(102, 126, 234, 0.6)',
                        borderColor: 'rgba(102, 126, 234, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'}
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function renderSalespersonCategoryChart(data) {
            const categoryData = {};
            data.forEach(item => {
                const category = item.category_2 || '';
                // ALL, Analitik, Eƒüitim, Bilinmiyor, bo≈ü deƒüerleri atla
                if (!category || 
                    category.toLowerCase() === 'all' || 
                    category.toLowerCase() === 'bilinmiyor' ||
                    category.toLowerCase().includes('analitik') || 
                    category.toLowerCase().includes('eƒüitim')) {
                    return;
                }
                if (!categoryData[category]) categoryData[category] = {sales: 0, qty: 0};
                categoryData[category].sales += parseFloat(item.usd_amount || 0);
                categoryData[category].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(categoryData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 10);
            const labels = sorted.map(item => item[0]);
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('salespersonCategoryChart');
            if (!ctx) return;
            
            if (salespersonCategoryChartInstance) {
                salespersonCategoryChartInstance.destroy();
            }
            
            salespersonCategoryChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD - KDV Hari√ß)',
                        data: salesValues,
                        backgroundColor: 'rgba(56, 239, 125, 0.6)',
                        borderColor: 'rgba(56, 239, 125, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'}
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function renderSalespersonStoreChart(data) {
            const storeData = {};
            data.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                if (!storeData[store]) storeData[store] = {sales: 0, qty: 0};
                storeData[store].sales += parseFloat(item.usd_amount || 0);
                storeData[store].qty += parseFloat(item.quantity || 0);
            });
            
            const sorted = Object.entries(storeData).sort((a, b) => b[1].sales - a[1].sales).slice(0, 5); // Top 5 maƒüaza
            // Maƒüaza adlarƒ±nƒ± temizle (kodlarƒ± kaldƒ±r)
            const labels = sorted.map(item => item[0].replace(/\[.*?\]\s*/g, '').replace(/^.*?\s-\s/, '').trim());
            const salesValues = sorted.map(item => item[1].sales);
            const qtyValues = sorted.map(item => item[1].qty);
            
            const ctx = document.getElementById('salespersonStoreChart');
            if (!ctx) return;
            
            if (salespersonStoreChartInstance) {
                salespersonStoreChartInstance.destroy();
            }
            
            salespersonStoreChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Satƒ±≈ü (USD - KDV Hari√ß)',
                        data: salesValues,
                        backgroundColor: 'rgba(245, 87, 108, 0.6)',
                        borderColor: 'rgba(245, 87, 108, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }, {
                        label: 'Miktar',
                        data: qtyValues,
                        backgroundColor: 'rgba(255, 159, 64, 0.6)',
                        borderColor: 'rgba(255, 159, 64, 1)',
                        borderWidth: 2,
                        yAxisID: 'y'
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'}
                    },
                    scales: {
                        x: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }
        
        function renderSalespersonMonthlyChart(data) {
            // Yƒ±l bazƒ±nda grupla (kar≈üƒ±la≈ütƒ±rma i√ßin)
            const yearlyMonthlyData = {};
            data.forEach(item => {
                const date = new Date(item.date);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const monthKey = `${year}-${month}`;
                
                if (!yearlyMonthlyData[year]) yearlyMonthlyData[year] = {};
                if (!yearlyMonthlyData[year][month]) yearlyMonthlyData[year][month] = 0;
                yearlyMonthlyData[year][month] += parseFloat(item.usd_amount || 0);
            });
            
            // T√ºm aylarƒ± topla (etiketler i√ßin)
            const allMonthKeys = new Set();
            Object.values(yearlyMonthlyData).forEach(yearData => {
                Object.keys(yearData).forEach(month => allMonthKeys.add(month));
            });
            const sortedMonths = Array.from(allMonthKeys).sort();
            
            // Dataset olu≈ütur (her yƒ±l i√ßin)
            const datasets = [];
            const colors = [
                {border: 'rgba(102, 126, 234, 1)', bg: 'rgba(102, 126, 234, 0.1)'},
                {border: 'rgba(245, 87, 108, 1)', bg: 'rgba(245, 87, 108, 0.1)'},
                {border: 'rgba(56, 239, 125, 1)', bg: 'rgba(56, 239, 125, 0.1)'},
                {border: 'rgba(255, 206, 86, 1)', bg: 'rgba(255, 206, 86, 0.1)'}
            ];
            
            Object.keys(yearlyMonthlyData).sort().forEach((year, idx) => {
                const yearData = yearlyMonthlyData[year];
                const values = sortedMonths.map(month => yearData[month] || 0);
                const color = colors[idx % colors.length];
                
                datasets.push({
                    label: `${year} Satƒ±≈ülarƒ±`,
                    data: values,
                    borderColor: color.border,
                    backgroundColor: color.bg,
                    borderWidth: 3,
                    fill: true,
                    tension: 0.4
                });
            });
            
            const ctx = document.getElementById('salespersonMonthlyChart');
            if (!ctx) return;
            
            if (salespersonMonthlyChartInstance) {
                salespersonMonthlyChartInstance.destroy();
            }
            
            // Ay isimlerini g√∂ster
            const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 
                               'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            const labels = sortedMonths.map(m => monthNames[parseInt(m) - 1]);
            
            salespersonMonthlyChartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: datasets
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {display: true, position: 'top'}
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function renderSalespersonTopProducts(data = null, sortColumn = null, sortDirection = null) {
            // Eƒüer data null ise, mevcut veriyi kullan
            if (data === null && lastSalespersonTopProductsData) {
                data = lastSalespersonTopProductsData;
            }
            
            if (!data || data.length === 0) {
                document.getElementById('salespersonTopProductsTable').innerHTML = '<p style="text-align: center; padding: 20px;">Veri bulunamadƒ±</p>';
                return;
            }
            
            // Sƒ±ralama parametrelerini g√ºncelle
            if (sortColumn !== null) {
                if (currentSalespersonSortColumn === sortColumn) {
                    currentSalespersonSortDirection = currentSalespersonSortDirection === 'asc' ? 'desc' : 'asc';
                } else {
                    currentSalespersonSortColumn = sortColumn;
                    currentSalespersonSortDirection = 'desc';
                }
            }
            
            // √úr√ºn bazƒ±nda grupla
            const productData = {};
            data.forEach(item => {
                const product = item.product || 'Bilinmiyor';
                if (!productData[product]) {
                    // Hiyerar≈üik kategori olu≈ütur (ALL atlanƒ±r)
                    const categoryParts = [item.category_1, item.category_2, item.category_3, item.category_4]
                        .filter(c => c && c.trim() && c.toLowerCase() !== 'all');
                    const categoryDisplay = categoryParts.length > 0 ? categoryParts.join(' ‚Ä∫ ') : 'Bilinmiyor';
                    
                    productData[product] = {
                        brand: item.brand || 'Bilinmiyor',
                        category: categoryDisplay,
                        sales: 0,
                        qty: 0,
                        count: 0
                    };
                }
                productData[product].sales += parseFloat(item.usd_amount || 0);
                productData[product].qty += parseFloat(item.quantity || 0);
                productData[product].count += 1;
            });
            
            // Sƒ±ralama
            let sorted = Object.entries(productData);
            
            if (currentSalespersonSortColumn === 'product') {
                sorted.sort((a, b) => {
                    return currentSalespersonSortDirection === 'asc' 
                        ? a[0].localeCompare(b[0], 'tr')
                        : b[0].localeCompare(a[0], 'tr');
                });
            } else if (currentSalespersonSortColumn === 'brand') {
                sorted.sort((a, b) => {
                    return currentSalespersonSortDirection === 'asc'
                        ? a[1].brand.localeCompare(b[1].brand, 'tr')
                        : b[1].brand.localeCompare(a[1].brand, 'tr');
                });
            } else if (currentSalespersonSortColumn === 'category') {
                sorted.sort((a, b) => {
                    return currentSalespersonSortDirection === 'asc'
                        ? a[1].category.localeCompare(b[1].category, 'tr')
                        : b[1].category.localeCompare(a[1].category, 'tr');
                });
            } else if (currentSalespersonSortColumn === 'sales') {
                sorted.sort((a, b) => {
                    return currentSalespersonSortDirection === 'asc'
                        ? a[1].sales - b[1].sales
                        : b[1].sales - a[1].sales;
                });
            } else if (currentSalespersonSortColumn === 'qty') {
                sorted.sort((a, b) => {
                    return currentSalespersonSortDirection === 'asc'
                        ? a[1].qty - b[1].qty
                        : b[1].qty - a[1].qty;
                });
            } else if (currentSalespersonSortColumn === 'count') {
                sorted.sort((a, b) => {
                    return currentSalespersonSortDirection === 'asc'
                        ? a[1].count - b[1].count
                        : b[1].count - a[1].count;
                });
            }
            
            // Top 20
            sorted = sorted.slice(0, 20);
            
            const getSortIcon = (column) => {
                if (currentSalespersonSortColumn !== column) return '‚áÖ';
                return currentSalespersonSortDirection === 'asc' ? '‚Üë' : '‚Üì';
            };
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left;">#</th>
                            <th style="padding: 15px; text-align: left; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'product')">
                                √úr√ºn ${getSortIcon('product')}
                            </th>
                            <th style="padding: 15px; text-align: left; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'brand')">
                                Marka ${getSortIcon('brand')}
                            </th>
                            <th style="padding: 15px; text-align: left; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'category')">
                                Kategori ${getSortIcon('category')}
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'sales')">
                                Satƒ±≈ü (USD) ${getSortIcon('sales')}
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'qty')">
                                Miktar ${getSortIcon('qty')}
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'count')">
                                ƒ∞≈ülem ${getSortIcon('count')}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sorted.forEach((item, index) => {
                const product = item[0];
                const stats = item[1];
                
                html += `
                    <tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: #f8f9fa;' : ''}">
                        <td style="padding: 12px;">${index + 1}</td>
                        <td style="padding: 12px;"><strong>${product}</strong></td>
                        <td style="padding: 12px;">${stats.brand}</td>
                        <td style="padding: 12px;">${stats.category}</td>
                        <td style="padding: 12px; text-align: right; color: #38ef7d; font-weight: bold;">$${stats.sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right;">${stats.qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right;">${stats.count}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('salespersonTopProductsTable').innerHTML = html;
        }
        
        function renderSalespersonBottomProducts(data) {
            // √úr√ºn bazƒ±nda grupla
            const productData = {};
            data.forEach(item => {
                const product = item.product || 'Bilinmiyor';
                if (!productData[product]) {
                    // Hiyerar≈üik kategori olu≈ütur (ALL atlanƒ±r)
                    const categoryParts = [item.category_1, item.category_2, item.category_3, item.category_4]
                        .filter(c => c && c.trim() && c.toLowerCase() !== 'all');
                    const categoryDisplay = categoryParts.length > 0 ? categoryParts.join(' ‚Ä∫ ') : 'Bilinmiyor';
                    
                    productData[product] = {
                        brand: item.brand || 'Bilinmiyor',
                        category: categoryDisplay,
                        sales: 0,
                        qty: 0,
                        count: 0
                    };
                }
                productData[product].sales += parseFloat(item.usd_amount || 0);
                productData[product].qty += parseFloat(item.quantity || 0);
                productData[product].count += 1;
            });
            
            // Bottom 10 (en az satan)
            const sorted = Object.entries(productData).sort((a, b) => a[1].sales - b[1].sales).slice(0, 10);
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left;">#</th>
                            <th style="padding: 15px; text-align: left;">√úr√ºn</th>
                            <th style="padding: 15px; text-align: left;">Marka</th>
                            <th style="padding: 15px; text-align: left;">Kategori</th>
                            <th style="padding: 15px; text-align: right;">Satƒ±≈ü (USD)</th>
                            <th style="padding: 15px; text-align: right;">Miktar</th>
                            <th style="padding: 15px; text-align: right;">ƒ∞≈ülem</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            sorted.forEach((item, index) => {
                const product = item[0];
                const stats = item[1];
                
                html += `
                    <tr style="border-bottom: 1px solid #eee; ${index % 2 === 0 ? 'background: #fff3cd;' : 'background: #ffe5e5;'}">
                        <td style="padding: 12px;">${index + 1}</td>
                        <td style="padding: 12px;"><strong>${product}</strong></td>
                        <td style="padding: 12px;">${stats.brand}</td>
                        <td style="padding: 12px;">${stats.category}</td>
                        <td style="padding: 12px; text-align: right; color: #f5576c; font-weight: bold;">$${stats.sales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right;">${stats.qty.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>
                        <td style="padding: 12px; text-align: right;">${stats.count}</td>
                    </tr>
                `;
            });
            
            html += `
                    </tbody>
                </table>
            `;
            
            document.getElementById('salespersonBottomProductsTable').innerHTML = html;
        }
        
        function renderSalespersonComparisonTable(salespersonsData) {
            const container = document.getElementById('salespersonComparisonTable');
            
            let html = `
                <table style="width: 100%; border-collapse: collapse; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <th style="padding: 15px; text-align: left;">Metrik</th>
                            ${salespersonsData.map(sp => `<th style="padding: 15px; text-align: right;">üë®‚Äçüíº ${sp.name}</th>`).join('')}
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">üí∞ Toplam Satƒ±≈ü</td>
                            ${salespersonsData.map(sp => `<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">$${sp.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>`).join('')}
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">üì¶ Toplam Adet</td>
                            ${salespersonsData.map(sp => `<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${sp.totalQty.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>`).join('')}
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">üõí Fatura Sayƒ±sƒ±</td>
                            ${salespersonsData.map(sp => `<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${sp.invoiceCount}</td>`).join('')}
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">üìä G√ºnl√ºk Ort. Satƒ±≈ü</td>
                            ${salespersonsData.map(sp => `<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">$${sp.avgTransaction.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>`).join('')}
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">üõí Sepet Ortalamasƒ±</td>
                            ${salespersonsData.map(sp => `<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">$${sp.avgBasket.toLocaleString('tr-TR', {minimumFractionDigits: 2})}</td>`).join('')}
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">üë• Farklƒ± M√º≈üteri</td>
                            ${salespersonsData.map(sp => `<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${sp.uniqueCustomers}</td>`).join('')}
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">üéØ Farklƒ± √úr√ºn</td>
                            ${salespersonsData.map(sp => `<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${sp.uniqueProducts}</td>`).join('')}
                        </tr>
                    </tbody>
                </table>
            `;
            
            container.innerHTML = html;
        }
        
        function renderSalespersonComparisonCharts(salespersonsData) {
            const names = salespersonsData.map(sp => sp.name);
            const sales = salespersonsData.map(sp => sp.totalSales);
            const quantities = salespersonsData.map(sp => sp.totalQty);
            
            const colors = [
                'rgba(102, 126, 234, 0.7)',
                'rgba(240, 147, 251, 0.7)',
                'rgba(255, 159, 64, 0.7)'
            ];
            
            const borderColors = [
                'rgba(102, 126, 234, 1)',
                'rgba(240, 147, 251, 1)',
                'rgba(255, 159, 64, 1)'
            ];
            
            // Satƒ±≈ü kar≈üƒ±la≈ütƒ±rma grafiƒüi
            const salesCtx = document.getElementById('comparisonSalesChart');
            if (comparisonSalesChartInstance) {
                comparisonSalesChartInstance.destroy();
            }
            
            comparisonSalesChartInstance = new Chart(salesCtx, {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [{
                        label: 'Toplam Satƒ±≈ü ($)',
                        data: sales,
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return '$' + context.parsed.y.toLocaleString('tr-TR', {minimumFractionDigits: 2});
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return '$' + (value / 1000).toFixed(0) + 'K';
                                }
                            }
                        }
                    }
                }
            });
            
            // Adet kar≈üƒ±la≈ütƒ±rma grafiƒüi
            const qtyCtx = document.getElementById('comparisonQtyChart');
            if (comparisonQtyChartInstance) {
                comparisonQtyChartInstance.destroy();
            }
            
            comparisonQtyChartInstance = new Chart(qtyCtx, {
                type: 'bar',
                data: {
                    labels: names,
                    datasets: [{
                        label: 'Toplam Adet',
                        data: quantities,
                        backgroundColor: colors,
                        borderColor: borderColors,
                        borderWidth: 2
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString('tr-TR', {minimumFractionDigits: 2}) + ' adet';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString('tr-TR');
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function performSalespersonAIAnalysis(data, profile) {
            console.log('ü§ñ Satƒ±≈ü temsilcisi AI analizi ba≈ülatƒ±lƒ±yor...');
            
            const insights = {positive: [], negative: [], neutral: [], recommendations: []};
            
            // Marka analizi
            const brandData = {};
            data.forEach(item => {
                const brand = item.brand || 'Bilinmiyor';
                if (!brandData[brand]) brandData[brand] = 0;
                brandData[brand] += parseFloat(item.usd_amount || 0);
            });
            const topBrands = Object.entries(brandData).sort((a, b) => b[1] - a[1]).slice(0, 3);
            const bottomBrands = Object.entries(brandData).sort((a, b) => a[1] - b[1]).slice(0, 3);
            
            // Kategori analizi (category_2 kullan, ALL/Analitik/Eƒüitim atla)
            const categoryData = {};
            data.forEach(item => {
                const category = item.category_2 || 'Bilinmiyor';
                if (category.toLowerCase() === 'all' || category.toLowerCase().includes('analitik') || category.toLowerCase().includes('eƒüitim')) {
                    return;
                }
                if (!categoryData[category]) categoryData[category] = 0;
                categoryData[category] += parseFloat(item.usd_amount || 0);
            });
            const topCategories = Object.entries(categoryData).sort((a, b) => b[1] - a[1]).slice(0, 3);
            const bottomCategories = Object.entries(categoryData).sort((a, b) => a[1] - b[1]).slice(0, 3);
            
            // ZAMAN ANALƒ∞ZLERƒ∞
            // Aylƒ±k analiz
            const monthNames = ['Ocak', '≈ûubat', 'Mart', 'Nisan', 'Mayƒ±s', 'Haziran', 'Temmuz', 'Aƒüustos', 'Eyl√ºl', 'Ekim', 'Kasƒ±m', 'Aralƒ±k'];
            const monthData = {};
            data.forEach(item => {
                const date = new Date(item.date);
                const month = date.getMonth();
                if (!monthData[month]) monthData[month] = 0;
                monthData[month] += parseFloat(item.usd_amount || 0);
            });
            const monthEntries = Object.entries(monthData).map(([m, v]) => ({month: parseInt(m), name: monthNames[m], value: v}));
            const bestMonth = monthEntries.sort((a, b) => b.value - a.value)[0];
            const worstMonth = monthEntries.sort((a, b) => a.value - b.value)[0];
            
            // G√ºnl√ºk analiz (haftanƒ±n g√ºnleri)
            const dayNames = ['Pazar', 'Pazartesi', 'Salƒ±', '√áar≈üamba', 'Per≈üembe', 'Cuma', 'Cumartesi'];
            const dayData = {};
            data.forEach(item => {
                const day = item.day_of_week;
                if (day !== undefined && day !== null) {
                    const dayIndex = (day + 1) % 7; // 0=Paz, 1=Pzt, ...
                    if (!dayData[dayIndex]) dayData[dayIndex] = 0;
                    dayData[dayIndex] += parseFloat(item.usd_amount || 0);
                }
            });
            const dayEntries = Object.entries(dayData).map(([d, v]) => ({day: parseInt(d), name: dayNames[d], value: v}));
            const bestDay = dayEntries.sort((a, b) => b.value - a.value)[0];
            const worstDay = dayEntries.sort((a, b) => a.value - b.value)[0];
            
            // Saatlik analiz
            const hourData = {};
            data.forEach(item => {
                const hour = item.create_hour;
                if (hour !== undefined && hour !== null) {
                    if (!hourData[hour]) hourData[hour] = 0;
                    hourData[hour] += parseFloat(item.usd_amount || 0);
                }
            });
            const hourEntries = Object.entries(hourData).map(([h, v]) => ({hour: parseInt(h), value: v}));
            const bestHour = hourEntries.sort((a, b) => b.value - a.value)[0];
            
            // Saat aralƒ±ƒüƒ± analizi (sabah, √∂ƒülen, ak≈üam)
            let morning = 0, afternoon = 0, evening = 0, night = 0;
            data.forEach(item => {
                const hour = item.create_hour;
                const amount = parseFloat(item.usd_amount || 0);
                if (hour >= 6 && hour < 12) morning += amount;
                else if (hour >= 12 && hour < 17) afternoon += amount;
                else if (hour >= 17 && hour < 22) evening += amount;
                else night += amount;
            });
            const timeSlots = [
                {name: 'Sabah (06:00-12:00)', value: morning},
                {name: '√ñƒülen (12:00-17:00)', value: afternoon},
                {name: 'Ak≈üam (17:00-22:00)', value: evening},
                {name: 'Gece (22:00-06:00)', value: night}
            ].sort((a, b) => b.value - a.value);
            
            // Maƒüaza-G√ºn kombinasyonu
            const storeDayData = {};
            data.forEach(item => {
                const store = item.store || 'Bilinmiyor';
                const day = item.day_of_week;
                if (day !== undefined && day !== null) {
                    const dayIndex = (day + 1) % 7;
                    const key = `${store}_${dayIndex}`;
                    if (!storeDayData[key]) storeDayData[key] = {store, day: dayIndex, dayName: dayNames[dayIndex], value: 0};
                    storeDayData[key].value += parseFloat(item.usd_amount || 0);
                }
            });
            const topStoreDay = Object.values(storeDayData).sort((a, b) => b.value - a.value)[0];
            
            // Pozitif i√ßg√∂r√ºler
            if (profile.totalSales > 100000) {
                insights.positive.push({
                    title: 'üèÜ Y√ºksek Performans',
                    description: `${profile.name} toplam $${profile.totalSales.toLocaleString('tr-TR', {minimumFractionDigits: 2})} satƒ±≈ü ger√ßekle≈ütirmi≈ü. Bu, √ßok ba≈üarƒ±lƒ± bir performans g√∂stergesi.`
                });
            }
            
            if (topBrands.length > 0) {
                const topBrand = topBrands[0];
                const brandShare = (topBrand[1] / profile.totalSales * 100).toFixed(1);
                insights.positive.push({
                    title: `üè∑Ô∏è ${topBrand[0]} Markasƒ±nda Uzman`,
                    description: `${topBrand[0]} markasƒ±nda %${brandShare} pay ile g√º√ßl√º ($${topBrand[1].toLocaleString('tr-TR', {minimumFractionDigits: 2})}). Bu markadaki √ºr√ºnleri √ßok iyi biliyor.`
                });
            }
            
            if (topCategories.length > 0) {
                const topCat = topCategories[0];
                const catShare = (topCat[1] / profile.totalSales * 100).toFixed(1);
                insights.positive.push({
                    title: `üìÇ ${topCat[0]} Kategorisinde Ba≈üarƒ±lƒ±`,
                    description: `${topCat[0]} kategorisinde %${catShare} pay ile lider ($${topCat[1].toLocaleString('tr-TR', {minimumFractionDigits: 2})}). Bu kategorideki √ºr√ºnleri etkili satƒ±yor.`
                });
            }
            
            // Negatif i√ßg√∂r√ºler (Geli≈üim alanlarƒ±)
            if (bottomBrands.length > 0 && bottomBrands[0][1] < profile.totalSales * 0.05) {
                insights.negative.push({
                    title: `‚ö†Ô∏è ${bottomBrands[0][0]} Markasƒ±nda Zayƒ±f`,
                    description: `${bottomBrands[0][0]} markasƒ±nda sadece $${bottomBrands[0][1].toLocaleString('tr-TR', {minimumFractionDigits: 2})} satƒ±≈ü var. Bu markada eƒüitim gerekebilir.`
                });
            }
            
            if (bottomCategories.length > 0 && bottomCategories[0][1] < profile.totalSales * 0.05) {
                insights.negative.push({
                    title: `‚ö†Ô∏è ${bottomCategories[0][0]} Kategorisinde Geli≈üim Alanƒ±`,
                    description: `${bottomCategories[0][0]} kategorisinde sadece $${bottomCategories[0][1].toLocaleString('tr-TR', {minimumFractionDigits: 2})} satƒ±≈ü var. Bu kategoride potansiyel artƒ±≈ü fƒ±rsatƒ±.`
                });
            }
            
            if (profile.uniqueCustomers < 50) {
                insights.negative.push({
                    title: 'üë• M√º≈üteri Portf√∂y√º Dar',
                    description: `Sadece ${profile.uniqueCustomers} farklƒ± m√º≈üteri ile √ßalƒ±≈üƒ±lmƒ±≈ü. Yeni m√º≈üteri kazanƒ±mƒ±na odaklanƒ±lmalƒ±.`
                });
            }
            
            // N√∂tr bilgiler - ZAMAN ANALƒ∞ZLERƒ∞
            if (bestMonth && worstMonth) {
                const bestPercent = ((bestMonth.value / profile.totalSales) * 100).toFixed(1);
                const worstPercent = ((worstMonth.value / profile.totalSales) * 100).toFixed(1);
                insights.neutral.push({
                    title: 'üìÖ Aylƒ±k Performans',
                    description: `En g√º√ßl√º ay: <span class="metric-highlight">${bestMonth.name}</span> (%${bestPercent})<br>En zayƒ±f ay: ${worstMonth.name} (%${worstPercent})`
                });
            }
            
            if (bestDay && worstDay) {
                const bestDayPercent = ((bestDay.value / profile.totalSales) * 100).toFixed(1);
                const worstDayPercent = ((worstDay.value / profile.totalSales) * 100).toFixed(1);
                insights.neutral.push({
                    title: 'üìÜ G√ºnl√ºk Performans',
                    description: `En g√º√ßl√º g√ºn: <span class="metric-highlight">${bestDay.name}</span> (%${bestDayPercent})<br>En zayƒ±f g√ºn: ${worstDay.name} (%${worstDayPercent})`
                });
            }
            
            if (timeSlots.length > 0) {
                const bestSlot = timeSlots[0];
                const bestSlotPercent = ((bestSlot.value / profile.totalSales) * 100).toFixed(1);
                insights.neutral.push({
                    title: 'üïê Saat Dilimi Performansƒ±',
                    description: `En g√º√ßl√º: <span class="metric-highlight">${bestSlot.name}</span> - Cironun %${bestSlotPercent}'i bu saatlerde`
                });
            }
            
            if (topStoreDay) {
                const storeDayPercent = ((topStoreDay.value / profile.totalSales) * 100).toFixed(1);
                // Maƒüaza adƒ±nƒ± sadele≈ütir (kodlarƒ± temizle)
                const cleanStoreName = topStoreDay.store.replace(/\[.*?\]\s*/g, '').trim();
                
                // Bu maƒüazanƒ±n √ßalƒ±≈üma saatlerini kontrol et
                const topStoreHours = getStoreWorkingHours(topStoreDay.store);
                const isDayClosed = topStoreHours.closedDays.includes(topStoreDay.day);
                
                if (!isDayClosed) {
                    insights.neutral.push({
                        title: '‚≠ê En Ba≈üarƒ±lƒ± Kombinasyon',
                        description: `<span class="metric-highlight">${cleanStoreName}</span> - <span class="metric-highlight">${topStoreDay.dayName}</span> g√ºnleri harika! (%${storeDayPercent})`
                    });
                }
            }
            
            insights.neutral.push({
                title: 'üìä Genel Performans',
                description: `<span class="metric-highlight">${profile.uniqueProducts}</span> farklƒ± √ºr√ºn, <span class="metric-highlight">${profile.uniqueCustomers}</span> farklƒ± m√º≈üteriye satƒ±ldƒ±. Ortalama i≈ülem deƒüeri $${profile.avgTransaction.toLocaleString('tr-TR', {minimumFractionDigits: 2})}.`
            });
            
            if (topBrands.length >= 3) {
                insights.neutral.push({
                    title: 'üè∑Ô∏è Marka √áe≈üitliliƒüi',
                    description: `En √ßok satƒ±lan markalar: ${topBrands.map(b => b[0]).join(', ')}. Bu markalarda yoƒüunla≈üma var.`
                });
            }
            
            if (topCategories.length >= 3) {
                insights.neutral.push({
                    title: 'üìÇ Kategori √áe≈üitliliƒüi',
                    description: `En √ßok satƒ±lan kategoriler: ${topCategories.map(c => c[0]).join(', ')}. Bu kategorilerde uzmanla≈üma mevcut.`
                });
            }
            
            // √ñneriler - ZAMAN BAZLI
            if (worstDay && bestDay) {
                insights.recommendations.push({
                    icon: 'üìÜ',
                    title: 'G√ºn Bazlƒ± Strateji',
                    description: `${worstDay.name} g√ºnleri zayƒ±f. ${bestDay.name} g√ºnlerindeki ba≈üarƒ±lƒ± yakla≈üƒ±mlarƒ± ${worstDay.name}'ya da uygulayƒ±n. M√º≈üteri ziyaretlerini buna g√∂re planlayƒ±n.`
                });
            }
            
            if (bestHour) {
                insights.recommendations.push({
                    icon: '‚è∞',
                    title: 'Saat Bazlƒ± Optimizasyon',
                    description: `Saat ${bestHour.hour}:00 civarƒ±nda en ba≈üarƒ±lƒ±. Bu saatlerde daha fazla m√º≈üteri g√∂r√º≈ümesi planlayƒ±n.`
                });
            }
            
            // Zayƒ±f zaman dilimi analizi (Gece hari√ß - maƒüazalar kapalƒ±)
            if (timeSlots.length > 1) {
                // √áalƒ±≈üma saatleri i√ßindeki zaman dilimlerini filtrele (Gece hari√ß)
                const workingHoursSlots = timeSlots.filter(slot => !slot.name.includes('Gece'));
                
                if (workingHoursSlots.length > 1) {
                    const weakSlot = workingHoursSlots[workingHoursSlots.length - 1];
                    const weakPercent = ((weakSlot.value / profile.totalSales) * 100).toFixed(1);
                    
                    // Sadece %20'nin altƒ±ndaki zaman dilimlerini √∂ner
                    if (parseFloat(weakPercent) < 20) {
                        let recommendation = `${weakSlot.name} sadece %${weakPercent} ciro yapƒ±yor.`;
                        
                        // Zaman dilimine g√∂re √∂zel √∂neriler
                        if (weakSlot.name.includes('Sabah')) {
                            recommendation += ' Sabah m√º≈üteri akƒ±≈üƒ±nƒ± artƒ±rmak i√ßin a√ßƒ±lƒ±≈ü kampanyalarƒ± ve sosyal medya duyurularƒ± yapƒ±lmalƒ±.';
                        } else if (weakSlot.name.includes('√ñƒülen')) {
                            recommendation += ' √ñƒüle saatlerinde √∂zel indirimler ve hƒ±zlƒ± servis sunulmalƒ±.';
                        } else if (weakSlot.name.includes('Ak≈üam')) {
                            recommendation += ' Ak≈üam saatlerinde (17:00-20:00/22:00) √∂zel etkinlikler ve workshop\'lar d√ºzenlenebilir.';
                        }
                        
                        insights.recommendations.push({
                            icon: 'üéØ',
                            title: 'Zayƒ±f Zaman Dilimini G√º√ßlendir',
                            description: recommendation
                        });
                    }
                }
            }
            
            if (bottomBrands.length > 0) {
                insights.recommendations.push({
                    icon: 'üìö',
                    title: '√úr√ºn Eƒüitimi',
                    description: `${bottomBrands[0][0]} ve ${bottomCategories[0][0]} konularƒ±nda √ºr√ºn eƒüitimi almalƒ±. Bu alanlardaki bilgi eksikliƒüi satƒ±≈ülarƒ± etkiliyor olabilir.`
                });
            }
            
            if (topBrands.length > 0) {
                insights.recommendations.push({
                    icon: 'üéØ',
                    title: 'Ba≈üarƒ±lƒ± Stratejileri Yaygƒ±nla≈ütƒ±r',
                    description: `${topBrands[0][0]} markasƒ±ndaki ba≈üarƒ±yƒ± diƒüer markalara da ta≈üƒ±mak i√ßin aylƒ±k hedefler belirleyin. Cross-selling fƒ±rsatlarƒ±nƒ± deƒüerlendirin.`
                });
            }
            
            insights.recommendations.push({
                icon: 'üë•',
                title: 'M√º≈üteri Geli≈ütirme',
                description: `Mevcut ${profile.uniqueCustomers} m√º≈üteriye ek olarak yeni m√º≈üteri kazanƒ±mƒ± i√ßin aktif √ßalƒ±≈üma yapƒ±lmalƒ±. Referans sistemi kullanƒ±labilir.`
            });
            
            // HTML olu≈ütur
            let html = `
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">
                    ${insights.positive.length > 0 ? `
                    <div class="analysis-section">
                        <h3 style="color: white; margin-top: 0;">‚úÖ G√º√ßl√º Y√∂nler</h3>
                        ${insights.positive.map(item => `
                            <div class="insight-item insight-positive" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">‚úÖ</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.negative.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">‚ö†Ô∏è Geli≈üim Alanlarƒ±</h3>
                        ${insights.negative.map(item => `
                            <div class="insight-item insight-negative" style="background: rgba(245, 87, 108, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #f5576c;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">‚ö†Ô∏è</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    ${insights.neutral.length > 0 ? `
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">üí° Genel Bilgiler</h3>
                        ${insights.neutral.map(item => `
                            <div class="insight-item insight-neutral" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">üí°</span>
                                <strong style="font-size: 1.1em;">${item.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${item.description}</span>
                            </div>
                        `).join('')}
                    </div>
                    ` : ''}
                    
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">üéØ Geli≈üim √ñnerileri</h3>
                        ${insights.recommendations.map(item => `
                            <div class="recommendation" style="background: rgba(255, 255, 255, 0.15); padding: 18px; border-radius: 10px; margin: 12px 0;">
                                <span class="recommendation-icon" style="font-size: 1.8em; margin-right: 12px;">${item.icon}</span>
                                <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px);">
                                    <strong style="font-size: 1.15em; display: block; margin-bottom: 8px;">${item.title}</strong>
                                    <p style="margin: 0; opacity: 0.95; line-height: 1.6;">${item.description}</p>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
            
            document.getElementById('salespersonAIAnalysisContent').innerHTML = html;
        }
        
        // ==================== MOBƒ∞L: TABLE SCROLL HINT ==================== 
        // Tablolar ilk kaydƒ±rƒ±ldƒ±ƒüƒ±nda "‚Üê Kaydƒ±rƒ±n ‚Üí" mesajƒ±nƒ± gizle
        function initMobileTableScrollHint() {
            if (window.innerWidth <= 768) {
                const tables = document.querySelectorAll('table');
                tables.forEach(table => {
                    table.addEventListener('scroll', function() {
                        this.classList.add('scrolled');
                    }, { once: true });
                });
            }
        }
        
        // Loading System
        let loadingProgress = 0;
        let loadingSteps = [
            { id: 'step1', text: 'üîÑ Sayfa ba≈ülatƒ±lƒ±yor...', progress: 10 },
            { id: 'step2', text: 'üìä Veri dosyalarƒ± y√ºkleniyor...', progress: 40 },
            { id: 'step3', text: 'üéØ Hedefler y√ºkleniyor...', progress: 70 },
            { id: 'step4', text: '‚úÖ Hazƒ±rlanƒ±yor...', progress: 100 }
        ];
        
        function updateLoadingProgress(stepIndex, customProgress = null) {
            const step = loadingSteps[stepIndex];
            const progress = customProgress !== null ? customProgress : step.progress;
            
            // Progress bar g√ºncelle
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = Math.round(progress) + '%';
            
            // Step g√∂ster/gizle ve aktif step'i vurgula
            loadingSteps.forEach((s, index) => {
                const stepElement = document.getElementById(s.id);
                if (stepElement) {
                    if (index <= stepIndex) {
                        stepElement.style.display = 'block';
                        if (index === stepIndex) {
                            stepElement.style.opacity = '1';
                            stepElement.style.color = '#4ade80';
                            stepElement.style.transform = 'scale(1.05)';
                        } else {
                            stepElement.style.opacity = '0.7';
                            stepElement.style.color = 'white';
                            stepElement.style.transform = 'scale(1)';
                        }
                    } else {
                        stepElement.style.display = 'none';
                    }
                }
            });
            
            // Eƒüer %100'e ula≈ütƒ±ysak loading'i gizle
            if (progress >= 100) {
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.opacity = '0';
                    document.getElementById('loadingScreen').style.transition = 'opacity 0.5s ease';
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                        document.getElementById('mainContainer').style.display = 'block';
                    }, 500);
                }, 500);
            }
        }
        
        function checkLoadingComplete() {
            let progress = 0;
            if (dataLoadProgress.pageInit) progress += 25;
            if (dataLoadProgress.dataFiles) progress += 50;
            if (dataLoadProgress.targets) progress += 20;
            if (dataLoadProgress.ready) progress += 5;
            
            // Progress'i g√ºncelle
            document.getElementById('progressBar').style.width = progress + '%';
            document.getElementById('progressText').textContent = Math.round(progress) + '%';
            
            // Step'leri g√ºncelle
            if (dataLoadProgress.pageInit) {
                document.getElementById('step1').style.display = 'block';
                document.getElementById('step1').style.opacity = '1';
                document.getElementById('step1').style.color = '#4ade80';
            }
            
            if (dataLoadProgress.dataFiles) {
                document.getElementById('step2').style.display = 'block';
                document.getElementById('step2').style.opacity = '1';
                document.getElementById('step2').style.color = '#4ade80';
            }
            
            if (dataLoadProgress.targets) {
                document.getElementById('step3').style.display = 'block';
                document.getElementById('step3').style.opacity = '1';
                document.getElementById('step3').style.color = '#4ade80';
            }
            
            if (dataLoadProgress.ready) {
                document.getElementById('step4').style.display = 'block';
                document.getElementById('step4').style.opacity = '1';
                document.getElementById('step4').style.color = '#4ade80';
                
                // %100'e ula≈ütƒ±ysak loading'i gizle
                setTimeout(() => {
                    document.getElementById('loadingScreen').style.opacity = '0';
                    document.getElementById('loadingScreen').style.transition = 'opacity 0.5s ease';
                    setTimeout(() => {
                        document.getElementById('loadingScreen').style.display = 'none';
                        document.getElementById('mainContainer').style.display = 'block';
                    }, 500);
                }, 500);
            }
        }
        
        function startRealLoading() {
            // Step 1: Session kontrol√º
            const sessionData = sessionStorage.getItem('otpVerified');
            const sessionExpiry = sessionStorage.getItem('sessionExpiry');
            
            if (sessionData === 'true' && sessionExpiry && new Date().getTime() < parseInt(sessionExpiry)) {
                // Session ge√ßerli, dashboard'ƒ± g√∂ster
                console.log('‚úÖ Ge√ßerli session bulundu, dashboard y√ºkleniyor...');
                showDashboardAfterAuth();
            } else {
                // Session yok veya s√ºresi dolmu≈ü, auth formunu g√∂ster
                console.log('üîê Session yok veya s√ºresi dolmu≈ü, auth formu g√∂steriliyor...');
                showAuthForm();
                return; // Veri y√ºkleme yapma
            }
            
            // Step 2: Sayfa ba≈ülatƒ±lƒ±yor
            dataLoadProgress.pageInit = true;
            checkLoadingComplete();
            
            // Ger√ßek veri y√ºkleme i≈ülemini ba≈ülat
            loadData();
        }

        // Sayfa y√ºklendiƒüinde ve tab deƒüi≈ütiƒüinde √ßalƒ±≈ütƒ±r
        document.addEventListener('DOMContentLoaded', function() {
            // Ger√ßek loading'i ba≈ülat
            startRealLoading();
            
            initMobileTableScrollHint();
            
            // Tab deƒüi≈üimlerinde de √ßalƒ±≈ütƒ±r
            const observer = new MutationObserver(function() {
                initMobileTableScrollHint();
            });
            
            observer.observe(document.body, {
                childList: true,
                subtree: true
            });
        });

        // Authentication UI Fonksiyonlarƒ±
        function showAuthForm() {
            const authForm = document.getElementById('authForm');
            const otpForm = document.getElementById('otpForm');
            const dashboard = document.getElementById('dashboard');
            
            if (authForm) authForm.style.display = 'flex';
            if (otpForm) otpForm.style.display = 'none';
            if (dashboard) dashboard.style.display = 'none';
        }
        
        function showOTPForm(email) {
            const authForm = document.getElementById('authForm');
            const otpForm = document.getElementById('otpForm');
            
            if (authForm) authForm.style.display = 'none';
            if (otpForm) otpForm.style.display = 'flex';
        }
        
        function showAuthLoading() {
            const loginBtn = document.getElementById('authLoginBtn');
            if (loginBtn) {
                loginBtn.textContent = '‚è≥ Y√ºkleniyor...';
                loginBtn.disabled = true;
            }
        }
        
        function showAuthError(message, type = 'error') {
            const errorDiv = document.getElementById('authError');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                errorDiv.style.background = type === 'success' ? '#d4edda' : '#f8d7da';
                errorDiv.style.color = type === 'success' ? '#155724' : '#721c24';
            }
        }
        
        // Sayfa y√ºklendiƒüinde authentication formunu g√∂ster
        document.addEventListener('DOMContentLoaded', function() {
            // Bu fonksiyon artƒ±k gerekli deƒüil - session kontrol√º zaten yapƒ±lƒ±yor
            console.log('üìù DOMContentLoaded - Session kontrol√º zaten yapƒ±ldƒ±');
        });

        // Kullanƒ±cƒ± bilgilerini g√ºncelle
        function updateUserInfo() {
            if (window.currentUser && window.currentUserType) {
                document.getElementById('userInfo').textContent = window.currentUser.name || window.currentUser.username || 'Kullanƒ±cƒ±';
                
                const userTypeText = window.currentUserType === 'admin' ? 'üëë Y√∂netici' : 'üë§ Kullanƒ±cƒ±';
                document.getElementById('userType').textContent = userTypeText;
                
                // G√ºvenlik bilgilerini g√ºncelle
                const securityText = window.currentUser.twoFactorEnabled ? 'üîê 2FA Aktif' : 'üõ°Ô∏è G√ºvenli Oturum';
                document.getElementById('securityInfo').textContent = securityText;
            }
        }
        
        // Sayfa y√ºklenince kullanƒ±cƒ± bilgilerini g√ºncelle
        updateUserInfo();

        // G√ºvenlik bilgilerini g√∂ster
        function showSecurityInfo() {
            const session = localStorage.getItem('session');
            if (!session) return;

            try {
                const key = 'zuhal-muzik-secret-key-2024';
                const bytes = CryptoJS.AES.decrypt(session, key);
                const sessionData = JSON.parse(bytes.toString(CryptoJS.enc.Utf8));
                
                const timeLeft = Math.max(0, 30 * 60 * 1000 - (Date.now() - sessionData.loginTime));
                const minutesLeft = Math.floor(timeLeft / (60 * 1000));
                
                const securityInfo = `
üõ°Ô∏è G√ºvenlik Bilgileri:
‚Ä¢ Kullanƒ±cƒ±: ${sessionData.user.name}
‚Ä¢ Rol: ${sessionData.user.role === 'admin' ? 'Y√∂netici' : 'Kullanƒ±cƒ±'}
‚Ä¢ ƒ∞kili Doƒürulama: ${sessionData.user.twoFactorEnabled ? 'Aktif ‚úÖ' : 'Pasif ‚ùå'}
‚Ä¢ IP Adresi: ${sessionData.ipAddress || 'Bilinmiyor'}
‚Ä¢ Cihaz: ${sessionData.deviceInfo ? sessionData.deviceInfo.platform : 'Bilinmiyor'}
‚Ä¢ Oturum S√ºresi: ${minutesLeft} dakika kaldƒ±
‚Ä¢ Giri≈ü Zamanƒ±: ${new Date(sessionData.loginTime).toLocaleString('tr-TR')}
‚Ä¢ Oturum ID: ${sessionData.sessionId.substring(0, 20)}...
                `;
                
                alert(securityInfo);
            } catch (error) {
                alert('G√ºvenlik bilgileri alƒ±namadƒ±.');
            }
        }

        // Sayfa y√ºklendiƒüinde kullanƒ±cƒ± bilgilerini g√ºncelle
        document.addEventListener('DOMContentLoaded', function() {
            updateUserInfo();
            
            // Oturum s√ºresi kontrol√º (her 5 dakikada bir)
            setInterval(function() {
                const session = localStorage.getItem('session');
                if (session) {
                    const sessionData = JSON.parse(session);
                    if (Date.now() - sessionData.loginTime > 30 * 60 * 1000) {
                        alert('Oturum s√ºreniz doldu. Tekrar giri≈ü yapƒ±n.');
                        logout();
                    }
                }
            }, 5 * 60 * 1000);
        });
        
    </script>
    
    <!-- Developer Credit -->
    <div style="position: fixed; bottom: 10px; right: 25px; font-size: 11px; color: #999; z-index: 9999; font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; background: rgba(255,255,255,0.9); padding: 5px 12px; border-radius: 15px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); backdrop-filter: blur(5px);">
        Developed by <strong style="color: #667eea;">Tofta</strong>
    </div>
</body>
</html>

