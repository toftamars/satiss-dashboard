<!DOCTYPE html><html lang="tr"><head><meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Zuhal Müzik Raporlama</title><link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>📊</text></svg>"><meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate"><meta http-equiv="Pragma" content="no-cache"><meta http-equiv="Expires" content="0"><script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script><script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script><script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script><script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0/dist/chartjs-plugin-datalabels.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script><script src="performance-optimizer.js"></script><script src="ai-analyzer-enhanced.js"></script><script src="time-analysis-enhanced.js"></script><script>(()=>{var e=sessionStorage.getItem("isLoggedIn"),o=sessionStorage.getItem("username");"true"===e&&o||(window.location.href="login.html")})()</script><style>*{margin:0;padding:0;box-sizing:border-box}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,'Helvetica Neue',Arial,sans-serif;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);min-height:100vh;padding:20px}.container{max-width:1400px;margin:0 auto;background:#fff;border-radius:20px;box-shadow:0 20px 60px rgba(0,0,0,.3);overflow:hidden}.header{background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;padding:30px;text-align:center;position:relative}.header h1{font-size:2.5em;margin-bottom:10px}.header p{font-size:1.2em;opacity:.9}.user-info{position:absolute;top:20px;right:30px;display:flex;align-items:center;gap:15px;background:rgba(255,255,255,.2);padding:10px 20px;border-radius:25px;backdrop-filter:blur(10px)}.user-name{font-size:14px;font-weight:500}.logout-btn{background:rgba(255,255,255,.3);border:1px solid rgba(255,255,255,.5);color:#fff;padding:6px 16px;border-radius:15px;cursor:pointer;font-size:13px;font-weight:500;transition:all .3s ease}.logout-btn:hover{background:rgba(255,255,255,.4);transform:translateY(-1px)}.info-box{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;padding:30px;background:#f8f9fa;border-bottom:1px solid #dee2e6}.info-card{background:#fff;padding:20px;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}.info-card h3{font-size:.9em;color:#6c757d;margin-bottom:10px;text-transform:uppercase;letter-spacing:.5px}.info-card p{font-size:1.5em;color:#212529;font-weight:600}.search-section{padding:30px;background:#fff;border-bottom:1px solid #dee2e6}.search-box{display:flex;gap:10px;max-width:800px;margin:0 auto}.search-box input{flex:1;padding:15px 20px;font-size:1.1em;border:2px solid #dee2e6;border-radius:10px;outline:0;transition:all .3s}.search-box input:focus{border-color:#667eea;box-shadow:0 0 0 3px rgba(102,126,234,.1)}.search-box button{padding:15px 30px;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;border:none;border-radius:10px;font-size:1.1em;font-weight:600;cursor:pointer;transition:transform .2s}.search-box button:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(102,126,234,.3)}.filters-section{padding:30px;background:#f8f9fa;border-bottom:1px solid #dee2e6}.filters-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px;margin-bottom:20px}.filter-group label{display:block;font-size:.9em;font-weight:600;color:#495057;margin-bottom:5px}.filter-group select{width:100%;padding:10px;border:2px solid #dee2e6;border-radius:8px;font-size:1em;outline:0;transition:all .3s;min-height:42px}.filter-group select[multiple]{display:none}.filter-search-box{position:relative;margin-bottom:8px}.filter-search-input{width:100%;padding:8px 30px 8px 10px;border:1px solid #ddd;border-radius:5px;font-size:.9em;box-sizing:border-box}.filter-search-input:focus{outline:0;border-color:#667eea}.filter-search-clear{position:absolute;right:8px;top:50%;transform:translateY(-50%);background:0 0;border:none;color:#999;cursor:pointer;font-size:1.2em;padding:0;width:20px;height:20px;display:none}.filter-search-clear:hover{color:#333}.checkbox-container{max-height:200px;overflow-y:auto;border:2px solid #dee2e6;border-radius:8px;padding:10px;background:#fff}.checkbox-item{display:flex;align-items:center;padding:8px;cursor:pointer;border-radius:5px;transition:background .2s}.checkbox-item.hidden{display:none}.checkbox-item:hover{background:#f8f9fa}.checkbox-item input[type=checkbox]{width:18px;height:18px;margin-right:10px;cursor:pointer;accent-color:#667eea}.checkbox-item label{cursor:pointer;flex:1;margin:0;font-size:.95em}.filter-group select:focus{border-color:#667eea}.selected-count{font-size:.85em;color:#667eea;margin-top:3px;font-weight:600}.filter-buttons{display:flex;gap:10px;justify-content:flex-end}.filter-buttons button{padding:10px 20px;border:none;border-radius:8px;font-weight:600;cursor:pointer;transition:all .3s}.btn-apply{background:#28a745;color:#fff}.btn-reset{background:#6c757d;color:#fff}.btn-apply:hover{background:#218838}.btn-reset:hover{background:#5a6268}.content{padding:30px}.summary-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(250px,1fr));gap:20px;margin-bottom:30px}.summary-card{background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;padding:25px;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,.2)}.summary-card h3{font-size:.9em;opacity:.9;margin-bottom:10px}.summary-card p{font-size:2em;font-weight:700}.table-wrapper{overflow-x:auto;border-radius:10px;box-shadow:0 2px 10px rgba(0,0,0,.1)}.data-table{width:100%;border-collapse:collapse;background:#fff;min-width:1200px}.data-table thead{background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;position:sticky;top:0;z-index:10}.data-table th{padding:15px 10px;text-align:left;font-weight:600;cursor:pointer;user-select:none;white-space:nowrap;font-size:.9em}.data-table th:hover{background:rgba(255,255,255,.1)}.data-table td{padding:10px;border-bottom:1px solid #dee2e6;font-size:.9em;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}.data-table td:hover{overflow:visible;white-space:normal;word-wrap:break-word;position:relative;z-index:5;background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.15)}.data-table tbody tr:hover{background:#f8f9fa}.data-table td.numeric{text-align:right;font-family:'Courier New',monospace}.loading{text-align:center;padding:50px;font-size:1.2em;color:#6c757d}.error{text-align:center;padding:50px;color:#dc3545;font-size:1.2em}.status-badge{display:inline-block;padding:5px 10px;border-radius:5px;font-size:.85em;font-weight:600}.status-success{background:#d4edda;color:#155724}.status-warning{background:#fff3cd;color:#856404}.status-error{background:#f8d7da;color:#721c24}.tabs{display:flex;background:#f8f9fa;border-bottom:2px solid #dee2e6;padding:0 30px}.tab{padding:15px 30px;cursor:pointer;border:none;background:0 0;font-size:1.1em;font-weight:600;color:#6c757d;transition:all .3s;border-bottom:3px solid transparent}.tab:hover{color:#667eea;background:rgba(102,126,234,.1)}.tab.active{color:#667eea;border-bottom-color:#667eea;background:#fff}.tab-content{display:none}.tab-content.active{display:block}.voice-btn{padding:15px 20px;background:linear-gradient(135deg,#f093fb 0,#f5576c 100%);color:#fff;border:none;border-radius:10px;font-size:1.5em;cursor:pointer;transition:all .3s}.voice-btn:hover{transform:scale(1.1);box-shadow:0 5px 15px rgba(245,87,108,.4)}.voice-btn.listening{animation:pulse 1.5s infinite}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}.target-section{background:#f8f9fa;padding:30px;border-radius:15px;margin-bottom:30px}.target-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-top:20px}.target-card{background:#fff;padding:25px;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,.1)}.target-card h3{font-size:1.2em;color:#495057;margin-bottom:15px}.target-input{width:100%;padding:12px;border:2px solid #dee2e6;border-radius:8px;font-size:1.1em;margin-bottom:15px}.progress-bar{width:100%;height:30px;background:#e9ecef;border-radius:15px;overflow:hidden;margin:15px 0}.progress-fill{height:100%;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);transition:width .5s ease;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:600}.target-stats{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;margin-top:15px}.target-stat{background:#f8f9fa;padding:10px;border-radius:8px;text-align:center}.target-stat label{font-size:.85em;color:#6c757d;display:block;margin-bottom:5px}.target-stat value{font-size:1.3em;font-weight:700;color:#212529}.customer-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:20px;margin-bottom:30px}.customer-card{background:#fff;padding:20px;border-radius:15px;box-shadow:0 5px 15px rgba(0,0,0,.1);transition:transform .3s}.customer-card:hover{transform:translateY(-5px);box-shadow:0 10px 25px rgba(0,0,0,.15)}.customer-rank{display:inline-block;width:40px;height:40px;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;border-radius:50%;text-align:center;line-height:40px;font-weight:700;font-size:1.2em;margin-right:15px}.chart-container{position:relative;height:400px;margin:30px 0}.export-btn{padding:12px 25px;background:linear-gradient(135deg,#11998e 0,#38ef7d 100%);color:#fff;border:none;border-radius:10px;font-size:1em;font-weight:600;cursor:pointer;transition:all .3s;margin-left:10px}.export-btn:hover{transform:translateY(-2px);box-shadow:0 5px 15px rgba(17,153,142,.3)}.analysis-panel{background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;padding:30px;border-radius:15px;margin:30px 0;box-shadow:0 10px 30px rgba(0,0,0,.2)}.analysis-section{background:rgba(255,255,255,.1);padding:20px;border-radius:10px;margin:15px 0;backdrop-filter:blur(10px)}.analysis-section h3{margin:0 0 15px 0;font-size:1.3em;display:flex;align-items:center;gap:10px}.insight-item{background:rgba(255,255,255,.15);padding:15px;border-radius:8px;margin:10px 0;border-left:4px solid}.insight-positive{border-left-color:#38ef7d}.insight-negative{border-left-color:#f5576c}.insight-neutral{border-left-color:gold}.insight-icon{font-size:1.5em;margin-right:10px}.recommendation{background:rgba(255,255,255,.2);padding:15px;border-radius:8px;margin:10px 0;display:flex;align-items:start;gap:15px}.recommendation-icon{font-size:2em;flex-shrink:0}.metric-highlight{display:inline-block;background:rgba(255,255,255,.3);padding:3px 10px;border-radius:5px;font-weight:700;margin:0 5px}@media (max-width:768px){body{padding:10px}.container{border-radius:10px}.header h1{font-size:1.5em;margin-bottom:5px}.header p{font-size:.9em}.header{padding:20px 15px}.info-cards{grid-template-columns:1fr;gap:10px;padding:15px}.info-card{padding:15px}.info-card h3{font-size:.9em}.info-card p{font-size:1.2em}.tabs{overflow-x:auto;overflow-y:hidden;white-space:nowrap;-webkit-overflow-scrolling:touch;padding:10px 5px;gap:5px;scrollbar-width:thin}.tabs::-webkit-scrollbar{height:4px}.tabs::-webkit-scrollbar-thumb{background:#667eea;border-radius:2px}.tab{display:inline-block;padding:12px 20px;font-size:.85em;min-width:auto;white-space:nowrap}.content{padding:15px}.content h2{font-size:1.3em;margin-bottom:15px}.content h3{font-size:1.1em;margin-bottom:10px}.summary-cards{grid-template-columns:1fr;gap:10px}.summary-card{padding:15px}.summary-card h3{font-size:.9em}.summary-card p{font-size:1.3em}.filters{grid-template-columns:1fr;gap:15px}.filter-group{padding:12px}.filter-group label{font-size:.9em}.filter-group input,.filter-group select{font-size:.9em;padding:10px}.multi-select-dropdown{max-height:200px}.checkbox-item{padding:10px 8px}.checkbox-item label{font-size:.9em}.search-section{padding:15px}.search-box input{font-size:.9em;padding:12px}.search-box button{padding:12px 20px;font-size:.9em}button{padding:12px 20px;font-size:.9em;min-height:44px}.chart-container{min-height:250px;padding:15px;margin-bottom:20px}.chart-container h3{font-size:1em;margin-bottom:10px}.content>div[style*=grid-template-columns]{grid-template-columns:1fr!important;gap:15px!important}table{font-size:.85em;display:block;overflow-x:auto;white-space:nowrap;-webkit-overflow-scrolling:touch}table tbody,table thead,table tr{display:table;width:100%;table-layout:fixed}table td,table th{padding:8px!important;min-width:80px}.customer-card{margin-bottom:15px}.customer-grid{grid-template-columns:1fr!important;gap:15px!important}.target-section{padding:15px}.target-input-group{grid-template-columns:1fr!important;gap:15px}.target-input-group input{font-size:.9em;padding:10px}.progress-item{margin-bottom:15px}.analysis-panel{padding:20px 15px}.analysis-section{margin:15px 0}.insight-item{padding:12px;margin:8px 0;font-size:.9em}.recommendation{padding:12px;margin:10px 0;font-size:.9em}#cityAnalysisContainer,#customerProfileContainer,#customerProfileMainContainer,#productResultsContainer,#salespersonProfileContainer{padding:10px}div[style*="grid-template-columns: repeat(auto-fit"]{grid-template-columns:1fr!important}input[type=number],input[type=text],select,textarea{font-size:16px!important}.tabs{position:sticky;top:0;z-index:100;background:#fff;box-shadow:0 2px 10px rgba(0,0,0,.1)}#voiceButton{width:44px;height:44px;padding:10px}button[onclick*=exportToExcel]{width:100%;margin-top:10px}#debugPanel{font-size:.8em;padding:10px}table::after{content:"← Kaydırın →";display:block;text-align:center;padding:10px;background:#f8f9fa;color:#6c757d;font-size:.85em;border-top:1px solid #dee2e6}table.scrolled::after{display:none}.content>*{margin-bottom:20px}.swal2-popup{width:90%!important;font-size:.9em!important}}@media (min-width:769px) and (max-width:1024px){.container{max-width:100%}.tabs{overflow-x:auto;white-space:nowrap}.tab{font-size:.9em;padding:12px 20px}.content{padding:20px}.filters{grid-template-columns:repeat(2,1fr)}div[style*="grid-template-columns: repeat(auto-fit"]{grid-template-columns:repeat(2,1fr)!important}}@media (max-width:768px) and (orientation:landscape){.header h1{font-size:1.3em}.chart-container{min-height:200px}.summary-cards{grid-template-columns:repeat(2,1fr)}}</style></head><body><div id="loadingScreen" style="position:fixed;top:0;left:0;width:100%;height:100%;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);z-index:9999;display:flex;flex-direction:column;justify-content:center;align-items:center;color:#fff"><div style="text-align:center"><div id="loadingIcon" style="font-size:4em;margin-bottom:20px;animation:pulse 2s infinite">📊</div><h1 style="margin:0 0 10px 0;font-size:2.5em;animation:fadeInUp 1s ease">Zuhal Müzik Raporlama</h1><p style="margin:0 0 30px 0;font-size:1.2em;opacity:.9;animation:fadeInUp 1s ease .2s both">Hoş Geldiniz! Veriler yükleniyor...</p><div style="width:400px;height:8px;background:rgba(255,255,255,.3);border-radius:4px;margin:0 auto 15px;overflow:hidden;animation:fadeInUp 1s ease .4s both"><div id="progressBar" style="width:0%;height:100%;background:linear-gradient(90deg,#4ade80 0,#22c55e 100%);border-radius:4px;transition:width .3s ease;position:relative"><div style="position:absolute;top:0;left:0;width:100%;height:100%;background:linear-gradient(90deg,transparent 0,rgba(255,255,255,.3) 50%,transparent 100%);animation:shimmer 2s infinite"></div></div></div><div id="progressText" style="font-size:1.1em;font-weight:600;margin-bottom:20px;animation:fadeInUp 1s ease .6s both">0%</div><div id="loadingSteps" style="font-size:.9em;opacity:.8;animation:fadeInUp 1s ease .8s both"><div id="step1" style="margin-bottom:8px;transition:all .3s ease">🔄 Sayfa başlatılıyor...</div><div id="step2" style="display:none;margin-bottom:8px;transition:all .3s ease">📊 Veri dosyaları yükleniyor...</div><div id="step3" style="display:none;margin-bottom:8px;transition:all .3s ease">🎯 Hedefler yükleniyor...</div><div id="step4" style="display:none;margin-bottom:8px;transition:all .3s ease">✅ Hazırlanıyor...</div></div></div></div><style>@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.1)}}@keyframes fadeInUp{from{opacity:0;transform:translateY(30px)}to{opacity:1;transform:translateY(0)}}@keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}#loadingScreen .loading-step{opacity:.5;transition:opacity .3s ease}#loadingScreen .loading-step.active{opacity:1;color:#4ade80}</style><div class="container" style="display:none" id="mainContainer"><div class="header"><h1>📊 Zuhal Müzik Raporlama</h1><p>Müzik Enstrüman Sektörü</p><div class="user-info"><span class="user-name" id="currentUserName">Kullanıcı</span> <button class="logout-btn" onclick="logout()">🚪 Çıkış</button></div></div><div style="background:linear-gradient(135deg,#667eea 0,#764ba2 100%);padding:25px;border-radius:15px;margin-bottom:20px;box-shadow:0 10px 30px rgba(102,126,234,.3)"><h3 style="color:#fff;margin:0 0 15px 0;font-size:1.3em">🏢 Satış Kanalı Filtresi</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px"><label style="background:rgba(255,255,255,.15);padding:12px 15px;border-radius:10px;cursor:pointer;display:flex;align-items:center;transition:all .3s;color:#fff;font-weight:500" onmouseover='this.style.background="rgba(255,255,255,0.25)"' onmouseout='this.style.background="rgba(255,255,255,0.15)"'><input type="checkbox" id="channelAll" checked="checked" onchange='handleChannelFilter("channelAll")' style="margin-right:10px;width:18px;height:18px;cursor:pointer"> <span>✨ Tümü (19 Kanal)</span></label> <label style="background:rgba(255,255,255,.15);padding:12px 15px;border-radius:10px;cursor:pointer;display:flex;align-items:center;transition:all .3s;color:#fff;font-weight:500" onmouseover='this.style.background="rgba(255,255,255,0.25)"' onmouseout='this.style.background="rgba(255,255,255,0.15)"'><input type="checkbox" id="channelRetail" onchange='handleChannelFilter("channelRetail")' style="margin-right:10px;width:18px;height:18px;cursor:pointer"> <span>🏪 Perakende (14)</span></label> <label style="background:rgba(255,255,255,.15);padding:12px 15px;border-radius:10px;cursor:pointer;display:flex;align-items:center;transition:all .3s;color:#fff;font-weight:500" onmouseover='this.style.background="rgba(255,255,255,0.25)"' onmouseout='this.style.background="rgba(255,255,255,0.15)"'><input type="checkbox" id="channelWholesale" onchange='handleChannelFilter("channelWholesale")' style="margin-right:10px;width:18px;height:18px;cursor:pointer"> <span>📦 Toptan Satış</span></label> <label style="background:rgba(255,255,255,.15);padding:12px 15px;border-radius:10px;cursor:pointer;display:flex;align-items:center;transition:all .3s;color:#fff;font-weight:500" onmouseover='this.style.background="rgba(255,255,255,0.25)"' onmouseout='this.style.background="rgba(255,255,255,0.15)"'><input type="checkbox" id="channelOnline" onchange='handleChannelFilter("channelOnline")' style="margin-right:10px;width:18px;height:18px;cursor:pointer"> <span>🌐 Online Satış</span></label> <label style="background:rgba(255,255,255,.15);padding:12px 15px;border-radius:10px;cursor:pointer;display:flex;align-items:center;transition:all .3s;color:#fff;font-weight:500" onmouseover='this.style.background="rgba(255,255,255,0.25)"' onmouseout='this.style.background="rgba(255,255,255,0.15)"'><input type="checkbox" id="channelCorporate" onchange='handleChannelFilter("channelCorporate")' style="margin-right:10px;width:18px;height:18px;cursor:pointer"> <span>🏢 Kurumsal Satış</span></label> <label style="background:rgba(255,255,255,.15);padding:12px 15px;border-radius:10px;cursor:pointer;display:flex;align-items:center;transition:all .3s;color:#fff;font-weight:500" onmouseover='this.style.background="rgba(255,255,255,0.25)"' onmouseout='this.style.background="rgba(255,255,255,0.15)"'><input type="checkbox" id="channelCentral" onchange='handleChannelFilter("channelCentral")' style="margin-right:10px;width:18px;height:18px;cursor:pointer"> <span>🏛️ Merkezi Satış</span></label></div><div id="channelFilterInfo" style="margin-top:12px;padding:10px 15px;background:rgba(255,255,255,.2);border-radius:8px;color:#fff;font-size:.9em;text-align:center">📊 Aktif: Tüm Kanallar</div></div><div id="channelLoadingSpinner" style="display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);z-index:9999;justify-content:center;align-items:center"><div style="text-align:center"><div style="width:80px;height:80px;border:8px solid rgba(255,255,255,.2);border-top:8px solid #667eea;border-radius:50%;animation:spin 1s linear infinite;margin:0 auto 20px"></div><div style="color:#fff;font-size:1.3em;font-weight:700" id="channelLoadingText">🔄 Filtreleniyor...</div><div style="color:rgba(255,255,255,.7);font-size:.9em;margin-top:10px">Lütfen bekleyin</div></div></div><style>@keyframes spin{0%{transform:rotate(0)}100%{transform:rotate(360deg)}}</style><div class="info-box"><div class="info-card"><h3>📊 Veri Durumu</h3><p id="dataStatus">Yukleniyor...</p></div><div class="info-card"><h3>Son Guncelleme</h3><p id="lastUpdate">-</p></div><div class="info-card"><h3>Toplam Kayit</h3><p id="totalRecords">-</p></div><div class="info-card"><h3>Toplam USD (KDV Hariç)</h3><p id="totalUSD">-</p></div><div class="info-card"><h3>📅 Günlük Ortalama</h3><p id="dailyAverage">-</p></div><div class="info-card"><h3>🛒 Sepet Ortalaması</h3><p id="basketAverage">-</p></div></div><div class="tabs"><button class="tab active" onclick='switchTab("dashboard")'>🏠 Dashboard</button> <button class="tab" onclick='switchTab("targets")'>🎯 Hedef Takip</button> <button class="tab" onclick='switchTab("customers")'>👥 Müşteri Analizi</button> <button class="tab" onclick='switchTab("salesperson")'>👨‍💼 Satış Temsilcisi</button> <button class="tab" onclick='switchTab("store")'>🏪 Mağaza Analizi</button> <button class="tab" onclick='switchTab("city")'>🌍 Şehir Analizi</button> <button class="tab" onclick='switchTab("stock")'>📦 Stok Dağılım</button> <button class="tab" onclick='switchTab("time")'>⏰ Zaman Analizi</button> <button class="tab" onclick='switchTab("product")'>🎸 Ürün, Marka ve Kategori Analizi</button></div><div id="dashboardTab" class="tab-content active"><div class="content"><h2 style="margin-bottom:30px;text-align:center">🏠 Zuhal Müzik - Genel Dashboard</h2><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:20px;margin-bottom:40px"><div class="summary-card" style="background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;padding:20px"><h3 style="font-size:.95em;margin-bottom:10px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis">💰 Toplam Satış</h3><p id="dashTotalSales" style="color:#fff;font-size:1.6em;font-weight:700;margin:10px 0;word-break:break-all">$0</p><small style="opacity:.9;font-size:.85em">KDV Hariç - Tüm zamanlar</small></div><div class="summary-card" style="background:linear-gradient(135deg,#f093fb 0,#f5576c 100%);color:#fff;padding:20px"><h3 style="font-size:.95em;margin-bottom:10px">📦 Toplam Ürün</h3><p id="dashTotalQty" style="color:#fff;font-size:1.6em;font-weight:700;margin:10px 0">0</p><small style="opacity:.9;font-size:.85em">Satılan ürün adedi</small></div><div class="summary-card" style="background:linear-gradient(135deg,#4facfe 0,#00f2fe 100%);color:#fff;padding:20px"><h3 style="font-size:.95em;margin-bottom:10px">👥 Müşteri</h3><p id="dashTotalCustomers" style="color:#fff;font-size:1.6em;font-weight:700;margin:10px 0">0</p><small style="opacity:.9;font-size:.85em">Aktif müşteri sayısı</small></div><div class="summary-card" style="background:linear-gradient(135deg,#43e97b 0,#38f9d7 100%);color:#fff;padding:20px"><h3 style="font-size:.95em;margin-bottom:10px">🎸 Farklı Ürün</h3><p id="dashTotalProducts" style="color:#fff;font-size:1.6em;font-weight:700;margin:10px 0">0</p><small style="opacity:.9;font-size:.85em">Ürün çeşidi</small></div><div class="summary-card" style="background:linear-gradient(135deg,#fa709a 0,#fee140 100%);color:#fff;padding:20px"><h3 style="font-size:.95em;margin-bottom:10px">🏪 Mağaza</h3><p id="dashTotalStores" style="color:#fff;font-size:1.6em;font-weight:700;margin:10px 0">0</p><small style="opacity:.9;font-size:.85em">Aktif mağaza sayısı</small></div><div class="summary-card" style="background:linear-gradient(135deg,#30cfd0 0,#330867 100%);color:#fff;padding:20px"><h3 style="font-size:.95em;margin-bottom:10px">👨‍💼 Temsilci</h3><p id="dashTotalSalespeople" style="color:#fff;font-size:1.6em;font-weight:700;margin:10px 0">0</p><small style="opacity:.9;font-size:.85em">Aktif temsilci sayısı</small></div><div class="summary-card" style="background:linear-gradient(135deg,#ffa751 0,#ffe259 100%);color:#fff;padding:20px"><h3 style="font-size:.95em;margin-bottom:10px">📅 Günlük Ortalama</h3><p id="dashDailyAverage" style="color:#fff;font-size:1.6em;font-weight:700;margin:10px 0">$0</p><small style="opacity:.9;font-size:.85em">Günlük ortalama satış</small></div><div class="summary-card" style="background:linear-gradient(135deg,#a8edea 0,#fed6e3 100%);color:#fff;padding:20px"><h3 style="font-size:.95em;margin-bottom:10px">🛒 Sepet Ortalaması</h3><p id="dashBasketAverage" style="color:#fff;font-size:1.6em;font-weight:700;margin:10px 0">$0</p><small style="opacity:.9;font-size:.85em">Ortalama işlem tutarı</small></div></div><div style="background:#fff;padding:30px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,.1);margin-bottom:40px"><div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:20px"><h3 style="margin:0">📊 Yıllık Satış Karşılaştırması</h3><div style="display:flex;gap:10px"><button id="dashYearlyMetricSales" onclick='changeDashYearlyMetric("sales")' style="padding:8px 20px;border:2px solid #667eea;background:#667eea;color:#fff;border-radius:8px;cursor:pointer;font-weight:600;transition:all .3s">💰 Satış (USD)</button> <button id="dashYearlyMetricQty" onclick='changeDashYearlyMetric("qty")' style="padding:8px 20px;border:2px solid #667eea;background:#fff;color:#667eea;border-radius:8px;cursor:pointer;font-weight:600;transition:all .3s">📦 Miktar</button></div></div><canvas id="dashYearlyChart" style="max-height:400px"></canvas></div><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:30px;margin-bottom:40px"><div style="background:#fff;padding:25px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,.1);height:580px"><h3 style="margin-bottom:20px">🏆 Top 10 Mağaza (Tüm Zamanlar)</h3><canvas id="dashTopStoresChart" style="height:500px;max-height:500px"></canvas></div><div style="background:#fff;padding:25px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,.1);height:580px"><h3 style="margin-bottom:20px">⭐ Top 10 Satış Temsilcisi (Tüm Zamanlar)</h3><canvas id="dashTopSalespeopleChart" style="height:500px;max-height:500px"></canvas></div><div style="background:#fff;padding:25px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,.1);height:580px"><h3 style="margin-bottom:20px">🏷️ Top 10 Marka (Tüm Zamanlar)</h3><canvas id="dashTopBrandsChart" style="height:500px;max-height:500px"></canvas></div><div style="background:#fff;padding:25px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,.1);height:580px"><h3 style="margin-bottom:20px">📂 Top 10 Kategori (Tüm Zamanlar)</h3><canvas id="dashTopCategoriesChart" style="height:500px;max-height:500px"></canvas></div><div style="background:#fff;padding:25px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,.1);height:580px"><h3 style="margin-bottom:20px">🌍 Top 10 Şehir (Tüm Zamanlar)</h3><canvas id="dashTopCitiesChart" style="height:500px;max-height:500px"></canvas></div><div style="background:#fff;padding:25px;border-radius:15px;box-shadow:0 4px 15px rgba(0,0,0,.1);height:580px"><h3 style="margin-bottom:20px">🎸 Top 10 Ürün (Tüm Zamanlar)</h3><canvas id="dashTopProductsChart" style="height:500px;max-height:500px"></canvas></div></div><div style="background:linear-gradient(135deg,#667eea 0,#764ba2 100%);padding:30px;border-radius:15px;margin-bottom:40px"><h3 style="color:#fff;margin-bottom:20px">🤖 AI Dashboard Analizi</h3><div id="dashAIAnalysis" style="background:#fff;padding:20px;border-radius:10px;line-height:1.8"></div></div></div></div><div id="targetsTab" class="tab-content"><div class="content"><h2 style="margin-bottom:30px">🎯 Hedef Takip Sistemi</h2><div style="background:linear-gradient(135deg,#667eea 0,#764ba2 100%);padding:30px;border-radius:15px;margin-bottom:30px"><h3 style="color:#fff;margin:0 0 20px 0">📅 Dönem Seçin</h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;max-width:600px"><div><label style="color:#fff;display:block;margin-bottom:8px;font-weight:600">Yıl</label> <select id="targetFilterYear" class="target-input" onchange="loadAllStoresTargets()" style="width:100%"><option value="2025">2025</option><option value="2024">2024</option><option value="2023">2023</option></select></div><div><label style="color:#fff;display:block;margin-bottom:8px;font-weight:600">Ay (Opsiyonel)</label> <select id="targetFilterMonth" class="target-input" onchange="loadAllStoresTargets()" style="width:100%"><option value="">Tüm Yıl</option><option value="01">Ocak</option><option value="02">Şubat</option><option value="03">Mart</option><option value="04">Nisan</option><option value="05">Mayıs</option><option value="06">Haziran</option><option value="07">Temmuz</option><option value="08">Ağustos</option><option value="09">Eylül</option><option value="10">Ekim</option><option value="11">Kasım</option><option value="12">Aralık</option></select></div></div><p style="color:#fff;opacity:.9;margin-top:15px;font-size:.95em">💡 İpucu: Sadece yıl seçerseniz yıllık hedefler, yıl + ay seçerseniz aylık hedefler gösterilir</p></div><div id="allStoresTargetsContainer"></div></div></div><div id="customersTab" class="tab-content"><div class="content"><h2 style="margin-bottom:20px">👥 Müşteri Analizi</h2><div class="summary-cards"><div class="summary-card"><h3>Toplam Müşteri</h3><p id="totalCustomers">0</p></div><div class="summary-card"><h3>Aktif Müşteri (Son 90 Gün)</h3><p id="activeCustomers">0</p></div><div class="summary-card"><h3>Ortalama Sipariş</h3><p id="avgOrderValue">$0</p></div><div class="summary-card"><h3>En Yüksek Sipariş</h3><p id="maxOrderValue">$0</p></div></div><div style="background:linear-gradient(135deg,#667eea 0,#764ba2 100%);padding:30px;border-radius:15px;margin:30px 0"><h3 style="color:#fff;margin:0 0 20px 0">🔍 Müşteri Arama</h3><div style="display:flex;gap:10px;max-width:600px"><div style="position:relative;flex:1"><input type="text" id="customerSearchInputMain" placeholder="Müşteri adı yazın... (örn: Ahmet Yılmaz)" style="width:100%;padding:15px 60px 15px 15px;font-size:1em;border:2px solid #fff;border-radius:10px;outline:0" onkeyup='"Enter"===event.key&&searchCustomerProfileMain()'> <button onclick="searchCustomerProfileMain()" style="position:absolute;right:5px;top:50%;transform:translateY(-50%);background:#fff;color:#667eea;border:none;padding:10px 20px;border-radius:8px;cursor:pointer;font-weight:700">🔍 Ara</button></div><button onclick="clearCustomerSearchMain()" style="background:rgba(255,255,255,.2);border:2px solid #fff;color:#fff;padding:15px 20px;border-radius:10px;cursor:pointer;font-weight:700;transition:all .3s" onmouseover='this.style.background="rgba(255,255,255,0.3)"' onmouseout='this.style.background="rgba(255,255,255,0.2)"'>🗑️ Temizle</button></div><p style="color:#fff;opacity:.9;margin-top:10px;font-size:.9em">💡 Müşteri adının bir kısmını yazmak yeterli</p></div><div id="customerProfileMainContainer" style="display:none;margin-bottom:40px"><div style="background:linear-gradient(135deg,#38ef7d 0,#11998e 100%);color:#fff;padding:30px;border-radius:15px;margin-bottom:30px"><h3 style="margin:0 0 15px 0;font-size:1.8em">👤 <span id="customerNameMain">-</span></h3><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:15px"><div><div style="opacity:.8;font-size:.85em">🌍 Şehir</div><div style="font-size:1.1em;font-weight:700" id="customerCityMain">-</div></div><div><div style="opacity:.8;font-size:.85em">🏷️ Etiketler</div><div style="font-size:.95em;font-weight:700" id="customerTagsMain">-</div></div><div><div style="opacity:.8;font-size:.85em">💰 Toplam Alışveriş</div><div style="font-size:1.3em;font-weight:700" id="customerTotalSalesMain">$0</div></div><div><div style="opacity:.8;font-size:.85em">📦 Toplam Adet</div><div style="font-size:1.3em;font-weight:700" id="customerTotalQtyMain">0</div></div><div><div style="opacity:.8;font-size:.85em">🛒 İşlem Sayısı</div><div style="font-size:1.3em;font-weight:700" id="customerTransactionCountMain">0</div></div><div><div style="opacity:.8;font-size:.85em">📊 Ortalama Sepet</div><div style="font-size:1.3em;font-weight:700" id="customerAvgBasketMain">$0</div></div></div></div><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(400px,1fr));gap:20px;margin-bottom:30px"><div class="chart-container"><h3 style="text-align:center;margin-bottom:15px">🏷️ En Çok Tercih Ettiği Markalar</h3><canvas id="customerBrandChartMain"></canvas></div><div class="chart-container"><h3 style="text-align:center;margin-bottom:15px">📂 En Çok Aldığı Kategoriler</h3><canvas id="customerCategoryChartMain"></canvas></div></div><div style="margin-top:30px"><h3 style="margin-bottom:15px">🛍️ Son Alışverişler (Son 20)</h3><div id="customerPurchaseHistoryMain" style="overflow-x:auto"></div></div><div id="customerAIAnalysisPanelMain" style="margin:40px 0;display:none"><h3 style="margin-bottom:20px">🤖 AI Müşteri Analizi, Yorum ve Öneriler</h3><div id="customerAIAnalysisContentMain"></div></div></div><div id="topCustomersSection"><h3 style="margin:30px 0 20px 0">🏆 Top 30 Müşteri</h3><div class="customer-grid" id="topCustomersGrid"></div></div><div id="customerChartsSection" style="margin-top:30px"><div class="chart-container" style="margin-bottom:30px"><h3 style="text-align:center;margin-bottom:20px">📊 Yıllık Müşteri Trendi</h3><canvas id="customerTrendChart" style="max-height:400px"></canvas></div><div class="chart-container" style="max-width:600px;margin:0 auto"><h3 style="text-align:center;margin-bottom:20px">🌍 Müşteri Dağılımı (Şehir)</h3><canvas id="customerCityChart"></canvas></div></div></div></div><div id="timeTab" class="tab-content"><div class="content"><h2 style="margin-bottom:20px">⏰ Zaman Analizi</h2><div style="background:linear-gradient(135deg,#667eea 0,#764ba2 100%);padding:20px;border-radius:15px;margin-bottom:30px"><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:15px"><div><label style="display:block;margin-bottom:8px;color:#fff;font-weight:600">📁 Kategori</label> <select id="timeCategory1Filter" onchange="analyzeTime()" style="width:100%;padding:10px;border:none;border-radius:8px;font-size:1em"><option value="">Tüm Kategoriler</option></select></div><div style="display:flex;align-items:end"><button onclick="clearTimeFilters()" style="width:100%;padding:10px 20px;background:rgba(255,255,255,.2);color:#fff;border:2px solid #fff;border-radius:8px;cursor:pointer;font-weight:700;font-size:1em">🔄 Temizle</button></div></div></div><div class="summary-cards"><div class="summary-card"><h3>En Yoğun Saat</h3><p id="peakHour">-</p></div><div class="summary-card"><h3>En Yoğun Gün</h3><p id="peakDay">-</p></div><div class="summary-card"><h3>Mesai Saati Satış</h3><p id="workHoursSales">-</p></div><div class="summary-card"><h3>Hafta Sonu Satış</h3><p id="weekendSales">-</p></div></div><div id="timeInsightsPanel" style="display:none"></div><div class="chart-container" style="margin:30px 0"><h3 style="text-align:center;margin-bottom:20px">📊 Saatlik Yoğunluk (24 Saat)</h3><canvas id="hourlyChart"></canvas></div><div class="chart-container" style="margin:30px 0"><h3 style="text-align:center;margin-bottom:20px">📅 Aylık Trend</h3><canvas id="monthlyTrendChart"></canvas></div><div class="chart-container" style="margin:30px 0"><h3 style="text-align:center;margin-bottom:20px">📊 Yıllık Trend</h3><canvas id="yearlyTrendChart"></canvas></div><div style="margin:30px 0"><h3 style="text-align:center;margin-bottom:20px">🏪 Mağaza Bazında Saat Karşılaştırması</h3><div style="margin-bottom:20px;text-align:center"><label>Mağaza Seç:</label> <select id="storeTimeFilter" onchange="renderStoreTimeChart()" style="padding:8px;border-radius:5px;border:1px solid #ddd"><option value="">Tüm Mağazalar</option></select></div><div class="chart-container"><canvas id="storeTimeChart"></canvas></div></div><div style="margin:30px 0"><h3 style="text-align:center;margin-bottom:20px">📦 Kategori Bazında Saat Analizi</h3><div style="margin-bottom:20px;text-align:center"><label>Kategori Seç:</label> <select id="categoryTimeFilter" onchange="renderCategoryTimeChart()" style="padding:8px;border-radius:5px;border:1px solid #ddd"><option value="">Tüm Kategoriler</option></select></div><div class="chart-container"><canvas id="categoryTimeChart"></canvas></div></div><div style="margin:30px 0"><h3 style="text-align:center;margin-bottom:20px">👤 Satış Temsilcisi Bazında Saat Analizi</h3><div style="margin-bottom:20px;text-align:center"><label>Temsilci Seç:</label> <select id="salesPersonTimeFilter" onchange="renderSalesPersonTimeChart()" style="padding:8px;border-radius:5px;border:1px solid #ddd"><option value="">Tüm Temsilciler</option></select></div><div class="chart-container"><canvas id="salesPersonTimeChart"></canvas></div></div></div></div><div id="productTab" class="tab-content"><div class="content"><h2 style="margin-bottom:20px">🎸 Ürün, Marka ve Kategori Analizi</h2><div style="background:linear-gradient(135deg,#667eea 0,#764ba2 100%);padding:30px;border-radius:15px;margin-bottom:30px"><h3 style="color:#fff;margin-bottom:20px;text-align:center">🔍 Ürün, Marka veya Kategori Ara</h3><div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;max-width:1000px;margin:0 auto 20px"><div style="grid-column:1/-1"><label style="color:#fff;display:block;margin-bottom:8px;font-weight:600">🔍 Ürün/Marka Ara</label><div style="display:flex;gap:10px"><input type="text" id="productSearchInput" placeholder="Örnek: KDP120R, Roland, Fender..." style="flex:1;padding:12px;border:none;border-radius:8px;font-size:1em" onkeypress='"Enter"===event.key&&searchProduct()'> <button onclick="searchProduct()" style="padding:12px 30px;background:#38ef7d;color:#fff;border:none;border-radius:8px;font-size:1em;font-weight:700;cursor:pointer">🔍 Ara</button></div></div><div style="position:relative"><label style="color:#fff;display:block;margin-bottom:8px;font-weight:600">📁 Kategori Ara</label> <input type="text" id="productCategorySearch" placeholder="Kategori adı yazın..." style="width:100%;padding:12px;border:none;border-radius:8px;font-size:1em" oninput="filterProductCategories()" onfocus="showProductCategoryDropdown()" onblur="setTimeout(()=>hideProductCategoryDropdown(),200)"><div id="productCategoryDropdown" style="display:none;position:absolute;top:100%;left:0;right:0;background:#fff;border-radius:8px;max-height:300px;overflow-y:auto;box-shadow:0 4px 12px rgba(0,0,0,.2);z-index:1000;margin-top:5px"></div></div><div style="margin-bottom:15px"><label style="color:#fff;display:block;margin-bottom:8px;font-weight:600">🏪 Mağaza (Opsiyonel)</label> <select id="productStoreFilter" style="width:100%;padding:12px;border:none;border-radius:8px;font-size:1em"><option value="">Tüm Mağazalar</option></select></div><div style="display:flex;gap:10px;align-items:end"><div style="flex:1"><label style="color:#fff;display:block;margin-bottom:8px;font-weight:600">📅 Başlangıç Tarihi</label> <input type="date" id="productDateStart" style="width:100%;padding:12px;border:none;border-radius:8px;font-size:1em"></div><div style="flex:1"><label style="color:#fff;display:block;margin-bottom:8px;font-weight:600">📅 Bitiş Tarihi</label> <input type="date" id="productDateEnd" style="width:100%;padding:12px;border:none;border-radius:8px;font-size:1em"></div><div><button onclick="clearProductDateFilters()" style="padding:12px 20px;background:rgba(255,255,255,.2);color:#fff;border:2px solid #fff;border-radius:8px;cursor:pointer;font-size:1em;white-space:nowrap">🔄 Temizle</button></div></div></div><p style="text-align:center;margin-top:15px;color:#fff;font-size:.95em;opacity:.9">💡 <strong>İpucu:</strong> Tarih aralığı seçmek zorunlu değil, istenirse tüm dönem veya belirli tarih aralığı için analiz yapabilirsiniz</p></div><div id="productResultsContainer" style="display:none"><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:30px"><div class="summary-card"><h3>Toplam Satış (KDV Hariç)</h3><p id="productTotalSales">$0</p></div><div class="summary-card"><h3>Toplam Adet</h3><p id="productTotalQty">0</p></div><div class="summary-card"><h3>Farklı Ürün</h3><p id="productUniqueCount">0</p></div><div class="summary-card"><h3>Sepet Ortalaması</h3><p id="productAvgPrice">$0</p></div></div><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(450px,1fr));gap:30px"><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">🏪 En Çok Satan Mağazalar</h3><canvas id="productStoreChart"></canvas></div><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">🌍 En Çok Satılan İller</h3><canvas id="productCityChart"></canvas></div><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">👤 En Çok Satan Temsilciler</h3><canvas id="productSalesPersonChart"></canvas></div><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">📈 Aylık Satış Trendi</h3><canvas id="productMonthlyChart"></canvas></div></div><div id="productAIAnalysisPanel" style="margin:40px 0;display:none"><h3 style="margin-bottom:20px">🤖 AI Analiz, Yorum ve Öneriler</h3><div id="productAIAnalysisContent"></div></div><div style="margin-top:40px"><h3 style="margin-bottom:20px">📋 Detaylı Ürün Listesi</h3><div id="productDetailTable" style="overflow-x:auto"></div></div></div><div id="productNoResults" style="display:none;text-align:center;padding:60px;background:#f8f9fa;border-radius:15px"><div style="font-size:4em;margin-bottom:20px">🔍</div><h3 style="color:#6c757d;margin-bottom:10px">Sonuç Bulunamadı</h3><p style="color:#adb5bd">Lütfen farklı bir ürün veya marka adı deneyin</p></div></div></div><div id="customerSearchTab" class="tab-content"><div class="content"><h2 style="margin-bottom:30px">🔍 Müşteri Arama ve Analizi</h2><div style="max-width:800px;margin:0 auto 40px"><div style="position:relative"><input type="text" id="customerSearchInput" placeholder="Müşteri adı yazın veya virgülle ayırarak çoklu arama yapın..." style="width:100%;padding:20px 60px 20px 20px;font-size:1.1em;border:2px solid #667eea;border-radius:15px;outline:0" oninput="showCustomerSuggestions(this.value)" onkeydown="handleCustomerKeydown(event)" onfocus="showCustomerSuggestions(this.value)"> <button onclick="searchCustomerProfile()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;border:none;padding:12px 25px;border-radius:10px;cursor:pointer;font-size:1em">🔍 Ara</button><div id="customerSuggestions" style="position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid #667eea;border-top:none;border-radius:0 0 15px 15px;max-height:300px;overflow-y:auto;display:none;z-index:1000;box-shadow:0 4px 6px rgba(0,0,0,.1)"></div></div><div id="selectedCustomersContainer" style="display:none;margin-top:15px"><div style="background:#f8f9fa;padding:15px;border-radius:10px;border:2px dashed #667eea"><div style="font-weight:600;color:#667eea;margin-bottom:10px">✅ Seçili Müşteriler (En fazla 3):</div><div id="selectedCustomersTags" style="display:flex;flex-wrap:wrap;gap:10px"></div></div></div><p style="text-align:center;color:#6c757d;margin-top:10px;font-size:.9em">💡 İpucu: Listeden tıklayarak veya virgül ile ayırarak birden fazla müşteri seçebilir, karşılaştırabilirsiniz</p></div><div id="customerProfileContainer" style="display:none"><div style="background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;padding:40px;border-radius:20px;margin-bottom:30px"><h2 style="margin:0 0 20px 0;font-size:2em">👤 <span id="customerName">-</span></h2><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px"><div><div style="opacity:.8;font-size:.9em">🌍 Şehir</div><div style="font-size:1.3em;font-weight:700" id="customerCity">-</div></div><div><div style="opacity:.8;font-size:.9em">🏷️ Etiketler</div><div style="font-size:1.1em;font-weight:700" id="customerTags">-</div></div><div><div style="opacity:.8;font-size:.9em">💰 Toplam Alışveriş</div><div style="font-size:1.5em;font-weight:700" id="customerTotalSales">$0</div></div><div><div style="opacity:.8;font-size:.9em">📦 Toplam Adet</div><div style="font-size:1.5em;font-weight:700" id="customerTotalQty">0</div></div><div><div style="opacity:.8;font-size:.9em">🛒 İşlem Sayısı</div><div style="font-size:1.5em;font-weight:700" id="customerTransactionCount">0</div></div><div><div style="opacity:.8;font-size:.9em">📊 Ortalama Sepet</div><div style="font-size:1.5em;font-weight:700" id="customerAvgBasket">$0</div></div><div><div style="opacity:.8;font-size:.9em">📅 İlk Alışveriş</div><div style="font-size:1.1em;font-weight:700" id="customerFirstPurchase">-</div></div><div><div style="opacity:.8;font-size:.9em">📅 Son Alışveriş</div><div style="font-size:1.1em;font-weight:700" id="customerLastPurchase">-</div></div></div></div><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(450px,1fr));gap:30px;margin-bottom:30px"><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">🏷️ En Çok Tercih Ettiği Markalar</h3><canvas id="customerBrandChart"></canvas></div><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">📂 En Çok Aldığı Kategoriler</h3><canvas id="customerCategoryChart"></canvas></div><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">🏪 Alışveriş Yaptığı Mağazalar</h3><canvas id="customerStoreChart"></canvas></div><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">📈 Aylık Alışveriş Trendi</h3><canvas id="customerMonthlyTrendChart"></canvas></div></div><div id="customerAIAnalysisPanel" style="margin:40px 0"><h3 style="margin-bottom:20px">🤖 AI Müşteri Analizi ve Öneriler</h3><div id="customerAIAnalysisContent"></div></div><div style="margin-top:40px"><h3 style="margin-bottom:20px">🛍️ Satın Alma Geçmişi</h3><div id="customerPurchaseHistory" style="overflow-x:auto"></div></div></div><div id="customerSearchNoResults" style="display:none;text-align:center;padding:60px;background:#f8f9fa;border-radius:15px"><div style="font-size:4em;margin-bottom:20px">🔍</div><h3 style="color:#6c757d;margin-bottom:10px">Müşteri Bulunamadı</h3><p style="color:#adb5bd">Lütfen farklı bir müşteri adı deneyin</p></div></div></div><div id="salespersonTab" class="tab-content"><div class="content"><h2 style="margin-bottom:30px">👨‍💼 Satış Temsilcisi Performans Analizi</h2><div class="filters-section" style="margin-bottom:30px"><div class="filters-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px"><div class="filter-group"><label>Yıl <span class="selected-count" id="countSalespersonYear"></span></label><div class="filter-search-box"><input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput='filterCheckboxes("filterSalespersonYear",this.value)'></div><div class="checkbox-container" id="filterSalespersonYear"></div></div><div class="filter-group"><label>Ay <span class="selected-count" id="countSalespersonMonth"></span></label><div class="filter-search-box"><input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput='filterCheckboxes("filterSalespersonMonth",this.value)'></div><div class="checkbox-container" id="filterSalespersonMonth"></div></div><div class="filter-group"><label>Gün <span class="selected-count" id="countSalespersonDay"></span></label><div class="filter-search-box"><input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput='filterCheckboxes("filterSalespersonDay",this.value)'></div><div class="checkbox-container" id="filterSalespersonDay"></div></div></div><div style="text-align:center;margin-top:20px"><button onclick="clearSalespersonFilters()" style="background:#6c757d;color:#fff;border:none;padding:12px 30px;border-radius:10px;cursor:pointer;font-weight:600;transition:all .3s">🔄 Filtreleri Temizle</button></div></div><div style="max-width:800px;margin:0 auto 40px"><div id="selectedSalespersonsContainer" style="display:none;margin-bottom:15px;padding:15px;background:#f8f9fa;border-radius:10px"><div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap"><span style="font-weight:600;color:#667eea">Seçili Temsilciler:</span><div id="selectedSalespersonsTags" style="display:flex;gap:8px;flex-wrap:wrap"></div></div></div><div style="position:relative"><input type="text" id="salespersonSearchInput" placeholder="Satış temsilcisi adı yazın... (örn: Mustafa Kılıç, Kaan Poyraz)" style="width:100%;padding:20px 60px 20px 20px;font-size:1.1em;border:2px solid #667eea;border-radius:15px;outline:0" oninput="showSalespersonSuggestions(this.value)" onkeydown="handleSalespersonKeydown(event)" onfocus="showSalespersonSuggestions(this.value)"> <button onclick="searchSalespersonProfile()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;border:none;padding:12px 25px;border-radius:10px;cursor:pointer;font-size:1em">🔍 Ara</button><div id="salespersonSuggestions" style="position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid #667eea;border-top:none;border-radius:0 0 15px 15px;max-height:300px;overflow-y:auto;display:none;z-index:1000;box-shadow:0 4px 6px rgba(0,0,0,.1)"></div></div><p style="text-align:center;color:#6c757d;margin-top:10px;font-size:.9em">💡 İpucu: Birden fazla temsilci seçerek karşılaştırmalı analiz yapabilirsiniz! (En fazla 3 temsilci)</p></div><div id="salespersonProfileContainer" style="display:none"><div id="singleSalespersonView" style="display:none"><div style="background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;padding:40px;border-radius:20px;margin-bottom:30px"><h2 style="margin:0 0 20px 0;font-size:2em">👨‍💼 <span id="salespersonName">-</span></h2><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px"><div><div style="opacity:.8;font-size:.9em">💰 Toplam Satış (KDV Hariç)</div><div style="font-size:1.5em;font-weight:700" id="salespersonTotalSales">$0</div></div><div><div style="opacity:.8;font-size:.9em">📦 Toplam Adet</div><div style="font-size:1.5em;font-weight:700" id="salespersonTotalQty">0</div></div><div><div style="opacity:.8;font-size:.9em">🛒 Fatura Sayısı</div><div style="font-size:1.5em;font-weight:700" id="salespersonInvoiceCount">0</div></div><div><div style="opacity:.8;font-size:.9em">📊 Günlük Ort. Satış</div><div style="font-size:1.5em;font-weight:700" id="salespersonAvgTransaction">$0</div></div><div><div style="opacity:.8;font-size:.9em">🛒 Sepet Ortalaması</div><div style="font-size:1.5em;font-weight:700" id="salespersonAvgBasket">$0</div></div><div><div style="opacity:.8;font-size:.9em">👥 Farklı Müşteri</div><div style="font-size:1.5em;font-weight:700" id="salespersonUniqueCustomers">0</div></div><div><div style="opacity:.8;font-size:.9em">🎯 Farklı Ürün</div><div style="font-size:1.5em;font-weight:700" id="salespersonUniqueProducts">0</div></div></div></div></div><div id="multipleSalespersonsView" style="display:none"><h2 style="margin:0 0 30px 0;font-size:2em;text-align:center">📊 Satış Temsilcileri Karşılaştırmalı Analiz</h2><div style="overflow-x:auto;margin-bottom:40px"><div id="salespersonComparisonTable"></div></div><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(450px,1fr));gap:30px;margin-bottom:30px"><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">💰 Toplam Satış Karşılaştırması</h3><canvas id="comparisonSalesChart"></canvas></div><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">📦 Ürün Adet Karşılaştırması</h3><canvas id="comparisonQtyChart"></canvas></div></div></div><div id="salespersonBrandCategorySection" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(450px,1fr));gap:30px;margin-bottom:30px"><div class="chart-container"><h3 id="salespersonBrandChartTitle" style="text-align:center;margin-bottom:20px">🏷️ En Çok Sattığı Markalar (Top 10)</h3><canvas id="salespersonBrandChart"></canvas></div><div class="chart-container"><h3 id="salespersonCategoryChartTitle" style="text-align:center;margin-bottom:20px">📂 En Çok Sattığı Kategoriler</h3><canvas id="salespersonCategoryChart"></canvas></div></div><div id="salespersonMonthlySection" style="margin-bottom:40px"><div class="chart-container" style="height:400px"><h3 style="text-align:center;margin-bottom:20px">📈 Aylık Performans Trendi (Yıl Karşılaştırmalı)</h3><canvas id="salespersonMonthlyChart"></canvas></div></div><div id="salespersonTopProductsSection" style="margin-bottom:40px"><h3 style="margin-bottom:20px">🎯 En Çok Sattığı Ürünler (Top 20)</h3><div id="salespersonTopProductsTable" style="overflow-x:auto"></div></div><div id="salespersonBottomProductsSection" style="margin-bottom:40px"><h3 style="margin-bottom:20px">⚠️ En Az Sattığı Ürünler (Bottom 10)</h3><div id="salespersonBottomProductsTable" style="overflow-x:auto"></div></div><div id="salespersonAIAnalysisPanel" style="margin:40px 0"><h3 style="margin-bottom:20px">🤖 AI Performans Analizi ve Öneriler</h3><div id="salespersonAIAnalysisContent"></div></div></div><div id="salespersonSearchNoResults" style="display:none;text-align:center;padding:60px;background:#f8f9fa;border-radius:15px"><div style="font-size:4em;margin-bottom:20px">🔍</div><h3 style="color:#6c757d;margin-bottom:10px">Satış Temsilcisi Bulunamadı</h3><p style="color:#adb5bd">Lütfen farklı bir isim deneyin</p></div></div></div><div id="storeTab" class="tab-content"><div class="content"><h2 style="margin-bottom:30px">🏪 Mağaza Performans Analizi</h2><div class="filters-section" style="margin-bottom:30px"><div class="filters-grid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px"><div class="filter-group"><label>Yıl <span class="selected-count" id="countStoreYear"></span></label><div class="filter-search-box"><input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput='filterCheckboxes("filterStoreYear",this.value)'></div><div class="checkbox-container" id="filterStoreYear"></div></div><div class="filter-group"><label>Ay <span class="selected-count" id="countStoreMonth"></span></label><div class="filter-search-box"><input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput='filterCheckboxes("filterStoreMonth",this.value)'></div><div class="checkbox-container" id="filterStoreMonth"></div></div><div class="filter-group"><label>Gün <span class="selected-count" id="countStoreDay"></span></label><div class="filter-search-box"><input type="text" class="filter-search-input" placeholder="🔍 Ara..." oninput='filterCheckboxes("filterStoreDay",this.value)'></div><div class="checkbox-container" id="filterStoreDay"></div></div></div><div style="text-align:center;margin-top:20px"><button onclick="clearStoreFilters()" style="background:#6c757d;color:#fff;border:none;padding:12px 30px;border-radius:10px;cursor:pointer;font-weight:600;transition:all .3s">🔄 Filtreleri Temizle</button></div></div><div style="max-width:800px;margin:0 auto 40px"><div id="selectedStoresContainer" style="display:none;margin-bottom:15px;padding:15px;background:#f8f9fa;border-radius:10px"><div style="display:flex;align-items:center;gap:10px;flex-wrap:wrap"><span style="font-weight:600;color:#667eea">Seçili Mağazalar:</span><div id="selectedStoresTags" style="display:flex;gap:8px;flex-wrap:wrap"></div></div></div><div style="position:relative"><input type="text" id="storeSearchInput" placeholder="Mağaza adı yazın... (örn: Toptan, Akasya)" style="width:100%;padding:20px 60px 20px 20px;font-size:1.1em;border:2px solid #667eea;border-radius:15px;outline:0" oninput="showStoreSuggestions(this.value)" onkeydown="handleStoreKeydown(event)" onfocus="showStoreSuggestions(this.value)"> <button onclick="searchStoreProfile()" style="position:absolute;right:10px;top:50%;transform:translateY(-50%);background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;border:none;padding:12px 25px;border-radius:10px;cursor:pointer;font-size:1em">🔍 Ara</button><div id="storeSuggestions" style="position:absolute;top:100%;left:0;right:0;background:#fff;border:2px solid #667eea;border-top:none;border-radius:0 0 15px 15px;max-height:300px;overflow-y:auto;display:none;z-index:1000;box-shadow:0 4px 6px rgba(0,0,0,.1)"></div></div><p style="text-align:center;color:#6c757d;margin-top:10px;font-size:.9em">💡 İpucu: Birden fazla mağaza seçerek karşılaştırmalı analiz yapabilirsiniz! (En fazla 3 mağaza)</p></div><div id="storeProfileContainer" style="display:none"><div id="multipleStoresView" style="display:none"><h2 style="margin-bottom:30px;text-align:center">🏪 Mağaza Karşılaştırma Analizi</h2><div id="storeComparisonTableContainer" style="margin-bottom:40px;overflow-x:auto"></div><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(450px,1fr));gap:30px;margin-bottom:30px"><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">📊 Toplam Satış Karşılaştırması</h3><canvas id="comparisonStoreSalesChart"></canvas></div><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">📦 Toplam Adet Karşılaştırması</h3><canvas id="comparisonStoreQtyChart"></canvas></div></div><div id="storeComparisonCategorySection" style="margin:40px 0"><h3 style="text-align:center;margin-bottom:30px">📂 Mağaza Bazında Kategori Karşılaştırması (Kategori 1)</h3><div id="storeCategoryComparisonTableContainer" style="margin-bottom:40px;overflow-x:auto"></div><div id="storeComparisonCategoryCharts" style="display:none"></div></div><div id="multipleStoresAIPanel" style="margin:40px 0"><div id="multipleStoresAIContent"></div></div></div><div id="singleStoreView" style="display:none"><div style="background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;padding:40px;border-radius:20px;margin-bottom:30px"><h2 style="margin:0 0 20px 0;font-size:2em">🏪 <span id="storeName">-</span></h2><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px"><div><div style="opacity:.8;font-size:.9em">💰 Toplam Satış (KDV Hariç)</div><div style="font-size:1.5em;font-weight:700" id="storeTotalSales">$0</div></div><div><div style="opacity:.8;font-size:.9em">📦 Toplam Adet</div><div style="font-size:1.5em;font-weight:700" id="storeTotalQty">0</div></div><div><div style="opacity:.8;font-size:.9em">🛒 Fatura Sayısı</div><div style="font-size:1.5em;font-weight:700" id="storeInvoiceCount">0</div></div><div><div style="opacity:.8;font-size:.9em">📊 Günlük Ort. Satış</div><div style="font-size:1.5em;font-weight:700" id="storeAvgTransaction">$0</div></div><div><div style="opacity:.8;font-size:.9em">🛒 Sepet Ortalaması</div><div style="font-size:1.5em;font-weight:700" id="storeAvgBasket">$0</div></div><div><div style="opacity:.8;font-size:.9em">👥 Farklı Müşteri</div><div style="font-size:1.5em;font-weight:700" id="storeUniqueCustomers">0</div></div><div><div style="opacity:.8;font-size:.9em">🎯 Farklı Ürün</div><div style="font-size:1.5em;font-weight:700" id="storeUniqueProducts">0</div></div></div></div><div id="storeBrandCategorySection" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(450px,1fr));gap:30px;margin-bottom:30px"><div class="chart-container"><h3 id="storeBrandChartTitle" style="text-align:center;margin-bottom:20px">🏷️ En Çok Satan Markalar (Top 10)</h3><canvas id="storeBrandChart"></canvas></div><div class="chart-container"><h3 id="storeCategoryChartTitle" style="text-align:center;margin-bottom:20px">📂 En Çok Satan Kategoriler</h3><canvas id="storeCategoryChart"></canvas></div><div class="chart-container"><h3 id="storeSalespersonChartTitle" style="text-align:center;margin-bottom:20px">👨‍💼 Satış Temsilcileri</h3><canvas id="storeSalespersonChart"></canvas></div><div class="chart-container"><h3 id="storeMonthlyChartTitle" style="text-align:center;margin-bottom:20px">📈 Aylık Performans Trendi</h3><canvas id="storeMonthlyChart"></canvas></div></div><div id="storeTopProductsSection" style="margin-bottom:40px"><h3 style="margin-bottom:20px">🎯 En Çok Satan Ürünler (Top 20)</h3><div id="storeTopProductsTable" style="overflow-x:auto"></div></div><div id="storeAIAnalysisPanel" style="margin:40px 0"><h3 style="margin-bottom:20px">🤖 AI Performans Analizi ve Öneriler</h3><div id="storeAIAnalysisContent"></div></div><div id="storeFullSalespersonSection" style="margin:40px 0"><h3 style="margin-bottom:20px">👥 Tüm Satış Temsilcileri Detaylı Performans Listesi</h3><div id="storeFullSalespersonTable" style="overflow-x:auto"></div></div></div><div id="storeSearchNoResults" style="display:none;text-align:center;padding:60px;background:#f8f9fa;border-radius:15px"><div style="font-size:4em;margin-bottom:20px">🔍</div><h3 style="color:#6c757d;margin-bottom:10px">Mağaza Bulunamadı</h3><p style="color:#adb5bd">Lütfen farklı bir isim deneyin</p></div></div></div></div><div id="cityTab" class="tab-content"><div class="content"><h2 style="margin-bottom:30px">🌍 Şehir Bazlı Satış Analizi</h2><div style="background:#e3f2fd;border-left:4px solid #2196f3;padding:15px;margin-bottom:20px;border-radius:5px"><p style="margin:0;color:#1565c0;font-size:.95em">💡 <strong>İpucu:</strong> Tarih aralığı seçmek zorunlu değil, istenirse tüm dönem veya belirli tarih aralığı için analiz yapabilirsiniz.</p></div><div style="background:linear-gradient(135deg,#667eea 0,#764ba2 100%);padding:30px;border-radius:15px;margin-bottom:40px"><div style="display:grid;grid-template-columns:1fr 1fr 1fr 1fr auto;gap:20px;align-items:end"><div><label style="color:#fff;display:block;margin-bottom:8px;font-weight:600">📍 Şehir Seçin</label> <select id="citySelect" onchange="handleCityChange()" style="width:100%;padding:15px;font-size:1.1em;border:none;border-radius:10px;outline:0"><option value="">-- Şehir Seçin --</option></select></div><div><label style="color:#fff;display:block;margin-bottom:8px;font-weight:600">🏘️ İlçe Seçin <small style="opacity:.8">(Opsiyonel)</small></label> <select id="districtSelect" onchange="analyzeCityPerformance()" style="width:100%;padding:15px;font-size:1.1em;border:none;border-radius:10px;outline:0" disabled="disabled"><option value="">-- Önce Şehir Seçin --</option></select></div><div><label style="color:#fff;display:block;margin-bottom:8px;font-weight:600">📅 Başlangıç Tarihi</label> <input type="date" id="cityDateStart" onchange="analyzeCityPerformance()" style="width:100%;padding:15px;border:none;border-radius:10px;font-size:1em"></div><div><label style="color:#fff;display:block;margin-bottom:8px;font-weight:600">📅 Bitiş Tarihi</label> <input type="date" id="cityDateEnd" onchange="analyzeCityPerformance()" style="width:100%;padding:15px;border:none;border-radius:10px;font-size:1em"></div><div><button onclick="clearCityFilters()" style="padding:15px 30px;background:#fff;color:#667eea;border:none;border-radius:10px;font-weight:600;cursor:pointer;white-space:nowrap">🗑️ Temizle</button></div></div></div><div id="cityAnalysisContainer" style="display:none"><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:20px;margin-bottom:30px"><div class="summary-card"><h3 style="font-size:1em;margin-bottom:10px">💰 Toplam Satış (KDV Hariç)</h3><p id="cityTotalSales" style="font-size:1.8em;font-weight:700">$0</p></div><div class="summary-card"><h3 style="font-size:1em;margin-bottom:10px">📦 Toplam Adet</h3><p id="cityTotalQty" style="font-size:1.8em;font-weight:700">0</p></div><div class="summary-card"><h3 style="font-size:1em;margin-bottom:10px">👥 Müşteri Sayısı</h3><p id="cityCustomerCount" style="font-size:1.8em;font-weight:700">0</p></div><div class="summary-card"><h3 style="font-size:1em;margin-bottom:10px">📊 Ortalama Sepet</h3><p id="cityAvgBasket" style="font-size:1.8em;font-weight:700">$0</p></div><div class="summary-card" style="background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff"><h3 style="font-size:1em;margin-bottom:10px;color:#fff">🏙️ Nüfus (2024)</h3><p id="cityPopulation" style="font-size:1.8em;font-weight:700;color:#fff">-</p></div><div class="summary-card" style="background:linear-gradient(135deg,#f093fb 0,#f5576c 100%);color:#fff"><h3 style="font-size:1em;margin-bottom:10px;color:#fff">👤 Kişi Başı Satış</h3><p id="cityPerCapitaSales" style="font-size:1.8em;font-weight:700;color:#fff">$0</p><small style="opacity:.9;font-size:.85em">Toplam Satış / Nüfus</small></div><div class="summary-card" style="background:linear-gradient(135deg,#38ef7d 0,#11998e 100%);color:#fff;grid-column:span 1"><h3 style="font-size:.95em;margin-bottom:10px">👤 Top 5 Temsilci</h3><div id="cityTopSalespersons" style="color:#fff;font-size:.85em;line-height:1.6;max-height:120px;overflow-y:auto"></div></div><div class="summary-card" style="background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;grid-column:span 1"><h3 style="font-size:.95em;margin-bottom:10px">🏪 Top 5 Mağaza</h3><div id="cityTopStores" style="color:#fff;font-size:.85em;line-height:1.6;max-height:120px;overflow-y:auto"></div></div></div><div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(450px,1fr));gap:30px;margin-bottom:30px"><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">🏷️ En Çok Satılan Markalar</h3><canvas id="cityBrandChart"></canvas></div><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">🎸 En Çok Satılan Ürünler</h3><canvas id="cityProductChart"></canvas></div><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">📂 En Çok Satılan Kategoriler</h3><canvas id="cityCategoryChart"></canvas></div><div class="chart-container"><h3 style="text-align:center;margin-bottom:20px">📈 Aylık Performans Trendi (Yıl Karşılaştırmalı)</h3><canvas id="cityYearlyChart"></canvas></div></div><div id="cityAIAnalysisPanel" style="margin:40px 0"><h3 style="margin-bottom:20px">🤖 AI Şehir Analizi ve Öneriler</h3><div id="cityAIAnalysisContent"></div></div></div></div></div><div id="stockTab" class="tab-content"><div class="content"><h2 style="margin-bottom:30px">📦 Stok Dağılım Analizi</h2><div style="max-width:1000px;margin:0 auto 30px"><div style="background:linear-gradient(135deg,#667eea 0,#764ba2 100%);padding:20px;border-radius:15px;color:#fff"><h3 style="margin-bottom:15px">📅 Tarih Aralığı Filtresi (Opsiyonel)</h3><div style="display:grid;grid-template-columns:1fr 1fr auto;gap:15px;align-items:end"><div><label style="display:block;margin-bottom:5px;font-size:.9em;opacity:.9">Başlangıç Tarihi:</label> <input type="date" id="stockDateStart" style="width:100%;padding:10px;border:none;border-radius:8px;font-size:1em"></div><div><label style="display:block;margin-bottom:5px;font-size:.9em;opacity:.9">Bitiş Tarihi:</label> <input type="date" id="stockDateEnd" style="width:100%;padding:10px;border:none;border-radius:8px;font-size:1em"></div><div><button onclick="clearStockDateFilters()" style="padding:10px 20px;background:rgba(255,255,255,.2);color:#fff;border:2px solid #fff;border-radius:8px;cursor:pointer;font-size:1em">🔄 Temizle</button></div></div><p style="margin-top:10px;font-size:.85em;opacity:.8">💡 Tarih seçmezseniz tüm satış verileri kullanılır</p></div></div><div style="max-width:1000px;margin:0 auto"><div style="display:grid;grid-template-columns:1fr 1fr;gap:30px;margin-bottom:40px"><div style="background:#f8f9fa;padding:30px;border-radius:15px"><h3 style="margin-bottom:20px">📄 Excel ile Toplu Yükleme</h3><p style="color:#6c757d;margin-bottom:15px">Excel formatı: <strong>Ürün Kodu | Stok Miktarı</strong></p><input type="file" id="stockExcelInput" accept=".xlsx,.xls" style="display:none" onchange="handleStockExcelUpload(event)"> <button onclick='document.getElementById("stockExcelInput").click()' style="width:100%;padding:15px;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:1.1em">📂 Excel Dosyası Seç</button><p style="color:#6c757d;margin-top:10px;font-size:.9em">Max 5 MB, .xlsx veya .xls</p></div><div style="background:#f8f9fa;padding:30px;border-radius:15px"><h3 style="margin-bottom:20px">✏️ Manuel Giriş</h3><div style="margin-bottom:15px"><label style="display:block;margin-bottom:5px;font-weight:700">Ürün Kodu:</label> <input type="text" id="manualProductCode" placeholder="örn: KDP120R" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px"></div><div style="margin-bottom:15px"><label style="display:block;margin-bottom:5px;font-weight:700">Stok Miktarı:</label> <input type="number" id="manualStockQty" placeholder="örn: 25" min="0" style="width:100%;padding:10px;border:1px solid #ddd;border-radius:5px"></div><button onclick="addManualStock()" style="width:100%;padding:15px;background:linear-gradient(135deg,#38ef7d 0,#11998e 100%);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:1.1em">➕ Stok Ekle</button></div></div><div id="stockListContainer" style="display:none;margin-bottom:40px"><h3 style="margin-bottom:20px">📋 Mevcut Stok Listesi</h3><div id="stockListTable" style="overflow-x:auto"></div><div style="margin-top:20px;text-align:center"><button onclick="analyzeStockDistribution()" style="padding:15px 40px;background:linear-gradient(135deg,#667eea 0,#764ba2 100%);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:1.1em;margin-right:10px">🤖 AI Dağılım Önerisi Al</button> <button onclick="clearStockList()" style="padding:15px 40px;background:#dc3545;color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:1.1em">🗑️ Listeyi Temizle</button></div></div><div id="stockDistributionResults" style="display:none"><h3 style="margin-bottom:20px">🤖 AI Stok Dağılım Önerileri</h3><div id="stockDistributionContent"></div></div></div></div></div></div><script>function logout(){confirm("Çıkış yapmak istediğinizden emin misiniz?")&&(sessionStorage.clear(),window.location.href="login.html")}window.addEventListener("DOMContentLoaded",function(){var e=sessionStorage.getItem("username");e&&(document.getElementById("currentUserName").textContent=e.charAt(0).toUpperCase()+e.slice(1))});let allData=[],filteredData=[],baseData=[],metadata=null,loadedYears=new Set,inventoryData=null,inventoryCharts={},activeChannels={all:!0,retail:!1,wholesale:!1,online:!1,corporate:!1,central:!1},dataLoadProgress={pageInit:!1,dataFiles:!1,targets:!1,ready:!1};function isDiscountProduct(e){e=(e.product||"").toLowerCase();return e.includes("[disc]")||e.includes("indirim")||e.includes("discount")||e.includes("toplam tutarda indirim")}function applyDiscountLogic(e){return isDiscountProduct(e)?{...e,usd_amount:-Math.abs(parseFloat(e.usd_amount||0)),quantity:Math.abs(parseFloat(e.quantity||0)),_isDiscount:!0}:e}let STORE_WORKING_HOURS={"Tünel":{openHour:10,closeHour:20,closedDays:[0]},"İzmir":{openHour:10,closeHour:20,closedDays:[0]},Antalya:{openHour:10,closeHour:20,closedDays:[0]},"Kızılay":{openHour:10,closeHour:20,closedDays:[0]},default:{openHour:10,closeHour:22,closedDays:[]}};function getStoreWorkingHours(e){var t,a,r=e.replace(/\[.*?\]\s*/g,"").trim();for([t,a]of Object.entries(STORE_WORKING_HOURS))if("default"!==t&&r.toLowerCase().includes(t.toLowerCase()))return a;return STORE_WORKING_HOURS.default}function isWithinWorkingHours(e){var t=getStoreWorkingHours(e.store||""),a=e.create_hour,e=e.day_of_week;if(null!=e&&t.closedDays.includes((e+1)%7))return!1;return null==a||!(a<t.openHour||a>=t.closeHour)}async function loadMetadata(){try{var e=(new Date).getTime(),t=await fetch("data-metadata.json?v="+e,{cache:"no-cache",headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}});if(t.ok)return metadata=await t.json(),console.log("✅ Metadata yüklendi:",metadata),metadata;throw new Error("Metadata yüklenemedi")}catch(e){return console.error("❌ Metadata hatası:",e),null}}async function loadYearData(a){if(loadedYears.has(a))return console.log(`⏭️ ${a} zaten yüklü, atlanıyor...`),null;loadedYears.add(a);try{console.log(`📦 ${a} yükleniyor...`);var e=(new Date).getTime(),r=await fetch(`data-${a}.json.gz?v=`+e,{cache:"no-cache",headers:{"Cache-Control":"no-cache, no-store, must-revalidate",Pragma:"no-cache",Expires:"0"}});if(!r.ok)throw new Error(a+" verisi bulunamadı");var n=await r.arrayBuffer();let t;if("undefined"!=typeof DecompressionStream)try{var o=new Blob([n]),i=new DecompressionStream("gzip"),l=o.stream().pipeThrough(i);t=await new Response(l).text()}catch(e){console.warn("DecompressionStream başarısız, pako kullanılıyor:",e);var s=new Uint8Array(n),d=pako.inflate(s);t=(new TextDecoder).decode(d)}else{if("undefined"==typeof pako)throw new Error("GZIP açma kütüphanesi yüklenmedi. Lütfen sayfayı yenileyin.");var c=new Uint8Array(n),m=pako.inflate(c);t=(new TextDecoder).decode(m)}var g=JSON.parse(t);return console.log(`✅ ${a} yüklendi: ${g.details?.length||0} kayıt`),g}catch(e){throw console.error(`❌ ${a} yükleme hatası:`,e),e}}let centralTargets={yearly:{},monthly:{}};async function loadCentralTargets(){try{console.log("🎯 Merkezi hedefler yükleniyor...");var e=await fetch("targets.json?"+Date.now());return e.ok?(centralTargets=await e.json(),console.log("✅ Merkezi hedefler yüklendi:",centralTargets),dataLoadProgress.targets=!0,checkLoadingComplete(),!0):(console.warn("⚠️ targets.json yüklenemedi, varsayılan hedefler kullanılacak"),!1)}catch(e){return console.error("❌ Hedef yükleme hatası:",e),!1}}function applyChannelFilter(){console.log("🏢 applyChannelFilter başladı"),console.log("📊 activeChannels:",activeChannels),console.log("📊 baseData uzunluk:",baseData.length);var e=document.getElementById("channelLoadingSpinner"),t=document.getElementById("channelLoadingText");e.style.display="flex";let a={retail:"🏪 Perakende",wholesale:"📦 Toptan Satış",online:"🌐 Online Satış",corporate:"🏢 Kurumsal Satış",central:"🏛️ Merkezi Satış"},r="Tüm Kanallar";activeChannels.all||(e=Object.keys(activeChannels).filter(e=>activeChannels[e]&&"all"!==e),r=e.map(e=>a[e]).join(" + ")),t.textContent=`🔄 ${r} verileri yükleniyor...`,setTimeout(()=>{var e,t;activeChannels.all?(allData=[...baseData],console.log("✅ Tümü seçili, allData uzunluk:",allData.length),document.getElementById("channelFilterInfo").textContent="📊 Aktif: Tüm Kanallar (19)"):(e=[],activeChannels.retail&&(allData=baseData.filter(e=>e.store&&e.store.toLowerCase().includes("perakende")),e.push("Perakende")),activeChannels.wholesale&&(t=baseData.filter(e=>e.store&&e.store.toLowerCase().includes("toptan")),allData=activeChannels.retail?[...allData,...t]:t,e.push("Toptan")),activeChannels.online&&(t=baseData.filter(e=>e.store&&e.store.toLowerCase().includes("online")),allData=activeChannels.retail||activeChannels.wholesale?[...allData,...t]:t,e.push("Online")),activeChannels.corporate&&(t=baseData.filter(e=>e.store&&e.store.toLowerCase().includes("kurumsal")),allData=activeChannels.retail||activeChannels.wholesale||activeChannels.online?[...allData,...t]:t,e.push("Kurumsal")),activeChannels.central&&(t=baseData.filter(e=>e.store&&e.store.toLowerCase().includes("merkezi")),allData=activeChannels.retail||activeChannels.wholesale||activeChannels.online||activeChannels.corporate?[...allData,...t]:t,e.push("Merkezi")),document.getElementById("channelFilterInfo").textContent=`📊 Aktif: ${e.join(" + ")} (${allData.length.toLocaleString("tr-TR")} kayıt)`),filteredData=[...allData],updateAfterChannelFilter()},100)}function updateAfterChannelFilter(){document.getElementById("totalRecords").textContent=allData.length.toLocaleString("tr-TR");var e=allData.reduce((e,t)=>e+(parseFloat(t.usd_amount)||0),0),t=(document.getElementById("totalUSD").textContent="$"+e.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2}),[...new Set(allData.map(e=>e.date))]),t=0<t.length?e/t.length:0,t=(document.getElementById("dailyAverage").textContent="$"+t.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2}),0<allData.length?e/allData.length:0);document.getElementById("basketAverage").textContent="$"+t.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2}),populateFilters(),updateSummary(),loadDashboard(),analyzeCustomers(),loadAllStoresTargets(),setTimeout(()=>{document.getElementById("channelLoadingSpinner").style.display="none"},500)}async function loadData(){try{dataLoadProgress.dataFiles=!0,checkLoadingComplete(),document.getElementById("dataStatus").innerHTML='<span class="status-badge" style="background:#ffc107;color:#000;">⏳ Yükleniyor...</span>';var a=document.getElementById("tableContainer");if(a&&(a.innerHTML='<div style="text-align:center;padding:50px;font-size:1.2em;">⏳ Veriler yükleniyor, lütfen bekleyin...</div>'),loadCentralTargets(),!(metadata=await loadMetadata())||!metadata.years||0===metadata.years.length)throw new Error("Geçerli yıl verisi bulunamadı");let e=metadata.years[metadata.years.length-1];var r=(await loadYearData(e)).details||[],n=r.filter(e=>isDiscountProduct(e));allData=r.map(e=>applyDiscountLogic(e)),baseData=[...allData],filteredData=[...allData],console.log(`💰 ${n.length} indirim ürünü negatif değer olarak işlendi (toplam kayıt: ${r.length})`),document.getElementById("dataStatus").innerHTML=`<span class="status-badge status-success">✅ ${e}</span>`,document.getElementById("lastUpdate").textContent=metadata.last_update||"-",document.getElementById("totalRecords").textContent=allData.length.toLocaleString("tr-TR");let t=0;allData&&Array.isArray(allData)&&(t=allData.reduce((e,t)=>e+(parseFloat(t.usd_amount)||0),0)),document.getElementById("totalUSD").textContent="$"+t.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2});var o=[...new Set(allData.map(e=>e.date))],i=0<o.length?t/o.length:0,l=(document.getElementById("dailyAverage").textContent="$"+i.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2}),0<allData.length?t/allData.length:0);document.getElementById("basketAverage").textContent="$"+l.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2}),populateFilters(),updateSummary(),renderTable(),populateSalespersonYearFilter(),populateStoreYearFilter(),initializeProductFilters(),loadDashboard(),setTimeout(()=>loadRemainingYears(e),2e3)}catch(e){console.error("Error loading data:",e),document.getElementById("dataStatus").innerHTML='<span class="status-badge status-error">❌ Hata</span>';a=document.getElementById("tableContainer");a&&(a.innerHTML='<div class="error">❌ Veri yüklenirken hata oluştu!<br><small>'+e.message+"</small></div>")}}async function loadRemainingYears(e){if(metadata&&metadata.years){console.log("📦 Diğer yıllar arka planda yükleniyor...");for(var t of metadata.years)if(t!==e&&!loadedYears.has(t))try{var a,r,n,o,i,l,s,d,c=await loadYearData(t);c&&c.details&&Array.isArray(c.details)&&(r=(a=c.details).filter(e=>isDiscountProduct(e)).length,n=a.map(e=>applyDiscountLogic(e)),allData=[...allData,...n],baseData=[...allData],filteredData=[...allData],console.log(`💰 ${t}: ${r} indirim ürünü negatif değer olarak işlendi (toplam: ${a.length})`),populateFilters(),updateSummary(),populateSalespersonYearFilter(),populateStoreYearFilter(),o=Array.from(loadedYears).sort().join(", "),document.getElementById("dataStatus").innerHTML=`<span class="status-badge status-success">✅ ${o}</span>`,document.getElementById("totalRecords").textContent=allData.length.toLocaleString("tr-TR"),i=allData.reduce((e,t)=>e+(parseFloat(t.usd_amount)||0),0),document.getElementById("totalUSD").textContent="$"+i.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2}),s=0<(l=[...new Set(allData.map(e=>e.date))]).length?i/l.length:0,document.getElementById("dailyAverage").textContent="$"+s.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2}),d=0<allData.length?i/allData.length:0,document.getElementById("basketAverage").textContent="$"+d.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2}))}catch(e){console.error(`⚠️ ${t} yüklenemedi:`,e)}console.log("✅ Tüm yıllar yüklendi!");var m=metadata.years.sort().join(", ");document.getElementById("dataStatus").innerHTML=`<span class="status-badge status-success">✅ Tüm Yıllar (${m})</span>`,dataLoadProgress.ready=!0,checkLoadingComplete()}}async function loadInventoryData(){console.log("📦 Envanter verileri yükleniyor..."),document.getElementById("inventoryLoading").style.display="block",document.getElementById("inventoryContent").style.display="none";try{var e=await fetch("inventory.json.gz");if(!e.ok)throw new Error(`HTTP ${e.status}: `+e.statusText);var t=await e.arrayBuffer(),a=pako.ungzip(new Uint8Array(t),{to:"string"}),r=JSON.parse(a);if(r.inventory&&Array.isArray(r.inventory))inventoryData=r.inventory,console.log(`✅ Envanter verileri yüklendi: ${inventoryData.length} kayıt`),console.log("📊 Toplam miktar: "+r.total_quantity),console.log("💰 Toplam değer: $"+r.total_value);else{if(!Array.isArray(r))throw new Error("Beklenmeyen veri formatı: inventory array bulunamadı");inventoryData=r,console.log(`✅ Envanter verileri yüklendi: ${inventoryData.length} kayıt`)}renderInventoryDashboard()}catch(e){console.error("❌ Envanter verileri yüklenemedi:",e),document.getElementById("inventoryLoading").innerHTML=`
                    <div style="text-align: center; padding: 60px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">⚠️</div>
                        <h3 style="color: #f5576c;">Envanter verileri yüklenemedi</h3>
                        <p style="color: #666; margin-top: 15px;">Hata: ${e.message}</p>
                        <button onclick="loadInventoryData()" style="margin-top: 20px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 1em;">
                            🔄 Tekrar Dene
                        </button>
                    </div>
                `}}function renderInventoryDashboard(){inventoryData&&0!==inventoryData.length?(console.log("📊 Envanter dashboard oluşturuluyor..."),document.getElementById("inventoryLoading").style.display="none",document.getElementById("inventoryContent").style.display="block",filterStockAnalysis(),console.log("✅ Envanter dashboard oluşturuldu!")):console.warn("⚠️ Envanter verisi yok!")}function filterStockAnalysis(){if(inventoryData&&0!==inventoryData.length&&allData&&0!==allData.length){console.log("🔍 Stok analizi filtreleniyor...");let a=(document.getElementById("stockSearchBrand")?.value||"").toLowerCase().trim(),r=(document.getElementById("stockSearchProduct")?.value||"").toLowerCase().trim(),n=(document.getElementById("stockSearchCat2")?.value||"").toLowerCase().trim(),o=(document.getElementById("stockSearchCat3")?.value||"").toLowerCase().trim(),i=(document.getElementById("stockSearchCat4")?.value||"").toLowerCase().trim();var e=inventoryData.filter(e=>{var t;return!(a&&!(e.brand||"").toLowerCase().includes(a)||(t=e.product_name||e.product||"",r&&!t.toLowerCase().includes(r))||(t=e.category||"",n&&!t.toLowerCase().includes(n))||o&&!t.toLowerCase().includes(o)||i&&!t.toLowerCase().includes(i))});console.log(`📦 Filtrelenmiş envanter: ${e.length} ürün`);let l={},s=(e.forEach(e=>{var t=e.location||"Bilinmeyen",a=e.product_name||e.product||"",r=e.brand||"",n=(l[t]||(l[t]={}),r+"_"+a);l[t][n]||(l[t][n]={brand:r,product:a,stock:0,sales:0,salesQty:0}),l[t][n].stock+=parseFloat(e.quantity)||0}),new Date);s.setMonth(s.getMonth()-12),allData.forEach(e=>{var t,a;new Date(e.date)<s||(t=e.store||"Bilinmeyen",a=(e.brand||"")+"_"+(e.product||""),l[t]&&l[t][a]&&(l[t][a].sales+=parseFloat(e.usd_amount)||0,l[t][a].salesQty+=parseFloat(e.quantity)||0))}),Object.keys(l).forEach(a=>{Object.keys(l[a]).forEach(e=>{var e=l[a][e],t=e.salesQty/12,t=Math.ceil(2*t*1.2),t=(e.recommendedStock=t,Math.max(0,t-e.stock));e.recommendedPurchase=Math.ceil(t)})}),renderStockAnalysisTable(l)}else console.warn("⚠️ Envanter veya satış verisi yok!"),document.getElementById("stockAnalysisTableContainer").innerHTML='<p style="text-align: center; color: #f5576c; padding: 40px;">⚠️ Veri henüz yüklenmedi. Lütfen bekleyin...</p>'}function renderStockAnalysisTable(e){var t=document.getElementById("stockAnalysisTableContainer");if(t){let a="";Object.entries(e).sort((e,t)=>e[0].localeCompare(t[0])).forEach(([e,t])=>{t=Object.values(t);0!==t.length&&(a+=`
                    <div style="margin-bottom: 40px;">
                        <h4 style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">
                            🏪 ${e} <span style="opacity: 0.8; font-size: 0.9em;">(${t.length} ürün)</span>
                        </h4>
                        <table style="width: 100%; border-collapse: collapse; background: white; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.1);">
                            <thead>
                                <tr style="background: #f8f9fa; text-align: left;">
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Marka</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6;">Ürün</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: right;">📦 Stok</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: right;">📊 Satış (12 Ay)</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: right;">🤖 Önerilen Stok</th>
                                    <th style="padding: 12px; border-bottom: 2px solid #dee2e6; text-align: right;">🛒 Önerilen Satın Alma</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${t.map(e=>`
                                        <tr style="${e.stock>=e.recommendedStock?"background: #d4edda;":e.stock<.5*e.recommendedStock?"background: #f8d7da;":""}">
                                            <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${e.brand||"-"}</td>
                                            <td style="padding: 10px; border-bottom: 1px solid #dee2e6;">${e.product||"-"}</td>
                                            <td style="padding: 10px; border-bottom: 1px solid #dee2e6; text-align: right; font-weight: bold;">${e.stock.toFixed(0)}</td>
                                            <td style="padding: 10px; border-bottom: 1px solid #dee2e6; text-align: right;">${e.salesQty.toFixed(0)} adet</td>
                                            <td style="padding: 10px; border-bottom: 1px solid #dee2e6; text-align: right; color: #667eea; font-weight: bold;">${e.recommendedStock}</td>
                                            <td style="padding: 10px; border-bottom: 1px solid #dee2e6; text-align: right; ${0<e.recommendedPurchase?"color: #f5576c; font-weight: bold;":"color: #38ef7d;"}">${0<e.recommendedPurchase?e.recommendedPurchase:"✓ Yeterli"}</td>
                                        </tr>
                                    `).join("")}
                            </tbody>
                        </table>
                    </div>
                `)}),""===a&&(a='<p style="text-align: center; color: #666; padding: 40px;">Filtre kriterlerine uygun ürün bulunamadı.</p>'),t.innerHTML=a,console.log("✅ Stok analiz tablosu oluşturuldu!")}}function clearStockFilters(){document.getElementById("stockSearchBrand").value="",document.getElementById("stockSearchProduct").value="",document.getElementById("stockSearchCat2").value="",document.getElementById("stockSearchCat3").value="",document.getElementById("stockSearchCat4").value="",filterStockAnalysis(),console.log("🗑️ Stok filtreleri temizlendi")}function renderInventoryCharts(){let a={};inventoryData.forEach(e=>{var t=e.brand||"Diğer";a[t]||(a[t]=0),a[t]+=parseFloat(e.value)||0});var e=Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,10);let r={};inventoryData.forEach(e=>{var t=e.category||"Diğer";r[t]||(r[t]=0),r[t]+=parseFloat(e.value)||0});var t=Object.entries(r).sort((e,t)=>t[1]-e[1]).slice(0,10);let n={};inventoryData.forEach(e=>{var t=e.location||"Diğer";n[t]||(n[t]=0),n[t]+=parseFloat(e.value)||0});var o=Object.entries(n).sort((e,t)=>t[1]-e[1]).slice(0,10),i=[...inventoryData].sort((e,t)=>(parseFloat(t.value)||0)-(parseFloat(e.value)||0)).slice(0,10),l=(inventoryCharts.brand&&inventoryCharts.brand.destroy(),document.getElementById("invBrandChart")),l=(l&&(inventoryCharts.brand=new Chart(l,{type:"bar",data:{labels:e.map(e=>e[0]),datasets:[{label:"Stok Değeri ($)",data:e.map(e=>e[1]),backgroundColor:"#667eea"}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{display:!1}}}})),inventoryCharts.category&&inventoryCharts.category.destroy(),document.getElementById("invCategoryChart")),e=(l&&(inventoryCharts.category=new Chart(l,{type:"doughnut",data:{labels:t.map(e=>e[0]),datasets:[{data:t.map(e=>e[1]),backgroundColor:["#667eea","#f093fb","#4facfe","#43e97b","#fa709a","#fee140","#30cfd0","#a8edea","#ffa751","#f5576c"]}]},options:{responsive:!0,maintainAspectRatio:!0}})),inventoryCharts.location&&inventoryCharts.location.destroy(),document.getElementById("invLocationChart")),l=(e&&(inventoryCharts.location=new Chart(e,{type:"bar",data:{labels:o.map(e=>e[0]),datasets:[{label:"Stok Değeri ($)",data:o.map(e=>e[1]),backgroundColor:"#f093fb"}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{display:!1}}}})),inventoryCharts.topValue&&inventoryCharts.topValue.destroy(),document.getElementById("invTopValueChart"));l&&(inventoryCharts.topValue=new Chart(l,{type:"horizontalBar",data:{labels:i.map(e=>(e.product||"Bilinmeyen").substring(0,30)),datasets:[{label:"Değer ($)",data:i.map(e=>parseFloat(e.value)||0),backgroundColor:"#43e97b"}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{display:!1}}}}))}function renderInventoryTable(){var e,t=document.getElementById("inventoryTableBody");t&&(e=inventoryData.slice(0,100),t.innerHTML=e.map(e=>`
                <tr>
                    <td>${e.product||"-"}</td>
                    <td>${e.brand||"-"}</td>
                    <td>${e.category||"-"}</td>
                    <td>${e.location||"-"}</td>
                    <td style="text-align: right;">${(parseFloat(e.quantity)||0).toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                    <td style="text-align: right;">$${(parseFloat(e.value)||0).toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                </tr>
            `).join(""),console.log(`✅ Envanter tablosu oluşturuldu: ${e.length} kayıt`))}function filterInventoryTable(){if(inventoryData&&0!==inventoryData.length){let t=document.getElementById("inventorySearch").value.toLowerCase();var e,a,r;t.trim()?(e=inventoryData.filter(e=>e.product&&e.product.toLowerCase().includes(t)||e.brand&&e.brand.toLowerCase().includes(t)||e.category&&e.category.toLowerCase().includes(t)||e.location&&e.location.toLowerCase().includes(t)),(a=document.getElementById("inventoryTableBody"))&&(r=e.slice(0,100),a.innerHTML=r.map(e=>`
                <tr>
                    <td>${e.product||"-"}</td>
                    <td>${e.brand||"-"}</td>
                    <td>${e.category||"-"}</td>
                    <td>${e.location||"-"}</td>
                    <td style="text-align: right;">${(parseFloat(e.quantity)||0).toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                    <td style="text-align: right;">$${(parseFloat(e.value)||0).toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                </tr>
            `).join(""),console.log(`🔍 Arama sonucu: ${e.length} kayıt bulundu, ${r.length} gösteriliyor`))):renderInventoryTable()}}function populateFilters(){let t=new Set,a=new Set,r=new Set,n=new Set;new Set;let o=new Set,i=new Set,l=new Set,s=new Set,d=new Set,c=new Set;allData.forEach(e=>{e.brand&&t.add(e.brand),e.category_2&&a.add(e.category_2),e.category_3&&r.add(e.category_3),e.category_4&&n.add(e.category_4),e.sales_person&&o.add(e.sales_person),e.store&&i.add(e.store),e.city&&l.add(e.city),e.date&&3<=(e=e.date.split("-")).length&&(s.add(e[0]),d.add(e[1]),c.add(e[2]))}),populateMultiSelect("filterBrand",Array.from(t).sort(),"countBrand"),populateMultiSelect("filterCategory1",Array.from(a).sort(),"countCategory1"),populateMultiSelect("filterCategory2",Array.from(r).sort(),"countCategory2"),populateMultiSelect("filterCategory3",Array.from(n).sort(),"countCategory3"),populateMultiSelect("filterSalesPerson",Array.from(o).sort(),"countSalesPerson"),populateMultiSelect("filterStore",Array.from(i).sort(),"countStore"),populateMultiSelect("filterCity",Array.from(l).sort(),"countCity"),populateMultiSelect("filterYear",Array.from(s).sort().reverse(),"countYear"),populateMultiSelect("filterMonth",Array.from(d).sort(),"countMonth"),populateMultiSelect("filterDay",Array.from(c).sort(),"countDay")}function populateMultiSelect(o,e,i){let l=document.getElementById(o);if(l){let n=Array.from(l.querySelectorAll('input[type="checkbox"]:checked')).map(e=>e.value);l.innerHTML="",e.forEach(e=>{var t=document.createElement("div"),a=(t.className="checkbox-item",document.createElement("input")),r=(a.type="checkbox",a.value=e,a.id=o+"_"+e.replace(/\s+/g,"_"),a.checked=n.includes(e),document.createElement("label"));r.htmlFor=a.id,r.textContent=e,a.addEventListener("change",()=>updateSelectionCount(o,i)),t.appendChild(a),t.appendChild(r),l.appendChild(t)}),updateSelectionCount(o,i)}}function updateSelectionCount(e,t){var e=document.getElementById(e);e&&(e=e.querySelectorAll('input[type="checkbox"]:checked').length,t=document.getElementById(t))&&(t.textContent=0<e?`(${e} seçili)`:"")}function getSelectedValues(e){e=document.getElementById(e);return e?Array.from(e.querySelectorAll('input[type="checkbox"]:checked')).map(e=>e.value):[]}function filterCheckboxes(e,t){e=document.getElementById(e);if(e){let a=t.toLowerCase().trim();e.querySelectorAll(".checkbox-item").forEach(e=>{var t=e.querySelector("label");t&&(t=t.textContent.toLowerCase(),""===a||t.includes(a)?e.classList.remove("hidden"):e.classList.add("hidden"))})}}function applyFilters(){let r=getSelectedValues("filterBrand"),n=getSelectedValues("filterCategory1"),t=getSelectedValues("filterCategory2"),a=getSelectedValues("filterCategory3"),o=getSelectedValues("filterSalesPerson"),i=getSelectedValues("filterStore"),l=getSelectedValues("filterCity"),s=getSelectedValues("filterYear"),d=getSelectedValues("filterMonth"),c=getSelectedValues("filterDay");console.log("🔍 Çoklu Filtreler:",{brands:r.length,cat1s:n.length,cat2s:t.length,cat3s:a.length,salesPersons:o.length,stores:i.length,cities:l.length,years:s.length,months:d.length,days:c.length}),filteredData=allData.filter(e=>{if(0<r.length&&!r.includes(e.brand))return!1;if(0<n.length&&!n.includes(e.category_2))return!1;if(0<t.length&&!t.includes(e.category_3))return!1;if(0<a.length&&!a.includes(e.category_4))return!1;if(0<o.length&&!o.includes(e.sales_person))return!1;if(0<i.length){let t=(e.store||"").toLowerCase();if(!i.some(e=>t.includes(e.toLowerCase())))return!1}if(0<l.length&&!l.includes(e.city))return!1;if(0<s.length||0<d.length||0<c.length){if(!e.date)return!1;e=e.date.split("-");if(e.length<3)return!1;if(0<s.length&&!s.includes(e[0]))return!1;if(0<d.length&&!d.includes(e[1]))return!1;if(0<c.length&&!c.includes(e[2]))return!1}return!0}),console.log(`Filtreleme sonucu: ${filteredData.length} kayit`);var e=document.getElementById("debugPanel"),m=document.getElementById("debugInfo");if(0<filteredData.length){var g=filteredData.reduce((e,t)=>e+(parseFloat(t.usd_amount)||0),0),u=filteredData.reduce((e,t)=>e+(parseFloat(t.quantity)||0),0),p=new Set(filteredData.map(e=>e.store)).size;let t={};filteredData.forEach(e=>{e=e.date||"Bilinmeyen";t[e]=(t[e]||0)+1});var y=Object.entries(t).sort((e,t)=>t[1]-e[1]).slice(0,5);let a=`<strong>Toplam Kayit:</strong> ${allData.length.toLocaleString("tr-TR")}<br>`;a=(a=(a=(a+=`<strong>Filtrelenmis Kayit:</strong> ${filteredData.length.toLocaleString("tr-TR")}<br>`)+`<strong>Toplam USD:</strong> $${g.toLocaleString("tr-TR",{minimumFractionDigits:2})}<br>`)+`<strong>Toplam Miktar:</strong> ${u.toLocaleString("tr-TR",{minimumFractionDigits:2})}<br>`)+`<strong>Benzersiz Magaza:</strong> ${p}<br><br>`+"<strong>Aktif Filtreler:</strong><br>",0<i.length&&(a+=`- Magaza: ${i.join(", ")}<br>`),0<s.length&&(a+=`- Yil: ${s.join(", ")}<br>`),0<d.length&&(a+=`- Ay: ${d.join(", ")}<br>`),0<c.length&&(a+=`- Gun: ${c.join(", ")}<br>`),0<r.length&&(a+=`- Marka: ${r.join(", ")}<br>`),0<n.length&&(a+=`- Kategori 1: ${n.join(", ")}<br>`),a+="<br><strong>En Cok Kayit Olan 5 Gun:</strong><br>",y.forEach(([e,t])=>{a+=`- ${e}: ${t} kayit<br>`}),a+="<br><strong>Ornek Kayitlar (ilk 3):</strong><br>";for(let e=0;e<Math.min(3,filteredData.length);e++)a=(a=(a+=`<br>${e+1}. Tarih: ${filteredData[e].date} | Magaza: ${filteredData[e].store}<br>`)+`   USD: $${parseFloat(filteredData[e].usd_amount).toFixed(2)} | Miktar: ${filteredData[e].quantity}<br>`)+`   Musteri: ${filteredData[e].partner}<br>`;m.innerHTML=a,e.style.display="block"}updateSummary(),renderTable()}function resetFilters(){["filterBrand","filterCategory1","filterCategory2","filterCategory3","filterCategory4","filterSalesPerson","filterStore","filterCity","filterYear","filterMonth","filterDay"].forEach(e=>{e=document.getElementById(e);e&&e.querySelectorAll('input[type="checkbox"]').forEach(e=>e.checked=!1)}),["countBrand","countCategory1","countCategory2","countCategory3","countCategory4","countSalesPerson","countStore","countCity","countYear","countMonth","countDay"].forEach(e=>{e=document.getElementById(e);e&&(e.textContent="")}),document.getElementById("smartSearch").value="",document.getElementById("debugPanel").style.display="none",document.getElementById("aiAnalysisPanel").style.display="none",filteredData=[...allData],updateSummary(),renderTable()}function applySmartSearch(){var e=document.getElementById("smartSearch").value.trim();(e?(console.log("🤖 AI AGENT BAŞLATILIYOR..."),console.log("📝 Sorgu:",e),resetFilters(),e=analyzeQueryWithAI(e),console.log("🧠 AI Analiz Sonucu:",e),applyAIFilters(e),filteredData=filterDataWithAI(allData,e),console.log(`✅ AI Agent Sonucu: ${filteredData.length} kayıt bulundu`),"basic"!==e.queryType?performAdvancedAnalysis(e,filteredData):showAIInterpretation(e,filteredData.length),updateSummary(),renderTable):resetFilters)()}function analyzeQueryWithAI(e){let n=e.toLowerCase(),o={intent:"search",queryType:"basic",entities:{stores:[],brands:[],categories:[],cities:[],salesPersons:[],products:[],dateRange:null,years:[],months:[],keywords:[]},question:{type:null,subject:null,object:null,action:null},confidence:0,interpretation:"",needsGPT:!1};var a,t=e.match(/(.+?)\s+(en\s+çok|en\s+fazla)?\s*hangi\s+(ürün|marka|kategori|model).*?(sattı|satmış|satıyor)/i),t=(t&&(o.queryType="person_analysis",o.question.type="who_sold_what",o.question.subject=t[1].trim(),o.question.object=t[3],o.question.action="sattı",o.intent="analyze",console.log("🎯 Tespit: Kişi analizi -",o.question.subject,"hangi",o.question.object,"sattı?")),e.match(/(.+?)\s+(en\s+çok|en\s+fazla)?\s*hangi\s+(marka|model|kategori|ürün).*?(aldı|almış|alıyor|satın\s+aldı)/i)),t=(t&&(o.queryType="city_analysis",o.question.type="city_bought_what",o.question.subject=t[1].trim(),o.question.object=t[3],o.question.action="aldı",o.intent="analyze",console.log("🎯 Tespit: Şehir/Müşteri analizi -",o.question.subject,"hangi",o.question.object,"aldı?")),e.match(/hangi\s+(mağaza|şehir|yer).*?(satmalı|satmalıyım|satmak|konumlandır|daha\s+çok\s+sat)/i)&&(o.queryType="product_recommendation",o.question.type="where_to_sell",o.question.action="satmalı",o.intent="recommendation",o.needsGPT=!0,console.log("🎯 Tespit: Ürün konumlandırma önerisi")),e.match(/(.+?)\s+için\s+en\s+iyi\s+(mağaza|şehir|yer|kategori)/i)),t=(t&&(o.queryType="product_recommendation",o.question.type="best_for",o.question.subject=t[1].trim(),o.question.object=t[2],o.intent="recommendation",console.log("🎯 Tespit: En iyi yer önerisi -",o.question.subject,"için")),e.match(/hangi\s+(ürün|marka|kategori).*?(şehir|mağaza|yer).*?(popüler|çok\s+sat|başarılı)/i)),r=(t&&(o.queryType="city_analysis",o.question.type="what_popular_where",o.question.object=t[1],o.intent="analyze",console.log("🎯 Tespit: Popülerlik analizi")),[...new Set(allData.map(e=>e.store).filter(Boolean))]);r.forEach(e=>{var t=e.toLowerCase();(n.includes(t)||t.includes(n)||fuzzyMatch(n,t))&&o.entities.stores.push(e)});for(let[e,t]of Object.entries({aka:"akasya",kadi:"kadıköy","kadı":"kadıköy",beylik:"beylikdüzü",beyl:"beylikdüzü"}))n.includes(e)&&(a=r.filter(e=>e.toLowerCase().includes(t)),o.entities.stores.push(...a));[...new Set(allData.map(e=>e.brand).filter(Boolean))].forEach(e=>{n.includes(e.toLowerCase())&&o.entities.brands.push(e)});let i=new Set;allData.forEach(e=>{[e.category_1,e.category_2,e.category_3,e.category_4].forEach(e=>{e&&i.add(e)})}),Array.from(i).forEach(e=>{n.includes(e.toLowerCase())&&o.entities.categories.push(e)});var l;for(let[t,e]of Object.entries({gitar:["gitar","guitar"],piyano:["piyano","piano"],davul:["davul","drum","bateri"],keman:["keman","violin"],saz:["saz","bağlama"],aksesu:["aksesuar","aksesuarlar"]}))e.some(e=>n.includes(e))&&(l=Array.from(i).filter(e=>e.toLowerCase().includes(t)),o.entities.categories.push(...l));var s;for(s of[/son\s+(\d+)\s+(gün|gun)/i,/son\s+(\d+)\s+(ay)/i,/son\s+(\d+)\s+(hafta)/i,/geçen\s+(\d+)\s+(gün|gun|ay|hafta)/i,/gecen\s+(\d+)\s+(gün|gun|ay|hafta)/i]){var d=e.match(s);if(d){var c=parseInt(d[1]),d=d[2].toLowerCase(),m=new Date;d.includes("ay")?m.setMonth(m.getMonth()-c):d.includes("hafta")?m.setDate(m.getDate()-7*c):m.setDate(m.getDate()-c),o.entities.dateRange={from:m.toISOString().split("T")[0],to:(new Date).toISOString().split("T")[0],description:`Son ${c} `+d};break}}var g,u;for([g,u]of Object.entries({ocak:"01",january:"01",jan:"01","şubat":"02",subat:"02",february:"02",feb:"02",mart:"03",march:"03",mar:"03",nisan:"04",april:"04",apr:"04","mayıs":"05",mayis:"05",may:"05",haziran:"06",june:"06",jun:"06",temmuz:"07",july:"07",jul:"07","ağustos":"08",agustos:"08",august:"08",aug:"08","eylül":"09",eylul:"09",september:"09",sep:"09",ekim:"10",october:"10",oct:"10","kasım":"11",kasim:"11",november:"11",nov:"11","aralık":"12",aralik:"12",december:"12",dec:"12"}))n.includes(g)&&o.entities.months.push(u);t=e.match(/\b(202[0-9])\b/g);t&&o.entities.years.push(...t),[...new Set(allData.map(e=>e.city).filter(Boolean))].forEach(e=>{n.includes(e.toLowerCase())&&o.entities.cities.push(e)});[...new Set(allData.map(e=>e.sales_person).filter(Boolean))].forEach(e=>{var t=e.toLowerCase(),a=n.split(/\s+/);let r=t.split(/\s+/);(a.some(t=>r.some(e=>e.includes(t)||t.includes(e)))||n.includes(t))&&o.entities.salesPersons.push(e)});var p,y=[...new Set(allData.map(e=>e.product).filter(Boolean))];for(let[t,e]of Object.entries({gitar:["gitar","guitar","elektro gitar","akustik gitar"],piyano:["piyano","piano","dijital piyano","akustik piyano"],davul:["davul","drum","bateri","davul seti"],keman:["keman","violin"],saz:["saz","bağlama"],amfi:["amfi","amplifier","amplifikatör"]}))e.some(e=>n.includes(e))&&(p=y.filter(e=>e.toLowerCase().includes(t)),o.entities.products.push(...p.slice(0,5)));let h=["ve","veya","ile","için","son","gün","gun","ay","yıl","yil","toplam","kaç","kac","ne","kadar","göster","goster","bul","ara"];t=e.toLowerCase().split(/\s+/).filter(e=>2<e.length&&!h.includes(e)&&!/^\d+$/.test(e));o.entities.keywords=t;let b=0;0<o.entities.stores.length&&(b+=30),0<o.entities.brands.length&&(b+=25),0<o.entities.categories.length&&(b+=20),(o.entities.dateRange||0<o.entities.years.length||0<o.entities.months.length)&&(b+=15),0<o.entities.keywords.length&&(b+=10),o.confidence=Math.min(b,100);t=[];return 0<o.entities.stores.length&&t.push("Mağaza: "+o.entities.stores.join(", ")),0<o.entities.brands.length&&t.push("Marka: "+o.entities.brands.join(", ")),0<o.entities.categories.length&&t.push("Kategori: "+o.entities.categories.join(", ")),o.entities.dateRange?t.push("Tarih: "+o.entities.dateRange.description):0<o.entities.years.length&&t.push("Yıl: "+o.entities.years.join(", ")),0<o.entities.months.length&&t.push("Ay: "+o.entities.months.join(", ")),0<o.entities.keywords.length&&t.push("Anahtar: "+o.entities.keywords.join(", ")),o.interpretation=0<t.length?t.join(" | "):"Genel arama",o}function fuzzyMatch(e,t){e=e.split(/\s+/);let a=t.toLowerCase();return e.some(e=>!(e.length<3)&&(a.includes(e)||levenshteinDistance(e,a)<3))}function levenshteinDistance(a,r){var n=[];for(let e=0;e<=r.length;e++)n[e]=[e];for(let e=0;e<=a.length;e++)n[0][e]=e;for(let t=1;t<=r.length;t++)for(let e=1;e<=a.length;e++)r.charAt(t-1)===a.charAt(e-1)?n[t][e]=n[t-1][e-1]:n[t][e]=Math.min(n[t-1][e-1]+1,n[t][e-1]+1,n[t-1][e]+1);return n[r.length][a.length]}function applyAIFilters(a){var e;0<a.entities.stores.length&&(e=document.getElementById("filterStore"))&&(e.querySelectorAll('input[type="checkbox"]').forEach(t=>{a.entities.stores.some(e=>t.value.toLowerCase().includes(e.toLowerCase()))&&(t.checked=!0)}),updateSelectionCount("filterStore","countStore")),0<a.entities.brands.length&&(e=document.getElementById("filterBrand"))&&(e.querySelectorAll('input[type="checkbox"]').forEach(e=>{a.entities.brands.includes(e.value)&&(e.checked=!0)}),updateSelectionCount("filterBrand","countBrand")),0<a.entities.years.length&&(e=document.getElementById("filterYear"))&&(e.querySelectorAll('input[type="checkbox"]').forEach(e=>{a.entities.years.includes(e.value)&&(e.checked=!0)}),updateSelectionCount("filterYear","countYear")),0<a.entities.months.length&&(e=document.getElementById("filterMonth"))&&(e.querySelectorAll('input[type="checkbox"]').forEach(e=>{a.entities.months.includes(e.value)&&(e.checked=!0)}),updateSelectionCount("filterMonth","countMonth"))}function filterDataWithAI(e,r){return e.filter(a=>{if(0<r.entities.stores.length){let t=(a.store||"").toLowerCase();if(!r.entities.stores.some(e=>t.includes(e.toLowerCase())))return!1}if(0<r.entities.brands.length&&!r.entities.brands.includes(a.brand))return!1;if(0<r.entities.categories.length){let e=[a.category_1,a.category_2,a.category_3,a.category_4].filter(Boolean).map(e=>e.toLowerCase());if(!r.entities.categories.some(t=>e.some(e=>e.includes(t.toLowerCase())||t.toLowerCase().includes(e))))return!1}if(r.entities.dateRange&&(!a.date||a.date<r.entities.dateRange.from))return!1;if(0<r.entities.years.length&&a.date){var e=a.date.split("-")[0];if(!r.entities.years.includes(e))return!1}if(0<r.entities.months.length&&a.date){e=a.date.split("-")[1];if(!r.entities.months.includes(e))return!1}if(0<r.entities.cities.length&&!r.entities.cities.includes(a.city))return!1;if(0<r.entities.salesPersons.length&&!r.entities.salesPersons.includes(a.sales_person))return!1;if(0<r.entities.keywords.length){let t=[a.partner,a.product,a.brand,a.category_1,a.category_2,a.category_3,a.category_4,a.sales_person,a.store,a.city].filter(Boolean).join(" ").toLowerCase();if(!r.entities.keywords.some(e=>t.includes(e)))return!1}return!0})}function showAIInterpretation(e,t){var a=document.getElementById("debugPanel"),r=document.getElementById("debugInfo");let n='<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin-bottom: 15px;">';n=(n=(n=(n+='<h4 style="margin: 0 0 10px 0; color: white;">🤖 AI Agent Analizi</h4>')+`<p style="margin: 5px 0; font-size: 0.95em;"><strong>Anladığım:</strong> ${e.interpretation}</p>`)+`<p style="margin: 5px 0; font-size: 0.9em;">📊 Güvenilirlik: ${e.confidence}% | 🎯 Sonuç: ${t} kayıt</p>`)+"</div><strong>🔍 Tespit Edilen Varlıklar:</strong><br>",0<e.entities.stores.length&&(n+=`🏪 Mağazalar: ${e.entities.stores.join(", ")}<br>`),0<e.entities.brands.length&&(n+=`🏷️ Markalar: ${e.entities.brands.join(", ")}<br>`),0<e.entities.categories.length&&(n+=`📂 Kategoriler: ${e.entities.categories.join(", ")}<br>`),e.entities.dateRange&&(n+=`📅 Tarih: ${e.entities.dateRange.description}<br>`),0<e.entities.years.length&&(n+=`📆 Yıl: ${e.entities.years.join(", ")}<br>`),0<e.entities.months.length&&(n+=`📆 Ay: ${e.entities.months.join(", ")}<br>`),0<e.entities.cities.length&&(n+=`🌍 Şehir: ${e.entities.cities.join(", ")}<br>`),0<e.entities.salesPersons.length&&(n+=`👤 Satış Tem.: ${e.entities.salesPersons.join(", ")}<br>`),0<e.entities.keywords.length&&(n+=`🔑 Anahtar Kelimeler: ${e.entities.keywords.join(", ")}<br>`),r.innerHTML=n,a.style.display="block"}function performAdvancedAnalysis(a,n){console.log("🎯 Gelişmiş analiz başlatılıyor:",a.queryType);var e=document.getElementById("debugPanel"),t=document.getElementById("debugInfo");let o='<div style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); color: white; padding: 20px; border-radius: 10px;">';if(o+='<h3 style="margin: 0 0 15px 0; color: white;">🤖 Gelişmiş AI Analizi</h3>',"person_analysis"===a.queryType){let t=a.question.subject,r=a.question.object;var i=n.filter(e=>e.sales_person&&e.sales_person.toLowerCase().includes(t.toLowerCase()));if(0===i.length)o+=`<p>⚠️ "${t}" adlı satış temsilcisi bulunamadı.</p>`;else{let a={};i.forEach(e=>{let t;"ürün"===r?t=e.product:"marka"===r?t=e.brand:"kategori"===r?t=e.category_1:"model"===r&&(t=e.product),t&&(a[t]||(a[t]={sales:0,count:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].count+=1)});var l=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,5);o=(o=(o=(o+=`<p style="font-size: 1.1em; margin-bottom: 15px;">📊 <strong>${t}</strong> analizi:</p>`)+`<p>💰 Toplam Satış: <strong>$${i.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0).toLocaleString("tr-TR",{minimumFractionDigits:2})}</strong></p>`)+`<p>📦 Toplam İşlem: <strong>${i.length}</strong></p>`+'<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">')+`<p style="font-size: 1.05em; margin-bottom: 10px;">🏆 En Çok Sattığı ${r.charAt(0).toUpperCase()+r.slice(1)}ler:</p>`,l.forEach((e,t)=>{o=(o=(o+='<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 5px; margin: 8px 0;">')+`<strong>${t+1}. ${e[0]}</strong><br>`)+`💰 Satış: $${e[1].sales.toLocaleString("tr-TR",{minimumFractionDigits:2})} | 📦 Adet: `+e[1].count+"</div>"}),o=(o+='<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">')+`<p style="font-size: 1em;">💡 <strong>Öneri:</strong> ${t}, <strong>${l[0][0]}</strong> konusunda uzman. Bu ${r}'e odaklanmalı ve stok takibi yapmalı.</p>`}}else if("city_analysis"===a.queryType){let t=a.question.subject,r=a.question.object,e=n.filter(e=>e.city&&e.city.toLowerCase().includes(t.toLowerCase()));if(0===(e=0===e.length?n.filter(e=>e.partner&&e.partner.toLowerCase().includes(t.toLowerCase())):e).length)o+=`<p>⚠️ "${t}" için veri bulunamadı.</p>`;else{let a={};e.forEach(e=>{let t;"marka"===r?t=e.brand:"model"===r?t=e.product:"kategori"===r?t=e.category_1:"ürün"===r&&(t=e.product),t&&(a[t]||(a[t]={sales:0,count:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].count+=1)});i=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,5);o=(o=(o=(o+=`<p style="font-size: 1.1em; margin-bottom: 15px;">📊 <strong>${t}</strong> analizi:</p>`)+`<p>💰 Toplam Satış: <strong>$${e.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0).toLocaleString("tr-TR",{minimumFractionDigits:2})}</strong></p>`)+`<p>📦 Toplam İşlem: <strong>${e.length}</strong></p>`+'<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">')+`<p style="font-size: 1.05em; margin-bottom: 10px;">🏆 En Çok Tercih Edilen ${r.charAt(0).toUpperCase()+r.slice(1)}ler:</p>`,i.forEach((e,t)=>{o=(o=(o+='<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 5px; margin: 8px 0;">')+`<strong>${t+1}. ${e[0]}</strong><br>`)+`💰 Satış: $${e[1].sales.toLocaleString("tr-TR",{minimumFractionDigits:2})} | 📦 Adet: `+e[1].count+"</div>"}),o=(o+='<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">')+`<p style="font-size: 1em;">💡 <strong>Öneri:</strong> ${t}'da <strong>${i[0][0]}</strong> en popüler. Bu ${r} için stok artırılmalı.</p>`}}else if("product_recommendation"===a.queryType){o+='<p style="font-size: 1.1em; margin-bottom: 15px;">🎯 Ürün Konumlandırma Önerisi</p>';let r={};n.forEach(e=>{var t=e.store||"Bilinmiyor",a=e.category_1||"Bilinmiyor";r[t]||(r[t]={sales:0,count:0,categories:{}}),r[t].sales+=parseFloat(e.usd_amount||0),r[t].count+=1,r[t].categories[a]||(r[t].categories[a]=0),r[t].categories[a]+=parseFloat(e.usd_amount||0)});l=Object.entries(r).sort((e,t)=>t[1].sales-e[1].sales).slice(0,3);o+="<p>📊 Mağaza Performans Analizi:</p>",l.forEach((e,t)=>{var a=e[0],e=e[1],r=Object.entries(e.categories).sort((e,t)=>t[1]-e[1])[0];o=(o=(o=(o=o+'<div style="background: rgba(255,255,255,0.15); padding: 12px; border-radius: 5px; margin: 10px 0;">'+`<strong>${t+1}. ${a}</strong><br>`)+`💰 Toplam Satış: $${e.sales.toLocaleString("tr-TR",{minimumFractionDigits:2})}<br>`)+`📦 İşlem Sayısı: ${e.count}<br>`)+"🏆 En Güçlü Kategori: "+r[0]+"</div>"}),o=(o=(o=o+'<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;">'+'<p style="font-size: 1em;">💡 <strong>Öneri:</strong></p>')+`<p>• <strong>${l[0][0]}</strong> en yüksek satış performansına sahip.</p>`+"<p>• Yeni ürün için bu mağazayı tercih edin.</p>")+`<p>• Özellikle <strong>${Object.entries(l[0][1].categories).sort((e,t)=>t[1]-e[1])[0][0]}</strong> kategorisinde güçlü.</p>`,a.needsGPT&&(o+='<hr style="border: 1px solid rgba(255,255,255,0.3); margin: 15px 0;"><p style="font-size: 0.9em; opacity: 0.9;">🤖 <em>Daha detaylı analiz için GPT-4 kullanılabilir. (İsteğe bağlı)</em></p>')}o+="</div>",t.innerHTML=o,e.style.display="block"}function updateSummary(){console.log("updateSummary - Filtrelenmis veri sayisi:",filteredData.length);var e=filteredData.reduce((e,t)=>e+(parseFloat(t.usd_amount)||0),0),t=filteredData.reduce((e,t)=>e+(parseFloat(t.quantity)||0),0),a=new Set(filteredData.map(e=>e.partner)).size,r=new Set(filteredData.map(e=>e.product)).size,n=(console.log("Ozet:",{totalUSD:e,totalQty:t,uniquePartners:a,uniqueProducts:r}),document.getElementById("summaryUSD")),o=document.getElementById("summaryQuantity"),i=document.getElementById("summaryPartners"),l=document.getElementById("summaryProducts");n&&(n.textContent="$"+e.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2})),o&&(o.textContent=t.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2})),i&&(i.textContent=a.toLocaleString("tr-TR")),l&&(l.textContent=r.toLocaleString("tr-TR")),0<filteredData.length&&performAIAnalysis()}window.handleChannelFilter=function(e){console.log("🔄 handleChannelFilter çağrıldı, tıklanan:",e),console.log("📊 baseData boyutu:",baseData.length),console.log("📊 allData boyutu:",allData.length);var t=document.getElementById("channelAll").checked,a=document.getElementById("channelRetail").checked,r=document.getElementById("channelWholesale").checked,n=document.getElementById("channelOnline").checked,o=document.getElementById("channelCorporate").checked,i=document.getElementById("channelCentral").checked;console.log("✅ Checkbox durumları:",{channelAll:t,channelRetail:a,channelWholesale:r,channelOnline:n,channelCorporate:o,channelCentral:i}),"channelAll"===e&&t?(document.getElementById("channelRetail").checked=!1,document.getElementById("channelWholesale").checked=!1,document.getElementById("channelOnline").checked=!1,document.getElementById("channelCorporate").checked=!1,document.getElementById("channelCentral").checked=!1,activeChannels={all:!0,retail:!1,wholesale:!1,online:!1,corporate:!1,central:!1}):"channelAll"!==e&&(a||r||n||o||i)?(document.getElementById("channelAll").checked=!1,activeChannels={all:!1,retail:a,wholesale:r,online:n,corporate:o,central:i}):(t||a||r||n||o||i)&&("channelAll"!==e||t)||(document.getElementById("channelAll").checked=!0,activeChannels={all:!0,retail:!1,wholesale:!1,online:!1,corporate:!1,central:!1}),applyChannelFilter()};let topCategoryChart=null,topBrandChart=null,topProductChart=null,topSalesPersonChart=null;function renderTable(){var s=document.getElementById("tableContainer");if(s)if(0===filteredData.length)s.innerHTML='<div class="loading">⚠️ Filtreye uygun veri bulunamadi.</div>';else{let a={},r={},n={},o={},e=(filteredData.forEach(e=>{var t=e.category_1||"Bilinmiyor",t=(a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0),e.brand||"Bilinmiyor"),t=(r[t]||(r[t]=0),r[t]+=parseFloat(e.usd_amount||0),e.product||"Bilinmiyor"),t=(n[t]||(n[t]=0),n[t]+=parseFloat(e.usd_amount||0),e.sales_person||"Bilinmiyor");o[t]||(o[t]=0),o[t]+=parseFloat(e.usd_amount||0)}),Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,10)),t=Object.entries(r).sort((e,t)=>t[1]-e[1]).slice(0,10),i=Object.entries(n).sort((e,t)=>t[1]-e[1]).slice(0,10),l=Object.entries(o).sort((e,t)=>t[1]-e[1]).slice(0,10);s.innerHTML=`
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(500px, 1fr)); gap: 30px; margin-top: 30px;">
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 20px;">🏆 En Başarılı Kategoriler</h3>
                        <canvas id="topCategoryChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 20px;">🏷️ En Çok Satan Markalar</h3>
                        <canvas id="topBrandChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 20px;">⭐ En Çok Satan Ürünler</h3>
                        <canvas id="topProductChart"></canvas>
                    </div>
                    <div class="chart-container">
                        <h3 style="text-align: center; margin-bottom: 20px;">👤 En Başarılı Satış Temsilcileri</h3>
                        <canvas id="topSalesPersonChart"></canvas>
                    </div>
                </div>
            `,setTimeout(()=>{renderTopCategoryChart(e),renderTopBrandChart(t),renderTopProductChart(i),renderTopSalesPersonChart(l)},100)}}function renderTopCategoryChart(e){var t=document.getElementById("topCategoryChart");t&&(topCategoryChart&&topCategoryChart.destroy(),topCategoryChart=new Chart(t,{type:"bar",data:{labels:e.map(e=>e[0]),datasets:[{label:"Satış ($ - KDV Hariç)",data:e.map(e=>e[1]),backgroundColor:"rgba(102, 126, 234, 0.8)",borderColor:"rgba(102, 126, 234, 1)",borderWidth:1}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}}))}function renderTopBrandChart(e){var t=document.getElementById("topBrandChart");t&&(topBrandChart&&topBrandChart.destroy(),topBrandChart=new Chart(t,{type:"bar",data:{labels:e.map(e=>e[0]),datasets:[{label:"Satış ($ - KDV Hariç)",data:e.map(e=>e[1]),backgroundColor:"rgba(56, 239, 125, 0.8)",borderColor:"rgba(56, 239, 125, 1)",borderWidth:1}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}}))}function renderTopProductChart(t){var e=document.getElementById("topProductChart");e&&(topProductChart&&topProductChart.destroy(),topProductChart=new Chart(e,{type:"bar",data:{labels:t.map(e=>e[0].substring(0,30)+(30<e[0].length?"...":"")),datasets:[{label:"Satış ($ - KDV Hariç)",data:t.map(e=>e[1]),backgroundColor:"rgba(245, 87, 108, 0.8)",borderColor:"rgba(245, 87, 108, 1)",borderWidth:1}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{title:function(e){return t[e[0].dataIndex][0]}}}},scales:{x:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}}))}function renderTopSalesPersonChart(e){var t=document.getElementById("topSalesPersonChart");t&&(topSalesPersonChart&&topSalesPersonChart.destroy(),topSalesPersonChart=new Chart(t,{type:"bar",data:{labels:e.map(e=>e[0]),datasets:[{label:"Satış ($ - KDV Hariç)",data:e.map(e=>e[1]),backgroundColor:"rgba(240, 147, 251, 0.8)",borderColor:"rgba(240, 147, 251, 1)",borderWidth:1}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}}))}function switchTab(e){console.log("🔄 switchTab çağrıldı:",e);document.querySelectorAll(".tab-content").forEach(e=>{e.classList.remove("active")});var t=document.querySelectorAll(".tab"),a=(t.forEach(e=>{e.classList.remove("active")}),document.getElementById(e+"Tab")),a=(console.log("🔍 Aranan tab ID:",e+"Tab","| Bulundu mu?",a?"EVET":"HAYIR"),a?(a.classList.add("active"),console.log("✅ Tab aktif edildi:",e+"Tab")):console.error("❌ Tab bulunamadı:",e+"Tab"),{dashboard:0,targets:1,customers:2,salesperson:3,store:4,city:5,stock:6,time:7,product:8});void 0!==a[e]&&t[a[e]].classList.add("active"),"dashboard"===e?loadDashboard():"targets"===e?loadAllStoresTargets():"customers"===e?analyzeCustomers():"time"===e?analyzeTime():"city"===e?(console.log("🌍 Şehir analizi sekmesi açılıyor..."),console.log("📊 allData durumu:",allData?allData.length+" kayıt":"Henüz yüklenmedi"),allData&&0<allData.length?populateCitySelect():(console.warn("⚠️ Veriler henüz yüklenmedi, şehir listesi doldurulamıyor"),setTimeout(()=>{allData&&0<allData.length&&(console.log("🔄 Veri yüklendi, şehir listesi yeniden dolduruluyor..."),populateCitySelect())},2e3))):"stock"===e&&(console.log("📦 Stok dağılım sekmesi açılıyor..."),inventoryData?console.log("✅ Envanter verileri zaten yüklü"):(console.log("🔄 Envanter verileri lazy loading ile yükleniyor..."),loadInventoryData()))}function exportToExcel(){var e,t;0===filteredData.length?alert("⚠️ Dışa aktarılacak veri yok!"):(console.log("📥 Excel export başlatılıyor..."),t=filteredData.map(e=>({"İş Ortağı":e.partner||"","Ürün":e.product||"",Marka:e.brand||"","Kategori 1":e.category_2||"","Kategori 2":e.category_3||"","Kategori 3":e.category_4||"","Satış Temsilcisi":e.sales_person||"","Mağaza":e.store||"","Şehir":e.city||"",Tarih:e.date||"",Miktar:parseFloat(e.quantity||0),"USD (KDV Hariç)":parseFloat(e.usd_amount||0)})),e={"İş Ortağı":"TOPLAM","Ürün":"",Marka:"","Kategori 1":"","Kategori 2":"","Kategori 3":"","Satış Temsilcisi":"","Mağaza":"","Şehir":"",Tarih:"",Miktar:filteredData.reduce((e,t)=>e+parseFloat(t.quantity||0),0),"USD (KDV Hariç)":filteredData.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0)},t.push(e),e=XLSX.utils.book_new(),(t=XLSX.utils.json_to_sheet(t))["!cols"]=[{wch:30},{wch:40},{wch:15},{wch:20},{wch:20},{wch:20},{wch:20},{wch:30},{wch:15},{wch:12},{wch:12},{wch:18}],XLSX.utils.book_append_sheet(e,t,"Satış Verileri"),t=`Satis_Analizi_${(new Date).toISOString().split("T")[0]}.xlsx`,XLSX.writeFile(e,t),console.log("✅ Excel dosyası indirildi: "+t),alert(`✅ ${filteredData.length} kayıt Excel'e aktarıldı!
Dosya: `+t))}let recognition=null,isListening=!1;function startVoiceSearch(){if("webkitSpeechRecognition"in window||"SpeechRecognition"in window){var t=window.SpeechRecognition||window.webkitSpeechRecognition;if(isListening)recognition&&recognition.stop();else{(recognition=new t).lang="tr-TR",recognition.continuous=!1,recognition.interimResults=!1;let e=document.getElementById("voiceBtn");recognition.onstart=()=>{isListening=!0,e.classList.add("listening"),e.textContent="🎙️",console.log("🎤 Dinleniyor...")},recognition.onresult=e=>{e=e.results[0][0].transcript;console.log("🗣️ Algılanan:",e),document.getElementById("smartSearch").value=e,applySmartSearch()},recognition.onerror=e=>{console.error("❌ Ses tanıma hatası:",e.error),"no-speech"===e.error?alert("⚠️ Ses algılanamadı. Lütfen tekrar deneyin."):"not-allowed"===e.error&&alert("⚠️ Mikrofon izni verilmedi. Lütfen tarayıcı ayarlarından mikrofon izni verin.")},recognition.onend=()=>{isListening=!1,e.classList.remove("listening"),e.textContent="🎤",console.log("🎤 Dinleme bitti")},recognition.start()}}else alert("⚠️ Tarayıcınız ses tanıma özelliğini desteklemiyor!\nChrome veya Edge kullanın.")}let targetChart=null;function saveYearlyTarget(){var a=document.getElementById("targetYear").value,r=document.getElementById("targetYearStore").value,n=parseFloat(document.getElementById("yearlyTarget").value)||0;if(console.log("💾 saveYearlyTarget çağrıldı:",{year:a,store:r,target:n}),n<=0)alert("⚠️ Lütfen geçerli bir hedef girin!");else{let e=JSON.parse(localStorage.getItem("yearlyTargets")||"{}"),t=(console.log("📂 Mevcut localStorage:",e),!1);for(var[o,i]of Object.entries(e))if("number"==typeof i){t=!0,console.warn("⚠️ Eski localStorage formatı tespit edildi! Otomatik temizleniyor...");break}if(t){var l,s,d={};for([l,s]of Object.entries(e))"number"==typeof s?(d[l]={"TÜM MAĞAZALAR":s},console.log(`🔄 ${l} yılı formatı güncellendi:`,s,"→",d[l])):d[l]=s;e=d,localStorage.setItem("yearlyTargets",JSON.stringify(e)),console.log("✅ Eski format temizlendi ve yeni formata dönüştürüldü!")}e[a]||(e[a]={}),e[a][r]=n,localStorage.setItem("yearlyTargets",JSON.stringify(e)),console.log("✅ localStorage'a kaydedildi:",e),console.log("🔍 Kontrol: localStorage.getItem:",localStorage.getItem("yearlyTargets")),calculateTargets(),alert(`✅ ${a} yılı ${"TÜM MAĞAZALAR"===r?"Tüm Mağazalar":r} hedefi kaydedildi: $`+n.toLocaleString("tr-TR",{minimumFractionDigits:2}))}}function loadAllStoresTargets(){let d=document.getElementById("targetFilterYear").value,c=document.getElementById("targetFilterMonth").value||"";var e=document.getElementById("allStoresTargetsContainer");console.log("📊 Tüm mağazalar hedef listesi yükleniyor:",{year:d,month:c,monthType:typeof c,monthLength:c.length});let t=new Set;allData.forEach(e=>{e.store&&"Analitik"!==e.store&&!e.store.toLowerCase().includes("eğitim")&&t.add(e.store)});var a=Array.from(t).sort().map(t=>{var e=t.replace(/^\[\d+\]\s*/,"");let a=0;function r(e,t){if(e){if(e[t])return t;var a,r=t.toLowerCase();for(a of Object.keys(e)){var n=a.toLowerCase();if(n.includes(r)||r.includes(n))return a}}return null}c?0===(a=centralTargets.monthly&&centralTargets.monthly[d]&&(o=r(centralTargets.monthly[d],e))&&centralTargets.monthly[d][o]&&centralTargets.monthly[d][o][c]?centralTargets.monthly[d][o][c]:a)&&(o=JSON.parse(localStorage.getItem("monthlyTargets")||"{}"))[d]&&(n=r(o[d],e))&&o[d][n][c]&&(a=o[d][n][c]):0===(a=centralTargets.yearly&&centralTargets.yearly[d]&&(o=r(centralTargets.yearly[d],e))?centralTargets.yearly[d][o]:a)&&(n=JSON.parse(localStorage.getItem("yearlyTargets")||"{}"))[d]&&(o=r(n[d],e))&&(a=n[d][o]);var e=allData.filter(e=>e.store===t&&!!e.date&&(c?e.date.startsWith(d+"-"+c):e.date.startsWith(d))).reduce((e,t)=>e+parseFloat(t.usd_amount||0),0),n=0<a?e/a*100:0,o=a-e,i=new Date;let l=0;var s=0<(l=c?(s=new Date(d,parseInt(c),0),Math.max(0,Math.ceil((s-i)/864e5))):(s=new Date(d,11,31),Math.max(0,Math.ceil((s-i)/864e5))))?o/l:0;return{name:t,target:a,achieved:e,percentage:n,remaining:o,daysLeft:l,dailyRequired:s}}),r=a.filter(e=>0<e.target),n=a.filter(e=>0===e.target),o=(r.sort((e,t)=>t.percentage-e.percentage),n.sort((e,t)=>e.name.localeCompare(t.name,"tr")),[...r,...n]);console.log(`📊 Toplam ${a.length} mağaza, ${r.length} hedefli, ${n.length} hedefsiz`);let i='<div style="margin-bottom: 20px; text-align: center;">';i=(i=(i=(i+='<h3 style="margin: 0; font-size: 1.5em;">')+(c?d+" - "+["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"][parseInt(c)-1]+" Dönemi":d+" Yılı")+" Mağaza Hedef Durumları</h3>")+'<p style="color: #6c757d; margin-top: 5px;">Toplam '+o.length+" mağaza</p>")+'</div><div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 20px;">',o.forEach(t=>{if(0===t.target)i=(i=(i=(i=(i+='<div class="storeCard" style="background: linear-gradient(135deg, #6c757d 0%, #495057 100%); border-radius: 15px; padding: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.15); color: white; opacity: 0.7;">')+'<h3 style="margin: 0 0 15px 0; font-size: 1.5em; color: white;">'+t.name+"</h3>")+'<div style="text-align: center; padding: 40px 0;"><div style="font-size: 3em; margin-bottom: 10px;">📊</div>')+'<div style="font-size: 1.1em; opacity: 0.9; margin-bottom: 10px;">Hedef Tanımlanmamış</div><div style="font-size: 1.3em; font-weight: 600; margin-top: 15px;">')+"Gerçekleşme: $"+t.achieved.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2})+"</div></div></div>";else{var a,r,n=130<=(n=t.percentage)?"#10b981":100<=n?"#22c55e":85<=n?"#f59e0b":"#ef4444";let e="";e=130<=t.percentage?(e=(e=(e=(e=(e=(e=(e=(e=(e='<div style="text-align: center; margin-bottom: 20px;">')+'<div style="font-size: 3em; font-weight: bold; margin-bottom: 5px;">'+t.percentage.toFixed(1)+'%</div><div style="font-size: 0.9em; opacity: 0.9;">Gerçekleşme</div>')+'</div><div style="text-align: center; font-size: 1.8em; margin: 20px 0;">🏆 Tüm Hedefler Tamamlandı!</div>')+'<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-top: 15px;"><div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">📊 Gerçekleşen</div>')+'<div style="font-size: 1.5em; font-weight: bold;">$'+t.achieved.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2})+"</div>")+'</div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px; font-size: 0.9em;">')+'<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px;"><div style="opacity: 0.9; margin-bottom: 3px;">🎯 %100 Hedef</div>')+'<div style="font-weight: bold;">$'+t.target.toLocaleString("tr-TR",{minimumFractionDigits:2})+"</div></div>")+'<div style="background: rgba(255,255,255,0.15); padding: 10px; border-radius: 8px;"><div style="opacity: 0.9; margin-bottom: 3px;">🏆 %130 Hedef</div>')+'<div style="font-weight: bold;">$'+(1.3*t.target).toLocaleString("tr-TR",{minimumFractionDigits:2})+"</div></div></div>":100<=t.percentage?(a=1.3*t.target-t.achieved,r=0<t.daysLeft?a/t.daysLeft:0,(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e=(e='<div style="text-align: center; margin-bottom: 20px;">')+'<div style="font-size: 3em; font-weight: bold; margin-bottom: 5px;">'+t.percentage.toFixed(1)+'%</div><div style="font-size: 0.9em; opacity: 0.9;">Gerçekleşme</div>')+'</div><div style="text-align: center; font-size: 1.5em; margin: 15px 0; font-weight: bold;">✅ Hedef Gerçekleşti!</div>')+'<div style="font-size: 0.95em; opacity: 0.95; margin-top: 15px; padding: 15px; background: rgba(255,255,255,0.15); border-radius: 10px;"><div style="margin-bottom: 8px;">🎯 <strong>%130 Hedefi için:</strong></div>')+'<div style="margin-bottom: 5px;">📊 Gerçekleşen: <strong>$'+t.achieved.toLocaleString("tr-TR",{minimumFractionDigits:2})+"</strong></div>")+'<div style="margin-bottom: 5px;">📈 Kalan: <strong>$'+a.toLocaleString("tr-TR",{minimumFractionDigits:2})+"</strong></div>")+'<div style="margin-bottom: 5px;">📅 Kalan Gün: <strong>'+t.daysLeft+"</strong></div>")+"<div>💰 Günlük Gerekli: <strong>$"+r.toLocaleString("tr-TR",{minimumFractionDigits:2})+"</strong></div>")+'</div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 15px;">')+'<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;"><div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">🎯 %100 Hedef</div>')+'<div style="font-size: 1.1em; font-weight: bold;">$'+t.target.toLocaleString("tr-TR",{minimumFractionDigits:2})+"</div></div>")+'<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;"><div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">🏆 %130 Hedef</div>')+'<div style="font-size: 1.1em; font-weight: bold;">$'+(1.3*t.target).toLocaleString("tr-TR",{minimumFractionDigits:2})+"</div></div></div>"):(e='<div style="text-align: center; margin-bottom: 20px;">',(e=(e=(e=(e=(e=(e=(e=(e+='<div style="font-size: 3em; font-weight: bold; margin-bottom: 5px;">'+t.percentage.toFixed(1)+"%</div>")+'<div style="font-size: 0.9em; opacity: 0.9;">Gerçekleşme</div></div>')+'<div style="background: rgba(255,255,255,0.2); padding: 15px; border-radius: 10px; margin-bottom: 15px; text-align: left;"><div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">📊 Gerçekleşen</div>')+'<div style="font-size: 1.6em; font-weight: bold;">$'+t.achieved.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2})+"</div>")+'</div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">')+'<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;"><div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">🎯 %100 Hedef</div>')+'<div style="font-size: 1.1em; font-weight: bold;">$'+t.target.toLocaleString("tr-TR",{minimumFractionDigits:2})+"</div></div>")+'<div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 10px;"><div style="font-size: 0.85em; opacity: 0.9; margin-bottom: 5px;">🏆 %130 Hedef</div>')+'<div style="font-size: 1.1em; font-weight: bold;">$'+(1.3*t.target).toLocaleString("tr-TR",{minimumFractionDigits:2})+"</div></div></div>"),i=(i=(i+='<div style="background: '+n+'; color: white; padding: 25px; border-radius: 15px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);">')+('<h3 style="margin: 0 0 20px 0; font-size: 1.3em; border-bottom: 2px solid rgba(255,255,255,0.3); padding-bottom: 10px;">🏪 '+t.name+"</h3>"))+e+"</div>"}}),i+="</div>",0===o.length&&(i=`
                    <div style="text-align: center; padding: 60px; background: #f8f9fa; border-radius: 15px;">
                        <div style="font-size: 4em; margin-bottom: 20px;">📊</div>
                        <h3 style="color: #6c757d; margin-bottom: 10px;">Hedef Bulunamadı</h3>
                        <p style="color: #adb5bd;">Seçili dönem için hiçbir mağazaya hedef tanımlanmamış</p>
                    </div>
                `),console.log(`📊 HTML oluşturuldu, container bulundu: ${!!e}, HTML uzunluğu: `+i.length),console.log("📊 HTML başlangıcı:",i.substring(0,200));try{e.innerHTML=i,console.log("✅ HTML container'a yazıldı!")}catch(e){console.error("❌ HTML yazma hatası:",e),console.log("❌ Hatalı HTML:",i.substring(0,500))}}function loadYearlyTarget(){var t=document.getElementById("targetYear"),a=document.getElementById("targetYearStore");if(t&&a){var t=t.value,a=a.value,r=a.replace(/\[.*?\]\s*/g,"").replace(/^.*?\s-\s/,"").trim();let e=null;e||(n=JSON.parse(localStorage.getItem("yearlyTargets")||"{}")[t]||{},e=n[a]);var n={[a]:e},t=(console.log("📊 loadYearlyTarget çağrıldı:",{year:t,store:a,cleanStoreName:r,yearlyTarget:e}),document.getElementById("yearlyTarget"));t.value="",n[a]?(t.value=n[a],console.log("✅ Yıllık hedef yüklendi (Google Sheets):",n[a])):console.log("⚠️ Bu mağaza için kaydedilmiş hedef yok"),calculateTargets()}else console.log("ℹ️ Eski hedef sistemi elementleri bulunamadı, yeni sistem kullanılıyor")}function saveMonthlyTarget(){var e,t=document.getElementById("targetYear").value,a=document.getElementById("targetMonth").value,r=document.getElementById("targetMonthStore").value,n=parseFloat(document.getElementById("monthlyTarget").value)||0;console.log("💾 saveMonthlyTarget çağrıldı:",{year:t,month:a,store:r,target:n}),n<=0?alert("⚠️ Lütfen geçerli bir hedef girin!"):(e=JSON.parse(localStorage.getItem("monthlyTargets")||"{}"),console.log("📂 Mevcut aylık localStorage:",e),e[t]||(e[t]={}),e[t][r]||(e[t][r]={}),e[t][r][a]=n,localStorage.setItem("monthlyTargets",JSON.stringify(e)),console.log("✅ Aylık localStorage'a kaydedildi:",e),calculateTargets(),alert(`✅ ${t} ${{"01":"Ocak","02":"Şubat","03":"Mart","04":"Nisan","05":"Mayıs","06":"Haziran","07":"Temmuz","08":"Ağustos","09":"Eylül",10:"Ekim",11:"Kasım",12:"Aralık"}[a]} ${"TÜM MAĞAZALAR"===r?"Tüm Mağazalar":r} hedefi kaydedildi: $`+n.toLocaleString("tr-TR",{minimumFractionDigits:2})))}function loadMonthlyTarget(){var e,t,a=document.getElementById("targetYear"),r=document.getElementById("targetMonth"),n=document.getElementById("targetMonthStore");a&&r&&n?(a=a.value,r=r.value,(n=n.value).replace(/\[.*?\]\s*/g,"").replace(/^.*?\s-\s/,"").trim(),t=e=JSON.parse(localStorage.getItem("monthlyTargets")||"{}")[a]?.[n]?.[r],console.log("📊 loadMonthlyTarget çağrıldı:",{year:a,month:r,store:n,localTarget:e}),(a=document.getElementById("monthlyTarget")).value="",t?(a.value=t,console.log("✅ Aylık hedef yüklendi (localStorage):",t)):console.log("⚠️ Bu mağaza ve ay için kaydedilmiş hedef yok"),calculateTargets()):console.log("ℹ️ Eski hedef sistemi elementleri bulunamadı, yeni sistem kullanılıyor")}function calculateTargets(){populateTargetStoreDropdowns();let a=document.getElementById("targetYear").value,r=document.getElementById("targetMonth").value,n=document.getElementById("targetYearStore").value,o=document.getElementById("targetMonthStore").value;var e=parseFloat(document.getElementById("yearlyTarget").value)||0,t=parseFloat(document.getElementById("monthlyTarget").value)||0,i=allData.filter(e=>{var t;return!!e.date&&(t=e.date.startsWith(a),e="TÜM MAĞAZALAR"===n||e.store===n,t)&&e}).reduce((e,t)=>e+parseFloat(t.usd_amount||0),0);0<e?(l=Math.max(0,e-i),e=i/e*100,d=new Date,s=new Date(a,11,31),d=0<(s=Math.max(0,Math.ceil((s-d)/864e5)))?l/s:0,document.getElementById("yearlyProgress").style.width=Math.min(100,e)+"%",document.getElementById("yearlyProgress").textContent=e.toFixed(1)+"%",document.getElementById("yearlyAchieved").textContent="$"+i.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("yearlyRemaining").textContent="$"+l.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("yearlyDaysLeft").textContent=s,document.getElementById("yearlyDailyRequired").textContent="$"+d.toLocaleString("tr-TR",{minimumFractionDigits:2})):(document.getElementById("yearlyProgress").style.width="0%",document.getElementById("yearlyProgress").textContent="0%",document.getElementById("yearlyAchieved").textContent="$"+i.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("yearlyRemaining").textContent="$0,00",document.getElementById("yearlyDaysLeft").textContent="-",document.getElementById("yearlyDailyRequired").textContent="$0,00");var l,s,d,e=allData.filter(e=>{var t;return!!e.date&&(t=(t=e.date.split("-"))[0]===a&&t[1]===r,e="TÜM MAĞAZALAR"===o||e.store===o,t)&&e}).reduce((e,t)=>e+parseFloat(t.usd_amount||0),0);0<t?(l=Math.max(0,t-e),s=e/t*100,d=new Date,i=new Date(a,parseInt(r),0),i=0<(t=Math.max(0,Math.ceil((i-d)/864e5)))?l/t:0,document.getElementById("monthlyProgress").style.width=Math.min(100,s)+"%",document.getElementById("monthlyProgress").textContent=s.toFixed(1)+"%",document.getElementById("monthlyAchieved").textContent="$"+e.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("monthlyRemaining").textContent="$"+l.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("monthlyDaysLeft").textContent=t,document.getElementById("monthlyDailyRequired").textContent="$"+i.toLocaleString("tr-TR",{minimumFractionDigits:2})):(document.getElementById("monthlyProgress").style.width="0%",document.getElementById("monthlyProgress").textContent="0%",document.getElementById("monthlyAchieved").textContent="$"+e.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("monthlyRemaining").textContent="$0,00",document.getElementById("monthlyDaysLeft").textContent="-",document.getElementById("monthlyDailyRequired").textContent="$0,00"),renderTargetChart()}function renderTargetChart(){var e=document.getElementById("targetChart");if(e){var t=["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];let r=document.getElementById("targetYear").value,n=document.getElementById("targetYearStore").value;var a=t.map((e,t)=>{let a=String(t+1).padStart(2,"0");return allData.filter(e=>{var t;return!!e.date&&(t=(t=e.date.split("-"))[0]===r&&t[1]===a,e="TÜM MAĞAZALAR"===n||e.store===n,t)&&e}).reduce((e,t)=>e+parseFloat(t.usd_amount||0),0)});targetChart&&targetChart.destroy(),targetChart=new Chart(e,{type:"bar",data:{labels:t,datasets:[{label:"Aylık Satış (USD)",data:a,backgroundColor:"rgba(102, 126, 234, 0.8)",borderColor:"rgba(102, 126, 234, 1)",borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"},title:{display:!0,text:r+" Yılı Aylık Satış Performansı "+("TÜM MAĞAZALAR"!==n?"("+n+")":""),font:{size:16,weight:"bold"}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}})}}let customerCityChart=null,customerTrendChart=null;function analyzeCustomers(){let a={};var e=new Date;let t=new Date(e.getTime()-7776e6);allData.forEach(e=>{var t=e.partner;t&&(a[t]||(a[t]={name:t,totalSales:0,orderCount:0,city:e.city||"Bilinmiyor",lastOrderDate:e.date||""}),a[t].totalSales+=parseFloat(e.usd_amount||0),a[t].orderCount+=1,e.date)&&e.date>a[t].lastOrderDate&&(a[t].lastOrderDate=e.date)});var e=Object.values(a).sort((e,t)=>t.totalSales-e.totalSales),r=e.length,n=e.filter(e=>!!e.lastOrderDate&&new Date(e.lastOrderDate)>=t).length,o=e.reduce((e,t)=>e+t.totalSales,0)/r,i=0<e.length?e[0].totalSales:0;document.getElementById("totalCustomers").textContent=r.toLocaleString("tr-TR"),document.getElementById("activeCustomers").textContent=n.toLocaleString("tr-TR"),document.getElementById("avgOrderValue").textContent="$"+o.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("maxOrderValue").textContent="$"+i.toLocaleString("tr-TR",{minimumFractionDigits:2}),renderTopCustomers(e.slice(0,30)),renderCustomerCityChart(e),renderCustomerTrendChart()}function renderTopCustomers(e){let r=document.getElementById("topCustomersGrid");r.innerHTML="",e.forEach((e,t)=>{var a=document.createElement("div");a.className="customer-card",a.innerHTML=`
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <span class="customer-rank">${t+1}</span>
                        <div style="flex: 1;">
                            <h4 style="margin: 0; font-size: 1.1em;">${e.name}</h4>
                            <p style="margin: 5px 0 0 0; color: #6c757d; font-size: 0.9em;">📍 ${e.city}</p>
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                            <p style="margin: 0; font-size: 0.85em; color: #6c757d;">Toplam Satış</p>
                            <p style="margin: 5px 0 0 0; font-size: 1.2em; font-weight: 700; color: #667eea;">$${e.totalSales.toLocaleString("tr-TR",{minimumFractionDigits:2})}</p>
                        </div>
                        <div style="background: #f8f9fa; padding: 10px; border-radius: 8px;">
                            <p style="margin: 0; font-size: 0.85em; color: #6c757d;">Sipariş Sayısı</p>
                            <p style="margin: 5px 0 0 0; font-size: 1.2em; font-weight: 700; color: #764ba2;">${e.orderCount}</p>
                        </div>
                    </div>
                `,r.appendChild(a)})}function renderCustomerCityChart(e){var a=document.getElementById("customerCityChart");if(a){let t={};e.forEach(e=>{e=e.city||"Bilinmiyor";t[e]=(t[e]||0)+1});e=Object.entries(t).sort((e,t)=>t[1]-e[1]).slice(0,10);customerCityChart&&customerCityChart.destroy(),customerCityChart=new Chart(a,{type:"doughnut",data:{labels:e.map(e=>e[0]),datasets:[{data:e.map(e=>e[1]),backgroundColor:["rgba(102, 126, 234, 0.8)","rgba(118, 75, 162, 0.8)","rgba(255, 99, 132, 0.8)","rgba(54, 162, 235, 0.8)","rgba(255, 206, 86, 0.8)","rgba(75, 192, 192, 0.8)","rgba(153, 102, 255, 0.8)","rgba(255, 159, 64, 0.8)","rgba(199, 199, 199, 0.8)","rgba(83, 102, 255, 0.8)"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"right"},datalabels:{color:"#fff",font:{weight:"bold",size:14},formatter:(e,t)=>(100*e/t.chart.data.datasets[0].data.reduce((e,t)=>e+t,0)).toFixed(1)+"%"}}},plugins:[ChartDataLabels]})}}function renderCustomerTrendChart(){var e=document.getElementById("customerTrendChart");if(e){console.log("📊 Yıllık Müşteri Trendi oluşturuluyor...");let a={},r=new Set;allData.forEach(e=>{var t;e.date&&e.partner&&(t=e.date.substring(0,4),r.add(t),a[t]||(a[t]=new Set),a[t].add(e.partner))});var t=Array.from(r).sort(),o=t.map(e=>a[e].size);console.log("📊 Yıllar:",t),console.log("📊 Müşteri sayıları:",o),customerTrendChart&&customerTrendChart.destroy();let n=["rgba(102, 126, 234, 0.8)","rgba(250, 112, 154, 0.8)","rgba(56, 239, 125, 0.8)","rgba(255, 193, 7, 0.8)","rgba(245, 87, 108, 0.8)","rgba(72, 219, 251, 0.8)"];customerTrendChart=new Chart(e,{type:"bar",data:{labels:t,datasets:[{label:"Aktif Müşteri Sayısı",data:o,backgroundColor:t.map((e,t)=>n[t%n.length]),borderColor:t.map((e,t)=>n[t%n.length].replace("0.8","1")),borderWidth:2,borderRadius:10,barThickness:60}]},options:{responsive:!0,maintainAspectRatio:!0,aspectRatio:3,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){return"Müşteri: "+e.parsed.y.toLocaleString("tr-TR")}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return e.toLocaleString("tr-TR")}}}},animation:{duration:1e3,easing:"easeInOutQuart"}},plugins:[ChartDataLabels]}),console.log("✅ Yıllık Müşteri Trendi grafiği oluşturuldu")}}function performAIAnalysis(){console.log("🤖 AI Analiz başlatılıyor...");var e,t=document.getElementById("aiAnalysisPanel");t&&0!==filteredData.length&&(e=generateInsights(analyzeData(filteredData)),e=`
                <div class="analysis-panel">
                    <h2 style="margin: 0 0 20px 0; font-size: 2em;">🤖 AI Analiz & Öneriler</h2>
                    <p style="opacity: 0.9; margin-bottom: 20px;">Filtrelenen ${filteredData.length.toLocaleString("tr-TR")} kayıt üzerinden yapılan akıllı analiz sonuçları</p>
                    
                    ${0<e.positive.length?`
                    <div class="analysis-section">
                        <h3>✅ Olumlu Tespitler</h3>
                        ${e.positive.map(e=>`
                            <div class="insight-item insight-positive">
                                <span class="insight-icon">✅</span>
                                <strong>${e.title}</strong><br>
                                ${e.description}
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    ${0<e.negative.length?`
                    <div class="analysis-section">
                        <h3>⚠️ Dikkat Edilmesi Gerekenler</h3>
                        ${e.negative.map(e=>`
                            <div class="insight-item insight-negative">
                                <span class="insight-icon">⚠️</span>
                                <strong>${e.title}</strong><br>
                                ${e.description}
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    ${0<e.neutral.length?`
                    <div class="analysis-section">
                        <h3>💡 Önemli Bilgiler</h3>
                        ${e.neutral.map(e=>`
                            <div class="insight-item insight-neutral">
                                <span class="insight-icon">💡</span>
                                <strong>${e.title}</strong><br>
                                ${e.description}
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    <div class="analysis-section">
                        <h3>🎯 Aksiyon Önerileri</h3>
                        ${e.recommendations.map(e=>`
                            <div class="recommendation">
                                <span class="recommendation-icon">${e.icon}</span>
                                <div>
                                    <strong style="font-size: 1.1em;">${e.title}</strong><br>
                                    <p style="margin: 10px 0 0 0; opacity: 0.95;">${e.description}</p>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                </div>
            `,t.innerHTML=e,t.style.display="block")}function analyzeData(e){var t=e.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0),a=e.reduce((e,t)=>e+parseFloat(t.quantity||0),0),r=t/e.length;let n={},o=(e.forEach(e=>{var t=e.store||"Bilinmiyor";n[t]||(n[t]={sales:0,count:0,qty:0}),n[t].sales+=parseFloat(e.usd_amount||0),n[t].count+=1,n[t].qty+=parseFloat(e.quantity||0)}),{}),i=(e.forEach(e=>{var t=e.brand||"Bilinmiyor";o[t]||(o[t]={sales:0,count:0}),o[t].sales+=parseFloat(e.usd_amount||0),o[t].count+=1}),{}),l=(e.forEach(e=>{var t=e.category_1||"Bilinmiyor";i[t]||(i[t]={sales:0,count:0}),i[t].sales+=parseFloat(e.usd_amount||0),i[t].count+=1}),{}),s=(e.forEach(e=>{var t=e.partner||"Bilinmiyor";l[t]||(l[t]={sales:0,count:0}),l[t].sales+=parseFloat(e.usd_amount||0),l[t].count+=1}),{}),d=(e.forEach(e=>{var t=e.sales_person||"Bilinmiyor";s[t]||(s[t]={sales:0,count:0}),s[t].sales+=parseFloat(e.usd_amount||0),s[t].count+=1}),{});e.forEach(e=>{var t;e.date&&(t=e.date.substring(0,7),d[t]||(d[t]={sales:0,count:0}),d[t].sales+=parseFloat(e.usd_amount||0),d[t].count+=1)});var c=Object.entries(n).sort((e,t)=>t[1].sales-e[1].sales),m=Object.entries(o).sort((e,t)=>t[1].sales-e[1].sales),g=Object.entries(i).sort((e,t)=>t[1].sales-e[1].sales),u=Object.entries(l).sort((e,t)=>t[1].sales-e[1].sales),p=Object.entries(s).sort((e,t)=>t[1].sales-e[1].sales);return{totalUSD:t,totalQty:a,avgOrderValue:r,recordCount:e.length,storeData:n,brandData:o,categoryData:i,customerData:l,salesPersonData:s,dateData:d,topStores:c,topBrands:m,topCategories:g,topCustomers:u,topSalesPersons:p}}function generateInsights(r){var e,t,a={positive:[],negative:[],neutral:[],recommendations:[]},n=(0<r.topStores.length&&30<(e=((t=r.topStores[0])[1].sales/r.totalUSD*100).toFixed(1))&&a.positive.push({title:"En Başarılı Mağaza: "+t[0],description:`<span class="metric-highlight">$${t[1].sales.toLocaleString("tr-TR",{minimumFractionDigits:2})}</span> satış ile toplam satışların <span class="metric-highlight">%${e}</span>'ini gerçekleştirmiş. Mükemmel performans! 🎉`}),0<r.topBrands.length&&(t=r.topBrands[0],a.positive.push({title:"En Çok Satan Marka: "+t[0],description:`<span class="metric-highlight">${t[1].count}</span> adet satış ile lider marka. Stok yönetimine dikkat edin.`})),100<r.avgOrderValue&&a.positive.push({title:"Yüksek Ortalama Sipariş Değeri",description:`Ortalama sipariş değeri <span class="metric-highlight">$${r.avgOrderValue.toLocaleString("tr-TR",{minimumFractionDigits:2})}</span>. Müşteriler yüksek değerli ürünleri tercih ediyor.`}),1<r.topStores.length&&(e=r.topStores[0],t=r.topStores[1],50<(n=((e[1].sales-t[1].sales)/e[1].sales*100).toFixed(1)))&&a.negative.push({title:"Mağazalar Arası Dengesizlik",description:`${e[0]} ile ${t[0]} arasında <span class="metric-highlight">%${n}</span> fark var. Düşük performanslı mağazalara destek gerekebilir.`}),0<r.topCustomers.length&&20<(t=((e=r.topCustomers[0])[1].sales/r.totalUSD*100).toFixed(1))&&a.negative.push({title:"Tek Müşteriye Bağımlılık Riski",description:e[0]+` toplam satışların <span class="metric-highlight">%${t}</span>'ini oluşturuyor. Müşteri portföyünü çeşitlendirmeyi düşünün.`}),r.recordCount<10&&a.negative.push({title:"Düşük Veri Hacmi",description:`Sadece <span class="metric-highlight">${r.recordCount}</span> kayıt analiz edildi. Daha geniş tarih aralığı seçerek daha sağlıklı analiz yapabilirsiniz.`}),r.topCategories.filter(e=>!e[0].toLowerCase().includes("all")&&!e[0].toLowerCase().includes("analitik")&&!e[0].toLowerCase().includes("eğitim")).slice(0,5)),n=(0<n.length&&(e=n.map((e,t)=>{var a=(e[1].sales/r.totalUSD*100).toFixed(1);return`${t+1}. <strong>${e[0]}</strong>: <span class="metric-highlight">${e[1].count}</span> adet, <span class="metric-highlight">%${a}</span>`}).join("<br>"),a.neutral.push({title:"🎸 En Popüler Kategoriler (İlk 5)",description:e})),0<r.topSalesPersons.length&&(t=r.topSalesPersons.slice(0,5).map((e,t)=>{var a=(e[1].sales/r.totalUSD*100).toFixed(1);return`${t+1}. <strong>${e[0]}</strong>: <span class="metric-highlight">$${e[1].sales.toLocaleString("tr-TR",{minimumFractionDigits:2})}</span> (<span class="metric-highlight">%${a}</span>)`}).join("<br>"),a.neutral.push({title:"👤 En Başarılı Satış Temsilcileri (İlk 5)",description:t})),Object.keys(r.customerData).length);return a.neutral.push({title:"Müşteri Çeşitliliği",description:`<span class="metric-highlight">${n}</span> farklı müşteri ile işlem yapılmış.`}),a.recommendations.push({icon:"🎯",title:"Hedef Belirleme",description:`Mevcut performans: <span class="metric-highlight">$${r.totalUSD.toLocaleString("tr-TR",{minimumFractionDigits:2})}</span>. "Hedef Takip" sekmesinden aylık/yıllık hedeflerinizi belirleyin ve ilerlemenizi takip edin.`}),1<r.topStores.length&&(e=r.topStores.slice(-2),a.recommendations.push({icon:"📈",title:"Düşük Performanslı Mağazalara Odaklanın",description:e.map(e=>e[0]).join(" ve ")+" mağazalarının performansını artırmak için özel kampanyalar düzenleyin."})),0<r.topBrands.length&&(t=r.topBrands.slice(0,5).map((e,t)=>{var a=(e[1].sales/r.totalUSD*100).toFixed(1);return`${t+1}. <strong>${e[0]}</strong>: <span class="metric-highlight">${e[1].count}</span> adet, <span class="metric-highlight">%${a}</span>`}).join("<br>"),a.recommendations.push({icon:"🏷️",title:"Stok Optimizasyonu - En Çok Satan Markalar (İlk 5)",description:t+"<br><br>Bu markaların stok seviyelerini yakından takip edin."})),a.recommendations.push({icon:"👥",title:"Müşteri İlişkileri",description:'"Müşteri Analizi" sekmesinden top müşterilerinizi inceleyin ve özel teklifler sunarak sadakati artırın.'}),r.avgOrderValue<50&&a.recommendations.push({icon:"💰",title:"Ortalama Sipariş Değerini Artırın",description:`Mevcut ortalama: <span class="metric-highlight">$${r.avgOrderValue.toFixed(2)}</span>. Cross-selling ve up-selling stratejileri uygulayın.`}),a.recommendations.push({icon:"📊",title:"Düzenli Raporlama",description:`"Excel'e Aktar" özelliğini kullanarak haftalık/aylık raporlar oluşturun ve trendleri takip edin.`}),a}let dashYearlyChartInstance=null,dashTopStoresChartInstance=null,dashTopSalespeopleChartInstance=null,dashTopBrandsChartInstance=null,dashTopCategoriesChartInstance=null,dashTopCitiesChartInstance=null,dashTopProductsChartInstance=null;function loadDashboard(){var e,t,a,r,n,o,i,l,s;console.log("🏠 Dashboard yükleniyor..."),allData&&0!==allData.length?(e=allData.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0),t=allData.reduce((e,t)=>e+parseFloat(t.quantity||0),0),a=new Set(allData.map(e=>e.partner).filter(Boolean)).size,r=new Set(allData.map(e=>e.product).filter(Boolean)).size,n=new Set(allData.map(e=>e.store).filter(Boolean)).size,o=new Set(allData.map(e=>e.sales_person).filter(Boolean)).size,l=0<(i=new Set(allData.map(e=>e.date).filter(Boolean)).size)?e/i:0,s=0<allData.length?e/allData.length:0,console.log("📅 Benzersiz Gün Sayısı (Tüm Zamanlar):",i),console.log("💰 Toplam Satış:",e.toLocaleString("tr-TR",{minimumFractionDigits:2})),console.log("📦 Toplam Kayıt:",allData.length.toLocaleString("tr-TR")),console.log("📊 Günlük Ortalama:",l.toLocaleString("tr-TR",{minimumFractionDigits:2})),console.log("🛒 Sepet Ortalaması:",s.toLocaleString("tr-TR",{minimumFractionDigits:2})),document.getElementById("dashTotalSales").textContent="$"+e.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("dashTotalQty").textContent=t.toLocaleString("tr-TR",{minimumFractionDigits:0}),document.getElementById("dashTotalCustomers").textContent=a.toLocaleString("tr-TR"),document.getElementById("dashTotalProducts").textContent=r.toLocaleString("tr-TR"),document.getElementById("dashTotalStores").textContent=n.toLocaleString("tr-TR"),document.getElementById("dashTotalSalespeople").textContent=o.toLocaleString("tr-TR"),document.getElementById("dashDailyAverage").textContent="$"+l.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("dashBasketAverage").textContent="$"+s.toLocaleString("tr-TR",{minimumFractionDigits:2}),renderDashYearlyChart(),renderDashTopStoresChart(allData),renderDashTopSalespeopleChart(allData),renderDashTopBrandsChart(allData),renderDashTopCategoriesChart(allData),renderDashTopCitiesChart(allData),renderDashTopProductsChart(allData),performDashboardAIAnalysis()):console.warn("⚠️ Veri yok, dashboard yüklenemedi")}let dashYearlyMetricType="sales",dashYearlyDataCache=null;function changeDashYearlyMetric(e){dashYearlyMetricType=e;var t=document.getElementById("dashYearlyMetricSales"),a=document.getElementById("dashYearlyMetricQty");"sales"===e?(t.style.background="#667eea",t.style.color="white",a.style.background="white",a.style.color="#667eea"):(t.style.background="white",t.style.color="#667eea",a.style.background="#667eea",a.style.color="white"),renderDashYearlyChart()}function renderDashYearlyChart(){var e=document.getElementById("dashYearlyChart");if(e){let r={},n={},t=(allData.forEach(e=>{var t,a;e.date&&(t=e.date.substring(0,4),a=e.date.substring(5,7),r[t]||(r[t]={}),r[t][a]||(r[t][a]=0),r[t][a]+=parseFloat(e.usd_amount||0),n[t]||(n[t]={}),n[t][a]||(n[t][a]=0),n[t][a]+=parseFloat(e.quantity||0))}),new Set),o=(Object.values(r).forEach(e=>{Object.keys(e).forEach(e=>t.add(e))}),Array.from(t).sort()),i="sales"===dashYearlyMetricType?r:n,l=[],s=[{border:"rgba(102, 126, 234, 1)",bg:"rgba(102, 126, 234, 0.1)"},{border:"rgba(245, 87, 108, 1)",bg:"rgba(245, 87, 108, 0.1)"},{border:"rgba(56, 239, 125, 1)",bg:"rgba(56, 239, 125, 0.1)"},{border:"rgba(255, 206, 86, 1)",bg:"rgba(255, 206, 86, 0.1)"}],a=(Object.keys(i).sort().forEach((e,t)=>{let a=i[e];var r=o.map(e=>a[e]||0),t=s[t%s.length];l.push({label:""+e,data:r,borderColor:t.border,backgroundColor:t.bg,borderWidth:3,fill:!0,tension:.4})}),dashYearlyChartInstance&&dashYearlyChartInstance.destroy(),["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"]);var c=o.map(e=>a[parseInt(e)-1]);let d="sales"===dashYearlyMetricType;var m=d?"Satış (USD - KDV Hariç)":"Miktar (Adet)",g=d?"rgba(102, 126, 234, 1)":"rgba(255, 159, 64, 1)";dashYearlyChartInstance=new Chart(e,{type:"line",data:{labels:c,datasets:l},options:{responsive:!0,maintainAspectRatio:!0,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!0,position:"top"},tooltip:{callbacks:{label:function(e){return d?e.dataset.label+": $"+e.parsed.y.toLocaleString("tr-TR",{minimumFractionDigits:2}):e.dataset.label+": "+e.parsed.y.toLocaleString("tr-TR",{minimumFractionDigits:0})+" adet"}}}},scales:{y:{beginAtZero:!0,title:{display:!0,text:m,color:g,font:{weight:"bold",size:12}},ticks:{callback:function(e){return d?"$"+e.toLocaleString("tr-TR"):e.toLocaleString("tr-TR")+" adet"}}}}}})}}function renderDashTopStoresChart(e){var t=document.getElementById("dashTopStoresChart");if(t){let a={};e.forEach(e=>{var t=e.store||"Bilinmiyor";a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0)});e=Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,10);let r=e.reduce((e,t)=>e+t[1],0);dashTopStoresChartInstance&&dashTopStoresChartInstance.destroy(),dashTopStoresChartInstance=new Chart(t,{type:"bar",data:{labels:e.map(e=>e[0]),datasets:[{label:"Satış (USD)",data:e.map(e=>e[1]),backgroundColor:"rgba(250, 112, 154, 0.8)"}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){var t=(e.parsed.x/r*100).toFixed(1);return"Satış: $"+e.parsed.x.toLocaleString("tr-TR",{minimumFractionDigits:2})+" ("+t+"%)"}}}},scales:{x:{ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}})}}function renderDashTopSalespeopleChart(e){var t=document.getElementById("dashTopSalespeopleChart");if(t){let a={};e.forEach(e=>{var t=e.sales_person||"Bilinmiyor";a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0)});e=Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,10);let r=e.reduce((e,t)=>e+t[1],0);dashTopSalespeopleChartInstance&&dashTopSalespeopleChartInstance.destroy(),dashTopSalespeopleChartInstance=new Chart(t,{type:"bar",data:{labels:e.map(e=>e[0]),datasets:[{label:"Satış (USD)",data:e.map(e=>e[1]),backgroundColor:"rgba(67, 233, 123, 0.8)"}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){var t=(e.parsed.x/r*100).toFixed(1);return"Satış: $"+e.parsed.x.toLocaleString("tr-TR",{minimumFractionDigits:2})+" ("+t+"%)"}}}},scales:{x:{ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}})}}function renderDashTopBrandsChart(e){var t=document.getElementById("dashTopBrandsChart");if(t){let a={};e.forEach(e=>{var t=e.brand||"Bilinmiyor";a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0)});e=Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,10);dashTopBrandsChartInstance&&dashTopBrandsChartInstance.destroy(),dashTopBrandsChartInstance=new Chart(t,{type:"doughnut",data:{labels:e.map(e=>e[0]),datasets:[{data:e.map(e=>e[1]),backgroundColor:["rgba(102, 126, 234, 0.8)","rgba(118, 75, 162, 0.8)","rgba(240, 147, 251, 0.8)","rgba(245, 87, 108, 0.8)","rgba(79, 172, 254, 0.8)","rgba(67, 233, 123, 0.8)","rgba(56, 249, 215, 0.8)","rgba(250, 112, 154, 0.8)","rgba(254, 224, 101, 0.8)","rgba(0, 242, 254, 0.8)"]}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{display:!0,position:"bottom"},tooltip:{callbacks:{label:function(e){return e.label+": $"+e.parsed.toLocaleString("tr-TR",{minimumFractionDigits:2})}}},datalabels:{color:"#fff",font:{weight:"bold",size:14},formatter:(e,t)=>(100*e/t.chart.data.datasets[0].data.reduce((e,t)=>e+t,0)).toFixed(1)+"%"}}},plugins:[ChartDataLabels]})}}function renderDashTopCategoriesChart(e){var t=document.getElementById("dashTopCategoriesChart");if(t){let a={};e.forEach(e=>{var t=e.category_1&&"all"!==e.category_1.toLowerCase()?e.category_1:e.category_2||e.category_3||"Diğer";!t||"bilinmiyor"===t.toLowerCase()||t.toLowerCase().includes("analitik")||t.toLowerCase().includes("eğitim")||(a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0))});e=Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,10);dashTopCategoriesChartInstance&&dashTopCategoriesChartInstance.destroy(),dashTopCategoriesChartInstance=new Chart(t,{type:"doughnut",data:{labels:e.map(e=>e[0]),datasets:[{data:e.map(e=>e[1]),backgroundColor:["rgba(67, 233, 123, 0.8)","rgba(56, 249, 215, 0.8)","rgba(79, 172, 254, 0.8)","rgba(0, 242, 254, 0.8)","rgba(102, 126, 234, 0.8)","rgba(118, 75, 162, 0.8)","rgba(240, 147, 251, 0.8)","rgba(245, 87, 108, 0.8)","rgba(250, 112, 154, 0.8)","rgba(254, 224, 101, 0.8)"]}]},options:{responsive:!0,maintainAspectRatio:!0,plugins:{legend:{display:!0,position:"bottom"},tooltip:{callbacks:{label:function(e){return e.label+": $"+e.parsed.toLocaleString("tr-TR",{minimumFractionDigits:2})}}},datalabels:{color:"#fff",font:{weight:"bold",size:14},formatter:(e,t)=>(100*e/t.chart.data.datasets[0].data.reduce((e,t)=>e+t,0)).toFixed(1)+"%"}}},plugins:[ChartDataLabels]})}}function renderDashTopCitiesChart(e){var t=document.getElementById("dashTopCitiesChart");if(t){let a={};e.forEach(e=>{var t=e.city||"Bilinmiyor";a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0)});e=Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,10);let r=e.reduce((e,t)=>e+t[1],0);dashTopCitiesChartInstance&&dashTopCitiesChartInstance.destroy(),dashTopCitiesChartInstance=new Chart(t,{type:"bar",data:{labels:e.map(e=>e[0]),datasets:[{label:"Satış (USD)",data:e.map(e=>e[1]),backgroundColor:"rgba(79, 172, 254, 0.8)"}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){var t=(e.parsed.x/r*100).toFixed(1);return"Satış: $"+e.parsed.x.toLocaleString("tr-TR",{minimumFractionDigits:2})+" ("+t+"%)"}}}},scales:{x:{ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}})}}function renderDashTopProductsChart(e){var n=document.getElementById("dashTopProductsChart");if(n){let a={},t=(e.forEach(e=>{var t=e.product||"Bilinmiyor";a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0)}),Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,10)),r=t.reduce((e,t)=>e+t[1],0);dashTopProductsChartInstance&&dashTopProductsChartInstance.destroy();e=t.map(e=>{let t=e[0];return 35<(t=(t=(t=(t=t.replace(/^[\[\(]?[A-Z0-9']+[\]\)]?\s*/g,"")).replace(/\s+Dijital\s+Piyano/gi," Piyano")).replace(/\s+Kuyruklu\s+Piyano/gi," K.Piyano")).replace(/\s+M\/PEP\s+/gi," ")).length?t.substring(0,32)+"...":t});dashTopProductsChartInstance=new Chart(n,{type:"bar",data:{labels:e,datasets:[{label:"Satış (USD)",data:t.map(e=>e[1]),backgroundColor:"rgba(240, 147, 251, 0.8)"}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{title:function(e){return t[e[0].dataIndex][0]},label:function(e){var t=(e.parsed.x/r*100).toFixed(1);return"Satış: $"+e.parsed.x.toLocaleString("tr-TR",{minimumFractionDigits:2})+" ("+t+"%)"}}}},scales:{x:{ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}},y:{ticks:{autoSkip:!1,font:{size:11}}}}}})}}function performDashboardAIAnalysis(){console.log("🤖 Gelişmiş AI Analiz başlatılıyor...");let t=(new Date).getFullYear(),a=t-1;var e=allData.filter(e=>e.date&&e.date.startsWith(t.toString())),r=allData.filter(e=>e.date&&e.date.startsWith(a.toString())),n=allData.map(e=>e.date).filter(e=>e).sort(),n=n[n.length-1],o=n?n.substring(0,4):t,i=n?n.substring(5,7):"",l=["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"],i=(n?n.substring(8,10):"")+` ${i?l[parseInt(i)-1]:""} `+o;console.log("📅 Son veri güncelleme tarihi:",i);let s=e.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0);var o=r.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0),d=new Date(t,0,1),n=new Date(n),n=Math.ceil((n-d)/864e5),d=365-n,c=0<n?s/n:0,m=o/365,g=0<m?(c-m)/m*100:0,u=365*c,p=0<o?(u-o)/o*100:0,R=Math.max(0,o-s),_=0<d?R/d:0,y=0<r.length?(s-o)/o*100:0;let h={},b={};e.forEach(e=>{var t=e.store||"Bilinmiyor";h[t]||(h[t]=0),h[t]+=parseFloat(e.usd_amount||0)}),r.forEach(e=>{var t=e.store||"Bilinmiyor";b[t]||(b[t]=0),b[t]+=parseFloat(e.usd_amount||0)});var f=Object.entries(h).sort((e,t)=>t[1]-e[1]),P=f.slice(0,10),v=f[f.length-1],f=f.map(([e,t])=>{var a=b[e]||0;return{store:e,sales:t,growth:0<a?(t-a)/a*100:0}}).sort((e,t)=>t.growth-e.growth),k=f[0],f=f[f.length-1];let S={},C={};e.forEach(e=>{var t=e.sales_person||"Bilinmiyor";S[t]||(S[t]=0),S[t]+=parseFloat(e.usd_amount||0)}),r.forEach(e=>{var t=e.sales_person||"Bilinmiyor";C[t]||(C[t]=0),C[t]+=parseFloat(e.usd_amount||0)});var x=Object.entries(S).sort((e,t)=>t[1]-e[1]);x.slice(0,10),x.map(([e,t])=>{var a=C[e]||0;return{sp:e,sales:t,growth:0<a?(t-a)/a*100:0}}).sort((e,t)=>t.growth-e.growth);let $={},T={};e.forEach(e=>{var t=e.brand||"Bilinmiyor";$[t]||($[t]=0),$[t]+=parseFloat(e.usd_amount||0)}),r.forEach(e=>{var t=e.brand||"Bilinmiyor";T[t]||(T[t]=0),T[t]+=parseFloat(e.usd_amount||0)});var x=Object.entries($).sort((e,t)=>t[1]-e[1]),I=x.slice(0,10),j=I.reduce((e,t)=>e+t[1],0)/s*100,x=x.map(([e,t])=>{var a=T[e]||0;return{brand:e,sales:t,growth:0<a?(t-a)/a*100:0}}).sort((e,t)=>t.growth-e.growth),D=x[0],x=x[x.length-1];let E={},B={};e.forEach(e=>{var t=e.category_2||"Bilinmiyor";E[t]||(E[t]=0),E[t]+=parseFloat(e.usd_amount||0)}),r.forEach(e=>{var t=e.category_2||"Bilinmiyor";B[t]||(B[t]=0),B[t]+=parseFloat(e.usd_amount||0)});var w=Object.entries(E).sort((e,t)=>t[1]-e[1]),w=(w.slice(0,10),w.map(([e,t])=>{var a=B[e]||0;return{category:e,sales:t,growth:0<a?(t-a)/a*100:0}}).sort((e,t)=>t.growth-e.growth));w[0];let F={},q={},O={},H={};e.forEach(e=>{var t=e.date.substring(5,7),a=e.date.substring(8,10);F[t]||(F[t]=0,O[t]=new Set),F[t]+=parseFloat(e.usd_amount||0),O[t].add(a)}),r.forEach(e=>{var t=e.date.substring(5,7),a=e.date.substring(8,10);q[t]||(q[t]=0,H[t]=new Set),q[t]+=parseFloat(e.usd_amount||0),H[t].add(a)});var w=Object.keys(F).sort(),w=w[w.length-1],L=F[w]||0,K=q[w]||0,L=L/(O[w]?O[w].size:1),z=K/(H[w]?H[w].size:1),A=0<z?(L-z)/z*100:0,M=new Date,Y=M.getDate(),M=w===String(M.getMonth()+1).padStart(2,"0"),Y=M?(Y/30*100).toFixed(0):100,G=new Set(e.map(e=>e.partner)).size,e=new Set(e.map(e=>e.move_name)).size,e=s/e,V=s/G,r=new Set(r.map(e=>e.move_name)).size,r=0<r?o/r:0,U=0<r?(e-r)/r*100:0,l=l[parseInt(w)-1],w=(console.log("📊 Veri güncelleme:",i),console.log(`⏱️ ${t}: ${n} gün geçti, ${d} gün kaldı`),console.log("📊 Günlük ortalama:",m.toFixed(0),"→",c.toFixed(0),`(${0<g?"+":""}${g.toFixed(1)}%)`),console.log("🎯 Yıl sonu tahmini:",u.toFixed(0),`(${0<p?"+":""}${p.toFixed(1)}%)`),console.log("📈 Basit karşılaştırma (YANILTICI):",y.toFixed(1)+"%"),console.log("📊 Aylık ivme:",A.toFixed(1)+"%"),`
                <!-- Veri Güncelleme Tarihi -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 15px; border-radius: 10px; margin-bottom: 20px; color: white; text-align: center;">
                    <strong>📅 Son Veri Güncelleme:</strong> ${i} | <strong>🎵 Müzik Enstrüman Sektörü</strong>
                </div>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 30px;">
                    <div>
                        <h4 style="margin-bottom: 15px; color: #38ef7d;">✅ Olumlu Tespitler & Güçlü Yönler</h4>
                        <ul style="line-height: 2.2; margin: 0;">
                            ${0<g?`<li><strong>📈 Günlük Ortalama İvme:</strong> %${Math.abs(g).toFixed(1)} artış<br><span style="font-size: 0.9em; color: #666;">💵 ${a}: $${m.toLocaleString("tr-TR",{minimumFractionDigits:0})}/gün → ${t}: $${c.toLocaleString("tr-TR",{minimumFractionDigits:0})}/gün<br>🎯 Yıl sonu tahmini: $${u.toLocaleString("tr-TR",{minimumFractionDigits:0})} (%${p.toFixed(1)} büyüme)</span></li>`:""}
                            ${0<A?`<li><strong>📊 ${l} Ayı İvme (Günlük Ort.):</strong> %${Math.abs(A).toFixed(1)} artış ${M?`<span style="color: #667eea;">(⏱️ Ay %${Y} tamamlandı)</span>`:""}<br><span style="font-size: 0.9em; color: #666;">📅 ${a}: $${z.toLocaleString("tr-TR",{minimumFractionDigits:0})}/gün → ${t}: $${L.toLocaleString("tr-TR",{minimumFractionDigits:0})}/gün</span></li>`:""}
                            ${0<U?`<li><strong>🛒 Sepet Ortalaması İvmesi:</strong> %${Math.abs(U).toFixed(1)} artış<br><span style="font-size: 0.9em; color: #666;">💰 ${a}: $${r.toLocaleString("tr-TR",{minimumFractionDigits:0})} → ${t}: $${e.toLocaleString("tr-TR",{minimumFractionDigits:0})}</span></li>`:""}
                            ${k&&20<k.growth?`<li><strong>🚀 En Hızlı Büyüyen Mağaza:</strong> ${k.store} (%${k.growth.toFixed(1)} ivme)<br><span style="font-size: 0.9em; color: #666;">🎯 Best practice kaynak olarak kullanılmalı</span></li>`:""}
                            ${D&&30<D.growth?`<li><strong>🏷️ En Hızlı Büyüyen Marka:</strong> ${D.brand} (%${D.growth.toFixed(1)} ivme)<br><span style="font-size: 0.9em; color: #666;">💡 Bu markaya yatırım artırılmalı</span></li>`:""}
                            <li><strong>🏷️ Top 10 Marka Performansı:</strong><br>
                                ${I.map((e,t)=>`<span style="font-size: 0.9em;">${t+1}. ${e[0]}: $${e[1].toLocaleString("tr-TR",{minimumFractionDigits:0})} (%${(e[1]/s*100).toFixed(1)})</span>`).join("<br>")}
                                <br><span style="font-size: 0.9em; color: #666;">🎯 Top 10 marka toplam satışın %${j.toFixed(1)}'ini oluşturuyor</span>
                            </li>
                            <li><strong>👥 Müşteri Metrikleri:</strong><br>
                                <span style="font-size: 0.9em;">• ${G.toLocaleString("tr-TR")} aktif müşteri<br>
                                • Müşteri başı ortalama: $${V.toLocaleString("tr-TR",{minimumFractionDigits:0})}<br>
                                • Sepet ortalaması: $${e.toLocaleString("tr-TR",{minimumFractionDigits:2})}</span>
                            </li>
                        </ul>
                    </div>
                    <div>
                        <h4 style="margin-bottom: 15px; color: #f5576c;">⚠️ Dikkat Noktaları & İyileştirme Alanları</h4>
                        <ul style="line-height: 2.2; margin: 0;">
                            ${y<0?`<li><strong>⏱️ ${t} Durum Raporu (${n} gün geçti, ${d} gün kaldı):</strong><br><span style="font-size: 0.9em; color: #666;">💵 <strong>${a} Tamamı:</strong> $${o.toLocaleString("tr-TR",{minimumFractionDigits:0})}<br>💵 <strong>${t} Şu An:</strong> $${s.toLocaleString("tr-TR",{minimumFractionDigits:0})} <span style="color: #f5576c;">(-%${Math.abs(y).toFixed(1)} - YANILTICI!)</span><br>📊 <strong>Günlük Ortalama:</strong> ${a}: $${m.toLocaleString("tr-TR",{minimumFractionDigits:0})}/gün → ${t}: $${c.toLocaleString("tr-TR",{minimumFractionDigits:0})}/gün <span style="${g<0?"color: #f5576c;":"color: #38ef7d;"}">(${0<g?"+":""}%${g.toFixed(1)})</span><br>🎯 <strong>Yıl Sonu Tahmini:</strong> $${u.toLocaleString("tr-TR",{minimumFractionDigits:0})} <span style="${p<0?"color: #f5576c;":"color: #38ef7d;"}">(${0<p?"+":""}%${p.toFixed(1)} vs ${a})</span><br>🚨 <strong>${a} seviyesini yakalamak için kalan ${d} günde:</strong> $${R.toLocaleString("tr-TR",{minimumFractionDigits:0})} ciro gerekli ($${_.toLocaleString("tr-TR",{minimumFractionDigits:0})}/gün vs mevcut $${c.toLocaleString("tr-TR",{minimumFractionDigits:0})}/gün)</span></li>`:""}
                            ${A<0?`<li><strong>⚠️ ${l} Ayı Negatif İvme:</strong> %${Math.abs(A).toFixed(1)} düşüş ${M?`<span style="color: #f5576c;">(⏱️ Ay %${Y} tamamlandı)</span>`:""}<br><span style="font-size: 0.9em; color: #666;">📅 Günlük ort: $${z.toLocaleString("tr-TR",{minimumFractionDigits:0})} → $${L.toLocaleString("tr-TR",{minimumFractionDigits:0})}<br>💡 Ay sonu tahmini: $${(30*L).toLocaleString("tr-TR",{minimumFractionDigits:0})} (vs ${a}: $${K.toLocaleString("tr-TR",{minimumFractionDigits:0})})</span></li>`:""}
                            ${U<0?`<li><strong>🛒 Sepet Ortalaması Düşüşü:</strong> %${Math.abs(U).toFixed(1)} azalış<br><span style="font-size: 0.9em; color: #666;">⚠️ Cross-selling ve upselling stratejileri güçlendirilmeli</span></li>`:""}
                            ${f&&f.growth<-10?`<li><strong>📊 En Düşük İvmeli Mağaza:</strong> ${f.store} (%${f.growth.toFixed(1)})<br><span style="font-size: 0.9em; color: #666;">🎯 Acil müdahale ve destek gerekli</span></li>`:""}
                            ${x&&x.growth<-20?`<li><strong>🏷️ Düşüş Yaşayan Marka:</strong> ${x.brand} (%${x.growth.toFixed(1)})<br><span style="font-size: 0.9em; color: #666;">💡 Ürün yelpazesi ve fiyatlandırma gözden geçirilmeli</span></li>`:""}
                            ${v?`<li><strong>📍 En Düşük Performanslı Mağaza:</strong> ${v[0]} ($${v[1].toLocaleString("tr-TR",{minimumFractionDigits:0})})<br><span style="font-size: 0.9em; color: #666;">Toplam satışın %${(v[1]/s*100).toFixed(2)}'i - Stratejik değerlendirme gerekli</span></li>`:""}
                            <li><strong>🎯 Marka Çeşitliliği:</strong> Top 10 marka satışların %${j.toFixed(1)}'ini oluşturuyor ${70<j?'<span style="color: #f5576c;">(⚠️ Risk yüksek!)</span>':'<span style="color: #38ef7d;">(✓ Dengeli)</span>'}<br><span style="font-size: 0.9em; color: #666;">💡 Portföy çeşitliliği artırılmalı</span></li>
                        </ul>
                    </div>
                </div>
                
                <hr style="margin: 25px 0; border: none; border-top: 2px solid #667eea;">
                <h4 style="margin-bottom: 15px; color: #667eea;">💡 Stratejik Öneriler & Aksiyon Planı (Müzik Sektörü Özel)</h4>
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px;">
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #38ef7d;">
                        <strong>🎯 Kısa Vadeli (1-3 ay)</strong>
                        <ul style="margin: 10px 0 0 0; line-height: 2; font-size: 0.95em;">
                            ${A<0?`<li><strong>🚨 ACİL:</strong> ${l} ayı düşüşü analizi - Stok, kampanya ve sezonsal faktörleri inceleyin</li>`:""}
                            ${0<P.length?`<li><strong>🏆 Best Practice:</strong> ${P[0][0]} mağazasının başarı faktörlerini (vitrin düzeni, müşteri deneyimi, teşhir teknikleri) diğer mağazalara aktarın</li>`:""}
                            <li><strong>🎸 Ürün Teşhiri:</strong> Gitarlar, klavyeler, davullar için akustik test alanları oluşturun - deneyimsel satış artışı hedefleyin</li>
                            <li><strong>🛒 Sepet Büyütme:</strong> Aksesuar paketleri (teller, kılıflar, tuner) ile cross-selling - hedef: %20 sepet artışı</li>
                            ${0<I.length?`<li><strong>🏷️ Kampanya:</strong> ${I[0][0]} için "Yeni Başlayanlar Paketi" kampanyası düzenleyin</li>`:""}
                            <li><strong>📱 Dijital:</strong> Online mağazada canlı ürün demoları ve sanal deneme özellikleri ekleyin</li>
                        </ul>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #667eea;">
                        <strong>📈 Orta Vadeli (3-6 ay)</strong>
                        <ul style="margin: 10px 0 0 0; line-height: 2; font-size: 0.95em;">
                            <li><strong>👥 Müşteri Segmentasyonu:</strong> Profesyonel müzisyenler, amatörler ve yeni başlayanlar için özel hizmet paketleri</li>
                            <li><strong>🎓 Eğitim Programı:</strong> Mağazalarda ücretsiz enstrüman tanıtım ve deneme workshopları (müşteri bağlılığı %30+ artış)</li>
                            <li><strong>🔧 Servis Geliştirme:</strong> Enstrüman bakım ve onarım servisleri ile satış sonrası gelir kaynağı oluşturun</li>
                            <li><strong>📦 Stok Optimizasyonu:</strong> Sezonsal trendlere göre (okul açılışı, yılbaşı) stok planlaması yapın</li>
                            ${v?`<li><strong>📊 Mağaza İyileştirme:</strong> ${v[0]} için özel destek programı - ürün karması ve satış ekibi eğitimi</li>`:""}
                            <li><strong>🌐 Online-Offline Entegrasyon:</strong> Click & Collect, mağazadan deneme sonrası online sipariş sistemi</li>
                        </ul>
                    </div>
                    <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; border-left: 4px solid #fa7268;">
                        <strong>🚀 Uzun Vadeli (6-12 ay)</strong>
                        <ul style="margin: 10px 0 0 0; line-height: 2; font-size: 0.95em;">
                            <li><strong>🎵 Topluluk Oluşturma:</strong> Müzisyen topluluğu platformu - konserler, jamler, ürün lansmanları düzenleyin</li>
                            <li><strong>🤝 B2B Geliştirme:</strong> Müzik okulları, kurslar ve tiyatrolar ile kurumsal anlaşmalar yapın</li>
                            <li><strong>💼 Kiralama Servisi:</strong> Profesyonel ekipman kiralama servisi başlatın (pasif gelir kaynağı)</li>
                            <li><strong>📊 Data Analytics:</strong> Müşteri satın alma davranışları analizi ile kişiselleştirilmiş öneriler geliştirin</li>
                            <li><strong>🌍 Pazar Genişletme:</strong> Yeni mağaza açılışları için potansiyel şehirleri analiz edin (${t} verilerine göre)</li>
                            <li><strong>🎯 Hedef Belirleme:</strong> ${t+1} yılı için gerçekçi büyüme hedefleri belirleyin - önerilen: %${0<y?(1.2*y).toFixed(0):"15"} büyüme</li>
                        </ul>
                    </div>
                </div>
            `);document.getElementById("dashAIAnalysis").innerHTML=w}let hourlyChartInstance=null,monthlyTrendChartInstance=null,yearlyTrendChartInstance=null,storeTimeChartInstance=null,categoryTimeChartInstance=null,salesPersonTimeChartInstance=null;function analyzeTime(){console.log("⏰ Zaman analizi başlatılıyor...");let t=document.getElementById("timeCategory1Filter")?.value||"";t?(filteredData=allData.filter(e=>e.category_2===t),console.log(`📁 Kategori filtresi: "${t}" - ${filteredData.length} kayıt`)):filteredData=[...allData],updateTimeSummary(),renderHourlyChart(),renderMonthlyTrendChart(),renderYearlyTrendChart(),populateTimeFilters(),renderStoreTimeChart(),renderCategoryTimeChart(),renderSalesPersonTimeChart(),performTimeAIAnalysis()}function updateTimeSummary(){let r={},n={},o=0,i=0,e=(filteredData.forEach(e=>{var t=e.create_hour||0,a=e.day_of_week||0,e=parseFloat(e.usd_amount||0);r[t]||(r[t]=0),r[t]+=e,n[a]||(n[a]=0),n[a]+=e,9<=t&&t<18&&(o+=e),5!==a&&6!==a||(i+=e)}),0),t=0;for(var[a,l]of Object.entries(r))l>t&&(t=l,e=parseInt(a));var s,d;let c=0,m=0;for([s,d]of Object.entries(n))d>m&&(m=d,c=parseInt(s));document.getElementById("peakHour").textContent=`${String(e).padStart(2,"0")}:00-${String(e+1).padStart(2,"0")}:00`,document.getElementById("peakDay").textContent=["Pazartesi","Salı","Çarşamba","Perşembe","Cuma","Cumartesi","Pazar"][c],document.getElementById("workHoursSales").textContent="$"+o.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("weekendSales").textContent="$"+i.toLocaleString("tr-TR",{minimumFractionDigits:2})}function renderHourlyChart(){var e=document.getElementById("hourlyChart");if(e){let a=Array(24).fill(0),r=Array(24).fill(0);filteredData.forEach(e=>{var t=e.create_hour||0;a[t]+=parseFloat(e.usd_amount||0),r[t]+=1}),hourlyChartInstance&&hourlyChartInstance.destroy(),hourlyChartInstance=new Chart(e,{type:"bar",data:{labels:Array.from({length:24},(e,t)=>String(t).padStart(2,"0")+":00"),datasets:[{label:"Satış ($ - KDV Hariç)",data:a,backgroundColor:a.map((e,t)=>e===Math.max(...a)?"rgba(245, 87, 108, 0.8)":9<=t&&t<18?"rgba(56, 239, 125, 0.6)":"rgba(102, 126, 234, 0.6)"),borderColor:"rgba(102, 126, 234, 1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0},tooltip:{callbacks:{label:function(e){return`Satış: $${e.parsed.y.toLocaleString("tr-TR")} (${r[e.dataIndex]} adet)`}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}})}}function renderMonthlyTrendChart(){var e=document.getElementById("monthlyTrendChart");if(e){let a={};filteredData.forEach(e=>{var t;e.date&&(t=e.date.substring(0,7),a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0))});var t=Object.keys(a).sort(),r=t.map(e=>{var[e,t]=e.split("-");return["Oca","Şub","Mar","Nis","May","Haz","Tem","Ağu","Eyl","Eki","Kas","Ara"][parseInt(t)-1]+" "+e}),t=t.map(e=>a[e]);monthlyTrendChartInstance&&monthlyTrendChartInstance.destroy(),monthlyTrendChartInstance=new Chart(e,{type:"bar",data:{labels:r,datasets:[{label:"Aylık Satış ($ - KDV Hariç)",data:t,backgroundColor:"rgba(102, 126, 234, 0.7)",borderColor:"rgba(102, 126, 234, 1)",borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0},tooltip:{callbacks:{label:function(e){return"Satış: $"+e.parsed.y.toLocaleString("tr-TR")}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+(e/1e3).toFixed(0)+"K"}}}}}})}}function renderYearlyTrendChart(){var e=document.getElementById("yearlyTrendChart");if(e){let a={};filteredData.forEach(e=>{var t;e.date&&(t=e.date.substring(0,4),a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0))});var t=Object.keys(a).sort(),r=t.map(e=>a[e]);yearlyTrendChartInstance&&yearlyTrendChartInstance.destroy(),yearlyTrendChartInstance=new Chart(e,{type:"bar",data:{labels:t,datasets:[{label:"Yıllık Satış ($ - KDV Hariç)",data:r,backgroundColor:"rgba(118, 75, 162, 0.7)",borderColor:"rgba(118, 75, 162, 1)",borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0},tooltip:{callbacks:{label:function(e){return"Satış: $"+e.parsed.y.toLocaleString("tr-TR")}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+(e/1e6).toFixed(1)+"M"}}}}}})}}function populateTimeFilters(){var e=[...new Set(allData.map(e=>e.category_2).filter(e=>e&&"all"!==e.toLowerCase()))].sort();let r=document.getElementById("timeCategory1Filter");if(r){let a=r.value;r.innerHTML='<option value="">Tüm Kategoriler</option>',e.forEach(e=>{var t=e===a?"selected":"";r.innerHTML+=`<option value="${e}" ${t}>${e}</option>`})}e=[...new Set(filteredData.map(e=>e.store).filter(Boolean))];let t=document.getElementById("storeTimeFilter");t.innerHTML='<option value="">Tüm Mağazalar</option>',e.forEach(e=>{t.innerHTML+=`<option value="${e}">${e}</option>`});e=[...new Set(filteredData.map(e=>e.category_2).filter(e=>e&&"all"!==e.toLowerCase()))].sort();let a=document.getElementById("categoryTimeFilter");a.innerHTML='<option value="">Tüm Kategoriler</option>',e.forEach(e=>{a.innerHTML+=`<option value="${e}">${e}</option>`});e=[...new Set(filteredData.map(e=>e.sales_person).filter(Boolean))];let n=document.getElementById("salesPersonTimeFilter");n.innerHTML='<option value="">Tüm Temsilciler</option>',e.forEach(e=>{n.innerHTML+=`<option value="${e}">${e}</option>`})}function clearTimeFilters(){var e=document.getElementById("timeCategory1Filter");e&&(e.value=""),console.log("🔄 Zaman analizi filtreleri temizlendi"),analyzeTime()}function renderStoreTimeChart(){var e=document.getElementById("storeTimeChart");if(e){let t=document.getElementById("storeTimeFilter").value;var r=t?filteredData.filter(e=>e.store===t):filteredData;let a=Array(24).fill(0);r.forEach(e=>{var t=e.create_hour||0;a[t]+=parseFloat(e.usd_amount||0)}),storeTimeChartInstance&&storeTimeChartInstance.destroy(),storeTimeChartInstance=new Chart(e,{type:"bar",data:{labels:Array.from({length:24},(e,t)=>String(t).padStart(2,"0")+":00"),datasets:[{label:t||"Tüm Mağazalar",data:a,backgroundColor:"rgba(56, 239, 125, 0.6)",borderColor:"rgba(56, 239, 125, 1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}})}}function renderCategoryTimeChart(){var e=document.getElementById("categoryTimeChart");if(e){let t=document.getElementById("categoryTimeFilter").value;var r=t?filteredData.filter(e=>e.category_2===t):filteredData;let a=Array(24).fill(0);r.forEach(e=>{var t=e.create_hour||0;a[t]+=parseFloat(e.usd_amount||0)}),categoryTimeChartInstance&&categoryTimeChartInstance.destroy(),categoryTimeChartInstance=new Chart(e,{type:"bar",data:{labels:Array.from({length:24},(e,t)=>String(t).padStart(2,"0")+":00"),datasets:[{label:t||"Tüm Kategoriler",data:a,backgroundColor:"rgba(245, 87, 108, 0.6)",borderColor:"rgba(245, 87, 108, 1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}})}}function renderSalesPersonTimeChart(){var e=document.getElementById("salesPersonTimeChart");if(e){let t=document.getElementById("salesPersonTimeFilter").value;var r=t?filteredData.filter(e=>e.sales_person===t):filteredData;let a=Array(24).fill(0);r.forEach(e=>{var t=e.create_hour||0;a[t]+=parseFloat(e.usd_amount||0)}),salesPersonTimeChartInstance&&salesPersonTimeChartInstance.destroy(),salesPersonTimeChartInstance=new Chart(e,{type:"bar",data:{labels:Array.from({length:24},(e,t)=>String(t).padStart(2,"0")+":00"),datasets:[{label:t||"Tüm Temsilciler",data:a,backgroundColor:"rgba(240, 147, 251, 0.6)",borderColor:"rgba(240, 147, 251, 1)",borderWidth:1}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}})}}function performTimeAIAnalysis(){console.log("🤖 Zaman AI analizi başlatılıyor...");var g=document.getElementById("timeInsightsPanel");if(g&&0!==filteredData.length){let o={},i={},l={},s={};filteredData.forEach(e=>{var t=e.create_hour||0,a=e.day_of_week||0,r=e.store||"Bilinmiyor",n=e.category_1||"Bilinmiyor",e=parseFloat(e.usd_amount||0);o[t]||(o[t]={sales:0,count:0}),o[t].sales+=e,o[t].count+=1,i[a]||(i[a]={sales:0,count:0}),i[a].sales+=e,i[a].count+=1,l[r]||(l[r]={}),l[r][t]||(l[r][t]=0),l[r][t]+=e,s[n]||(s[n]={}),s[n][t]||(s[n][t]=0),s[n][t]+=e});var u,p,y={positive:[],negative:[],neutral:[],recommendations:[]};let e=0,t=0;for([u,p]of Object.entries(o))p.sales>t&&(t=p.sales,e=parseInt(u));y.positive.push({title:`En Yoğun Saat: ${String(e).padStart(2,"0")}:00-${String(e+1).padStart(2,"0")}:00`,description:`<span class="metric-highlight">$${t.toLocaleString("tr-TR",{minimumFractionDigits:2})}</span> satış ile en yoğun saat dilimi. Bu saatte personel sayısını artırın.`});var h,b,f,v,k=["Pazartesi","Salı","Çarşamba","Perşembe","Cuma","Cumartesi","Pazar"];let a=0,r=0,n=0,d=1/0;for([h,b]of Object.entries(i))b.sales>r&&(r=b.sales,a=parseInt(h)),b.sales<d&&(d=b.sales,n=parseInt(h));y.positive.push({title:"En Yoğun Gün: "+k[a],description:`<span class="metric-highlight">$${r.toLocaleString("tr-TR",{minimumFractionDigits:2})}</span> satış ile haftanın en yoğun günü.`}),2<r/d&&y.negative.push({title:"Günler Arası Büyük Fark",description:`${k[a]} ile ${k[n]} arasında <span class="metric-highlight">${(100*(r/d-1)).toFixed(0)}%</span> fark var. ${k[n]} için özel kampanyalar düşünün.`});let c=0,m=0;for([f,v]of Object.entries(o))9<=parseInt(f)&&parseInt(f)<18?c+=v.sales:m+=v.sales;var S=(c/(c+m)*100).toFixed(1),S=(y.neutral.push({title:"Mesai Saati Dağılımı",description:`Satışların <span class="metric-highlight">%${S}</span>'i mesai saatlerinde (09:00-18:00) gerçekleşiyor.`}),y.recommendations.push({icon:"⏰",title:"Personel Planlaması",description:`${String(e).padStart(2,"0")}:00-${String(e+1).padStart(2,"0")}:00 saatleri arasında personel sayısını artırın. Bu saatte satışların %${(t/Object.values(o).reduce((e,t)=>e+t.sales,0)*100).toFixed(1)}'i gerçekleşiyor.`}),y.recommendations.push({icon:"📅",title:"Kampanya Zamanlaması",description:`${k[n]} günleri için özel kampanyalar düzenleyin. Mevcut satışlar ${k[a]}'ye göre %${(100*(1-d/r)).toFixed(0)} daha düşük.`}),m>.3*c&&y.recommendations.push({icon:"🌙",title:"Mesai Dışı Potansiyel",description:`Mesai dışı satışlar toplam satışların %${(m/(c+m)*100).toFixed(1)}'ini oluşturuyor. Online satış kanallarını güçlendirin.`}),`
                <div class="analysis-panel" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">
                    <h2 style="margin: 0 0 20px 0; font-size: 2em;">⏰ Zaman Analizi AI Önerileri</h2>
                    <p style="opacity: 0.9; margin-bottom: 20px;">Filtrelenen ${filteredData.length.toLocaleString("tr-TR")} kayıt üzerinden yapılan zaman analizi sonuçları</p>
                    
                    ${0<y.positive.length?`
                    <div class="analysis-section">
                        <h3>✅ Olumlu Tespitler</h3>
                        ${y.positive.map(e=>`
                            <div class="insight-item insight-positive">
                                <span class="insight-icon">✅</span>
                                <strong>${e.title}</strong><br>
                                ${e.description}
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    ${0<y.negative.length?`
                    <div class="analysis-section">
                        <h3>⚠️ Dikkat Edilmesi Gerekenler</h3>
                        ${y.negative.map(e=>`
                            <div class="insight-item insight-negative">
                                <span class="insight-icon">⚠️</span>
                                <strong>${e.title}</strong><br>
                                ${e.description}
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    ${0<y.neutral.length?`
                    <div class="analysis-section">
                        <h3>💡 Önemli Bilgiler</h3>
                        ${y.neutral.map(e=>`
                            <div class="insight-item insight-neutral">
                                <span class="insight-icon">💡</span>
                                <strong>${e.title}</strong><br>
                                ${e.description}
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    <div class="analysis-section">
                        <h3>🎯 Aksiyon Önerileri</h3>
                        ${y.recommendations.map(e=>`
                            <div class="recommendation">
                                <span class="recommendation-icon">${e.icon}</span>
                                <div>
                                    <strong style="font-size: 1.1em;">${e.title}</strong><br>
                                    <p style="margin: 10px 0 0 0; opacity: 0.95;">${e.description}</p>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                </div>
            `);g.innerHTML=S,g.style.display="block"}}loadData();let productStoreChartInstance=null,productCityChartInstance=null,productSalesPersonChartInstance=null,productMonthlyChartInstance=null,currentProductData=[],currentSortColumn="sales",currentSortDirection="desc",lastProductSearchData=null,lastSalespersonTopProductsData=null,currentSalespersonSortColumn="sales",currentSalespersonSortDirection="desc",lastCustomerPurchaseData=null,currentCustomerPurchaseSortColumn="date",currentCustomerPurchaseSortDirection="desc",allCategories=[],allCategoriesHierarchical=[];function initializeProductFilters(){let r=new Map,t=(allData.forEach(e=>{var t=[e.category_1||"",e.category_2||"",e.category_3||"",e.category_4||""].filter(e=>e&&e.trim());for(let e=1;e<=t.length;e++){var a=t.slice(0,e).join(" > ");a&&!r.has(a)&&r.set(a,{cat1:t[0]||"",cat2:t[1]||"",cat3:t[2]||"",cat4:t[3]||""})}}),allCategoriesHierarchical=Array.from(r.keys()).sort(),new Set),a=(allData.forEach(e=>{e.category_1&&t.add(e.category_1),e.category_2&&t.add(e.category_2),e.category_3&&t.add(e.category_3),e.category_4&&t.add(e.category_4)}),allCategories=Array.from(t).sort(),new Set),n=(allData.forEach(e=>{e.store&&"Analitik"!==e.store&&!e.store.toLowerCase().includes("eğitim")&&a.add(e.store)}),document.getElementById("productStoreFilter"));n&&(n.innerHTML='<option value="">Tüm Mağazalar</option>',Array.from(a).sort().forEach(e=>{n.innerHTML+=`<option value="${e}">${e}</option>`}))}function showProductCategoryDropdown(){filterProductCategories(),document.getElementById("productCategoryDropdown").style.display="block"}function hideProductCategoryDropdown(){document.getElementById("productCategoryDropdown").style.display="none"}function filterProductCategories(){let t=document.getElementById("productCategorySearch").value.toLowerCase();var e=document.getElementById("productCategoryDropdown"),a=allCategoriesHierarchical.filter(e=>e.toLowerCase().includes(t));0===a.length?e.innerHTML='<div style="padding: 15px; text-align: center; color: #999;">Sonuç bulunamadı</div>':(e.innerHTML=a.slice(0,20).map(e=>{var t=e.split(" > ").map((e,t)=>{var a=["#667eea","#764ba2","#e74c3c","#f39c12"];return`<span style="color: ${a[t%a.length]}; font-weight: ${0===t?"bold":"normal"};">${e}</span>`}).join(' <span style="color: #999;">›</span> ');return`
                        <div onclick="selectProductCategory('${e.replace(/'/g,"\\'")}')" 
                             style="padding: 12px; cursor: pointer; border-bottom: 1px solid #eee; transition: all 0.2s;"
                             onmouseover="this.style.background='#f5f5f5'"
                             onmouseout="this.style.background='white'">
                            📁 ${t}
                        </div>
                    `}).join(""),20<a.length&&(e.innerHTML+='<div style="padding: 10px; text-align: center; color: #999; font-size: 0.9em;">+'+(a.length-20)+" daha...</div>")),e.style.display="block"}function selectProductCategory(e){document.getElementById("productCategorySearch").value=e,document.getElementById("productCategorySearch").setAttribute("data-selected-category",e),hideProductCategoryDropdown(),searchProduct()}function clearProductDateFilters(){document.getElementById("productDateStart").value="",document.getElementById("productDateEnd").value="",console.log("🔄 Ürün tarih filtreleri temizlendi")}function searchProduct(){let c=document.getElementById("productSearchInput").value.trim(),m=document.getElementById("productCategorySearch").getAttribute("data-selected-category")||"",g=document.getElementById("productStoreFilter").value,u=document.getElementById("productDateStart").value,p=document.getElementById("productDateEnd").value;if(c||m){console.log("🔍 Arama kriteri:",{searchTerm:c,selectedCategory:m,selectedStore:g,dateStart:u,dateEnd:p});let d=c.toLowerCase();var e,t,a,r,n=allData.filter(e=>{var t=(e.product||"").toLowerCase(),a=(e.brand||"").toLowerCase(),r=(e.category_1||"").toLowerCase(),n=(e.category_2||"").toLowerCase(),o=(e.category_3||"").toLowerCase(),t=!c||t.includes(d)||a.includes(d);let i=!0,l=(m&&(a=m.toLowerCase(),i=m.includes(" > ")?[e.category_1,e.category_2,e.category_3,e.category_4].filter(e=>e&&e.trim()).join(" > ").toLowerCase().includes(a):r.includes(a)||n.includes(a)||o.includes(a)||(e.category_4||"").toLowerCase().includes(a)),!0),s=((u||p)&&(!e.date||(u&&e.date<u&&(l=!1),p&&e.date>p))&&(l=!1),!0);return g&&(s=(e.store||"").toLowerCase().includes(g.toLowerCase())),t&&i&&l&&s});console.log("📊 Bulunan kayıt sayısı:",n.length),0===n.length?(document.getElementById("productResultsContainer").style.display="none",alert("❌ Arama kriterlerine uygun sonuç bulunamadı!")):(document.getElementById("productResultsContainer").style.display="block",document.getElementById("productNoResults").style.display="none",e=(lastProductSearchData=n).reduce((e,t)=>e+parseFloat(t.usd_amount||0),0),t=n.reduce((e,t)=>e+parseFloat(t.quantity||0),0),a=new Set(n.map(e=>e.product)).size,r=e/Math.max(t,1),document.getElementById("productTotalSales").textContent="$"+e.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("productTotalQty").textContent=t.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("productUniqueCount").textContent=a,document.getElementById("productAvgPrice").textContent="$"+r.toLocaleString("tr-TR",{minimumFractionDigits:2}),renderProductStoreChart(n),renderProductCityChart(n),renderProductSalesPersonChart(n),renderProductMonthlyChart(n),renderProductDetailTable(n),performProductAIAnalysis(n))}else alert("⚠️ Lütfen bir ürün/marka adı girin veya kategori seçin!")}function renderProductStoreChart(e){let a={};e.forEach(e=>{var t=e.store||"Bilinmiyor";a[t]||(a[t]={sales:0,qty:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0)});var e=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,10),t=e.map(e=>e[0]),r=e.map(e=>e[1].sales),e=e.map(e=>e[1].qty),n=document.getElementById("productStoreChart");n&&(productStoreChartInstance&&productStoreChartInstance.destroy(),productStoreChartInstance=new Chart(n,{type:"bar",data:{labels:t,datasets:[{label:"Satış (USD - KDV Hariç)",data:r,backgroundColor:"rgba(102, 126, 234, 0.6)",borderColor:"rgba(102, 126, 234, 1)",borderWidth:2,yAxisID:"y"},{label:"Miktar",data:e,backgroundColor:"rgba(255, 159, 64, 0.6)",borderColor:"rgba(255, 159, 64, 1)",borderWidth:2,yAxisID:"y"}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"},tooltip:{callbacks:{label:function(e){var t=e.dataset.label||"";return"Satış (USD)"===t?t+": $"+e.parsed.x.toLocaleString("tr-TR",{minimumFractionDigits:2}):t+": "+e.parsed.x.toLocaleString("tr-TR",{minimumFractionDigits:2})}}}},scales:{x:{beginAtZero:!0,ticks:{callback:function(e){return e.toLocaleString("tr-TR")}}}}}}))}function renderProductCityChart(e){let a={};e.forEach(e=>{var t=e.city||"Bilinmiyor";a[t]||(a[t]={sales:0,qty:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0)});var e=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,10),t=e.map(e=>e[0]),r=e.map(e=>e[1].sales),e=e.map(e=>e[1].qty),n=document.getElementById("productCityChart");n&&(productCityChartInstance&&productCityChartInstance.destroy(),productCityChartInstance=new Chart(n,{type:"bar",data:{labels:t,datasets:[{label:"Satış (USD - KDV Hariç)",data:r,backgroundColor:"rgba(56, 239, 125, 0.6)",borderColor:"rgba(56, 239, 125, 1)",borderWidth:2,yAxisID:"y"},{label:"Miktar",data:e,backgroundColor:"rgba(255, 159, 64, 0.6)",borderColor:"rgba(255, 159, 64, 1)",borderWidth:2,yAxisID:"y"}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"},tooltip:{callbacks:{label:function(e){var t=e.dataset.label||"";return"Satış (USD)"===t?t+": $"+e.parsed.x.toLocaleString("tr-TR",{minimumFractionDigits:2}):t+": "+e.parsed.x.toLocaleString("tr-TR",{minimumFractionDigits:2})}}}},scales:{x:{beginAtZero:!0,ticks:{callback:function(e){return e.toLocaleString("tr-TR")}}}}}}))}function renderProductSalesPersonChart(e){let a={};e.forEach(e=>{var t=e.sales_person||"Bilinmiyor";a[t]||(a[t]={sales:0,qty:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0)});var e=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,10),t=e.map(e=>e[0]),r=e.map(e=>e[1].sales),e=e.map(e=>e[1].qty),n=document.getElementById("productSalesPersonChart");n&&(productSalesPersonChartInstance&&productSalesPersonChartInstance.destroy(),productSalesPersonChartInstance=new Chart(n,{type:"bar",data:{labels:t,datasets:[{label:"Satış (USD - KDV Hariç)",data:r,backgroundColor:"rgba(245, 87, 108, 0.6)",borderColor:"rgba(245, 87, 108, 1)",borderWidth:2,yAxisID:"y"},{label:"Miktar",data:e,backgroundColor:"rgba(255, 159, 64, 0.6)",borderColor:"rgba(255, 159, 64, 1)",borderWidth:2,yAxisID:"y"}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"},tooltip:{callbacks:{label:function(e){var t=e.dataset.label||"";return"Satış (USD)"===t?t+": $"+e.parsed.x.toLocaleString("tr-TR",{minimumFractionDigits:2}):t+": "+e.parsed.x.toLocaleString("tr-TR",{minimumFractionDigits:2})}}}},scales:{x:{beginAtZero:!0,ticks:{callback:function(e){return e.toLocaleString("tr-TR")}}}}}}))}function renderProductMonthlyChart(e){let r={};e.forEach(e=>{var t,a;e.date&&(t=e.date.substring(0,4),a=parseInt(e.date.substring(5,7)),r[t]||(r[t]={}),r[t][a]||(r[t][a]=0),r[t][a]+=parseFloat(e.usd_amount||0))});e=Object.keys(r).sort();let n=[{bg:"rgba(102, 126, 234, 0.2)",border:"rgba(102, 126, 234, 1)"},{bg:"rgba(240, 147, 251, 0.2)",border:"rgba(240, 147, 251, 1)"},{bg:"rgba(255, 159, 64, 0.2)",border:"rgba(255, 159, 64, 1)"},{bg:"rgba(75, 192, 192, 0.2)",border:"rgba(75, 192, 192, 1)"},{bg:"rgba(255, 99, 132, 0.2)",border:"rgba(255, 99, 132, 1)"}];var e=e.map((t,e)=>{let a=Array(12).fill(0);Object.keys(r[t]).forEach(e=>{a[parseInt(e)-1]=r[t][e]});e=n[e%n.length];return{label:t,data:a,backgroundColor:e.bg,borderColor:e.border,borderWidth:3,fill:!0,tension:.4}}),t=document.getElementById("productMonthlyChart");t&&(productMonthlyChartInstance&&productMonthlyChartInstance.destroy(),productMonthlyChartInstance=new Chart(t,{type:"line",data:{labels:["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"],datasets:e},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"},tooltip:{callbacks:{label:function(e){return e.dataset.label+": $"+e.parsed.y.toLocaleString("tr-TR",{minimumFractionDigits:2})}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+(e/1e3).toFixed(0)+"K"}}}}}}))}function renderProductDetailTable(e=null,t=null,a){if((e=(e=null===e&&lastProductSearchData?lastProductSearchData:e)&&e.filter(e=>!e._isDiscount))&&0!==e.length){null!==t&&(currentSortDirection=currentSortColumn===t?"asc"===currentSortDirection?"desc":"asc":(currentSortColumn=t,"desc"));let r={};e.forEach(e=>{var t,a=e.product||"Bilinmiyor";r[a]||(t=0<(t=[e.category_1,e.category_2,e.category_3,e.category_4].filter(e=>e&&e.trim()&&"all"!==e.toLowerCase())).length?t.join(" › "):"Bilinmiyor",r[a]={brand:e.brand||"Bilinmiyor",category:t,sales:0,qty:0,count:0}),r[a].sales+=parseFloat(e.usd_amount||0),r[a].qty+=parseFloat(e.quantity||0),r[a].count+=1}),(currentProductData=Object.entries(r)).sort((e,t)=>{let a,r;return"product"===currentSortColumn?(a=e[0].toLowerCase(),r=t[0].toLowerCase(),"asc"===currentSortDirection?a.localeCompare(r):r.localeCompare(a)):"brand"===currentSortColumn?(a=e[1].brand.toLowerCase(),r=t[1].brand.toLowerCase(),"asc"===currentSortDirection?a.localeCompare(r):r.localeCompare(a)):"category"===currentSortColumn?(a=e[1].category.toLowerCase(),r=t[1].category.toLowerCase(),"asc"===currentSortDirection?a.localeCompare(r):r.localeCompare(a)):("sales"===currentSortColumn?(a=e[1].sales,r=t[1].sales):"qty"===currentSortColumn?(a=e[1].qty,r=t[1].qty):"count"===currentSortColumn?(a=e[1].count,r=t[1].count):"avgPrice"===currentSortColumn&&(a=e[1].sales/Math.max(e[1].qty,1),r=t[1].sales/Math.max(t[1].qty,1)),"asc"===currentSortDirection?a-r:r-a)});t=e=>currentSortColumn===e?"asc"===currentSortDirection?" ▲":" ▼":" ⇅";let n=`
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd;">#</th>
                            <th onclick="renderProductDetailTable(null, 'product')" style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sıralamak için tıklayın">
                                Ürün${t("product")}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'brand')" style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sıralamak için tıklayın">
                                Marka${t("brand")}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'category')" style="padding: 15px; text-align: left; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sıralamak için tıklayın">
                                Kategori${t("category")}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'sales')" style="padding: 15px; text-align: right; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sıralamak için tıklayın">
                                Satış (USD)${t("sales")}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'qty')" style="padding: 15px; text-align: right; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sıralamak için tıklayın">
                                Miktar${t("qty")}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'count')" style="padding: 15px; text-align: right; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sıralamak için tıklayın">
                                İşlem${t("count")}
                            </th>
                            <th onclick="renderProductDetailTable(null, 'avgPrice')" style="padding: 15px; text-align: right; border-bottom: 2px solid #ddd; cursor: pointer; user-select: none;" title="Sıralamak için tıklayın">
                                Sepet Ort.${t("avgPrice")}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
            `;e=currentProductData.slice(0,30),t=30<currentProductData.length;e.forEach((e,t)=>{var a=e[0],e=e[1],r=e.sales/Math.max(e.count,1);n+=`
                    <tr style="border-bottom: 1px solid #eee; ${t%2==0?"background: #f8f9fa;":""}">
                        <td style="padding: 12px;">${t+1}</td>
                        <td style="padding: 12px;"><strong>${a}</strong></td>
                        <td style="padding: 12px;">${e.brand}</td>
                        <td style="padding: 12px;">${e.category}</td>
                        <td style="padding: 12px; text-align: right; color: #38ef7d; font-weight: bold;">$${e.sales.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                        <td style="padding: 12px; text-align: right;">${e.qty.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                        <td style="padding: 12px; text-align: right;">${e.count}</td>
                        <td style="padding: 12px; text-align: right;">$${r.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                    </tr>
                `}),t&&(n+=`
                    <tr style="background: #fffbeb; border-top: 2px solid #fbbf24;">
                        <td colspan="8" style="padding: 15px; text-align: center; color: #92400e; font-weight: 600;">
                            ℹ️ İlk 30 ürün gösteriliyor (Toplam: ${currentProductData.length} ürün). Daha fazlası için filtreleri daraltabilirsiniz.
                        </td>
                    </tr>
                `),n+=`
                    </tbody>
                </table>
            `,document.getElementById("productDetailTable").innerHTML=n}else document.getElementById("productDetailTable").innerHTML='<p style="text-align: center; padding: 20px;">Veri bulunamadı</p>'}function performProductAIAnalysis(e){console.log("🤖 Ürün analizi AI değerlendirmesi başlatılıyor...");let r=e.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0);var t=e.reduce((e,t)=>e+parseFloat(t.quantity||0),0),n=new Set(e.map(e=>e.product)).size,a=r/Math.max(t,1);let o={};e.forEach(e=>{var t=e.store||"Bilinmiyor";o[t]||(o[t]={sales:0,qty:0}),o[t].sales+=parseFloat(e.usd_amount||0),o[t].qty+=parseFloat(e.quantity||0)});var i=Object.entries(o).sort((e,t)=>t[1].sales-e[1].sales).slice(0,3);let l={};e.forEach(e=>{var t=e.city||"Bilinmiyor";l[t]||(l[t]={sales:0,qty:0}),l[t].sales+=parseFloat(e.usd_amount||0),l[t].qty+=parseFloat(e.quantity||0)});var s=Object.entries(l).sort((e,t)=>t[1].sales-e[1].sales).slice(0,3);let d={};e.forEach(e=>{var t=e.sales_person||"Bilinmiyor";d[t]||(d[t]={sales:0,qty:0}),d[t].sales+=parseFloat(e.usd_amount||0),d[t].qty+=parseFloat(e.quantity||0)});var c=Object.entries(d).sort((e,t)=>t[1].sales-e[1].sales).slice(0,3);let m={};e.forEach(e=>{var t=e.brand||"Bilinmiyor";m[t]||(m[t]={sales:0,qty:0}),m[t].sales+=parseFloat(e.usd_amount||0),m[t].qty+=parseFloat(e.quantity||0)});var g=Object.entries(m).sort((e,t)=>t[1].sales-e[1].sales).slice(0,3);let u={};e.forEach(e=>{var t=e.category_1||"Bilinmiyor";u[t]||(u[t]={sales:0,qty:0}),u[t].sales+=parseFloat(e.usd_amount||0),u[t].qty+=parseFloat(e.quantity||0)});var p,y=Object.entries(u).sort((e,t)=>t[1].sales-e[1].sales).slice(0,3),h={positive:[],negative:[],neutral:[],recommendations:[]};if(0<i.length&&(p=((b=i[0])[1].sales/r*100).toFixed(1),h.positive.push({title:`🏪 ${b[0]} Lider Mağaza`,description:`${b[0]} mağazası toplam satışın %${p}'ini gerçekleştirdi ($${b[1].sales.toLocaleString("tr-TR",{minimumFractionDigits:2})} / ${b[1].qty.toLocaleString("tr-TR",{minimumFractionDigits:2})} adet). Bu mağaza bu ürün/marka için en güçlü performansı gösteriyor.`})),0<s.length&&(b=((p=s[0])[1].sales/r*100).toFixed(1),h.positive.push({title:`🌍 ${p[0]} Önde Gelen İl`,description:`${p[0]} ili toplam satışın %${b}'ini oluşturuyor ($${p[1].sales.toLocaleString("tr-TR",{minimumFractionDigits:2})} / ${p[1].qty.toLocaleString("tr-TR",{minimumFractionDigits:2})} adet). Bu bölgede güçlü talep var.`})),0<c.length&&(b=c.slice(0,Math.min(5,c.length)).map((e,t)=>{var a=(e[1].sales/r*100).toFixed(1);return`${t+1}. ${e[0]} (%${a}, $${e[1].sales.toLocaleString("tr-TR",{minimumFractionDigits:2})})`}).join(" | "),h.positive.push({title:"👤 En Başarılı 5 Temsilci",description:b})),h.neutral.push({title:"📊 Genel Performans",description:`Toplam ${n} farklı ürün, ${t.toLocaleString("tr-TR",{minimumFractionDigits:2})} adet satıldı. Ortalama ürün fiyatı $${a.toLocaleString("tr-TR",{minimumFractionDigits:2})}.`}),0<g.length&&(p=g.map(e=>{var t=(e[1].sales/r*100).toFixed(1);return e[0]+` (%${t})`}).join(", "),h.neutral.push({title:"🏷️ Marka Dağılımı",description:`En çok satan markalar: ${p}. Bu markalar toplam satışın büyük kısmını oluşturuyor.`})),0<y.length){let a={};e.forEach(e=>{var t=e.category_2||"Bilinmiyor";"all"===t.toLowerCase()||"bilinmiyor"===t.toLowerCase()||t.toLowerCase().includes("analitik")||t.toLowerCase().includes("eğitim")||(a[t]||(a[t]={sales:0,qty:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0))});var b=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,3);0<b.length&&(n=b.map(e=>{var t=(e[1].sales/r*100).toFixed(1);return e[0]+` (%${t})`}).join(", "),h.neutral.push({title:"📂 Kategori Dağılımı",description:`En çok satan kategoriler: ${n}. Bu kategorilerde yoğunlaşma var.`}))}1<i.length&&(t=i[0],g=i[1],b=((e=(p=t[1].sales)-(y=g[1].sales))/y*100).toFixed(1),n=Object.keys(o).length,y=(p/r*100).toFixed(1),30<b)&&h.negative.push({title:"⚠️ Mağazalar Arası Performans Farkı",description:`${t[0]} mağazası toplam ${n} mağaza içinde lider (%${y} pay). ${g[0]} mağazasından $${e.toLocaleString("tr-TR",{minimumFractionDigits:2})} (%${b}) daha fazla satış yapıyor. Diğer mağazalarda stok, teşhir, personel eğitimi ve pazarlama açısından iyileştirme potansiyeli var.`}),5<Object.keys(l).length&&.5<s[0][1].sales/r&&h.negative.push({title:"🌍 Coğrafi Yoğunlaşma",description:`Satışların büyük kısmı ${s[0][0]} ilinde yoğunlaşmış. Diğer illerde pazar payı artırma fırsatı var.`}),h.recommendations.push({icon:"🎯",title:"Stok Optimizasyonu",description:i[0][0]+" mağazasında bu ürün/marka için stok seviyesini artırın. Bu mağaza en yüksek satış performansını gösteriyor ve stok tükenmesi riski var."}),h.recommendations.push({icon:"📍",title:"Coğrafi Genişleme",description:`${s[0][0]} ilindeki başarıyı analiz edin ve benzer demografik özelliklere sahip diğer illerde (${s.slice(1,3).map(e=>e[0]).join(", ")}) pazarlama kampanyaları düzenleyin.`}),h.recommendations.push({icon:"👥",title:"Temsilci Eğitimi",description:c[0][0]+"'in satış tekniklerini diğer temsilcilerle paylaşın. Bu temsilcinin başarı stratejilerini eğitim programına dahil edin."}),300<a&&h.recommendations.push({icon:"💳",title:"Ödeme Kolaylığı",description:`Ortalama ürün fiyatı $${a.toLocaleString("tr-TR",{minimumFractionDigits:2})} gibi yüksek bir seviyede. Taksit seçenekleri ve finansman imkanları sunarak satışları artırabilirsiniz.`}),3<=i.length&&(p=i[2])[1].sales<.3*i[0][1].sales&&h.recommendations.push({icon:"📢",title:"Düşük Performanslı Mağazalar",description:p[0]+" ve benzeri mağazalarda özel promosyonlar düzenleyin. Bu mağazalarda satış potansiyeli henüz tam olarak kullanılmamış."});t=`
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">
                    ${0<h.positive.length?`
                    <div class="analysis-section">
                        <h3 style="color: white; margin-top: 0;">✅ Güçlü Yönler</h3>
                        ${h.positive.map(e=>`
                            <div class="insight-item insight-positive" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">✅</span>
                                <strong style="font-size: 1.1em;">${e.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${e.description}</span>
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    ${0<h.negative.length?`
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">⚠️ Dikkat Edilmesi Gerekenler</h3>
                        ${h.negative.map(e=>`
                            <div class="insight-item insight-negative" style="background: rgba(245, 87, 108, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #f5576c;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">⚠️</span>
                                <strong style="font-size: 1.1em;">${e.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${e.description}</span>
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    ${0<h.neutral.length?`
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">💡 Genel Bilgiler</h3>
                        ${h.neutral.map(e=>`
                            <div class="insight-item insight-neutral" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">💡</span>
                                <strong style="font-size: 1.1em;">${e.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${e.description}</span>
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">🎯 Aksiyon Önerileri</h3>
                        ${h.recommendations.map(e=>`
                            <div class="recommendation" style="background: rgba(255, 255, 255, 0.15); padding: 18px; border-radius: 10px; margin: 12px 0;">
                                <span class="recommendation-icon" style="font-size: 1.8em; margin-right: 12px;">${e.icon}</span>
                                <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px);">
                                    <strong style="font-size: 1.15em; display: block; margin-bottom: 8px;">${e.title}</strong>
                                    <p style="margin: 0; opacity: 0.95; line-height: 1.6;">${e.description}</p>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                </div>
            `;document.getElementById("productAIAnalysisContent").innerHTML=t,document.getElementById("productAIAnalysisPanel").style.display="block"}let queryCostTracker={totalQueries:parseInt(localStorage.getItem("gpt_total_queries")||"0"),totalCost:parseFloat(localStorage.getItem("gpt_total_cost")||"0"),monthlyQueries:parseInt(localStorage.getItem("gpt_monthly_queries")||"0"),monthlyCost:parseFloat(localStorage.getItem("gpt_monthly_cost")||"0"),lastResetDate:localStorage.getItem("gpt_last_reset")||(new Date).toISOString().slice(0,7)};function checkMonthlyReset(){var e=(new Date).toISOString().slice(0,7);queryCostTracker.lastResetDate!==e&&(queryCostTracker.monthlyQueries=0,queryCostTracker.monthlyCost=0,queryCostTracker.lastResetDate=e,localStorage.setItem("gpt_monthly_queries","0"),localStorage.setItem("gpt_monthly_cost","0"),localStorage.setItem("gpt_last_reset",e))}function updateQueryCost(e,t,a){checkMonthlyReset();let r=0;return"gpt-3.5-turbo"===e?r=t/1e3*5e-4+a/1e3*.0015:"gpt-4-turbo"===e?r=t/1e3*.01+a/1e3*.03:"gpt-4o-mini"===e&&(r=t/1e3*15e-5+a/1e3*6e-4),queryCostTracker.totalQueries++,queryCostTracker.totalCost+=r,queryCostTracker.monthlyQueries++,queryCostTracker.monthlyCost+=r,localStorage.setItem("gpt_total_queries",queryCostTracker.totalQueries.toString()),localStorage.setItem("gpt_total_cost",queryCostTracker.totalCost.toFixed(4)),localStorage.setItem("gpt_monthly_queries",queryCostTracker.monthlyQueries.toString()),localStorage.setItem("gpt_monthly_cost",queryCostTracker.monthlyCost.toFixed(4)),console.log(`💰 GPT Maliyet: $${r.toFixed(4)} | Aylık Toplam: $${queryCostTracker.monthlyCost.toFixed(2)} (${queryCostTracker.monthlyQueries} sorgu)`),r}async function callGPTAPI(e,t){console.log("🤖 GPT API çağrısı hazırlanıyor..."),console.log("📝 Sorgu:",e),console.log("📊 Context boyutu:",JSON.stringify(t).length,"karakter");try{var a,r=await fetch("YOUR_BACKEND_URL_HERE",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({query:e,context:t,model:"gpt-3.5-turbo"})});if(r.ok)return(a=await r.json()).usage&&updateQueryCost(a.model||"gpt-3.5-turbo",a.usage.prompt_tokens,a.usage.completion_tokens),{success:!0,answer:a.answer,model:a.model,cost:a.cost};throw new Error("Backend error: "+r.status)}catch(e){return console.error("❌ GPT API Hatası:",e),{success:!1,error:e.message}}}function showCostStats(){checkMonthlyReset();var e=`
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 15px; border-radius: 10px; margin: 10px 0;">
                    <h4 style="margin: 0 0 10px 0;">💰 GPT Maliyet İstatistikleri</h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <strong>Bu Ay:</strong><br>
                            ${queryCostTracker.monthlyQueries} sorgu<br>
                            $${queryCostTracker.monthlyCost.toFixed(2)} (~${(30*queryCostTracker.monthlyCost).toFixed(0)} TL)
                        </div>
                        <div>
                            <strong>Toplam:</strong><br>
                            ${queryCostTracker.totalQueries} sorgu<br>
                            $${queryCostTracker.totalCost.toFixed(2)}
                        </div>
                    </div>
                    <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.9;">
                        📊 Ortalama: $${(queryCostTracker.monthlyCost/Math.max(queryCostTracker.monthlyQueries,1)).toFixed(4)}/sorgu
                    </div>
                </div>
            `,t=document.getElementById("debugPanel");t&&"block"===t.style.display&&(document.getElementById("debugInfo").innerHTML+=e)}window.showGPTStats=function(){checkMonthlyReset(),console.log("💰 GPT Maliyet İstatistikleri:"),console.log("Bu Ay:",queryCostTracker.monthlyQueries,"sorgu, $"+queryCostTracker.monthlyCost.toFixed(2)),console.log("Toplam:",queryCostTracker.totalQueries,"sorgu, $"+queryCostTracker.totalCost.toFixed(2)),console.log("Ortalama:","$"+(queryCostTracker.monthlyCost/Math.max(queryCostTracker.monthlyQueries,1)).toFixed(4),"per sorgu")},window.resetGPTStats=function(){confirm("Tüm GPT maliyet istatistiklerini sıfırlamak istediğinize emin misiniz?")&&(localStorage.removeItem("gpt_total_queries"),localStorage.removeItem("gpt_total_cost"),localStorage.removeItem("gpt_monthly_queries"),localStorage.removeItem("gpt_monthly_cost"),localStorage.removeItem("gpt_last_reset"),queryCostTracker={totalQueries:0,totalCost:0,monthlyQueries:0,monthlyCost:0,lastResetDate:(new Date).toISOString().slice(0,7)},console.log("✅ GPT maliyet istatistikleri sıfırlandı."))},console.log("✅ GPT Backend hazır! Kullanım:"),console.log("   showGPTStats() - Maliyet istatistiklerini göster"),console.log("   resetGPTStats() - Maliyet istatistiklerini sıfırla");let customerBrandChartMainInstance=null,customerCategoryChartMainInstance=null;function searchCustomerProfileMain(){let t=document.getElementById("customerSearchInputMain").value.trim().toLowerCase();var e,a,r,n,o,i,l,s;t?(console.log("🔍 Müşteri aranıyor:",t),0===(e=allData.filter(e=>e.partner&&e.partner.toLowerCase().includes(t))).length?(document.getElementById("customerProfileMainContainer").style.display="none",alert("Müşteri bulunamadı. Lütfen farklı bir isim deneyin.")):(document.getElementById("customerProfileMainContainer").style.display="block",document.getElementById("topCustomersSection").style.display="none",document.getElementById("customerChartsSection").style.display="none",a=e[0].partner,r=e[0].city||"Bilinmiyor",n=e[0].tags||"-",o=e.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0),i=e.reduce((e,t)=>e+parseFloat(t.quantity||0),0),l=new Set(e.map(e=>e.date)).size,s=o/Math.max(l,1),document.getElementById("customerNameMain").textContent=a,document.getElementById("customerCityMain").textContent=r,document.getElementById("customerTagsMain").textContent=n,document.getElementById("customerTotalSalesMain").textContent="$"+o.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("customerTotalQtyMain").textContent=i.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("customerTransactionCountMain").textContent=l,document.getElementById("customerAvgBasketMain").textContent="$"+s.toLocaleString("tr-TR",{minimumFractionDigits:2}),renderCustomerBrandChartMain(e),renderCustomerCategoryChartMain(e),renderCustomerPurchaseHistoryMain(lastCustomerPurchaseData=e),performCustomerAIAnalysisMain(e,{name:a,city:r,tags:n,totalSales:o,totalQty:i,transactionCount:l,avgBasket:s}),document.getElementById("customerProfileMainContainer").scrollIntoView({behavior:"smooth",block:"start"}))):alert("Lütfen bir müşteri adı girin")}function clearCustomerSearchMain(){document.getElementById("customerSearchInputMain").value="",document.getElementById("customerProfileMainContainer").style.display="none",document.getElementById("topCustomersSection").style.display="block",document.getElementById("customerChartsSection").style.display="grid",console.log("✅ Müşteri araması temizlendi, Top 30 ve grafikler gösteriliyor")}function renderCustomerBrandChartMain(e){let a={};e.forEach(e=>{var t=e.brand||"Bilinmiyor";a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0)});var e=Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,10),t=e.map(e=>e[0]),e=e.map(e=>e[1]),r=document.getElementById("customerBrandChartMain");r&&(customerBrandChartMainInstance&&customerBrandChartMainInstance.destroy(),customerBrandChartMainInstance=new Chart(r,{type:"bar",data:{labels:t,datasets:[{label:"Satış (USD - KDV Hariç)",data:e,backgroundColor:"rgba(102, 126, 234, 0.6)",borderColor:"rgba(102, 126, 234, 1)",borderWidth:2}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}}))}function renderCustomerCategoryChartMain(e){let a={};e.forEach(e=>{var t=e.category_2||e.category_1||"Bilinmiyor";a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0)});var e=Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,10),t=e.map(e=>e[0]),e=e.map(e=>e[1]),r=document.getElementById("customerCategoryChartMain");r&&(customerCategoryChartMainInstance&&customerCategoryChartMainInstance.destroy(),customerCategoryChartMainInstance=new Chart(r,{type:"bar",data:{labels:t,datasets:[{label:"Satış (USD - KDV Hariç)",data:e,backgroundColor:"rgba(56, 239, 125, 0.6)",borderColor:"rgba(56, 239, 125, 1)",borderWidth:2}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}}))}function renderCustomerPurchaseHistoryMain(t=null,r=null,e){if((t=(t=null===t&&lastCustomerPurchaseData?lastCustomerPurchaseData:t)&&t.filter(e=>!e._isDiscount))&&0!==t.length){null!==r&&(currentCustomerPurchaseSortDirection=currentCustomerPurchaseSortColumn===r?"asc"===currentCustomerPurchaseSortDirection?"desc":"asc":"date"===(currentCustomerPurchaseSortColumn=r)?"desc":"asc");let e=[...t];"date"===currentCustomerPurchaseSortColumn?e.sort((e,t)=>{e=new Date(e.date),t=new Date(t.date);return"asc"===currentCustomerPurchaseSortDirection?e-t:t-e}):"product"===currentCustomerPurchaseSortColumn?e.sort((e,t)=>"asc"===currentCustomerPurchaseSortDirection?(e.product||"").localeCompare(t.product||"","tr"):(t.product||"").localeCompare(e.product||"","tr")):"brand"===currentCustomerPurchaseSortColumn?e.sort((e,t)=>"asc"===currentCustomerPurchaseSortDirection?(e.brand||"").localeCompare(t.brand||"","tr"):(t.brand||"").localeCompare(e.brand||"","tr")):"quantity"===currentCustomerPurchaseSortColumn?e.sort((e,t)=>"asc"===currentCustomerPurchaseSortDirection?parseFloat(e.quantity||0)-parseFloat(t.quantity||0):parseFloat(t.quantity||0)-parseFloat(e.quantity||0)):"amount"===currentCustomerPurchaseSortColumn?e.sort((e,t)=>"asc"===currentCustomerPurchaseSortDirection?parseFloat(e.usd_amount||0)-parseFloat(t.usd_amount||0):parseFloat(t.usd_amount||0)-parseFloat(e.usd_amount||0)):"store"===currentCustomerPurchaseSortColumn&&e.sort((e,t)=>"asc"===currentCustomerPurchaseSortDirection?(e.store||"").localeCompare(t.store||"","tr"):(t.store||"").localeCompare(e.store||"","tr")),e=e.slice(0,20);r=e=>currentCustomerPurchaseSortColumn!==e?"⇅":"asc"===currentCustomerPurchaseSortDirection?"↑":"↓";let a=`
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'date')">
                                Tarih ${r("date")}
                            </th>
                            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'product')">
                                Ürün ${r("product")}
                            </th>
                            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'brand')">
                                Marka ${r("brand")}
                            </th>
                            <th style="padding: 12px; text-align: right; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'quantity')">
                                Adet ${r("quantity")}
                            </th>
                            <th style="padding: 12px; text-align: right; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'amount')">
                                Tutar ${r("amount")}
                            </th>
                            <th style="padding: 12px; text-align: left; cursor: pointer;" onclick="renderCustomerPurchaseHistoryMain(null, 'store')">
                                Mağaza ${r("store")}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
            `;e.forEach((e,t)=>{a+=`
                    <tr style="border-bottom: 1px solid #eee; ${t%2==0?"background: #f8f9fa;":""}">
                        <td style="padding: 10px;">${e.date}</td>
                        <td style="padding: 10px;"><strong>${e.product}</strong></td>
                        <td style="padding: 10px;">${e.brand}</td>
                        <td style="padding: 10px; text-align: right;">${parseFloat(e.quantity||0).toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                        <td style="padding: 10px; text-align: right; color: #38ef7d; font-weight: bold;">$${parseFloat(e.usd_amount||0).toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                        <td style="padding: 10px;">${e.store}</td>
                    </tr>
                `}),a+=`
                    </tbody>
                </table>
            `,document.getElementById("customerPurchaseHistoryMain").innerHTML=a}else document.getElementById("customerPurchaseHistoryMain").innerHTML='<p style="text-align: center; padding: 20px;">Veri bulunamadı</p>'}function performCustomerAIAnalysisMain(e,t){console.log("🤖 Müşteri AI analizi başlatılıyor...",t);let a={},r={},n={},o={};e.forEach(e=>{var t=e.brand||"Bilinmiyor",t=(a[t]||(a[t]={sales:0,qty:0,count:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0),a[t].count+=1,e.category_2||e.category_1||"Bilinmiyor"),t=(r[t]||(r[t]={sales:0,qty:0}),r[t].sales+=parseFloat(e.usd_amount||0),r[t].qty+=parseFloat(e.quantity||0),e.store||"Bilinmiyor"),t=(n[t]||(n[t]={sales:0,count:0}),n[t].sales+=parseFloat(e.usd_amount||0),n[t].count+=1,e.date?e.date.substring(0,7):"Bilinmiyor");o[t]||(o[t]=0),o[t]+=parseFloat(e.usd_amount||0)});var i=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,3),l=Object.entries(r).sort((e,t)=>t[1].sales-e[1].sales).slice(0,3),s=Object.entries(n).sort((e,t)=>t[1].sales-e[1].sales).slice(0,3),d=Object.entries(o).sort((e,t)=>new Date(t[0])-new Date(e[0])).slice(0,6);let c={};e.forEach(e=>{var t=e.product||"Bilinmiyor";c[t]||(c[t]={qty:0,sales:0}),c[t].qty+=parseFloat(e.quantity||0),c[t].sales+=parseFloat(e.usd_amount||0)});var m=Object.entries(c).sort((e,t)=>t[1].qty-e[1].qty)[0],g={positive:[],negative:[],neutral:[],recommendations:[]},e=(1e4<t.totalSales?g.positive.push({title:"💎 VIP Müşteri",description:`${t.name}, toplam $${t.totalSales.toLocaleString("tr-TR",{minimumFractionDigits:2})} alışveriş ile VIP müşteri kategorisinde. Bu müşteriye özel ilgi gösterilmeli.`}):5e3<t.totalSales&&g.positive.push({title:"⭐ Değerli Müşteri",description:`${t.name}, toplam $${t.totalSales.toLocaleString("tr-TR",{minimumFractionDigits:2})} alışveriş ile değerli müşteri kategorisinde.`}),10<t.transactionCount&&g.positive.push({title:"🔄 Sadık Müşteri",description:t.transactionCount+" işlem ile düzenli alışveriş yapan sadık bir müşteri. Müşteri memnuniyeti yüksek."}),1e3<t.avgBasket&&g.positive.push({title:"🛒 Yüksek Sepet Ortalaması",description:`Ortalama sepet tutarı $${t.avgBasket.toLocaleString("tr-TR",{minimumFractionDigits:2})}. Premium ürünlere ilgi gösteriyor.`}),0<i.length&&g.positive.push({title:"🏷️ Favori Marka: "+i[0][0],description:`${i[0][0]} markasından $${i[0][1].sales.toLocaleString("tr-TR",{minimumFractionDigits:2})} değerinde ${i[0][1].count} adet ürün aldı. Bu markada yeni ürünler önerilmeli.`}),t.transactionCount<3&&g.negative.push({title:"⚠️ Yeni Müşteri",description:`Sadece ${t.transactionCount} işlem gerçekleştirdi. Müşteri sadakati oluşturmak için özel kampanyalar sunulmalı.`}),t.avgBasket<500&&g.negative.push({title:"📊 Düşük Sepet Ortalaması",description:`Ortalama sepet tutarı $${t.avgBasket.toLocaleString("tr-TR",{minimumFractionDigits:2})}. Cross-sell ve up-sell fırsatları değerlendirilmeli.`}),0<e.length?new Date(Math.max(...e.map(e=>new Date(e.date)))):null),m=(e&&90<(e=Math.floor((new Date-e)/864e5))&&g.negative.push({title:"⏰ Uzun Süredir Alışveriş Yok",description:`Son alışverişten ${e} gün geçti. Müşteriyi geri kazanmak için hatırlatma kampanyası düzenlenebilir.`}),g.neutral.push({title:"📍 Konum Bilgisi",description:`Müşteri ${t.city} şehrinden alışveriş yapıyor. `+(0<s.length?`En çok ${s[0][0]} mağazasını tercih ediyor.`:"")}),0<l.length&&g.neutral.push({title:"📂 İlgi Alanı: "+l[0][0],description:`${l[0][0]} kategorisinden $${l[0][1].sales.toLocaleString("tr-TR",{minimumFractionDigits:2})} değerinde alışveriş yaptı.`}),m&&g.neutral.push({title:"🎯 En Çok Aldığı Ürün",description:`${m[0]} ürününden ${m[1].qty.toLocaleString("tr-TR",{minimumFractionDigits:2})} adet aldı.`}),1<i.length&&g.recommendations.push({icon:"🎁",title:"Çapraz Satış Fırsatı",description:`Müşteri ${i.map(e=>e[0]).join(", ")} markalarını tercih ediyor. Bu markaların yeni ürünleri ve aksesuarları önerilebilir.`}),500<t.avgBasket&&g.recommendations.push({icon:"💳",title:"Premium Ürün Önerisi",description:"Yüksek sepet ortalaması nedeniyle premium ve lüks ürünler önerilebilir. Özel koleksiyonlar sunulmalı."}),5<t.transactionCount&&g.recommendations.push({icon:"🎖️",title:"Sadakat Programı",description:"Düzenli müşteri olduğu için sadakat programına dahil edilmeli. Özel indirimler ve erken erişim fırsatları sunulabilir."}),0<s.length&&g.recommendations.push({icon:"🏪",title:"Mağaza Bazlı Kampanya",description:s[0][0]+" mağazasını sıklıkla tercih ediyor. Bu mağazada özel etkinlikler ve lansmanlar için davet gönderilebilir."}),g.recommendations.push({icon:"📧",title:"Kişiselleştirilmiş İletişim",description:`${0<l.length?l[0][0]:"İlgi alanı"} kategorisindeki yeni ürünler hakkında e-posta veya SMS ile bilgilendirme yapılabilir.`}),0<d.length&&(e=d.reduce((e,t)=>e+t[1],0)/d.length,g.recommendations.push({icon:"📊",title:"Alışveriş Tahmini",description:`Aylık ortalama $${e.toLocaleString("tr-TR",{minimumFractionDigits:2})} alışveriş yapıyor. Gelecek ay için özel teklifler hazırlanabilir.`})),`
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">
                    ${0<g.positive.length?`
                    <div class="analysis-section">
                        <h3 style="color: white; margin-top: 0;">✅ Güçlü Yönler</h3>
                        ${g.positive.map(e=>`
                            <div class="insight-item insight-positive" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">✅</span>
                                <strong style="font-size: 1.1em;">${e.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${e.description}</span>
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    ${0<g.negative.length?`
                    <div class="analysis-section" style="margin-top: 30px;">
                        <h3 style="color: white;">⚠️ Dikkat Edilmesi Gerekenler</h3>
                        ${g.negative.map(e=>`
                            <div class="insight-item insight-negative" style="background: rgba(255, 107, 107, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ff6b6b;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">⚠️</span>
                                <strong style="font-size: 1.1em;">${e.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${e.description}</span>
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    ${0<g.neutral.length?`
                    <div class="analysis-section" style="margin-top: 30px;">
                        <h3 style="color: white;">📊 Genel Bilgiler</h3>
                        ${g.neutral.map(e=>`
                            <div class="insight-item insight-neutral" style="background: rgba(255, 255, 255, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid white;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">📊</span>
                                <strong style="font-size: 1.1em;">${e.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${e.description}</span>
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    ${0<g.recommendations.length?`
                    <div class="analysis-section" style="margin-top: 30px;">
                        <h3 style="color: white;">💡 Aksiyon Önerileri</h3>
                        ${g.recommendations.map(e=>`
                            <div class="recommendation" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700; display: flex; align-items: start; gap: 15px;">
                                <span class="recommendation-icon" style="font-size: 2em; flex-shrink: 0;">${e.icon}</span>
                                <div style="flex: 1;">
                                    <strong style="font-size: 1.1em; display: block; margin-bottom: 5px;">${e.title}</strong>
                                    <span style="opacity: 0.95;">${e.description}</span>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                </div>
            `);document.getElementById("customerAIAnalysisContentMain").innerHTML=m,document.getElementById("customerAIAnalysisPanelMain").style.display="block"}let customerBrandChartInstance=null,customerCategoryChartInstance=null,customerStoreChartInstance=null,customerMonthlyTrendChartInstance=null;function populateCityDropdownForCustomerSearch(){console.log("⚠️ Bu fonksiyon artık kullanılmıyor")}let customerSuggestionIndex=-1,salespersonSuggestionIndex=-1,storeSuggestionIndex=-1,selectedCustomers=[],selectedStores=[];function showCustomerSuggestions(r){var e=document.getElementById("customerSuggestions"),t=r.split(","),t=t[t.length-1].trim().toLowerCase();if((r=t).length<2)e.style.display="none";else if(allData&&0!==allData.length){let a={};allData.forEach(e=>{var t=e.partner||"";t&&t.toLowerCase().includes(r)&&(a[t]||(a[t]={name:t,sales:0,count:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].count+=1)});t=Object.values(a).sort((e,t)=>t.sales-e.sales).slice(0,10);if(0===t.length)e.style.display="none";else{let a="";t.forEach((e,t)=>{a+=`<div class="suggestion-item" data-index="${t}" data-name="${e.name}" 
                    style="padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #e0e0e0; transition: background 0.2s;"
                    onmouseover="this.style.background='#f0f0ff'; customerSuggestionIndex=${t};"
                    onmouseout="this.style.background='white';"
                    onclick="selectCustomerSuggestion('${e.name.replace(/'/g,"\\'")}')">
                    <strong>${e.name}</strong>
                    <span style="color: #667eea; margin-left: 10px; font-size: 0.9em;">
                        $${e.sales.toLocaleString("tr-TR",{minimumFractionDigits:2})} • ${e.count} sipariş
                    </span>
                </div>`}),e.innerHTML=a,e.style.display="block",customerSuggestionIndex=-1}}}function selectCustomerSuggestion(e){3<=selectedCustomers.length?alert("⚠️ En fazla 3 müşteri seçebilirsiniz!"):selectedCustomers.includes(e)?alert("⚠️ Bu müşteri zaten seçili!"):(selectedCustomers.push(e),updateSelectedCustomersTags(),document.getElementById("customerSearchInput").value="",document.getElementById("customerSuggestions").style.display="none",searchCustomerProfile())}function updateSelectedCustomersTags(){var e=document.getElementById("selectedCustomersContainer"),t=document.getElementById("selectedCustomersTags");0===selectedCustomers.length?e.style.display="none":(e.style.display="block",t.innerHTML=selectedCustomers.map((e,t)=>`
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 0.9em;">
                    <span>👤 ${e}</span>
                    <button onclick="removeCustomer(${t})" 
                            style="background: rgba(255,255,255,0.3); border: none; color: white; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8em;">
                        ×
                    </button>
                </div>
            `).join(""))}function removeCustomer(e){selectedCustomers.splice(e,1),updateSelectedCustomersTags(),0===selectedCustomers.length?document.getElementById("customerProfileContainer").style.display="none":searchCustomerProfile()}function handleCustomerKeydown(e){var t=document.getElementById("customerSuggestions"),a=t.querySelectorAll(".suggestion-item");0!==a.length&&("ArrowDown"===e.key?(e.preventDefault(),customerSuggestionIndex=Math.min(customerSuggestionIndex+1,a.length-1),highlightCustomerSuggestion(a)):"ArrowUp"===e.key?(e.preventDefault(),customerSuggestionIndex=Math.max(customerSuggestionIndex-1,0),highlightCustomerSuggestion(a)):"Enter"===e.key?(e.preventDefault(),0<=customerSuggestionIndex&&a[customerSuggestionIndex]?selectCustomerSuggestion(a[customerSuggestionIndex].getAttribute("data-name")):searchCustomerProfile()):"Escape"===e.key&&(t.style.display="none"))}function highlightCustomerSuggestion(e){e.forEach((e,t)=>{t===customerSuggestionIndex?(e.style.background="#f0f0ff",e.scrollIntoView({block:"nearest"})):e.style.background="white"})}function showSalespersonSuggestions(n){var e=document.getElementById("salespersonSuggestions");if((n=n.trim().toLowerCase()).length<2)e.style.display="none";else if(allData&&0!==allData.length){let r={};allData.forEach(e=>{var t=e.sales_person||"",a=e.store||"";a.toLowerCase().includes("analitik")||a.toLowerCase().includes("eğitim")||t&&t.toLowerCase().includes(n)&&(r[t]||(r[t]={name:t,sales:0,count:0}),r[t].sales+=parseFloat(e.usd_amount||0),r[t].count+=1)});var t=Object.values(r).sort((e,t)=>t.sales-e.sales).slice(0,10);if(0===t.length)e.style.display="none";else{let a="";t.forEach((e,t)=>{a+=`<div class="suggestion-item" data-index="${t}" data-name="${e.name}" 
                    style="padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #e0e0e0; transition: background 0.2s;"
                    onmouseover="this.style.background='#f0f0ff'; salespersonSuggestionIndex=${t};"
                    onmouseout="this.style.background='white';"
                    onclick="selectSalespersonSuggestion('${e.name.replace(/'/g,"\\'")}')">
                    <strong>${e.name}</strong>
                    <span style="color: #667eea; margin-left: 10px; font-size: 0.9em;">
                        $${e.sales.toLocaleString("tr-TR",{minimumFractionDigits:2})} • ${e.count} satış
                    </span>
                </div>`}),e.innerHTML=a,e.style.display="block",salespersonSuggestionIndex=-1}}}function selectSalespersonSuggestion(e){3<=selectedSalespersons.length?alert("⚠️ En fazla 3 satış temsilcisi seçebilirsiniz!"):selectedSalespersons.includes(e)?alert("⚠️ Bu temsilci zaten seçili!"):(selectedSalespersons.push(e),updateSelectedSalespersonsTags(),document.getElementById("salespersonSearchInput").value="",document.getElementById("salespersonSuggestions").style.display="none",searchSalespersonProfile())}function updateSelectedSalespersonsTags(){var e=document.getElementById("selectedSalespersonsContainer"),t=document.getElementById("selectedSalespersonsTags");0===selectedSalespersons.length?e.style.display="none":(e.style.display="block",t.innerHTML=selectedSalespersons.map(e=>`
                <div style="display: inline-flex; align-items: center; gap: 8px; padding: 8px 12px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-radius: 20px; font-size: 0.9em;">
                    <span>👨‍💼 ${e}</span>
                    <button onclick="removeSalesperson('${e.replace(/'/g,"\\'")}'); event.stopPropagation();" 
                            style="background: rgba(255,255,255,0.3); border: none; color: white; border-radius: 50%; width: 20px; height: 20px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8em;">
                        ×
                    </button>
                </div>
            `).join(""))}function removeSalesperson(t){selectedSalespersons=selectedSalespersons.filter(e=>e!==t),updateSelectedSalespersonsTags(),0<selectedSalespersons.length?searchSalespersonProfile():document.getElementById("salespersonProfileContainer").style.display="none"}function handleSalespersonKeydown(e){var t=document.getElementById("salespersonSuggestions"),a=t.querySelectorAll(".suggestion-item");0!==a.length&&("ArrowDown"===e.key?(e.preventDefault(),salespersonSuggestionIndex=Math.min(salespersonSuggestionIndex+1,a.length-1),highlightSalespersonSuggestion(a)):"ArrowUp"===e.key?(e.preventDefault(),salespersonSuggestionIndex=Math.max(salespersonSuggestionIndex-1,0),highlightSalespersonSuggestion(a)):"Enter"===e.key?(e.preventDefault(),0<=salespersonSuggestionIndex&&a[salespersonSuggestionIndex]?selectSalespersonSuggestion(a[salespersonSuggestionIndex].getAttribute("data-name")):searchSalespersonProfile()):"Escape"===e.key&&(t.style.display="none"))}function highlightSalespersonSuggestion(e){e.forEach((e,t)=>{t===salespersonSuggestionIndex?(e.style.background="#f0f0ff",e.scrollIntoView({block:"nearest"})):e.style.background="white"})}function showStoreSuggestions(r){var e=document.getElementById("storeSuggestions");if((r=r.trim().toLowerCase()).length<2)e.style.display="none";else if(allData&&0!==allData.length){let a={};allData.forEach(e=>{var t=e.store||"";t&&t.toLowerCase().includes(r)&&(a[t]||(a[t]={name:t,sales:0,count:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].count+=1)});var t=Object.values(a).sort((e,t)=>t.sales-e.sales).slice(0,10);if(0===t.length)e.style.display="none";else{let a="";t.forEach((e,t)=>{a+=`<div class="suggestion-item" data-index="${t}" data-name="${e.name}" 
                    style="padding: 12px 20px; cursor: pointer; border-bottom: 1px solid #e0e0e0; transition: background 0.2s;"
                    onmouseover="this.style.background='#f0f0ff'; storeSuggestionIndex=${t};"
                    onmouseout="this.style.background='white';"
                    onclick="selectStoreSuggestion('${e.name.replace(/'/g,"\\'")}')">
                    <strong>${e.name}</strong>
                    <span style="color: #667eea; margin-left: 10px; font-size: 0.9em;">
                        $${e.sales.toLocaleString("tr-TR",{minimumFractionDigits:2})} • ${e.count} satış
                    </span>
                </div>`}),e.innerHTML=a,e.style.display="block",storeSuggestionIndex=-1}}}function selectStoreSuggestion(e){3<=selectedStores.length?alert("⚠️ En fazla 3 mağaza seçebilirsiniz!"):selectedStores.includes(e)?alert("⚠️ Bu mağaza zaten seçili!"):(selectedStores.push(e),updateSelectedStoresTags(),document.getElementById("storeSearchInput").value="",document.getElementById("storeSuggestions").style.display="none",searchStoreProfile())}function updateSelectedStoresTags(){var e=document.getElementById("selectedStoresContainer"),t=document.getElementById("selectedStoresTags");0===selectedStores.length?e.style.display="none":(e.style.display="block",t.innerHTML=selectedStores.map((e,t)=>`
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 8px 15px; border-radius: 20px; display: flex; align-items: center; gap: 8px; font-size: 0.9em;">
                    <span>🏪 ${e}</span>
                    <button onclick="removeStore(${t})" 
                            style="background: rgba(255,255,255,0.3); border: none; color: white; width: 20px; height: 20px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 0.8em;">
                        ×
                    </button>
                </div>
            `).join(""))}function removeStore(e){selectedStores.splice(e,1),updateSelectedStoresTags(),0===selectedStores.length?document.getElementById("storeProfileContainer").style.display="none":searchStoreProfile()}function handleStoreKeydown(e){var t=document.getElementById("storeSuggestions"),a=t.querySelectorAll(".suggestion-item");0!==a.length&&("ArrowDown"===e.key?(e.preventDefault(),storeSuggestionIndex=Math.min(storeSuggestionIndex+1,a.length-1),highlightStoreSuggestion(a)):"ArrowUp"===e.key?(e.preventDefault(),storeSuggestionIndex=Math.max(storeSuggestionIndex-1,0),highlightStoreSuggestion(a)):"Enter"===e.key?(e.preventDefault(),0<=storeSuggestionIndex&&a[storeSuggestionIndex]?selectStoreSuggestion(a[storeSuggestionIndex].getAttribute("data-name")):searchStoreProfile()):"Escape"===e.key&&(t.style.display="none"))}function highlightStoreSuggestion(e){e.forEach((e,t)=>{t===storeSuggestionIndex?(e.style.background="#f0f0ff",e.scrollIntoView({block:"nearest"})):e.style.background="white"})}function searchCustomerProfile(){let n=[];if(0<selectedCustomers.length)n=selectedCustomers;else{var e=document.getElementById("customerSearchInput").value.trim();if(!e)return void alert("Lütfen bir müşteri adı girin veya listeden seçin");e=e.split(",").map(e=>e.trim()).filter(e=>e);if(0===e.length)return void alert("Lütfen geçerli bir müşteri adı girin");let r={};if(allData.forEach(e=>{e=e.partner||"";e&&!r[e]&&(r[e]=e)}),n=[],e.forEach(e=>{let t=e.toLowerCase();var a,e=Object.keys(r).filter(e=>e.toLowerCase().includes(t));0<e.length&&(a=e.find(e=>e.toLowerCase()===t),n.push(a||e[0]))}),0===n.length)return void alert("❌ Girilen isimlere uygun müşteri bulunamadı!");3<(n=[...new Set(n)]).length&&(alert("⚠️ En fazla 3 müşteri arayabilirsiniz!"),n=n.slice(0,3))}if(console.log("🔍 Müşteriler aranıyor:",n),1===n.length){let t=n[0];var a,r,o,i,l,s,d,c,m,e=allData.filter(e=>e.partner&&e.partner.toLowerCase()===t.toLowerCase());0===e.length?(document.getElementById("customerProfileContainer").style.display="none",document.getElementById("customerSearchNoResults").style.display="block"):(document.getElementById("customerSearchNoResults").style.display="none",document.getElementById("customerProfileContainer").style.display="block",a=e[0].partner,r=e[0].city||"Bilinmiyor",o=e[0].tags||"-",i=e.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0),l=e.reduce((e,t)=>e+parseFloat(t.quantity||0),0),s=new Set(e.map(e=>e.date)).size,d=i/Math.max(s,1),c=(m=e.map(e=>new Date(e.date)).sort((e,t)=>e-t))[0].toLocaleDateString("tr-TR"),m=m[m.length-1].toLocaleDateString("tr-TR"),document.getElementById("customerName").textContent=a,document.getElementById("customerCity").textContent=r,document.getElementById("customerTags").textContent=o,document.getElementById("customerTotalSales").textContent="$"+i.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("customerTotalQty").textContent=l.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("customerTransactionCount").textContent=s,document.getElementById("customerAvgBasket").textContent="$"+d.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("customerFirstPurchase").textContent=c,document.getElementById("customerLastPurchase").textContent=m,renderCustomerBrandChart(e),renderCustomerCategoryChart(e),renderCustomerStoreChart(e),renderCustomerMonthlyTrendChart(e),renderCustomerPurchaseHistory(e),performCustomerAIAnalysis(e,{name:a,city:r,tags:o,totalSales:i,totalQty:l,transactionCount:s,avgBasket:d,firstPurchase:c,lastPurchase:m}))}else alert("🚧 Çoklu müşteri karşılaştırma özelliği yakında eklenecek!")}function renderCustomerBrandChart(e){let a={};e.forEach(e=>{var t=e.brand||"Bilinmiyor";a[t]||(a[t]={sales:0,qty:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0)});var e=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,10),t=e.map(e=>e[0]),e=e.map(e=>e[1].sales),r=document.getElementById("customerBrandChart");r&&(customerBrandChartInstance&&customerBrandChartInstance.destroy(),customerBrandChartInstance=new Chart(r,{type:"bar",data:{labels:t,datasets:[{label:"Satış (USD - KDV Hariç)",data:e,backgroundColor:"rgba(102, 126, 234, 0.6)",borderColor:"rgba(102, 126, 234, 1)",borderWidth:2}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}}))}function renderCustomerCategoryChart(e){let a={};e.forEach(e=>{var t=e.category_2||e.category_1||"Bilinmiyor";a[t]||(a[t]={sales:0,qty:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0)});var e=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,10),t=e.map(e=>e[0]),e=e.map(e=>e[1].sales),r=document.getElementById("customerCategoryChart");r&&(customerCategoryChartInstance&&customerCategoryChartInstance.destroy(),customerCategoryChartInstance=new Chart(r,{type:"bar",data:{labels:t,datasets:[{label:"Satış (USD - KDV Hariç)",data:e,backgroundColor:"rgba(56, 239, 125, 0.6)",borderColor:"rgba(56, 239, 125, 1)",borderWidth:2}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}}))}function renderCustomerStoreChart(e){let a={};e.forEach(e=>{var t=e.store||"Bilinmiyor";a[t]||(a[t]={sales:0,qty:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0)});var e=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,10),t=e.map(e=>e[0]),e=e.map(e=>e[1].sales),r=document.getElementById("customerStoreChart");r&&(customerStoreChartInstance&&customerStoreChartInstance.destroy(),customerStoreChartInstance=new Chart(r,{type:"bar",data:{labels:t,datasets:[{label:"Satış (USD - KDV Hariç)",data:e,backgroundColor:"rgba(245, 87, 108, 0.6)",borderColor:"rgba(245, 87, 108, 1)",borderWidth:2}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}}))}function renderCustomerMonthlyTrendChart(e){let a={};e.forEach(e=>{var t=new Date(e.date),t=t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,"0");a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0)});var e=Object.entries(a).sort((e,t)=>e[0].localeCompare(t[0])),t=e.map(e=>e[0]),e=e.map(e=>e[1]),r=document.getElementById("customerMonthlyTrendChart");r&&(customerMonthlyTrendChartInstance&&customerMonthlyTrendChartInstance.destroy(),customerMonthlyTrendChartInstance=new Chart(r,{type:"line",data:{labels:t,datasets:[{label:"Aylık Satış (USD)",data:e,borderColor:"rgba(102, 126, 234, 1)",backgroundColor:"rgba(102, 126, 234, 0.1)",borderWidth:3,fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}}))}function renderCustomerPurchaseHistory(e){e=[...e].sort((e,t)=>new Date(t.date)-new Date(e.date)).slice(0,50);let a=`
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left;">Tarih</th>
                            <th style="padding: 15px; text-align: left;">Ürün</th>
                            <th style="padding: 15px; text-align: left;">Marka</th>
                            <th style="padding: 15px; text-align: right;">Adet</th>
                            <th style="padding: 15px; text-align: right;">Tutar</th>
                            <th style="padding: 15px; text-align: left;">Mağaza</th>
                        </tr>
                    </thead>
                    <tbody>
            `;e.forEach((e,t)=>{a+=`
                    <tr style="border-bottom: 1px solid #eee; ${t%2==0?"background: #f8f9fa;":""}">
                        <td style="padding: 12px;">${e.date}</td>
                        <td style="padding: 12px;"><strong>${e.product}</strong></td>
                        <td style="padding: 12px;">${e.brand}</td>
                        <td style="padding: 12px; text-align: right;">${parseFloat(e.quantity||0).toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                        <td style="padding: 12px; text-align: right; color: #38ef7d; font-weight: bold;">$${parseFloat(e.usd_amount||0).toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                        <td style="padding: 12px;">${e.store}</td>
                    </tr>
                `}),a+=`
                    </tbody>
                </table>
            `,document.getElementById("customerPurchaseHistory").innerHTML=a}function performCustomerAIAnalysis(e,t){console.log("🤖 Müşteri AI analizi başlatılıyor...");var a={positive:[],negative:[],neutral:[],recommendations:[]},r=(4e4<t.totalSales&&a.positive.push({title:"👑 VIP Müşteri",description:`Toplam ${t.totalSales.toLocaleString("tr-TR",{minimumFractionDigits:2})} USD alışveriş yapmış. Bu müşteriye özel ilgi gösterilmeli.`}),new Date(t.firstPurchase.split(".").reverse().join("-"))),n=new Date(t.lastPurchase.split(".").reverse().join("-")),n=Math.floor((n-r)/864e5);365<n&&a.positive.push({title:"💎 Sadık Müşteri",description:Math.floor(n/365)+" yıldan fazla süredir müşteri. Uzun vadeli ilişki kurulmuş."}),3e3<t.avgBasket&&a.positive.push({title:"💰 Yüksek Sepet Değeri",description:`Ortalama sepet değeri $${t.avgBasket.toLocaleString("tr-TR",{minimumFractionDigits:2})}. Premium ürünleri tercih ediyor.`});let o={};e.forEach(e=>{var t=e.brand||"Bilinmiyor";o[t]||(o[t]=0),o[t]+=parseFloat(e.usd_amount||0)});r=Object.entries(o).sort((e,t)=>t[1]-e[1])[0],n=(r[1]/t.totalSales*100).toFixed(1),50<n&&a.neutral.push({title:`🏷️ ${r[0]} Markasına Sadık`,description:`Alışverişlerin %${n}'i ${r[0]} markasından. Bu markadaki yeni ürünleri önerebilirsiniz.`}),a.recommendations.push({icon:"🎁",title:"Kişiselleştirilmiş Kampanya",description:r[0]+" markasındaki yeni ürünler için özel indirim sunun."}),a.recommendations.push({icon:"📧",title:"E-posta Bildirimi",description:`Tercih ettiği kategorilerdeki (${e[0].category_1}) yeni ürünler için e-posta gönderin.`}),3e3<t.avgBasket&&a.recommendations.push({icon:"⭐",title:"VIP Program",description:"Yüksek sepet değeri nedeniyle VIP müşteri programına davet edin."}),n=`
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">
                    ${0<a.positive.length?`
                    <div class="analysis-section">
                        <h3 style="color: white; margin-top: 0;">✅ Müşteri Profili</h3>
                        ${a.positive.map(e=>`
                            <div class="insight-item insight-positive" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">✅</span>
                                <strong style="font-size: 1.1em;">${e.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${e.description}</span>
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    ${0<a.neutral.length?`
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">💡 Satın Alma Davranışı</h3>
                        ${a.neutral.map(e=>`
                            <div class="insight-item insight-neutral" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">💡</span>
                                <strong style="font-size: 1.1em;">${e.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${e.description}</span>
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">🎯 Kişiselleştirilmiş Öneriler</h3>
                        ${a.recommendations.map(e=>`
                            <div class="recommendation" style="background: rgba(255, 255, 255, 0.15); padding: 18px; border-radius: 10px; margin: 12px 0;">
                                <span class="recommendation-icon" style="font-size: 1.8em; margin-right: 12px;">${e.icon}</span>
                                <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px);">
                                    <strong style="font-size: 1.15em; display: block; margin-bottom: 8px;">${e.title}</strong>
                                    <p style="margin: 0; opacity: 0.95; line-height: 1.6;">${e.description}</p>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                </div>
            `;document.getElementById("customerAIAnalysisContent").innerHTML=n}document.addEventListener("click",function(e){e.target.closest("#customerSearchInput")||e.target.closest("#customerSuggestions")||(document.getElementById("customerSuggestions").style.display="none"),e.target.closest("#salespersonSearchInput")||e.target.closest("#salespersonSuggestions")||(document.getElementById("salespersonSuggestions").style.display="none"),e.target.closest("#storeSearchInput")||e.target.closest("#storeSuggestions")||(document.getElementById("storeSuggestions").style.display="none")});let storeBrandChartInstance=null,storeCategoryChartInstance=null,storeSalespersonChartInstance=null,storeMonthlyChartInstance=null,lastStoreTopProductsData=null;function populateStoreYearFilter(){if(allData&&0!==allData.length){let t=new Set,a=new Set,r=new Set;allData.forEach(e=>{e.date&&3<=(e=e.date.split("-")).length&&(t.add(e[0]),a.add(e[1]),r.add(e[2]))}),populateMultiSelect("filterStoreYear",Array.from(t).sort().reverse(),"countStoreYear"),populateMultiSelect("filterStoreMonth",Array.from(a).sort(),"countStoreMonth"),populateMultiSelect("filterStoreDay",Array.from(r).sort(),"countStoreDay")}}function clearStoreFilters(){var e=document.querySelectorAll('#filterStoreYear input[type="checkbox"]'),t=document.querySelectorAll('#filterStoreMonth input[type="checkbox"]'),a=document.querySelectorAll('#filterStoreDay input[type="checkbox"]');e.forEach(e=>e.checked=!1),t.forEach(e=>e.checked=!1),a.forEach(e=>e.checked=!1),updateSelectionCount("filterStoreYear","countStoreYear"),updateSelectionCount("filterStoreMonth","countStoreMonth"),updateSelectionCount("filterStoreDay","countStoreDay"),console.log("✅ Mağaza filtreleri temizlendi")}function performMultipleSalespersonsAIAnalysis(e){console.log("🤖 Çoklu satış temsilcisi karşılaştırmalı AI analizi başlatılıyor...");let a={positive:[],negative:[],neutral:[],recommendations:[]};var t,r=e.map(e=>e.name).join(", "),r=(a.neutral.push(`🔍 ${e.length} satış temsilcisi karşılaştırılıyor: `+r),[...e].sort((e,t)=>t.totalSales-e.totalSales)),n=(a.positive.push(`🏆 En yüksek satış: <strong>${r[0].name}</strong> - $`+r[0].totalSales.toLocaleString("tr-TR",{minimumFractionDigits:2})),1<r.length&&(t=((n=r[0].totalSales-r[1].totalSales)/r[1].totalSales*100).toFixed(1),a.neutral.push(`📊 1. ve 2. arasındaki fark: $${n.toLocaleString("tr-TR",{minimumFractionDigits:2})} (%${t})`)),2<r.length&&a.negative.push(`⚠️ En düşük satış: <strong>${r[r.length-1].name}</strong> - $`+r[r.length-1].totalSales.toLocaleString("tr-TR",{minimumFractionDigits:2})),[...e].sort((e,t)=>t.totalQty-e.totalQty));a.positive.push(`📦 En yüksek adet: <strong>${n[0].name}</strong> - ${n[0].totalQty.toLocaleString("tr-TR",{minimumFractionDigits:2})} adet`),e.forEach(e=>{var t=e.totalSales/Math.max(e.uniqueCustomers,1);5e3<t?a.positive.push(`💰 <strong>${e.name}</strong> müşteri başına yüksek ortalama: $`+t.toLocaleString("tr-TR",{minimumFractionDigits:2})):t<1e3&&a.negative.push(`📉 <strong>${e.name}</strong> müşteri başına düşük ortalama: $`+t.toLocaleString("tr-TR",{minimumFractionDigits:2}))}),a.recommendations.push(`🎯 <strong>${r[0].name}</strong>'in stratejilerini diğer temsilcilerle paylaşın`),1<r.length&&0<(t=r.slice(Math.ceil(r.length/2))).length&&a.recommendations.push(`📚 ${t.map(e=>e.name).join(", ")} için ek eğitim ve mentorluk programı düşünün`),a.recommendations.push("🤝 Tüm temsilciler için ortak hedefler belirleyin ve takım çalışmasını teşvik edin"),a.recommendations.push("📊 Aylık performans toplantıları düzenleyerek en iyi uygulamaları paylaşın");let o='<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; color: white; margin-bottom: 30px;">';o+='<h3 style="margin: 0 0 20px 0; font-size: 1.8em;">🤖 Karşılaştırmalı AI Performans Analizi</h3>',0<a.positive.length&&(o+='<div style="margin-bottom: 20px;"><h4 style="color: #4ade80; margin-bottom: 10px;">✅ Güçlü Yönler:</h4><ul style="margin: 0; padding-left: 20px;">',a.positive.forEach(e=>o+=`<li style="margin-bottom: 8px;">${e}</li>`),o+="</ul></div>"),0<a.negative.length&&(o+='<div style="margin-bottom: 20px;"><h4 style="color: #fbbf24; margin-bottom: 10px;">⚠️ Gelişim Alanları:</h4><ul style="margin: 0; padding-left: 20px;">',a.negative.forEach(e=>o+=`<li style="margin-bottom: 8px;">${e}</li>`),o+="</ul></div>"),0<a.neutral.length&&(o+='<div style="margin-bottom: 20px;"><h4 style="color: #e0e7ff; margin-bottom: 10px;">📊 Genel Durum:</h4><ul style="margin: 0; padding-left: 20px;">',a.neutral.forEach(e=>o+=`<li style="margin-bottom: 8px;">${e}</li>`),o+="</ul></div>"),0<a.recommendations.length&&(o+='<div><h4 style="color: #a78bfa; margin-bottom: 10px;">💡 Öneriler:</h4><ul style="margin: 0; padding-left: 20px;">',a.recommendations.forEach(e=>o+=`<li style="margin-bottom: 8px;">${e}</li>`),o+="</ul></div>"),o+="</div>";n=document.getElementById("salespersonAIAnalysisContent");n&&(n.innerHTML=o)}function searchStoreProfile(){let n=[];if(0<selectedStores.length)n=selectedStores;else{var e=document.getElementById("storeSearchInput").value.trim();if(!e)return void alert("Lütfen bir mağaza adı girin veya listeden seçin");e=e.split(",").map(e=>e.trim().toLowerCase()).filter(e=>e);if(0===e.length)return void alert("Lütfen geçerli bir mağaza adı girin");let r={};if(allData.forEach(e=>{e=e.store||"";e&&!r[e]&&(r[e]=e)}),n=[],e.forEach(t=>{var e,a=Object.keys(r).filter(e=>e.toLowerCase().includes(t));0<a.length&&(e=a.find(e=>e.toLowerCase()===t),n.push(e||a[0]))}),0===n.length)return void alert("❌ Girilen isimlere uygun mağaza bulunamadı!");3<(n=[...new Set(n)]).length&&(alert("⚠️ En fazla 3 mağaza arayabilirsiniz!"),n=n.slice(0,3))}console.log("🔍 Mağazalar aranıyor:",n);var e=Array.from(document.querySelectorAll('#filterStoreYear input[type="checkbox"]:checked')).map(e=>e.value),t=Array.from(document.querySelectorAll('#filterStoreMonth input[type="checkbox"]:checked')).map(e=>e.value),a=Array.from(document.querySelectorAll('#filterStoreDay input[type="checkbox"]:checked')).map(e=>e.value);1===n.length?renderSingleStoreView(n[0],e,t,a):renderMultipleStoresView(n,e,t,a)}function renderSingleStoreView(a,r,n,o){var e,t,i,l,s,d,c,m,g,u=allData.filter(e=>{if(!e.store||e.store.toLowerCase()!==a.toLowerCase())return!1;var t=(e.store||"").toLowerCase();if(t.includes("analitik")||t.includes("eğitim"))return!1;if(!e.date)return!1;if(0<r.length){t=e.date.substring(0,4);if(!r.includes(t))return!1}if(0<n.length){t=e.date.substring(5,7);if(!n.includes(t))return!1}if(0<o.length){t=e.date.substring(8,10);if(!o.includes(t))return!1}return!0});0===u.length?(document.getElementById("storeProfileContainer").style.display="none",document.getElementById("storeSearchNoResults").style.display="block"):(document.getElementById("storeSearchNoResults").style.display="none",document.getElementById("storeProfileContainer").style.display="block",document.getElementById("singleStoreView").style.display="block",document.getElementById("multipleStoresView").style.display="none",document.getElementById("storeBrandCategorySection").style.display="grid",document.getElementById("storeTopProductsSection").style.display="block",document.getElementById("storeFullSalespersonSection").style.display="block",e=u[0].store,t=u.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0),i=u.reduce((e,t)=>e+parseFloat(t.quantity||0),0),l=new Set(u.map(e=>e.date)).size,g=new Set(u.map(e=>e.move_name)).size,s=t/Math.max(l,1),d=t/Math.max(g,1),c=new Set(u.map(e=>e.partner)).size,m=new Set(u.map(e=>e.product)).size,document.getElementById("storeBrandChartTitle").textContent=`🏷️ ${e} - En Çok Satan Markalar (Top 10)`,document.getElementById("storeCategoryChartTitle").textContent=`📂 ${e} - En Çok Satan Kategoriler`,document.getElementById("storeSalespersonChartTitle").textContent=`👨‍💼 ${e} - Satış Temsilcileri`,document.getElementById("storeMonthlyChartTitle").textContent=`📈 ${e} - Aylık Performans Trendi`,document.getElementById("storeName").textContent=e,document.getElementById("storeTotalSales").textContent="$"+t.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("storeTotalQty").textContent=i.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("storeInvoiceCount").textContent=g,document.getElementById("storeAvgTransaction").textContent="$"+s.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("storeAvgBasket").textContent="$"+d.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("storeUniqueCustomers").textContent=c,document.getElementById("storeUniqueProducts").textContent=m,renderStoreBrandChart(u),renderStoreCategoryChart(u),renderStoreSalespersonChart(u),renderStoreMonthlyChart(u),renderStoreTopProducts(u),renderStoreFullSalespersonTable(u),g=allData.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0),performStoreAIAnalysis(u,{name:e,totalSales:t,totalQty:i,transactionCount:l,avgTransaction:s,uniqueCustomers:c,uniqueProducts:m,totalAllSales:g,storeSalesPercentage:(t/g*100).toFixed(1)}))}function renderMultipleStoresView(e,c,m,g){var t,e=e.map(a=>{var e=allData.filter(e=>{if(!e.store||e.store.toLowerCase()!==a.toLowerCase())return!1;var t=(e.store||"").toLowerCase();if(t.includes("analitik")||t.includes("eğitim"))return!1;if(!e.date)return!1;if(0<c.length){t=e.date.substring(0,4);if(!c.includes(t))return!1}if(0<m.length){t=e.date.substring(5,7);if(!m.includes(t))return!1}if(0<g.length){t=e.date.substring(8,10);if(!g.includes(t))return!1}return!0}),t=e.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0),r=e.reduce((e,t)=>e+parseFloat(t.quantity||0),0),n=new Set(e.map(e=>e.date)).size,o=new Set(e.map(e=>e.move_name)).size,i=t/Math.max(n,1),l=t/Math.max(o,1),s=new Set(e.map(e=>e.partner)).size,d=new Set(e.map(e=>e.product)).size;return{name:a,data:e,invoiceCount:o,avgBasket:l,totalSales:t,totalQty:r,transactionCount:n,avgTransaction:i,uniqueCustomers:s,uniqueProducts:d}}).filter(e=>0<e.data.length);0===e.length?(document.getElementById("storeProfileContainer").style.display="none",document.getElementById("storeSearchNoResults").style.display="block"):(document.getElementById("storeSearchNoResults").style.display="none",document.getElementById("storeProfileContainer").style.display="block",document.getElementById("singleStoreView").style.display="none",document.getElementById("multipleStoresView").style.display="block",renderStoreComparisonTable(e),renderStoreComparisonCharts(e),renderStoreComparisonCategoryCharts(e),document.getElementById("storeBrandCategorySection").style.display="none",document.getElementById("storeTopProductsSection").style.display="none",document.getElementById("storeFullSalespersonSection").style.display="none",(t=document.getElementById("storeAIAnalysisPanel"))&&(t.style.display="block"),performMultipleStoresAIAnalysis(e))}function renderStoreComparisonTable(e){var t=document.getElementById("storeComparisonTableContainer"),e=`
                <table style="width: 100%; border-collapse: collapse; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <th style="padding: 15px; text-align: left;">Metrik</th>
                            ${e.map(e=>`<th style="padding: 15px; text-align: right;">🏪 ${e.name}</th>`).join("")}
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">💰 Toplam Satış</td>
                            ${e.map(e=>`<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">$${e.totalSales.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>`).join("")}
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">📦 Toplam Adet</td>
                            ${e.map(e=>`<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${e.totalQty.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>`).join("")}
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">🛒 Fatura Sayısı</td>
                            ${e.map(e=>`<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${e.invoiceCount}</td>`).join("")}
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">📊 Günlük Ort. Satış</td>
                            ${e.map(e=>`<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">$${e.avgTransaction.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>`).join("")}
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">🛒 Sepet Ortalaması</td>
                            ${e.map(e=>`<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">$${e.avgBasket.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>`).join("")}
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">👥 Farklı Müşteri</td>
                            ${e.map(e=>`<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${e.uniqueCustomers}</td>`).join("")}
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">🎯 Farklı Ürün</td>
                            ${e.map(e=>`<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${e.uniqueProducts}</td>`).join("")}
                        </tr>
                    </tbody>
                </table>
            `;t.innerHTML=e}function renderStoreComparisonCharts(e){var t=e.map(e=>e.name),a=e.map(e=>e.totalSales),e=e.map(e=>e.totalQty),r=["rgba(102, 126, 234, 0.7)","rgba(240, 147, 251, 0.7)","rgba(255, 159, 64, 0.7)"],n=["rgba(102, 126, 234, 1)","rgba(240, 147, 251, 1)","rgba(255, 159, 64, 1)"],o=document.getElementById("comparisonStoreSalesChart"),o=(comparisonStoreSalesChartInstance&&comparisonStoreSalesChartInstance.destroy(),comparisonStoreSalesChartInstance=new Chart(o,{type:"bar",data:{labels:t,datasets:[{label:"Toplam Satış ($)",data:a,backgroundColor:r,borderColor:n,borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){return"$"+e.parsed.y.toLocaleString("tr-TR",{minimumFractionDigits:2})}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}}),document.getElementById("comparisonStoreQtyChart"));comparisonStoreQtyChartInstance&&comparisonStoreQtyChartInstance.destroy(),comparisonStoreQtyChartInstance=new Chart(o,{type:"bar",data:{labels:t,datasets:[{label:"Toplam Adet",data:e,backgroundColor:r,borderColor:n,borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){return e.parsed.y.toLocaleString("tr-TR",{minimumFractionDigits:2})+" adet"}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return e.toLocaleString("tr-TR")}}}}}})}function renderStoreCategoryComparisonTable(e){var n=document.getElementById("storeCategoryComparisonTableContainer");if(n){let t=e.map(e=>{let a={};e.data.forEach(e=>{var t=e.category_1&&"all"!==e.category_1.toLowerCase()?e.category_1:e.category_2||e.category_3||"Diğer";t.toLowerCase().includes("analitik")||t.toLowerCase().includes("eğitim")||(a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0))});var t=Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,10);return{name:e.name,categories:t,totalSales:t.reduce((e,t)=>e+t[1],0)}}),a=new Set,r=(t.forEach(e=>{e.categories.forEach(([e])=>a.add(e))}),`
                <table style="width: 100%; border-collapse: collapse; box-shadow: 0 2px 10px rgba(0,0,0,0.1); background: white; border-radius: 10px; overflow: hidden;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <th style="padding: 20px; text-align: left; font-size: 1.1em; position: sticky; left: 0; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); z-index: 10;">📂 Kategori</th>
            `);t.forEach(e=>{r+=`<th style="padding: 20px; text-align: center; font-size: 1.1em; min-width: 150px;">🏪 ${e.name}</th>`}),r+="</tr></thead><tbody>",Array.from(a).sort().forEach((a,e)=>{e=e%2==0?"#f8f9fa":"white";r=(r+=`<tr style="background: ${e}; border-bottom: 1px solid #e9ecef;">`)+`<td style="padding: 15px; font-weight: 600; position: sticky; left: 0; background: ${e}; z-index: 5;">${a}</td>`,t.forEach(e=>{var t=e.categories.find(([e])=>e===a);t?(e=((t=t[1])/e.totalSales*100).toFixed(1),r+=`
                            <td style="padding: 15px; text-align: center;">
                                <div style="font-weight: bold; color: #667eea; font-size: 1.1em;">$${t.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2})}</div>
                                <div style="color: #6c757d; font-size: 0.9em; margin-top: 5px;">${e}%</div>
                            </td>
                        `):r+='<td style="padding: 15px; text-align: center; color: #adb5bd;">-</td>'}),r+="</tr>"}),r+=`
                <tr style="background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); color: white; font-weight: bold;">
                    <td style="padding: 20px; font-size: 1.1em; position: sticky; left: 0; background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); z-index: 10;">💰 TOPLAM</td>
            `,t.forEach(e=>{r+=`<td style="padding: 20px; text-align: center; font-size: 1.2em;">$${e.totalSales.toLocaleString("tr-TR",{minimumFractionDigits:2,maximumFractionDigits:2})}</td>`}),r+="</tr></tbody></table>",n.innerHTML=r}}function renderStoreComparisonCategoryCharts(e){var t=document.getElementById("storeComparisonCategoryCharts");if(t)return console.log("📊 Kategori karşılaştırması başlatılıyor...",e.length,"mağaza"),void renderStoreCategoryComparisonTable(e);else console.error("❌ storeComparisonCategoryCharts container bulunamadı!")}function performMultipleStoresAIAnalysis(e){console.log("🤖 Çoklu mağaza karşılaştırmalı AI analizi başlatılıyor...",e);let r={positive:[],negative:[],neutral:[],recommendations:[],categories:[]};var t=e.map(e=>e.name).join(", "),t=(r.neutral.push(`🔍 <strong>${e.length} Mağaza Detaylı Karşılaştırma:</strong> `+t),[...e].sort((e,t)=>t.totalSales-e.totalSales)),a=t.reduce((e,t)=>e+t.totalSales,0);let n=a/t.length;r.positive.push(`🏆 <strong>Satış Lideri:</strong> ${t[0].name} - $${t[0].totalSales.toLocaleString("tr-TR",{minimumFractionDigits:2})} (Toplam satışın %${(t[0].totalSales/a*100).toFixed(1)}'i)`),1<t.length&&(o=((a=t[0].totalSales-t[1].totalSales)/t[1].totalSales*100).toFixed(1),r.neutral.push(`📊 <strong>Lider Farkı:</strong> 1. sıradaki mağaza 2. sıradan $${a.toLocaleString("tr-TR",{minimumFractionDigits:2})} (%${o}) daha fazla satış yapıyor`),0<(a=t.filter(e=>e.totalSales<n)).length)&&r.negative.push(`⚠️ <strong>Ortalama Altı Performans:</strong> ${a.map(e=>e.name).join(", ")} ortalama satışın ($${n.toLocaleString("tr-TR",{minimumFractionDigits:2})}) altında`),2<t.length&&(o=t[t.length-1],a=t[0].totalSales-o.totalSales,r.negative.push(`📉 <strong>En Düşük Performans:</strong> ${o.name} - $${o.totalSales.toLocaleString("tr-TR",{minimumFractionDigits:2})} (Liderden %${(a/t[0].totalSales*100).toFixed(1)} daha az)`));var o=[...e].sort((e,t)=>t.totalQty-e.totalQty),a=[...e].sort((e,t)=>t.avgBasket-e.avgBasket),o=(r.positive.push(`📦 <strong>En Yüksek Adet Satışı:</strong> ${o[0].name} - ${o[0].totalQty.toLocaleString("tr-TR")} adet`),r.positive.push(`🛒 <strong>En Yüksek Sepet Ortalaması:</strong> ${a[0].name} - $${a[0].avgBasket.toLocaleString("tr-TR",{minimumFractionDigits:2})}/fatura`),e.filter(e=>e.avgBasket<100));0<o.length&&r.negative.push(`⚠️ <strong>Düşük Sepet Ortalaması:</strong> ${o.map(e=>`${e.name} ($${e.avgBasket.toFixed(2)})`).join(", ")} - Cross-selling fırsatı var`);let i={};e.forEach(a=>{a.data.forEach(e=>{var t=e.category_1&&"all"!==e.category_1.toLowerCase()?e.category_1:e.category_2||e.category_3||"Diğer";t.toLowerCase().includes("analitik")||t.toLowerCase().includes("eğitim")||(i[t]||(i[t]={}),i[t][a.name]||(i[t][a.name]=0),i[t][a.name]+=parseFloat(e.usd_amount||0))})}),Object.entries(i).forEach(([e,t])=>{var a,t=Object.entries(t).sort((e,t)=>t[1]-e[1]);0<t.length&&1e3<t[0][1]&&(a=t[0],t=t.reduce((e,[,t])=>e+t,0),t=(a[1]/t*100).toFixed(1),r.categories.push(`📂 <strong>${e}:</strong> ${a[0]} lider ($${a[1].toLocaleString("tr-TR",{minimumFractionDigits:2})}, %${t})`))}),r.recommendations.push(`🎯 <strong>${t[0].name}</strong> en iyi uygulamalarını (satış teknikleri, ürün yerleşimi, müşteri hizmetleri) diğer mağazalarla paylaşmalı`),0<o.length&&r.recommendations.push(`🛒 ${o.map(e=>e.name).join(", ")} için <strong>cross-selling ve up-selling eğitimleri</strong> düzenleyin - Sepet ortalamasını artırma potansiyeli yüksek`);a=Object.entries(i).map(([e,t])=>[e,Object.values(t).reduce((e,t)=>e+t,0)]).sort((e,t)=>t[1]-e[1]).slice(0,3);0<a.length&&r.recommendations.push(`📊 <strong>En çok satan 3 kategori:</strong> ${a.map(([e])=>e).join(", ")} - Bu kategorilerde stok ve teşhir optimizasyonu yapın`),1<t.length&&0<(e=t.slice(Math.ceil(t.length/2))).length&&r.recommendations.push(`📚 <strong>${e.map(e=>e.name).join(", ")}</strong> için: Trafik analizi, personel verimliliği, ürün çeşitliliği ve fiyatlandırma stratejilerini gözden geçirin`),r.recommendations.push("🤝 <strong>Aylık Performans Toplantıları:</strong> Mağaza müdürleri arası best practice paylaşımı ve sorun çözme workshopları düzenleyin"),r.recommendations.push("📊 <strong>Müşteri Geri Bildirimleri:</strong> Her mağaza için NPS (Net Promoter Score) ve müşteri memnuniyeti anketleri yaparak performans farklılıklarının nedenlerini analiz edin");let l='<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 30px; border-radius: 15px; color: white; margin-bottom: 30px;">';l+='<h3 style="margin: 0 0 20px 0; font-size: 1.8em;">🤖 Karşılaştırmalı AI Performans Analizi</h3>',0<r.positive.length&&(l+='<div style="margin-bottom: 20px;"><h4 style="color: #4ade80; margin-bottom: 10px;">✅ Güçlü Yönler:</h4><ul style="margin: 0; padding-left: 20px;">',r.positive.forEach(e=>l+=`<li style="margin-bottom: 8px;">${e}</li>`),l+="</ul></div>"),0<r.negative.length&&(l+='<div style="margin-bottom: 20px;"><h4 style="color: #fbbf24; margin-bottom: 10px;">⚠️ Gelişim Alanları:</h4><ul style="margin: 0; padding-left: 20px;">',r.negative.forEach(e=>l+=`<li style="margin-bottom: 8px;">${e}</li>`),l+="</ul></div>"),0<r.neutral.length&&(l+='<div style="margin-bottom: 20px;"><h4 style="color: #e0e7ff; margin-bottom: 10px;">📊 Genel Durum:</h4><ul style="margin: 0; padding-left: 20px;">',r.neutral.forEach(e=>l+=`<li style="margin-bottom: 8px;">${e}</li>`),l+="</ul></div>"),0<r.categories.length&&(l+='<div style="margin-bottom: 20px;"><h4 style="color: #fcd34d; margin-bottom: 10px;">📂 Kategori Liderlikleri:</h4><ul style="margin: 0; padding-left: 20px;">',r.categories.forEach(e=>l+=`<li style="margin-bottom: 8px;">${e}</li>`),l+="</ul></div>"),0<r.recommendations.length&&(l+='<div><h4 style="color: #a78bfa; margin-bottom: 10px;">💡 Stratejik Öneriler:</h4><ul style="margin: 0; padding-left: 20px;">',r.recommendations.forEach(e=>l+=`<li style="margin-bottom: 8px;">${e}</li>`),l+="</ul></div>"),l+="</div>";o=document.getElementById("multipleStoresAIContent"),o?(o.innerHTML=l,console.log("✅ Çoklu mağaza AI analizi HTML eklendi")):console.error("❌ multipleStoresAIContent bulunamadı!"),a=document.getElementById("storeAIAnalysisContent");a&&(a.innerHTML=l)}function renderStoreBrandChart(e){let a={};e.forEach(e=>{var t=e.brand||"Bilinmiyor";a[t]||(a[t]={sales:0,qty:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0)});var e=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,10),t=document.getElementById("storeBrandChart");t&&(storeBrandChartInstance&&storeBrandChartInstance.destroy(),storeBrandChartInstance=new Chart(t,{type:"bar",data:{labels:e.map(e=>e[0]),datasets:[{label:"Satış (USD)",data:e.map(e=>e[1].sales),backgroundColor:"rgba(102, 126, 234, 0.6)"}]},options:{responsive:!0,maintainAspectRatio:!1}}))}function renderStoreCategoryChart(e){let a={};e.forEach(e=>{var t=e.category_2||"";!t||"all"===t.toLowerCase()||"bilinmiyor"===t.toLowerCase()||t.toLowerCase().includes("analitik")||t.toLowerCase().includes("eğitim")||(a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0))});var e=Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,10),t=document.getElementById("storeCategoryChart");t&&(storeCategoryChartInstance&&storeCategoryChartInstance.destroy(),storeCategoryChartInstance=new Chart(t,{type:"doughnut",data:{labels:e.map(e=>e[0]),datasets:[{data:e.map(e=>e[1])}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{datalabels:{color:"#fff",font:{weight:"bold",size:14},formatter:(e,t)=>(100*e/t.chart.data.datasets[0].data.reduce((e,t)=>e+t,0)).toFixed(1)+"%"}}},plugins:[ChartDataLabels]}))}function renderStoreSalespersonChart(e){let a={};e.forEach(e=>{var t=e.sales_person||"Bilinmiyor";a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0)});var e=Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,10),t=document.getElementById("storeSalespersonChart");t&&(storeSalespersonChartInstance&&storeSalespersonChartInstance.destroy(),storeSalespersonChartInstance=new Chart(t,{type:"bar",data:{labels:e.map(e=>e[0]),datasets:[{label:"Satış (USD)",data:e.map(e=>e[1]),backgroundColor:"rgba(118, 75, 162, 0.6)"}]},options:{responsive:!0,maintainAspectRatio:!1}}))}function renderStoreMonthlyChart(e){let n={},t=(e.forEach(e=>{var t=new Date(e.date),a=t.getFullYear(),t=String(t.getMonth()+1).padStart(2,"0");n[a]||(n[a]={}),n[a][t]||(n[a][t]=0),n[a][t]+=parseFloat(e.usd_amount||0)}),new Set),o=(Object.values(n).forEach(e=>{Object.keys(e).forEach(e=>t.add(e))}),Array.from(t).sort()),i=[],l=[{border:"rgba(102, 126, 234, 1)",bg:"rgba(102, 126, 234, 0.1)"},{border:"rgba(245, 87, 108, 1)",bg:"rgba(245, 87, 108, 0.1)"},{border:"rgba(56, 239, 125, 1)",bg:"rgba(56, 239, 125, 0.1)"}];Object.keys(n).sort().forEach((e,t)=>{let a=n[e];var r=o.map(e=>a[e]||0),t=l[t%l.length];i.push({label:""+e,data:r,borderColor:t.border,backgroundColor:t.bg,borderWidth:3,fill:!0,tension:.4})});e=document.getElementById("storeMonthlyChart");if(e){storeMonthlyChartInstance&&storeMonthlyChartInstance.destroy();let t=["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];var a=o.map(e=>t[parseInt(e)-1]);storeMonthlyChartInstance=new Chart(e,{type:"line",data:{labels:a,datasets:i},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"}}}})}}function renderStoreTopProducts(e){let a={};e.forEach(e=>{var t=e.product||"Bilinmiyor";a[t]||(a[t]={brand:e.brand||"Bilinmiyor",sales:0,qty:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0)});e=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,20);let r='<table style="width: 100%; border-collapse: collapse;"><thead><tr style="background: #667eea; color: white;"><th style="padding: 12px; text-align: left;">Ürün</th><th style="padding: 12px; text-align: left;">Marka</th><th style="padding: 12px; text-align: right;">Satış (USD)</th><th style="padding: 12px; text-align: right;">Adet</th></tr></thead><tbody>';e.forEach((e,t)=>{r+=`<tr style="border-bottom: 1px solid #eee; ${t%2==0?"background: #f8f9fa;":""}">
                    <td style="padding: 12px;">${e[0]}</td>
                    <td style="padding: 12px;">${e[1].brand}</td>
                    <td style="padding: 12px; text-align: right;">$${e[1].sales.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                    <td style="padding: 12px; text-align: right;">${e[1].qty.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                </tr>`}),r+="</tbody></table>",document.getElementById("storeTopProductsTable").innerHTML=r}function renderStoreFullSalespersonTable(e){let a={};e.forEach(e=>{var t=e.sales_person||"Bilinmiyor";a[t]||(a[t]={sales:0,qty:0,invoiceCount:0,uniqueCustomers:0,invoices:new Set,customers:new Set}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0),e.move_name?a[t].invoices.add(e.move_name):e.move_id&&a[t].invoices.add(e.move_id),e.partner&&a[t].customers.add(e.partner)}),Object.keys(a).forEach(e=>{a[e].invoiceCount=a[e].invoices.size,a[e].uniqueCustomers=a[e].customers.size,delete a[e].invoices,delete a[e].customers});e=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales);let o=`
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 8px rgba(0,0,0,0.1); border-radius: 8px; overflow: hidden;">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <th style="padding: 15px; text-align: left; cursor: pointer;" onclick="sortStoreSpTable(0)">
                                # <span style="font-size: 0.8em;">▼</span>
                            </th>
                            <th style="padding: 15px; text-align: left; cursor: pointer;" onclick="sortStoreSpTable(1)">
                                👤 Satış Temsilcisi <span style="font-size: 0.8em;">▼</span>
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="sortStoreSpTable(2)">
                                💰 Toplam Satış (USD) <span style="font-size: 0.8em;">▼</span>
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="sortStoreSpTable(3)">
                                📦 Ürün Miktarı <span style="font-size: 0.8em;">▼</span>
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="sortStoreSpTable(4)">
                                👥 Farklı Müşteri <span style="font-size: 0.8em;">▼</span>
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="sortStoreSpTable(5)">
                                🛒 Sepet Ortalaması <span style="font-size: 0.8em;">▼</span>
                            </th>
                            <th style="padding: 15px; text-align: right;">
                                📈 Pay (%)
                            </th>
                        </tr>
                    </thead>
                    <tbody id="storeSpTableBody">
            `,i=e.reduce((e,t)=>e+t[1].sales,0);e.forEach((e,t)=>{var a=e[0],e=e[1],r=(e.sales/i*100).toFixed(1),n=0<e.invoiceCount?e.sales/e.invoiceCount:0;o+=`
                    <tr style="border-bottom: 1px solid #eee; ${t%2==0?"background: #f8f9fa;":"background: white;"}">
                        <td style="padding: 12px;">${t+1}</td>
                        <td style="padding: 12px;"><strong>${a}</strong></td>
                        <td style="padding: 12px; text-align: right; color: #667eea; font-weight: bold;">$${e.sales.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                        <td style="padding: 12px; text-align: right;">${e.qty.toLocaleString("tr-TR",{minimumFractionDigits:0})}</td>
                        <td style="padding: 12px; text-align: right; color: #764ba2; font-weight: bold;">${e.uniqueCustomers.toLocaleString("tr-TR")}</td>
                        <td style="padding: 12px; text-align: right;">$${n.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                        <td style="padding: 12px; text-align: right;">
                            <span style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 4px 12px; border-radius: 12px; font-weight: bold;">
                                %${r}
                            </span>
                        </td>
                    </tr>
                `}),o+=`
                    </tbody>
                </table>
                <p style="margin-top: 10px; color: #6c757d; font-size: 0.9em;">
                    💡 <strong>Toplam ${e.length} satış temsilcisi</strong> - Sütun başlıklarına tıklayarak sıralama yapabilirsiniz
                </p>
            `,document.getElementById("storeFullSalespersonTable").innerHTML=o}let storeSpSortColumn=2,storeSpSortAsc=!1;function sortStoreSpTable(n){storeSpSortAsc=storeSpSortColumn===n?!storeSpSortAsc:(storeSpSortColumn=n,!1);let t=document.getElementById("storeSpTableBody");var e=Array.from(t.querySelectorAll("tr"));e.sort((e,t)=>{e=e.querySelectorAll("td"),t=t.querySelectorAll("td");let a,r;if(0===n)a=parseInt(e[0].textContent),r=parseInt(t[0].textContent);else{if(1===n)return a=e[1].textContent.trim(),r=t[1].textContent.trim(),storeSpSortAsc?a.localeCompare(r):r.localeCompare(a);2===n?(a=parseFloat(e[2].textContent.replace(/[^0-9,.-]/g,"").replace(",",".")),r=parseFloat(t[2].textContent.replace(/[^0-9,.-]/g,"").replace(",","."))):3===n?(a=parseFloat(e[3].textContent.replace(/[^0-9,.-]/g,"").replace(",",".")),r=parseFloat(t[3].textContent.replace(/[^0-9,.-]/g,"").replace(",","."))):4===n?(a=parseInt(e[4].textContent.replace(/[^0-9]/g,"")),r=parseInt(t[4].textContent.replace(/[^0-9]/g,""))):5===n&&(a=parseFloat(e[5].textContent.replace(/[^0-9,.-]/g,"").replace(",",".")),r=parseFloat(t[5].textContent.replace(/[^0-9,.-]/g,"").replace(",",".")))}return storeSpSortAsc?a-r:r-a}),e.forEach(e=>t.appendChild(e))}function performStoreAIAnalysis(e,r){var t={positive:[],negative:[],neutral:[],recommendations:[],warnings:[]};console.log("📊 Yıllık trend analizi başlatılıyor...");let l={};e.forEach(e=>{var t=e.date?e.date.substring(0,4):null;t&&(l[t]||(l[t]=0),l[t]+=parseFloat(e.usd_amount||0))});var s=Object.keys(l).sort(),d=(new Date).getFullYear().toString(),c=(parseInt(d)-1).toString();if(2<=s.length){var s=s.slice(-3),m=(s.map(e=>({year:e,sales:l[e]})),l[d]||0),c=l[c]||0,g=0<c?(m-c)/c*100:0;let e=0,t=(3===s.length&&(u=0<l[s[1]]?(l[s[1]]-l[s[0]])/l[s[0]]*100:0,p=0<l[s[2]]?(l[s[2]]-l[s[1]])/l[s[1]]*100:0,e=(u+p)/2),"📊"),a="",r="#667eea";r=20<g?(t="🚀",a="GÜÇLÜ BÜYÜME","#38ef7d"):10<g?(t="📈",a="POZİTİF BÜYÜME","#4facfe"):0<g?(t="➡️",a="STABIL BÜYÜME","#ffa751"):-10<g?(t="⚠️",a="DÜŞ","#ff6b6b"):(t="📉",a="YÜKSEK DÜŞÜŞ","#dc3545"),r,t,s.map(e=>`
                                <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; text-align: center;">
                                    <div style="font-size: 0.9em; opacity: 0.9; margin-bottom: 5px;">${e}</div>
                                    <div style="font-size: 1.3em; font-weight: bold;">$${(l[e]||0).toLocaleString("tr-TR",{minimumFractionDigits:0})}</div>
                                </div>
                            `).join(""),a,g.toFixed(1),c.toLocaleString("tr-TR",{minimumFractionDigits:0}),m.toLocaleString("tr-TR",{minimumFractionDigits:0}),3===s.length&&(e,e.toFixed(1));var u=(parseInt(d)+1).toString();let n=0,o="",i="#667eea";i=20<g?(n=1.22*m,o=`🚀 Mağaza son yıl <strong>%${g.toFixed(1)}</strong> büyüdü! Bu momentum ile ${u} için <strong>%22</strong> büyüme hedefi makul.`,"#38ef7d"):10<g?(n=1.16*m,o=`📈 Mağaza sağlam bir büyüme gösteriyor (%${g.toFixed(1)}). ${u} için <strong>%16</strong> büyüme hedefi öneriyoruz.`,"#4facfe"):0<g?(n=1.1*m,o=`➡️ Mağaza stabil büyüme gösteriyor (%${g.toFixed(1)}). ${u} için dikkatli bir <strong>%10</strong> büyüme hedefi uygun.`,"#ffa751"):-10<g?(n=1.05*m,o=`⚠️ Mağaza hafif düşüş yaşıyor (%${g.toFixed(1)}). ${u} için önce <strong>stabilizasyon</strong>, sonra %5 büyüme hedefleyin. <span style="background: rgba(255,255,255,0.2); padding: 4px 8px; border-radius: 4px; font-size: 0.9em;">Acil aksiyon gerekli!</span>`,"#ff6b6b"):(n=m,o=`📉 Mağaza ciddi düşüş yaşıyor (%${g.toFixed(1)}). ${u} için öncelik <strong>mevcut seviyeyi korumak</strong> olmalı. <span style="background: rgba(255,0,0,0.3); padding: 4px 8px; border-radius: 4px; font-size: 0.9em;">🚨 Kapsamlı strateji revizyonu şart!</span>`,"#dc3545"),i,n.toLocaleString("tr-TR",{minimumFractionDigits:0}),m.toLocaleString("tr-TR",{minimumFractionDigits:0}),((n-m)/m*100).toFixed(1),o,0<g&&(n.toLocaleString("tr-TR",{minimumFractionDigits:0}),(n/12).toLocaleString("tr-TR",{minimumFractionDigits:0}),(n/365).toLocaleString("tr-TR",{minimumFractionDigits:0}))}let a={};e.forEach(e=>{var t=e.brand||"Bilinmiyor";a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0)});var p=Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,3);let n={};e.forEach(e=>{var t=e.sales_person||"Bilinmiyor";n[t]||(n[t]=0),n[t]+=parseFloat(e.usd_amount||0)});c=Object.entries(n).sort((e,t)=>t[1]-e[1]).slice(0,3);let o={};e.forEach(e=>{var t=e.category_2||"Bilinmiyor";"all"===t.toLowerCase()||t.toLowerCase().includes("analitik")||t.toLowerCase().includes("eğitim")||(o[t]||(o[t]=0),o[t]+=parseFloat(e.usd_amount||0))});s=Object.entries(o).sort((e,t)=>t[1]-e[1]).slice(0,3);let i=["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"],y={};e.forEach(e=>{var t=new Date(e.date).getMonth();y[t]||(y[t]=0),y[t]+=parseFloat(e.usd_amount||0)});d=Object.entries(y).map(([e,t])=>({month:parseInt(e),name:i[e],value:t})),u=d.sort((e,t)=>t.value-e.value)[0],m=d.sort((e,t)=>e.value-t.value)[0];let h=["Pazar","Pazartesi","Salı","Çarşamba","Perşembe","Cuma","Cumartesi"],b={};e.forEach(e=>{var t=e.day_of_week;null!=t&&(t=(t+1)%7,b[t]||(b[t]=0),b[t]+=parseFloat(e.usd_amount||0))});g=Object.entries(b).map(([e,t])=>({day:parseInt(e),name:h[e],value:t})),d=g.sort((e,t)=>t.value-e.value)[0],g=g.sort((e,t)=>e.value-t.value)[0];let f={};e.forEach(e=>{var t=e.create_hour;null!=t&&(f[t]||(f[t]=0),f[t]+=parseFloat(e.usd_amount||0))});var v=Object.entries(f).map(([e,t])=>({hour:parseInt(e),value:t}));v.sort((e,t)=>t.value-e.value)[0],v.sort((e,t)=>e.value-t.value)[0];let k=0,S=0,C=0,x=0;e.forEach(e=>{var t=e.create_hour,e=parseFloat(e.usd_amount||0);6<=t&&t<12?k+=e:12<=t&&t<17?S+=e:17<=t&&t<22?C+=e:x+=e});v=[{name:"Sabah (06:00-12:00)",value:k},{name:"Öğlen (12:00-17:00)",value:S},{name:"Akşam (17:00-22:00)",value:C},{name:"Gece (22:00-06:00)",value:x}].sort((e,t)=>t.value-e.value);let $={};e.forEach(e=>{var t,a=e.sales_person||"Bilinmiyor",r=e.day_of_week;null!=r&&(t=a+"_"+(r=(r+1)%7),$[t]||($[t]={sp:a,day:r,dayName:h[r],value:0}),$[t].value+=parseFloat(e.usd_amount||0))});var T=Object.values($).sort((e,t)=>t.value-e.value)[0];let I={};e.forEach(e=>{var t,a=e.sales_person||"Bilinmiyor",r=e.create_hour;null!=r&&(t=a+"_"+r,I[t]||(I[t]={sp:a,hour:r,value:0}),I[t].value+=parseFloat(e.usd_amount||0))});var D,e=Object.values(I).sort((e,t)=>t.value-e.value)[0],E=(1e5<r.totalSales&&t.positive.push({title:"💰 Yüksek Ciro",description:`Mağaza toplam <span class="metric-highlight">$${r.totalSales.toLocaleString("tr-TR",{minimumFractionDigits:2})}</span> satış gerçekleştirmiş. Mükemmel performans!`}),0<p.length&&((p[0][1]/r.totalSales*100).toFixed(1),t.positive.push({title:"🏷️ En Başarılı 3 Marka",description:""+p.slice(0,3).map(e=>`${e[0]} (%${(e[1]/r.totalSales*100).toFixed(1)})`).join(", ")})),0<s.length&&((s[0][1]/r.totalSales*100).toFixed(1),t.positive.push({title:"📂 En Başarılı 3 Kategori",description:""+s.slice(0,3).map(e=>`${e[0]} (%${(e[1]/r.totalSales*100).toFixed(1)})`).join(", ")})),u&&m&&(E=(u.value/r.totalSales*100).toFixed(1),D=(m.value/r.totalSales*100).toFixed(1),t.neutral.push({title:"📅 Aylık Performans",description:`En güçlü ay: <span class="metric-highlight">${u.name}</span> (%${E})<br>En zayıf ay: ${m.name} (%${D})`})),d&&g&&(u=(d.value/r.totalSales*100).toFixed(1),E=(g.value/r.totalSales*100).toFixed(1),t.neutral.push({title:"📆 Günlük Performans",description:`En güçlü gün: <span class="metric-highlight">${d.name}</span> (%${u})<br>En zayıf gün: ${g.name} (%${E})`})),0<v.length&&(D=((m=v[0]).value/r.totalSales*100).toFixed(1),t.neutral.push({title:"🕐 Saat Dilimi Performansı",description:`En güçlü: <span class="metric-highlight">${m.name}</span> - Cironun %${D}'i bu saatlerde`})),T&&(u=(T.value/r.totalSales*100).toFixed(1),t.neutral.push({title:"⭐ En Başarılı Kombinasyon",description:`<span class="metric-highlight">${T.sp}</span> - <span class="metric-highlight">${T.dayName}</span> günleri harika! (%${u})`})),getStoreWorkingHours(r.name||""));E.closedDays.map(e=>["Pazar","Pazartesi","Salı","Çarşamba","Perşembe","Cuma","Cumartesi"][e]).join(", ");0<c.length&&(v=c.map((e,t)=>{var a=(e[1]/r.totalSales*100).toFixed(1);return`${t+1}. ${e[0]} (%${a})`}).join("<br>"),t.neutral.push({title:"👨‍💼 En Başarılı Satış Temsilcileri",description:v})),t.neutral.push({title:"📊 Genel Performans",description:`<span class="metric-highlight">${r.uniqueCustomers}</span> farklı müşteri, <span class="metric-highlight">${r.uniqueProducts}</span> farklı ürün satıldı.`}),t.neutral.push({title:"📈 Toplam Satış İçindeki Pay",description:`${r.name} mağazası, toplam şirket satışının <strong>%${r.storeSalesPercentage}</strong> payını oluşturuyor. Bu, $${r.totalAllSales.toLocaleString("tr-TR",{minimumFractionDigits:2})} toplam satış içinde $${r.totalSales.toLocaleString("tr-TR",{minimumFractionDigits:2})} değerinde bir performans.`}),3<=s.length&&t.neutral.push({title:"📂 Kategori Çeşitliliği",description:`En çok satılan kategoriler: ${s.map(e=>e[0]).join(", ")}. Bu kategorilerde güçlü performans.`}),g&&d&&(m=g.day,E.closedDays.includes(m)?t.recommendations.push({icon:"📆",title:"Kapalı Gün Değerlendirmesi",description:g.name+" günleri mağaza kapalı. Bu gün için özel bir strateji gerekmiyor."}):t.recommendations.push({icon:"📆",title:"Gün Bazlı Strateji",description:`${g.name} günleri zayıf. ${d.name} günlerindeki başarılı stratejileri ${g.name}'ya da uygulayın. Özel kampanyalar düzenleyin.`})),e&&e.hour>=E.openHour&&e.hour<E.closeHour&&t.recommendations.push({icon:"⏰",title:"Saat Bazlı Planlama",description:`${e.sp} saat ${e.hour}:00'da en başarılı. Vardiya planlamasını buna göre optimize edin. (Çalışma saatleri: ${E.openHour}:00-${E.closeHour}:00)`}),t.recommendations.push({icon:"🎯",title:"Stok Yönetimi",description:`En çok satan markalar: ${p.map(e=>e[0]).join(", ")}. Bu markaların stok seviyelerini takip edin.`}),t.recommendations.push({icon:"👥",title:"Ekip Yönetimi",description:`En başarılı temsilci ${c[0][0]}. Başarı hikayesini diğer ekip üyeleriyle paylaşın.`});let B='<div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">';0<t.positive.length&&(B+='<div class="analysis-section"><h3 style="color: white; margin-top: 0;">✅ Güçlü Yönler</h3>',t.positive.forEach(e=>{B+=`<div class="insight-item" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                        <strong style="font-size: 1.1em;">${e.title}</strong><br>
                        <span style="opacity: 0.95; margin-top: 8px; display: block;">${e.description}</span>
                    </div>`}),B+="</div>"),0<t.neutral.length&&(B+='<div class="analysis-section" style="margin-top: 25px;"><h3 style="color: white;">💡 Önemli Bilgiler</h3>',t.neutral.forEach(e=>{B+=`<div class="insight-item" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700;">
                        <strong style="font-size: 1.1em;">${e.title}</strong><br>
                        <span style="opacity: 0.95; margin-top: 8px; display: block;">${e.description}</span>
                    </div>`}),B+="</div>"),0<t.recommendations.length&&(B+='<div class="analysis-section" style="margin-top: 25px;"><h3 style="color: white;">🎯 Öneriler</h3>',t.recommendations.forEach(e=>{B+=`<div class="recommendation" style="background: rgba(255, 255, 255, 0.15); padding: 18px; border-radius: 10px; margin: 12px 0;">
                        <span style="font-size: 1.8em; margin-right: 12px;">${e.icon}</span>
                        <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px);">
                            <strong style="font-size: 1.15em; display: block; margin-bottom: 8px;">${e.title}</strong>
                            <p style="margin: 0; opacity: 0.95; line-height: 1.6;">${e.description}</p>
                        </div>
                    </div>`}),B+="</div>"),B+="</div>",document.getElementById("storeAIAnalysisContent").innerHTML=B}let cityBrandChartInstance=null,cityProductChartInstance=null,cityCategoryChartInstance=null,cityMonthlyChartInstance=null;function populateCitySelect(){if(allData&&0!==allData.length){let t=new Set,a=(allData.forEach(e=>{e.partner_city&&t.add(e.partner_city)}),document.getElementById("citySelect"));a?(a.innerHTML='<option value="">-- Şehir Seçin --</option>',0===t.size?(console.warn("⚠️ Hiç şehir verisi bulunamadı"),a.innerHTML+='<option value="" disabled>Şehir verisi bulunamadı</option>'):(Array.from(t).sort().forEach(e=>{var t=document.createElement("option");t.value=e,t.textContent=e,a.appendChild(t)}),console.log("✅ Şehir dropdown dolduruldu:",t.size,"şehir"),console.log("📋 Dropdown içeriği:",a.innerHTML.substring(0,500)))):console.error("❌ citySelect elementi bulunamadı")}else console.warn("⚠️ Şehir listesi doldurulamadı: Veri henüz yüklenmedi")}let targetStoresPopulated=!1;function populateTargetStoreDropdowns(){if(allData&&0!==allData.length)if(targetStoresPopulated)console.log("✅ Mağaza dropdown zaten dolduruldu, tekrar doldurulmayacak");else{let t=new Set;allData.forEach(e=>{e.store&&t.add(e.store)});var e=Array.from(t).sort();let a=document.getElementById("targetYearStore");var n,o,i=document.getElementById("targetYear");a&&i&&(n=(n=JSON.parse(localStorage.getItem("yearlyTargets")||"{}"))[i=i.value]?Object.keys(n[i])[0]:"TÜM MAĞAZALAR",a.innerHTML='<option value="TÜM MAĞAZALAR">🏢 Tüm Mağazalar</option>',e.forEach(e=>{var t=document.createElement("option");t.value=e,t.textContent=e,a.appendChild(t)}),n)&&(a.value=n);let r=document.getElementById("targetMonthStore");r&&(i=JSON.parse(localStorage.getItem("monthlyTargets")||"{}"),n=document.getElementById("targetYear").value,o=document.getElementById("targetMonth").value,o=i[n]&&i[n][o]?Object.keys(i[n])[0]:"TÜM MAĞAZALAR",r.innerHTML='<option value="TÜM MAĞAZALAR">🏢 Tüm Mağazalar</option>',e.forEach(e=>{var t=document.createElement("option");t.value=e,t.textContent=e,r.appendChild(t)}),o)&&(r.value=o),targetStoresPopulated=!0,console.log("✅ Hedef takip mağaza dropdownları dolduruldu:",t.size,"mağaza")}else console.warn("⚠️ Mağaza dropdown doldurulamıyor: Veri yok")}function levenshteinDistance(a,r){var n=a.length,o=r.length,i=[];for(let e=0;e<=n;e++)i[e]=[e];for(let e=0;e<=o;e++)i[0][e]=e;for(let t=1;t<=n;t++)for(let e=1;e<=o;e++)a[t-1]===r[e-1]?i[t][e]=i[t-1][e-1]:i[t][e]=Math.min(i[t-1][e-1]+1,i[t][e-1]+1,i[t-1][e]+1);return i[n][o]}function normalizeTurkish(e){if(!e)return"";let t={"ı":"i","İ":"i","ş":"s","Ş":"s","ğ":"g","Ğ":"g","ü":"u","Ü":"u","ö":"o","Ö":"o","ç":"c","Ç":"c"};return e.toLowerCase().trim().split("").map(e=>t[e]||e).join("")}function normalizeDistrictName(e,t){if(!e||"Bilinmeyen"===e)return e;if(t.includes(e))return e;var a=normalizeTurkish(e);let r=e,n=1/0;var o;for(o of t){var i=normalizeTurkish(o),l=levenshteinDistance(a,i),i=1-l/Math.max(a.length,i.length);l<n&&l<=4&&.65<=i&&(n=l,r=o)}if(r===e&&0<t.length){let e=0;for(var s of t){var d=normalizeTurkish(s),c=levenshteinDistance(a,d),d=1-c/Math.max(a.length,d.length);d>e&&.6<=d&&(e=d,r=s,n=c)}}return r!==e&&console.log(`🔧 İlçe düzeltildi: "${e}" → "${r}" (distance: ${n})`),r}function clearCityFilters(){document.getElementById("citySelect").value="",document.getElementById("districtSelect").value="",document.getElementById("districtSelect").innerHTML='<option value="">-- Önce Şehir Seçin --</option>',document.getElementById("districtSelect").disabled=!0,document.getElementById("cityDateStart").value="",document.getElementById("cityDateEnd").value="",document.getElementById("cityAnalysisContainer").style.display="none",console.log("🗑️ Şehir ve ilçe filtreleri temizlendi")}function handleCityChange(){let n=document.getElementById("citySelect").value,o=document.getElementById("districtSelect");if(console.log("📍 Şehir değişti:",n),n){let t=new Set,a=(allData.forEach(e=>{e.partner_city===n&&e.city&&0<e.city.length&&t.add(e.city)}),console.log("🏘️ Ham ilçe sayısı:",t.size),console.log("📋 İlk 10 ilçe örneği:",Array.from(t).slice(0,10)),Array.from(t)),r=new Map;a.forEach(e=>{e=normalizeDistrictName(e,a);r.has(e)||r.set(e,e)});var e=Array.from(r.keys()).sort();console.log("🏘️ Normalize edilmiş ilçe sayısı:",e.length),o.innerHTML='<option value="">-- Tüm İlçeler --</option>',e.forEach(e=>{var t=document.createElement("option");t.value=e,t.textContent=e,o.appendChild(t)}),o.disabled=0===e.length}else o.innerHTML='<option value="">-- Önce Şehir Seçin --</option>',o.disabled=!0;analyzeCityPerformance()}let cityPopulations={"İstanbul":15907951,"İstanbul (TR)":15907951,Ankara:5803482,"Ankara (TR)":5803482,"İzmir":4462056,"İzmir (TR)":4462056,Bursa:3194720,"Bursa (TR)":3194720,Antalya:2688004,"Antalya (TR)":2688004,Adana:2274106,"Adana (TR)":2274106,Konya:2305609,"Konya (TR)":2305609,Gaziantep:2154051,"Gaziantep (TR)":2154051,"Şanlıurfa":2155805,"Şanlıurfa (TR)":2155805,Kocaeli:2102907,"Kocaeli (TR)":2102907,Mersin:1938389,"Mersin (TR)":1938389,"Diyarbakır":1804880,"Diyarbakır (TR)":1804880,Hatay:1686043,"Hatay (TR)":1686043,Manisa:1468279,"Manisa (TR)":1468279,Kayseri:1434357,"Kayseri (TR)":1434357,Samsun:1368488,"Samsun (TR)":1368488,"Balıkesir":1257590,"Balıkesir (TR)":1257590,"Kahramanmaraş":1168163,"Kahramanmaraş (TR)":1168163,Van:1136757,"Van (TR)":1136757,"Aydın":1148241,"Aydın (TR)":1148241,Denizli:1058663,"Denizli (TR)":1058663,Sakarya:1080080,"Sakarya (TR)":1080080,"Tekirdağ":1158149,"Tekirdağ (TR)":1158149,"Muğla":1042669,"Muğla (TR)":1042669,"Eskişehir":906617,"Eskişehir (TR)":906617,Mardin:870374,"Mardin (TR)":870374,Malatya:812580,"Malatya (TR)":812580,Erzurum:760476,"Erzurum (TR)":760476,Trabzon:818023,"Trabzon (TR)":818023,"Elazığ":602877,"Elazığ (TR)":602877,"Şırnak":542743,"Şırnak (TR)":542743,Ordu:769854,"Ordu (TR)":769854,"Kütahya":589524,"Kütahya (TR)":589524,Afyonkarahisar:754854,"Afyonkarahisar (TR)":754854,Tokat:617062,"Tokat (TR)":617062,"Çorum":530126,"Çorum (TR)":530126,Sivas:643864,"Sivas (TR)":643864,Zonguldak:588510,"Zonguldak (TR)":588510,Aksaray:433229,"Aksaray (TR)":433229,Batman:634491,"Batman (TR)":634491,Isparta:446102,"Isparta (TR)":446102,"Çanakkale":557099,"Çanakkale (TR)":557099,"Uşak":378115,"Uşak (TR)":378115,"Düzce":405285,"Düzce (TR)":405285,Osmaniye:558016,"Osmaniye (TR)":558016,Amasya:338267,"Amasya (TR)":338267,Giresun:453912,"Giresun (TR)":453912,"Kırıkkale":286602,"Kırıkkale (TR)":286602,Edirne:413903,"Edirne (TR)":413903,"Kırşehir":250120,"Kırşehir (TR)":250120,Bolu:320014,"Bolu (TR)":320014,"Adıyaman":635286,"Adıyaman (TR)":635286,"Kırklareli":368872,"Kırklareli (TR)":368872,Yozgat:424981,"Yozgat (TR)":424981,"Nevşehir":310538,"Nevşehir (TR)":310538,Burdur:273799,"Burdur (TR)":273799,Karaman:262997,"Karaman (TR)":262997,Kilis:147887,"Kilis (TR)":147887,"Ağrı":528744,"Ağrı (TR)":528744,"Niğde":365419,"Niğde (TR)":365419,Kastamonu:383373,"Kastamonu (TR)":383373,Artvin:170875,"Artvin (TR)":170875,Siirt:331070,"Siirt (TR)":331070,Bilecik:228673,"Bilecik (TR)":228673,Sinop:218273,"Sinop (TR)":218273,Rize:348608,"Rize (TR)":348608,"Karabük":248014,"Karabük (TR)":248014,Yalova:291001,"Yalova (TR)":291001,"Bartın":198999,"Bartın (TR)":198999,"Muş":408728,"Muş (TR)":408728,Bitlis:353988,"Bitlis (TR)":353988,Erzincan:236034,"Erzincan (TR)":236034,Hakkari:287625,"Hakkari (TR)":287625,Ardahan:94932,"Ardahan (TR)":94932,"Iğdır":201314,"Iğdır (TR)":201314,Kars:281869,"Kars (TR)":281869,"Gümüşhane":164521,"Gümüşhane (TR)":164521,"Çankırı":195766,"Çankırı (TR)":195766,Tunceli:89266,"Tunceli (TR)":89266,Bayburt:84843,"Bayburt (TR)":84843};function analyzeCityPerformance(){let l=document.getElementById("citySelect").value,a=document.getElementById("districtSelect").value,r=document.getElementById("cityDateStart").value,n=document.getElementById("cityDateEnd").value;if(l){console.log("🌍 Şehir analizi:",l,a?"/ "+a:"","Tarih:",r,"-",n);let t=[];a&&allData.forEach(e=>{e.partner_city===l&&e.city&&t.push(e.city)});var e=allData.filter(e=>{if(e.partner_city!==l)return!1;if(a&&e.city){if(normalizeDistrictName(e.city,t)!==a)return!1}else if(a&&!e.city)return!1;return!(r&&e.date<r||n&&e.date>n)});if(0===e.length)alert("Bu şehir için veri bulunamadı");else{let r=e.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0);var s=e.reduce((e,t)=>e+parseFloat(t.quantity||0),0),d=new Set(e.map(e=>e.partner)).size,c=new Set(e.map(e=>e.date)).size,c=r/Math.max(c,1);let a={};e.forEach(e=>{var t=e.sales_person||"Bilinmiyor";a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0)});Object.entries(a).sort((e,t)=>t[1]-e[1])[0];let n={};e.forEach(e=>{var t=e.store||"Bilinmiyor";n[t]||(n[t]=0),n[t]+=parseFloat(e.usd_amount||0)});Object.entries(n).sort((e,t)=>t[1]-e[1])[0];var m=cityPopulations[l]||0,g=0<m?r/m:0,m=(document.getElementById("cityTotalSales").textContent="$"+r.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("cityTotalQty").textContent=s.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("cityCustomerCount").textContent=d,document.getElementById("cityAvgBasket").textContent="$"+c.toLocaleString("tr-TR",{minimumFractionDigits:2}),0<m?(m=(m/1e6).toFixed(2),document.getElementById("cityPopulation").textContent=m+"M",document.getElementById("cityPerCapitaSales").textContent="$"+g.toLocaleString("tr-TR",{minimumFractionDigits:2})):(document.getElementById("cityPopulation").textContent="Veri Yok",document.getElementById("cityPerCapitaSales").textContent="-"),Object.entries(a).sort((e,t)=>t[1]-e[1]).slice(0,5));let o="";m.forEach((e,t)=>{var a=(e[1]/r*100).toFixed(1);o+=`<div style="margin: 5px 0;">${t+1}. ${e[0]}: <strong>$${e[1].toLocaleString("tr-TR",{minimumFractionDigits:2})}</strong> (%${a})</div>`}),document.getElementById("cityTopSalespersons").innerHTML=o;g=Object.entries(n).sort((e,t)=>t[1]-e[1]).slice(0,5);let i="";g.forEach((e,t)=>{var a=(e[1]/r*100).toFixed(1);i+=`<div style="margin: 5px 0;">${t+1}. ${e[0]}: <strong>$${e[1].toLocaleString("tr-TR",{minimumFractionDigits:2})}</strong> (%${a})</div>`}),document.getElementById("cityTopStores").innerHTML=i,document.getElementById("cityAnalysisContainer").style.display="block",renderCityBrandChart(e),renderCityProductChart(e),renderCityCategoryChart(e),renderCityMonthlyChart(e),renderCityYearlyChart(e),performCityAIAnalysis(e,l,{totalSales:r,totalQty:s,uniqueCustomers:d,avgBasket:c})}}else document.getElementById("cityAnalysisContainer").style.display="none"}function renderCityBrandChart(e){let a={};e.forEach(e=>{var t=e.brand||"Bilinmiyor";a[t]||(a[t]={sales:0,qty:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0)});var e=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,10),t=e.map(e=>e[0]),r=e.map(e=>e[1].sales),e=e.map(e=>e[1].qty),n=document.getElementById("cityBrandChart");n&&(cityBrandChartInstance&&cityBrandChartInstance.destroy(),cityBrandChartInstance=new Chart(n,{type:"bar",data:{labels:t,datasets:[{label:"Satış (USD - KDV Hariç)",data:r,backgroundColor:"rgba(102, 126, 234, 0.6)",borderColor:"rgba(102, 126, 234, 1)",borderWidth:2,yAxisID:"y"},{label:"Miktar",data:e,backgroundColor:"rgba(255, 159, 64, 0.6)",borderColor:"rgba(255, 159, 64, 1)",borderWidth:2,yAxisID:"y"}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"}},scales:{x:{beginAtZero:!0}}}}))}function renderCityProductChart(e){let a={};e.forEach(e=>{var t=e.product||"Bilinmiyor";a[t]||(a[t]={sales:0,qty:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0)});var e=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,10),t=e.map(e=>e[0].substring(0,30)+(30<e[0].length?"...":"")),r=e.map(e=>e[1].sales),e=e.map(e=>e[1].qty),n=document.getElementById("cityProductChart");n&&(cityProductChartInstance&&cityProductChartInstance.destroy(),cityProductChartInstance=new Chart(n,{type:"bar",data:{labels:t,datasets:[{label:"Satış (USD - KDV Hariç)",data:r,backgroundColor:"rgba(56, 239, 125, 0.6)",borderColor:"rgba(56, 239, 125, 1)",borderWidth:2,yAxisID:"y"},{label:"Miktar",data:e,backgroundColor:"rgba(255, 159, 64, 0.6)",borderColor:"rgba(255, 159, 64, 1)",borderWidth:2,yAxisID:"y"}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"}},scales:{x:{beginAtZero:!0}}}}))}function renderCityCategoryChart(e){let a={};e.forEach(e=>{var t=e.category_2||"Bilinmiyor";"all"===t.toLowerCase()||t.toLowerCase().includes("analitik")||t.toLowerCase().includes("eğitim")||(a[t]||(a[t]={sales:0,qty:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0))});var e=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,10),t=e.map(e=>e[0]),r=e.map(e=>e[1].sales),e=e.map(e=>e[1].qty),n=document.getElementById("cityCategoryChart");n&&(cityCategoryChartInstance&&cityCategoryChartInstance.destroy(),cityCategoryChartInstance=new Chart(n,{type:"bar",data:{labels:t,datasets:[{label:"Satış (USD - KDV Hariç)",data:r,backgroundColor:"rgba(245, 87, 108, 0.6)",borderColor:"rgba(245, 87, 108, 1)",borderWidth:2,yAxisID:"y"},{label:"Miktar",data:e,backgroundColor:"rgba(255, 159, 64, 0.6)",borderColor:"rgba(255, 159, 64, 1)",borderWidth:2,yAxisID:"y"}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"}},scales:{x:{beginAtZero:!0}}}}))}function renderCityMonthlyChart(e){let a={};e.forEach(e=>{var t=new Date(e.date),t=t.getFullYear()+"-"+String(t.getMonth()+1).padStart(2,"0");a[t]||(a[t]=0),a[t]+=parseFloat(e.usd_amount||0)});var e=Object.entries(a).sort((e,t)=>e[0].localeCompare(t[0])),t=e.map(e=>e[0]),e=e.map(e=>e[1]),r=document.getElementById("cityMonthlyChart");r&&(cityMonthlyChartInstance&&cityMonthlyChartInstance.destroy(),cityMonthlyChartInstance=new Chart(r,{type:"line",data:{labels:t,datasets:[{label:"Aylık Satış (USD)",data:e,borderColor:"rgba(102, 126, 234, 1)",backgroundColor:"rgba(102, 126, 234, 0.1)",borderWidth:3,fill:!0,tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}}))}let cityYearlyChartInstance=null;function renderCityYearlyChart(e){let n={},t=(e.forEach(e=>{var t=new Date(e.date),a=t.getFullYear(),t=String(t.getMonth()+1).padStart(2,"0");n[a]||(n[a]={}),n[a][t]||(n[a][t]=0),n[a][t]+=parseFloat(e.usd_amount||0)}),new Set),o=(Object.values(n).forEach(e=>{Object.keys(e).forEach(e=>t.add(e))}),Array.from(t).sort()),i=[],l=[{border:"rgba(102, 126, 234, 1)",bg:"rgba(102, 126, 234, 0.1)"},{border:"rgba(245, 87, 108, 1)",bg:"rgba(245, 87, 108, 0.1)"},{border:"rgba(56, 239, 125, 1)",bg:"rgba(56, 239, 125, 0.1)"},{border:"rgba(255, 206, 86, 1)",bg:"rgba(255, 206, 86, 0.1)"}];Object.keys(n).sort().forEach((e,t)=>{let a=n[e];var r=o.map(e=>a[e]||0),t=l[t%l.length];i.push({label:e+" Satışları",data:r,borderColor:t.border,backgroundColor:t.bg,borderWidth:3,fill:!0,tension:.4})});e=document.getElementById("cityYearlyChart");if(e){cityYearlyChartInstance&&cityYearlyChartInstance.destroy();let t=["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];var a=o.map(e=>t[parseInt(e)-1]);cityYearlyChartInstance=new Chart(e,{type:"line",data:{labels:a,datasets:i},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"},tooltip:{callbacks:{label:function(e){return e.dataset.label+": $"+e.parsed.y.toLocaleString("tr-TR",{minimumFractionDigits:2})}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}})}}function performCityAIAnalysis(e,t,a){console.log("🤖 Şehir AI analizi başlatılıyor...");let r={};e.forEach(e=>{var t=e.brand||"Bilinmiyor";r[t]||(r[t]=0),r[t]+=parseFloat(e.usd_amount||0)});var n=Object.entries(r).sort((e,t)=>t[1]-e[1]).slice(0,3);let o={};e.forEach(e=>{var t=e.category_2||"Bilinmiyor";o[t]||(o[t]=0),o[t]+=parseFloat(e.usd_amount||0)});var i,e=Object.entries(o).sort((e,t)=>t[1]-e[1]).slice(0,3),l={positive:[],negative:[],neutral:[],recommendations:[]},s=(0<n.length&&(i=((s=n[0])[1]/a.totalSales*100).toFixed(1),l.positive.push({title:`🏷️ ${s[0]} Lider Marka`,description:`${t} ilinde ${s[0]} markası %${i} pay ile lider ($${s[1].toLocaleString("tr-TR",{minimumFractionDigits:2})}).`})),0<e.length&&(s=((i=e[0])[1]/a.totalSales*100).toFixed(1),l.positive.push({title:`📂 ${i[0]} En Popüler Kategori`,description:`${t} ilinde ${i[0]} kategorisi %${s} pay ile en çok tercih edilen ($${i[1].toLocaleString("tr-TR",{minimumFractionDigits:2})}).`})),l.neutral.push({title:`📊 ${t} Genel Performans`,description:`Toplam ${a.uniqueCustomers} müşteri, $${a.totalSales.toLocaleString("tr-TR",{minimumFractionDigits:2})} satış gerçekleştirdi. Ortalama sepet değeri $${a.avgBasket.toLocaleString("tr-TR",{minimumFractionDigits:2})}.`}),3<=n.length&&l.neutral.push({title:"🏷️ Top 3 Marka",description:n.map(e=>e[0]).join(", ")+` markaları ${t} ilinde en çok tercih ediliyor.`}),l.recommendations.push({icon:"📦",title:"Stok Optimizasyonu",description:`${t} ilindeki mağazalarda ${n[0][0]} markası ve ${e[0][0]} kategorisi ürünlerinin stok seviyesini artırın.`}),l.recommendations.push({icon:"📢",title:"Bölgesel Kampanya",description:`${t} ili için ${n[0][0]} markasında özel kampanya düzenleyin. Bu bölgede yüksek talep var.`}),l.recommendations.push({icon:"🎯",title:"Müşteri Segmentasyonu",description:`${t} ilindeki ${a.uniqueCustomers} müşteriye özel e-posta kampanyaları gönderin. Tercih ettikleri kategorilerdeki yeni ürünleri tanıtın.`}),`
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">
                    ${0<l.positive.length?`
                    <div class="analysis-section">
                        <h3 style="color: white; margin-top: 0;">✅ ${t} Güçlü Yönler</h3>
                        ${l.positive.map(e=>`
                            <div class="insight-item insight-positive" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">✅</span>
                                <strong style="font-size: 1.1em;">${e.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${e.description}</span>
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    ${0<l.neutral.length?`
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">💡 Genel Bilgiler</h3>
                        ${l.neutral.map(e=>`
                            <div class="insight-item insight-neutral" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">💡</span>
                                <strong style="font-size: 1.1em;">${e.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${e.description}</span>
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">🎯 Aksiyon Önerileri</h3>
                        ${l.recommendations.map(e=>`
                            <div class="recommendation" style="background: rgba(255, 255, 255, 0.15); padding: 18px; border-radius: 10px; margin: 12px 0;">
                                <span class="recommendation-icon" style="font-size: 1.8em; margin-right: 12px;">${e.icon}</span>
                                <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px);">
                                    <strong style="font-size: 1.15em; display: block; margin-bottom: 8px;">${e.title}</strong>
                                    <p style="margin: 0; opacity: 0.95; line-height: 1.6;">${e.description}</p>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                </div>
            `);document.getElementById("cityAIAnalysisContent").innerHTML=s}let stockList=[];function handleStockExcelUpload(e){var t,e=e.target.files[0];e&&(5242880<e.size?alert("Dosya çok büyük! Maksimum 5 MB olmalıdır."):["application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/vnd.ms-excel"].includes(e.type)?(console.log("📄 Excel dosyası okunuyor..."),(t=new FileReader).onload=e=>{try{var t=new Uint8Array(e.target.result),a=XLSX.read(t,{type:"array"}),r=a.SheetNames[0],n=a.Sheets[r],o=XLSX.utils.sheet_to_json(n);console.log("📊 Excel verisi:",o),stockList=[],o.forEach(e=>{var t=e["Ürün Kodu"]||e.product_code||e["Product Code"]||e.Kod||e.Code,e=e["Stok Miktarı"]||e.stock||e.Stock||e.Miktar||e.Quantity||e.qty;t&&e&&stockList.push({product_code:String(t).trim(),qty:parseFloat(e)})}),0===stockList.length?alert('Excel dosyasında geçerli veri bulunamadı! Kolon isimleri: "Ürün Kodu" ve "Stok Miktarı" olmalı.'):(console.log("✅ Stok listesi yüklendi:",stockList.length,"ürün"),renderStockList())}catch(e){console.error("❌ Excel okuma hatası:",e),alert("Excel dosyası okunamadı! Lütfen dosya formatını kontrol edin.")}},t.readAsArrayBuffer(e)):alert("Sadece Excel dosyaları (.xlsx, .xls) yükleyebilirsiniz."))}function addManualStock(){let t=document.getElementById("manualProductCode").value.trim();var e,a=parseFloat(document.getElementById("manualStockQty").value);t?isNaN(a)||a<=0?alert("Lütfen geçerli bir stok miktarı girin"):(0<=(e=stockList.findIndex(e=>e.product_code===t))?stockList[e].qty=a:stockList.push({product_code:t,qty:a}),document.getElementById("manualProductCode").value="",document.getElementById("manualStockQty").value="",console.log("✅ Stok eklendi:",t,a),renderStockList()):alert("Lütfen ürün kodu girin")}function renderStockList(){if(0===stockList.length)document.getElementById("stockListContainer").style.display="none";else{document.getElementById("stockListContainer").style.display="block";let a=`
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left;">#</th>
                            <th style="padding: 15px; text-align: left;">Ürün Kodu</th>
                            <th style="padding: 15px; text-align: right;">Stok Miktarı</th>
                            <th style="padding: 15px; text-align: center;">İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
            `;stockList.forEach((e,t)=>{a+=`
                    <tr style="border-bottom: 1px solid #eee; ${t%2==0?"background: #f8f9fa;":""}">
                        <td style="padding: 12px;">${t+1}</td>
                        <td style="padding: 12px;"><strong>${e.product_code}</strong></td>
                        <td style="padding: 12px; text-align: right;">${e.qty.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                        <td style="padding: 12px; text-align: center;">
                            <button onclick="removeStock(${t})" style="background: #dc3545; color: white; border: none; padding: 5px 15px; border-radius: 5px; cursor: pointer;">
                                🗑️ Sil
                            </button>
                        </td>
                    </tr>
                `}),a+=`
                    </tbody>
                </table>
            `,document.getElementById("stockListTable").innerHTML=a}}function removeStock(e){stockList.splice(e,1),renderStockList()}function clearStockList(){confirm("Tüm stok listesini temizlemek istediğinize emin misiniz?")&&(stockList=[],renderStockList(),document.getElementById("stockDistributionResults").style.display="none")}function analyzeStockDistribution(){if(0===stockList.length)alert("Önce stok listesi yükleyin veya manuel giriş yapın");else{console.log("🤖 AI stok dağılım analizi başlatılıyor...");let t=document.getElementById("stockDateStart").value,a=document.getElementById("stockDateEnd").value,r=(console.log("📅 Tarih Filtreleri:",{dateStart:t,dateEnd:a}),[]);stockList.forEach(i=>{let e=allData.filter(e=>e.product&&e.product.toLowerCase().includes(i.product_code.toLowerCase()));if(t&&(e=e.filter(e=>e.date>=t)),0===(e=a?e.filter(e=>e.date<=a):e).length)r.push({productCode:i.product_code,totalStock:i.qty,distribution:[],message:`⚠️ "${i.product_code}" için geçmiş satış verisi bulunamadı. Eşit dağılım öneriliyor.`,noData:!0});else{let a={},n=(e.forEach(e=>{var t=e.store||"Bilinmiyor";a[t]||(a[t]={qty:0,sales:0}),a[t].qty+=parseFloat(e.quantity||0),a[t].sales+=parseFloat(e.usd_amount||0)}),Object.values(a).reduce((e,t)=>e+t.qty,0)),o=[];Object.entries(a).forEach(([e,t])=>{var a=t.qty/n,r=Math.round(i.qty*a);o.push({store:e,historicalQty:t.qty,historicalSales:t.sales,percentage:(100*a).toFixed(1),recommendedQty:r})}),o.sort((e,t)=>t.recommendedQty-e.recommendedQty),r.push({productCode:i.product_code,totalStock:i.qty,distribution:o,message:`✅ "${i.product_code}" için ${o.length} mağazaya dağılım önerisi hazırlandı.`,noData:!1})}}),renderStockDistributionResults(r)}}function clearStockDateFilters(){document.getElementById("stockDateStart").value="",document.getElementById("stockDateEnd").value="",console.log("🔄 Stok tarih filtreleri temizlendi")}function renderStockDistributionResults(e){document.getElementById("stockDistributionResults").style.display="block";let a="";e.forEach((e,t)=>{a+=`
                    <div style="background: white; padding: 30px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
                        <h3 style="margin: 0 0 20px 0; color: #667eea;">
                            ${t+1}. ${e.productCode} (Toplam Stok: ${e.totalStock.toLocaleString("tr-TR",{minimumFractionDigits:2})} adet)
                        </h3>
                        <p style="color: #6c757d; margin-bottom: 20px;">${e.message}</p>
                        
                        ${e.noData?`
                            <div style="background: #fff3cd; padding: 20px; border-radius: 10px; border-left: 4px solid #ffc107;">
                                <strong>💡 Öneri:</strong> Geçmiş satış verisi olmadığı için mağazalara eşit dağıtım yapabilirsiniz.
                            </div>
                        `:`
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead style="background: #f8f9fa;">
                                    <tr>
                                        <th style="padding: 12px; text-align: left; border-bottom: 2px solid #ddd;">Mağaza</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Geçmiş Satış</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Pay (%)</th>
                                        <th style="padding: 12px; text-align: right; border-bottom: 2px solid #ddd;">Önerilen Stok</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${e.distribution.map((e,t)=>`
                                        <tr style="border-bottom: 1px solid #eee; ${t%2==0?"background: #f8f9fa;":""}">
                                            <td style="padding: 12px;"><strong>${e.store}</strong></td>
                                            <td style="padding: 12px; text-align: right;">${e.historicalQty.toLocaleString("tr-TR",{minimumFractionDigits:2})} adet</td>
                                            <td style="padding: 12px; text-align: right; color: #667eea; font-weight: bold;">${e.percentage}%</td>
                                            <td style="padding: 12px; text-align: right; color: #38ef7d; font-weight: bold; font-size: 1.1em;">${e.recommendedQty} adet</td>
                                        </tr>
                                    `).join("")}
                                </tbody>
                            </table>
                            
                            <div style="background: #d1ecf1; padding: 20px; border-radius: 10px; border-left: 4px solid #0c5460; margin-top: 20px;">
                                <strong>🤖 AI Öneri:</strong> Bu dağılım, geçmiş satış performansına göre optimize edilmiştir. 
                                En yüksek satış yapan mağazalara daha fazla stok ayrılmıştır.
                            </div>
                        `}
                    </div>
                `}),document.getElementById("stockDistributionContent").innerHTML=a,document.getElementById("stockDistributionResults").scrollIntoView({behavior:"smooth",block:"start"})}let salespersonBrandChartInstance=null,salespersonCategoryChartInstance=null,salespersonStoreChartInstance=null,salespersonMonthlyChartInstance=null,comparisonSalesChartInstance=null,comparisonQtyChartInstance=null,selectedSalespersons=[],comparisonStoreSalesChartInstance=null,comparisonStoreQtyChartInstance=null;function populateSalespersonYearFilter(){if(allData&&0!==allData.length){let t=new Set,a=new Set,r=new Set;allData.forEach(e=>{e.date&&3<=(e=e.date.split("-")).length&&(t.add(e[0]),a.add(e[1]),r.add(e[2]))}),populateMultiSelect("filterSalespersonYear",Array.from(t).sort().reverse(),"countSalespersonYear"),populateMultiSelect("filterSalespersonMonth",Array.from(a).sort(),"countSalespersonMonth"),populateMultiSelect("filterSalespersonDay",Array.from(r).sort(),"countSalespersonDay")}}function toggleSalespersonCustomDayRange(e){var t=document.getElementById("salespersonCustomDayRange");"custom"===e?t.style.display="block":(t.style.display="none",e?([t,e]=e.split("-"),document.getElementById("salespersonStartDay").value=t,document.getElementById("salespersonEndDay").value=e):(document.getElementById("salespersonStartDay").value="",document.getElementById("salespersonEndDay").value=""))}function clearSalespersonFilters(){var e=document.querySelectorAll('#filterSalespersonYear input[type="checkbox"]'),t=document.querySelectorAll('#filterSalespersonMonth input[type="checkbox"]'),a=document.querySelectorAll('#filterSalespersonDay input[type="checkbox"]');e.forEach(e=>e.checked=!1),t.forEach(e=>e.checked=!1),a.forEach(e=>e.checked=!1),updateSelectionCount("filterSalespersonYear","countSalespersonYear"),updateSelectionCount("filterSalespersonMonth","countSalespersonMonth"),updateSelectionCount("filterSalespersonDay","countSalespersonDay"),console.log("✅ Satış temsilcisi filtreleri temizlendi")}function searchSalespersonProfile(){let n=[];if(0<selectedSalespersons.length)n=selectedSalespersons;else{var e=document.getElementById("salespersonSearchInput").value.trim();if(!e)return void alert("Lütfen bir satış temsilcisi adı girin veya listeden seçin");e=e.split(",").map(e=>e.trim().toLowerCase()).filter(e=>e);if(0===e.length)return void alert("Lütfen geçerli bir satış temsilcisi adı girin");let r={};if(allData.forEach(e=>{var t=e.sales_person||"",e=e.store||"";e.toLowerCase().includes("analitik")||e.toLowerCase().includes("eğitim")||t&&!r[t]&&(r[t]=t)}),n=[],e.forEach(t=>{var e,a=Object.keys(r).filter(e=>e.toLowerCase().includes(t));0<a.length&&(e=a.find(e=>e.toLowerCase()===t),n.push(e||a[0]))}),0===n.length)return void alert("❌ Girilen isimlere uygun satış temsilcisi bulunamadı!");3<(n=[...new Set(n)]).length&&(alert("⚠️ En fazla 3 satış temsilcisi arayabilirsiniz!"),n=n.slice(0,3))}console.log("🔍 Satış temsilcileri aranıyor:",n);var e=Array.from(document.querySelectorAll('#filterSalespersonYear input[type="checkbox"]:checked')).map(e=>e.value),t=Array.from(document.querySelectorAll('#filterSalespersonMonth input[type="checkbox"]:checked')).map(e=>e.value),a=Array.from(document.querySelectorAll('#filterSalespersonDay input[type="checkbox"]:checked')).map(e=>e.value);console.log("📅 Filtreler:",{yearFilter:e,monthFilter:t,dayFilter:a}),1===n.length?renderSingleSalespersonView(n[0],e,t,a):renderMultipleSalespersonsView(n,e,t,a)}function renderSingleSalespersonView(a,r,n,o){var e,t,i,l,s,d,c,m,g,u=allData.filter(e=>{if(!e.sales_person||!e.sales_person.toLowerCase().includes(a.toLowerCase()))return!1;var t=(e.store||"").toLowerCase();if(t.includes("analitik")||t.includes("eğitim"))return!1;if(!e.date)return!1;if(0<r.length){t=e.date.substring(0,4);if(!r.includes(t))return!1}if(0<n.length){t=e.date.substring(5,7);if(!n.includes(t))return!1}if(0<o.length){t=e.date.substring(8,10);if(!o.includes(t))return!1}return!0});0===u.length?(document.getElementById("salespersonProfileContainer").style.display="none",document.getElementById("salespersonSearchNoResults").style.display="block"):(document.getElementById("salespersonSearchNoResults").style.display="none",document.getElementById("salespersonProfileContainer").style.display="block",document.getElementById("singleSalespersonView").style.display="block",document.getElementById("multipleSalespersonsView").style.display="none",document.getElementById("salespersonBrandCategorySection").style.display="grid",document.getElementById("salespersonMonthlySection").style.display="block",document.getElementById("salespersonTopProductsSection").style.display="block",document.getElementById("salespersonBottomProductsSection").style.display="block",e=u[0].sales_person,document.getElementById("salespersonBrandChartTitle").textContent=`🏷️ ${e} - En Çok Sattığı Markalar (Top 10)`,document.getElementById("salespersonCategoryChartTitle").textContent=`📂 ${e} - En Çok Sattığı Kategoriler`,t=u.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0),i=u.reduce((e,t)=>e+parseFloat(t.quantity||0),0),l=new Set(u.map(e=>e.date)).size,s=new Set(u.map(e=>e.move_name)).size,d=t/Math.max(l,1),c=t/Math.max(s,1),m=new Set(u.map(e=>e.partner)).size,g=new Set(u.map(e=>e.product)).size,document.getElementById("salespersonName").textContent=e,document.getElementById("salespersonTotalSales").textContent="$"+t.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("salespersonTotalQty").textContent=i.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("salespersonInvoiceCount").textContent=s,document.getElementById("salespersonAvgTransaction").textContent="$"+d.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("salespersonAvgBasket").textContent="$"+c.toLocaleString("tr-TR",{minimumFractionDigits:2}),document.getElementById("salespersonUniqueCustomers").textContent=m,document.getElementById("salespersonUniqueProducts").textContent=g,renderSalespersonBrandChart(u),renderSalespersonCategoryChart(u),renderSalespersonMonthlyChart(u),renderSalespersonTopProducts(lastSalespersonTopProductsData=u),renderSalespersonBottomProducts(u),performSalespersonAIAnalysis(u,{name:e,totalSales:t,totalQty:i,transactionCount:l,avgTransaction:d,uniqueCustomers:m,uniqueProducts:g}))}function renderMultipleSalespersonsView(e,c,m,g){var t,e=e.map(a=>{var e=allData.filter(e=>{if(!e.sales_person||e.sales_person!==a)return!1;var t=(e.store||"").toLowerCase();if(t.includes("analitik")||t.includes("eğitim"))return!1;if(!e.date)return!1;if(0<c.length){t=e.date.substring(0,4);if(!c.includes(t))return!1}if(0<m.length){t=e.date.substring(5,7);if(!m.includes(t))return!1}if(0<g.length){t=e.date.substring(8,10);if(!g.includes(t))return!1}return!0}),t=e.reduce((e,t)=>e+parseFloat(t.usd_amount||0),0),r=e.reduce((e,t)=>e+parseFloat(t.quantity||0),0),n=new Set(e.map(e=>e.date)).size,o=new Set(e.map(e=>e.move_name)).size,i=t/Math.max(n,1),l=t/Math.max(o,1),s=new Set(e.map(e=>e.partner)).size,d=new Set(e.map(e=>e.product)).size;return{name:a,data:e,invoiceCount:o,avgBasket:l,totalSales:t,totalQty:r,transactionCount:n,avgTransaction:i,uniqueCustomers:s,uniqueProducts:d}}).filter(e=>0<e.data.length);0===e.length?(document.getElementById("salespersonProfileContainer").style.display="none",document.getElementById("salespersonSearchNoResults").style.display="block"):(document.getElementById("salespersonSearchNoResults").style.display="none",document.getElementById("salespersonProfileContainer").style.display="block",document.getElementById("singleSalespersonView").style.display="none",document.getElementById("multipleSalespersonsView").style.display="block",renderSalespersonComparisonTable(e),renderSalespersonComparisonCharts(e),document.getElementById("salespersonBrandCategorySection").style.display="none",document.getElementById("salespersonMonthlySection").style.display="none",document.getElementById("salespersonTopProductsSection").style.display="none",document.getElementById("salespersonBottomProductsSection").style.display="none",(t=document.getElementById("salespersonAIAnalysisPanel"))&&(t.style.display="block"),performMultipleSalespersonsAIAnalysis(e))}function renderSalespersonBrandChart(e){let a={};e.forEach(e=>{var t=e.brand||"Bilinmiyor";a[t]||(a[t]={sales:0,qty:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0)});var e=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,10),t=e.map(e=>e[0]),r=e.map(e=>e[1].sales),e=e.map(e=>e[1].qty),n=document.getElementById("salespersonBrandChart");n&&(salespersonBrandChartInstance&&salespersonBrandChartInstance.destroy(),salespersonBrandChartInstance=new Chart(n,{type:"bar",data:{labels:t,datasets:[{label:"Satış (USD - KDV Hariç)",data:r,backgroundColor:"rgba(102, 126, 234, 0.6)",borderColor:"rgba(102, 126, 234, 1)",borderWidth:2,yAxisID:"y"},{label:"Miktar",data:e,backgroundColor:"rgba(255, 159, 64, 0.6)",borderColor:"rgba(255, 159, 64, 1)",borderWidth:2,yAxisID:"y"}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"}},scales:{x:{beginAtZero:!0}}}}))}function renderSalespersonCategoryChart(e){let a={};e.forEach(e=>{var t=e.category_2||"";!t||"all"===t.toLowerCase()||"bilinmiyor"===t.toLowerCase()||t.toLowerCase().includes("analitik")||t.toLowerCase().includes("eğitim")||(a[t]||(a[t]={sales:0,qty:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0))});var e=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,10),t=e.map(e=>e[0]),r=e.map(e=>e[1].sales),e=e.map(e=>e[1].qty),n=document.getElementById("salespersonCategoryChart");n&&(salespersonCategoryChartInstance&&salespersonCategoryChartInstance.destroy(),salespersonCategoryChartInstance=new Chart(n,{type:"bar",data:{labels:t,datasets:[{label:"Satış (USD - KDV Hariç)",data:r,backgroundColor:"rgba(56, 239, 125, 0.6)",borderColor:"rgba(56, 239, 125, 1)",borderWidth:2,yAxisID:"y"},{label:"Miktar",data:e,backgroundColor:"rgba(255, 159, 64, 0.6)",borderColor:"rgba(255, 159, 64, 1)",borderWidth:2,yAxisID:"y"}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"}},scales:{x:{beginAtZero:!0}}}}))}function renderSalespersonStoreChart(e){let a={};e.forEach(e=>{var t=e.store||"Bilinmiyor";a[t]||(a[t]={sales:0,qty:0}),a[t].sales+=parseFloat(e.usd_amount||0),a[t].qty+=parseFloat(e.quantity||0)});var e=Object.entries(a).sort((e,t)=>t[1].sales-e[1].sales).slice(0,5),t=e.map(e=>e[0].replace(/\[.*?\]\s*/g,"").replace(/^.*?\s-\s/,"").trim()),r=e.map(e=>e[1].sales),e=e.map(e=>e[1].qty),n=document.getElementById("salespersonStoreChart");n&&(salespersonStoreChartInstance&&salespersonStoreChartInstance.destroy(),salespersonStoreChartInstance=new Chart(n,{type:"bar",data:{labels:t,datasets:[{label:"Satış (USD - KDV Hariç)",data:r,backgroundColor:"rgba(245, 87, 108, 0.6)",borderColor:"rgba(245, 87, 108, 1)",borderWidth:2,yAxisID:"y"},{label:"Miktar",data:e,backgroundColor:"rgba(255, 159, 64, 0.6)",borderColor:"rgba(255, 159, 64, 1)",borderWidth:2,yAxisID:"y"}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"}},scales:{x:{beginAtZero:!0}}}}))}function renderSalespersonMonthlyChart(e){let n={},t=(e.forEach(e=>{var t=new Date(e.date),a=t.getFullYear(),t=String(t.getMonth()+1).padStart(2,"0");n[a]||(n[a]={}),n[a][t]||(n[a][t]=0),n[a][t]+=parseFloat(e.usd_amount||0)}),new Set),o=(Object.values(n).forEach(e=>{Object.keys(e).forEach(e=>t.add(e))}),Array.from(t).sort()),i=[],l=[{border:"rgba(102, 126, 234, 1)",bg:"rgba(102, 126, 234, 0.1)"},{border:"rgba(245, 87, 108, 1)",bg:"rgba(245, 87, 108, 0.1)"},{border:"rgba(56, 239, 125, 1)",bg:"rgba(56, 239, 125, 0.1)"},{border:"rgba(255, 206, 86, 1)",bg:"rgba(255, 206, 86, 0.1)"}];Object.keys(n).sort().forEach((e,t)=>{let a=n[e];var r=o.map(e=>a[e]||0),t=l[t%l.length];i.push({label:e+" Satışları",data:r,borderColor:t.border,backgroundColor:t.bg,borderWidth:3,fill:!0,tension:.4})});e=document.getElementById("salespersonMonthlyChart");if(e){salespersonMonthlyChartInstance&&salespersonMonthlyChartInstance.destroy();let t=["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"];var a=o.map(e=>t[parseInt(e)-1]);salespersonMonthlyChartInstance=new Chart(e,{type:"line",data:{labels:a,datasets:i},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!0,position:"top"}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+e.toLocaleString("tr-TR")}}}}}})}}function renderSalespersonTopProducts(t=null,a=null,e){if((t=null===t&&lastSalespersonTopProductsData?lastSalespersonTopProductsData:t)&&0!==t.length){null!==a&&(currentSalespersonSortDirection=currentSalespersonSortColumn===a?"asc"===currentSalespersonSortDirection?"desc":"asc":(currentSalespersonSortColumn=a,"desc"));let r={},e=(t.forEach(e=>{var t,a=e.product||"Bilinmiyor";r[a]||(t=0<(t=[e.category_1,e.category_2,e.category_3,e.category_4].filter(e=>e&&e.trim()&&"all"!==e.toLowerCase())).length?t.join(" › "):"Bilinmiyor",r[a]={brand:e.brand||"Bilinmiyor",category:t,sales:0,qty:0,count:0}),r[a].sales+=parseFloat(e.usd_amount||0),r[a].qty+=parseFloat(e.quantity||0),r[a].count+=1}),Object.entries(r));"product"===currentSalespersonSortColumn?e.sort((e,t)=>"asc"===currentSalespersonSortDirection?e[0].localeCompare(t[0],"tr"):t[0].localeCompare(e[0],"tr")):"brand"===currentSalespersonSortColumn?e.sort((e,t)=>"asc"===currentSalespersonSortDirection?e[1].brand.localeCompare(t[1].brand,"tr"):t[1].brand.localeCompare(e[1].brand,"tr")):"category"===currentSalespersonSortColumn?e.sort((e,t)=>"asc"===currentSalespersonSortDirection?e[1].category.localeCompare(t[1].category,"tr"):t[1].category.localeCompare(e[1].category,"tr")):"sales"===currentSalespersonSortColumn?e.sort((e,t)=>"asc"===currentSalespersonSortDirection?e[1].sales-t[1].sales:t[1].sales-e[1].sales):"qty"===currentSalespersonSortColumn?e.sort((e,t)=>"asc"===currentSalespersonSortDirection?e[1].qty-t[1].qty:t[1].qty-e[1].qty):"count"===currentSalespersonSortColumn&&e.sort((e,t)=>"asc"===currentSalespersonSortDirection?e[1].count-t[1].count:t[1].count-e[1].count),e=e.slice(0,20);a=e=>currentSalespersonSortColumn!==e?"⇅":"asc"===currentSalespersonSortDirection?"↑":"↓";let n=`
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #38ef7d 0%, #11998e 100%); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left;">#</th>
                            <th style="padding: 15px; text-align: left; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'product')">
                                Ürün ${a("product")}
                            </th>
                            <th style="padding: 15px; text-align: left; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'brand')">
                                Marka ${a("brand")}
                            </th>
                            <th style="padding: 15px; text-align: left; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'category')">
                                Kategori ${a("category")}
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'sales')">
                                Satış (USD) ${a("sales")}
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'qty')">
                                Miktar ${a("qty")}
                            </th>
                            <th style="padding: 15px; text-align: right; cursor: pointer;" onclick="renderSalespersonTopProducts(null, 'count')">
                                İşlem ${a("count")}
                            </th>
                        </tr>
                    </thead>
                    <tbody>
            `;e.forEach((e,t)=>{var a=e[0],e=e[1];n+=`
                    <tr style="border-bottom: 1px solid #eee; ${t%2==0?"background: #f8f9fa;":""}">
                        <td style="padding: 12px;">${t+1}</td>
                        <td style="padding: 12px;"><strong>${a}</strong></td>
                        <td style="padding: 12px;">${e.brand}</td>
                        <td style="padding: 12px;">${e.category}</td>
                        <td style="padding: 12px; text-align: right; color: #38ef7d; font-weight: bold;">$${e.sales.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                        <td style="padding: 12px; text-align: right;">${e.qty.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                        <td style="padding: 12px; text-align: right;">${e.count}</td>
                    </tr>
                `}),n+=`
                    </tbody>
                </table>
            `,document.getElementById("salespersonTopProductsTable").innerHTML=n}else document.getElementById("salespersonTopProductsTable").innerHTML='<p style="text-align: center; padding: 20px;">Veri bulunamadı</p>'}function renderSalespersonBottomProducts(e){let r={};e.forEach(e=>{var t,a=e.product||"Bilinmiyor";r[a]||(t=0<(t=[e.category_1,e.category_2,e.category_3,e.category_4].filter(e=>e&&e.trim()&&"all"!==e.toLowerCase())).length?t.join(" › "):"Bilinmiyor",r[a]={brand:e.brand||"Bilinmiyor",category:t,sales:0,qty:0,count:0}),r[a].sales+=parseFloat(e.usd_amount||0),r[a].qty+=parseFloat(e.quantity||0),r[a].count+=1});e=Object.entries(r).sort((e,t)=>e[1].sales-t[1].sales).slice(0,10);let n=`
                <table style="width: 100%; border-collapse: collapse; background: white; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead style="background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); color: white;">
                        <tr>
                            <th style="padding: 15px; text-align: left;">#</th>
                            <th style="padding: 15px; text-align: left;">Ürün</th>
                            <th style="padding: 15px; text-align: left;">Marka</th>
                            <th style="padding: 15px; text-align: left;">Kategori</th>
                            <th style="padding: 15px; text-align: right;">Satış (USD)</th>
                            <th style="padding: 15px; text-align: right;">Miktar</th>
                            <th style="padding: 15px; text-align: right;">İşlem</th>
                        </tr>
                    </thead>
                    <tbody>
            `;e.forEach((e,t)=>{var a=e[0],e=e[1];n+=`
                    <tr style="border-bottom: 1px solid #eee; ${t%2==0?"background: #fff3cd;":"background: #ffe5e5;"}">
                        <td style="padding: 12px;">${t+1}</td>
                        <td style="padding: 12px;"><strong>${a}</strong></td>
                        <td style="padding: 12px;">${e.brand}</td>
                        <td style="padding: 12px;">${e.category}</td>
                        <td style="padding: 12px; text-align: right; color: #f5576c; font-weight: bold;">$${e.sales.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                        <td style="padding: 12px; text-align: right;">${e.qty.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>
                        <td style="padding: 12px; text-align: right;">${e.count}</td>
                    </tr>
                `}),n+=`
                    </tbody>
                </table>
            `,document.getElementById("salespersonBottomProductsTable").innerHTML=n}function renderSalespersonComparisonTable(e){var t=document.getElementById("salespersonComparisonTable"),e=`
                <table style="width: 100%; border-collapse: collapse; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <thead>
                        <tr style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                            <th style="padding: 15px; text-align: left;">Metrik</th>
                            ${e.map(e=>`<th style="padding: 15px; text-align: right;">👨‍💼 ${e.name}</th>`).join("")}
                        </tr>
                    </thead>
                    <tbody>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">💰 Toplam Satış</td>
                            ${e.map(e=>`<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">$${e.totalSales.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>`).join("")}
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">📦 Toplam Adet</td>
                            ${e.map(e=>`<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${e.totalQty.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>`).join("")}
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">🛒 Fatura Sayısı</td>
                            ${e.map(e=>`<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${e.invoiceCount}</td>`).join("")}
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">📊 Günlük Ort. Satış</td>
                            ${e.map(e=>`<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">$${e.avgTransaction.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>`).join("")}
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">🛒 Sepet Ortalaması</td>
                            ${e.map(e=>`<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">$${e.avgBasket.toLocaleString("tr-TR",{minimumFractionDigits:2})}</td>`).join("")}
                        </tr>
                        <tr style="background: white;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">👥 Farklı Müşteri</td>
                            ${e.map(e=>`<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${e.uniqueCustomers}</td>`).join("")}
                        </tr>
                        <tr style="background: #f8f9fa;">
                            <td style="padding: 12px; border-bottom: 1px solid #dee2e6; font-weight: 600;">🎯 Farklı Ürün</td>
                            ${e.map(e=>`<td style="padding: 12px; border-bottom: 1px solid #dee2e6; text-align: right;">${e.uniqueProducts}</td>`).join("")}
                        </tr>
                    </tbody>
                </table>
            `;t.innerHTML=e}function renderSalespersonComparisonCharts(e){var t=e.map(e=>e.name),a=e.map(e=>e.totalSales),e=e.map(e=>e.totalQty),r=["rgba(102, 126, 234, 0.7)","rgba(240, 147, 251, 0.7)","rgba(255, 159, 64, 0.7)"],n=["rgba(102, 126, 234, 1)","rgba(240, 147, 251, 1)","rgba(255, 159, 64, 1)"],o=document.getElementById("comparisonSalesChart"),o=(comparisonSalesChartInstance&&comparisonSalesChartInstance.destroy(),comparisonSalesChartInstance=new Chart(o,{type:"bar",data:{labels:t,datasets:[{label:"Toplam Satış ($)",data:a,backgroundColor:r,borderColor:n,borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){return"$"+e.parsed.y.toLocaleString("tr-TR",{minimumFractionDigits:2})}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return"$"+(e/1e3).toFixed(0)+"K"}}}}}}),document.getElementById("comparisonQtyChart"));comparisonQtyChartInstance&&comparisonQtyChartInstance.destroy(),comparisonQtyChartInstance=new Chart(o,{type:"bar",data:{labels:t,datasets:[{label:"Toplam Adet",data:e,backgroundColor:r,borderColor:n,borderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{callbacks:{label:function(e){return e.parsed.y.toLocaleString("tr-TR",{minimumFractionDigits:2})+" adet"}}}},scales:{y:{beginAtZero:!0,ticks:{callback:function(e){return e.toLocaleString("tr-TR")}}}}}})}function performSalespersonAIAnalysis(e,t){console.log("🤖 Satış temsilcisi AI analizi başlatılıyor...");var a={positive:[],negative:[],neutral:[],recommendations:[]};let r={};e.forEach(e=>{var t=e.brand||"Bilinmiyor";r[t]||(r[t]=0),r[t]+=parseFloat(e.usd_amount||0)});var n=Object.entries(r).sort((e,t)=>t[1]-e[1]).slice(0,3),o=Object.entries(r).sort((e,t)=>e[1]-t[1]).slice(0,3);let i={};e.forEach(e=>{var t=e.category_2||"Bilinmiyor";"all"===t.toLowerCase()||t.toLowerCase().includes("analitik")||t.toLowerCase().includes("eğitim")||(i[t]||(i[t]=0),i[t]+=parseFloat(e.usd_amount||0))});var l=Object.entries(i).sort((e,t)=>t[1]-e[1]).slice(0,3),s=Object.entries(i).sort((e,t)=>e[1]-t[1]).slice(0,3);let d=["Ocak","Şubat","Mart","Nisan","Mayıs","Haziran","Temmuz","Ağustos","Eylül","Ekim","Kasım","Aralık"],c={};e.forEach(e=>{var t=new Date(e.date).getMonth();c[t]||(c[t]=0),c[t]+=parseFloat(e.usd_amount||0)});var m=Object.entries(c).map(([e,t])=>({month:parseInt(e),name:d[e],value:t})),g=m.sort((e,t)=>t.value-e.value)[0],m=m.sort((e,t)=>e.value-t.value)[0];let u=["Pazar","Pazartesi","Salı","Çarşamba","Perşembe","Cuma","Cumartesi"],p={};e.forEach(e=>{var t=e.day_of_week;null!=t&&(t=(t+1)%7,p[t]||(p[t]=0),p[t]+=parseFloat(e.usd_amount||0))});var y=Object.entries(p).map(([e,t])=>({day:parseInt(e),name:u[e],value:t})),h=y.sort((e,t)=>t.value-e.value)[0],y=y.sort((e,t)=>e.value-t.value)[0];let b={};e.forEach(e=>{var t=e.create_hour;null!=t&&(b[t]||(b[t]=0),b[t]+=parseFloat(e.usd_amount||0))});var f=Object.entries(b).map(([e,t])=>({hour:parseInt(e),value:t})).sort((e,t)=>t.value-e.value)[0];let v=0,k=0,S=0,C=0;e.forEach(e=>{var t=e.create_hour,e=parseFloat(e.usd_amount||0);6<=t&&t<12?v+=e:12<=t&&t<17?k+=e:17<=t&&t<22?S+=e:C+=e});var x=[{name:"Sabah (06:00-12:00)",value:v},{name:"Öğlen (12:00-17:00)",value:k},{name:"Akşam (17:00-22:00)",value:S},{name:"Gece (22:00-06:00)",value:C}].sort((e,t)=>t.value-e.value);let $={};e.forEach(e=>{var t,a=e.store||"Bilinmiyor",r=e.day_of_week;null!=r&&(t=a+"_"+(r=(r+1)%7),$[t]||($[t]={store:a,day:r,dayName:u[r],value:0}),$[t].value+=parseFloat(e.usd_amount||0))});e=Object.values($).sort((e,t)=>t.value-e.value)[0];if(1e5<t.totalSales&&a.positive.push({title:"🏆 Yüksek Performans",description:`${t.name} toplam $${t.totalSales.toLocaleString("tr-TR",{minimumFractionDigits:2})} satış gerçekleştirmiş. Bu, çok başarılı bir performans göstergesi.`}),0<n.length&&(T=((I=n[0])[1]/t.totalSales*100).toFixed(1),a.positive.push({title:`🏷️ ${I[0]} Markasında Uzman`,description:`${I[0]} markasında %${T} pay ile güçlü ($${I[1].toLocaleString("tr-TR",{minimumFractionDigits:2})}). Bu markadaki ürünleri çok iyi biliyor.`})),0<l.length&&(I=((T=l[0])[1]/t.totalSales*100).toFixed(1),a.positive.push({title:`📂 ${T[0]} Kategorisinde Başarılı`,description:`${T[0]} kategorisinde %${I} pay ile lider ($${T[1].toLocaleString("tr-TR",{minimumFractionDigits:2})}). Bu kategorideki ürünleri etkili satıyor.`})),0<o.length&&o[0][1]<.05*t.totalSales&&a.negative.push({title:`⚠️ ${o[0][0]} Markasında Zayıf`,description:`${o[0][0]} markasında sadece $${o[0][1].toLocaleString("tr-TR",{minimumFractionDigits:2})} satış var. Bu markada eğitim gerekebilir.`}),0<s.length&&s[0][1]<.05*t.totalSales&&a.negative.push({title:`⚠️ ${s[0][0]} Kategorisinde Gelişim Alanı`,description:`${s[0][0]} kategorisinde sadece $${s[0][1].toLocaleString("tr-TR",{minimumFractionDigits:2})} satış var. Bu kategoride potansiyel artış fırsatı.`}),t.uniqueCustomers<50&&a.negative.push({title:"👥 Müşteri Portföyü Dar",description:`Sadece ${t.uniqueCustomers} farklı müşteri ile çalışılmış. Yeni müşteri kazanımına odaklanılmalı.`}),g&&m&&(I=(g.value/t.totalSales*100).toFixed(1),T=(m.value/t.totalSales*100).toFixed(1),a.neutral.push({title:"📅 Aylık Performans",description:`En güçlü ay: <span class="metric-highlight">${g.name}</span> (%${I})<br>En zayıf ay: ${m.name} (%${T})`})),h&&y&&(g=(h.value/t.totalSales*100).toFixed(1),I=(y.value/t.totalSales*100).toFixed(1),a.neutral.push({title:"📆 Günlük Performans",description:`En güçlü gün: <span class="metric-highlight">${h.name}</span> (%${g})<br>En zayıf gün: ${y.name} (%${I})`})),0<x.length&&(T=((m=x[0]).value/t.totalSales*100).toFixed(1),a.neutral.push({title:"🕐 Saat Dilimi Performansı",description:`En güçlü: <span class="metric-highlight">${m.name}</span> - Cironun %${T}'i bu saatlerde`})),e&&(g=(e.value/t.totalSales*100).toFixed(1),I=e.store.replace(/\[.*?\]\s*/g,"").trim(),getStoreWorkingHours(e.store).closedDays.includes(e.day)||a.neutral.push({title:"⭐ En Başarılı Kombinasyon",description:`<span class="metric-highlight">${I}</span> - <span class="metric-highlight">${e.dayName}</span> günleri harika! (%${g})`})),a.neutral.push({title:"📊 Genel Performans",description:`<span class="metric-highlight">${t.uniqueProducts}</span> farklı ürün, <span class="metric-highlight">${t.uniqueCustomers}</span> farklı müşteriye satıldı. Ortalama işlem değeri $${t.avgTransaction.toLocaleString("tr-TR",{minimumFractionDigits:2})}.`}),3<=n.length&&a.neutral.push({title:"🏷️ Marka Çeşitliliği",description:`En çok satılan markalar: ${n.map(e=>e[0]).join(", ")}. Bu markalarda yoğunlaşma var.`}),3<=l.length&&a.neutral.push({title:"📂 Kategori Çeşitliliği",description:`En çok satılan kategoriler: ${l.map(e=>e[0]).join(", ")}. Bu kategorilerde uzmanlaşma mevcut.`}),y&&h&&a.recommendations.push({icon:"📆",title:"Gün Bazlı Strateji",description:`${y.name} günleri zayıf. ${h.name} günlerindeki başarılı yaklaşımları ${y.name}'ya da uygulayın. Müşteri ziyaretlerini buna göre planlayın.`}),f&&a.recommendations.push({icon:"⏰",title:"Saat Bazlı Optimizasyon",description:`Saat ${f.hour}:00 civarında en başarılı. Bu saatlerde daha fazla müşteri görüşmesi planlayın.`}),1<x.length){m=x.filter(e=>!e.name.includes("Gece"));if(1<m.length){var T=m[m.length-1],I=(T.value/t.totalSales*100).toFixed(1);if(parseFloat(I)<20){let e=T.name+` sadece %${I} ciro yapıyor.`;T.name.includes("Sabah")?e+=" Sabah müşteri akışını artırmak için açılış kampanyaları ve sosyal medya duyuruları yapılmalı.":T.name.includes("Öğlen")?e+=" Öğle saatlerinde özel indirimler ve hızlı servis sunulmalı.":T.name.includes("Akşam")&&(e+=" Akşam saatlerinde (17:00-20:00/22:00) özel etkinlikler ve workshop'lar düzenlenebilir."),a.recommendations.push({icon:"🎯",title:"Zayıf Zaman Dilimini Güçlendir",description:e})}}}0<o.length&&a.recommendations.push({icon:"📚",title:"Ürün Eğitimi",description:`${o[0][0]} ve ${s[0][0]} konularında ürün eğitimi almalı. Bu alanlardaki bilgi eksikliği satışları etkiliyor olabilir.`}),0<n.length&&a.recommendations.push({icon:"🎯",title:"Başarılı Stratejileri Yaygınlaştır",description:n[0][0]+" markasındaki başarıyı diğer markalara da taşımak için aylık hedefler belirleyin. Cross-selling fırsatlarını değerlendirin."}),a.recommendations.push({icon:"👥",title:"Müşteri Geliştirme",description:`Mevcut ${t.uniqueCustomers} müşteriye ek olarak yeni müşteri kazanımı için aktif çalışma yapılmalı. Referans sistemi kullanılabilir.`});e=`
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 30px; border-radius: 15px;">
                    ${0<a.positive.length?`
                    <div class="analysis-section">
                        <h3 style="color: white; margin-top: 0;">✅ Güçlü Yönler</h3>
                        ${a.positive.map(e=>`
                            <div class="insight-item insight-positive" style="background: rgba(56, 239, 125, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #38ef7d;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">✅</span>
                                <strong style="font-size: 1.1em;">${e.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${e.description}</span>
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    ${0<a.negative.length?`
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">⚠️ Gelişim Alanları</h3>
                        ${a.negative.map(e=>`
                            <div class="insight-item insight-negative" style="background: rgba(245, 87, 108, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #f5576c;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">⚠️</span>
                                <strong style="font-size: 1.1em;">${e.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${e.description}</span>
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    ${0<a.neutral.length?`
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">💡 Genel Bilgiler</h3>
                        ${a.neutral.map(e=>`
                            <div class="insight-item insight-neutral" style="background: rgba(255, 215, 0, 0.2); padding: 15px; border-radius: 10px; margin: 10px 0; border-left: 4px solid #ffd700;">
                                <span class="insight-icon" style="font-size: 1.5em; margin-right: 10px;">💡</span>
                                <strong style="font-size: 1.1em;">${e.title}</strong><br>
                                <span style="opacity: 0.95; margin-top: 8px; display: block;">${e.description}</span>
                            </div>
                        `).join("")}
                    </div>
                    `:""}
                    
                    <div class="analysis-section" style="margin-top: 25px;">
                        <h3 style="color: white;">🎯 Gelişim Önerileri</h3>
                        ${a.recommendations.map(e=>`
                            <div class="recommendation" style="background: rgba(255, 255, 255, 0.15); padding: 18px; border-radius: 10px; margin: 12px 0;">
                                <span class="recommendation-icon" style="font-size: 1.8em; margin-right: 12px;">${e.icon}</span>
                                <div style="display: inline-block; vertical-align: top; width: calc(100% - 50px);">
                                    <strong style="font-size: 1.15em; display: block; margin-bottom: 8px;">${e.title}</strong>
                                    <p style="margin: 0; opacity: 0.95; line-height: 1.6;">${e.description}</p>
                                </div>
                            </div>
                        `).join("")}
                    </div>
                </div>
            `;document.getElementById("salespersonAIAnalysisContent").innerHTML=e}function initMobileTableScrollHint(){window.innerWidth<=768&&document.querySelectorAll("table").forEach(e=>{e.addEventListener("scroll",function(){this.classList.add("scrolled")},{once:!0})})}let loadingProgress=0,loadingSteps=[{id:"step1",text:"🔄 Sayfa başlatılıyor...",progress:10},{id:"step2",text:"📊 Veri dosyaları yükleniyor...",progress:40},{id:"step3",text:"🎯 Hedefler yükleniyor...",progress:70},{id:"step4",text:"✅ Hazırlanıyor...",progress:100}];function updateLoadingProgress(a,e=null){var t=loadingSteps[a],e=null!==e?e:t.progress;document.getElementById("progressBar").style.width=e+"%",document.getElementById("progressText").textContent=Math.round(e)+"%",loadingSteps.forEach((e,t)=>{e=document.getElementById(e.id);e&&(t<=a?(e.style.display="block",t===a?(e.style.opacity="1",e.style.color="#4ade80",e.style.transform="scale(1.05)"):(e.style.opacity="0.7",e.style.color="white",e.style.transform="scale(1)")):e.style.display="none")}),100<=e&&setTimeout(()=>{document.getElementById("loadingScreen").style.opacity="0",document.getElementById("loadingScreen").style.transition="opacity 0.5s ease",setTimeout(()=>{document.getElementById("loadingScreen").style.display="none",document.getElementById("mainContainer").style.display="block"},500)},500)}function checkLoadingComplete(){let e=0;dataLoadProgress.pageInit&&(e+=25),dataLoadProgress.dataFiles&&(e+=50),dataLoadProgress.targets&&(e+=20),dataLoadProgress.ready&&(e+=5),document.getElementById("progressBar").style.width=e+"%",document.getElementById("progressText").textContent=Math.round(e)+"%",dataLoadProgress.pageInit&&(document.getElementById("step1").style.display="block",document.getElementById("step1").style.opacity="1",document.getElementById("step1").style.color="#4ade80"),dataLoadProgress.dataFiles&&(document.getElementById("step2").style.display="block",document.getElementById("step2").style.opacity="1",document.getElementById("step2").style.color="#4ade80"),dataLoadProgress.targets&&(document.getElementById("step3").style.display="block",document.getElementById("step3").style.opacity="1",document.getElementById("step3").style.color="#4ade80"),dataLoadProgress.ready&&(document.getElementById("step4").style.display="block",document.getElementById("step4").style.opacity="1",document.getElementById("step4").style.color="#4ade80",setTimeout(()=>{document.getElementById("loadingScreen").style.opacity="0",document.getElementById("loadingScreen").style.transition="opacity 0.5s ease",setTimeout(()=>{document.getElementById("loadingScreen").style.display="none",document.getElementById("mainContainer").style.display="block"},500)},500))}function startRealLoading(){dataLoadProgress.pageInit=!0,checkLoadingComplete(),loadData()}function logout(){confirm("Çıkış yapmak istediğinizden emin misiniz?")&&(sessionStorage.removeItem("session"),localStorage.removeItem("session"),window.location.href="auth-advanced.html")}function updateUserInfo(){var e;window.currentUser&&window.currentUserType&&(document.getElementById("userInfo").textContent=window.currentUser.name||window.currentUser.username||"Kullanıcı",e="admin"===window.currentUserType?"👑 Yönetici":"👤 Kullanıcı",document.getElementById("userType").textContent=e,e=window.currentUser.twoFactorEnabled?"🔐 2FA Aktif":"🛡️ Güvenli Oturum",document.getElementById("securityInfo").textContent=e)}function showSecurityInfo(){var e=localStorage.getItem("session");if(e)try{var t=CryptoJS.AES.decrypt(e,"zuhal-muzik-secret-key-2024"),a=JSON.parse(t.toString(CryptoJS.enc.Utf8)),r=Math.max(0,18e5-(Date.now()-a.loginTime)),n=Math.floor(r/6e4),o=`
🛡️ Güvenlik Bilgileri:
• Kullanıcı: ${a.user.name}
• Rol: ${"admin"===a.user.role?"Yönetici":"Kullanıcı"}
• İkili Doğrulama: ${a.user.twoFactorEnabled?"Aktif ✅":"Pasif ❌"}
• IP Adresi: ${a.ipAddress||"Bilinmiyor"}
• Cihaz: ${a.deviceInfo?a.deviceInfo.platform:"Bilinmiyor"}
• Oturum Süresi: ${n} dakika kaldı
• Giriş Zamanı: ${new Date(a.loginTime).toLocaleString("tr-TR")}
• Oturum ID: ${a.sessionId.substring(0,20)}...
                `;alert(o)}catch(e){alert("Güvenlik bilgileri alınamadı.")}}document.addEventListener("DOMContentLoaded",function(){startRealLoading(),initMobileTableScrollHint(),new MutationObserver(function(){initMobileTableScrollHint()}).observe(document.body,{childList:!0,subtree:!0})}),updateUserInfo(),document.addEventListener("DOMContentLoaded",function(){updateUserInfo(),setInterval(function(){var e=localStorage.getItem("session");e&&(e=JSON.parse(e),18e5<Date.now()-e.loginTime)&&(alert("Oturum süreniz doldu. Tekrar giriş yapın."),logout())},3e5)})</script><div style="position:fixed;bottom:10px;right:25px;font-size:11px;color:#999;z-index:9999;font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;background:rgba(255,255,255,.9);padding:5px 12px;border-radius:15px;box-shadow:0 2px 8px rgba(0,0,0,.1);backdrop-filter:blur(5px)">Developed by <strong style="color:#667eea">Tofta</strong></div></body></html>