<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üîí Giri≈ü - Zuhal M√ºzik Raporlama</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-container {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            text-align: center;
            max-width: 450px;
            width: 100%;
            animation: slideIn 0.5s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(-30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .logo {
            font-size: 60px;
            margin-bottom: 20px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        p {
            color: #666;
            margin-bottom: 20px;
            font-size: 14px;
        }

        .pin-input {
            width: 100%;
            padding: 15px;
            font-size: 24px;
            text-align: center;
            border: 2px solid #ddd;
            border-radius: 10px;
            margin-bottom: 20px;
            letter-spacing: 10px;
            transition: all 0.3s;
        }

        .pin-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .qr-section {
            background: #f9f9f9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .qr-code {
            background: white;
            padding: 15px;
            border-radius: 10px;
            display: inline-block;
            margin: 15px 0;
        }

        .secret-key {
            background: #fff3cd;
            color: #856404;
            padding: 12px;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 0;
            word-break: break-all;
        }

        .setup-instructions {
            text-align: left;
            background: #e7f3ff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            line-height: 1.6;
        }

        .setup-instructions ol {
            margin-left: 20px;
        }

        .setup-instructions li {
            margin: 8px 0;
        }

        .btn-login {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }

        .btn-login:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3);
        }

        .btn-login:active {
            transform: translateY(0);
        }

        .btn-secondary {
            background: #6c757d;
            margin-top: 10px;
        }

        .error-message, .success-message {
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
            font-size: 14px;
        }

        .error-message {
            background: #fee;
            color: #c33;
        }

        .success-message {
            background: #d4edda;
            color: #155724;
        }

        .error-message.show, .success-message.show {
            display: block;
            animation: shake 0.5s;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .footer {
            margin-top: 20px;
            color: #999;
            font-size: 12px;
        }

        .timer {
            font-size: 12px;
            color: #667eea;
            margin-top: 5px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="auth-container">
        <div class="logo">üéµ</div>
        <h1>Zuhal M√ºzik Raporlama</h1>
        <p>üîê Google Authenticator ile g√ºvenli giri≈ü</p>

        <!-- Setup Section -->
        <div id="setupSection">
            <div class="setup-instructions">
                <strong>üì± ƒ∞lk Kurulum:</strong>
                <ol>
                    <li>Google Authenticator uygulamasƒ±nƒ± indirin</li>
                    <li>QR kodu tarayƒ±n veya kodu manuel girin</li>
                    <li>Uygulama 6 haneli kod √ºretecek</li>
                    <li>Kodu a≈üaƒüƒ±ya girin ve doƒürulayƒ±n</li>
                </ol>
            </div>

            <div class="qr-section">
                <div class="qr-code" id="qrCode"></div>
                <div class="secret-key" id="secretKey"></div>
            </div>

            <div class="error-message" id="setupError">
                ‚ùå Hatalƒ± kod! L√ºtfen tekrar deneyin.
            </div>

            <div class="success-message" id="setupSuccess">
                ‚úÖ Google Authenticator ba≈üarƒ±yla kuruldu!
            </div>

            <input 
                type="text" 
                id="setupCodeInput" 
                class="pin-input" 
                placeholder="000000" 
                maxlength="6"
                autofocus
            >

            <button class="btn-login" onclick="verifySetup()">
                ‚úÖ Kurulumu Tamamla
            </button>
        </div>

        <!-- Login Section -->
        <div id="loginSection" style="display: none;">
            <p>Google Authenticator kodunuzu girin</p>

            <div class="error-message" id="loginError">
                ‚ùå Hatalƒ± kod! L√ºtfen tekrar deneyin.
            </div>

            <input 
                type="text" 
                id="loginCodeInput" 
                class="pin-input" 
                placeholder="000000" 
                maxlength="6"
                autofocus
            >

            <div class="timer" id="timer">‚è±Ô∏è Kod yenilenme s√ºresi: 30s</div>

            <button class="btn-login" onclick="verify2FA()">
                üîì Kod ile Giri≈ü Yap
            </button>

            <button class="btn-login btn-secondary" onclick="reset2FA()">
                üîÑ QR Kodu Sƒ±fƒ±rla
            </button>
        </div>

        <div class="footer">
            üîí G√ºvenli Giri≈ü
        </div>
    </div>

    <!-- CryptoJS for encryption -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <!-- QRCode.js for QR generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <!-- jsSHA for TOTP -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsSHA/3.3.1/sha1.js"></script>
    
    <script>
        console.log('üöÄ Auth sayfasƒ± y√ºklendi');
        
        let currentSecret = null;

        // Base32 decode function
        function base32Decode(base32) {
            const base32chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let bits = '';
            let bytes = [];
            
            base32 = base32.replace(/=+$/, '');
            
            for (let i = 0; i < base32.length; i++) {
                const val = base32chars.indexOf(base32.charAt(i).toUpperCase());
                bits += val.toString(2).padStart(5, '0');
            }
            
            for (let i = 0; i + 8 <= bits.length; i += 8) {
                bytes.push(parseInt(bits.substr(i, 8), 2));
            }
            
            return new Uint8Array(bytes);
        }

        // Generate TOTP code
        function generateTOTP(secret) {
            try {
                const epoch = Math.floor(Date.now() / 1000);
                const timeCounter = Math.floor(epoch / 30);
                
                const key = base32Decode(secret);
                const timeBytes = new ArrayBuffer(8);
                const timeView = new DataView(timeBytes);
                timeView.setUint32(4, timeCounter);
                
                const shaObj = new jsSHA("SHA-1", "ARRAYBUFFER");
                shaObj.setHMACKey(key, "UINT8ARRAY");
                shaObj.update(timeBytes);
                const hmac = new Uint8Array(shaObj.getHMAC("UINT8ARRAY"));
                
                const offset = hmac[19] & 0xf;
                const code = ((hmac[offset] & 0x7f) << 24) |
                            ((hmac[offset + 1] & 0xff) << 16) |
                            ((hmac[offset + 2] & 0xff) << 8) |
                            (hmac[offset + 3] & 0xff);
                
                const otp = (code % 1000000).toString().padStart(6, '0');
                console.log('‚úÖ TOTP olu≈üturuldu:', otp);
                return otp;
            } catch(error) {
                console.error('‚ùå TOTP olu≈üturma hatasƒ±:', error);
                return null;
            }
        }

        // Generate random secret
        function generateRandomSecret() {
            const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ234567';
            let secret = '';
            for (let i = 0; i < 32; i++) {
                secret += chars.charAt(Math.floor(Math.random() * chars.length));
            }
            return secret;
        }

        // Device fingerprint
        function generateDeviceFingerprint() {
            const nav = navigator;
            return btoa(nav.userAgent + nav.language + screen.width + screen.height);
        }

        // Create encrypted session
        function createSession() {
            console.log('üîê Session olu≈üturuluyor...');
            
            const sessionData = {
                username: 'admin',
                loginTime: Date.now(),
                deviceFingerprint: generateDeviceFingerprint(),
                deviceInfo: {
                    userAgent: navigator.userAgent,
                    platform: navigator.platform,
                    language: navigator.language
                }
            };

            const key = 'zuhal-muzik-secret-key-2024';
            const encryptedSession = CryptoJS.AES.encrypt(JSON.stringify(sessionData), key).toString();
            localStorage.setItem('session', encryptedSession);
            
            console.log('‚úÖ Session kaydedildi, y√∂nlendiriliyor...');
            
            setTimeout(() => {
                window.location.href = 'index.html';
            }, 500);
        }

        // Check setup status
        function checkSetupStatus() {
            console.log('üîç Setup durumu kontrol ediliyor...');
            const secret = localStorage.getItem('2fa_secret');
            const isSetup = localStorage.getItem('2fa_setup_complete');

            if (isSetup === 'true' && secret) {
                console.log('‚úÖ 2FA zaten kurulu, login ekranƒ± g√∂steriliyor');
                currentSecret = secret;
                document.getElementById('setupSection').style.display = 'none';
                document.getElementById('loginSection').style.display = 'block';
                document.getElementById('loginCodeInput').focus();
                startTimer();
            } else {
                console.log('üì± 2FA kurulumu ba≈ülatƒ±lƒ±yor...');
                generate2FASetup();
            }
        }

        // Generate 2FA setup
        function generate2FASetup() {
            currentSecret = generateRandomSecret();
            localStorage.setItem('2fa_secret', currentSecret);
            console.log('üîë Secret olu≈üturuldu:', currentSecret);

            // Generate QR Code
            const issuer = 'Zuhal M√ºzik';
            const label = 'Raporlama';
            const otpauthURL = `otpauth://totp/${encodeURIComponent(issuer)}:${encodeURIComponent(label)}?secret=${currentSecret}&issuer=${encodeURIComponent(issuer)}`;
            
            console.log('üì± QR kod olu≈üturuluyor...');
            document.getElementById('qrCode').innerHTML = '';
            new QRCode(document.getElementById('qrCode'), {
                text: otpauthURL,
                width: 200,
                height: 200
            });

            document.getElementById('secretKey').textContent = currentSecret;
            console.log('‚úÖ QR kod hazƒ±r');
        }

        // Verify setup
        document.getElementById('setupCodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') verifySetup();
        });

        function verifySetup() {
            const code = document.getElementById('setupCodeInput').value;
            const expectedCode = generateTOTP(currentSecret);
            
            console.log('üîç Kurulum doƒürulanƒ±yor... Girilen:', code, 'Beklenen:', expectedCode);

            if (code === expectedCode) {
                console.log('‚úÖ Kod doƒüru, kurulum tamamlanƒ±yor');
                localStorage.setItem('2fa_setup_complete', 'true');
                document.getElementById('setupSuccess').classList.add('show');
                setTimeout(() => {
                    document.getElementById('setupSuccess').classList.remove('show');
                    checkSetupStatus();
                }, 1500);
            } else {
                console.log('‚ùå Kod yanlƒ±≈ü');
                document.getElementById('setupError').classList.add('show');
                document.getElementById('setupCodeInput').value = '';
                setTimeout(() => document.getElementById('setupError').classList.remove('show'), 2000);
            }
        }

        // Verify login
        document.getElementById('loginCodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') verify2FA();
        });

        function verify2FA() {
            const code = document.getElementById('loginCodeInput').value;
            const expectedCode = generateTOTP(currentSecret);

            console.log('üîç Giri≈ü doƒürulanƒ±yor... Girilen:', code, 'Beklenen:', expectedCode);

            if (code === expectedCode) {
                console.log('‚úÖ Kod doƒüru, giri≈ü yapƒ±lƒ±yor');
                createSession();
            } else {
                console.log('‚ùå Kod yanlƒ±≈ü');
                document.getElementById('loginError').classList.add('show');
                document.getElementById('loginCodeInput').value = '';
                setTimeout(() => document.getElementById('loginError').classList.remove('show'), 2000);
            }
        }

        // Reset 2FA
        function reset2FA() {
            if (confirm('Google Authenticator kurulumunu sƒ±fƒ±rlamak istediƒüinize emin misiniz?')) {
                console.log('üîÑ 2FA sƒ±fƒ±rlanƒ±yor...');
                localStorage.removeItem('2fa_secret');
                localStorage.removeItem('2fa_setup_complete');
                checkSetupStatus();
            }
        }

        // Timer countdown
        function startTimer() {
            function updateTimer() {
                const now = Math.floor(Date.now() / 1000);
                const remaining = 30 - (now % 30);
                document.getElementById('timer').textContent = `‚è±Ô∏è Kod yenilenme s√ºresi: ${remaining}s`;
            }
            updateTimer();
            setInterval(updateTimer, 1000);
        }

        // Auto-start on load
        window.addEventListener('load', function() {
            console.log('‚úÖ Sayfa tamamen y√ºklendi');
            checkSetupStatus();
        });

        // Fallback - k√ºt√ºphaneler y√ºklenmediyse uyar
        setTimeout(() => {
            if (typeof jsSHA === 'undefined') {
                console.error('‚ùå jsSHA k√ºt√ºphanesi y√ºklenemedi!');
                alert('G√ºvenlik k√ºt√ºphaneleri y√ºklenemedi. L√ºtfen sayfayƒ± yenileyin.');
            }
            if (typeof QRCode === 'undefined') {
                console.error('‚ùå QRCode k√ºt√ºphanesi y√ºklenemedi!');
            }
            if (typeof CryptoJS === 'undefined') {
                console.error('‚ùå CryptoJS k√ºt√ºphanesi y√ºklenemedi!');
            }
        }, 2000);
    </script>
</body>
</html>
