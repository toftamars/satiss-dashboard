name: Odoo Veri GÃ¼ncelleme

on:
  # schedule:
  #   - cron: '0 23 * * *'  # Otomatik Ã§alÄ±ÅŸma kapatÄ±ldÄ±
  workflow_dispatch:  # Manuel Ã§alÄ±ÅŸtÄ±rma aktif

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        token: ${{ secrets.PAT_TOKEN }}
        persist-credentials: true
    
    - name: Python kurulumu
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
    
    - name: Gerekli kÃ¼tÃ¼phaneleri kur
      run: |
        pip install requests
    
    - name: Odoo'dan veri Ã§ek
      env:
        ODOO_URL: ${{ secrets.ODOO_URL }}
        ODOO_USERNAME: ${{ secrets.ODOO_USERNAME }}
        ODOO_API_KEY: ${{ secrets.ODOO_API_KEY }}
      run: |
        python3 << 'EOF'
        import os
        import requests
        import json
        from datetime import datetime
        import warnings
        import xmlrpc.client
        import ssl
        
        warnings.filterwarnings('ignore')
        ssl._create_default_https_context = ssl._create_unverified_context
        
        print("=" * 60)
        print("ğŸš€ Odoo 15 API Test - Yeni KullanÄ±cÄ±")
        print("=" * 60)
        
        url = os.environ['ODOO_URL']
        username = os.environ['ODOO_USERNAME']
        password = os.environ['ODOO_API_KEY']
        db = "erp.zuhalmuzik.com"
        
        print(f"ğŸ”Œ URL: {url}")
        print(f"ğŸ—„ï¸ Database: {db}")
        print(f"ğŸ‘¤ Username: {username}")
        print(f"ğŸ” Password: {'*' * len(password)}")
        
        try:
            session = requests.Session()
            
            # Odoo 15 authenticate
            auth_url = f"{url}/web/session/authenticate"
            
            auth_payload = {
                "jsonrpc": "2.0",
                "method": "call",
                "params": {
                    "db": db,
                    "login": username,
                    "password": password
                },
                "id": 1
            }
            
            print("\nğŸ” Kimlik doÄŸrulama yapÄ±lÄ±yor...")
            
            response = session.post(
                auth_url,
                json=auth_payload,
                headers={"Content-Type": "application/json"},
                verify=False,
                timeout=30
            )
            
            print(f"ğŸ“¡ HTTP Status: {response.status_code}")
            
            if response.status_code != 200:
                print(f"âŒ HTTP HatasÄ±: {response.status_code}")
                print(f"Response: {response.text[:500]}")
                exit(1)
            
            result = response.json()
            
            # Hata kontrolÃ¼
            if 'error' in result:
                error_data = result['error'].get('data', {})
                error_msg = error_data.get('message', result['error'].get('message', 'Bilinmeyen'))
                error_name = error_data.get('name', 'Bilinmeyen')
                
                print(f"âŒ Odoo HatasÄ±: {error_name}")
                print(f"ğŸ“ Mesaj: {error_msg}")
                
                # DetaylÄ± debug
                if 'debug' in error_data:
                    debug = error_data['debug']
                    if 'database' in debug.lower():
                        print("\nğŸ’¡ VERÄ°TABANI HATASI TESPÄ°T EDÄ°LDÄ°!")
                        print("Denenen DB:", db)
                    elif 'access denied' in debug.lower() or 'credentials' in debug.lower():
                        print("\nğŸ’¡ KULLANICI ADI/ÅÄ°FRE HATASI!")
                        print("Username kontrol edin:", username)
                    elif '2fa' in debug.lower() or 'two factor' in debug.lower():
                        print("\nğŸ’¡ 2FA SORUNU!")
                        print("KullanÄ±cÄ±da 2FA kapalÄ± mÄ± kontrol edin")
                
                exit(1)
            
            # BaÅŸarÄ±lÄ± giriÅŸ
            if 'result' in result:
                session_info = result['result']
                
                if session_info and isinstance(session_info, dict):
                    uid = session_info.get('uid')
                    
                    if uid:
                        print("\n" + "=" * 60)
                        print("âœ… BAÅARILI! ODOO'YA BAÄLANILDI!")
                        print("=" * 60)
                        print(f"ğŸ‘¤ User ID: {uid}")
                        print(f"ğŸ‘¤ Ä°sim: {session_info.get('name', 'N/A')}")
                        print(f"ğŸ¢ Åirket: {session_info.get('company_name', 'N/A')}")
                        print(f"ğŸ—„ï¸ GerÃ§ek DB: {session_info.get('db', 'N/A')}")
                        print(f"ğŸŒ User Context: {session_info.get('user_context', {})}")
                        
                        # Veri Ã§ekme testi
                        print("\n" + "=" * 60)
                        print("ğŸ‰ GÄ°RÄ°Å BAÅARILI! XML-RPC Ä°LE VERÄ° Ã‡EKMEYE GEÃ‡Ä°YORUZ")
                        print("=" * 60)
                        
                        # XML-RPC ile devam et (daha stabil)
                        print("\nğŸ”„ XML-RPC baÄŸlantÄ±sÄ± kuruluyor...")
                        
                        try:
                            common = xmlrpc.client.ServerProxy(f'{url}/xmlrpc/2/common')
                            models = xmlrpc.client.ServerProxy(f'{url}/xmlrpc/2/object')
                            
                            # Tekrar authenticate (XML-RPC iÃ§in)
                            uid_xmlrpc = common.authenticate(db, username, password, {})
                            
                            if not uid_xmlrpc:
                                print("âŒ XML-RPC authentication baÅŸarÄ±sÄ±z!")
                                exit(1)
                            
                            print(f"âœ… XML-RPC baÄŸlantÄ±sÄ± baÅŸarÄ±lÄ±! (UID: {uid_xmlrpc})")
                        except Exception as e:
                            print(f"âŒ XML-RPC hatasÄ±: {e}")
                            print("âš ï¸ REST API ile devam ediliyor...")
                            models = None
                        
                        # KAPSAMLI VERÄ° Ã‡EKME BAÅLIYOR
                        print("\n" + "=" * 60)
                        print("ğŸ“Š KAPSAMLI VERÄ° Ã‡EKME BAÅLADI")
                        print("=" * 60)
                        
                        # XML-RPC Ä°LE VERÄ° Ã‡EK
                        print("\n1ï¸âƒ£ TestDeneme filtresi ile fatura satÄ±rlarÄ± Ã§ekiliyor (XML-RPC)...")
                        
                        if models:
                            # XML-RPC ile Ã§ek
                            try:
                                print("â³ Veri Ã§ekiliyor (bu 2-3 dakika sÃ¼rebilir)...")
                                
                                # TestDeneme FÄ°LTRESÄ° - KullanÄ±cÄ±nÄ±n kaydedilmiÅŸ filtresini Ã§ek
                                print("ğŸ” 'TestDeneme' filtresinin domain'i Ã§ekiliyor...")
                                
                                try:
                                    # SADECE 'TestDeneme' FÄ°LTRESÄ°NÄ° ARA (TEK YER)
                                    print("ğŸ” 'TestDeneme' filtresi aranÄ±yor...")
                                    
                                    filters = models.execute_kw(
                                        db, uid_xmlrpc, password,
                                        'ir.filters', 'search_read',
                                        [[
                                            ('user_id', '=', uid_xmlrpc),
                                            ('model_id', '=', 'account.invoice.report'),
                                            ('name', '=', 'TestDeneme')
                                        ]],
                                        {'fields': ['name', 'domain', 'context']}
                                    )
                                    
                                    # Filtre bulunamadÄ±ysa HATA VER VE DURDUR
                                    if not filters or len(filters) == 0:
                                        print("âŒ HATA: 'TestDeneme' filtresi bulunamadÄ±!")
                                        print("âŒ KullanÄ±cÄ±ya Ã¶zel account.invoice.report'ta 'TestDeneme' filtresi olmalÄ±.")
                                        exit(1)
                                    
                                    # Filtre bulundu
                                    filter_data = filters[0]
                                    print(f"âœ… 'TestDeneme' filtresi bulundu!")
                                    print(f"ğŸ“‹ Domain: {filter_data['domain']}")
                                    
                                    # KONTROL: Filtre out_refund'larÄ± dahil ediyor mu?
                                    if 'out_refund' in str(filter_data['domain']):
                                        print("âš ï¸ DÄ°KKAT: Filtre domain'inde 'out_refund' bulundu!")
                                    else:
                                        print("âš ï¸ UYARI: Filtre domain'inde 'out_refund' YOK - Ä°adeler filtrede hariÃ§ tutulmuÅŸ olabilir!")
                                    
                                    # Domain'i parse et
                                    import ast
                                    domain = ast.literal_eval(filter_data['domain']) if filter_data['domain'] else []
                                    
                                    if not domain:
                                        print("âŒ HATA: Filtre domain'i boÅŸ!")
                                        exit(1)
                                    
                                    # Domain'i account.move.line formatÄ±na Ã§evir
                                    print("ğŸ”„ Domain account.move.line formatÄ±na Ã§evriliyor...")
                                    converted_domain = []
                                    has_move_type_filter = False
                                    
                                    for item in domain:
                                        if isinstance(item, tuple) and len(item) >= 3:
                                            field, operator, value = item[0], item[1], item[2]
                                            # Alan adlarÄ±nÄ± dÃ¶nÃ¼ÅŸtÃ¼r
                                            if field == 'state':
                                                # account.move.line'da state alanÄ± yok, atla
                                                continue
                                            elif field == 'move_type':
                                                field = 'move_id.move_type'
                                                has_move_type_filter = True
                                                # Ã–NEMLÄ°: move_type filtresini out_invoice VE out_refund iÃ§erecek ÅŸekilde deÄŸiÅŸtir
                                                if operator == '=' and value == 'out_invoice':
                                                    # Sadece out_invoice varsa, out_refund'u da ekle
                                                    operator = 'in'
                                                    value = ('out_invoice', 'out_refund')
                                                    print("ğŸ”§ move_type filtresi gÃ¼ncellendi: out_invoice + out_refund dahil")
                                                elif operator == 'in' and isinstance(value, (list, tuple)):
                                                    # EÄŸer liste varsa ve out_refund yoksa ekle
                                                    value_list = list(value)
                                                    if 'out_invoice' in value_list and 'out_refund' not in value_list:
                                                        value_list.append('out_refund')
                                                        value = tuple(value_list)
                                                        print("ğŸ”§ move_type filtresine out_refund eklendi")
                                            elif field == 'analytic_account_id':
                                                field = 'analytic_account_id'
                                            elif field == 'product_categ_id':
                                                field = 'product_id.categ_id'
                                            elif field == 'product_id':
                                                field = 'product_id'
                                            converted_domain.append((field, operator, value))
                                        else:
                                            converted_domain.append(item)
                                    
                                    # EÄŸer move_type filtresi yoksa ekle (hem out_invoice hem out_refund)
                                    if not has_move_type_filter:
                                        converted_domain.append(('move_id.move_type', 'in', ('out_invoice', 'out_refund')))
                                        print("â• move_type filtresi eklendi: out_invoice + out_refund")
                                    
                                    # display_type ekle
                                    converted_domain.append(('display_type', '=', False))
                                    domain = converted_domain
                                    print(f"âœ… Domain dÃ¶nÃ¼ÅŸtÃ¼rÃ¼ldÃ¼: {len(domain)} koÅŸul")
                                    
                                except Exception as e:
                                    print(f"âŒ HATA: Filtre Ã§ekme hatasÄ±: {e}")
                                    import traceback
                                    traceback.print_exc()
                                    exit(1)
                                
                                # KayÄ±t sayÄ±sÄ±nÄ± kontrol et (account.move.line)
                                count = models.execute_kw(
                                    db, uid_xmlrpc, password,
                                    'account.move.line', 'search_count',
                                    [domain]
                                )
                                print(f"ğŸ“Š FiltrelenmiÅŸ kayÄ±t sayÄ±sÄ±: {count:,}")
                                
                                # account.move.line alanlarÄ±
                                fields = [
                                    'move_id', 'date', 'create_date', 'write_date',
                                    'product_id', 'quantity', 'price_subtotal', 
                                    'currency_id', 'partner_id', 'analytic_account_id', 'id'
                                ]
                                
                                # TÃœM VERÄ°YÄ° BATCH (PARÃ‡A PARÃ‡A) Ã‡EK
                                print("âš ï¸ TÃ¼m fatura satÄ±rlarÄ± Ã§ekiliyor (10,000'erlik parÃ§alar halinde)...")
                                
                                all_data = []
                                batch_size = 10000
                                offset = 0
                                batch_count = 0
                                
                                max_errors = 5
                                error_count = 0
                                
                                while True:
                                    batch_count += 1
                                    print(f"ğŸ“¦ Batch {batch_count}: {offset} - {offset + batch_size} arasÄ± Ã§ekiliyor...")
                                    
                                    try:
                                        batch_data = models.execute_kw(
                                            db, uid_xmlrpc, password,
                                            'account.move.line', 'search_read',
                                            [domain],
                                            {'fields': fields, 'limit': batch_size, 'offset': offset}
                                        )
                                        
                                        if not batch_data or len(batch_data) == 0:
                                            print(f"âœ… Batch {batch_count}: Veri bitti!")
                                            break
                                        
                                        all_data.extend(batch_data)
                                        print(f"âœ… Batch {batch_count}: {len(batch_data)} kayÄ±t eklendi (Toplam: {len(all_data)})")
                                        
                                        # Hata sayacÄ±nÄ± sÄ±fÄ±rla (baÅŸarÄ±lÄ± batch)
                                        error_count = 0
                                        
                                        if len(batch_data) < batch_size:
                                            print(f"âœ… Son batch tamamlandÄ±!")
                                            break
                                        
                                        offset += batch_size
                                        
                                    except Exception as e:
                                        error_count += 1
                                        print(f"âš ï¸ Batch {batch_count} hatasÄ±: {str(e)[:100]}")
                                        print(f"â­ï¸ Batch atlanÄ±yor... (Hata: {error_count}/{max_errors})")
                                        
                                        if error_count >= max_errors:
                                            print(f"âŒ Ã‡ok fazla hata ({max_errors}), durduruluyor...")
                                            break
                                        
                                        # HatalÄ± batch'i atla
                                        offset += batch_size
                                        continue
                                
                                print(f"\nâœ… TOPLAM {len(all_data)} fatura satÄ±rÄ± Ã§ekildi (XML-RPC)!")
                                print(f"ğŸ“Š Veri boyutu: ~{len(all_data) * 0.5 / 1024:.2f} MB")
                                
                                # HÄ°BRÄ°T YÃ–NTEM: USD tutarlarÄ± VE ÅEHÄ°R bilgisini account.invoice.report'tan Ã§ek
                                print(f"\nğŸ’° USD tutarlarÄ± ve ÅŸehir bilgisi account.invoice.report'tan Ã§ekiliyor (HÄ°BRÄ°T YÃ–NTEM)...")
                                
                                # move.line ID'lerini topla
                                line_ids = [line.get('id') for line in all_data if line.get('id')]
                                print(f"ğŸ“¦ {len(line_ids)} satÄ±r iÃ§in USD tutar ve ÅŸehir Ã§ekilecek...")
                                
                                usd_amount_map = {}
                                state_id_map = {}  # Åehir bilgisi iÃ§in yeni map
                                usd_rate_map = {}  # KUR bilgisi iÃ§in yeni map
                                try:
                                    # account.invoice.report'tan USD tutarlarÄ±nÄ±, state_id ve usd_rate'i batch olarak Ã§ek
                                    for i in range(0, len(line_ids), 5000):
                                        batch_ids = line_ids[i:i+5000]
                                        print(f"   ğŸ’µ USD + Åehir + KUR batch {i//5000 + 1}: {len(batch_ids)} kayÄ±t...")
                                        
                                        # account.invoice.report'tan price_usd_subtotal, state_id ve usd_rate Ã§ek
                                        usd_batch = models.execute_kw(
                                            db, uid_xmlrpc, password,
                                            'account.invoice.report', 'search_read',
                                            [[('id', 'in', batch_ids)]],
                                            {'fields': ['id', 'price_usd_subtotal', 'state_id', 'usd_rate']}
                                        )
                                        
                                        for usd_record in usd_batch:
                                            line_id = usd_record.get('id')
                                            usd_subtotal = usd_record.get('price_usd_subtotal', 0)
                                            state_id = usd_record.get('state_id')
                                            usd_rate = usd_record.get('usd_rate', 0)
                                            
                                            usd_amount_map[line_id] = float(usd_subtotal) if usd_subtotal else 0
                                            
                                            # state_id'yi ÅŸehir adÄ±na Ã§evir
                                            if state_id and isinstance(state_id, list) and len(state_id) > 1:
                                                state_id_map[line_id] = state_id[1]  # [id, name] formatÄ±nda geliyor
                                            else:
                                                state_id_map[line_id] = 'Bilinmeyen'
                                            
                                            # usd_rate'i kaydet
                                            if usd_rate and float(usd_rate) > 0:
                                                usd_rate_map[line_id] = float(usd_rate)
                                    
                                    print(f"âœ… {len(usd_amount_map)} satÄ±r iÃ§in USD tutar eÅŸleÅŸtirildi!")
                                    print(f"âœ… {len(state_id_map)} satÄ±r iÃ§in ÅŸehir bilgisi eÅŸleÅŸtirildi!")
                                    print(f"âœ… {len(usd_rate_map)} satÄ±r iÃ§in KUR bilgisi eÅŸleÅŸtirildi!")
                                    
                                    # Ä°statistik
                                    with_usd = sum(1 for v in usd_amount_map.values() if v != 0)
                                    total_usd = sum(usd_amount_map.values())
                                    with_city = sum(1 for c in state_id_map.values() if c != 'Bilinmeyen')
                                    with_rate = len(usd_rate_map)
                                    print(f"   ğŸ’° USD olan: {with_usd}")
                                    print(f"   ğŸ’µ Toplam USD: ${total_usd:,.2f}")
                                    print(f"   ğŸ™ï¸ Åehir bilgisi olan: {with_city}")
                                    print(f"   ğŸ’± KUR bilgisi olan: {with_rate}")
                                    
                                except Exception as e:
                                    print(f"âš ï¸ USD tutar + ÅŸehir + kur Ã§ekme hatasÄ±: {e}")
                                    print(f"âš ï¸ Fallback: account.move'dan currency_rate Ã§ekilecek")
                                    usd_amount_map = {}
                                    state_id_map = {}
                                    usd_rate_map = {}
                                
                                # SatÄ±ÅŸ temsilcileri ve KUR bilgilerini Ã§ek (account.move'dan)
                                print(f"\nğŸ‘¤ SatÄ±ÅŸ temsilcileri ve KUR bilgileri Ã§ekiliyor...")
                                move_ids = list(set([line.get('move_id')[0] for line in all_data if line.get('move_id') and isinstance(line.get('move_id'), list)]))
                                print(f"ğŸ“¦ {len(move_ids)} fatura baÅŸlÄ±ÄŸÄ± iÃ§in satÄ±ÅŸ temsilcisi ve kur Ã§ekiliyor (5000'erlik batch)...")
                                
                                invoice_user_map = {}
                                invoice_datetime_map = {}  # Fatura kesilme zamanÄ± (saat iÃ§in)
                                invoice_date_map = {}  # GerÃ§ek fatura tarihi
                                move_type_map = {}  # Fatura tipi (iade kontrolÃ¼ iÃ§in)
                                invoice_currency_rate_map = {}  # Fatura kuru (USD hesabÄ± iÃ§in)
                                
                                try:
                                    for i in range(0, len(move_ids), 5000):
                                        batch_ids = move_ids[i:i+5000]
                                        print(f"   ğŸ“¦ Fatura batch {i//5000 + 1}: {len(batch_ids)} fatura...")
                                        batch_moves = models.execute_kw(
                                            db, uid_xmlrpc, password,
                                            'account.move', 'search_read',
                                            [[('id', 'in', batch_ids)]],
                                            {'fields': ['id', 'invoice_user_id', 'user_id', 'create_date', 'invoice_date', 'move_type', 'currency_rate', 'amount_total', 'amount_total_signed']}
                                        )
                                        for move in batch_moves:
                                            move_id = move['id']
                                            
                                            # SatÄ±ÅŸ temsilcisi
                                            if move.get('invoice_user_id') and isinstance(move.get('invoice_user_id'), list):
                                                invoice_user_map[move_id] = move['invoice_user_id'][1]
                                            elif move.get('user_id') and isinstance(move.get('user_id'), list):
                                                invoice_user_map[move_id] = move['user_id'][1]
                                            else:
                                                invoice_user_map[move_id] = 'Sistem'
                                            
                                            # Fatura kesilme zamanÄ± (tarih + saat)
                                            if move.get('create_date'):
                                                invoice_datetime_map[move_id] = move['create_date']
                                            
                                            # GerÃ§ek fatura tarihi
                                            if move.get('invoice_date'):
                                                invoice_date_map[move_id] = move['invoice_date']
                                            
                                            # Fatura tipi (iade kontrolÃ¼ iÃ§in)
                                            if move.get('move_type'):
                                                move_type_map[move_id] = move['move_type']
                                            
                                            # KUR bilgisi (USD hesabÄ± iÃ§in)
                                            if move.get('currency_rate'):
                                                invoice_currency_rate_map[move_id] = float(move['currency_rate'])
                                    
                                    print(f"âœ… {len(invoice_user_map)} fatura iÃ§in satÄ±ÅŸ temsilcisi eÅŸleÅŸtirildi!")
                                    print(f"âœ… {len(invoice_datetime_map)} fatura iÃ§in tarih-saat bilgisi alÄ±ndÄ±!")
                                    print(f"âœ… {len(invoice_date_map)} fatura iÃ§in gerÃ§ek tarih alÄ±ndÄ±!")
                                    print(f"âœ… {len(move_type_map)} fatura iÃ§in tip bilgisi alÄ±ndÄ±!")
                                    print(f"âœ… {len(invoice_currency_rate_map)} fatura iÃ§in KUR bilgisi alÄ±ndÄ±!")
                                except Exception as e:
                                    print(f"âš ï¸ SatÄ±ÅŸ temsilcisi + tarih Ã§ekme hatasÄ±: {e}")
                                    invoice_user_map = {}
                                    invoice_datetime_map = {}
                                    invoice_date_map = {}
                                
                            except Exception as e:
                                print(f"âŒ XML-RPC veri Ã§ekme hatasÄ±: {e}")
                                all_data = None
                        else:
                            all_data = None
                        
                        if all_data and len(all_data) > 0:
                            
                            # Verileri iÅŸle ve JSON oluÅŸtur
                            print("\n2ï¸âƒ£ Veriler iÅŸleniyor ve kategorilere ayrÄ±lÄ±yor...")
                            
                            processed_data = {
                                'categories': {},
                                'products': {},
                                'partners': {},
                                'sales_persons': {},
                                'cities': {},
                                'stores': {},  # MaÄŸaza bilgisi (analytic_account)
                                'years': {},
                                'months': {},
                                'raw_count': len(all_data),
                                'last_update': datetime.now().isoformat()
                            }
                            
                            # Ã–nce Ã¼rÃ¼n kategorilerini ve partner ÅŸehirlerini Ã§ek (XML-RPC)
                            print("ğŸ“¦ ÃœrÃ¼n kategorileri Ã§ekiliyor (HiyerarÅŸik - XML-RPC)...")
                            
                            product_ids = list(set([line.get('product_id')[0] for line in all_data if line.get('product_id') and isinstance(line.get('product_id'), list)]))
                            partner_ids = list(set([line.get('partner_id')[0] for line in all_data if line.get('partner_id') and isinstance(line.get('partner_id'), list)]))
                            
                            product_categ_map = {}
                            product_brand_map = {}
                            category_hierarchy = {}
                            partner_city_map = {}
                            partner_tags_map = {}
                            
                            if product_ids and models:  # TÃœM ÃœRÃœNLER
                                try:
                                    # ÃœrÃ¼nleri BATCH Ã§ek - TÃœM ÃœRÃœNLER (kategori + marka)
                                    print(f"ğŸ“¦ {len(product_ids)} Ã¼rÃ¼n Ã§ekiliyor (5000'erlik batch)...")
                                    products = []
                                    for i in range(0, len(product_ids), 5000):
                                        batch_ids = product_ids[i:i+5000]
                                        print(f"   ğŸ“¦ ÃœrÃ¼n batch {i//5000 + 1}: {len(batch_ids)} Ã¼rÃ¼n...")
                                        batch_products = models.execute_kw(
                                            db, uid_xmlrpc, password,
                                            'product.product', 'search_read',
                                            [[('id', 'in', batch_ids)]],
                                            {'fields': ['id', 'categ_id', 'product_brand_id', 'product_tmpl_id']}
                                        )
                                        products.extend(batch_products)
                                    print(f"âœ… Toplam {len(products)} Ã¼rÃ¼n Ã§ekildi!")
                                    
                                    # Kategori ID'lerini topla
                                    categ_ids = list(set([prod['categ_id'][0] for prod in products if prod.get('categ_id') and isinstance(prod.get('categ_id'), list)]))
                                    
                                    # TÃ¼m kategorileri Ã§ek (parent bilgisiyle)
                                    print(f"ğŸ“‚ {len(categ_ids)} kategori detayÄ± Ã§ekiliyor...")
                                    categories = models.execute_kw(
                                        db, uid_xmlrpc, password,
                                        'product.category', 'search_read',
                                        [[('id', 'in', categ_ids)]],
                                        {'fields': ['id', 'name', 'parent_id', 'complete_name']}
                                    )
                                    
                                    # Kategori hiyerarÅŸisini oluÅŸtur (5 seviyeye kadar)
                                    for cat in categories:
                                        cat_id = cat['id']
                                        cat_name = cat.get('complete_name') or cat.get('name')
                                        parent_name = cat['parent_id'][1] if cat.get('parent_id') and isinstance(cat.get('parent_id'), list) else None
                                        
                                        # Kategori yolunu parÃ§ala (Ã¶rn: "MÃ¼zik / Gitarlar / Elektro" -> ["MÃ¼zik", "Gitarlar", "Elektro"])
                                        cat_levels = cat_name.split(' / ') if ' / ' in cat_name else [cat_name]
                                        
                                        category_hierarchy[cat_id] = {
                                            'name': cat_name,
                                            'parent': parent_name,
                                            'full_path': cat_name,
                                            'level1': cat_levels[0] if len(cat_levels) > 0 else '',
                                            'level2': cat_levels[1] if len(cat_levels) > 1 else '',
                                            'level3': cat_levels[2] if len(cat_levels) > 2 else '',
                                            'level4': cat_levels[3] if len(cat_levels) > 3 else '',
                                            'level5': cat_levels[4] if len(cat_levels) > 4 else ''
                                        }
                                    
                                    # ÃœrÃ¼n-kategori ve marka eÅŸleÅŸtirmesi
                                    product_brand_map = {}
                                    for prod in products:
                                        prod_id = prod['id']
                                        
                                        # Kategori
                                        categ = prod.get('categ_id')
                                        if categ and isinstance(categ, list) and len(categ) > 0:
                                            cat_id = categ[0]
                                            if cat_id in category_hierarchy:
                                                product_categ_map[prod_id] = category_hierarchy[cat_id]['full_path']
                                            else:
                                                product_categ_map[prod_id] = categ[1] if len(categ) > 1 else 'DiÄŸer'
                                        else:
                                            product_categ_map[prod_id] = 'DiÄŸer'
                                        
                                        # Marka
                                        brand = None
                                        if prod.get('product_brand_id') and isinstance(prod.get('product_brand_id'), list):
                                            brand = prod['product_brand_id'][1]
                                        
                                        product_brand_map[prod_id] = brand if brand else 'Bilinmeyen'
                                    
                                    print(f"âœ… {len(product_categ_map)} Ã¼rÃ¼n kategorisi eÅŸleÅŸtirildi (XML-RPC)")
                                    print(f"âœ… {len(product_brand_map)} Ã¼rÃ¼n markasÄ± eÅŸleÅŸtirildi")
                                    print(f"âœ… {len(category_hierarchy)} kategori hiyerarÅŸisi oluÅŸturuldu (5 seviye)!")
                                    
                                    # Kategori hiyerarÅŸisini data'ya ekle
                                    processed_data['category_hierarchy'] = category_hierarchy
                                    
                                except Exception as e:
                                    print(f"âš ï¸ ÃœrÃ¼n kategorisi Ã§ekme hatasÄ±: {e}")
                                    category_hierarchy = {}
                                    product_brand_map = {}
                            
                            # Partner ÅŸehir bilgilerini Ã§ek (XML-RPC) - HÄ°BRÄ°T YÃ–NTEM (state_id dahil) - TÃœM PARTNER
                            print(f"\nğŸ™ï¸ Partner ÅŸehir bilgileri Ã§ekiliyor (TÃœM PARTNER: {len(partner_ids)})...")
                            if partner_ids and models:
                                try:
                                    # Partnerleri BATCH Ã§ek (5000'erlik)
                                    print(f"ğŸ“¦ {len(partner_ids)} partner Ã§ekiliyor (5000'erlik batch)...")
                                    partners = []
                                    for i in range(0, len(partner_ids), 5000):
                                        batch_ids = partner_ids[i:i+5000]
                                        print(f"   ğŸ“¦ Partner batch {i//5000 + 1}: {len(batch_ids)} partner...")
                                        batch_partners = models.execute_kw(
                                            db, uid_xmlrpc, password,
                                            'res.partner', 'search_read',
                                            [[('id', 'in', batch_ids)]],
                                            {'fields': ['id', 'name', 'city', 'state_id']}
                                        )
                                        partners.extend(batch_partners)
                                    print(f"âœ… Toplam {len(partners)} partner Ã§ekildi!")
                                    
                                    # Åehir listesi (partner adÄ±ndan Ã§Ä±karmak iÃ§in)
                                    city_keywords = [
                                        'Ä°stanbul', 'Ankara', 'Ä°zmir', 'Antalya', 'Bursa', 'Adana', 
                                        'Konya', 'Gaziantep', 'ÅanlÄ±urfa', 'Kocaeli', 'Mersin', 
                                        'DiyarbakÄ±r', 'Hatay', 'Manisa', 'Kayseri', 'Samsun',
                                        'BalÄ±kesir', 'KahramanmaraÅŸ', 'Van', 'AydÄ±n', 'Denizli',
                                        'Sakarya', 'TekirdaÄŸ', 'MuÄŸla', 'EskiÅŸehir', 'Mardin',
                                        'Malatya', 'Erzurum', 'Trabzon', 'ElazÄ±ÄŸ', 'Ordu',
                                        'Ã‡orum', 'Afyonkarahisar', 'Sivas', 'Tokat', 'Giresun',
                                        'Aksaray', 'NiÄŸde', 'NevÅŸehir', 'KÄ±rÄ±kkale', 'KÄ±rÅŸehir',
                                        'Bodrum', 'TÃ¼nel', 'Hilltown', 'Uniq', 'Akasya', 'Kanyon',
                                        'Zorlu', 'Emaar', 'Marmara', 'Optimum', 'Capacity', 'Forum',
                                        'Cevahir', 'Metropol', 'Palladium', 'Galleria', 'Mall of'
                                    ]
                                    
                                    for partner in partners:
                                        partner_id = partner['id']
                                        partner_name = partner.get('name', '')
                                        city_field = partner.get('city', '').strip()
                                        state_field = partner.get('state_id')
                                        
                                        # 1. Ã–nce state_id'den (Ä°l/BÃ¶lge bilgisi - en doÄŸru)
                                        if state_field and isinstance(state_field, list) and len(state_field) > 1:
                                            partner_city_map[partner_id] = state_field[1]  # [id, name]
                                        # 2. Sonra city alanÄ±ndan
                                        elif city_field and city_field != '':
                                            partner_city_map[partner_id] = city_field
                                        else:
                                            # 3. Partner adÄ±ndan ÅŸehir Ã§Ä±kar
                                            found_city = None
                                            for city in city_keywords:
                                                if city.lower() in partner_name.lower():
                                                    found_city = city
                                                    break
                                            
                                            partner_city_map[partner_id] = found_city if found_city else 'Bilinmeyen'
                                    
                                    # Ä°statistik
                                    with_city = sum(1 for c in partner_city_map.values() if c != 'Bilinmeyen')
                                    print(f"âœ… {len(partner_city_map)} partner iÅŸlendi!")
                                    print(f"   ğŸ“ Åehir bilgisi olan: {with_city}")
                                    print(f"   â“ Bilinmeyen ÅŸehir: {len(partner_city_map) - with_city}")
                                    
                                except Exception as e:
                                    print(f"âš ï¸ Partner ÅŸehir bilgisi Ã§ekme hatasÄ±: {e}")
                                    partner_city_map = {}
                                    partner_tags_map = {}
                            
                            # Detay kayÄ±tlarÄ± iÃ§in liste
                            details = []
                            
                            # Ä°ade faturalarÄ± istatistikleri
                            refund_count = 0
                            refund_total_usd = 0
                            invoice_count = 0
                            invoice_total_usd = 0
                            
                            # Ä°ÅŸleme sayacÄ± (debug iÃ§in)
                            processed_count = 0
                            
                            for line in all_data:
                                try:
                                    processed_count += 1
                                    
                                    # Ã–NCE move bilgisini al
                                    move = line.get('move_id')
                                    move_id = move[0] if isinstance(move, list) else 0
                                    move_name = move[1] if isinstance(move, list) and len(move) > 1 else ''
                                    
                                    # Ä°ADE KONTROLÃœ: 
                                    # Format: RMRKZ/2024/00053 (EFT2024000000163)
                                    # Ä°ADE FATURALARI DAÄ°MA "R" ile baÅŸlar!
                                    is_refund = False
                                    if move_name and move_name.upper().startswith('R'):
                                        is_refund = True
                                    
                                    # Ek kontrol: move_type de kontrol et (Ã§ift gÃ¼venlik)
                                    move_type = move_type_map.get(move_id, '')
                                    if move_type == 'out_refund':
                                        is_refund = True
                                    
                                    # DEBUG: Ä°lk 20 kaydÄ± logla
                                    if processed_count <= 20:
                                        print(f"ğŸ“ KayÄ±t #{processed_count}: move_name={move_name}, is_refund={is_refund}, move_type={move_type}")
                                    
                                    # DORUK TEKÄ°N iÃ§in ERKEN DEBUG (partner bilgisi alÄ±nmadan Ã¶nce)
                                    partner = line.get('partner_id')
                                    partner_name_early = partner[1] if isinstance(partner, list) and len(partner) > 1 else ''
                                    if 'DORUK' in partner_name_early.upper():
                                        print(f"ğŸ” ERKEN DORUK: move_name={move_name}, is_refund={is_refund}, move_type={move_type}")
                                    
                                    # Tarih - GERÃ‡EK FATURA TARÄ°HÄ°
                                    # account.move'dan invoice_date, yoksa account.move.line'dan date
                                    date_str = invoice_date_map.get(move_id) or line.get('date', '')
                                    if date_str:
                                        year = date_str[:4]
                                        month = date_str[:7]
                                    else:
                                        year = 'Bilinmeyen'
                                        month = 'Bilinmeyen'
                                    
                                    # Saat bilgisi - account.move'dan create_date (FATURA KESÄ°LME ZAMANI)
                                    create_hour = 0
                                    create_day_of_week = 0
                                    
                                    create_date_str = invoice_datetime_map.get(move_id, '')
                                    if create_date_str:
                                        try:
                                            # Format: '2025-10-15 14:35:22'
                                            from datetime import datetime
                                            dt = datetime.strptime(create_date_str, '%Y-%m-%d %H:%M:%S')
                                            create_hour = dt.hour
                                            create_day_of_week = dt.weekday()  # 0=Pazartesi, 6=Pazar
                                        except:
                                            pass
                                    
                                    # ÃœrÃ¼n
                                    product = line.get('product_id')
                                    product_id = product[0] if isinstance(product, list) else 0
                                    
                                    # Kategori (Ã¼rÃ¼n map'inden)
                                    categ_name = product_categ_map.get(product_id, 'DiÄŸer')
                                    
                                    # ÃœrÃ¼n
                                    product = line.get('product_id')
                                    product_name = product[1] if isinstance(product, list) and len(product) > 1 else 'Bilinmeyen'
                                    product_id = product[0] if isinstance(product, list) else 0
                                    
                                    # MÃ¼ÅŸteri/MaÄŸaza
                                    partner = line.get('partner_id')
                                    partner_name = partner[1] if isinstance(partner, list) and len(partner) > 1 else 'Bilinmeyen'
                                    partner_id = partner[0] if isinstance(partner, list) else 0
                                    
                                    # Åehir - account.invoice.report'tan state_id_map'den Ã§ek (HÄ°BRÄ°T YÃ–NTEM)
                                    line_id = line.get('id')
                                    city = state_id_map.get(line_id, 'Bilinmeyen') if state_id_map else partner_city_map.get(partner_id, 'Bilinmeyen')
                                    
                                    # MaÄŸaza - analytic_account_id'den
                                    analytic_account = line.get('analytic_account_id')
                                    store_name = analytic_account[1] if isinstance(analytic_account, list) and len(analytic_account) > 1 else 'Genel'
                                    
                                    # SatÄ±ÅŸ temsilcisi - invoice_user_map'ten al
                                    move_id_value = line.get('move_id')
                                    move_id_int = move_id_value[0] if isinstance(move_id_value, list) else 0
                                    user_name = invoice_user_map.get(move_id_int, 'Sistem')
                                    
                                    # SayÄ±sal deÄŸerler - SADECE USD VE MÄ°KTAR
                                    qty = float(line.get('quantity', 0))
                                    
                                    # USD tutar - HÄ°BRÄ°T YÃ–NTEM (3 KatmanlÄ± Fallback)
                                    line_id = line.get('id')
                                    price_subtotal = abs(float(line.get('price_subtotal', 0)))  # TL tutar (mutlak deÄŸer)
                                    
                                    # 1. Ã–NCELÄ°K: account.invoice.report'tan usd_rate ve USD tutarÄ± kullan
                                    if line_id in usd_rate_map and usd_rate_map[line_id] > 0:
                                        # SatÄ±r bazÄ±nda kur varsa kullan (en doÄŸru!)
                                        usd_rate = usd_rate_map[line_id]
                                        usd_amount = price_subtotal / usd_rate
                                    elif line_id in usd_amount_map and usd_amount_map[line_id] != 0:
                                        # DoÄŸrudan USD tutarÄ± varsa kullan
                                        usd_amount = abs(usd_amount_map[line_id])
                                    # 2. FALLBACK: account.move'dan fatura kuru
                                    elif move_id in invoice_currency_rate_map and invoice_currency_rate_map[move_id] > 0:
                                        currency_rate = invoice_currency_rate_map[move_id]
                                        usd_amount = price_subtotal / currency_rate
                                    # 3. SON Ã‡ARE: Currency kontrolÃ¼
                                    else:
                                        currency = line.get('currency_id')
                                        currency_code = currency[1] if isinstance(currency, list) and len(currency) > 1 else ''
                                        
                                        if 'USD' in currency_code.upper():
                                            usd_amount = price_subtotal
                                        else:
                                            # Son Ã§are: ortalama kur
                                            usd_amount = price_subtotal / 34.5
                                    
                                    # HER ZAMAN POZÄ°TÄ°F OLARAK AL (move_type'a gÃ¶re sonra iÅŸaret belirleyeceÄŸiz)
                                    usd_amount = abs(usd_amount)
                                    qty = abs(qty)
                                    
                                    # Ä°ADE FATURALARI Ä°Ã‡Ä°N Ä°ÅARET KONTROLÃœ
                                    if is_refund:
                                        # DEBUG: Ä°lk 10 out_refund kaydÄ±nÄ± logla (iÅŸaret deÄŸiÅŸtirmeden Ã–NCE)
                                        if refund_count < 10:
                                            print(f"ğŸ” Ä°ADE #{refund_count + 1} Ã–NCE: move={move_name}, move_type={move_type}, qty={qty}, usd={usd_amount:.2f}, partner={partner_name[:40]}")
                                        
                                        # Ä°statistik
                                        refund_count += 1
                                        refund_total_usd += abs(usd_amount)
                                        
                                        # KRÄ°TÄ°K: Ä°ADE FATURALARI HER ZAMAN NEGATÄ°F OLMALI!
                                        # YukarÄ±da abs() aldÄ±k, ÅŸimdi negatif yap
                                        usd_amount_before = usd_amount
                                        qty_before = qty
                                        usd_amount = -abs(usd_amount)
                                        qty = -abs(qty)
                                        
                                        # DEBUG: Ä°ÅŸaret deÄŸiÅŸtirdikten SONRA
                                        if refund_count <= 10:
                                            print(f"ğŸ” Ä°ADE #{refund_count} SONRA: qty={qty_before:.1f} â†’ {qty:.1f}, usd={usd_amount_before:.2f} â†’ {usd_amount:.2f}")
                                    else:
                                        # Normal satÄ±ÅŸ faturalarÄ± iÃ§in istatistik
                                        invoice_count += 1
                                        invoice_total_usd += usd_amount
                                    
                                    # Kategori bazlÄ± toplama - SADECE USD VE MÄ°KTAR
                                    if categ_name not in processed_data['categories']:
                                        processed_data['categories'][categ_name] = {
                                            'quantity': 0, 'usd_amount': 0, 'years': {}
                                        }
                                    
                                    processed_data['categories'][categ_name]['quantity'] += qty
                                    processed_data['categories'][categ_name]['usd_amount'] += usd_amount
                                    
                                    if year not in processed_data['categories'][categ_name]['years']:
                                        processed_data['categories'][categ_name]['years'][year] = {
                                            'quantity': 0, 'usd_amount': 0
                                        }
                                    
                                    processed_data['categories'][categ_name]['years'][year]['quantity'] += qty
                                    processed_data['categories'][categ_name]['years'][year]['usd_amount'] += usd_amount
                                    
                                    # ÃœrÃ¼n bazlÄ± - SADECE USD VE MÄ°KTAR + MARKA + KATEGORÄ° SEVÄ°YELERÄ°
                                    if product_id not in processed_data['products']:
                                        # Kategori seviyelerini al
                                        cat_hierarchy = category_hierarchy.get(
                                            [k for k, v in product_categ_map.items() if k == product_id][0] if product_id in product_categ_map else None
                                        ) if product_id in product_categ_map else {}
                                        
                                        # Daha basit yÃ¶ntem: product_id'den kategori bilgisini al
                                        cat_info = {}
                                        for cat_id, cat_data in category_hierarchy.items():
                                            if product_categ_map.get(product_id) == cat_data.get('full_path'):
                                                cat_info = cat_data
                                                break
                                        
                                        processed_data['products'][product_id] = {
                                            'name': product_name,
                                            'category': categ_name,
                                            'brand': product_brand_map.get(product_id, 'Bilinmeyen'),
                                            'category_level1': cat_info.get('level1', ''),
                                            'category_level2': cat_info.get('level2', ''),
                                            'category_level3': cat_info.get('level3', ''),
                                            'category_level4': cat_info.get('level4', ''),
                                            'category_level5': cat_info.get('level5', ''),
                                            'quantity': 0,
                                            'usd_amount': 0
                                        }
                                    
                                    processed_data['products'][product_id]['quantity'] += qty
                                    processed_data['products'][product_id]['usd_amount'] += usd_amount
                                    
                                    # MÃ¼ÅŸteri/MaÄŸaza bazlÄ± - SADECE USD VE MÄ°KTAR + ÅEHÄ°R + ETÄ°KETLER
                                    if partner_id not in processed_data['partners']:
                                        processed_data['partners'][partner_id] = {
                                            'name': partner_name,
                                            'city': city,
                                            'quantity': 0,
                                            'usd_amount': 0
                                        }
                                    
                                    processed_data['partners'][partner_id]['quantity'] += qty
                                    processed_data['partners'][partner_id]['usd_amount'] += usd_amount
                                    
                                    # DEBUG: DORUK TEKÄ°N iÃ§in Ã¶zel log (TOPLAMA SONRASI)
                                    if 'DORUK' in partner_name.upper():
                                        print(f"ğŸ’ DORUK SONUÃ‡: partner={partner_name}, move={move_name}, is_refund={is_refund}, move_type={move_type}, qty={qty}, usd={usd_amount:.2f}, yeni_toplam_qty={processed_data['partners'][partner_id]['quantity']}, yeni_toplam_usd={processed_data['partners'][partner_id]['usd_amount']:.2f}")
                                    
                                    # SatÄ±ÅŸ Temsilcisi bazlÄ± - SADECE USD VE MÄ°KTAR
                                    if user_name not in processed_data['sales_persons']:
                                        processed_data['sales_persons'][user_name] = {
                                            'quantity': 0, 'usd_amount': 0
                                        }
                                    
                                    processed_data['sales_persons'][user_name]['quantity'] += qty
                                    processed_data['sales_persons'][user_name]['usd_amount'] += usd_amount
                                    
                                    # Åehir bazlÄ± - SADECE USD VE MÄ°KTAR
                                    if city not in processed_data['cities']:
                                        processed_data['cities'][city] = {
                                            'quantity': 0, 'usd_amount': 0
                                        }
                                    
                                    processed_data['cities'][city]['quantity'] += qty
                                    processed_data['cities'][city]['usd_amount'] += usd_amount
                                    
                                    # MaÄŸaza bazlÄ± - SADECE USD VE MÄ°KTAR
                                    if store_name not in processed_data['stores']:
                                        processed_data['stores'][store_name] = {
                                            'quantity': 0, 'usd_amount': 0
                                        }
                                    
                                    processed_data['stores'][store_name]['quantity'] += qty
                                    processed_data['stores'][store_name]['usd_amount'] += usd_amount
                                    
                                    # YÄ±l bazlÄ± - SADECE USD VE MÄ°KTAR
                                    if year not in processed_data['years']:
                                        processed_data['years'][year] = {
                                            'quantity': 0, 'usd_amount': 0
                                        }
                                    
                                    processed_data['years'][year]['quantity'] += qty
                                    processed_data['years'][year]['usd_amount'] += usd_amount
                                    
                                    # Ay bazlÄ± - SADECE USD VE MÄ°KTAR
                                    if month not in processed_data['months']:
                                        processed_data['months'][month] = {
                                            'quantity': 0, 'usd_amount': 0
                                        }
                                    
                                    processed_data['months'][month]['quantity'] += qty
                                    processed_data['months'][month]['usd_amount'] += usd_amount
                                    
                                    # Detay kaydÄ± ekle - AMA Ä°ADE FATURALARINI EKLEME (sayfada gÃ¶sterme)
                                    if not is_refund:
                                        cat_info = {}
                                        for cat_id, cat_data in category_hierarchy.items():
                                            if product_categ_map.get(product_id) == cat_data.get('full_path'):
                                                cat_info = cat_data
                                                break
                                        
                                        details.append({
                                            'date': date_str,
                                            'create_hour': create_hour,
                                            'day_of_week': create_day_of_week,
                                            'partner': partner_name,
                                            'product': product_name,
                                            'brand': product_brand_map.get(product_id, 'Bilinmeyen'),
                                            'category_1': cat_info.get('level1', ''),
                                            'category_2': cat_info.get('level2', ''),
                                            'category_3': cat_info.get('level3', ''),
                                            'category_4': cat_info.get('level4', ''),
                                            'sales_person': user_name,
                                            'store': store_name,
                                            'city': city,
                                            'quantity': qty,
                                            'usd_amount': usd_amount
                                        })
                                    
                                except Exception as e:
                                    print(f"âš ï¸ SatÄ±r iÅŸleme hatasÄ±: {e}")
                                    continue
                            
                            print("\nâœ… Veri iÅŸleme tamamlandÄ±!")
                            print(f"ğŸ“¦ Kategori sayÄ±sÄ±: {len(processed_data['categories'])}")
                            print(f"ğŸ·ï¸ ÃœrÃ¼n sayÄ±sÄ±: {len(processed_data['products'])}")
                            print(f"ğŸ¤ MÃ¼ÅŸteri sayÄ±sÄ±: {len(processed_data['partners'])}")
                            print(f"ğŸ“‹ Detay kayÄ±t sayÄ±sÄ±: {len(details)}")
                            print(f"ğŸ‘¤ SatÄ±ÅŸ Temsilcisi sayÄ±sÄ±: {len(processed_data['sales_persons'])}")
                            print(f"ğŸ™ï¸ Åehir sayÄ±sÄ±: {len(processed_data['cities'])}")
                            print(f"ğŸ“… YÄ±l sayÄ±sÄ±: {len(processed_data['years'])}")
                            print(f"ğŸ“† Ay sayÄ±sÄ±: {len(processed_data['months'])}")
                            print(f"\nğŸ’° FATURA Ä°STATÄ°STÄ°KLERÄ°:")
                            print(f"   âœ… SatÄ±ÅŸ FaturalarÄ± (out_invoice): {invoice_count} adet, ${invoice_total_usd:,.2f}")
                            print(f"   âŒ Ä°ade FaturalarÄ± (out_refund): {refund_count} adet, ${refund_total_usd:,.2f}")
                            print(f"   ğŸ“Š NET TOPLAM: ${invoice_total_usd - refund_total_usd:,.2f}")
                            
                            # RES.PARTNER (MÃ¼ÅŸteri) DetaylÄ± Bilgileri Ã‡ek (XML-RPC) - TÃœM MÃœÅTERÄ°LER
                            print("\n4ï¸âƒ£ MÃ¼ÅŸteri detay bilgileri Ã§ekiliyor (res.partner - XML-RPC)...")
                            
                            partner_ids = list(processed_data['partners'].keys())  # TÃœM MÃœÅTERÄ°LER
                            print(f"ğŸ‘¥ Toplam {len(partner_ids)} mÃ¼ÅŸteri detayÄ± Ã§ekilecek...")
                            
                            if partner_ids and models:
                                try:
                                    partners = models.execute_kw(
                                        db, uid_xmlrpc, password,
                                        'res.partner', 'search_read',
                                        [[('id', 'in', partner_ids)]],
                                        {
                                            'fields': [
                                                'id', 'name', 'email', 'phone', 'mobile',
                                                'street', 'city', 'state_id', 'country_id',
                                                'customer_rank', 'supplier_rank', 'company_type',
                                                'vat', 'category_id', 'user_id', 'create_date'
                                            ]
                                        }
                                    )
                                    
                                    partner_details = {}
                                    
                                    for partner in partners:
                                        partner_id = partner.get('id')
                                        
                                        state = partner.get('state_id')
                                        state_name = state[1] if isinstance(state, list) and len(state) > 1 else ''
                                        
                                        country = partner.get('country_id')
                                        country_name = country[1] if isinstance(country, list) and len(country) > 1 else ''
                                        
                                        categories = partner.get('category_id', [])
                                        category_names = [cat[1] for cat in categories if isinstance(cat, list) and len(cat) > 1] if categories else []
                                        
                                        user = partner.get('user_id')
                                        user_name = user[1] if isinstance(user, list) and len(user) > 1 else ''
                                        
                                        partner_details[partner_id] = {
                                            'name': partner.get('name', ''),
                                            'email': partner.get('email', ''),
                                            'phone': partner.get('phone', ''),
                                            'mobile': partner.get('mobile', ''),
                                            'street': partner.get('street', ''),
                                            'city': partner.get('city', ''),
                                            'state': state_name,
                                            'country': country_name,
                                            'customer_rank': partner.get('customer_rank', 0),
                                            'supplier_rank': partner.get('supplier_rank', 0),
                                            'company_type': partner.get('company_type', ''),
                                            'vat': partner.get('vat', ''),
                                            'categories': category_names,
                                            'sales_person': user_name,
                                            'create_date': partner.get('create_date', ''),
                                            'sales_data': processed_data['partners'].get(partner_id, {})
                                        }
                                    
                                    processed_data['partner_details'] = partner_details
                                    
                                    print(f"âœ… {len(partner_details)} mÃ¼ÅŸteri detayÄ± Ã§ekildi (XML-RPC)!")
                                    print(f"ğŸ“§ Email olan: {sum(1 for p in partner_details.values() if p['email'])}")
                                    print(f"ğŸ“± Telefon olan: {sum(1 for p in partner_details.values() if p['phone'] or p['mobile'])}")
                                    print(f"ğŸ™ï¸ Åehir bilgisi olan: {sum(1 for p in partner_details.values() if p['city'])}")
                                    
                                except Exception as e:
                                    print(f"âš ï¸ MÃ¼ÅŸteri detaylarÄ± Ã§ekme hatasÄ±: {e}")
                                    processed_data['partner_details'] = {}
                            else:
                                print("âš ï¸ MÃ¼ÅŸteri ID'leri yok veya XML-RPC baÄŸlantÄ±sÄ± yok")
                                processed_data['partner_details'] = {}
                            
                            # DetaylarÄ± processed_data'ya ekle
                            processed_data['details'] = details
                            
                            # JSON dosyalarÄ± oluÅŸtur (YILLARA BÃ–LÃœNMÃœÅ + GZIP)
                            print("\n5ï¸âƒ£ JSON dosyalarÄ± oluÅŸturuluyor (yÄ±llara bÃ¶lÃ¼nmÃ¼ÅŸ + sÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ)...")
                            
                            import gzip
                            from collections import defaultdict
                            
                            # Verileri yÄ±llara gÃ¶re ayÄ±r
                            data_by_year = defaultdict(list)
                            for record in details:
                                year = record['date'][:4] if record.get('date') else '2025'
                                data_by_year[year].append(record)
                            
                            print(f"ğŸ“Š Veriler {len(data_by_year)} yÄ±la bÃ¶lÃ¼ndÃ¼:")
                            for year in sorted(data_by_year.keys()):
                                print(f"   - {year}: {len(data_by_year[year])} kayÄ±t")
                            
                            # Her yÄ±l iÃ§in ayrÄ± sÄ±kÄ±ÅŸtÄ±rÄ±lmÄ±ÅŸ dosya oluÅŸtur
                            created_files = []
                            for year in sorted(data_by_year.keys()):
                                year_data = {
                                    'year': year,
                                    'categories': processed_data['categories'],
                                    'products': processed_data['products'],
                                    'partners': processed_data['partners'],
                                    'partner_details': processed_data['partner_details'],
                                    'sales_persons': processed_data['sales_persons'],
                                    'stores': processed_data['stores'],
                                    'years': processed_data['years'],
                                    'months': processed_data['months'],
                                    'details': data_by_year[year]
                                }
                                
                                filename = f'data-{year}.json.gz'
                                with gzip.open(filename, 'wt', encoding='utf-8') as f:
                                    json.dump(year_data, f, ensure_ascii=False)
                                
                                # Dosya boyutunu kontrol et
                                import os
                                file_size_mb = os.path.getsize(filename) / (1024 * 1024)
                                print(f"   âœ… {filename}: {file_size_mb:.2f} MB")
                                created_files.append(filename)
                            
                            # Metadata dosyasÄ± oluÅŸtur (hangi yÄ±llar var?)
                            metadata = {
                                'years': sorted(data_by_year.keys()),
                                'total_records': len(details),
                                'files': created_files,
                                'last_update': datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                            }
                            
                            with open('data-metadata.json', 'w', encoding='utf-8') as f:
                                json.dump(metadata, f, ensure_ascii=False, indent=2)
                            
                            print(f"âœ… {len(created_files)} dosya oluÅŸturuldu!")
                            print(f"âœ… data-metadata.json oluÅŸturuldu!")
                            
                            print("\n" + "=" * 60)
                            print("ğŸ‰ TÃœM VERÄ°LER BAÅARIYLA Ã‡EKÄ°LDÄ° VE Ä°ÅLENDÄ°!")
                            print("=" * 60)
                            
                        else:
                            print(f"âŒ Fatura verileri Ã§ekilemedi!")
                            print(f"YanÄ±t: {all_data if 'all_data' in locals() else 'Veri yok'}")
                            exit(1)
                        
                    else:
                        print("âŒ UID bulunamadÄ±!")
                        print(f"Session: {session_info}")
                        exit(1)
                else:
                    print("âŒ GeÃ§ersiz session!")
                    print(f"Result: {result}")
                    exit(1)
            else:
                print("âŒ Beklenmeyen yanÄ±t!")
                print(f"Response: {result}")
                exit(1)
                
        except Exception as e:
            print(f"âŒ Hata: {e}")
            import traceback
            traceback.print_exc()
            exit(1)
        
        EOF
    
    - name: Dosya BoyutlarÄ±nÄ± Kontrol Et
      run: |
        echo "ğŸ“Š OluÅŸturulan dosyalar:"
        ls -lh data-*.json.gz data-metadata.json 2>/dev/null || echo "âš ï¸ Dosyalar bulunamadÄ±"
        
        echo ""
        echo "ğŸ“Š Dosya boyutlarÄ±:"
        for file in data-*.json.gz; do
          if [ -f "$file" ]; then
            SIZE=$(stat -f%z "$file" 2>/dev/null || stat -c%s "$file" 2>/dev/null)
            SIZE_MB=$((SIZE / 1024 / 1024))
            echo "   - $file: ${SIZE_MB} MB"
            
            if [ $SIZE_MB -gt 100 ]; then
              echo "   âš ï¸ UYARI: $file 100 MB'dan bÃ¼yÃ¼k!"
            fi
          fi
        done
    
    - name: DeÄŸiÅŸiklikleri commit et ve yÃ¼kle
      env:
        PAT_TOKEN: ${{ secrets.PAT_TOKEN }}
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
        
        # Eski data.json varsa sil (artÄ±k kullanmÄ±yoruz)
        if [[ -f "data.json" ]]; then
          echo "ğŸ—‘ï¸ Eski data.json siliniyor..."
          git rm -f data.json 2>/dev/null || rm -f data.json
        fi
        
        # Yeni dosyalarÄ± kontrol et
        if ls data-*.json.gz 1> /dev/null 2>&1; then
          echo "âœ… YÄ±llara bÃ¶lÃ¼nmÃ¼ÅŸ dosyalar bulundu"
          
          # Ã–nce remote deÄŸiÅŸiklikleri Ã§ek
          echo "ğŸ”„ Remote deÄŸiÅŸiklikler kontrol ediliyor..."
          git fetch origin
          
          # Pull yap
          if git pull --rebase origin main; then
            echo "âœ… Rebase baÅŸarÄ±lÄ±"
          elif git pull origin main; then
            echo "âœ… Merge baÅŸarÄ±lÄ±"
          else
            echo "âš ï¸ Pull baÅŸarÄ±sÄ±z, devam ediliyor..."
          fi
          
          # TÃ¼m data dosyalarÄ±nÄ± ekle
          git add data-*.json.gz data-metadata.json
          
          if [[ -n $(git status -s) ]]; then
            git commit -m "Veriler gÃ¼ncellendi - $(date +'%Y-%m-%d %H:%M')"
            
            # Push URL'ini PAT ile gÃ¼ncelle
            git remote set-url origin https://x-access-token:${PAT_TOKEN}@github.com/toftamars/satiss-dashboard.git
            
            # Push dene, baÅŸarÄ±sÄ±z olursa force push
            if git push origin main; then
              echo "âœ… DeÄŸiÅŸiklikler GitHub'a yÃ¼klendi!"
            else
              echo "âš ï¸ Normal push baÅŸarÄ±sÄ±z, pull yapÄ±p tekrar deneniyor..."
              git pull --rebase origin main
              git push origin main
              echo "âœ… DeÄŸiÅŸiklikler GitHub'a yÃ¼klendi (rebase sonrasÄ±)!"
            fi
          else
            echo "â„¹ï¸ DeÄŸiÅŸiklik yok"
          fi
        else
          echo "âš ï¸ data.json dosyasÄ± bulunamadÄ±"
        fi
